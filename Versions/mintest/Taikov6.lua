Split=function(a,b)local c={}for d,b in a:gmatch("([^"..b.."]*)("..b.."?)")do table.insert(c,d)if b==''then return c end end end;Trim=function(e)local a=e:gsub("^%s*(.-)%s*$","%1")return a end;TrimLeft=function(e)local a=e:gsub("^%s*(.-)$","%1")return a end;TrimRight=function(e)local a=e:gsub("^(.-)%s*$","%1")return a end;StartsWith=function(a,b)return a:sub(1,#b)==b end;EndsWith=function(a,b)return a:sub(-#b,-1)==b end;Table={}function Table.Clone(f,g)g=g or{}local h=type(f)local i;if h=='table'then if g[f]then i=g[f]else i={}g[f]=i;for j,k in next,f,nil do i[Table.Clone(j,g)]=Table.Clone(k,g)end;setmetatable(i,Table.Clone(getmetatable(f),g))end else i=f end;return i end;ClipN=function(l,a,b)if l<a then return a elseif l>b then return b else return l end end;function Error(m)error(m)end;LineN=nil;function ParseError(n,m,o)Error('Line: '..LineN..'\n'..n..': '..m..(o and', '..o or''))end;function MsToS(p)return p/1000 end;function SToMs(e)return e*1000 end;Taiko={}Taiko.Data={Languages={'','EN','JA','CN','TW','KO'},GenreName={Pop={'pop','j-pop'},Anime={'anime','アニメ'},Kids={'kids','どうよう'},Variety={'variety','バラエティ'},VOCALOID={'vocaloid','ボーカロイド'},Classic={'classic','クラシック'},['Game Music']={'game music','ゲームミュージック'},['Namco Original']={'namco original','ナムコオリジナル'}},CourseId={easy=0,normal=1,hard=2,oni=3,edit=4,tower=5,dan=6,ura=4},CourseName={[0]='Easy','Normal','Hard','Oni','Edit','Tower','Dan','Ura'},RatingMultiplier={[0]=0,[1]=0.5,[2]=1,[3]=2},ScoreMode={[0]=function(q,r,s,t,u)return q+(r<200 and(s or 1000)or(s or 1000)+(t or 1000))*Taiko.Data.RatingMultiplier[u]end,[1]=function(q,r,s,t,u)return q+(s+math.max(0,t*math.floor((math.min(r,100)-1)/10)))*Taiko.Data.RatingMultiplier[u]end,[2]=function(q,r,s,t,u)return q+(s+t*(r>=100 and 8 or r>=50 and 4 or r>=30 and 2 or r>=10 and 1 or 0))*Taiko.Data.RatingMultiplier[u]end},Autoscore={[0]=function(v)end,[1]=function(v)end,[2]=function(v)end},SideId={normal=1,ex=2,both=3},SideName={'normal','ex','both'},StyleId={single=1,double=2,couple=2},StyleName={'single','double'},Exam={Condition={g=true,jp=true,jg=true,jb=true,s=true,r=true,h=true,c=true},Scope={m=true,l=true}},Branch={PathId={N=0,E=1,M=2},PathName={[0]='N',[1]='E',[2]='M'},Requirements={r=function()end,p=function()end}}}for w,x in pairs(Taiko.Data.ScoreMode)do Taiko.Data.ScoreMode[w]=function(...)return math.floor(x(...)/10)*10 end end;function Taiko.ParseTJA(y)local z=os.clock()local A={}local v={Metadata={BPM=120,WAVE='main.mp3',OFFSET=0,DEMOSTART=0,SCOREMODE=1,SONGVOL=100,SEVOL=100,SIDE=3,LIFE=0,GAME='Taiko',HEADSCROLL=1,MOVIEOFFSET=0,COURSE='ONI',LEVEL=0,BALLOON=nil,SCOREINIT,SCOREDIFF,BALLOONNOR=nil,BALLOONEXP=nil,BALLOONMAS=nil,STYLE=1,EXAM1=nil,EXAM2=nil,EXAM3=nil,GAUGEINCR='NORMAL',TOTAL=nil,HIDDENBRANCH=0,DIVERGENOTES=false,SCOREINIT=0,SCOREDIFF=0},Data={}}local function B(C)local a=Taiko.Data.Languages;for D=1,#a do local b=v.Metadata[C..a[D]]if b then return b end end;return nil end;local function E(n,l,F)local a=tonumber(l)if a then return a else ParseError(n,F,l)end end;local function G(n,a,F,o)if a then return a else ParseError(n,F,o)end end;local function H(n,b,F)local I={['true']=true,['false']=false,yes=true,no=false,['1']=true,['0']=false,[1]=true,[0]=false}local a=I[b]~=nil;if a then return a else ParseError(n,F,b)end end;local function J(n,K)local L=','local M='\\'local N={}local O=''local P=false;for D=1,#K do local e=string.sub(K,D,D)if P then O=O..e;P=false else if e==L then table.insert(N,O)O=''elseif e==M then P=true else O=O..e end end end;table.insert(N,O)return N end;local function Q(n,K,F)local N=J(n,K)for D=1,#N do N[D]=E(n,N[D],F,K)end;return N end;local function R(n,e,F)if e and e~=''then return Q(n,e,F)else return{}end end;local function S(n,e,F)if e and e~=''then local N=J(n,e,F)G(n,Taiko.Data.Exam.Condition[N[1]],F)N[2]=E(n,N[2],F)N[3]=E(n,N[3],F)G(n,Taiko.Data.Exam.Scope[N[4]],F)return N else return{}end end;local T={}local function U()local T={settings={noteparse={notealias={A=3,B=4},noteexceptions={[',']=true,[' ']=true,['\t']=true}},command={matchexceptions={}}},bpm=0,ms=0,songstarted=false,timingpoint=nil,sign=4/4,mpm=0,mspermeasure=0,scroll=1,measuredone=true,currentmeasure={},measurepushto=v.Data,barline=true,gogo=false,lastlong=nil,balloonn=1,currentbranch=nil,branch={on=false,requirements={},paths={}},msbeforebranch=nil}function T.createnote(l)if l then local V={ms=nil,data=nil,type=l,txt=nil,gogo=T.gogo,scroll=T.scroll*v.Metadata.HEADSCROLL,mspermeasure=T.mspermeasure,bpm=T.bpm,nextnote=nil,radius=1,requiredhits=nil,length=nil,endnote=nil,onnotepush=nil}V.type=l;if l==3 or l==4 or l==6 then V.radius=V.radius*1.6 end;if l==5 or l==6 or l==7 or l==9 then if T.lastlong then if l==9 then else ParseError('parser.noteparse','Last long note has not ended')end else T.lastlong=V;if l==7 or l==9 then V.requiredhits=G('parser.noteparse',v.Metadata.BALLOON[T.balloonn],'Invalid number of balloons',T.balloonn)T.balloonn=T.balloonn+1 end end end;if l==8 then local W=T.lastlong;T.lastlong=nil;V.startnote=W;if W then V.onnotepush=function()W.length=V.ms-W.ms;W.endnote=V end else end end;return V else return{ms=nil,data=nil,type=nil,txt=nil,gogo=T.gogo,scroll=T.scroll*v.Metadata.HEADSCROLL,mspermeasure=T.mspermeasure,bpm=T.bpm,nextnote=nil}end end;function T.endbranch()local l=T.createnote()l.data='event'l.event='branch'l.branch={requirements=T.branch.requirements,paths=T.branch.paths}T.branch.on=false;T.branch.requirements={}T.branch.paths={}table.insert(v.Data,l)T.measurepushto=v.Data end;return T end;T=U()local X=Split(y,'\n')for D=1,#X do LineN=D;local Y=Trim(X[D])if StartsWith(Y,'//')or Y==''then else local Z=string.find(Y,'//')if Z then Y=string.sub(Y,1,Z-1)end;local _=false;if T.songstarted==false and _==false then local a0={string.match(Y,'(%u+):(.*)')}if a0[1]then local a=Trim(a0[2])if a~=''then v.Metadata[Trim(a0[1])]=a end;_=true end end;if(T.songstarted or StartsWith(Y,'#START'))and _==false then local a0={string.match(Y,'#(%u-)%s(.*)')}if not a0[1]then a0={string.match(Y,'#(%u+)')}end;if a0[1]then if a0[1]=='START'then if T.songstarted then ParseError(a0[1],'Song has already started')else v.OriginalMetadata=Table.Clone(v.Metadata)v.Metadata.TITLE=G(a0[1],B('TITLE'),'Title is missing')v.Metadata.SUBTITLE=G(a0[1],B('SUBTITLE'),'Subtitle is missing')v.Metadata.BPM=E(a0[1],v.Metadata.BPM,'Invalid bpm')v.Metadata.OFFSET=SToMs(E(a0[1],v.Metadata.OFFSET,'Invalid offset'))v.Metadata.DEMOSTART=SToMs(E(a0[1],v.Metadata.DEMOSTART,'Invalid demostart'))if v.Metadata.DEMOSTART==0 then v.Metadata.DEMOSTART=nil end;for w,x in pairs(Taiko.Data.GenreName)do for D=1,#x do if x[D]==v.Metadata.GENRE then v.Metadata.GENRE=w end end end;v.Metadata.SCOREMODE=E(a0[1],v.Metadata.SCOREMODE,'Invalid scoremode')G(a0[1],Taiko.Data.ScoreMode[v.Metadata.SCOREMODE],'Invalid scoremode',v.Metadata.SCOREMODE)if v.Metadata.MAKER then v.Metadata.CREATORURLT={}v.Metadata.CREATOR=Trim(string.gsub(v.Metadata.MAKER,'(<.->)',function(a1)table.insert(v.Metadata.CREATORURLT,string.sub(a1,2,-2))return''end))v.Metadata.CREATORURL=table.concat(v.Metadata.CREATORURLT,', ')v.Metadata.CREATIVE=false else v.Metadata.CREATIVE=false end;v.Metadata.SONGVOL=E(a0[1],v.Metadata.SONGVOL,'Invalid songvol')/100;v.Metadata.SEVOL=E(a0[1],v.Metadata.SEVOL,'Invalid sevol')/100;local a=tonumber(v.Metadata.SIDE)if a then G(a0[1],Taiko.Data.SideName[a],'Invalid side id',v.Metadata.SIDE)v.Metadata.SIDE=a else v.Metadata.SIDE=G(a0[1],Taiko.Data.SideId[string.lower(v.Metadata.SIDE)],'Invalid side name',v.Metadata.SIDE)end;v.Metadata.LIFE=E(a0[1],v.Metadata.LIFE,'Invalid life')if v.Metadata.LIFE==0 then v.Metadata.LIFE=nil end;v.Metadata.GAME=string.lower(v.Metadata.GAME)if v.Metadata.GAME=='taiko'then elseif v.Metadata.GAME=='jube'then else end;v.Metadata.HEADSCROLL=E(a0[1],v.Metadata.HEADSCROLL,'Invalid headscroll')v.Metadata.MOVIEOFFSET=E(a0[1],v.Metadata.MOVIEOFFSET,'Invalid movieoffset')local a=tonumber(v.Metadata.COURSE)if a then G(a0[1],Taiko.Data.CourseName[a],'Invalid course id',v.Metadata.COURSE)v.Metadata.COURSE=a else v.Metadata.COURSE=G(a0[1],Taiko.Data.CourseId[string.lower(v.Metadata.COURSE)],'Invalid course name',v.Metadata.COURSE)end;v.Metadata.LEVEL=ClipN(math.floor(E(a0[1],v.Metadata.LEVEL,'Invalid level')),0,10)v.Metadata.BALLOON=R(a0[1],v.Metadata.BALLOON,'Invalid balloon')v.Metadata.SCOREINIT=E(a0[1],v.Metadata.SCOREINIT,'Invalid scoreinit')v.Metadata.SCOREDIFF=E(a0[1],v.Metadata.SCOREDIFF,'Invalid scoreinit')v.Metadata.BALLOONNOR=R(a0[1],v.Metadata.BALLOONNOR,'Invalid balloonnor')v.Metadata.BALLOONEXP=R(a0[1],v.Metadata.BALLOONEXP,'Invalid balloonexp')v.Metadata.BALLOONMAS=R(a0[1],v.Metadata.BALLOONMAS,'Invalid balloonmas')local a=tonumber(v.Metadata.STYLE)if a then G(a0[1],Taiko.Data.StyleName[a],'Invalid course id',Taiko.Data.STYLE)v.Metadata.STYLE=a else v.Metadata.STYLE=G(a0[1],Taiko.Data.CourseId[string.lower(v.Metadata.STYLE)],'Invalid course name',v.Metadata.STYLE)end;v.Metadata.EXAM1=S(v.Metadata.EXAM1)v.Metadata.EXAM2=S(v.Metadata.EXAM2)v.Metadata.EXAM3=S(v.Metadata.EXAM3)v.Metadata.GAUGEINCR=string.lower(v.Metadata.GAUGEINCR)if v.Metadata.TOTAL then v.Metadata.TOTAL=E(a0[1],v.Metadata.TOTAL,'Invalid total')end;v.Metadata.HIDDENBRANCH=H(a0[1],v.Metadata.HIDDENBRANCH,'Invalid hiddenbranch')T.bpm=v.Metadata.BPM;T.songstarted=true end elseif a0[1]=='END'then if T.songstarted then if#T.currentmeasure~=0 then ParseError(a0[1],'Current measure is not empty')end;table.insert(A,v)v={Metadata=Table.Clone(v.OriginalMetadata),Data={}}T=U()T.songstarted=false;T.measurepushto=v.Data else ParseError(a0[1],'Song has already ended')end elseif a0[1]=='MEASURE'then local a,b=string.match(a0[2],'(%d+)/(%d+)')a=E(a0[1],a,'Invalid measure')b=E(a0[1],b,'Invalid measure')T.sign=a/b or T.sign elseif a0[1]=='BPMCHANGE'then T.bpm=E(a0[1],a0[2],'Invalid bpmchange')or T.bpm elseif a0[1]=='DELAY'then table.insert(T.currentmeasure,{a0[1],SToMs(E(a0[1],a0[2],'Invalid delay')or 0)})elseif a0[1]=='SCROLL'then T.scroll=E(a0[1],a0[2],'Invalid scroll')or T.scroll;if T.scroll==0 then ParseError(a0[1],'Scroll cannot be 0')end elseif a0[1]=='GOGOSTART'then T.gogo=true elseif a0[1]=='GOGOEND'then T.gogo=false elseif a0[1]=='BARLINEOFF'then T.barline=false elseif a0[1]=='BARLINEON'then T.barline=true elseif a0[1]=='BRANCHSTART'then if T.branch.on then T.endbranch()end;T.msbeforebranch=T.ms;T.branch.on=true;v.Metadata.DIVERGENOTES=true;local N=J(a0[1],a0[2])local a2=G(a0[1],Taiko.Data.Branch.Requirements[string.lower(N[1])],'Invalid type',N[1])T.branch.requirements={a2}local D=2;while true do if not N[D]then break end;local a3=Taiko.Data.Branch.PathName[D-1]if a3 then T.branch.requirements[a3]=N[D]else break end;D=D+1 end elseif Taiko.Data.Branch.PathId[a0[1]]then if T.branch.on then T.ms=T.msbeforebranch;T.currentbranch=a0[1]T.branch.paths[a0[1]]={}T.measurepushto=T.branch.paths[a0[1]]else ParseError(a0[1],'Branch has not started')end elseif a0[1]=='BRANCHEND'then if T.branch.on then T.endbranch()else ParseError(a0[1],'Branch has already ended')end elseif a0[1]=='SECTION'then elseif a0[1]=='LYRIC'then elseif a0[1]=='LEVELHOLD'then elseif a0[1]=='BMSCROLL'then elseif a0[1]=='HBSCROLL'then elseif a0[1]=='SENOTECHANGE'then elseif a0[1]=='NEXTSONG'then elseif a0[1]=='DIRECTION'then elseif a0[1]=='SUDDEN'then elseif a0[1]=='JPOSSCROLL'then else end;_=true end end;if T.songstarted and _==false then T.mpm=T.bpm*T.sign/4;T.mspermeasure=60000*T.sign*4/T.bpm;if T.barline and#T.currentmeasure==0 then local V=T.createnote()V.ms=T.ms;V.data='event'V.event='barline'table.insert(T.measurepushto,1,V)end;for D=1,#Y do local e=string.sub(Y,D,D)if T.settings.noteparse.noteexceptions[e]then else local l=E('parser.noteparse',tonumber(e)or T.settings.noteparse.notealias[e]or e,'Invalid note')if l then local V=T.createnote(l)V.data='note'table.insert(T.currentmeasure,V)end end end;if EndsWith(TrimRight(Y),',')then T.mpm=T.bpm*T.sign/4;T.mspermeasure=60000*T.sign*4/T.bpm;if#T.currentmeasure==0 then T.ms=T.ms+T.mspermeasure else local a4=0;local a5=nil;for D=1,#T.currentmeasure do local c=T.currentmeasure[D]if c.data=='note'then a5=a5 or c.mspermeasure;a4=a4+1 end end;local a6=a5/a4;for D=1,#T.currentmeasure do local c=T.currentmeasure[D]if c[1]=='DELAY'then T.ms=T.ms+c[2]else if c.type~=0 then c.ms=T.ms;local a7=v.Data[#v.Data]if a7 then a7.nextnote=c end;table.insert(T.measurepushto,c)if c.onnotepush then c.onnotepush()end;a6=c.mspermeasure/a4 end end;T.ms=T.ms+a6 end end;T.measuredone=true;T.currentmeasure={}else T.measuredone=false end end end end;print('Parsing Took: '..SToMs(os.clock()-z)..'ms')return A end;function Taiko.Analyze(v)for D=1,#v.Data do end end;function Taiko.GetDifficulty(v,a8)local a=Taiko.Data.CourseId[string.lower(a8)]or a8;for w,x in pairs(v)do if x.Metadata.COURSE==a then return x end end;Error('No difficulty found, '..a8)return nil end;function Taiko.ForAll(a9,a2)local l=1;for D=1,#a9 do local x=a9[D]if x.branch then local aa=-1;for ab,ac in pairs(x.branch.paths)do local ad=l;for ae=1,#ac do a2(ac[ae],ae,ad)ad=ad+1 end;aa=aa<ad and ad or aa end;l=aa else a2(x,D,l)end;l=l+1 end;return a9 end;function Taiko.GetAllNotes(a9)local N={}for w,x in pairs(a9)do if x.branch then for ab,ac in pairs(x.branch.paths)do for D=1,#ac do table.insert(N,ac[D])end end else table.insert(N,x)end end;return N end;function Taiko.ConnectNotes(a9)local af=nil;for D=#a9,1,-1 do local l=a9[D]l.nextnote=af;af=l end;return a9 end;function Taiko.ExtractBranch(ag,ah)return ag.branch.paths[ah]end;function Taiko.ConnectAll(a9)local af=nil;for D=#a9,1,-1 do local V=a9[D]if V.branch then for w,x in pairs(V.branch.paths)do local ah=Taiko.ConnectNotes(x)ah[#ah].nextnote=af end else V.nextnote=af end;af=V end end;function Taiko.CalculateSpeed(V,ai)local aj=ai*V.scroll*V.bpm/7500;return aj end;function Taiko.CalculateSpeedAll(a9,ai)for D=1,#a9 do a9[D].speed=Taiko.CalculateSpeed(a9[D],ai)end;return a9 end;function Taiko.RenderScale(v)local N={}local ak={}local al={}for D=1,#v.Data do local V=v.Data[D]if V.data=='note'then local p=math.floor(V.ms)if math.floor(p)-p==0 then table.insert(N,{p,V.type})table.insert(ak,p)else table.insert(al,D)end end end;function gcd2(a,b)if b==0 then return a else return gcd2(b,a%b)end end;function gcdn(am)local an=am[1]for D=2,#am do an=gcd2(an,am[D])end;return an end;local ao=gcdn(ak)for D=1,#al do local d=N[al[D]]d[1]=math.floor(d[1]/ao)*ao end;local K=''local p=0;for D=1,#N do N[D][1]=N[D][1]/ao;K=K..string.rep(' ',N[D][1]-p)..N[D][2]p=N[D][1]end;return K end;function Taiko.PlaySong(v,a8)local ap={on=false,fps=60,frames={}}local aq=100;local ar=10;local as=100;local ai=4;local at=0;local au=10;local av=0;local aw=40;local ax=3;local ay=1;local az={[1]={color='red'},[2]={color='blue'},[3]={color='red'},[4]={color='blue'},[5]={color='yellow'},[6]={color='yellow'}}aw=math.floor(aw*ai)local aA=av+aw;ax=math.floor(ax*ai)local aB=require('Pixels')local aC,aD=av,aw;local aE,aF=-au,au;aB.Convert.ToDots=function(K)K=GetPixelData(K)local o,color=K.Data,K.Color;if ReverseY then local function aG(N)local aH={}for aI,x in pairs(N)do for at,ac in pairs(x)do aH[aI]=aH[aI]or{}aH[aI][-at]=ac end end;return aH end;o=aG(o)color=aG(color)end;K={Data=o,Color=color}local function aJ(N)local c=nil;for w,x in pairs(N)do if not c or w<c then c=w end end;return c end;local function aK(N)local c=nil;for w,x in pairs(N)do if not c or w>c then c=w end end;return c end;local function aL(N,aM)local aN={}for w,x in pairs(N)do local a=aM(x)if a then aN[a]=true end end;return aM(aN)end;local aO={}local aP=string.rep('0',8)local aQ=aB.Data.Dot[aP]local aR=nil;local aS=nil;if K.Color.All then local c=tostring(aB.Color(K.Color.All))table.insert(aO,c)aS=c end;local aT={}for aI,x in pairs(o)do for at,ac in pairs(x)do aT[at]=aT[at]or{}aT[at][aI]=ac end end;if not aE then return''end;for at=aE,aF,4 do for aI=aC,aD,2 do local aU=''local c={{0,0},{0,1},{0,2},{0,3},{1,0},{1,1},{1,2},{1,3}}for D=1,8 do local aI,at=aI+c[D][1],at+c[D][2]aU=aU..((o[aI]and o[aI][at]or false)and o[aI][at]or aB.Data.Empty)end;if aU~=aP then aU=aB.Data.Dot[aU]if not aS then local color=aB.GetColor(K,aI,at)if not color then local c={{0,0},{0,1},{0,2},{0,3},{1,0},{1,1},{1,2},{1,3}}for D=1,8 do color=aB.GetColor(K,aI+c[D][1],at+c[D][2])if color then break end end end;if color then color=tostring(aB.Color(color))else color=tostring(aB.Color('reset'))end;if aR==color then else table.insert(aO,color)aR=color end end;table.insert(aO,aU)else table.insert(aO,aQ)end end;table.insert(aO,aB.Data.NewLine)end;table.insert(aO,tostring(aB.Color('reset')))return table.concat(aO)end;local function aV(aO,V)local aI=math.floor(V.p)local aW,aX=at-au,at+au;for at=aW,aX do local a=aB.GetPixel(aO,aI,at)if a=='0'or a==nil then aB.SetPixel(aO,aI,at,'1')end end end;local function aY(aO,V)aB.Circle(aO,math.floor(V.p),at,ai*V.radius,az[V.type])end;local function aZ(aO,a_,b0,aW,aX,b1)local b1=b1 or{}color=b1.color;local b2=av-ar;if a_<b2 then a_=b2 end;local b3=aw+ar;if b0>b3 then b0=b3 end;for at=aW,aX do for aI=a_,b0 do aB.SetPixel(aO,aI,at,'1')if color then aB.SetColor(aO,aI,at,color)end end end end;local function b4(aO,V)local l=V.type;if l==1 or l==2 or l==3 or l==4 then aY(aO,V)elseif l==5 or l==6 then aY(aO,V)local b5=V.endnote;local b6=(b5.ms-V.ms)*V.speed;aY(aO,V)local an=ai*V.radius;local a_,b0=math.floor(V.p),math.floor(V.p+b6)local aW=at-an;local aX=at+an;aZ(aO,a_,b0,aW,aX,az[V.type])elseif l==8 then if V.renderproxy then V.renderproxy.p=V.p else local b7=V.startnote;V.renderproxy={}for w,x in pairs(b7)do if w~='type'then V.renderproxy[w]=x end end end;V.renderproxy.p=V.p;aY(aO,V.renderproxy)end end;local b8={ClearScreen=function()io.write("\27[2J")end,SetCursor=function(aI,at)io.write(string.format("\27[%d;%dH",at,aI))end}v=Taiko.GetDifficulty(v,a8)local b9=Taiko.GetAllNotes(v.Data)local ba=v.Metadata.OFFSET;local function bb(V)return V.data=='note'or V.data=='event'and V.event=='barline'end;local function bc(V,p)return p-(aw/V.speed+aq)end;local function bd(V,be)return(V.ms-be)*V.speed+ax end;local function bf(V,p)return V.loadp-V.speed*(p-V.loadms)end;local bg={}for w,x in pairs(b9)do x.ms=x.ms-ba;x.s=MsToS(x.ms)x.speed=Taiko.CalculateSpeed(x,ai)x.loadms=bc(x,x.ms)x.loads=MsToS(x.loadms)x.loadp=bd(x,x.loadms)table.insert(bg,x.ms)end;for w,x in pairs(v.Data)do if x.branch then for ab,ac in pairs(x.branch.paths)do table.sort(ac,function(a,b)return a.loadms<b.loadms end)end end end;table.sort(v.Data,function(a,b)if a.branch and b.branch then for w,x in pairs(a.branch.paths)do for ab,ac in pairs(b.branch.paths)do return x[1].loadms<ac[1].loadms end end elseif a.branch then for w,x in pairs(a.branch.paths)do return x[1].loadms<b.loadms end elseif b.branch then for w,x in pairs(b.branch.paths)do return a.loadms<x[1].loadms end else return a.loadms<b.loadms end end)Taiko.ConnectAll(v.Data)Taiko.ForAll(v.Data,function(V,D,l)V.n=l end)local as=math.max(unpack(bg))+as;local bh={s=1,e=0,n=0}local af=v.Data[1]local bi=af.loads;bh.e=bh.n;local bj=10;local function bk(w,x)print(w..': '..tostring(x)..string.rep(' ',bj))end;local bl=''local function bm(e)bl=bl..'\n'..e end;local function bn()print(bl)end;b8.ClearScreen()local ag='M'local bo=0;local bp=0;local bq=os.clock()if not ap.on then while true do local aO=aB.New()local br=os.clock()local e=br-bq;local p=e*1000;if af then if af.loadms<p then bh.n=bh.n+1;bh.e=af.n;bh[af.n]=af;af=af.nextnote;if af and af.branch then bm('branch')af=af.branch.paths[ag][1]end end else if p>as then break end end;for D=bh.s,bh.e do local V=bh[D]if V then V.p=bf(V,p)if V.p<av-ar then if V.endnote and V.endnote.done~=true then else V.done=true;bh[D]=nil;if af and bh.n==0 then bh.s=af.n elseif V.n==bh.s then if V.n==bh.e then bh.n=0 else local ae=bh.s;repeat ae=ae+1;bh.n=bh.n-1 until bh[ae]bh.s=ae end end end end;if V.p<aw+aq then if V.data=='event'then if V.event=='barline'then aV(aO,V)end elseif V.data=='note'then b4(aO,V)else error('Invalid note.data')end end end end;b8.SetCursor(1,1)print(aO)bo=bo+1;local bs=os.clock()-br;bp=bp+bs end else while true do local aO=aB.New()local br=os.clock()local e=1/ap.fps*bo;local p=e*1000;if af then if af.loadms<p then bh.n=bh.n+1;bh.e=af.n;bh[af.n]=af;af=af.nextnote;if af and af.branch then bm('branch')af=af.branch.paths[ag][1]end end else if p>as then break end end;for D=bh.s,bh.e do local V=bh[D]if V then V.p=bf(V,p)if V.p<av-ar then if V.endnote and V.endnote.done~=true then else V.done=true;bh[D]=nil;if af and bh.n==0 then bh.s=af.n elseif V.n==bh.s then if V.n==bh.e then bh.n=0 else local ae=bh.s;repeat ae=ae+1;bh.n=bh.n-1 until bh[ae]bh.s=ae end end end end;if V.p<aw+aq then if V.data=='event'then if V.event=='barline'then aV(aO,V)end elseif V.data=='note'then b4(aO,V)else error('Invalid note.data')end end end end;b8.SetCursor(1,1)ap.frames[bo]=aO;bo=bo+1;local bs=os.clock()-br;bp=bp+bs;bk('S',e)bk('Ms',p)bk('Loaded',bh.n)bk('Frames Rendered',bo)bk('Last Frame Render (s)',bs)bk('Last Frame Render (ms)',bs*1000)bk('Frame Render Total (s)',bp)bk('Frame Render Total (ms)',bp*1000)bk('Frame Render Total (%)',bp/e*100)bk('FPS (Frame)',bo/e)bk('Memory Usage (mb)',collectgarbage('count')/1000)bk('Finished (%)',p/as*100)bn()end;print('Prerendering Finished!\nPress enter to start')io.read()local bt=os.clock()local a6=1/ap.fps;while true do local e=os.clock()-bt;local bu=ap.frames[math.floor((e-e%a6)/a6+0.5)]if bu==nil then break end;b8.SetCursor(1,1)print(bu)end end end;function scandir(bv)local D,N,bw=0,{},io.popen;local bx=bw('dir "'..bv..'" /b')for by in bx:lines()do D=D+1;N[D]=by end;bx:close()return N end;local bz=[[C:\Users\User\OneDrive\code\Taiko\Versions\taikobuipm]]local N=scandir(bz)local bA={['Koibumi 2000.tja']=true}for D=1,#N do local file=N[D]if not bA[file]and EndsWith(file,'tja')then print(file)Taiko.ParseTJA(io.open(bz..'\\'..file,'r'):read('*all'))end end;file='./tja/donkama.tja'file='./tja/ekiben.tja'file='./tja/saitama.tja'file='./tja/funny2000.tja'file='./tja/waraeru.tja'file='../tja/donkama.tja'Taiko.PlaySong(Taiko.ParseTJA(io.open(file,'r'):read('*all')),'Oni')

Split=function(c,d)local e={}for f,g in c:gmatch("([^"..d.."]*)("..d.."?)")do table.insert(e,f)if g==''then return e end end end;Trim=function(b)local c=b:gsub("^%s*(.-)%s*$","%1")return c end;TrimLeft=function(b)local c=b:gsub("^%s*(.-)$","%1")return c end;TrimRight=function(b)local c=b:gsub("^(.-)%s*$","%1")return c end;StartsWith=function(c,d)return c:sub(1,#d)==d end;EndsWith=function(c,d)return c:sub(-#d,-1)==d end;Table={}function Table.Clone(b,c)c=c or{}local d=type(b)local e;if d=='table'then if c[b]then e=c[b]else e={}c[b]=e;for f,g in next,b,nil do e[Table.Clone(f,c)]=Table.Clone(g,c)end;setmetatable(e,Table.Clone(getmetatable(b),c))end else e=b end;return e end;ClipN=function(c,d,e)if c<d then return d elseif c>e then return e else return c end end;function Error(b)error(b)end;function ParseError(b,c,d)Error(b..': '..c.. (d and(', '..d)or''))end;function MsToS(b)return b/1000 end;function SToMs(b)return b*1000 end;Taiko={}Taiko.Data={Languages={'','EN','JA','CN','TW','KO'},GenreName={Pop={'pop','j-pop'},Anime={'anime','アニメ'},Kids={'kids','どうよう'},Variety={'variety','バラエティ'},VOCALOID={'vocaloid','ボーカロイド'},Classic={'classic','クラシック'},['Game Music']={'game music','ゲームミュージック'},['Namco Original']={'namco original','ナムコオリジナル'}},CourseId={easy=0,normal=1,hard=2,oni=3,edit=4,tower=5,dan=6,ura=4},CourseName={[0]='Easy','Normal','Hard','Oni','Edit','Tower','Dan','Ura'},RatingMultiplier={[0]=0,[1]=0.5,[2]=1,[3]=2},ScoreMode={[0]=function(b,c,d,e,f)return b+ ( ( (c<200)and(d or 1000)or( (d or 1000)+ (e or 1000)))*Taiko.Data.RatingMultiplier[f])end,[1]=function(b,c,d,e,f)return b+ (d+math.max(0,e*math.floor((math.min(c,100)-1)/10)))*Taiko.Data.RatingMultiplier[f]end,[2]=function(b,c,d,e,f)return b+ (d+e* ( (c>=100)and 8 or(c>=50)and 4 or(c>=30)and 2 or(c>=10)and 1 or 0))*Taiko.Data.RatingMultiplier[f]end},Autoscore={[0]=function(b)end,[1]=function(b)end,[2]=function(b)end},SideId={normal=1,ex=2,both=3},SideName={'normal','ex','both'},StyleId={single=1,double=2,couple=2},StyleName={'single','double'},Exam={Condition={g=true,jp=true,jg=true,jb=true,s=true,r=true,h=true,c=true},Scope={m=true,l=true}}}for b,c in pairs(Taiko.Data.ScoreMode)do Taiko.Data.ScoreMode[b]=function(...)return math.floor(c(...)/10)*10 end end;function Taiko.ParseTJA(b)local c=os.clock()local d={}local e={Metadata={BPM=120,WAVE='main.mp3',OFFSET=0,DEMOSTART=0,SCOREMODE=1,SONGVOL=100,SEVOL=100,SIDE=3,LIFE=0,GAME='Taiko',HEADSCROLL=1,MOVIEOFFSET=0,COURSE='ONI',LEVEL=0,BALLOON=nil,SCOREINIT,SCOREDIFF,BALLOONNOR=nil,BALLOONEXP=nil,BALLOONMAS=nil,STYLE=1,EXAM1=nil,EXAM2=nil,EXAM3=nil,GAUGEINCR='NORMAL',TOTAL=nil,HIDDENBRANCH=0},Data={}}local f={settings={noteparse={notealias={A=3,B=4},noteexceptions={[',']=true,[' ']=true,['\t']=true}},command={matchexceptions={}}},bpm=0,ms=0,songstarted=false,timingpoint=nil,sign=4 /4,mpm=0,mspermeasure=0,scroll=1,measuredone=true,currentmeasure={},barline=true,gogo=false,lastlong=nil,balloonn=1}local function g(p)local q=Taiko.Data.Languages;for i=1,#q do local r=e.Metadata[p..q[i]]if r then return r end end;return nil end;local function h(p,q,r)local s=tonumber(q)if s then return s else ParseError(p,r,q)end end;local function i(p,q,r,s)if q then return q else ParseError(p,r,s)end end;local function j(p,q,r)local s={['true']=true,['false']=false,yes=true,no=false,['1']=true,['0']=false,[1]=true,[0]=false}local t=s[q]~=nil;if t then return t else ParseError(p,r,q)end end;local function k(p,q)local r=','local s='\\'local u={}local v=''local w=false;for i=1,#q do local x=string.sub(q,i,i)if w then v=v..x;w=false else if x==r then table.insert(u,v)v=''elseif x==s then w=true else v=v..x end end end;table.insert(u,v)return u end;local function l(p,q,r)local s=k(p,q)for i=1,#s do s[i]=h(p,s[i],r,q)end;return a end;local function m(p,q,r)if q and q~=''then return l(p,q,r)else return{}end end;local function n(p,q,r)if q and q~=''then local u=k(p,q,r)i(p,Taiko.Data.Exam.Condition[u[1]],r)u[2]=h(p,u[2],r)u[3]=h(p,u[3],r)i(p,Taiko.Data.Exam.Scope[u[4]],r)return u else return{}end end;function f.createnote(p)if p then local q={ms=nil,data=nil,type=p,txt=nil,gogo=f.gogo,scroll=(f.scroll*e.Metadata.HEADSCROLL),mspermeasure=f.mspermeasure,bpm=f.bpm,nextnote=nil,radius=1,requiredhits=nil,length=nil,endnote=nil,onnotepush=nil}q.type=p;if p==3 or p==4 or p==6 then q.radius=q.radius*1.6 end;if p==5 or p==6 or p==7 or p==9 then if f.lastlong then ParseError('parser.noteparse','Last long note has not ended')else f.lastlong=q;if p==7 or p==9 then q.requiredhits=i('parser.noteparse',e.METADATA.BALLOON[balloonn],'Invalid number of balloons',ballonn)balloonn=balloonn+1 end end end;if p==8 then local r=f.lastlong;q.startnote=r;if r then q.onnotepush=function()r.length=q.ms-r.ms;r.endnote=q;f.lastlong=nil end else ParseError('parser.noteparse','Last long note has ended')end end;return q else return{ms=nil,data=nil,type=nil,txt=nil,gogo=f.gogo,scroll=(f.scroll*e.Metadata.HEADSCROLL),mspermeasure=f.mspermeasure,bpm=f.bpm,nextnote=nil}end end;local o=Split(b,'\n')for i=1,#o do local p=TrimLeft(o[i])if StartsWith(p,'//')or p==''then else local q=string.find(p,'//')if q then p=string.sub(p,1,q-1)end;local r=false;if f.songstarted==false and r==false then local s={string.match(p,'(%u+):(.*)')}if s[1]then local t=Trim(s[2])if t~=''then e.Metadata[Trim(s[1])]=t end;r=true end end;if(f.songstarted or StartsWith(p,'#START'))and r==false then local s={string.match(p,'#(%u-)%s(.*)')}if not s[1]then s={string.match(p,'#(%u+)')}end;if s[1]then if s[1]=='START'then if f.songstarted then ParseError(s[1],'Song has already started')else e.OriginalMetadata=Table.Clone(e.Metadata)e.Metadata.TITLE=i(s[1],g('TITLE'),'Title is missing')e.Metadata.SUBTITLE=i(s[1],g('SUBTITLE'),'Subtitle is missing')e.Metadata.BPM=h(s[1],e.Metadata.BPM,'Invalid bpm')e.Metadata.OFFSET=SToMs(h(s[1],e.Metadata.OFFSET,'Invalid offset'))e.Metadata.DEMOSTART=SToMs(h(s[1],e.Metadata.DEMOSTART,'Invalid demostart'))if e.Metadata.DEMOSTART==0 then e.Metadata.DEMOSTART=nil end;for w,x in pairs(Taiko.Data.GenreName)do for i=1,#x do if x[i]==e.Metadata.GENRE then e.Metadata.GENRE=w end end end;e.Metadata.SCOREMODE=h(s[1],e.Metadata.SCOREMODE,'Invalid scoremode')i(s[1],Taiko.Data.ScoreMode[e.Metadata.SCOREMODE],'Invalid scoremode',e.Metadata.SCOREMODE)if e.Metadata.MAKER then e.Metadata.CREATORURLT={}e.Metadata.CREATOR=Trim(string.gsub(e.Metadata.MAKER,'(<.->)',function(w)table.insert(e.Metadata.CREATORURLT,string.sub(w,2,-2))return''end))e.Metadata.CREATORURL=table.concat(e.Metadata.CREATORURLT,', ')e.Metadata.CREATIVE=false else e.Metadata.CREATIVE=false end;e.Metadata.SONGVOL=h(s[1],e.Metadata.SONGVOL,'Invalid songvol')/100;e.Metadata.SEVOL=h(s[1],e.Metadata.SEVOL,'Invalid sevol')/100;local t=tonumber(e.Metadata.SIDE)if t then i(s[1],Taiko.Data.SideName[t],'Invalid side id',e.Metadata.SIDE)e.Metadata.SIDE=t else e.Metadata.SIDE=i(s[1],Taiko.Data.SideId[string.lower(e.Metadata.SIDE)],'Invalid side name',e.Metadata.SIDE)end;e.Metadata.LIFE=h(s[1],e.Metadata.LIFE,'Invalid life')if e.Metadata.LIFE==0 then e.Metadata.LIFE=nil end;e.Metadata.GAME=string.lower(e.Metadata.GAME)if e.Metadata.GAME=='taiko'then elseif e.Metadata.GAME=='jube'then else end;e.Metadata.HEADSCROLL=h(s[1],e.Metadata.HEADSCROLL,'Invalid headscroll')e.Metadata.MOVIEOFFSET=h(s[1],e.Metadata.MOVIEOFFSET,'Invalid movieoffset')local u=tonumber(e.Metadata.COURSE)if u then i(s[1],Taiko.Data.CourseName[u],'Invalid course id',e.Metadata.COURSE)e.Metadata.COURSE=u else e.Metadata.COURSE=i(s[1],Taiko.Data.CourseId[string.lower(e.Metadata.COURSE)],'Invalid course name',e.Metadata.COURSE)end;e.Metadata.LEVEL=ClipN(math.floor(h(s[1],e.Metadata.LEVEL,'Invalid level')),0,10)e.Metadata.BALLOON=m(s[1],e.Metadata.BALLOON,'Invalid balloon')e.Metadata.SCOREINIT=h(s[1],e.Metadata.SCOREINIT,'Invalid scoreinit')e.Metadata.SCOREDIFF=h(s[1],e.Metadata.SCOREDIFF,'Invalid scoreinit')e.Metadata.BALLOONNOR=m(s[1],e.Metadata.BALLOONNOR,'Invalid balloonnor')e.Metadata.BALLOONEXP=m(s[1],e.Metadata.BALLOONEXP,'Invalid balloonexp')e.Metadata.BALLOONMAS=m(s[1],e.Metadata.BALLOONMAS,'Invalid balloonmas')local v=tonumber(e.Metadata.STYLE)if v then i(s[1],Taiko.Data.StyleName[v],'Invalid course id',Taiko.Data.STYLE)e.Metadata.STYLE=v else e.Metadata.STYLE=i(s[1],Taiko.Data.CourseId[string.lower(e.Metadata.STYLE)],'Invalid course name',e.Metadata.STYLE)end;e.Metadata.EXAM1=n(e.Metadata.EXAM1)e.Metadata.EXAM2=n(e.Metadata.EXAM2)e.Metadata.EXAM3=n(e.Metadata.EXAM3)e.Metadata.GAUGEINCR=string.lower(e.Metadata.GAUGEINCR)if e.Metadata.TOTAL then e.Metadata.TOTAL=h(s[1],e.Metadata.TOTAL,'Invalid total')end;e.Metadata.HIDDENBRANCH=j(s[1],e.Metadata.HIDDENBRANCH,'Invalid hiddenbranch')f.bpm=e.Metadata.BPM;f.songstarted=true end elseif s[1]=='END'then if f.songstarted then table.insert(d,e)e={Metadata=Table.Clone(e.OriginalMetadata),Data={}}f.songstarted=false else ParseError(s[1],'Song has already ended')end elseif s[1]=='MEASURE'then local t,u=string.match(s[2],'(%d+)/(%d+)')t=h(s[1],t,'Invalid measure')u=h(s[1],u,'Invalid measure')f.sign=(t/u)or f.sign elseif s[1]=='BPMCHANGE'then f.bpm=h(s[1],s[2],'Invalid bpmchange')or f.bpm elseif s[1]=='DELAY'then table.insert(f.currentmeasure,{s[1],SToMs((h(s[1],s[2],'Invalid delay')or 0))})elseif s[1]=='SCROLL'then f.scroll=h(s[1],s[2],'Invalid scroll')or f.scroll;if f.scroll==0 then ParseError(s[1],'Scroll cannot be 0')end elseif s[1]=='GOGOSTART'then f.gogo=true elseif s[1]=='GOGOEND'then f.gogo=false elseif s[1]=='BARLINEOFF'then f.barline=false elseif s[1]=='BARLINEON'then f.barline=true elseif s[1]=='BRANCHSTART'then elseif s[1]=='N'then elseif s[1]=='E'then elseif s[1]=='M'then elseif s[1]=='BRANCHEND'then elseif s[1]=='SECTION'then elseif s[1]=='LYRIC'then elseif s[1]=='LEVELHOLD'then elseif s[1]=='BMSCROLL'then elseif s[1]=='HBSCROLL'then elseif s[1]=='SENOTECHANGE'then elseif s[1]=='NEXTSONG'then elseif s[1]=='DIRECTION'then elseif s[1]=='SUDDEN'then elseif s[1]=='JPOSSCROLL'then else end;r=true end end;if(f.songstarted)and r==false then f.mpm=f.bpm*f.sign/4;f.mspermeasure=60000 *f.sign*4 /f.bpm;if f.barline and#f.currentmeasure==0 then local t=f.createnote()t.ms=f.ms;t.data='event't.event='barline'end;local s={}for i=1,#p do local t=string.sub(p,i,i)if f.settings.noteparse.noteexceptions[t]then else local u=h('parser.noteparse',tonumber(t)or f.settings.noteparse.notealias[t]or t,'Invalid note')if u then local v=f.createnote(u)v.data='note'table.insert(f.currentmeasure,v)end end end;if EndsWith(p,',')then f.mpm=f.bpm*f.sign/4;f.mspermeasure=60000 *f.sign*4 /f.bpm;if#f.currentmeasure==0 then f.ms=f.ms+f.mspermeasure else local t=0;local u=nil;for i=1,#f.currentmeasure do local w=f.currentmeasure[i]if w.data=='note'then u=u or w.mspermeasure;t=t+1 end end;local v=u/t;for i=1,#f.currentmeasure do local w=f.currentmeasure[i]if w[1]=='DELAY'then f.ms=f.ms+w[2]else if w.type~=0 then w.ms=f.ms;local x=e.Data[#e.Data]if x then x.nextnote=w end;table.insert(e.Data,w)if w.onnotepush then w.onnotepush()end;v=w.mspermeasure/t end end;f.ms=f.ms+v end end;f.measuredone=true;f.currentmeasure={}else f.measuredone=false end end end end;print('Parsing Took: '..SToMs(os.clock()-c)..'ms')return d end;function Taiko.Analyze(b)for i=1,#b.Data do end end;function Taiko.GetDifficulty(b,c)local d=Taiko.Data.CourseId[string.lower(c)]or c;for e,f in pairs(b)do if f.Metadata.COURSE==d then return f end end;Error('No difficulty found, '..c)return nil end;function Taiko.CalculateSpeed(b,c)local d=(c*b.scroll*b.bpm/7500)return d end;function Taiko.CalculateSpeedAll(b,c)for i=1,#b.Data do b.Data[i].speed=Taiko.CalculateSpeed(b.Data[i],c)end;return b end;function Taiko.RenderScale(b)local c={}local d={}local e={}for i=1,#b.Data do local j=b.Data[i]if j.data=='note'then local k=math.floor(j.ms)if math.floor(k)-k==0 then table.insert(c,{k,j.type})table.insert(d,k)else table.insert(e,i)end end end;function gcd2(i,j)if j==0 then return i else return gcd2(j,i%j)end end;function gcdn(i)local j=i[1]for i=2,#i do j=gcd2(j,i[i])end;return j end;local f=gcdn(d)for i=1,#e do local j=c[e[i]]j[1]=math.floor(j[1]/f)*f end;local g=''local h=0;for i=1,#c do c[i][1]=c[i][1]/f;g=g..string.rep(' ',c[i][1]-h)..c[i][2]h=c[i][1]end;return g end;function Taiko.PlaySong(b,c)local d=100;local e=10;local f=1000;local g=100;local h=4;local i=0;local j=40;local k=3;local l=1;local m={{color='red'},{color='blue'},{color='red'},{color='blue'}}j=math.floor(j*h)k=math.floor(k*h)local n=require('Pixels')local o,p=0,j;n.Convert.ToDots=function(F)F=GetPixelData(F)local G,H=F.Data,F.Color;if ReverseY then local function T(U)local V={}for W,X in pairs(U)do for Y,Z in pairs(X)do V[W]=V[W]or{}V[W][-Y]=Z end end;return V end;G=T(G)H=T(H)end;F={Data=G,Color=H}local function I(T)local U=nil;for V,W in pairs(T)do if not U or V<U then U=V end end;return U end;local function J(T)local U=nil;for V,W in pairs(T)do if not U or V>U then U=V end end;return U end;local function K(T,U)local V={}for W,X in pairs(T)do local Y=U(X)if Y then V[Y]=true end end;return U(V)end;local L,M=K(G,I),K(G,J)local N={}local O=string.rep('0',8)local P=n.Data.Dot[O]local Q=nil;local R=nil;if F.Color.All then local T=tostring(n.Color(F.Color.All))table.insert(N,T)R=T end;local S={}for T,U in pairs(G)do for V,W in pairs(U)do S[V]=S[V]or{}S[V][T]=W end end;if not L then return''end;for y=L,M,4 do for x=o,p,2 do local T=''local U={{0,0},{0,1},{0,2},{0,3},{1,0},{1,1},{1,2},{1,3}}for i=1,8 do local V,W=x+U[i][1],y+U[i][2]T=T.. ( (G[V]and G[V][W]or false)and G[V][W]or n.Data.Empty)end;if T~=O then T=n.Data.Dot[T]if not R then local V=n.GetColor(F,x,y)if not V then local W={{0,0},{0,1},{0,2},{0,3},{1,0},{1,1},{1,2},{1,3}}for i=1,8 do V=n.GetColor(F,x+W[i][1],y+W[i][2])if V then break end end end;if V then V=tostring(n.Color(V))else V=tostring(n.Color('reset'))end;if Q==V then else table.insert(N,V)Q=V end end;table.insert(N,T)else table.insert(N,P)end end;table.insert(N,n.Data.NewLine)end;table.insert(N,tostring(n.Color('reset')))return table.concat(N)end;local function q(F,G)n.Circle(F,math.floor(G.p),i,h*G.radius,m[G.type])end;local function r(F,G,H)local I=(0 -e)if G<I then G=I end;local J=(j+e)if H>J then H=J end;local K=i-h;local L=i+h;for y=K,L do for x=G,H do n.SetPixel(F,x,y,'1')end end end;local function s(F,G)local H=G.type;if H==1 or H==2 or H==3 or H==4 then q(F,G)elseif H==5 or H==6 then q(F,G)local I=G.endnote;local J=(I.ms-G.ms)*G.speed;q(F,G)local K,L=math.floor(G.p),math.floor(G.p+J)r(F,K,L)elseif H==8 then if G.renderproxy then G.renderproxy.p=G.p else local I=G.startnote;G.renderproxy={}for J,K in pairs(I)do if J~='type'then G.renderproxy[J]=K end end end;G.renderproxy.p=G.p;q(F,G.renderproxy)end end;local t={ClearScreen=function()io.write("\27[2J")end,SetCursor=function(F,G)io.write(string.format("\27[%d;%dH",G,F))end}b=Taiko.CalculateSpeedAll(Taiko.GetDifficulty(b,c),h)local function u(F,G)return G- ( (j/F.speed)+d)end;local function v(F,G)return(F.ms-G)*F.speed+k end;local function w(F,G)return F.loadp- (F.speed* (G-F.loadms))end;local x={}for F,G in pairs(b.Data)do table.insert(x,G.ms)G.ms=G.ms+f;G.s=MsToS(G.ms)G.loadms=u(G,G.ms)G.loads=MsToS(G.loadms)G.loadp=v(G,G.loadms)end;table.sort(b.Data,function(F,G)return F.loadms<G.loadms end)local z=nil;for i=#b.Data,1,-1 do local F=b.Data[i]F.n=i;F.nextnote=z;z=F end;ends=MsToS(math.max(unpack(x))+g)local A={s=1,e=0,n=0}local B=b.Data[1]local C=B.loads;while true do if B then if C<0 then B.p=w(B,0)A.n=A.n+1;A[A.n]=B end else break end;if C>0 then break end;B=B.nextnote;C=B.loads end;A.e=A.n;t.ClearScreen()local D=os.clock()local E=D*1000;while true do local F=n.New()local G=os.clock()-D;local H=G*1000;if B and B.loadms<H then A.n=A.n+1;A.e=B.n;A[B.n]=B;B=B.nextnote end;for i=A.s,A.e do local J=A[i]if J then J.p=w(J,H)if(J.p< (0 -e))and(J.endnote==nil)then A[i]=nil;if A.n==0 then A.s=B.n elseif J.n==A.s then if J.n==A.e then A.n=0 else local K=A.s;repeat K=K+1;A.n=A.n-1 until A[K]A.s=K end end end;if J.p<j then s(F,J)end end end;t.SetCursor(1,1)print(F)print(H-E)local I=1000 / (H-E)print(I)E=H end end;file='./tja/donkama.tja'Taiko.PlaySong(Taiko.ParseTJA(io.open(file,'r'):read('*all')),'Oni')
Split=function(j,k)local l={}for m,n in j:gmatch("([^"..k.."]*)("..k.."?)")do table.insert(l,m)if n==''then return l end end end;Trim=function(j)local k=j:gsub("^%s*(.-)%s*$","%1")return k end;TrimLeft=function(j)local k=j:gsub("^%s*(.-)$","%1")return k end;TrimRight=function(j)local k=j:gsub("^(.-)%s*$","%1")return k end;StartsWith=function(j,k)return j:sub(1,#k)==k end;EndsWith=function(j,k)return j:sub(-#k,-1)==k end;Table={}function Table.Clone(j,k)k=k or{}local l=type(j)local m;if l=='table'then if k[j]then m=k[j]else m={}k[j]=m;for n,o in next,j,nil do m[Table.Clone(n,k)]=Table.Clone(o,k)end;setmetatable(m,Table.Clone(getmetatable(j),k))end else m=j end;return m end;ClipN=function(j,k,l)if j<k then return k elseif j>l then return l else return j end end;function Error(j)print(j)end;LineN=nil;function ParseError(j,k,l)Error('Line: '..LineN..'\n'..j..': '..k.. (l and(', '..l)or''))end;function MsToS(j)return j/1000 end;function SToMs(j)return j*1000 end;Taiko={}Taiko.Data={Languages={'','EN','JA','CN','TW','KO'},GenreName={Pop={'pop','j-pop'},Anime={'anime','アニメ'},Kids={'kids','どうよう'},Variety={'variety','バラエティ'},VOCALOID={'vocaloid','ボーカロイド'},Classic={'classic','クラシック'},['Game Music']={'game music','ゲームミュージック'},['Namco Original']={'namco original','ナムコオリジナル'}},CourseId={easy=0,normal=1,hard=2,oni=3,edit=4,tower=5,dan=6,ura=4},CourseName={[0]='Easy','Normal','Hard','Oni','Edit','Tower','Dan','Ura'},RatingMultiplier={[0]=0,[1]=0.5,[2]=1,[3]=2},GogoMultiplier=1.2,ScoreMode={[0]=function(j,k,l,m,n,o)return j+ ( ( (k<200)and(l or 1000)or( (l or 1000)+ (m or 1000)))*Taiko.Data.RatingMultiplier[n]* (o and Taiko.Data.GogoMultiplier or 1))end,[1]=function(j,k,l,m,n,o)return j+ ( (l+math.max(0,m*math.floor((math.min(k,100)-1)/10)))*Taiko.Data.RatingMultiplier[n]* (o and Taiko.Data.GogoMultiplier or 1))end,[2]=function(j,k,l,m,n,o)return j+ ( (l+m* ( (k>=100)and 8 or(k>=50)and 4 or(k>=30)and 2 or(k>=10)and 1 or 0))*Taiko.Data.RatingMultiplier[n]* (o and Taiko.Data.GogoMultiplier or 1))end},Autoscore={[0]=function(j)end,[1]=function(j)end,[2]=function(j)end},SideId={normal=1,ex=2,both=3},SideName={'normal','ex','both'},StyleId={single=1,double=2,couple=2},StyleName={'single','double'},Exam={Condition={g=true,jp=true,jg=true,jb=true,s=true,r=true,h=true,c=true},Scope={m=true,l=true}},Branch={PathId={N=0,E=1,M=2},PathName={[0]='N',[1]='E',[2]='M'},Requirements={r=function()end,p=function()end}},Timing={GetFunction=function(j)return function(k)if j==1 then return{good=5 /2 *k,ok=13 /2 *k,bad=15 /2 *k}else return{good=3 /2 *k,ok=9 /2 *k,bad=13 /2 *k}end end end},StatusId={bad=0,ok=1,good=2,biggood=3},StatusName={[0]='BAD',[1]='OK',[2]='GOOD',[3]='GOOD'},ModeId={['']=0,P1=1,P2=2},ModeName={[0]='',P1,P2},Combo={[1]=true,[2]=true,[3]=true,[4]=true},BigLeniency=2}for j,l in pairs(Taiko.Data.ScoreMode)do Taiko.Data.ScoreMode[j]=function(...)return math.floor(l(...)/10)*10 end end;function Taiko.ParseTJA(j)local k=os.clock()local l={}local m={Metadata={BPM=120,WAVE='main.mp3',OFFSET=0,DEMOSTART=0,SCOREMODE=1,SONGVOL=100,SEVOL=100,SIDE=3,LIFE=0,GAME='Taiko',HEADSCROLL=1,MOVIEOFFSET=0,COURSE='ONI',LEVEL=0,BALLOON=nil,SCOREINIT,SCOREDIFF,BALLOONNOR=nil,BALLOONEXP=nil,BALLOONMAS=nil,STYLE=1,EXAM1=nil,EXAM2=nil,EXAM3=nil,GAUGEINCR='NORMAL',TOTAL=nil,HIDDENBRANCH=0,DIVERGENOTES=false,SCOREINIT=0,SCOREDIFF=0},Data={}}local function n(z)local A=Taiko.Data.Languages;for i=1,#A do local B=m.Metadata[z..A[i]]if B then return B end end;return nil end;local function o(z,A,B)local C=tonumber(A)if C then return C else ParseError(z,B,A)end end;local function p(z,A,B,C)if A then return A else ParseError(z,B,C)end end;local function q(z,A,B)local C={['true']=true,['false']=false,yes=true,no=false,['1']=true,['0']=false,[1]=true,[0]=false}local D=C[A]~=nil;if D then return D else ParseError(z,B,A)end end;local function r(z,A)local B=','local C='\\'local D={}local E=''local F=false;for i=1,#A do local G=string.sub(A,i,i)if F then E=E..G;F=false else if G==B then table.insert(D,E)E=''elseif G==C then F=true else E=E..G end end end;table.insert(D,E)return D end;local function s(z,A,B)local C=r(z,A)for i=1,#C do C[i]=o(z,C[i],B,A)end;return C end;local function u(z,A,B)if A and A~=''then return s(z,A,B)else return{}end end;local function v(z,A,B)if A and A~=''then local C=r(z,A,B)p(z,Taiko.Data.Exam.Condition[C[1]],B)C[2]=o(z,C[2],B)C[3]=o(z,C[3],B)p(z,Taiko.Data.Exam.Scope[C[4]],B)return C else return{}end end;local w={}local function x()local z={settings={noteparse={notealias={A=3,B=4},noteexceptions={[',']=true,[' ']=true,['\t']=true}},command={matchexceptions={}}},bpm=0,ms=0,songstarted=false,timingpoint=nil,sign=4 /4,mpm=0,mspermeasure=0,scroll=1,measuredone=true,currentmeasure={},measurepushto=m.Data,barline=true,gogo=false,lastlong=nil,balloonn=1,currentbranch=nil,branch={on=false,requirements={},paths={}},msbeforebranch=nil}function z.createnote(A)if A then local B={ms=nil,data=nil,type=A,txt=nil,gogo=z.gogo,scroll=(z.scroll*m.Metadata.HEADSCROLL),mspermeasure=z.mspermeasure,bpm=z.bpm,nextnote=nil,radius=1,requiredhits=nil,length=nil,endnote=nil,onnotepush=nil}B.type=A;if A==3 or A==4 or A==6 then B.radius=B.radius*1.6 end;if A==5 or A==6 or A==7 or A==9 then if z.lastlong then if A==9 then else ParseError('parser.noteparse','Last long note has not ended')end else z.lastlong=B;if A==7 or A==9 then B.requiredhits=p('parser.noteparse',m.Metadata.BALLOON[z.balloonn],'Invalid number of balloons',z.balloonn)z.balloonn=z.balloonn+1 end end end;if A==8 then local C=z.lastlong;z.lastlong=nil;B.startnote=C;if C then B.onnotepush=function()C.length=B.ms-C.ms;C.endnote=B end else end end;return B else return{ms=nil,data=nil,type=nil,txt=nil,gogo=z.gogo,scroll=(z.scroll*m.Metadata.HEADSCROLL),mspermeasure=z.mspermeasure,bpm=z.bpm,nextnote=nil}end end;function z.endbranch()local A=z.createnote()A.data='event'A.event='branch'A.branch={requirements=z.branch.requirements,paths=z.branch.paths}z.branch.on=false;z.branch.requirements={}z.branch.paths={}table.insert(m.Data,A)z.measurepushto=m.Data end;return z end;w=x()local y=Split(j,'\n')for i=1,#y do LineN=i;local z=Trim(y[i])if StartsWith(z,'//')or z==''then else local A=string.find(z,'//')if A then z=string.sub(z,1,A-1)end;local B=false;if w.songstarted==false and B==false then local C={string.match(z,'(%u+):(.*)')}if C[1]then local D=Trim(C[2])if D~=''then m.Metadata[Trim(C[1])]=D end;B=true end end;if(w.songstarted or StartsWith(z,'#START'))and B==false then local C={string.match(z,'#(%u-)%s(.*)')}if not C[1]then C={string.match(z,'#(%u+)')}end;if C[1]then if C[1]=='START'then if w.songstarted then ParseError(C[1],'Song has already started')else m.OriginalMetadata=Table.Clone(m.Metadata)if C[2]then m.Metadata.MODE=p(C[1],Taiko.Data.ModeId[C[2]],'Invalid mode',C[2])else m.Metadata.MODE=0 end;m.Metadata.TITLE=p(C[1],n('TITLE'),'Title is missing')m.Metadata.SUBTITLE=p(C[1],n('SUBTITLE'),'Subtitle is missing')m.Metadata.BPM=o(C[1],m.Metadata.BPM,'Invalid bpm')m.Metadata.OFFSET=SToMs(o(C[1],m.Metadata.OFFSET,'Invalid offset'))m.Metadata.DEMOSTART=SToMs(o(C[1],m.Metadata.DEMOSTART,'Invalid demostart'))if m.Metadata.DEMOSTART==0 then m.Metadata.DEMOSTART=nil end;for G,H in pairs(Taiko.Data.GenreName)do for i=1,#H do if H[i]==m.Metadata.GENRE then m.Metadata.GENRE=G end end end;m.Metadata.SCOREMODE=o(C[1],m.Metadata.SCOREMODE,'Invalid scoremode')p(C[1],Taiko.Data.ScoreMode[m.Metadata.SCOREMODE],'Invalid scoremode',m.Metadata.SCOREMODE)if m.Metadata.MAKER then m.Metadata.CREATORURLT={}m.Metadata.CREATOR=Trim(string.gsub(m.Metadata.MAKER,'(<.->)',function(G)table.insert(m.Metadata.CREATORURLT,string.sub(G,2,-2))return''end))m.Metadata.CREATORURL=table.concat(m.Metadata.CREATORURLT,', ')m.Metadata.CREATIVE=false else m.Metadata.CREATIVE=false end;m.Metadata.SONGVOL=o(C[1],m.Metadata.SONGVOL,'Invalid songvol')/100;m.Metadata.SEVOL=o(C[1],m.Metadata.SEVOL,'Invalid sevol')/100;local D=tonumber(m.Metadata.SIDE)if D then p(C[1],Taiko.Data.SideName[D],'Invalid side id',m.Metadata.SIDE)m.Metadata.SIDE=D else m.Metadata.SIDE=p(C[1],Taiko.Data.SideId[string.lower(m.Metadata.SIDE)],'Invalid side name',m.Metadata.SIDE)end;m.Metadata.LIFE=o(C[1],m.Metadata.LIFE,'Invalid life')if m.Metadata.LIFE==0 then m.Metadata.LIFE=nil end;m.Metadata.GAME=string.lower(m.Metadata.GAME)if m.Metadata.GAME=='taiko'then elseif m.Metadata.GAME=='jube'then else end;m.Metadata.HEADSCROLL=o(C[1],m.Metadata.HEADSCROLL,'Invalid headscroll')m.Metadata.MOVIEOFFSET=o(C[1],m.Metadata.MOVIEOFFSET,'Invalid movieoffset')local E=tonumber(m.Metadata.COURSE)if E then p(C[1],Taiko.Data.CourseName[E],'Invalid course id',m.Metadata.COURSE)m.Metadata.COURSE=E else m.Metadata.COURSE=p(C[1],Taiko.Data.CourseId[string.lower(m.Metadata.COURSE)],'Invalid course name',m.Metadata.COURSE)end;m.Metadata.TIMING=Taiko.Data.Timing.GetFunction(m.Metadata.COURSE)m.Metadata.LEVEL=ClipN(math.floor(o(C[1],m.Metadata.LEVEL,'Invalid level')),0,10)m.Metadata.BALLOON=u(C[1],m.Metadata.BALLOON,'Invalid balloon')m.Metadata.SCOREINIT=o(C[1],m.Metadata.SCOREINIT,'Invalid scoreinit')m.Metadata.SCOREDIFF=o(C[1],m.Metadata.SCOREDIFF,'Invalid scoreinit')m.Metadata.BALLOONNOR=u(C[1],m.Metadata.BALLOONNOR,'Invalid balloonnor')m.Metadata.BALLOONEXP=u(C[1],m.Metadata.BALLOONEXP,'Invalid balloonexp')m.Metadata.BALLOONMAS=u(C[1],m.Metadata.BALLOONMAS,'Invalid balloonmas')local F=tonumber(m.Metadata.STYLE)if F then p(C[1],Taiko.Data.StyleName[F],'Invalid style id',Taiko.Data.STYLE)m.Metadata.STYLE=F else m.Metadata.STYLE=p(C[1],Taiko.Data.StyleId[string.lower(m.Metadata.STYLE)],'Invalid style name',m.Metadata.STYLE)end;m.Metadata.EXAM1=v(m.Metadata.EXAM1)m.Metadata.EXAM2=v(m.Metadata.EXAM2)m.Metadata.EXAM3=v(m.Metadata.EXAM3)m.Metadata.GAUGEINCR=string.lower(m.Metadata.GAUGEINCR)if m.Metadata.TOTAL then m.Metadata.TOTAL=o(C[1],m.Metadata.TOTAL,'Invalid total')end;m.Metadata.HIDDENBRANCH=q(C[1],m.Metadata.HIDDENBRANCH,'Invalid hiddenbranch')w.bpm=m.Metadata.BPM;w.songstarted=true end elseif C[1]=='END'then if w.songstarted then if#w.currentmeasure~=0 then ParseError(C[1],'Current measure is not empty')end;table.insert(l,m)m={Metadata=Table.Clone(m.OriginalMetadata),Data={}}w=x()w.songstarted=false;w.measurepushto=m.Data else ParseError(C[1],'Song has already ended')end elseif C[1]=='MEASURE'then local D,E=string.match(C[2],'(%d+)/(%d+)')D=o(C[1],D,'Invalid measure')E=o(C[1],E,'Invalid measure')w.sign=(D/E)or w.sign elseif C[1]=='BPMCHANGE'then w.bpm=o(C[1],C[2],'Invalid bpmchange')or w.bpm elseif C[1]=='DELAY'then table.insert(w.currentmeasure,{C[1],SToMs((o(C[1],C[2],'Invalid delay')or 0))})elseif C[1]=='SCROLL'then w.scroll=o(C[1],C[2],'Invalid scroll')or w.scroll;if w.scroll==0 then ParseError(C[1],'Scroll cannot be 0')end elseif C[1]=='GOGOSTART'then w.gogo=true elseif C[1]=='GOGOEND'then w.gogo=false elseif C[1]=='BARLINEOFF'then w.barline=false elseif C[1]=='BARLINEON'then w.barline=true elseif C[1]=='BRANCHSTART'then if w.branch.on then w.endbranch()end;w.msbeforebranch=w.ms;w.branch.on=true;m.Metadata.DIVERGENOTES=true;local D=r(C[1],C[2])local E=p(C[1],Taiko.Data.Branch.Requirements[string.lower(D[1])],'Invalid type',D[1])w.branch.requirements={E}local F=2;while true do if not D[F]then break end;local G=Taiko.Data.Branch.PathName[F-1]if G then w.branch.requirements[G]=D[F]else break end;F=F+1 end elseif Taiko.Data.Branch.PathId[C[1]]then if w.branch.on then w.ms=w.msbeforebranch;w.currentbranch=C[1]w.branch.paths[C[1]]={}w.measurepushto=w.branch.paths[C[1]]else ParseError(C[1],'Branch has not started')end elseif C[1]=='BRANCHEND'then if w.branch.on then w.endbranch()else ParseError(C[1],'Branch has already ended')end elseif C[1]=='SECTION'then elseif C[1]=='LYRIC'then elseif C[1]=='LEVELHOLD'then elseif C[1]=='BMSCROLL'then elseif C[1]=='HBSCROLL'then elseif C[1]=='SENOTECHANGE'then elseif C[1]=='NEXTSONG'then elseif C[1]=='DIRECTION'then elseif C[1]=='SUDDEN'then elseif C[1]=='JPOSSCROLL'then else end;B=true end end;if(w.songstarted)and B==false then w.mpm=w.bpm*w.sign/4;w.mspermeasure=60000 *w.sign*4 /w.bpm;if w.barline and#w.currentmeasure==0 then local C=w.createnote()C.ms=w.ms;C.data='event'C.event='barline'table.insert(w.measurepushto,1,C)end;for i=1,#z do local C=string.sub(z,i,i)if w.settings.noteparse.noteexceptions[C]then else local D=o('parser.noteparse',tonumber(C)or w.settings.noteparse.notealias[C]or C,'Invalid note')if D then local E=w.createnote(D)E.data='note'table.insert(w.currentmeasure,E)end end end;if EndsWith(TrimRight(z),',')then w.mpm=w.bpm*w.sign/4;w.mspermeasure=60000 *w.sign*4 /w.bpm;if#w.currentmeasure==0 then w.ms=w.ms+w.mspermeasure else local C=0;local D=nil;for i=1,#w.currentmeasure do local F=w.currentmeasure[i]if F.data=='note'then D=D or F.mspermeasure;C=C+1 end end;D=D or w.mspermeasure;local E=D/C;for i=1,#w.currentmeasure do local F=w.currentmeasure[i]if F[1]=='DELAY'then w.ms=w.ms+F[2]else if F.type~=0 then F.ms=w.ms;local G=m.Data[#m.Data]if G then G.nextnote=F end;table.insert(w.measurepushto,F)if F.onnotepush then F.onnotepush()end;E=F.mspermeasure/C end end;w.ms=w.ms+E end end;w.measuredone=true;w.currentmeasure={}else w.measuredone=false end end end end;print('Parsing Took: '..SToMs(os.clock()-k)..'ms')return l end;function Taiko.Score(j,k,l,m,n)if m==0 then l=0 else l=l+1 end;local o=j.Metadata;return Taiko.Data.ScoreMode[o.SCOREMODE](k,l,o.SCOREINIT,o.SCOREDIFF,m,n),l end;function Taiko.Analyze(j)local k='M'local l={[1]=2,[2]=2,[3]=3,[4]=3}local m={notes={n=0,validn=0},measures=0,lengthms=0,drumrollms=0,drumrollbigms=0,balloonms=0,balloonhit=0,specialms=0,specialhit=0,maxcombo=0,maxscore=0}local n=nil;Taiko.ForAll(j.Data,function(o,p,q)if o.data=='note'then m.notes.n=m.notes.n+1;m.notes[o.type]=m.notes[o.type]and m.notes[o.type]+1 or 1;if l[o.type]then m.maxscore,m.maxcombo=Taiko.Score(j,m.maxscore,m.maxcombo,l[o.type],o.gogo)end;local r=o.endnote;if r then local s=r.ms-o.ms;if o.type==5 then m.drumrollms=m.drumrollms+s elseif o.type==6 then m.drumrollbigms=m.drumrollbigms+s elseif o.type==7 then m.balloonms=m.balloonms+s;m.balloonhit=m.balloonhit+o.requiredhits elseif o.type==9 then m.specialms=m.specialms+s;m.specialhit=m.specialhit+o.requiredhits else end end;n=o elseif o.data=='event'and o.event=='barline'then m.measures=m.measures+1 else end end,k)m.lengthms=n.ms-j.Metadata.OFFSET;m.notes.validn=m.maxcombo;return m end;function Taiko.GetDifficulty(j,k)local l=Taiko.Data.CourseId[string.lower(k)]or k;for m,n in pairs(j)do if n.Metadata.COURSE==l then return n end end;Error('No difficulty found, '..k)return nil end;function Taiko.ForAll(j,k,l)local m=1;for i=1,#j do local o=j[i]if o.branch then if l then local p=o.branch.paths[l]for i2=1,#p do k(p[i2],i2,m)m=m+1 end;m=m-1 else local p=-1;for q,r in pairs(o.branch.paths)do local s=m;for i2=1,#r do k(r[i2],i2,s)s=s+1 end;p=(p<s)and s or p end;m=p end else k(o,i,m)end;m=m+1 end;return j end;function Taiko.GetAllNotes(j)local k={}for l,m in pairs(j)do if m.branch then for n,o in pairs(m.branch.paths)do for i=1,#o do table.insert(k,o[i])end end else table.insert(k,m)end end;return k end;function Taiko.ConnectNotes(j)local k=nil;for i=#j,1,-1 do local l=j[i]l.nextnote=k;k=l end;return j end;function Taiko.ExtractBranch(j,k)return j.branch.paths[k]end;function Taiko.ConnectAll(j)local k=nil;for i=#j,1,-1 do local l=j[i]if l.branch then for m,n in pairs(l.branch.paths)do local o=Taiko.ConnectNotes(n)o[#o].nextnote=k end else l.nextnote=k end;k=l end end;function Taiko.CalculateSpeed(j,k)local l=(k*j.scroll*j.bpm/7500)return l end;function Taiko.CalculateSpeedAll(j,k)for i=1,#j do j[i].speed=Taiko.CalculateSpeed(j[i],k)end;return j end;function Taiko.RenderScale(j)local k={}local l={}local m={}for i=1,#j.Data do local q=j.Data[i]if q.data=='note'then local r=math.floor(q.ms)if math.floor(r)-r==0 then table.insert(k,{r,q.type})table.insert(l,r)else table.insert(m,i)end end end;function gcd2(q,r)if r==0 then return q else return gcd2(r,q%r)end end;function gcdn(q)local s=q[1]for i=2,#q do s=gcd2(s,q[i])end;return s end;local n=gcdn(l)for i=1,#m do local q=k[m[i]]q[1]=math.floor(q[1]/n)*n end;local o=''local p=0;for i=1,#k do k[i][1]=k[i][1]/n;o=o..string.rep(' ',k[i][1]-p)..k[i][2]p=k[i][1]end;return o end;function Taiko.PlaySong(j,k,l)local m={on=false,fps=60,frames={}}local n=nil;local o=false;local p=false;local q=k or{}q={Hit=q.Hit or{['4']=2,['v']=1,['n']=1,['8']=2},Escape=q.Escape or{['\27']=true,ALT_ESC=true},L=q.L or{KEY_LEFT=true,KEY_SLEFT=true,CTL_LEFT=true,KEY_B1=true,ALT_LEFT=true,KEY_SHIFT_L=true,KEY_UP=true,KEY_A2=true},R=q.R or{KEY_RIGHT=true,KEY_SRIGHT=true,CTL_RIGHT=true,KEY_B3=true,ALT_RIGHT=true,KEY_SHIFT_R=true,KEY_DOWN=true,KEY_C2=true},Select=q.Select or{KEY_ENTER=true,PADENTER=true,CTL_PADENTER=true,ALT_PADENTER=true,CTL_PADCENTER=true,ALT_ENTER=true,CTL_ENTER=true,SHF_PADENTER=true,['\n']=true,['\r']=true}}local r=1;local s=2;local u='>'local v='\n\n\n'local w=10;local x=1000;local z=4;local A=0;local B=10;local C=0;local D=40;local E=3;local F=1;local G={[1]={color='red'},[2]={color='blue'},[3]={color='red'},[4]={color='blue'},[5]={color='yellow'},[6]={color='yellow'}}local H=200;local I=H/4;local J=4;local K=20;D=math.floor(D*z)local L=C+D;E=math.floor(E*z)local M=require('taikocurses')local N=l or{window=M.initscr()}M.keypad(N,true)M.echo(false)M.raw(true)M.nl(false)M.cbreak(true)M.nodelay(N,true)local O={[0]={Data={[1]={'0','1','1','1','1','1','1','1'},[2]={[2]='1',[5]='1',[8]='1'},[3]={[2]='1',[5]='1',[8]='1'},[4]={[2]='1',[5]='1',[8]='1'},[5]={[2]='1',[5]='1',[8]='1'},[6]={[3]='1',[4]='1',[6]='1',[7]='1'},[8]={'0','0','1','1','1','1','1','1'},[9]={[2]='1',[5]='1'},[10]={[2]='1',[5]='1'},[11]={[2]='1',[5]='1'},[12]={[2]='1',[5]='1'},[13]={'0','0','1','1','1','1','1','1'},[15]={'0','1','1','1','1','1','1','1'},[16]={[2]='1',[8]='1'},[17]={[2]='1',[8]='1'},[18]={[2]='1',[8]='1'},[19]={[2]='1',[8]='1'},[20]={'0','0','1','1','1','1','1','0'}},Color={All='blue'},Offset={-1,0}},[1]={Data={[1]={'0','0','1','1','1','1','1','0'},[2]={[2]='1',[8]='1'},[3]={[2]='1',[8]='1'},[4]={[2]='1',[8]='1'},[5]={[2]='1',[8]='1'},[6]={'0','0','1','1','1','1','1','0'},[8]={'0','1','1','1','1','1','1','1'},[9]={[5]='1'},[10]={[4]='1',[6]='1'},[11]={[3]='1',[7]='1'},[12]={[2]='1',[8]='1'}},Color={All='white'},Offset={-1,0}},[2]={Data={[1]={'0','0','1','1','1','1','1','0'},[2]={[2]='1',[8]='1'},[3]={[2]='1',[8]='1'},[4]={[2]='1',[5]='1',[8]='1'},[5]={[2]='1',[5]='1',[8]='1'},[6]={'0','1','0','0','1','1','1','1'},[8]={'0','0','1','1','1','1','1','0'},[9]={[2]='1',[8]='1'},[10]={[2]='1',[8]='1'},[11]={[2]='1',[8]='1'},[12]={[2]='1',[8]='1'},[13]={'0','0','1','1','1','1','1','0'},[15]={'0','0','1','1','1','1','1','0'},[16]={[2]='1',[8]='1'},[17]={[2]='1',[8]='1'},[18]={[2]='1',[8]='1'},[19]={[2]='1',[8]='1'},[20]={'0','0','1','1','1','1','1','0'},[22]={'0','1','1','1','1','1','1','1'},[23]={[2]='1',[8]='1'},[24]={[2]='1',[8]='1'},[25]={[2]='1',[8]='1'},[26]={[2]='1',[8]='1'},[27]={'0','0','1','1','1','1','1','0'}},Color={All='yellow'},Offset={-1,0}}}O[3]=O[2]local P={[0]=nil,[1]={},[2]={}}Pixel={}local Q=([[
⠀ ⢀ ⠠ ⢠ ⠐ ⢐ ⠰ ⢰ ⠈ ⢈ ⠨ ⢨ ⠘ ⢘ ⠸ ⢸
⡀ ⣀ ⡠ ⣠ ⡐ ⣐ ⡰ ⣰ ⡈ ⣈ ⡨ ⣨ ⡘ ⣘ ⡸ ⣸
⠄ ⢄ ⠤ ⢤ ⠔ ⢔ ⠴ ⢴ ⠌ ⢌ ⠬ ⢬ ⠜ ⢜ ⠼ ⢼
⡄ ⣄ ⡤ ⣤ ⡔ ⣔ ⡴ ⣴ ⡌ ⣌ ⡬ ⣬ ⡜ ⣜ ⡼ ⣼
⠂ ⢂ ⠢ ⢢ ⠒ ⢒ ⠲ ⢲ ⠊ ⢊ ⠪ ⢪ ⠚ ⢚ ⠺ ⢺
⡂ ⣂ ⡢ ⣢ ⡒ ⣒ ⡲ ⣲ ⡊ ⣊ ⡪ ⣪ ⡚ ⣚ ⡺ ⣺
⠆ ⢆ ⠦ ⢦ ⠖ ⢖ ⠶ ⢶ ⠎ ⢎ ⠮ ⢮ ⠞ ⢞ ⠾ ⢾
⡆ ⣆ ⡦ ⣦ ⡖ ⣖ ⡶ ⣶ ⡎ ⣎ ⡮ ⣮ ⡞ ⣞ ⡾ ⣾
⠁ ⢁ ⠡ ⢡ ⠑ ⢑ ⠱ ⢱ ⠉ ⢉ ⠩ ⢩ ⠙ ⢙ ⠹ ⢹
⡁ ⣁ ⡡ ⣡ ⡑ ⣑ ⡱ ⣱ ⡉ ⣉ ⡩ ⣩ ⡙ ⣙ ⡹ ⣹
⠅ ⢅ ⠥ ⢥ ⠕ ⢕ ⠵ ⢵ ⠍ ⢍ ⠭ ⢭ ⠝ ⢝ ⠽ ⢽
⡅ ⣅ ⡥ ⣥ ⡕ ⣕ ⡵ ⣵ ⡍ ⣍ ⡭ ⣭ ⡝ ⣝ ⡽ ⣽
⠃ ⢃ ⠣ ⢣ ⠓ ⢓ ⠳ ⢳ ⠋ ⢋ ⠫ ⢫ ⠛ ⢛ ⠻ ⢻
⡃ ⣃ ⡣ ⣣ ⡓ ⣓ ⡳ ⣳ ⡋ ⣋ ⡫ ⣫ ⡛ ⣛ ⡻ ⣻
⠇ ⢇ ⠧ ⢧ ⠗ ⢗ ⠷ ⢷ ⠏ ⢏ ⠯ ⢯ ⠟ ⢟ ⠿ ⢿
⡇ ⣇ ⡧ ⣧ ⡗ ⣗ ⡷ ⣷ ⡏ ⣏ ⡯ ⣯ ⡟ ⣟ ⡿ ⣿]]):gsub('\n',' ')function GenerateDotData()function ToBinary(Kb)local Lb={}while Kb>0 do local Nb=math.fmod(Kb,2)Lb[#Lb+1]=string.sub(Nb,1,1)Kb=(Kb-Nb)/2 end;local Mb=string.reverse(table.concat(Lb))return string.rep('0',8 -#Mb)..Mb end;local function Eb(Kb)return Kb end;local Fb=Split(Q,' ')local Gb={}local Hb=false;local Ib=''local Jb=' 'for i=1,#Fb do Gb[ToBinary(i-1)]=Eb(Fb[i])if Hb then print(ToBinary(i-1)..Fb[i])local Kb=io.read()if Kb==''then Kb=Fb[i]elseif Kb=='stop'then break end;Ib=Ib..Kb..Jb end end;if Hb then print(Ib)io.open('Data.lua','a+'):write(Ib)end;return Gb end;Pixel.Data={}Pixel.Data.Dot=GenerateDotData()Pixel.ColorData={reset=0,clear=0,space=0,bright=1,bold=1,dim=2,faint=1,italic=3,underline=4,blink=5,reverse=7,invisible=8,hidden=8,strikethrough=9,black=30,red=31,green=32,yellow=33,blue=34,purple=35,magenta=35,cyan=36,white=37,onblack=40,onred=41,ongreen=42,onyellow=43,onblue=44,onpurple=45,onmagenta=45,oncyan=46,onwhite=47}Pixel.Color={}for Eb,Fb in pairs(Pixel.ColorData)do Pixel.Color[Eb]='\27['..Fb..'m'end;local R,S=C,D;local T,U=-B,B;T,U=-20,20;Pixel.Convert={}Pixel.Convert.ToDots=function(Eb)local Fb,Gb=Eb.Data,Eb.Color;local Hb={}local Ib=string.rep('0',8)local Jb=Pixel.Data.Dot[Ib]local Kb=nil;local Lb=nil;local Mb=Pixel.Color['reset']if Eb.Color.All then local Nb=Pixel.Color[Eb.Color.All]table.insert(Hb,Nb)Lb=Nb end;if not T then return''end;for y=T,U,4 do for x=R,S,2 do local Nb=Fb[x]local Ob=Fb[x+1]local Pb=( (Nb)and( (Nb[y]or'0').. (Nb[y+1]or'0').. (Nb[y+2]or'0').. (Nb[y+3]or'0'))or'0000').. ( (Ob)and( (Ob[y]or'0').. (Ob[y+1]or'0').. (Ob[y+2]or'0').. (Ob[y+3]or'0'))or'0000')if Pb~=Ib then Pb=Pixel.Data.Dot[Pb]if not Lb then local Qb=Gb[x]local Rb=Gb[x+1]local Sb=( (Qb)and(Qb[y]or Qb[y+1]or Qb[y+2]or Qb[y+3]))or( (Rb)and(Rb[y]or Rb[y+1]or Rb[y+2]or Rb[y+3]))if Sb then Sb=Pixel.Color[Sb]else Sb=Mb end;if Kb==Sb then else table.insert(Hb,Sb)Kb=Sb end end;table.insert(Hb,Pb)else table.insert(Hb,Jb)end end;table.insert(Hb,'\n')end;table.insert(Hb,Mb)return table.concat(Hb)end;Pixel.CircleGen=function(Eb,Fb,Gb,Hb,Ib)Ib=Ib or{}local Jb=Ib.color;local Kb=Hb*Hb;local Lb=Hb;for y=0,Hb do Lb=Lb+1;repeat Lb=Lb-1 until Lb*Lb+y*y<=Kb;for x2=0,Lb do Eb.Data[Fb+x2]=Eb.Data[Fb+x2]or{}Eb.Data[Fb-x2]=Eb.Data[Fb-x2]or{}Eb.Data[Fb+x2][Gb+y]='1'Eb.Data[Fb-x2][Gb+y]='1'Eb.Data[Fb+x2][Gb-y]='1'Eb.Data[Fb-x2][Gb-y]='1'Eb.Color[Fb+x2]=Eb.Color[Fb+x2]or{}Eb.Color[Fb-x2]=Eb.Color[Fb-x2]or{}Eb.Color[Fb+x2][Gb+y]=Jb;Eb.Color[Fb-x2][Gb+y]=Jb;Eb.Color[Fb+x2][Gb-y]=Jb;Eb.Color[Fb-x2][Gb-y]=Jb end end;return Eb end;local V={}Pixel.Circle=function(Eb,Fb,Gb,Hb,Ib)local Jb=nil;if V[Hb]then else V[Hb]=Pixel.CircleGen(Pixel.New(),0,0,Hb)end;local Kb=Ib and Ib.color;Jb=V[Hb]for Lb,Mb in pairs(Jb.Data)do for Nb,Ob in pairs(Mb)do local Pb,Qb=Lb+Fb,Nb+Gb;Eb.Data[Pb]=Eb.Data[Pb]or{}Eb.Data[Pb][Qb]=Ob;Eb.Color[Pb]=Eb.Color[Pb]or{}Eb.Color[Pb][Qb]=Kb end end;return Eb end;Pixel.New=function()return{Data={},Color={}}end;local function W(Eb,Fb)local Gb=math.floor(Fb.p)local Hb,Ib=A-B,A+B;for y=Hb,Ib do local Jb=Eb.Data[Gb]and Eb.Data[Gb][y]if Jb=='0'or Jb==nil then Eb.Data[Gb]=Eb.Data[Gb]or{}Eb.Data[Gb][y]='1'end end end;local function X(Eb,Fb,Gb)Gb=Gb or Fb.p;Pixel.Circle(Eb,math.floor(Gb),A,z*Fb.radius,G[Fb.type])end;local function Y(Eb,Fb,Gb,Hb,Ib,Jb)local Kb=Jb or{}color=Kb.color;local Lb=(C-w)if Fb<Lb then Fb=Lb end;local Mb=(D+w)if Gb>Mb then Gb=Mb end;for y=Hb,Ib do for x=Fb,Gb do Eb.Data[x]=Eb.Data[x]or{}Eb.Data[x][y]='1'if color then Eb.Color[x]=Eb.Color[x]or{}Eb.Color[x][y]=color end end end end;local function Z(Eb,Fb)local Gb=Fb.type;if Gb==1 or Gb==2 or Gb==3 or Gb==4 then X(Eb,Fb)elseif Gb==5 or Gb==6 then X(Eb,Fb)local Hb=Fb.endnote;local Ib=(Hb.ms-Fb.ms)*Fb.speed;X(Eb,Fb)local Jb=z*Fb.radius;local Kb,Lb=math.floor(Fb.p),math.floor(Fb.p+Ib)local Mb=math.floor(A-Jb)local Nb=math.floor(A+Jb)Y(Eb,Kb,Lb,Mb,Nb,G[Fb.type])elseif Gb==8 then X(Eb,Fb.startnote,Fb.p)end end;local function ab(Eb,Fb,Gb)local Hb=J/ (I/2)local Ib=-Hb*math.abs(( (Gb-Fb.startms)/ (H/I))- (J/Hb))+J;local Jb=O[Fb.status]local Kb=Jb.Offset;local Lb=Jb.Color.All;local Mb,Nb=0,-math.floor(z*1.6)-8 -math.floor(Ib)for Ob,Pb in pairs(Jb.Data)do for Qb,Rb in pairs(Pb)do if Rb=='1'then local Sb,Tb=Ob+Kb[1]+Mb,Qb+Kb[2]+Nb;Eb.Data[Sb]=Eb.Data[Sb]or{}Eb.Data[Sb][Tb]=Rb;Eb.Color[Sb]=Eb.Color[Sb]or{}Eb.Color[Sb][Tb]=Lb end end end end;local function bb(Eb,Fb)local Gb=P[Fb.status]local Hb=Gb.Offset;local Ib=Gb.Color.All;local Jb,Kb=0,0;for Lb,Mb in pairs(Gb.Data)do for Nb,Ob in pairs(Mb)do if Ob=='1'then local Pb,Qb=Lb+Hb[1]+Jb,Nb+Hb[2]+Kb;Eb.Data[Pb]=Eb.Data[Pb]or{}Eb.Data[Pb][Qb]=Ob;Eb.Color[Pb]=Eb.Color[Pb]or{}Eb.Color[Pb][Qb]=Ib end end end end;local cb={ClearScreen=function()io.write("\27[2J")end,SetCursor=function(Eb,Fb)io.write(string.format("\27[%d;%dH",Fb,Eb))end}local db=Taiko.GetAllNotes(j.Data)local eb=j.Metadata.OFFSET;local fb=1000 /60;local gb=j.Metadata.TIMING(fb)local function hb(Eb)return(Eb.data=='note')or(Eb.data=='event'and Eb.event=='barline')end;local function ib(Eb,Fb)return Fb- (( (D+w)/math.abs(Eb.speed)))end;local function jb(Eb,Fb)return(Eb.ms-Fb)*Eb.speed+E end;local function kb(Eb,Fb)return Eb.loadp- (Eb.speed* (Fb-Eb.loadms))end;local lb={}for Eb,Fb in pairs(db)do Fb.ms=Fb.ms-eb;Fb.s=MsToS(Fb.ms)Fb.speed=Taiko.CalculateSpeed(Fb,z)Fb.loadms=ib(Fb,Fb.ms)Fb.loads=MsToS(Fb.loadms)Fb.loadp=jb(Fb,Fb.loadms)table.insert(lb,Fb.ms)end;for Eb,Fb in pairs(j.Data)do if Fb.branch then for Gb,Hb in pairs(Fb.branch.paths)do table.sort(Hb,function(Ib,Jb)return Ib.loadms<Jb.loadms end)end end end;table.sort(j.Data,function(Eb,Fb)if Eb.branch and Fb.branch then for Gb,Hb in pairs(Eb.branch.paths)do for Ib,Jb in pairs(Fb.branch.paths)do return Hb[1].loadms<Jb[1].loadms end end elseif Eb.branch then for Gb,Hb in pairs(Eb.branch.paths)do return Hb[1].loadms<Fb.loadms end elseif Fb.branch then for Gb,Hb in pairs(Fb.branch.paths)do return Eb.loadms<Hb[1].loadms end else return Eb.loadms<Fb.loadms end end)Taiko.ConnectAll(j.Data)Taiko.ForAll(j.Data,function(Eb,Fb,Gb)Eb.n=Gb end)local mb=math.max(unpack(lb))+x;local nb={s=1,e=0,n=0}local ob=j.Data[1]local pb=ob.loads;nb.e=nb.n;local qb=10;local rb=string.rep(' ',qb)local sb={}local function tb(Eb,Fb)table.insert(sb,Eb)table.insert(sb,': ')table.insert(sb,tostring(Fb))table.insert(sb,rb)table.insert(sb,'\n')end;local function ub()print(table.concat(sb))sb={}end;local vb=''local function wb(Eb)vb=vb..'\n'..Eb end;local function xb()print(vb)end;cb.ClearScreen()local yb='M'local zb={startms=nil,status=nil}local Ab={-1,nil}local Bb=0;local Cb=0;if n then local Eb=1 /n;local Fb=nil end;local Db=os.clock()if n then nextframes=Db+frames end;if not m.on then while true do local Eb=Pixel.New()local Fb=os.clock()local Gb=Fb-Db;local Hb=Gb*1000;if ob then if ob.loadms<Hb then nb.n=nb.n+1;nb.e=ob.n;nb[ob.n]=ob;ob=ob.nextnote;if ob and ob.branch then ob=ob.branch.paths[yb][1]end end else if Hb>mb then break end end;Pixel.Circle(Eb,math.floor(E),A,z,{color='purple'})local Ib={}local Jb={}for i=nb.s,nb.e do local Ob=nb[i]if Ob then if Ob.data=='note'then if(Ob.type==1 or Ob.type==3)and(not Ib[1]or math.abs(Hb-Ob.ms)<Ib[1])then Ib[1]=math.abs(Hb-Ob.ms)Jb[1]=Ob elseif(Ob.type==2 or Ob.type==4)and(not Ib[2]or math.abs(Hb-Ob.ms)<Ib[2])then Ib[2]=math.abs(Hb-Ob.ms)Jb[2]=Ob end end;Ob.p=kb(Ob,Hb)if math.abs(Ob.p-E)> (D+w+1)then if Ob.endnote and Ob.endnote.done~=true then else Ob.done=true;nb[i]=nil;if ob and nb.n==0 then nb.s=ob.n elseif Ob.n==nb.s then if Ob.n==nb.e then nb.n=0 else local Pb=nb.s;repeat Pb=Pb+1;nb.n=nb.n-1 until nb[Pb]nb.s=Pb end end end else if Ob.data=='event'then if Ob.event=='barline'then W(Eb,Ob)end elseif Ob.data=='note'then Z(Eb,Ob)else error('Invalid note.data')end end end end;if zb.status then if Hb>zb.startms+H then zb={}else ab(Eb,zb,Hb)end end;cb.SetCursor(1,1)if n then local Ob=Pixel.Convert.ToDots(Eb)repeat until os.clock()>=nextframes;nextframes=nextframes+frames;print(Ob)else print(Pixel.Convert.ToDots(Eb))end;Bb=Bb+1;local Kb=os.clock()-Fb;Cb=Cb+Kb;local Lb=M.getch(N)local Mb=M.getkeyname(Lb)local Nb=q.Hit[Mb]if o then local Ob=Ib[1]local Pb=Ib[2]local Qb=(Ib[1]and Ib[2])and( (Ib[1]<Ib[2])and 1 or 2)or(Ib[1]and 1 or 2)local Rb=Ib[Qb]local Sb=Jb[Qb]if Rb and Hb>Sb.ms and(not Sb.hit)then if p then Nb=Qb else Sb.hit=true;local Tb=Sb.type;local Ub=( (Tb==3 or Tb==4)and 3)or 2;zb={startms=Hb,status=Ub}end end end;if Nb and Ib[Nb]and(not Jb[Nb].hit)then local Ob=Ib[Nb]local Pb;local Qb=Jb[Nb].type;local Rb=( (Qb==3 or Qb==4)and Taiko.Data.BigLeniency)or 1;if Ob< (gb.good)then local Sb=Jb[Nb].type;Pb=( (Sb==3 or Sb==4)and 3)or 2 elseif Ob< (gb.ok*Rb)then Pb=1 elseif Ob< (gb.bad*Rb)then Pb=0 else Pb=nil end;if Pb then Jb[Nb].hit=true;zb={startms=Hb,status=Pb}end end;if q.Escape[Mb]then local Ob=os.clock()cb.ClearScreen()M.nodelay(N,false)local Pb={'Back','Retry','Back to Select'}while true do cb.SetCursor(1,1)local Qb={}for i=1,#Pb do Qb[i]=( (i==r)and(u..string.rep(' ',s-#u))or string.rep(' ',s))..Pb[i]end;print(table.concat(Qb,v))local Rb=M.getch(N)local Sb=M.getkeyname(Rb)if q.L[Sb]then r=r==1 and 1 or r-1 elseif q.R[Sb]then r=r==3 and 3 or r+1 elseif q.Select[Sb]then if r==1 then elseif r==2 then return'Retry'elseif r==3 then return nil end;break elseif q.Escape[Sb]then break end end;M.nodelay(N,true)Db=Db+ (os.clock()-Ob)end;if Lb~=-1 then Ab={Lb,Mb}end;tb('Input (ascii)',Ab[1])tb('Input (key)',Ab[2])tb('S',Gb)tb('Ms',Hb)tb('Loaded',nb.n)tb('Frames Rendered',Bb)tb('Last Frame Render (s)',Kb)tb('Last Frame Render (ms)',Kb*1000)tb('Frame Render Total (s)',Cb)tb('Frame Render Total (ms)',Cb*1000)tb('Frame Render Total (%)',Cb/Gb*100)tb('FPS (Frame)',Bb/Gb)tb('Memory Usage (mb)',collectgarbage('count')/1000)tb('Finished (%)',Hb/ (mb)*100)tb('Nearest1 (ms)',Ib[1])tb('Nearest2 (ms)',Ib[2])tb('Song Name',j.Metadata.TITLE)tb('Difficulty (id)',j.Metadata.COURSE)tb('Stars',j.Metadata.LEVEL)ub()xb()end else error('Prerendering has been removed')end;return true end;function Taiko.SongSelect(j,k)local l={}local m,n=10,10;local o,p,q,r=-m,m,-n,n;local s=true;local u=1;local v=1;local w=4;local x=5;local y=5;local z=2;local A='V'local B='>'local C=10;local D=nil;local E='>'local F='>'local G=2;local H=true;local I={[2]={'Normal','Auto'},[3]={'None','2x Speed','3x Speed','4x Speed'}}local J={4,1,1}local K={nil}for eb,fb in pairs(I)do K[eb]={1,#fb,fb}end;local L=require('./CompactTJA/compactv4')local M=require('taikocurses')local N={window=M.initscr()}M.keypad(N,true)M.echo(false)M.raw(true)M.nl(false)M.cbreak(true)M.nodelay(N,true)M.getch(N)M.nodelay(N,false)local O,P=M.cols(),M.lines()D=D or O-2;local Q={Escape={['\27']=true,ALT_ESC=true},Scroll={L={KEY_LEFT=true,KEY_SLEFT=true,CTL_LEFT=true,KEY_B1=true,ALT_LEFT=true,KEY_SHIFT_L=true,KEY_UP=true,KEY_A2=true},R={KEY_RIGHT=true,KEY_SRIGHT=true,CTL_RIGHT=true,KEY_B3=true,ALT_RIGHT=true,KEY_SHIFT_R=true,KEY_DOWN=true,KEY_C2=true}},Select={Init={KEY_ENTER=true,PADENTER=true,CTL_PADENTER=true,ALT_PADENTER=true,CTL_PADCENTER=true,ALT_ENTER=true,CTL_ENTER=true,SHF_PADENTER=true,['\n']=true,['\r']=true},Select={KEY_ENTER=true,PADENTER=true,CTL_PADENTER=true,ALT_PADENTER=true,CTL_PADCENTER=true,ALT_ENTER=true,CTL_ENTER=true,SHF_PADENTER=true,['\n']=true,['\r']=true},Escape={['\27']=true,ALT_ESC=true},L={KEY_LEFT=true,KEY_SLEFT=true,CTL_LEFT=true,KEY_B1=true,ALT_LEFT=true,KEY_SHIFT_L=true},R={KEY_RIGHT=true,KEY_SRIGHT=true,CTL_RIGHT=true,KEY_B3=true,ALT_RIGHT=true,KEY_SHIFT_R=true},U={KEY_UP=true,KEY_A2=true},D={KEY_DOWN=true,KEY_C2=true},Play={Hit={['4']=2,['v']=1,['n']=1,['8']=2},Escape={['\27']=true,ALT_ESC=true},L={KEY_LEFT=true,KEY_SLEFT=true,CTL_LEFT=true,KEY_B1=true,ALT_LEFT=true,KEY_SHIFT_L=true,KEY_UP=true,KEY_DOWN=true},R={KEY_RIGHT=true,KEY_SRIGHT=true,CTL_RIGHT=true,KEY_B3=true,ALT_RIGHT=true,KEY_SHIFT_R=true,KEY_DOWN=true,KEY_C2=true},Select={KEY_ENTER=true,PADENTER=true,CTL_PADENTER=true,ALT_PADENTER=true,CTL_PADCENTER=true,ALT_ENTER=true,CTL_ENTER=true,SHF_PADENTER=true,['\n']=true,['\r']=true}}},Search={Init={ALT_F=true,f=true,F=true},Backspace={['\8']=true,KEY_BACKSPACE=true,ALT_BKSP,CTL_BKSP},FirstResult={KEY_ENTER=true,PADENTER=true,CTL_PADENTER=true,ALT_PADENTER=true,CTL_PADCENTER=true,ALT_ENTER=true,CTL_ENTER=true,SHF_PADENTER=true,['\n']=true,['\r']=true},Select={KEY_RIGHT=true,KEY_SRIGHT=true,CTL_RIGHT=true,KEY_B3=true,ALT_RIGHT=true,KEY_SHIFT_R=true},Up={KEY_A2=true,KEY_UP=true},Down={KEY_C2=true,KEY_DOWN=true},Escape={['\27']=true,ALT_ESC=true}}}local R={ClearScreen=function()io.write("\27[2J")end,SetCursor=function(eb,fb)io.write(string.format("\27[%d;%dH",fb,eb))end}local function S(eb)return eb..string.rep(' ',D-#eb)end;local function T()local eb=M.getch(N)local fb=M.getkeyname(eb)return eb,fb end;local function U(eb)return eb>=32 and eb<=126 end;local function V(eb,fb,gb,hb)return(eb and(fb..string.sub(gb,#fb+1,-1))or gb)..hb end;local function W(eb,fb,gb)return eb>gb and fb or eb<fb and gb or eb end;local X={[0]='No',[1]='Yes'}local function Y(eb)return eb and X[1]or X[0]end;local function Z(eb)return eb*100 ..'%'end;local function ab(eb)return MsToS(eb)..'s'end;local function bb(eb)return ab(SToMs(eb))end;local function cb(eb)return tonumber(eb)and tonumber(eb)or 0 end;local db={}R.ClearScreen()while true do l={}if s then l[o]={}for i=u-x,u+x do local ib=nil;if i<1 then ib=#j+i elseif i>#j then ib=i-#j else ib=i end;local jb=j[ib]if jb then l[0]=l[0]or{}l[0][(i-u)*y]=jb end end;local gb={}local hb=string.rep(' ',z)for y=q,r do gb[#gb+1]=V(y==0,B,hb,'')gb[#gb+1]=S(l[0][y]or'')gb[#gb+1]='\n'end;R.SetCursor(1,1)print(table.concat(gb))else l[0]={}l[0][q]=A;for i=u-x,u+x do local hb=nil;if i<1 then hb=#j+i elseif i>#j then hb=i-#j else hb=i end;local ib=j[hb]if ib then local jb=(i-u)*y;l[jb]=l[jb]or{}local kb=q+z;for i2=1,#ib do l[jb][kb]=string.sub(ib,i2,i2)kb=kb+1 end end end;local gb={}for y=q,r do for x=o,p do if l[x]and l[x][y]then local hb=l[x][y]if U(string.byte(hb))then gb[#gb+1]=hb else gb[#gb+1]=' 'end else gb[#gb+1]=' 'end end;gb[#gb+1]='\n'end;R.SetCursor(1,1)print(table.concat(gb))end;local eb,fb=T()if Q.Scroll.L[fb]then u=u-1 elseif Q.Scroll.R[fb]then u=u+1 elseif Q.Select.Init[fb]then local gb;if H then if db[u]then gb=db[u]else gb=Taiko.ParseTJA(k[u])db[u]=gb end else gb=Taiko.ParseTJA(k[u])end;local hb,ib;local jb;if v==1 then jb={}for nb,ob in pairs(gb)do jb[#jb+1]={nb,ob.Metadata.COURSE}end;table.sort(jb,function(nb,ob)return nb[2]<ob[2]end)hb=1;ib=#jb;K[v]={hb,ib,jb}else local nb=K[v]hb,ib,jb=nb[1],nb[2],nb[3]end;w=ClipN(w,hb,ib)local kb=string.rep(' ',G)R.ClearScreen()R.SetCursor(1,1)local lb=nil;local mb=v;while true do R.SetCursor(1,1)local nb=jb[J[1]][2]lb=Taiko.GetDifficulty(gb,nb)local ob=lb.Metadata;local pb=Taiko.Analyze(lb)local qb={{'',ob.TITLE},{'\t',ob.SUBTITLE},{'',''},{'','Select Options:'},{V(v==1,F,kb,'Difficulty: '),Taiko.Data.CourseName[ob.COURSE]},{V(v==2,F,kb,'Mode: '),I[2][J[2]]},{V(v==3,F,kb,'Modifiers: '),I[3][J[3]]},{'',''},{'Difficulty: ',Taiko.Data.CourseName[ob.COURSE]},{'Stars: ',ob.LEVEL},{'Diverge Notes: ',Y(ob.DIVERGENOTES)},{'',''},{'','Statistics:'},{'Don (DON) / Ka (KA): ',cb(pb.notes[1])..' + ('..cb(pb.notes[3])..') / '..cb(pb.notes[2])..' + ('..cb(pb.notes[4])..') = '..Z((cb(pb.notes[1])+cb(pb.notes[3]))/pb.notes.validn)..' / '..Z((cb(pb.notes[2])+cb(pb.notes[4]))/pb.notes.validn)},{'Max Score (without drumroll): ',pb.maxscore},{'Max Combo: ',pb.maxcombo},{'Drumroll Time (total): ',ab(pb.drumrollms+pb.drumrollbigms)},{'Balloon Time: ',ab(pb.balloonms)},{'Balloon Hits: ',pb.balloonhit},{'Special Time: ',ab(pb.specialms)},{'Special Hits: ',pb.specialhit},{'',''},{'','Press Enter to Play!'}}for i=1,#qb do local ub=qb[i]print(S(ub[1]..tostring(ub[2])))end;local rb,sb=T()if Q.Select.L[sb]then w=w-1 elseif Q.Select.R[sb]then w=w+1 elseif Q.Select.U[sb]then v=v-1 elseif Q.Select.D[sb]then v=v+1 elseif Q.Select.Select[sb]then while true do local ub,vb=Taiko.PlaySong(Taiko.GetDifficulty(gb,nb),Q.Select.Play,N)if ub and vb then break elseif ub=='Retry'then else break end end;M.nodelay(N,false)elseif Q.Select.Escape[sb]then break end;v=ClipN(v,1,3)if v~=mb then w=J[v]mb=v end;local tb=K[v]hb,ib=tb[1],tb[2]w=W(w,hb,ib)J[v]=w end elseif Q.Search.Init[fb]then local gb=''local hb={}local ib=1;local jb=nil;local kb=1;R.ClearScreen()R.SetCursor(1,1)print('Searching...')while true do R.SetCursor(#gb+1,2)local lb,mb=T()R.SetCursor(1,2)if Q.Search.Backspace[mb]then gb=string.sub(gb,1,-2)elseif Q.Search.FirstResult[mb]then jb=hb[1]break elseif Q.Search.Select[mb]then jb=hb[kb]break elseif Q.Search.Down[mb]then kb=kb+1 elseif Q.Search.Up[mb]then kb=kb-1 elseif Q.Search.Escape[mb]then break else gb=gb..mb end;print(S(gb))local nb=L.SearchHeaderAll(j,gb)for i=1,C do if nb[i][2]==-math.huge then ib=i-1;break elseif i==C then ib=i end end;kb=ClipN(kb,1,ib)local ob=false;for i=1,C do local pb=nb[i]if ob then print(S(''))else if pb then if pb[2]==-math.huge then ob=true;print(S(''))else print(S((i==kb and E or i)..'. '..nb[i][3]))hb[i]=pb end end end end end;u=(jb and jb[1]or u)or u elseif Q.Escape[fb]then return end;u=W(u,1,#j)end end;local f='./CompactTJA/taikobuipm.tjac'f='./CompactTJA/ESE/06 Classical.tjac'f='./CompactTJA/ESE/ESE.tjac'local g=require('./CompactTJA/compactv4')local h,i=g.Decompress(g.Read(f))Taiko.SongSelect(i,h)error()Taiko.PlaySong(Taiko.GetDifficulty(Taiko.ParseTJA(g.InputFile(f)),'Ura'))
Split=function(c,d)local e={}for f,g in c:gmatch("([^"..d.."]*)("..d.."?)")do table.insert(e,f)if g==''then return e end end end;Trim=function(b)local c=b:gsub("^%s*(.-)%s*$","%1")return c end;TrimLeft=function(b)local c=b:gsub("^%s*(.-)$","%1")return c end;TrimRight=function(b)local c=b:gsub("^(.-)%s*$","%1")return c end;StartsWith=function(c,d)return c:sub(1,#d)==d end;EndsWith=function(c,d)return c:sub(-#d,-1)==d end;Table={}function Table.Clone(b,c)c=c or{}local d=type(b)local e;if d=='table'then if c[b]then e=c[b]else e={}c[b]=e;for f,g in next,b,nil do e[Table.Clone(f,c)]=Table.Clone(g,c)end;setmetatable(e,Table.Clone(getmetatable(b),c))end else e=b end;return e end;ClipN=function(c,d,e)if c<d then return d elseif c>e then return e else return c end end;function Error(b)error(b)end;function ParseError(b,c,d)Error(b..': '..c.. (d and(', '..d)or''))end;function MsToS(b)return b/1000 end;function SToMs(b)return b*1000 end;Taiko={}Taiko.Data={Languages={'','EN','JA','CN','TW','KO'},GenreName={Pop={'pop','j-pop'},Anime={'anime','アニメ'},Kids={'kids','どうよう'},Variety={'variety','バラエティ'},VOCALOID={'vocaloid','ボーカロイド'},Classic={'classic','クラシック'},['Game Music']={'game music','ゲームミュージック'},['Namco Original']={'namco original','ナムコオリジナル'}},CourseId={easy=0,normal=1,hard=2,oni=3,edit=4,tower=5,dan=6,ura=4},CourseName={[0]='Easy','Normal','Hard','Oni','Edit','Tower','Dan','Ura'},RatingMultiplier={[0]=0,[1]=0.5,[2]=1,[3]=2},ScoreMode={[0]=function(b,c,d,e,f)return b+ ( ( (c<200)and(d or 1000)or( (d or 1000)+ (e or 1000)))*Taiko.Data.RatingMultiplier[f])end,[1]=function(b,c,d,e,f)return b+ (d+math.max(0,e*math.floor((math.min(c,100)-1)/10)))*Taiko.Data.RatingMultiplier[f]end,[2]=function(b,c,d,e,f)return b+ (d+e* ( (c>=100)and 8 or(c>=50)and 4 or(c>=30)and 2 or(c>=10)and 1 or 0))*Taiko.Data.RatingMultiplier[f]end},Autoscore={[0]=function(b)end,[1]=function(b)end,[2]=function(b)end},SideId={normal=1,ex=2,both=3},SideName={'normal','ex','both'},StyleId={single=1,double=2,couple=2},StyleName={'single','double'},Exam={Condition={g=true,jp=true,jg=true,jb=true,s=true,r=true,h=true,c=true},Scope={m=true,l=true}}}for b,c in pairs(Taiko.Data.ScoreMode)do Taiko.Data.ScoreMode[b]=function(...)return math.floor(c(...)/10)*10 end end;function Taiko.ParseTJA(b)local c=os.clock()local d={}local e={Metadata={BPM=120,WAVE='main.mp3',OFFSET=0,DEMOSTART=0,SCOREMODE=1,SONGVOL=100,SEVOL=100,SIDE=3,LIFE=0,GAME='Taiko',HEADSCROLL=1,MOVIEOFFSET=0,COURSE='ONI',LEVEL=0,BALLOON=nil,SCOREINIT,SCOREDIFF,BALLOONNOR=nil,BALLOONEXP=nil,BALLOONMAS=nil,STYLE=1,EXAM1=nil,EXAM2=nil,EXAM3=nil,GAUGEINCR='NORMAL',TOTAL=nil,HIDDENBRANCH=0},Data={}}local f={settings={noteparse={notealias={A=3,B=4},noteexceptions={[',']=true,[' ']=true,['\t']=true}}},bpm=0,ms=0,songstarted=false,timingpoint=nil,sign=4 /4,mpm=0,mspermeasure=0,scroll=1,measuredone=true,currentmeasure={},barline=true,gogo=false}local function g(p)local q=Taiko.Data.Languages;for i=1,#q do local r=e.Metadata[p..q[i]]if r then return r end end;return nil end;local function h(p,q,r)local s=tonumber(q)if s then return s else ParseError(p,r,q)end end;local function i(p,q,r,s)if q then return q else ParseError(p,r,s)end end;local function j(p,q,r)local s={['true']=true,['false']=false,yes=true,no=false,['1']=true,['0']=false,[1]=true,[0]=false}local t=s[q]~=nil;if t then return t else ParseError(p,r,q)end end;local function k(p,q)local r=','local s='\\'local u={}local v=''local w=false;for i=1,#q do local x=string.sub(q,i,i)if w then v=v..x;w=false else if x==r then table.insert(u,v)v=''elseif x==s then w=true else v=v..x end end end;table.insert(u,v)return u end;local function l(p,q,r)local s=k(p,q)for i=1,#s do s[i]=h(p,s[i],r,q)end;return a end;local function m(p,q,r)if q and q~=''then return l(p,q,r)else return{}end end;local function n(p,q,r)if q and q~=''then local u=k(p,q,r)i(p,Taiko.Data.Exam.Condition[u[1]],r)u[2]=h(p,u[2],r)u[3]=h(p,u[3],r)i(p,Taiko.Data.Exam.Scope[u[4]],r)return u else return{}end end;function f.createnote()return{ms=nil,data=nil,type=nil,txt=nil,gogo=f.gogo,scroll=(f.scroll*e.Metadata.HEADSCROLL),mspermeasure=f.mspermeasure,bpm=f.bpm,nextnote=nil}end;local o=Split(b,'\n')for i=1,#o do local p=TrimLeft(o[i])if StartsWith(p,'//')or p==''then else local q=false;if f.songstarted==false and q==false then local r={string.match(p,'(%u+):(.*)')}if r[1]then e.Metadata[Trim(r[1])]=Trim(r[2])q=true end end;if(f.songstarted or StartsWith(p,'#START'))and q==false then local r={string.match(p,'#(%u-)%s(.*)')}if not r[1]then r={string.match(p,'#(%u+)')}end;if r[1]then if r[1]=='START'then if f.songstarted then ParseError(r[1],'Song has already started')else e.OriginalMetadata=Table.Clone(e.Metadata)e.Metadata.TITLE=i(r[1],g('TITLE'),'Title is missing')e.Metadata.SUBTITLE=i(r[1],g('SUBTITLE'),'Subtitle is missing')e.Metadata.BPM=h(r[1],e.Metadata.BPM,'Invalid bpm')e.Metadata.OFFSET=SToMs(h(r[1],e.Metadata.OFFSET,'Invalid offset'))e.Metadata.DEMOSTART=SToMs(h(r[1],e.Metadata.DEMOSTART,'Invalid demostart'))if e.Metadata.DEMOSTART==0 then e.Metadata.DEMOSTART=nil end;for w,x in pairs(Taiko.Data.GenreName)do for i=1,#x do if x[i]==e.Metadata.GENRE then e.Metadata.GENRE=w end end end;e.Metadata.SCOREMODE=h(r[1],e.Metadata.SCOREMODE,'Invalid scoremode')i(r[1],Taiko.Data.ScoreMode[e.Metadata.SCOREMODE],'Invalid scoremode',e.Metadata.SCOREMODE)if e.Metadata.MAKER then e.Metadata.CREATORURLT={}e.Metadata.CREATOR=Trim(string.gsub(e.Metadata.MAKER,'(<.->)',function(v)table.insert(e.Metadata.CREATORURLT,string.sub(v,2,-2))return''end))e.Metadata.CREATORURL=table.concat(e.Metadata.CREATORURLT,', ')e.Metadata.CREATIVE=false else e.Metadata.CREATIVE=false end;e.Metadata.SONGVOL=h(r[1],e.Metadata.SONGVOL,'Invalid songvol')/100;e.Metadata.SEVOL=h(r[1],e.Metadata.SEVOL,'Invalid sevol')/100;local s=tonumber(e.Metadata.SIDE)if s then i(r[1],Taiko.Data.SideName[s],'Invalid side id',e.Metadata.SIDE)e.Metadata.SIDE=s else e.Metadata.SIDE=i(r[1],Taiko.Data.SideId[string.lower(e.Metadata.SIDE)],'Invalid side name',e.Metadata.SIDE)end;e.Metadata.LIFE=h(r[1],e.Metadata.LIFE,'Invalid life')if e.Metadata.LIFE==0 then e.Metadata.LIFE=nil end;e.Metadata.GAME=string.lower(e.Metadata.GAME)if e.Metadata.GAME=='taiko'then elseif e.Metadata.GAME=='jube'then else end;e.Metadata.HEADSCROLL=h(r[1],e.Metadata.HEADSCROLL,'Invalid headscroll')e.Metadata.MOVIEOFFSET=h(r[1],e.Metadata.MOVIEOFFSET,'Invalid movieoffset')local t=tonumber(e.Metadata.COURSE)if t then i(r[1],Taiko.Data.CourseName[t],'Invalid course id',e.Metadata.COURSE)e.Metadata.COURSE=t else e.Metadata.COURSE=i(r[1],Taiko.Data.CourseId[string.lower(e.Metadata.COURSE)],'Invalid course name',e.Metadata.COURSE)end;e.Metadata.LEVEL=ClipN(math.floor(h(r[1],e.Metadata.LEVEL,'Invalid level')),0,10)e.Metadata.BALLOON=m(r[1],e.Metadata.BALLOON,'Invalid balloon')e.Metadata.SCOREINIT=h(r[1],e.Metadata.SCOREINIT,'Invalid scoreinit')e.Metadata.SCOREDIFF=h(r[1],e.Metadata.SCOREDIFF,'Invalid scoreinit')e.Metadata.BALLOONNOR=m(r[1],e.Metadata.BALLOONNOR,'Invalid balloonnor')e.Metadata.BALLOONEXP=m(r[1],e.Metadata.BALLOONEXP,'Invalid balloonexp')e.Metadata.BALLOONMAS=m(r[1],e.Metadata.BALLOONMAS,'Invalid balloonmas')local u=tonumber(e.Metadata.STYLE)if u then i(r[1],Taiko.Data.StyleName[u],'Invalid course id',Taiko.Data.STYLE)e.Metadata.STYLE=u else e.Metadata.STYLE=i(r[1],Taiko.Data.CourseId[string.lower(e.Metadata.STYLE)],'Invalid course name',e.Metadata.STYLE)end;e.Metadata.EXAM1=n(e.Metadata.EXAM1)e.Metadata.EXAM2=n(e.Metadata.EXAM2)e.Metadata.EXAM3=n(e.Metadata.EXAM3)e.Metadata.GAUGEINCR=string.lower(e.Metadata.GAUGEINCR)if e.Metadata.TOTAL then e.Metadata.TOTAL=h(r[1],e.Metadata.TOTAL,'Invalid total')end;e.Metadata.HIDDENBRANCH=j(r[1],e.Metadata.HIDDENBRANCH,'Invalid hiddenbranch')f.bpm=e.Metadata.BPM;f.songstarted=true end elseif r[1]=='END'then if f.songstarted then table.insert(d,e)e={Metadata=Table.Clone(e.OriginalMetadata),Data={}}f.songstarted=false else ParseError(r[1],'Song has already ended')end elseif r[1]=='MEASURE'then local s,t=string.match(r[2],'(%d+)/(%d+)')s=h(r[1],s,'Invalid measure')t=h(r[1],t,'Invalid measure')f.sign=(s/t)or f.sign elseif r[1]=='BPMCHANGE'then f.bpm=h(r[1],r[2],'Invalid bpmchange')or f.bpm elseif r[1]=='DELAY'then table.insert(f.currentmeasure,{r[1],SToMs((h(r[1],r[2],'Invalid delay')or 0))})elseif r[1]=='SCROLL'then f.scroll=h(r[1],r[2],'Invalid scroll')or f.scroll;if f.scroll==0 then ParseError(r[1],'Scroll cannot be 0')end elseif r[1]=='GOGOSTART'then f.gogo=true elseif r[1]=='GOGOEND'then f.gogo=false elseif r[1]=='BARLINEOFF'then f.barline=false elseif r[1]=='BARLINEON'then f.barline=true elseif r[1]=='BRANCHSTART'then elseif r[1]=='N'then elseif r[1]=='E'then elseif r[1]=='M'then elseif r[1]=='BRANCHEND'then elseif r[1]=='SECTION'then elseif r[1]=='LYRIC'then elseif r[1]=='LEVELHOLD'then elseif r[1]=='BMSCROLL'then elseif r[1]=='HBSCROLL'then elseif r[1]=='SENOTECHANGE'then elseif r[1]=='NEXTSONG'then elseif r[1]=='DIRECTION'then elseif r[1]=='SUDDEN'then elseif r[1]=='JPOSSCROLL'then else end;q=true end end;if(f.songstarted)and q==false then f.mpm=f.bpm*f.sign/4;f.mspermeasure=60000 *f.sign*4 /f.bpm;if f.barline and#f.currentmeasure==0 then local s=f.createnote()s.ms=f.ms;s.data='event's.event='barline'end;local r={}for i=1,#p do local t=string.sub(p,i,i)if f.settings.noteparse.noteexceptions[t]then else local u=h('parser.noteparse',tonumber(t)or f.settings.noteparse.notealias[t],'Invalid note',t)if u then local v=f.createnote()v.data='note'v.type=u;table.insert(f.currentmeasure,v)end end end;if EndsWith(p,',')then if#f.currentmeasure==0 then f.ms=f.ms+f.mspermeasure else local s=0;local t=nil;for i=1,#f.currentmeasure do local v=f.currentmeasure[i]if v.data=='note'then t=t or v.mspermeasure;s=s+1 end end;local u=t/s;for i=1,#f.currentmeasure do local v=f.currentmeasure[i]if v[1]=='DELAY'then f.ms=f.ms+v[2]else if v.type~=0 then v.ms=f.ms;local w=e.Data[#e.Data]if w then w.nextnote=v end;table.insert(e.Data,v)u=v.mspermeasure/s end end;f.ms=f.ms+u end end;f.measuredone=true;f.currentmeasure={}else f.measuredone=false end end end end;print('Parsing Took: '..SToMs(os.clock()-c)..'ms')return d end;function Taiko.GetDifficulty(b,c)local d=Taiko.Data.CourseId[string.lower(c)]or c;for e,f in pairs(b)do if f.Metadata.COURSE==d then return f end end;Error('No difficulty found, '..c)return nil end;function Taiko.FindMaxCombo()end;function Taiko.FindMaxScore()end;function Taiko.GetNextNote(b,c)while true do if c>#b.Data then return nil end;local d=b.Data[c]if d.data=='note'then return c end;c=c+1 end end;function Taiko.CalculateSpeed(b,c)local d=9600 *c*b.scroll/ (b.bpm*b.mspermeasure)return d end;function Taiko.CalculateSpeedAll(b,c)local d={}for i=1,#b.Data do b.Data[i].speed=Taiko.CalculateSpeed(b.Data[i],c)table.insert(d,b.Data[i].speed)end;return b end;function Taiko.RenderScale(b)local c={}local d={}local e={}for i=1,#b.Data do local j=b.Data[i]if j.data=='note'then local k=math.floor(j.ms)if math.floor(k)-k==0 then table.insert(c,{k,j.type})table.insert(d,k)else table.insert(e,i)end end end;function gcd2(i,j)if j==0 then return i else return gcd2(j,i%j)end end;function gcdn(i)local j=i[1]for i=2,#i do j=gcd2(j,i[i])end;return j end;local f=gcdn(d)for i=1,#e do local j=c[e[i]]j[1]=math.floor(j[1]/f)*f end;local g=''local h=0;for i=1,#c do c[i][1]=c[i][1]/f;g=g..string.rep(' ',c[i][1]-h)..c[i][2]h=c[i][1]end;return g end;function Taiko.PlaySong(b,c)local d=require('Pixels')b=Taiko.GetDifficulty(b,c)require'ppp'(Taiko.CalculateSpeedAll(b,1).Data[1])local e=100;local f=100;local g=40;local h=3;local i={}for o,p in pairs(b.Data)do table.insert(i,p.ms)p.ms=MsToS(p.ms)end;f=MsToS(math.max(unpack(i))+f)local function j(o)while true do if o==#b.Data then return b.Data[o],math.huge,0 end;local p=b.Data[o]if p.data=='note'then return p,p.ms,o end;o=o+1 end end;local k,l,m=j(1)local n=os.clock()while true do local o=os.clock()-n;if o>l then print(l,o)print(k.speed)k,l,m=j(m+1)end;if o>f then break end end end;file='./tja/donkama.tja'Taiko.PlaySong(Taiko.ParseTJA(io.open(file,'r'):read('*all')),'Oni')
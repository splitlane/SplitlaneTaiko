#!.\raylua_s.exe 
require'strict'local function l(u)local v=""local w=0;if u<0x80 then return string.char(u)end;local x=0x20;while u>x do local A=bit.bor(bit.band(u,0x3F),0x80)v=string.char(A)..v;u=bit.rshift(u,6)w=w+1;x=bit.rshift(x,1)end;local y=bit.lshift(bit.rshift(0xFF,7 -w),7 -w)local z=bit.bor(y,u)return string.char(z)..v end;local function m(u,v,...)if v~=nil then u={u,v,...}end;local w={}for x,y in ipairs(u)do if y<0x80 then w[#w+1]=string.char(y)elseif y<0x800 then w[#w+1]=string.char(bit.bor(bit.rshift(y,6),0xc0))w[#w+1]=string.char(bit.bor(bit.band(y,0x3F),0x80))elseif y<0x10000 then w[#w+1]=string.char(bit.bor(bit.rshift(y,12),0xe0))w[#w+1]=string.char(bit.bor(bit.band(bit.rshift(y,6),0x3F),0x80))w[#w+1]=string.char(bit.bor(bit.band(y,0x3F),0x80))elseif y<0x200000 then w[#w+1]=string.char(bit.bor(bit.rshift(y,18),0xf0))w[#w+1]=string.char(bit.bor(bit.band(bit.rshift(y,12),0x3F),0x80))w[#w+1]=string.char(bit.bor(bit.band(bit.rshift(y,6),0x3F),0x80))w[#w+1]=string.char(bit.bor(bit.band(y,0x3F),0x80))else w[#w+1]=l(y)end end;return table.concat(w)end;local function n(u)local v,w,x={},0,nil;for i=1,#u do local y=string.byte(u,i)if w==0 then table.insert(v,x)w=y<0x80 and 1 or y<0xE0 and 2 or y<0xF0 and 3 or y<0xF8 and 4 or y<0xFC and 5 or y<0xFE and 6 or error("invalid UTF-8 character sequence")x=bit.band(y,2 ^ (8 -w)-1)else x=bit.bor(bit.lshift(x,6),bit.band(y,0x3F))end;w=w-1 end;table.insert(v,x)return v end;local function o(u)return string.char(bit.band(bit.rshift(u,8),0xFF),bit.band(u,0xFF))end;local function p(u)return string.char(bit.band(u,0xFF),bit.band(bit.rshift(u,8),0xFF))end;local function q(u,v)if v<0x10000 then return u(v)else v=v-0x10000;return u(0xD800 +bit.rshift(v,10))..u(0xDC00 +bit.band(v,0x3FF))end end;local function r(u)local v={'\255\254'}for i=1,#u do v[#v+1]=q(p,u[i])end;return table.concat(v)end;do local u=require'ffi'u.cdef[[
    typedef struct {
    char *fpos;
    void *base;
    unsigned short handle;
    short flags;
    short unget;
    unsigned long alloc;
    unsigned short buffincrement;
    } FILE;

    FILE *fopen(const char *filename, const char *mode);
    int fclose(FILE *stream);


    void *malloc(int64_t);
    void free(void *);

    int fseek(FILE *stream, long int offset, int whence);
    long int ftell(FILE *stream);

    size_t fread(void *ptr, size_t size, size_t nmemb, FILE *stream);
    size_t fwrite(const void *ptr, size_t size, size_t nmemb, FILE *stream);

    ]]local v=u.os=='Windows'local w;if v then u.cdef[[
        FILE *_wfopen(const wchar_t *filename, const wchar_t *mode);
        ]]w=function(z)local A=#z+1;local B=u.new('wchar_t[?]',A)for i=1,#z do B[i-1]=z[i]end;B[#z]=0;return B end end;local x={}local y=io.open;function x.open(z,A)local B=n(z)local C=false;for i=1,#B do if B[i]>255 then C=true;break end end;if C==false then return y(z,A)end;local D;if v then local E=w(B)local F=w(n(A))D=u.C._wfopen(E,F)else D=u.C.fopen(z,A)end;if D==nil then return nil end;return setmetatable({file=D},{__index=x})end;function x.read(z,A)if string.sub(A,1,2)~='*a'then error('File.read: Does not support mode')end;local B=z.file;u.C.fseek(B,0,2)local C=u.C.ftell(B)u.C.fseek(B,0,0)if C~=-1 then local D=u.cast('char *',u.C.malloc(C+1))u.C.fread(D,C,1,B)D[C]=0;local E=u.string(D,C)u.C.free(D)return E else error('File error')end end;function x.write(z,A)local B=z.file;u.C.fwrite(A,#A,1,B)end;function x.close(z)local A=z.file;u.C.fclose(A)end;io.open=x.open end;do local u='\\'local v='\\'local w=-0.005;local x=-0.005;local y=-0.01;local z=1.0;local A=0.9;local B=0.8;local C=0.7;local D=0.6;local E=math.huge;local F=-math.huge;local G=1024;local H={}function H.has_match(ib,jb,kb)if not kb then ib=string.lower(ib)jb=string.lower(jb)end;local lb=1;for i=1,string.len(ib)do lb=string.find(jb,ib:sub(i,i),lb,true)if not lb then return false else lb=lb+1 end end;return true end;local function I(ib)return ib:match("%l")end;local function J(ib)return ib:match("%u")end;local function K(ib)local jb={}local kb="/"for i=1,string.len(ib)do local lb=ib:sub(i,i)if kb=="/"or kb=="\\"then jb[i]=A elseif kb=="-"or kb=="_"or kb==" "then jb[i]=B elseif kb=="."then jb[i]=D elseif I(kb)and J(lb)then jb[i]=C else jb[i]=0 end;kb=lb end;return jb end;local function L(ib,jb,kb,lb,mb)local nb=K(jb)local ob=string.len(ib)local pb=string.len(jb)if not mb then ib=string.lower(ib)jb=string.lower(jb)end;local qb={}for i=1,pb do qb[i]=jb:sub(i,i)end;for i=1,ob do kb[i]={}lb[i]={}local rb=F;local sb=i==ob and x or y;local tb=ib:sub(i,i)for j=1,pb do if tb==qb[j]then local ub=F;if i==1 then ub=( (j-1)*w)+nb[j]elseif j>1 then local vb=lb[i-1][j-1]+nb[j]local wb=kb[i-1][j-1]+z;ub=math.max(vb,wb)end;kb[i][j]=ub;rb=math.max(ub,rb+sb)lb[i][j]=rb else kb[i][j]=F;rb=rb+sb;lb[i][j]=rb end end end end;function H.score(ib,jb,kb)local lb=string.len(ib)local mb=string.len(jb)if lb==0 or mb==0 or mb>G or lb>mb then return F elseif ib==jb then return E else local nb={}local ob={}L(ib,jb,nb,ob,kb)return ob[lb][mb]end end;function H.positions(ib,jb,kb)local lb=string.len(ib)local mb=string.len(jb)if lb==0 or mb==0 or mb>G or lb>mb then return{},F elseif lb==mb then local sb={}for i=1,lb do sb[i]=i end;return sb,E end;local nb={}local ob={}L(ib,jb,nb,ob,kb)local pb={}local qb=false;local rb=mb;for i=lb,1,-1 do while rb>=1 do if nb[i][rb]~=F and(qb or nb[i][rb]==ob[i][rb])then qb=(i~=1)and(rb~=1)and(ob[i][rb]==nb[i-1][rb-1]+z)pb[i]=rb;rb=rb-1;break else rb=rb-1 end end end;return pb,ob[lb][mb]end;function H.filter(ib,jb,kb)local lb={}for mb,nb in ipairs(jb)do if H.has_match(ib,nb,kb)then local ob,pb=H.positions(ib,nb,kb)table.insert(lb,{mb,ob,pb})end end;return lb end;function H.get_score_min()return F end;function H.get_score_max()return E end;function H.get_max_length()return G end;function H.get_score_floor()return G*y end;function H.get_score_ceiling()return G*z end;function H.get_implementation_name()return"lua"end;local M=function(ib,jb)return H.score(jb,ib)end;local function N(ib,jb)return string.gsub(string.gsub(ib,u,u..u),jb,u..jb)end;local function O(ib,jb)return string.gsub(string.gsub(ib,u..jb,jb),u..u,u)end;local function P(ib,jb,kb)local lb={}local mb=''for nb,ob in string.gmatch(ib,'([^'..jb..']*)('..jb..'?)')do local pb,qb=string.sub(nb,-2,-2),string.sub(nb,-1,-1)local rb=true;if pb==kb then if qb==kb then else end else if qb==kb then mb=mb..string.sub(nb,1,-2)..ob;rb=false else end end;if rb then mb=mb..nb;lb[#lb+1]=mb;mb=''end;if ob==''then return lb end end;return error(unpack(lb))end;local Q=string.char;local R=type;local S=select;local T=string.sub;local U=table.concat;local V={}local W={}for i=0,255 do local ib,jb=Q(i),Q(i,0)V[ib]=jb;W[jb]=ib end;local function X(ib,jb,kb,lb)if kb>=256 then kb,lb=0,lb+1;if lb>=256 then jb={}lb=1 end end;jb[ib]=Q(kb,lb)kb=kb+1;return jb,kb,lb end;local function Y(ib)if R(ib)~="string"then return nil,"string expected, got "..R(ib)end;local jb=#ib;if jb<=1 then return"u"..ib end;local kb={}local lb,mb=0,1;local nb={"c"}local ob=1;local pb=2;local qb=""for i=1,jb do local rb=T(ib,i,i)local sb=qb..rb;if not(V[sb]or kb[sb])then local tb=V[qb]or kb[qb]if not tb then return nil,"algorithm error, could not fetch word"end;nb[pb]=tb;ob=ob+#tb;pb=pb+1;if jb<=ob then return"u"..ib end;kb,lb,mb=X(sb,kb,lb,mb)qb=rb else qb=sb end end;nb[pb]=V[qb]or kb[qb]ob=ob+#nb[pb]pb=pb+1;if jb<=ob then return"u"..ib end;return U(nb)end;local function Z(ib,jb,kb,lb)if kb>=256 then kb,lb=0,lb+1;if lb>=256 then jb={}lb=1 end end;jb[Q(kb,lb)]=ib;kb=kb+1;return jb,kb,lb end;local function ab(ib)if R(ib)~="string"then return nil,"string expected, got "..R(ib)end;if#ib<1 then return nil,"invalid input - not a compressed string"end;local jb=T(ib,1,1)if jb=="u"then return T(ib,2)elseif jb~="c"then return nil,"invalid input - not a compressed string"end;ib=T(ib,2)local kb=#ib;if kb<2 then return nil,"invalid input - not a compressed string"end;local lb={}local mb,nb=0,1;local ob={}local pb=1;local qb=T(ib,1,2)ob[pb]=W[qb]or lb[qb]pb=pb+1;for i=3,kb,2 do local rb=T(ib,i,i+1)local sb=W[qb]or lb[qb]if not sb then return nil,"could not find last from dict. Invalid input?"end;local tb=W[rb]or lb[rb]if tb then ob[pb]=tb;pb=pb+1;lb,mb,nb=Z(sb..T(tb,1,1),lb,mb,nb)else local ub=sb..T(sb,1,1)ob[pb]=ub;pb=pb+1;lb,mb,nb=Z(ub,lb,mb,nb)end;qb=rb end;return U(ob)end;local function bb(ib)if string.sub(ib,1,3)=='\239\187\191'then return string.sub(ib,4,-1)else return ib end end;local cb='\n'local db=','local function eb(ib)local jb={}for i=1,#ib do print(string.match(ib[i],'\nTITLE:(.-)\n'))local kb=string.match(ib[i],'TITLE:(.-)\n')or string.match(ib[i],'TITLE:(.-)\r')if not kb then print'input title'kb=io.read()end;jb[#jb+1]=N(kb,db)end;return table.concat(jb,db)..cb end;local function fb(ib)local jb=string.find(ib,cb)local kb=P(string.sub(ib,1,jb-1),db,u)for i=1,#kb do kb[i]=O(kb[i],db)end;return kb,string.sub(ib,jb+1,-1)end;local function gb(ib,jb)local kb={}for i=1,#ib do kb[i]={i,M(ib[i],jb),ib[i]}end;table.sort(kb,function(lb,mb)return lb[2]>mb[2]end)return kb end;local function hb(ib,jb)local kb=gb(ib,jb)return kb[1][1]end;Compact={}function Compact.Read(ib)local jb=io.open(ib,'rb')local kb=jb:read('*all')jb:close()return kb end;function Compact.Write(ib,jb)local kb=io.open(ib,'wb+')kb:write(jb)kb:close()end;function Compact.Compress(ib)for i=1,#ib do ib[i]=N(bb(ib[i]),v)end;local jb=table.concat(ib,v)local kb=Y(jb)kb=eb(ib)..kb;print('Before chars: '..#jb..'\nAfter Chars:'..#kb..'\nAfter/Before: '.. (#kb/#jb)..'\nCompression Rate: '.. (#jb/#kb)..'x')return kb end;function Compact.Decompress(ib)local jb,kb=fb(ib)local lb=ab(kb)local mb=P(lb,v,u)return mb,jb end;function Compact.ListFiles(ib)local jb={}for i=1,#ib do jb[#jb+1]=ib[i]end;table.sort(jb)return table.concat(jb,'\n')end;function Compact.Search(ib,jb,kb)local lb=hb(jb,kb)if lb then return ib[lb]else return nil end end;function Compact.Input(ib)local jb,kb=Compact.Decompress(ib)print(Compact.ListFiles(kb))print('Song Name:')local lb=io.read()local mb=Compact.Search(jb,kb,lb)if mb then return mb else error('Invalid input')end end;function Compact.InputFile(ib)return Compact.Input(Compact.Read(ib))end;function Compact.Merge(ib)local jb={}for i=1,#ib do local kb=Compact.Decompress(ib[i])for i=1,#kb do jb[#jb+1]=kb[i]end end;return Compact.Compress(jb)end;function Compact.CompressDir(ib,jb)local function kb(pb)local qb,rb,sb=0,{},io.popen;local tb=sb('dir "'..pb..'" /b')for ub in tb:lines()do qb=qb+1;rb[qb]=ub end;tb:close()return rb end;local lb=ib;local mb=kb(lb)local nb={}local ob={}for i=1,#mb do local pb=mb[i]local qb=kb(lb..'\\'..pb)if#qb~=0 and qb[1]~=pb then local rb=Compact.CompressDir(lb..'\\'..pb,true)for i=1,#rb do ob[#ob+1]=rb[i]end elseif(not nb[pb])and string.sub(pb,-3,-1)=='tja'then print(pb)ob[#ob+1]=lb..'\\'..pb else end end;if jb then return ob else for i=1,#ob do local pb=io.open(ob[i],'r')ob[i]=pb:read('*all')pb:close()end;return Compact.Compress(ob)end end;Compact.SearchHeader=hb;Compact.SearchHeaderAll=gb;Compact.Search=M end;do Replay={}Replay.Version='beta-2'Replay.Notes={['1']={1,false},['2']={2,false},['3']={1,true},['4']={2,true}}local u=string.char;local v=type;local w=select;local x=string.sub;local y=table.concat;local z={}local A={}for i=0,255 do local F,G=u(i),u(i,0)z[F]=G;A[G]=F end;local function B(F,G,H,I)if H>=256 then H,I=0,I+1;if I>=256 then G={}I=1 end end;G[F]=u(H,I)H=H+1;return G,H,I end;local function C(F)if v(F)~="string"then return nil,"string expected, got "..v(F)end;local G=#F;if G<=1 then return"u"..F end;local H={}local I,J=0,1;local K={"c"}local L=1;local M=2;local N=""for i=1,G do local O=x(F,i,i)local P=N..O;if not(z[P]or H[P])then local Q=z[N]or H[N]if not Q then return nil,"algorithm error, could not fetch word"end;K[M]=Q;L=L+#Q;M=M+1;if G<=L then return"u"..F end;H,I,J=B(P,H,I,J)N=O else N=P end end;K[M]=z[N]or H[N]L=L+#K[M]M=M+1;if G<=L then return"u"..F end;return y(K)end;local function D(F,G,H,I)if H>=256 then H,I=0,I+1;if I>=256 then G={}I=1 end end;G[u(H,I)]=F;H=H+1;return G,H,I end;local function E(F)if v(F)~="string"then return nil,"string expected, got "..v(F)end;if#F<1 then return nil,"invalid input - not a compressed string"end;local G=x(F,1,1)if G=="u"then return x(F,2)elseif G~="c"then return nil,"invalid input - not a compressed string"end;F=x(F,2)local H=#F;if H<2 then return nil,"invalid input - not a compressed string"end;local I={}local J,K=0,1;local L={}local M=1;local N=x(F,1,2)L[M]=A[N]or I[N]M=M+1;for i=3,H,2 do local O=x(F,i,i+1)local P=A[N]or I[N]if not P then return nil,"could not find last from dict. Invalid input?"end;local Q=A[O]or I[O]if Q then L[M]=Q;M=M+1;I,J,K=D(P..x(Q,1,1),I,J,K)else local R=P..x(P,1,1)L[M]=R;M=M+1;I,J,K=D(R,I,J,K)end;N=O end;return y(L)end;function Replay.Read(F)local G=io.open(F,'rb')local H=G:read('*all')G:close()return H end;function Replay.Write(F,G)local H=io.open(F,'wb+')H:write(G)H:close()end;function Replay.TranscodeRaw(F)local G={}for H,I in pairs(F)do local J=string.find(H,' ')G[tonumber(string.sub(H,1,J-1))]=tonumber(string.sub(H,J+1,-1))end;return G end;function Replay.TranscodeRawKey(F)local G={}for H,I in pairs(F)do for i=1,#I do local J=I[i]G[J]=G[J]and G[J]or{}G[J][#G[J]+1]=H end end;return G end;function Replay.Save(F,G)local H={}local I,J,K=0;for M,N in pairs(F)do J=(not J or M<J)and M or J;K=(not K or M>K)and M or K;I=I+1 end;H={'version ',Replay.Version,'\ntotalms ',tostring(K-J),'\nactivecount ',tostring(I)}G=G or{}for i=1,#G do H[#H+1]=G[i]end;H[#H+1]='\ndata 'local L={}for M,N in pairs(F)do L[#L+1]=tostring(M)L[#L+1]=' 'L[#L+1]=table.concat(N)L[#L+1]='\n'end;H[#H+1]=C(table.concat(L))return table.concat(H)end;function Replay.Load(F)local G,H=string.find(F,'data ')local I=string.sub(F,1,G-1)local J={}string.gsub(I,'(.-) (.-)\n',function(O,P)J[O]=P end)local K=string.sub(F,H+1,-1)local L=E(K)local M={}local N=1;while true do local O,P=string.find(L,'\n',N)if not O then break end;local Q=string.sub(L,N,O-1)N=P+1;local R=string.find(Q,' ')local S=string.sub(Q,1,R-1)local T=string.sub(Q,R+1,-1)local U={}for i2=1,#T do U[#U+1]=string.sub(T,i2,i2)end;M[tonumber(S)]=U end;return M,J end end;do local u=require('ffi')local v=u.load('tinyfiledialogs64')u.cdef[[
    char * tinyfd_openFileDialog(
        char const * aTitle, /* NULL or "" */
        char const * aDefaultPathAndFile, /* NULL or "" */
        int aNumOfFilterPatterns , /* 0 (2 in the following example) */
        char const * const * aFilterPatterns, /* NULL or char const * lFilterPatterns[2]={"*.png","*.jpg"}; */
        char const * aSingleFilterDescription, /* NULL or "image files" */
        int aAllowMultipleSelects ) ; /* 0 or 1 */
            /* in case of multiple files, the separator is | */
            /* returns NULL on cancel */

    char * tinyfd_selectFolderDialog(
        char const * aTitle, /* NULL or "" */
        char const * aDefaultPath); /* NULL or "" */
            /* returns NULL on cancel */

    char const * tinyfd_saveFileDialog(
        char const * aTitle , // NULL or ""
        char const * aDefaultPathAndFile , // NULL or ""
        int aNumOfFilterPatterns , // 0 (1 in the following example)
        char const * const * aFilterPatterns , // NULL or char const * lFilterPatterns[1]={"*.txt"};
        char const * aSingleFilterDescription ); // NULL or "text files"
            // returns NULL on cancel
    ]]FileDialog={}function FileDialog.Open(w,x,y,z,A)w=w or''x=x or''local B=y and#y or 0;local C=nil;if y then C=u.new('const char * [?]',B)for i=1,#y do C[i-1]=u.new('char [?]',#y[i]+1,y[i])end end;local D=A and 1 or 0;local E=v.tinyfd_openFileDialog(w,x,B,C,z,D)if E==nil then return nil else return u.string(E)end end;function FileDialog.OpenFolder(w,x)w=w or''x=x or''local y=v.tinyfd_selectFolderDialog(w,x)if y==nil then return nil else return u.string(y)end end;function FileDialog.Save(w,x,y,z)w=w or''x=x or''local A=y and#y or 0;local B=nil;if y then B=u.new('const char * [?]',A)for i=1,#y do B[i-1]=u.new('char [?]',#y[i]+1,y[i])end end;local C=v.tinyfd_saveFileDialog(w,x,A,B,z)if C==nil then return nil else return u.string(C)end end;function FileDialog.LoadFile(...)local w=FileDialog.Open(...)if w then local x=io.open(w,'rb')local y=x:read('*all')x:close()return y else return nil end end;function FileDialog.SaveFile(...)local w=FileDialog.Save(...)if w then local x=io.open(w,'wb+')x:write()x:close()return true else return nil end end end;do Persistent={}function Persistent.Read(v)local w=io.open(v,'rb')local x=w:read('*all')w:close()return x end;function Persistent.Write(v,w)local x=io.open(v,'wb+')x:write(w)x:close()end;local u=function(v,w)local x={}for z in pairs(v)do x[#x+1]=z end;if w then table.sort(x,function(z,A)return w(v,z,A)end)else table.sort(x)end;local y=0;return function()y=y+1;if x[y]then return x[y],v[x[y]]end end end;function Persistent.Save(v,w,x)local y=w;w=w or{'Automatically generated by Persistent.\nThis file will be read and overwritten.\nDO NOT EDIT\n'}x=x and x+1 or 1;w[#w+1]='{\n'for z,A in u(v,function(z,A,B)return tostring(A)<tostring(B)end)do w[#w+1]=string.rep('\t',x)if type(z)=='string'then w[#w+1]='\''w[#w+1]=z;w[#w+1]='\''elseif type(z)=='number'or type(z)=='boolean'or type(z)=='nil'then w[#w+1]=tostring(z)else error('Invalid key type, '..type(z))end;w[#w+1]=' = 'if type(A)=='table'then Persistent.Save(A,w,x)elseif type(A)=='string'then w[#w+1]='\''w[#w+1]=A;w[#w+1]='\''elseif type(A)=='number'or type(A)=='boolean'or type(A)=='nil'then w[#w+1]=tostring(A)else error('Invalid value type, '..type(A))end;w[#w+1]=',\n'end;w[#w+1]=string.rep('\t',x-1)w[#w+1]='}'if not y then return table.concat(w)end end;function Persistent.Load(v)v=Persistent.StripComments(v)local w={}local x=0;local y=0;local z=true;local A=0;local B=true;local C=false;local D={}local E={}local F={}local G=w;local H=string.find(v,'{')-1;repeat H=H+1;if B and string.sub(v,H,H+2)==' = 'then B=false;C=true;E={}H=H+3 end;local I=string.sub(v,H,H)if I=='{'then x=x+1;if x>=2 then B=true;C=false;local J=table.concat(D)J=string.sub(J,1,1)=='\''and string.sub(J,2,-2)or tonumber(J)and tonumber(J)or J=='true'and true or J=='false'and false;F[#F+1]=J;D={}local K=w;for i=1,#F-1 do K=K[F[i]]end;K[F[#F]]={}G=K[F[#F]]end elseif I=='}'then x=x-1;if#F>=1 then F[#F]=nil;local J=w;for i=1,#F do J=J[F[i]]end;G=J end elseif I=='\''and A%2 ==0 then y=z and y+1 or y-1;z=not z elseif I=='\\'then A=A+1 end;if B and I~='{'and I~='}'and I~=','and I~='\t'and I~='\n'and I~='\r'and I~=' 'then D[#D+1]=I end;if C then if y==0 and I==','then local J=table.concat(D)J=string.sub(J,1,1)=='\''and string.sub(J,2,-2)or tonumber(J)and tonumber(J)or J=='true'and true or J=='false'and false;local K=table.concat(E)K=string.sub(K,1,1)=='\''and string.sub(K,2,-2)or tonumber(K)and tonumber(K)or K=='true'and true or K=='false'and false;G[J]=K;B=true;C=false;D={}else E[#E+1]=I end end;if I~='\\'then A=0 end until H>=#v;return w end;function Persistent.StripComments(v)return string.gsub(v,'//.-\n','')end end;do TextureMap={}function TextureMap.SplitUsingMap(u,v,w,x,y)x=x or{1,1}y=y or{0,0}local function z(A)local B={}for C,D in pairs(A)do local E=false;for F,G in pairs(D)do if type(G)=='table'then E=true end end;if E then B[C]=z(D)else B[C]=rl.ImageFromImage(u,rl.new('Rectangle',D[1]*x[1]+y[1],D[2]*x[2]+y[2],(D[3]or w[1])-1 +y[1],(D[4]or w[2])-1 +y[2]))end end;return B end;return z(v)end;function TextureMap.LoadTextureFromImage(u)local v=rl.LoadTextureFromImage(u)rl.UnloadImage(u)return v end;function TextureMap.ReplaceWithTexture(u)local function v(w)local x={}for y,z in pairs(w)do if type(z)=='table'then x[y]=v(z)else x[y]=TextureMap.LoadTextureFromImage(z)end end;return x end;return v(u)end;function TextureMap.SplitAndReplaceWithTexture(...)return TextureMap.ReplaceWithTexture(TextureMap.SplitUsingMap(...))end end;do IniParser={}function IniParser.Read(v)local w=io.open(v,'rb')local x=w:read('*all')w:close()return x end;function IniParser.Write(v,w)local x=io.open(v,'wb+')x:write(w)x:close()end;local u=function(v,w)local x={}for z in pairs(v)do x[#x+1]=z end;if w then table.sort(x,function(z,A)return w(v,z,A)end)else table.sort(x)end;local y=0;return function()y=y+1;if x[y]then return x[y],v[x[y]]end end end;function IniParser.Save(v)local w={}local x={}for y,z in u(v,function(y,z,A)return tostring(z)<tostring(A)end)do if type(z)=='table'then x[#x+1]='['x[#x+1]=tostring(y)x[#x+1]=']\n'for A,B in u(z,function(A,B,C)return tostring(B)<tostring(C)end)do x[#x+1]=tostring(A)x[#x+1]=' = 'x[#x+1]=tostring(B)x[#x+1]='\n'end;x[#x+1]='\n'else w[#w+1]=tostring(y)w[#w+1]=' = 'w[#w+1]=tostring(z)w[#w+1]='\n'end end;return table.concat(w).. (#x~=0 and('\n\n'..table.concat(x))or'')end;function IniParser.Load(v,w,x)v=v..'\n'local y=w or{}local z=x or{}local A=nil;local B=1;while true do local C=string.find(v,'\n',B)local D=string.find(v,'\r\n',B)if D and D<C then C=D end;if not C then break end;local E=string.sub(v,B,C-1)if string.sub(E,1,1)~=';'then if string.sub(E,1,8)=='#include'then z[#z+1]=string.sub(E,10,-1)else local F=string.find(E,'%[')if F then local H=string.find(E,'%]')if H then A=string.sub(E,F+1,H-1)y[A]=y[A]or{}end end;local G=string.find(E,'=')if G then local H=G-1;while true do local K=string.sub(E,H,H)if string.find(K,'%s')then H=H-1 else break end end;local I=G+1;while true do local K=string.sub(E,I,I)if string.find(K,'%s')then I=I+1 else break end end;local J=y;if A then J=y[A]else J=y end;J[string.sub(E,1,H)]=string.sub(E,I,-1)end end end;B=C+ (D and 2 or 1)end;return y,z end;function IniParser.LoadFile(v)local w=string.find(string.reverse(v),'[/\\]')local x=w and string.sub(v,1,#v+1 -w)or''local y={}local z={w and string.sub(v,#v+2 -w)or v}while true do local A=x..z[#z]z[#z]=nil;local B=io.open(A,'rb')if B then local C=B:read('*all')y,z=IniParser.Load(C,y,z)if#z==0 then break end else return nil,'Unable to open file.'end end;return y end;function IniParser.ParseCSV(v)local w=','local x='\\'local y={}local z=''local A=false;for i=1,#v do local B=string.sub(v,i,i)if A then z=z..B;A=false else if B==w then table.insert(y,z)z=''elseif B==x then A=true else z=z..B end end end;table.insert(y,z)return y end;function IniParser.ParseCSVN(v)local w=IniParser.ParseCSV(v)for i=1,#w do local x=tonumber(w[i])if x then w[i]=x else error('IniParser: csvn value not a number')end end;return w end end;do Romaji={}Romaji.Data={To={['a']={'あ','ア'},['i']={'い','イ'},['u']={'う','ウ'},['e']={'え','エ'},['o']={'お','オ'},['ka']={'か','カ'},['ki']={'き','キ'},['ku']={'く','ク'},['ke']={'け','ケ'},['ko']={'こ','コ'},['kya']={'きゃ','キャ'},['kyu']={'きゅ','キュ'},['kyo']={'きょ','キョ'},['sa']={'さ','サ'},['shi']={'し','シ'},['su']={'す','ス'},['se']={'せ','セ'},['so']={'そ','ソ'},['sha']={'しゃ','シャ'},['shu']={'しゅ','シュ'},['sho']={'しょ','ショ'},['ta']={'た','タ'},['chi']={'ち','チ'},['tsu']={'つ','ツ'},['te']={'て','テ'},['to']={'と','ト'},['cha']={'ちゃ','チャ'},['chu']={'ちゅ','チュ'},['cho']={'ちょ','チョ'},['na']={'な','ナ'},['ni']={'に','ニ'},['nu']={'ぬ','ヌ'},['ne']={'ね','ネ'},['no']={'の','ノ'},['nya']={'にゃ','ニャ'},['nyu']={'にゅ','ニュ'},['nyo']={'にょ','ニョ'},['ha']={'は','ハ'},['hi']={'ひ','ヒ'},['fu']={'ふ','フ'},['he']={'へ','ヘ'},['ho']={'ほ','ホ'},['hya']={'ひゃ','ヒャ'},['hyu']={'ひゅ','ヒュ'},['hyo']={'ひょ','ヒョ'},['ma']={'ま','マ'},['mi']={'み','ミ'},['mu']={'む','ム'},['me']={'め','メ'},['mo']={'も','モ'},['mya']={'みゃ','ミャ'},['myu']={'みゅ','ミュ'},['myo']={'みょ','ミョ'},['ya']={'や','ヤ'},['yu']={'ゆ','ユ'},['yo']={'よ','ヨ'},['ra']={'ら','ラ'},['ri']={'り','リ'},['ru']={'る','ル'},['re']={'れ','レ'},['ro']={'ろ','ロ'},['rya']={'りゃ','リャ'},['ryu']={'りゅ','リュ'},['ryo']={'りょ','リョ'},['wa']={'わ','ワ'},['wo']={'を','ヲ'},['n']={'ん','ン'},['ga']={'が','ガ'},['gi']={'ぎ','ギ'},['gu']={'ぐ','グ'},['ge']={'げ','ゲ'},['go']={'ご','ゴ'},['gya']={'ぎゃ','ギャ'},['gyu']={'ぎゅ','ギュ'},['gyo']={'ぎょ','ギョ'},['za']={'ざ','ザ'},['ji']={'じ','ジ'},['zu']={'ず','ズ'},['ze']={'ぜ','ゼ'},['zo']={'ぞ','ゾ'},['ja']={'じゃ','ジャ'},['ju']={'じゅ','ジュ'},['jo']={'じょ','ジョ'},['da']={'だ','ダ'},['ji']={'ぢ','ヂ'},['zu']={'づ','ヅ'},['de']={'で','デ'},['do']={'ど','ド'},['ja']={'ぢゃ','ヂャ'},['ju']={'ぢゅ','ヂュ'},['jo']={'ぢょ','ヂョ'},['ba']={'ば','バ'},['bi']={'び','ビ'},['bu']={'ぶ','ブ'},['be']={'べ','ベ'},['bo']={'ぼ','ボ'},['bya']={'びゃ','ビャ'},['byu']={'びゅ','ビュ'},['byo']={'びょ','ビョ'},['pa']={'ぱ','パ'},['pi']={'ぴ','ピ'},['pu']={'ぷ','プ'},['pe']={'ぺ','ペ'},['po']={'ぽ','ポ'},['pya']={'ぴゃ','ピャ'},['pyu']={'ぴゅ','ピュ'},['pyo']={'ぴょ','ピョ'},['si']={'し','シ'},['kka']={'っか','ッカ'},['kki']={'っき','ッキ'},['kku']={'っく','ック'},['kke']={'っけ','ッケ'},['kko']={'っこ','ッコ'},['kkya']={'っきゃ','ッキャ'},['kkyu']={'っきゅ','ッキュ'},['kkyo']={'っきょ','ッキョ'},['ssa']={'っさ','ッサ'},['sshi']={'っし','ッシ'},['ssu']={'っす','ッス'},['sse']={'っせ','ッセ'},['sso']={'っそ','ッソ'},['ssha']={'っしゃ','ッシャ'},['sshu']={'っしゅ','ッシュ'},['ssho']={'っしょ','ッショ'},['tta']={'った','ッタ'},['cchi']={'っち','ッチ'},['ttsu']={'っつ','ッツ'},['tte']={'って','ッテ'},['tto']={'っと','ット'},['ccha']={'っちゃ','ッチャ'},['cchu']={'っちゅ','ッチュ'},['ccho']={'っちょ','ッチョ'},['hha']={'っは','ッハ'},['hhi']={'っひ','ッヒ'},['ffu']={'っふ','ッフ'},['hhe']={'っへ','ッヘ'},['hho']={'っほ','ッホ'},['hhya']={'っひゃ','ッヒャ'},['hhyu']={'っひゅ','ッヒュ'},['hhyo']={'っひょ','ッヒョ'},['mma']={'っま','ッマ'},['mmi']={'っみ','ッミ'},['mmu']={'っむ','ッム'},['mme']={'っめ','ッメ'},['mmo']={'っも','ッモ'},['mmya']={'っみゃ','ッミャ'},['mmyu']={'っみゅ','ッミュ'},['mmyo']={'っみょ','ッミョ'},['yya']={'っや','ッヤ'},['yyu']={'っゆ','ッユ'},['yyo']={'っよ','ッヨ'},['rra']={'っら','ッラ'},['rri']={'っり','ッリ'},['rru']={'っる','ッル'},['rre']={'っれ','ッレ'},['rro']={'っろ','ッロ'},['rrya']={'っりゃ','ッリャ'},['rryu']={'っりゅ','ッリュ'},['rryo']={'っりょ','ッリョ'},['wwa']={'っわ','ッワ'},['wwo']={'っを','ッヲ'},['gga']={'っが','ッガ'},['ggi']={'っぎ','ッギ'},['ggu']={'っぐ','ッグ'},['gge']={'っげ','ッゲ'},['ggo']={'っご','ッゴ'},['ggya']={'っぎゃ','ッギャ'},['ggyu']={'っぎゅ','ッギュ'},['ggyo']={'っぎょ','ッギョ'},['zza']={'っざ','ッザ'},['jji']={'っじ','ッジ'},['zzu']={'っず','ッズ'},['zze']={'っぜ','ッゼ'},['zzo']={'っぞ','ッゾ'},['jja']={'っじゃ','ッジャ'},['jju']={'っじゅ','ッジュ'},['jjo']={'っじょ','ッジョ'},['dda']={'っだ','ッダ'},['jji']={'っぢ','ッヂ'},['zzu']={'っづ','ッヅ'},['dde']={'っで','ッデ'},['ddo']={'っど','ッド'},['jja']={'っぢゃ','ッヂャ'},['jju']={'っぢゅ','ッヂュ'},['jjo']={'っぢょ','ッヂョ'},['bba']={'っば','ッバ'},['bbi']={'っび','ッビ'},['bbu']={'っぶ','ッブ'},['bbe']={'っべ','ッベ'},['bbo']={'っぼ','ッボ'},['bbya']={'っびゃ','ッビャ'},['bbyu']={'っびゅ','ッビュ'},['bbyo']={'っびょ','ッビョ'},['ppa']={'っぱ','ッパ'},['ppi']={'っぴ','ッピ'},['ppu']={'っぷ','ップ'},['ppe']={'っぺ','ッペ'},['ppo']={'っぽ','ッポ'},['ppya']={'っぴゃ','ッピャ'},['ppyu']={'っぴゅ','ッピュ'},['ppyo']={'っぴょ','ッピョ'}}}function Romaji.ToHiragana(u)local v=1;local w=string.lower(u)local x={}local y=1;while true do local z=false;if not z and y<#w-1 then local A=string.sub(w,y,y+2)if Romaji.Data.To[A]then x[#x+1]=Romaji.Data.To[A][v]y=y+3;z=true end end;if not z and y<#w then local A=string.sub(w,y,y+1)if Romaji.Data.To[A]then x[#x+1]=Romaji.Data.To[A][v]y=y+2;z=true end end;if not z then local A=string.sub(w,y,y)if Romaji.Data.To[A]then x[#x+1]=Romaji.Data.To[A][v]y=y+1;z=true end end;if not z then x[#x+1]=string.sub(w,y,y)y=y+1 end;if y>#w then break end end;return table.concat(x)end;function Romaji.ToRomaji(u)end end;do SaveState={}local function u(y,z)z=z or{}local A=type(y)local B;if A=='table'then if z[y]then B=z[y]else B={}z[y]=B;for C,D in next,y,nil do B[u(C,z)]=u(D,z)end;setmetatable(B,u(getmetatable(y),z))end else B=y end;return B end;local function v(y,z)local A=u(y,z)return false end;local w=1;function SaveState.Save(y)local z={locals={},globals={}}while true do y=(y or w)+1;if debug.getinfo(y)then else break end;local A={}local B=1;while true do local C,D=debug.getlocal(y,B)if C then A[#A+1]={C,u(D)}else break end;B=B+1 end;z.locals[y]=A end;for A,B in pairs(_G)do z.globals[u(A)]=u(B)end;return z end;function SaveState.Load(y)for z,A in pairs(y.locals)do local B=1;while true do local C,D=debug.getlocal(z,B)if C then for i2=1,#A do local E=A[i2]if E[1]==C then debug.setlocal(z,B,E[2])break end end else break end;B=B+1 end end;for z,A in pairs(y.globals)do _G[z]=A end end;local x={}function SaveState.SaveSlot(y)x[y]=SaveState.Save(w+1)return true,x[y]end;function SaveState.LoadSlot(y)if x[y]then SaveState.Load(u(x[y]))return true else return nil end end end;do Serialize={}local u=require('ffi')local function v(x)return(x:gsub('.',function(y)return string.format('%02X',string.byte(y))end))end;local w;do local x,y,z,A=pairs,type,tostring,select;local B,C=table.concat,table.remove;local D,E=string.format,string.match;local F={["and"]=true,["break"]=true,["do"]=true,["else"]=true,["elseif"]=true,["end"]=true,["false"]=true,["for"]=true,["function"]=true,["if"]=true,["in"]=true,["local"]=true,["nil"]=true,["not"]=true,["or"]=true,["repeat"]=true,["return"]=true,["then"]=true,["true"]=true,["until"]=true,["while"]=true}local G;do local R={[z(1 /0)]="1/0",[z(-1 /0)]="-1/0",[z(0 /0)]="0/0"}number_to_string=function(S)local T=z(S)return R[T]or T end;G=function(S)local T=("%.17g"):format(S)return R[T]or T end end;local H;local I=function(R)H[#H+1]=R end;local function J(R,S)S=S+1;local T=R[S]if T~=nil then return S,T end end;local function K(R,S)S=S+1;local T=rawget(R,S)if T~=nil then return S,T end end;local function L(R)if getmetatable(R)then return K,R,0 end;return J,R,0 end;local function M(R,S,T,U)local V=y(R)if V=="table"then if not(U[R]or T[R])then T[R]=true;for W,X in x(R)do M(W,S,T,U)M(X,S,T,U)end else if not U[R]and T[R]then S[#S+1]=R;U[R]={name="_["..#S.."]",num=#S}end end end end;local N;do local R;local function S(T,U,V)local W=y(T)local X=false;if W=="table"then if not U[T]or not R then R=true;for Y,Z in x(T)do if S(Y,U,V)or S(Z,U,V)then X=true;if y(Y)=="table"then V[Y]=true end;if y(Z)=="table"then V[Z]=true end end end else return true end end;return X end;N=function(T,U,V)R=false;V[T]=true;S(T,U,V)end end;local function O(R,S,T,U,V)local W=y(R)if W=="table"then if not V or not S[R]then local X=true;I("{")local Y=0;for ab,bb in L(R)do Y=ab;if not(T[ab]or T[bb])then if ab~=1 then I(",")end;O(bb,S,T,U,X)else Y=ab-1;break end end;Y=Y+1;local Z=(Y>1)and","or""for ab,bb in x(R)do local cb=y(ab)if not(T[ab]or T[bb])then if cb=="string"then I(Z)Z=","if not F[ab]and E(ab,"^[%a_][%a%d_]*$")then I(ab)I("=")else I(D("[%q]=",ab))end;O(bb,S,T,U,X)elseif cb~="number"or ab>=Y or ab<1 or ab%1 ~=0 then I(Z)Z=","I("[")O(ab,S,T,U,X)I("]")I("=")O(bb,S,T,U,X)end else U[#U+1]={ab,bb}end end;I("}")else I(S[R].name)end elseif W=="string"then I(D("%q",R))elseif W=="number"then I(G(R))elseif W=="boolean"then I(z(R))elseif W=="cdata"then I("nil")elseif R==nil then I("nil")else I("nil")return nil end;return true end;local function P(R,S)local T=y(R)if T=="table"then if not S[R]then I("{")local U=0;for W,X in L(R)do U=W;if W~=1 then I(",")end;P(X,S)end;U=U+1;local V=(U>1)and","or""for W,X in x(R)do local Y=y(W)if Y=="string"then I(V)V=","if not F[W]and E(W,"^[%a_][%a%d_]*$")then I(W)I("=")else I(D("[%q]=",W))end;P(X,S)elseif Y~="number"or W>=U or W<1 or W%1 ~=0 then I(V)V=","I("[")P(W,S)I("]")I("=")P(X,S)end end;I("}")else I(S[R].name)end elseif T=="string"then I(D("%q",R))elseif T=="number"then I(G(R))elseif T=="boolean"then I(z(R))elseif T=="cdata"then I("nil")elseif R==nil then I("nil")else I("nil")return nil end;return true end;local Q=function(R,S,T,U,V)H=T;I(" ")I(U)I("[")local W=T.afterwork;if not P(R,V)then return false end;I("]=")if not P(S,V)then return false end;I(" ")return true end;w=function(...)local R=A("#",...)local S={}local T={}local U={}for i=1,R do local ab=A(i,...)M(ab,T,S,U)end;S=nil;local V=#T;local W={}for i=1,V do local ab=T[i]N(ab,U,W)end;local X={}for i=1,V do local ab=T[i]X[i]={afterwork={}}local bb=X[i].afterwork;H=X[i]if not O(ab,U,W,bb)then return nil,"Unserializable data in parameter #"..i end end;W={}for i=1,V do local ab=T[i]X[i].afterstart=#X[i]for j=1,# (X[i].afterwork)do if not Q(X[i].afterwork[j][1],X[i].afterwork[j][2],X[i],U[ab].name,U)then return nil,"Unserializable data in parameter #"..i end end end;for i=1,R do local ab=A(i,...)X[i+V]={}H=X[i+V]if not P(ab,U)then return nil,"Unserializable data in parameter #"..i end end;local Y={}for ab,bb in x(U)do Y[#Y+1]="["..bb.num.."]="..B(X[bb.num],"",1,X[bb.num].afterstart)..";"end;for i=1,V do X[i]=B(X[i],"",X[i].afterstart+1)end;for i=V+1,V+R do X[i]=B(X[i])end;local Z="local ffi=require'ffi'_CDATA=function(t,h)return ffi.cast(t..'*',h:gsub('..',function(c)return string.char(tonumber(c,16))end))end "if V==0 then return Z.."return "..B(X,",")else local ab={"do local _={",B(Y," "),'}',B(X," ",1,V)," return ",B(X,",",V+1)," end"}return Z..B(ab)end end end;function Serialize.Save(x)return w(x)end;function Serialize.Load(x)local y,z=loadstring(x)if y then local A,B=pcall(y)if A then return B else error(B)end else error(z)end end end;do PersistentParsed={}local u=require('ffi')local function v(J)return(J:gsub('.',function(K)return string.format('%02X',string.byte(K))end))end;PersistentParsed.CompressKeyData={n='a',bpm='b',senotepr='c',oms='d',odelay='e',mspermeasure='f',scrollx='g',senote='h',type='i',setdelay='j',osenotepr='k',tcenter='l',line='m',p='n',scrolly='o',data='p',nextnote='q',loadms='r',rotationr='s',radiusr='t',tcentero='u',CalculatePosition='v',speed='w',delay='x',gogo='y',radius='z',ms='A',brokecombo='B',pop='C',pr='D',senotet='E',event='F',startnote='G',endnote='H',onnotepush='I',lengthms='J',endtype='K',drumrollbend='L',notetype='M',recttype='N'}PersistentParsed.DecompressKeyData={}for J,K in pairs(PersistentParsed.CompressKeyData)do PersistentParsed.DecompressKeyData[K]=J end;local w={number=1,boolean=1,string=1,['nil']=1}function serialize(J)local K=0;local L={}local M={}local N={}local O={}local P={}local function Q()K=K+1;return K end;local function R(ab,bb,cb)local db,eb=N[bb],N[cb]assert(not db or L[bb]or M[bb])assert(not eb or L[cb]or M[cb])local fb=(db and eb and"kv")or(db and"k")or("v")local gb=O[ab]local hb={bb,cb}if not gb then gb={}O[ab]=gb end;gb[bb],gb[cb]=db,eb;table.insert(P,{ab,bb,cb})L[ab],M[ab]=nil,true end;local function S(ab)if w[type(ab)]then return end;if L[ab]then L[ab],M[ab]=nil,true elseif M[ab]then else L[ab]=true end;if type(ab)=='table'then N[ab]=true;for bb,cb in pairs(ab)do if N[bb]or N[cb]then R(ab,bb,cb)else S(bb)S(cb)end end;N[ab]=nil end end;local T={}local U={}local V,W;function W(ab)if N[ab]then return'false'end;if not M[ab]then return V(ab)end;local bb=T[ab]if bb then return"_["..bb.."]"end;local cb=V(ab)bb=Q()table.insert(U,"_["..bb.."]="..cb)T[ab]=bb;return"_["..bb.."]"end;function V(ab)local bb=type(ab)if ab==nil then return'nil'elseif bb=="number"then return tostring(ab)elseif bb=="string"then return string.format("%q",ab)elseif bb=="boolean"then return ab and"true"or"false"elseif bb=="function"then return string.format("loadstring(%q,'@serialized')",string.dump(ab))elseif bb=="table"then local cb={}local db={}local eb=O[ab]for fb,gb in ipairs(ab)do if eb and eb[gb]then table.insert(cb,'false')else table.insert(cb,W(gb))end;db[fb]=true end;for fb,gb in pairs(ab)do if eb and(eb[fb]or eb[gb])then elseif not db[fb]then if PersistentParsed.CompressKeyData[fb]then table.insert(cb,PersistentParsed.CompressKeyData[fb].."="..W(gb))else table.insert(cb,"["..W(fb).."]="..W(gb))end end end;return"{"..table.concat(cb,",").."}"else local cb=ab;local db=string.match(tostring(u.typeof(cb)),'ctype<struct (.-)>')if not db then db='void *'else db=string.gsub(db,'%s%*','')end;local eb=u.string(cb,u.sizeof(cb))return'_CDATA(\''..db..'\',\''..v(eb)..'\')'end end;local function X()for ab,bb in ipairs(P)do local cb,db,eb=unpack(bb)assert(M[cb])local fb=W(cb).."["..W(db).."]="..W(eb)table.insert(U,fb)end end;S(J)local Y=W(J)X()local Z="local ffi=require'ffi'_CDATA=function(t,h)return ffi.cast(t..'*',h:gsub('..',function(c)return string.char(tonumber(c,16))end))end "if next(U)then return Z.."local _={}"..table.concat(U,"").."return "..Y else return Z.."return "..Y end end;local x=string.char;local y=type;local z=select;local A=string.sub;local B=table.concat;local C={}local D={}for i=0,255 do local J,K=x(i),x(i,0)C[J]=K;D[K]=J end;local function E(J,K,L,M)if L>=256 then L,M=0,M+1;if M>=256 then K={}M=1 end end;K[J]=x(L,M)L=L+1;return K,L,M end;local function F(J)if y(J)~="string"then return nil,"string expected, got "..y(J)end;local K=#J;if K<=1 then return"u"..J end;local L={}local M,N=0,1;local O={"c"}local P=1;local Q=2;local R=""for i=1,K do local S=A(J,i,i)local T=R..S;if not(C[T]or L[T])then local U=C[R]or L[R]if not U then return nil,"algorithm error, could not fetch word"end;O[Q]=U;P=P+#U;Q=Q+1;if K<=P then return"u"..J end;L,M,N=E(T,L,M,N)R=S else R=T end end;O[Q]=C[R]or L[R]P=P+#O[Q]Q=Q+1;if K<=P then return"u"..J end;return B(O)end;local function G(J,K,L,M)if L>=256 then L,M=0,M+1;if M>=256 then K={}M=1 end end;K[x(L,M)]=J;L=L+1;return K,L,M end;local function H(J)if y(J)~="string"then return nil,"string expected, got "..y(J)end;if#J<1 then return nil,"invalid input - not a compressed string"end;local K=A(J,1,1)if K=="u"then return A(J,2)elseif K~="c"then return nil,"invalid input - not a compressed string"end;J=A(J,2)local L=#J;if L<2 then return nil,"invalid input - not a compressed string"end;local M={}local N,O=0,1;local P={}local Q=1;local R=A(J,1,2)P[Q]=D[R]or M[R]Q=Q+1;for i=3,L,2 do local S=A(J,i,i+1)local T=D[R]or M[R]if not T then return nil,"could not find last from dict. Invalid input?"end;local U=D[S]or M[S]if U then P[Q]=U;Q=Q+1;M,N,O=G(T..A(U,1,1),M,N,O)else local V=T..A(T,1,1)P[Q]=V;Q=Q+1;M,N,O=G(V,M,N,O)end;R=S end;return B(P)end;local I='THIS IS EDITOR SAVE DATA\nAutomatically generated by PersistentParsed.\nThis file will be read and overwritten.\nDO NOT EDIT\n'function PersistentParsed.Save(J)local K={}for i=1,#J.Data do K[J.Data[i]]=i end;for i=1,#J.Data do local L=J.Data[i]if L.nextnote then L.nextnote=K[L.nextnote]end;if L.startnote then L.startnote=K[L.startnote]end;if L.endnote then L.endnote=K[L.endnote]end end;return I..F(serialize(J))end;function PersistentParsed.Load(J)local K=H(string.sub(J,#I+1,-1))if K then local L=loadstring(K)if L then local M,N=pcall(L)if M then for i=1,#N.Data do local O=N.Data[i]local P={}for Q,R in pairs(O)do if PersistentParsed.DecompressKeyData[Q]then P[PersistentParsed.DecompressKeyData[Q]]=R else P[Q]=R end end;N.Data[i]=P end;for i=1,#N.Data do local O=N.Data[i]if O.nextnote then O.nextnote=N.Data[O.nextnote]end;if O.startnote then O.startnote=N.Data[O.startnote]end;if O.endnote then O.endnote=N.Data[O.endnote]end end;return N else return nil end else return nil end else return nil end end;function PersistentParsed.Read(J)local K=io.open(J,'rb')local L=K:read('*all')K:close()return L end;function PersistentParsed.Write(J,K)local L=io.open(J,'wb+')L:write(K)L:close()end end;String={}String.Split=function(u,v)local w={}for x,y in u:gmatch("([^"..v.."]*)("..v.."?)")do table.insert(w,x)if y==''then return w end end end;String.Trim=function(u)local v=u:gsub("^%s*(.-)%s*$","%1")return v end;String.TrimLeft=function(u)local v=u:gsub("^%s*(.-)$","%1")return v end;String.TrimRight=function(u)local v=u:gsub("^(.-)%s*$","%1")return v end;String.StartsWith=function(u,v)return u:sub(1,#v)==v end;String.EndsWith=function(u,v)return u:sub(-#v,-1)==v end;Table={}function Table.Clone(u,v)v=v or{}local w=type(u)local x;if w=='table'then if v[u]then x=v[u]else x={}v[u]=x;for y,z in next,u,nil do x[Table.Clone(y,v)]=Table.Clone(z,v)end;setmetatable(x,Table.Clone(getmetatable(u),v))end else x=u end;return x end;ClipN=function(u,v,w)if u<v then return v elseif u>w then return w else return u end end;function Error(u)error(u,0)end;LineN=nil;function ParseError(u,v,w)Error('Line: '..LineN..'\n'..u..': '..v.. (w and(', '..w)or''))end;function MsToS(u)return u/1000 end;function SToMs(u)return u*1000 end;function HexToRGB(u)u=string.gsub(u,'#','')if#u==3 then return(tonumber(string.sub(u,1,1),16)*17), (tonumber(string.sub(u,2,2),16)*17), (tonumber(string.sub(u,3,3),16)*17)else return(tonumber(string.sub(u,1,2),16)), (tonumber(string.sub(u,3,4),16)), (tonumber(string.sub(u,5,6),16))end end;Taiko={}Taiko.Data={Languages={'','EN','JA','CN','TW','KO'},GenreAlias={Pop={'pop','j-pop'},Anime={'anime','アニメ'},Kids={'kids','どうよう'},Variety={'variety','バラエティ'},VOCALOID={'vocaloid','ボーカロイド'},Classic={'classic','クラシック'},['Game Music']={'game music','ゲームミュージック'},['Namco Original']={'namco original','ナムコオリジナル'}},CourseId={easy=0,normal=1,hard=2,oni=3,edit=4,tower=5,dan=6,ura=4},CourseName={[0]='Easy','Normal','Hard','Oni','Edit','Tower','Dan','Ura'},RatingMultiplier={[0]=0,[1]=0.5,[2]=1,[3]=2},GogoMultiplier=1.2,ScoreMode={Note={[0]=function(u,v,w,x,y,z)return math.floor((u+ ( ( (v<200)and(w or 1000)or( (w or 1000)+ (x or 1000)))*Taiko.Data.RatingMultiplier[y]* (z and Taiko.Data.GogoMultiplier or 1)))/10)*10 end,[1]=function(u,v,w,x,y,z)return math.floor((u+ ( (w+math.max(0,x*math.floor((math.min(v,100)-1)/10)))*Taiko.Data.RatingMultiplier[y]* (z and Taiko.Data.GogoMultiplier or 1)))/10)*10 end,[2]=function(u,v,w,x,y,z)return math.floor((u+ ( (w+x* ( (v>=100)and 8 or(v>=50)and 4 or(v>=30)and 2 or(v>=10)and 1 or 0))*Taiko.Data.RatingMultiplier[y]* (z and Taiko.Data.GogoMultiplier or 1)))/10)*10 end},Drumroll={[0]=function(u,v,w)return u+ ( (v==5 and 300 or v==6 and 600)* (w and Taiko.Data.GogoMultiplier or 1))end,[1]=function(u,v,w)return u+ ( (v==5 and 300 or v==6 and 600)* (w and Taiko.Data.GogoMultiplier or 1))end,[2]=function(u,v,w)return u+ ( (v==5 and 100 or v==6 and 200)* (w and Taiko.Data.GogoMultiplier or 1))end},Balloon={[0]=function(u,v,w)return u+ ( (v==7 and 300)* (w and Taiko.Data.GogoMultiplier or 1))end,[1]=function(u,v,w)return u+ ( (v==7 and 300)* (w and Taiko.Data.GogoMultiplier or 1))end,[2]=function(u,v,w)return u+ ( (v==7 and 300)* (w and Taiko.Data.GogoMultiplier or 1))end},BalloonPop={[0]=function(u,v,w)return u+ ( (v==7 and 5000)* (w and Taiko.Data.GogoMultiplier or 1))end,[1]=function(u,v,w)return u+ ( (v==7 and 5000)* (w and Taiko.Data.GogoMultiplier or 1))end,[2]=function(u,v,w)return u+ ( (v==7 and 5000)* (w and Taiko.Data.GogoMultiplier or 1))end}},Autoscore={[0]=function(u)end,[1]=function(u)end,[2]=function(u)end},SideId={normal=1,ex=2,both=3},SideName={'normal','ex','both'},StyleId={single=1,double=2,couple=2},StyleName={'single','double'},Exam={Condition={g=true,jp=true,jg=true,jb=true,s=true,r=true,h=true,c=true},Scope={m=true,l=true}},Branch={PathId={N=0,E=1,M=2},PathName={[0]='N',[1]='E',[2]='M'},Requirements={r=function()end,p=function()end}},Timing={Level={[0]={good=75,ok=108,bad=125},[1]={good=58,ok=108,bad=125},[2]={good=42,ok=108,bad=125},[3]={good=42,ok=75,bad=108},[4]={good=25,ok=75,bad=108},[5]={good=25,ok=58,bad=108},[6]={good=17,ok=42,bad=108}},Course=function(u)if u==0 or u==1 then return 2 else return 4 end end},StatusId={bad=0,ok=1,good=2,biggood=3},StatusName={[0]='BAD',[1]='OK',[2]='GOOD',[3]='GOOD'},ModeId={['']=0,P1=1,P2=2},ModeName={[0]='','P1','P2'},Combo={[1]=true,[2]=true,[3]=true,[4]=true},BigLeniency=2,Gauge={Soul={[0]=function(u)local v=10000 /u*1.575;local w=v*0.75;local x=v/-2;return{[2]=v,[1]=w,[0]=x}end,[1]=function(u)local v=10000 /u/0.7;local w=v*0.75;local x=v/-0.75;return{[2]=v,[1]=w,[0]=x}end,[2]=function(u)local v=10000 /u*1.5;local w=v*0.75;local x=v/-0.8;return{[2]=v,[1]=w,[0]=x}end,[3]=function(u)local v=10000 /u/0.7;local w=v*0.5;local x=v*-1.6;return{[2]=v,[1]=w,[0]=x}end,[4]=function(u)local v=10000 /u/0.7;local w=v*0.5;local x=v*-1.6;return{[2]=v,[1]=w,[0]=x}end},Percent=function(u)return(u/200)/50 end,ClearPercent=0.8,OverflowPercent=1},SENotes={[1]={1,2,3},[2]={4,5},[3]={6,6,6},[4]={7,7},[5]={8,9,10},[6]={11,9,10},[7]={12}},Notes={ReverseNotes={[0]=0,[1]=2,[2]=1,[3]=4,[4]=3,[5]=5,[6]=6,[7]=7,[8]=8,[9]=9}},BigNoteMul=1.5}function Taiko.ReplaceNewline(u)return string.gsub(u,'\r\n','\n')end;local function s(u)local v,w,x,y=string.match(u,'(..)%:(..)%:(..)%.(...)')if not v then v='00'w,x,y=string.match(u,'(..)%:(..)%.(...)')end;v,w,x,y=tonumber(v),tonumber(w),tonumber(x),tonumber(y)return v*60 *60 *1000 +w*60 *1000 +x*1000 +y end;function Taiko.ParseWebVTT(u)local v={}u=u..'\n\n'string.gsub(u,'\n([%d%:%.]+)[ \t]-%-%-%>[ \t]-([%d%:%.]+)\n(.-)\n',function(w,x,y)local z,A=s(w),s(x)v[#v+1]={ms=z,lengthms=A,data=y}end)return v end;local function t(u)local v=math.floor(u/ (1000 *60 *60))local w=math.floor((u% (1000 *60 *60))/ (1000 *60))local x=math.floor((u% (1000 *60))/ (1000))local y=math.floor((u% (1000))/ (1))local z={}if v~=0 then local D=tostring(v)if#D>=2 then else z[#z+1]='0'end;z[#z+1]=D;z[#z+1]=':'else z[#z+1]='00:'end;local A=tostring(w)if#A>=2 then else z[#z+1]='0'end;z[#z+1]=A;z[#z+1]=':'local B=tostring(x)if#B>=2 then else z[#z+1]='0'end;z[#z+1]=B;z[#z+1]='.'local C=tostring(y)if#C==1 then z[#z+1]='00'elseif#C==2 then z[#z+1]='0'else end;z[#z+1]=C;return table.concat(z)end;function Taiko.SerializeWebVTT(u,v)table.sort(u,function(x,y)return x.ms<y.ms end)local w={'WEBVTT\n\n'}for i=1,#u do local x=u[i]if x.data~=''then local y=x.ms;w[#w+1]=t(y)w[#w+1]=' --> 'local z=nil;if x.lengthms then z=y+x.lengthms elseif i~=#u then z=u[i+1].ms else z=v end;w[#w+1]=t(z)w[#w+1]='\n'w[#w+1]=x.data;w[#w+1]='\n\n'end end;if w[#w]=='\n\n'then w[#w]=nil end;return table.concat(w)end;function Taiko.ParseTJA(u)local v=os.clock()local w=true;local x=true;local y=true;local z=true;local A=true;local B=true;local C={}local D={Flag={PARSER_FORCE_OLD_SPEED_CALCULATION=false,PARSER_FORCE_OLD_NOTERADIUS=false,PARSER_FORCE_OLD_TARGET=false,PARSER_FORCE_OLD_BPMCHANGE=false},Metadata={SUBTITLE='',BPM=120,WAVE='main.mp3',OFFSET=0,DEMOSTART=0,SCOREMODE=1,SONGVOL=100,SEVOL=100,SIDE=3,LIFE=0,GAME='Taiko',HEADSCROLL=1,MOVIEOFFSET=0,COURSE='ONI',LEVEL=0,BALLOON=nil,BALLOONNOR=nil,BALLOONEXP=nil,BALLOONMAS=nil,STYLE=1,EXAM1=nil,EXAM2=nil,EXAM3=nil,GAUGEINCR='NORMAL',TOTAL=nil,HIDDENBRANCH=0,DIVERGENOTES=false,SCOREINIT=0,SCOREDIFF=0,STOPSONG=false},Data={},Lyric={}}if string.find(u,'$PARSER_FORCE_OLD_SPEED_CALCULATION')then D.Flag.PARSER_FORCE_OLD_SPEED_CALCULATION=true elseif string.find(u,'$PARSER_FORCE_OPENTAIKO_SPEED_CALCULATION')then else end;if string.find(u,'$PARSER_FORCE_OLD_NOTERADIUS')then D.Flag.PARSER_FORCE_OLD_NOTERADIUS=true end;if string.find(u,'$PARSER_FORCE_OLD_TARGET')then D.Flag.PARSER_FORCE_OLD_TARGET=true end;if string.find(u,'$PARSER_FORCE_OLD_BPMCHANGE')then D.Flag.PARSER_FORCE_OLD_BPMCHANGE=true end;if string.find(u,'$PARSER_UNCOMMENT_@@@')then D.Flag.PARSER_UNCOMMENT_TRIPLE_ATMARK=true;u=string.gsub(u,'$PARSER_UNCOMMENT_@@@','')local db=0;while true do if db>#u then break end;local eb,fb=string.find(u,'@@@',db)if eb then local gb=eb;while true do if string.sub(u,gb,gb)=='\n'then break else gb=gb-1 end end;local hb,ib=string.find(u,'@@@',fb)if hb then local jb=ib;while true do if string.sub(u,jb,jb)=='\n'then break else jb=jb+1 end end;local kb=string.gsub(string.gsub(string.sub(u,gb,jb),'@@@',''),'//(.-\n)','%1')u=string.sub(u,1,gb-1)..kb..string.sub(u,jb+1,-1)db=ib else break end else break end end end;local function E(db)local eb=Taiko.Data.Languages;for i=1,#eb do local fb=D.Metadata[db..eb[i]]if fb then return fb end end;return nil end;local function F(db,eb,fb)local gb=tonumber(eb)if gb then return gb else ParseError(db,fb,eb)end end;local function G(db,eb,fb,gb)if eb then return eb else ParseError(db,fb,gb)end end;local function H(db,eb,fb)local gb={['true']=true,['false']=false,yes=true,no=false,['1']=true,['0']=false,[1]=true,[0]=false}local hb=gb[eb]~=nil;if hb then return hb else ParseError(db,fb,eb)end end;local function I(db,eb,fb)local gb,hb=loadstring(eb)if gb then return gb else ParseError(db,eb,fb..': '..hb)end end;local function J(db,eb)local fb=','local gb='\\'local hb={}local ib=''local jb=false;for i=1,#eb do local kb=string.sub(eb,i,i)if jb then ib=ib..kb;jb=false else if kb==fb then table.insert(hb,ib)ib=''elseif kb==gb then jb=true else ib=ib..kb end end end;table.insert(hb,ib)return hb end;local function K(db,eb,fb)local gb=J(db,eb)for i=1,#gb do gb[i]=F(db,gb[i],fb,eb)end;return gb end;local function L(db,eb,fb)if eb and eb~=''then return K(db,eb,fb)else return{}end end;local function M(db,eb,fb)if eb and eb~=''then local gb=J(db,eb,fb)G(db,Taiko.Data.Exam.Condition[gb[1]],fb)gb[2]=F(db,gb[2],fb)gb[3]=F(db,gb[3],fb)G(db,Taiko.Data.Exam.Scope[gb[4]],fb)return gb else return{}end end;local N=error;local function O(db)return string.find(db,'/')end;local function P(db)return string.match(db,'(.+)/(.+)')end;local function Q(db)local eb=nil;local fb=false;local gb=''for i=1,#db do local hb=string.sub(db,i,i)if hb=='+'or hb=='-'then if eb then N('There are multiple signs')else eb=hb end elseif hb=='.'then if fb then N('There are multiple decimal points')else gb=gb..hb;fb=true end elseif tonumber(hb)then gb=gb..hb end end;if gb==''then N('No number was found')end;return tonumber((eb or'+')..gb)end;local function R(db)local eb=tonumber(db)if eb then return eb end;local fb=string.gsub(db,'[^%d%.%-%+]','')if fb==''then return 0 end;return tonumber(fb)or Q(db)or Q(fb)end;local function S(db)return string.find(db,'i')end;local function T(db)local eb={0,0}local fb=false;local gb=''for i=1,#db do local hb=string.sub(db,i,i)if hb=='+'or hb=='-'then eb[1]=eb[1]+R(gb)gb=hb elseif hb=='i'then eb[2]=eb[2]+R(gb)gb=''else gb=gb..hb end end;if gb~=''then eb[1]=eb[1]+R(gb)end;return eb end;local function U(db)local eb=String.Split(db,'%+')local fb={}for i=1,#eb do local ib=String.Split(eb[i],'%-')for i=1,#ib do if i==1 then fb[#fb+1]=ib[i]else fb[#fb+1]='-'..ib[i]end end end;eb=fb;local gb={0,0}local hb={false,false}for i=1,#eb do if eb[i]~=''then local ib=false;if string.find(eb[i],'i')then ib=true;eb[i]=string.gsub(eb[i],'i','')end;if O(eb[i])then local jb,kb=P(eb[i])eb[i]=(jb/kb)hb[ib and 2 or 1]=true else eb[i]=tonumber(eb[i])end;if ib then gb[2]=gb[2]+eb[i]else gb[1]=gb[1]+eb[i]end end end;return gb,hb end;local function V(db)return string.find(db,',')end;local function W(db,eb)return{db*math.cos(eb),db*math.sin(eb)}end;local function X(db)return String.Split(db,' ')end;local Y={}local function Z()local db={settings={noteparse={notes={[0]=true,[1]=true,[2]=true,[3]=true,[4]=true,[5]=true,[6]=true,[7]=true,[8]=true,[9]=true,['A']=true,['B']=true}},command={matchexceptions={}},directionweight={R=0,U=90,L=180,D=270,['0']=0,['1']=90,['2']=270,['3']=45,['4']=315,['5']=180,['6']=135,['7']=225},strict={noteparse={notes={[' ']=true,['\t']=true,['\n']=true,['\r']=true}}}},bpm=0,ms=0,songstarted=false,timingpoint=nil,sign=4 /4,mpm=0,mspermeasure=0,scrollx=-1,scrolly=0,measuredone=true,currentmeasure={},measurepushto=D.Data,barline=true,insertbarline=true,gogo=false,lastlong=nil,balloonn=1,currentbranch=nil,branch={on=false,requirements={},paths={}},msbeforebranch=nil,section=false,disablescroll=false,attachbpmchange=false,stopsong=false,delay=0,suddenappear=nil,suddenmove=nil,senotems=nil,senotei=false,lastsenote=nil,lastlastsenote=nil,senotechange=nil,jposscroll={lengthms=nil,p=nil,lanep=nil},zeroopt=w,drumrollbend=nil,drumrollbendstart=nil,positionf=nil}function db.createnote(eb)if eb then local fb={ms=nil,data=nil,type=eb,txt=nil,gogo=db.gogo,scrollx=(db.scrollx*D.Metadata.HEADSCROLL),scrolly=(db.scrolly*D.Metadata.HEADSCROLL),mspermeasure=db.mspermeasure,bpm=db.bpm,nextnote=nil,radius=1,requiredhits=nil,lengthms=nil,endnote=nil,section=nil,text=nil,delay=db.delay,senote=nil,appearancems=db.suddenappear,movems=db.suddenmove,dummy=db.dummy,positionf=db.positionf,onnotepush=nil,currentbranch=db.currentbranch,line=LineN}if eb==3 or eb==4 or eb==6 then fb.radius=fb.radius*Taiko.Data.BigNoteMul end;if eb==5 or eb==6 or eb==7 or eb==9 then if db.lastlong then if eb==9 then else ParseError('parser.noteparse','Last long note has not ended')end else db.lastlong=fb;if eb==7 or eb==9 then fb.requiredhits=G('parser.noteparse',D.Metadata.BALLOON[db.balloonn],'Invalid number of balloons',db.balloonn)db.balloonn=db.balloonn+1 end end end;if eb==8 then local gb=db.lastlong;db.lastlong=nil;fb.startnote=gb;if gb then fb.onnotepush=function()gb.lengthms=fb.ms-gb.ms;gb.endnote=fb end else ParseError('parser.noteparse','Last long note has already ended')end end;if db.section then fb.section=true;db.section=false end;if eb and db.senotechange then fb.senote=db.senotechange;db.senotechange=nil end;return fb else return{ms=nil,data=nil,type=eb,txt=nil,gogo=db.gogo,scrollx=(db.scrollx*D.Metadata.HEADSCROLL),scrolly=(db.scrolly*D.Metadata.HEADSCROLL),mspermeasure=db.mspermeasure,bpm=db.bpm,nextnote=nil,radius=1,requiredhits=nil,lengthms=nil,endnote=nil,section=nil,text=nil,delay=db.delay,senote=nil,appearancems=db.suddenappear,movems=db.suddenmove,dummy=db.dummy,positionf=db.positionf,onnotepush=nil,currentbranch=db.currentbranch,line=LineN}end end;function db.createbarline()local eb=db.createnote()eb.ms=db.ms;eb.data='event'eb.event='barline'return eb end;function db.endbranch()local eb=db.createnote()eb.data='event'eb.event='branch'eb.branch={requirements=db.branch.requirements,paths=db.branch.paths}db.branch.on=false;db.currentbranch=nil;db.branch.requirements={}db.branch.paths={}table.insert(D.Data,eb)db.measurepushto=D.Data end;return db end;Y=Z()local ab=String.Split(u,'\n')local bb=0;for i=1,#ab do if i<bb then else LineN=i;local db=String.Trim(ab[i])if String.StartsWith(db,'//')or db==''then else local eb=string.find(db,'//')if eb then db=string.sub(db,1,eb-1)end;if A then local gb,hb=string.find(db,'%[%[')if gb then local ib,jb=string.find(db,'%]%]',hb)if ib then else db=string.sub(db,1,gb-1)..string.sub(db,hb+1,-1)local kb=i+1;local lb,mb;while true do lb,mb=string.find(ab[kb],'%]%]')if lb then break else db=db..'\n'..ab[kb]end;kb=kb+1 end;bb=kb;db=db..'\n'..string.sub(ab[kb],1,lb-1)ab[kb]=string.sub(ab[kb],mb+1,-1)end end end;local fb=false;if Y.songstarted==false and fb==false then local gb={string.match(db,'(%u+):(.*)')}if gb[1]then local hb=String.Trim(gb[2])if hb~=''then D.Metadata[String.Trim(gb[1])]=hb end;fb=true end end;if(Y.songstarted or String.StartsWith(db,'#START')or String.StartsWith(db,'#BMSCROLL')or String.StartsWith(db,'#HBSCROLL')or String.StartsWith(db,'#NMSCROLL'))and fb==false then local gb={string.match(db,'#(%u-)%s(.*)')}if not gb[1]then gb={string.match(db,'#(%u+)')}end;if gb[1]then if gb[1]=='START'then if Y.songstarted then ParseError(gb[1],'Song has already started')else D.OriginalMetadata=Table.Clone(D.Metadata)if gb[2]then D.Metadata.MODE=G(gb[1],Taiko.Data.ModeId[gb[2]],'Invalid mode',gb[2])else D.Metadata.MODE=0 end;D.Metadata.TITLE=G(gb[1],E('TITLE'),'Title is missing')D.Metadata.SUBTITLE=G(gb[1],E('SUBTITLE'),'Subtitle is missing')D.Metadata.BPM=F(gb[1],D.Metadata.BPM,'Invalid bpm')D.Metadata.OFFSET=SToMs(F(gb[1],D.Metadata.OFFSET,'Invalid offset'))D.Metadata.DEMOSTART=SToMs(F(gb[1],D.Metadata.DEMOSTART,'Invalid demostart'))if D.Metadata.DEMOSTART==0 then D.Metadata.DEMOSTART=nil end;for kb,lb in pairs(Taiko.Data.GenreAlias)do for i=1,#lb do if lb[i]==D.Metadata.GENRE then D.Metadata.GENRE=kb end end end;D.Metadata.SCOREMODE=F(gb[1],D.Metadata.SCOREMODE,'Invalid scoremode')G(gb[1],Taiko.Data.ScoreMode.Note[D.Metadata.SCOREMODE],'Invalid scoremode',D.Metadata.SCOREMODE)if D.Metadata.MAKER then D.Metadata.CREATORURLT={}D.Metadata.CREATOR=String.Trim(string.gsub(D.Metadata.MAKER,'(<.->)',function(kb)table.insert(D.Metadata.CREATORURLT,string.sub(kb,2,-2))return''end))D.Metadata.CREATORURL=table.concat(D.Metadata.CREATORURLT,', ')D.Metadata.CREATIVE=false else D.Metadata.CREATIVE=false end;D.Metadata.SONGVOL=F(gb[1],D.Metadata.SONGVOL,'Invalid songvol')/100;D.Metadata.SEVOL=F(gb[1],D.Metadata.SEVOL,'Invalid sevol')/100;local hb=tonumber(D.Metadata.SIDE)if hb then G(gb[1],Taiko.Data.SideName[hb],'Invalid side id',D.Metadata.SIDE)D.Metadata.SIDE=hb else D.Metadata.SIDE=G(gb[1],Taiko.Data.SideId[string.lower(D.Metadata.SIDE)],'Invalid side name',D.Metadata.SIDE)end;D.Metadata.LIFE=F(gb[1],D.Metadata.LIFE,'Invalid life')if D.Metadata.LIFE==0 then D.Metadata.LIFE=nil end;D.Metadata.GAME=string.lower(D.Metadata.GAME)if D.Metadata.GAME=='taiko'then elseif D.Metadata.GAME=='jube'then else end;D.Metadata.HEADSCROLL=F(gb[1],D.Metadata.HEADSCROLL,'Invalid headscroll')D.Metadata.MOVIEOFFSET=F(gb[1],D.Metadata.MOVIEOFFSET,'Invalid movieoffset')local ib=tonumber(D.Metadata.COURSE)if ib then G(gb[1],Taiko.Data.CourseName[ib],'Invalid course id',D.Metadata.COURSE)D.Metadata.COURSE=ib else D.Metadata.COURSE=G(gb[1],Taiko.Data.CourseId[string.lower(D.Metadata.COURSE)],'Invalid course name',D.Metadata.COURSE)end;D.Metadata.TIMING=Taiko.Data.Timing.Course(D.Metadata.COURSE)D.Metadata.LEVEL=ClipN(math.floor(F(gb[1],D.Metadata.LEVEL,'Invalid level')),0,10)D.Metadata.BALLOON=L(gb[1],D.Metadata.BALLOON,'Invalid balloon')D.Metadata.SCOREINIT=F(gb[1],D.Metadata.SCOREINIT,'Invalid scoreinit')D.Metadata.SCOREDIFF=F(gb[1],D.Metadata.SCOREDIFF,'Invalid scoreinit')D.Metadata.BALLOONNOR=L(gb[1],D.Metadata.BALLOONNOR,'Invalid balloonnor')D.Metadata.BALLOONEXP=L(gb[1],D.Metadata.BALLOONEXP,'Invalid balloonexp')D.Metadata.BALLOONMAS=L(gb[1],D.Metadata.BALLOONMAS,'Invalid balloonmas')local jb=tonumber(D.Metadata.STYLE)if jb then G(gb[1],Taiko.Data.StyleName[jb],'Invalid style id',Taiko.Data.STYLE)D.Metadata.STYLE=jb else D.Metadata.STYLE=G(gb[1],Taiko.Data.StyleId[string.lower(D.Metadata.STYLE)],'Invalid style name',D.Metadata.STYLE)end;D.Metadata.EXAM1=M(D.Metadata.EXAM1)D.Metadata.EXAM2=M(D.Metadata.EXAM2)D.Metadata.EXAM3=M(D.Metadata.EXAM3)D.Metadata.GAUGEINCR=string.lower(D.Metadata.GAUGEINCR)if D.Metadata.TOTAL then D.Metadata.TOTAL=F(gb[1],D.Metadata.TOTAL,'Invalid total')end;D.Metadata.HIDDENBRANCH=H(gb[1],D.Metadata.HIDDENBRANCH,'Invalid hiddenbranch')Y.bpm=D.Metadata.BPM;Y.songstarted=true end elseif gb[1]=='END'then if Y.songstarted then if#Y.currentmeasure~=0 then ParseError(gb[1],'Current measure is not empty')end;table.insert(C,D)D={Flag=D.Flag,Metadata=Table.Clone(D.OriginalMetadata),Data={},Lyric={}}Y=Z()else ParseError(gb[1],'Song has already ended')end elseif gb[1]=='MEASURE'then local hb,ib=P(gb[2])hb=F(gb[1],hb,'Invalid measure')ib=F(gb[1],ib,'Invalid measure')Y.sign=(hb/ib)or Y.sign elseif gb[1]=='BPMCHANGE'then Y.bpm=F(gb[1],gb[2],'Invalid bpmchange')or Y.bpm;if Y.attachbpmchange then table.insert(Y.currentmeasure,{'BPMCHANGE',Y.bpm})end elseif gb[1]=='DELAY'then local hb=SToMs((F(gb[1],gb[2],'Invalid delay')or 0))if D.Metadata.STOPSONG then Y.delay=Y.delay+hb end;table.insert(Y.currentmeasure,{'DELAY',hb})elseif gb[1]=='SCROLL'then if Y.disablescroll then else if x and S(gb[2])then local hb=T(gb[2])Y.scrollx=-hb[1]Y.scrolly=-hb[2]elseif x and V(gb[2])then local hb=K(gb[1],gb[2],'Invalid polar scroll')if#hb==3 then local ib=W(hb[1],math.rad(hb[3]/hb[2]*360))Y.scrollx=-ib[1]Y.scrolly=-ib[2]else ParseError(gb[1],'Invalid polar scroll')end else Y.scrollx=- (F(gb[1],gb[2],'Invalid scroll')or-Y.scrollx)Y.scrolly=0 end;if Y.scroll==0 and Y.scrollx==0 and Y.scrolly==0 then ParseError(gb[1],'Scroll cannot be 0')end end elseif gb[1]=='GOGOSTART'then Y.gogo=true elseif gb[1]=='GOGOEND'then Y.gogo=false elseif gb[1]=='BARLINEOFF'then Y.barline=false elseif gb[1]=='BARLINEON'then Y.barline=true elseif gb[1]=='BRANCHSTART'then if Y.branch.on then Y.endbranch()end;Y.msbeforebranch=Y.ms;Y.branch.on=true;D.Metadata.DIVERGENOTES=true;local hb=J(gb[1],gb[2])local ib=G(gb[1],Taiko.Data.Branch.Requirements[string.lower(hb[1])],'Invalid type',hb[1])Y.branch.requirements={ib}local jb=2;while true do if not hb[jb]then break end;local kb=Taiko.Data.Branch.PathName[jb-1]if kb then Y.branch.requirements[kb]=hb[jb]else break end;jb=jb+1 end elseif Taiko.Data.Branch.PathId[gb[1]]then if Y.branch.on then Y.ms=Y.msbeforebranch;Y.currentbranch=gb[1]Y.branch.paths[gb[1]]={}Y.measurepushto=Y.branch.paths[gb[1]]else ParseError(gb[1],'Branch has not started')end elseif gb[1]=='BRANCHEND'then if Y.branch.on then Y.endbranch()else ParseError(gb[1],'Branch has already ended')end elseif gb[1]=='SECTION'then Y.section=true elseif gb[1]=='LYRIC'then table.insert(Y.currentmeasure,{'LYRIC',gb[2]})elseif gb[1]=='LEVELHOLD'then elseif gb[1]=='BMSCROLL'then Y.disablescroll=true;if not D.Flag.PARSER_FORCE_OLD_BPMCHANGE then Y.attachbpmchange=true end;D.Metadata.STOPSONG=true elseif gb[1]=='HBSCROLL'then if not D.Flag.PARSER_FORCE_OLD_BPMCHANGE then Y.attachbpmchange=true end;D.Metadata.STOPSONG=true elseif gb[1]=='NMSCROLL'then if not D.Flag.PARSER_FORCE_OLD_BPMCHANGE then Y.attachbpmchange=false end;D.Metadata.STOPSONG=false elseif gb[1]=='SENOTECHANGE'then Y.senotechange=F(gb[1],gb[2],'Invalid senotechange')elseif gb[1]=='NEXTSONG'then elseif gb[1]=='DIRECTION'then local hb=gb[2]local ib=Y.settings.directionweight;local jb=0;local kb=0;for i=1,#hb do local ob=string.sub(hb,i,i)if ib[ob]then jb=jb+ib[ob]kb=kb+1 end end;if kb==0 then ParseError(gb[1],'Invalid direction')end;local lb=jb/kb;local mb=math.sqrt(Y.scrollx^2 +Y.scrolly^2)local nb=W(mb,math.rad(lb))Y.scrollx=-nb[1]Y.scrolly=-nb[2]elseif gb[1]=='SUDDEN'then local hb=X(gb[2])Y.suddenappear=-SToMs(F(gb[1],hb[1],'Invalid sudden')or(Y.suddenappear and-MsToS(Y.suddenappear)or 0))Y.suddenmove=-SToMs(F(gb[1],hb[2],'Invalid sudden')or(Y.suddenmove and-MsToS(Y.suddenmove)or 0))elseif gb[1]=='JPOSSCROLL'then local hb=false;local ib=X(gb[2])local function jb(kb,lb,mb,nb)if(x and O(lb))or(nb)then Y.jposscroll.lanep=Y.jposscroll.lanep or{nil,nil}if O(lb)then local ob,pb=P(lb)ob=F(gb[1],ob,'Invalid jposscroll')pb=F(gb[1],pb,'Invalid jposscroll')Y.jposscroll.lanep[kb]=(ob/pb)else Y.jposscroll.lanep[kb]=lb end;if mb then Y.jposscroll.lanep[1]=Y.jposscroll.lanep[1]* (G(gb[1],mb=='1'and 1 or mb=='0'and-1,'Invalid jposscroll',mb)or 1)end elseif x and lb=='default'then Y.jposscroll.p='default'else Y.jposscroll.p=Y.jposscroll.p or{nil,nil}Y.jposscroll.p[kb]=F(gb[1],lb,'Invalid jposscroll')if mb then Y.jposscroll.p[kb]=Y.jposscroll.p[kb]* (G(gb[1],mb=='1'and 1 or mb=='0'and-1,'Invalid jposscroll',mb)or 1)end end end;if y then if S(ib[2])then local kb,lb=U(ib[2])jb(1,kb[1],nil,lb[1])jb(2,kb[2],nil,lb[2])hb=true elseif V(ib[2])then local kb=J(gb[1],ib[2])if#kb==3 then local lb=false;if O(kb[2])then lb=true;local nb,ob=P(kb[2])nb=F(gb[1],nb,'Invalid polar jposscroll')ob=F(gb[1],ob,'Invalid polar jposscroll')kb[2]=(nb/ob)else kb[2]=F(gb[1],kb[2],'Invalid polar jposscroll')end;kb[1]=F(gb[1],kb[1],'Invalid polar jposscroll')kb[3]=F(gb[1],kb[3],'Invalid polar jposscroll')local mb=W(kb[1],math.rad(kb[3]/kb[2]*360))jb(1,mb[1],nil,lb)jb(2,mb[2],nil,lb)hb=true else ParseError(gb[1],'Invalid polar jposscroll')end end else end;if hb==false then jb(1,ib[2],ib[3])end;Y.jposscroll.lengthms=SToMs(F(gb[1],ib[1],'Invalid jposscroll')or 0)table.insert(Y.currentmeasure,{'JPOSSCROLL',Y.jposscroll})Y.jposscroll={}elseif x and gb[1]=='GAMEMODE'then elseif x and gb[1]=='SPLITLANE'then elseif x and gb[1]=='MERGELANE'then elseif x and gb[1]=='BARLINE'then table.insert(Y.currentmeasure,Y.createbarline())elseif x and gb[1]=='DUMMYSTART'then Y.dummy=true elseif x and gb[1]=='DUMMYEND'then Y.dummy=false elseif x and gb[1]==''then elseif x and gb[1]==''then elseif x and gb[1]==''then elseif x and gb[1]==''then elseif x and gb[1]==''then elseif x and gb[1]==''then elseif x and gb[1]==''then elseif x and gb[1]==''then elseif x and gb[1]==''then elseif x and gb[1]==''then elseif x and gb[1]==''then elseif x and gb[1]==''then elseif x and gb[1]==''then elseif x and gb[1]==''then elseif x and gb[1]==''then elseif x and gb[1]==''then elseif x and gb[1]==''then elseif x and gb[1]=='RESETCOMMAND'then Y=Z()Y.songstarted=true elseif z and gb[1]=='POSITIONF'then if not gb[2]or gb[2]==''then Y.positionf=nil else local hb=nil;if string.sub(String.TrimLeft(gb[2]),1,#'return function(')=='return function('then hb=I(gb[1],gb[2],'Invalid positionf')()elseif string.sub(String.TrimLeft(gb[2]),1,#'function(')=='function('then hb=I(gb[1],'return '..gb[2],'Invalid positionf')()elseif string.sub(String.TrimLeft(gb[2]),1,#'return ')=='return 'then hb=I(gb[1],'return function(note,ms,target)'..gb[2]..' end','Invalid positionf')()else hb=I(gb[1],'return function(note,ms,target)return '..gb[2]..' end','Invalid positionf')()end;Y.positionf=hb end elseif z and gb[1]=='POSITIONT'then if not gb[2]or gb[2]==''then Y.positionf=nil else local hb=nil;if string.sub(String.TrimLeft(gb[2]),1,#'return ')=='return 'then hb={I(gb[1],gb[2],'Invalid positionf')()}else hb={I(gb[1],'return '..gb[2],'Invalid positionf')()}end;local ib={}for i=1,#hb,2 do ib[#ib+1]={hb[i],hb[i+1],{}}end;hb=nil;table.sort(ib,function(kb,lb)return kb[1]>lb[1]end)local jb=nil;if ib[1][1]==math.huge then jb=ib[1]table.remove(ib,1)end;Y.positionf=function(kb,lb,mb)for i=#ib,1,-1 do local qb=ib[i]if i==#ib then qb[3][1],qb[3][2]=mb[1],mb[2]else local rb=ib[i][1]- (ib[i+1]and ib[i+1][1]or 0)qb[3][1],qb[3][2]=(ib[i+1])[2](kb,kb.ms-rb,ib[i+1][3])end end;local nb=kb.ms-lb;for i=#ib,1,-1 do local qb=ib[i]if nb<qb[1]then local rb=ib[i+1]and ib[i+1][1]or 0;return qb[2](kb,lb+rb,qb[3])end end;local ob=ib[1][1]- (ib[2]and ib[2][1]or 0)jb[3][1],jb[3][2]=(ib[1])[2](kb,kb.ms-ob,ib[1][3])local pb=ib[1]and ib[1][1]or 0;return jb[2](kb,lb+pb,jb[3])end end else end;fb=true end end;if(Y.songstarted)and fb==false then Y.mpm=Y.bpm*Y.sign/4;Y.mspermeasure=60000 *Y.sign*4 /Y.bpm;if Y.barline and Y.insertbarline then table.insert(Y.currentmeasure,Y.createbarline())Y.insertbarline=false end;for i=1,#db do local gb=string.sub(db,i,i)local hb=tonumber(gb)or gb;if Y.settings.noteparse.notes[hb]then local ib=Y.createnote(hb)ib.data='note'table.insert(Y.currentmeasure,ib)else if B then if Y.settings.strict.noteparse.notes[gb]then else local ib=#String.TrimRight(db)if i==ib then else ParseError('parser.noteparse','Invalid symbol')end end end end end;if String.EndsWith(String.TrimRight(db),',')then Y.mpm=Y.bpm*Y.sign/4;Y.mspermeasure=60000 *Y.sign*4 /Y.bpm;if#Y.currentmeasure==0 then Y.ms=Y.ms+Y.mspermeasure;Y.measuredone=true;Y.insertbarline=true elseif#Y.currentmeasure==1 and Y.currentmeasure[1].data=='event'and Y.currentmeasure[1].event=='barline'then D.Data[#D.Data+1]=Y.currentmeasure[1]Y.ms=Y.ms+Y.mspermeasure;Y.measuredone=true;Y.currentmeasure={}Y.insertbarline=true else local gb=0;local hb=nil;for i=1,#Y.currentmeasure do local mb=Y.currentmeasure[i]if mb.data=='note'then hb=hb or mb.mspermeasure;gb=gb+1 end end;hb=hb or Y.mspermeasure;local ib=hb/gb;local jb=false;local kb=false;local lb=false;for i=1,#Y.currentmeasure do local mb=Y.currentmeasure[i]if mb[1]=='DELAY'then Y.ms=Y.ms+mb[2]elseif mb[1]=='JPOSSCROLL'then jb=mb;Y.zeroopt=false elseif mb[1]=='BPMCHANGE'then kb=mb;Y.zeroopt=false elseif mb[1]=='LYRIC'then lb=mb;Y.zeroopt=false else if Y.drumrollbend and mb.type==0 and(mb.scrollx~=Y.drumrollbendstart.scrollx or mb.scrolly~=Y.drumrollbendstart.scrolly or mb.positionf~=Y.drumrollbendstart.positionf)then Y.drumrollbend[#Y.drumrollbend+1]=mb end;if not Y.zeroopt or mb.type~=0 then mb.ms=Y.ms;local nb=Y.measurepushto[#Y.measurepushto]or D.Data[#D.Data]if nb then nb.nextnote=mb end;if z then if mb.type==5 or mb.type==6 and(not Y.drumrollbend)then mb.drumrollbend={}Y.drumrollbend=mb.drumrollbend;Y.drumrollbendstart=mb end;if mb.type==8 then Y.drumrollbend=nil end end;table.insert(Y.measurepushto,mb)if mb.onnotepush then mb.onnotepush()end;ib=mb.mspermeasure/gb end;if jb then mb.jposscroll=jb[2]jb=false end;if kb then mb.bpmchange=kb[2]kb=false end;if lb then table.insert(D.Lyric,{ms=mb.ms-D.Metadata.OFFSET,lengthms=nil,data=lb[2]})lb=false end;if mb.type==0 then Y.zeroopt=w end;if mb.type==1 or mb.type==2 then if not Y.senotems then if Y.senotems==nil then Y.senotems=false elseif Y.lastsenote then local nb=(mb.ms or Y.ms)-Y.lastsenote.ms;if nb<200 then Y.senotems=nb;if Y.lastlastsenote and(Y.lastsenote.ms-Y.lastlastsenote.ms==Y.senotems)then Y.lastlastsenote.senote=Taiko.Data.SENotes[Y.lastlastsenote.type][2]end end end end;if Y.senotems then if mb.ms- (Y.lastsenote and Y.lastsenote.ms or 0)==Y.senotems then Y.lastsenote.senote=Taiko.Data.SENotes[Y.lastsenote.type][2]elseif Y.lastsenote and Taiko.Data.SENotes[Y.lastsenote.type]then Y.lastsenote.senote=Taiko.Data.SENotes[Y.lastsenote.type][1]Y.senotems=false end elseif Y.lastsenote then Y.lastsenote.senote=Taiko.Data.SENotes[Y.lastsenote.type][1]end;Y.lastlastsenote=Y.lastsenote;Y.lastsenote=mb elseif mb.type==3 or mb.type==4 or mb.type==7 or mb.type==5 or mb.type==6 then mb.senote=Taiko.Data.SENotes[mb.type][1]Y.senotems=false end;if mb.data=='note'then Y.ms=Y.ms+ib end end end;Y.measuredone=true;Y.currentmeasure={}Y.zeroopt=w;Y.insertbarline=true;if jb then Y.currentmeasure[#Y.currentmeasure+1]=jb end;if kb then Y.currentmeasure[#Y.currentmeasure+1]=kb end;if lb then Y.currentmeasure[#Y.currentmeasure+1]=lb end end else Y.measuredone=false end end end end end;local cb=nil;for db,eb in pairs(C)do if#eb.Lyric~=0 then cb=eb.Lyric;break end end;if cb then for db,eb in pairs(C)do if#eb.Lyric==0 then eb.Lyric=cb end end end;LineN=1;return C end;function Taiko.ParseTJAFile(u)local v=io.open(u,'r')if v then local w=v:read('*all')v:close()local x;local y,z=pcall(function()x=Taiko.ParseTJA(w)end)if y then else return nil,z end;local A=string.find(string.reverse(u),'[/\\]')for B,C in pairs(x)do C.Metadata.SONG=(A and string.sub(u,1,#u+1 -A)or'')..C.Metadata.WAVE end;return x else return nil,'Unable to open file'end end;function Taiko.SerializeTJA(u)local v={OFFSET=0.001,MOVIEOFFSET=0.001,DEMOSTART=0.001,SONGVOL=100,SEVOL=100}local w={}local x={'// Automatically Serialized by Taiko.SerializeTJA\n\n'}local y=function(J,K)local L={}for N in pairs(J)do L[#L+1]=N end;if K then table.sort(L,function(N,O)return K(J,N,O)end)else table.sort(L)end;local M=0;return function()M=M+1;if L[M]then return L[M],J[L[M]]end end end;local z=1;local function A(J,K)if J<0 or K<0 then error('Negative GCD')return nil end;if J<K then return A(K,J)end;if math.abs(K)<z then return J else return A(K,J-math.floor(J/K)*K)end end;local function B(J)return math.floor(J+0.5)end;local function C(J)local K,L=J,1;while true do if not string.find(tostring(K),'%.')then break end;K=K*10;L=L*10 end;return K..'/'..L end;local D=nil;local E=nil;local F={mspermeasure=true,startnote=true,endnote=true,nextnote=true,lengthms=true,onnotepush=true,data=true,line=true,type=true,ms=true,scrolly=true,event=true}local G={scrollx=true}local function H(J)local K=0;local L=true;for O,P in y(J,function(O,P,Q)return P<Q end)do if(G[O])or( (not F[O])and(not D or not(J[O]==D[O])))then local Q=#x+1;local R=true;if O=='bpm'then x[#x+1]='#BPMCHANGE 'x[#x+1]=tostring(J.bpm)elseif O=='scrollx'then if(not D or not(J[O]==D[O]and J.scrolly==D.scrolly))then x[#x+1]='#SCROLL 'x[#x+1]=tostring(-J.scrollx)if J.scrolly~=0 then if-J.scrolly>=0 then x[#x+1]='+'end;x[#x+1]=tostring(-J.scrolly)x[#x+1]='i'end else R=false end elseif O=='gogo'then if J.gogo then x[#x+1]='#GOGOSTART'else x[#x+1]='#GOGOEND'end elseif O=='senote'then R=false elseif O=='delay'then elseif O=='jposscroll'then x[#x+1]='#JPOSSCROLL 'x[#x+1]=tostring(MsToS(P.lengthms))x[#x+1]=' 'if P.p=='default'then x[#x+1]='default'else if P.p and P.p[1]then x[#x+1]=tostring(P.p[1])else x[#x+1]=C(P.lanep[1])end;if P.p and P.p[2]and P.p[2]~=0 then if P.p[2]>=0 then x[#x+1]='+'end;x[#x+1]=tostring(P.p[2])x[#x+1]='i'elseif P.lanep and P.lanep[2]and P.lanep[2]~=0 then if P.lanep[2]>=0 then x[#x+1]='+'end;x[#x+1]=C(P.lanep[2])x[#x+1]='i'end end;x[#x+1]=' 1'elseif O=='radius'then local S=J.type;if(not D or not(P/ ( (S==3 or S==4 or S==6)and Taiko.Data.BigNoteMul or 1)==D[O]/ ( (D.type==3 or D.type==4 or D.type==6)and Taiko.Data.BigNoteMul or 1)))then x[#x+1]='#RADIUS 'x[#x+1]=tostring(P)else R=false end else print('Invalid attribute, '..O)R=false end;if R then if L then table.insert(x,Q,'\n')L=false end;x[#x+1]='\n'end end end;local M=#x+1;local N=true;if not D then N=false else local O=J.delay- (D and D.delay or 0)if O==0 then N=false else x[#x+1]='#DELAY 'x[#x+1]=tostring(MsToS(O))K=K+O end end;if N then if L then table.insert(x,M,'\n')L=false end;x[#x+1]='\n'end;if J.data=='note'then x[#x+1]=tostring(J.type)end;E=D;D=J;return K end;local function I(J,K,L)local M=J[1].ms-K;for i=2,#J do M=A(M,J[i].ms-K)end;M=A(M,L-J[#J].ms)return M end;for J,K in pairs(u)do D=nil;local L=K.Data;for S,T in y(K.Flag,function(S,T,U)return T<U end)do x[#x+1]='//$'x[#x+1]=tostring(S)x[#x+1]='\n'end;x[#x+1]='\n'for S,T in y(K.Metadata,function(S,T,U)return T<U end)do if(type(T)=='string'or type(T)=='number')and S~='SONG'then x[#x+1]=tostring(S)x[#x+1]=':'if S=='COURSE'then x[#x+1]=tostring(Taiko.Data.CourseName[T])elseif v[S]then x[#x+1]=tostring(T*v[S])else x[#x+1]=tostring(T)end;x[#x+1]='\n'end end;x[#x+1]='\n'if K.Metadata.STOPSONG then x[#x+1]='\n#HBSCROLL\n'else x[#x+1]='\n#NMSCROLL\n'end;for i=1,#L do local S=L[i]S.ms=S.ms-S.delay end;x[#x+1]='#START\n'local M=nil;local N=nil;local O=nil;local P=nil;local Q=nil;local R=nil;for i=1,#L do local S=L[i]local T=L[i+1]if(not Q)and(T and(S.data=='note'and T.data=='note')and S.ms==T.ms)then Q=S.ms end;if(S and(S.data=='event'and S.event=='barline'))or(i==1)or R or( (not Q)and(T and S.ms==T.ms))then M={}N=S.ms end;M[#M+1]=S;R=(Q and not(T and T.ms==Q))if(T and(T.data=='event'and T.event=='barline'))or(i==#L)or R then if R then x[#x+1]='\n#BARLINEOFF\n'if P~=0 then x[#x+1]='#MEASURE 0/1\n'end;for i=1,#M do local X=M[i]local Y=H(X)end;x[#x+1]=',\n'local U=60000 /S.bpm;local V=( (T.ms-Q)/U)/4;local W=tostring(V)if W~=O then x[#x+1]='\n#MEASURE 'x[#x+1]=C(V)x[#x+1]='\n'x[#x+1]=',\n'x[#x+1]='\n#MEASURE 'x[#x+1]=C(P)x[#x+1]='\n'end;x[#x+1]='#BARLINEON\n'Q=nil else local U=(T and T.ms or S.ms)local V=U-N;local W=nil;if#M>=2 then W=I(M,N,U)elseif#M==1 then W=A(S.ms-N,U-S.ms)else W=V end;local X=nil;if T then X=V else X=W+V end;local Y=60000 /S.bpm;local Z=(X/Y)/4;local ab=tostring(Z)if ab~=O then x[#x+1]='\n#MEASURE 'x[#x+1]=C(Z)x[#x+1]='\n'O=ab;P=Z end;if#M==0 then x[#x+1]=',\n'else x[#x+1]=string.rep('0',((M[1].ms-N))/W)for i=1,#M do local bb=M[i]local cb=H(bb)if i==#M then x[#x+1]=string.rep('0',(( (T and T.ms or(X)+N)-M[#M].ms))/W-1)else x[#x+1]=string.rep('0',((M[i+1].ms-M[i].ms))/W-1)end end;x[#x+1]=',\n'end end end end;x[#x+1]='#END\n'for i=1,#L do local S=L[i]S.ms=S.ms+S.delay end;return table.concat(x)end;return table.concat(x)end;function Taiko.Score(u,v,w,x,y)if x==0 then w=0 else w=w+1 end;local z=u.Metadata;return Taiko.Data.ScoreMode.Note[z.SCOREMODE](v,w,z.SCOREINIT,z.SCOREDIFF,x,y),w end;function Taiko.Analyze(u)local v='M'local w={[1]=2,[2]=2,[3]=3,[4]=3}local x={notes={n=0,validn=0},measures=0,lengthms=0,drumrollms=0,drumrollbigms=0,balloonms=0,balloonhit=0,specialms=0,specialhit=0,maxcombo=0,maxscore=0}local y=nil;Taiko.ForAll(u.Data,function(z,A,B)if z.data=='note'then x.notes.n=x.notes.n+1;x.notes[z.type]=x.notes[z.type]and x.notes[z.type]+1 or 1;if w[z.type]then x.maxscore,x.maxcombo=Taiko.Score(u,x.maxscore,x.maxcombo,w[z.type],z.gogo)end;local C=z.endnote;if C then local D=C.ms-z.ms;if z.type==5 then x.drumrollms=x.drumrollms+D elseif z.type==6 then x.drumrollbigms=x.drumrollbigms+D elseif z.type==7 then x.balloonms=x.balloonms+D;x.balloonhit=x.balloonhit+z.requiredhits elseif z.type==9 then x.specialms=x.specialms+D;x.specialhit=x.specialhit+z.requiredhits else end end;y=z elseif z.data=='event'and z.event=='barline'then x.measures=x.measures+1 else end end,v)x.lengthms=y.ms-u.Metadata.OFFSET;x.notes.validn=x.maxcombo;return x end;function Taiko.GetDifficulty(u,v)local w=Taiko.Data.CourseId[string.lower(v)]or v;for x,y in pairs(u)do if y.Metadata.COURSE==w then return y end end;Error('No difficulty found, '..v)return nil end;function Taiko.ForAll(u,v,w)local x=1;for i=1,#u do local y=u[i]if y.branch then if w then local z=y.branch.paths[w]for i2=1,#z do v(z[i2],i2,x)x=x+1 end;x=x-1 else local z=-1;for A,B in pairs(y.branch.paths)do local C=x;for i2=1,#B do v(B[i2],i2,C)C=C+1 end;z=(z<C)and C or z end;x=z end else v(y,i,x)end;x=x+1 end;return u end;function Taiko.GetAllNotes(u)local v={}for w,x in pairs(u)do if x.branch then for y,z in pairs(x.branch.paths)do for i=1,#z do table.insert(v,z[i])end end else table.insert(v,x)end end;return v end;function Taiko.ConnectNotes(u)local v=nil;for i=#u,1,-1 do local w=u[i]w.nextnote=v;v=w end;return u end;function Taiko.ExtractBranch(u,v)return u.branch.paths[v]end;function Taiko.ConnectAll(u)local v=nil;for i=#u,1,-1 do local w=u[i]if w.branch then for x,y in pairs(w.branch.paths)do local z=Taiko.ConnectNotes(y)z[#z].nextnote=v end else w.nextnote=v end;v=w end end;function Taiko.CalculateSpeed(u,v)local w=(v*u.scrollx*u.bpm/7500)local x=(v*u.scrolly*u.bpm/7500)return{w,x}end;function Taiko.CalculateSpeedInterval(u,v)local w=960;local x=(u.bpm/240000 *u.scrollx*w*v)local y=(u.bpm/240000 *u.scrolly*w*v)return{x,y}end;function Taiko.RenderScale(u)local v={}local w={}local x={}for i=1,#u.Data do local B=u.Data[i]if B.data=='note'then local C=math.floor(B.ms)if math.floor(C)-C==0 then table.insert(v,{C,B.type})table.insert(w,C)else table.insert(x,i)end end end;function gcd2(B,C)if C==0 then return B else return gcd2(C,B%C)end end;function gcdn(B)local C=B[1]for i=2,#B do C=gcd2(C,B[i])end;return C end;local y=gcdn(w)for i=1,#x do local B=v[x[i]]B[1]=math.floor(B[1]/y)*y end;local z=''local A=0;for i=1,#v do v[i][1]=v[i][1]/y;z=z..string.rep(' ',v[i][1]-A)..v[i][2]A=v[i][1]end;return z end;function Taiko.Game()local u=nil;local v='config.tpd'local w;local x=0;local y=138;local z;local function A()rl.CloseWindow()rl.CloseAudioDevice()end;local function B(Ec,Fc)local Gc=10;if Fc<Gc then Fc=Gc end;local Hc=Fc/Gc;local Ic=rl.MeasureTextEx(rl.GetFontDefault(),Ec,Fc,Hc)return math.floor(Ic.x),math.floor(Ic.y)end;local C={[rl.KEY_Y]=true,[rl.KEY_N]=false}local D=50;local function E(Ec)local Fc,Gc=B(Ec,D)local Hc=nil;while not rl.WindowShouldClose()do rl.BeginDrawing()rl.ClearBackground(rl.RAYWHITE)rl.DrawText(Ec,w.ScreenWidth/2 -Fc/2,w.ScreenHeight/2 -Gc/2,D,rl.BLACK)rl.EndDrawing()for Ic,Jc in pairs(C)do if rl.IsKeyPressed(Ic)then Hc=Jc;break end end;if Hc~=nil then break end end;return Hc end;local F=true;local function G(Ec)if F then return E(Ec..'\nPress y to confirm\nPress n to reject')else return true end end;local function H(Ec)local Fc,Gc=B(Ec,D)local Hc={}Ec=Ec..'\n'local Ic=Ec;while not rl.WindowShouldClose()do rl.BeginDrawing()rl.ClearBackground(rl.RAYWHITE)rl.DrawText(Ic,w.ScreenWidth/2 -Fc/2,w.ScreenHeight/2 -Gc/2,D,rl.BLACK)rl.EndDrawing()while true do local Jc=rl.GetCharPressed()if Jc==0 then break else Hc[#Hc+1]=Jc;Ic=Ec..m(Hc)end end;if rl.IsKeyPressed(rl.KEY_BACKSPACE)then Hc[#Hc]=nil;Ic=Ec..m(Hc)end;if rl.IsKeyPressed(rl.KEY_ENTER)then break end end;Hc=m(Hc)return Hc~=''and Hc or nil end;local function I(Ec)local Fc,Gc=B(Ec,D)local Hc=nil;while not rl.WindowShouldClose()do rl.BeginDrawing()rl.ClearBackground(rl.RAYWHITE)rl.DrawText(Ec,w.ScreenWidth/2 -Fc/2,w.ScreenHeight/2 -Gc/2,D,rl.BLACK)rl.EndDrawing()while true do local Ic=rl.GetCharPressed()if Ic==0 then break else Hc=true;break end end;if Hc then break end end;return Hc end;local J=true;local function K(Ec,Fc)if J then local Gc=H(Ec..'\nType \''..Fc..'\' to confirm')if Gc==Fc then return true else return false end else return true end end;local function L(Ec)return string.reverse(string.match(string.reverse(Ec),'(.-%.)'))end;local function M(Ec)local Fc=string.sub(Ec,-1,-1)if Fc=='/'or Fc=='\\'then return string.sub(Ec,1,-2)else return Ec end end;local function N(Ec)return string.reverse(string.match(string.reverse(Ec),'(.-)/'))end;local function O(Ec)local Fc=N(Ec)local Gc=string.find(Fc,'%.')if Gc then return string.sub(Fc,1,Gc-1)else return Fc end end;local function P(Ec)local Fc=N(Ec)if string.find(Fc,'%.')then return true else return false end end;local function Q(Ec)local Fc=require('ffi')local Gc=rl.LoadDirectoryFiles(M(Ec))local Hc={}for i=0,Gc.count-1 do Hc[#Hc+1]=Fc.string(Gc.paths[i])if rl.IsPathFile(Hc[#Hc])==false then local Ic=Q(Hc[#Hc])Hc[#Hc]=nil;for i2=1,#Ic do Hc[#Hc+1]=Ic[i2]end end end;return Hc end;local function R(Ec)local Fc=require('ffi')Ec=Ec or w.Paths.Songs;local Gc={}local Hc=rl.LoadDirectoryFiles(M(Ec))local Ic={}for i=0,Hc.count-1 do if rl.IsPathFile(Ic[#Ic])==false then local Jc=Ic[#Ic]local Kc=Fc.string(rl.GetFileNameWithoutExt(Ic[#Ic]))local Lc,Mc=ScanSongs(Ic[#Ic])Gc[Kc]=Mc;Ic[#Ic]=nil;local Nc=true;for i2=1,#Lc do if Nc then local Oc=rl.GetFileNameWithoutExt(Lc[i2])if Fc.string(Oc)==Kc then else Nc=false end end;Ic[#Ic+1]=Lc[i2]end;if Nc then for i2=1,#Gc[Kc]do Gc[#Gc+1]=Gc[Kc][i2]end;Gc[Kc]=nil else end else Gc[#Gc+1]=Ic[#Ic]end end;return Ic,Gc end;local function S(Ec)local Fc=require('lfs.lfs_ffi')Ec=Ec or w.Paths.Songs;local Gc={}local Hc=M(Ec)local Ic,Jc=Fc.dir(Hc)Hc=Hc..'/'local Kc={}while true do local Lc=Ic(Jc)if not Lc then break end;if Lc~='.'and Lc~='..'then Kc[#Kc+1]=Hc..Lc;if P(Kc[#Kc])==false then local Mc=Kc[#Kc]local Nc=O(Kc[#Kc])local Oc,Pc=S(Kc[#Kc])Gc[Nc]=Pc;Kc[#Kc]=nil;local Qc=true;for i2=1,#Oc do if Qc then local Rc=O(Oc[i2])if Rc==Nc then else Qc=false end end;Kc[#Kc+1]=Oc[i2]end;if Qc then for i2=1,#Gc[Nc]do Gc[#Gc+1]=Gc[Nc][i2]end;Gc[Nc]=nil else end else Gc[#Gc+1]=Kc[#Kc]end end end;return Kc,Gc end;local function T(Ec)local Fc={}for Gc,Hc in pairs(Ec)do if type(Hc)=='table'then Fc[Gc]=T(Hc)else if L(Hc)=='.tja'then Fc[O(Hc)]=Hc end end end;return Fc end;local function U(Ec)local Fc=io.open(Ec,'rb')if Fc then Fc:close()return true else return false end end;local function V(Ec)local Fc=io.open(Ec,'rb')if Fc then local Gc=Fc:read('*all')Fc:close()return Gc else print('Unable to find file: '..Ec)end end;local function W(Ec)z(Ec)return V(u..Ec)end;local function X(Ec)local Fc,Gc=io.open(Ec,'rb')if Fc then local Hc=Fc:read('*all')Fc:close()local Ic=require('ffi')return rl.LoadMusicStreamFromMemory(Ic.new('const char *',L(Ec)),Ic.new("const unsigned char *",Hc),Ic.new('int',#Hc+1))else return nil end end;local function Y(Ec)return rl.LoadMusicStream(Ec)end;local function Z(Ec)local Fc=W(Ec)if not Fc then return rl.new('Image')end;return rl.LoadImageFromMemory(L(Ec),Fc,#Fc)end;local function ab(Ec)local Fc=W(Ec)if not Fc then return rl.new('Wave')end;return rl.LoadWaveFromMemory(L(Ec),Fc,#Fc)end;local function bb(Ec)local Fc=ab(Ec)local Gc=rl.LoadSoundFromWave(Fc)rl.UnloadWave(Fc)return Gc end;local function cb(Ec,Fc,Gc)local Hc={}local Ic=Gc;while true do local Jc=Ec..tostring(Ic)..Fc;if U(u..Jc)then Hc[Ic]=Z(Jc)Ic=Ic+1 else if Ic==0 then Hc[0]=rl.new('Image')end;break end end;return Hc end;local function db(Ec,Fc)local Gc={Ec,Fc}return Gc end;local function eb(Ec)local Fc=0;for Gc,Hc in pairs(Ec)do Fc=Fc+1 end;return Fc end;local function fb(Ec,Fc,Gc,Hc)Fc=Fc or 32;if not Gc then Gc={}for i=1,Hc do Gc[#Gc+1]=i end end;Gc=Gc and rl.new('int[?]',#Gc,Gc)Hc=Hc or 0;local Ic=W(Ec)if not Ic then return rl.new('Font')end;return rl.LoadFontFromMemory(L(Ec),Ic,#Ic,Fc,Gc,Hc)end;local gb={}local function hb(Ec,Fc,Gc,Hc)return function(Ic,Jc)if not Jc then Jc={}for i=1,#Ic do Jc[Ic[i]]=true end end;for Kc,Lc in pairs(gb)do if#Kc==#Ic then local Mc=true;for i=1,#Kc do if not Jc[Kc[i]]then Mc=false;break end end;if Mc then return Lc end end end;gb[Ic]=fb(Ec,Fc,Ic,#Ic)return gb[Ic]end end;local ib=-4;local function jb(Ec,Fc,Gc,Hc,Ic,Jc)local Kc=ib*Jc[1]local Lc,Mc=0,0;local Nc=0;for i=1,#Ec do local Oc=string.sub(Ec,i,i)if Oc=='\n'then Nc=Nc- (Hc+Kc)Lc=Nc>Lc and Nc or Lc;Mc=Mc+ (Ic+Kc)else Nc=Nc+ (Hc+Kc)end end;Nc=Nc- (Hc+Kc)Lc=Nc>Lc and Nc or Lc;return Lc,Mc end;local function kb(Ec,Fc,Gc,Hc,Ic,Jc,Kc,Lc,Mc,Nc)Nc=Nc or{['0']={0,0},['1']={1,0},['2']={2,0},['3']={3,0},['4']={4,0},['5']={5,0},['6']={6,0},['7']={7,0},['8']={8,0},['9']={9,0}}local Oc=0;local Pc=0;local Qc=rl.new('Rectangle',0,0,Ic-1,Jc-1)local Rc=rl.new('Rectangle',0,0,Kc-1,Lc-1)local Sc=rl.new('Vector2',0,0)local Tc=ib*Mc[1]for i=1,#Fc do local Uc=string.sub(Fc,i,i)if Uc=='\n'then Oc=Oc+1;Pc=0 else local Vc=Nc[Uc]Qc.x=Vc[1]*Ic;Qc.y=Vc[2]*Jc;Rc.x=Gc+ (Kc+Tc)*Pc;Rc.y=Hc+ (Lc+Tc)*Oc;rl.DrawTexturePro(Ec,Qc,Rc,Sc,0,rl.WHITE)Pc=Pc+1 end end end;local function lb(Ec,Fc)local Gc=os.date('%Y-%m-%d-%Hh%Mm%Ss000',os.time())local Hc=Ec..Gc..Fc;return Hc end;local function mb(Ec,Fc,Gc)local Hc=lb(Ec,Fc)local Ic=io.open(Hc,'wb+')if Ic then Ic:write(Gc)Ic:close()else print('Unable to find file: '..Hc)end end;local nb=false;if U(v)then w=Persistent.Load(Persistent.Read(v))else w={}nb=true end;w=w or{}w.ScreenWidth=w.ScreenWidth or 1600;w.ScreenHeight=w.ScreenHeight or w.ScreenWidth/16 *9;w.WindowName=w.WindowName or'Taiko'w.Settings=w.Settings or{}w.Settings.FPS=w.Settings.FPS or 60;w.Settings.VSync=w.Settings.VSync==nil and true or w.Settings.VSync;local function ob()if w.Settings.VSync then rl.SetConfigFlags(rl.FLAG_VSYNC_HINT)end;rl.SetConfigFlags(rl.FLAG_WINDOW_RESIZABLE)rl.SetTraceLogLevel(rl.LOG_NONE)rl.InitWindow(w.ScreenWidth,w.ScreenHeight,w.WindowName)if w.Settings.LimitFPS then rl.SetTargetFPS(w.Settings.FPS)end;rl.SetExitKey(rl.KEY_NULL)end;ob()if nb then local Ec=nil;while true do local Fc=E('Config file not found\nPress y to generate new config\nPress n to use a different config')if Fc==true then local Gc=G('Are you sure you want to overwrite '..v..'?')if Gc then Ec=Persistent.Read('defaultconfig.tpd')else end elseif Fc==false then while true do local Gc=H('What is the file path?\n(Relative or Absolute)')if Gc then if U(Gc)then local Hc=G('Are you sure you want to use '..Gc..'?')if Hc then Ec=Persistent.Read(Gc)break else end else I('Invalid file')end else break end end else local Gc=G('Are you sure you want to continue without config?')if Gc then break else end end;if Ec then break end end;if Ec then w=Persistent.Load(Ec)end end;local pb=Table.Clone(w)local function qb(Ec)for Fc,Gc in pairs(Ec)do if rl.IsKeyPressed(Fc)then return true end end;return false end;local function rb(Ec)for Fc,Gc in pairs(Ec)do if rl.IsKeyDown(Fc)then return true end end;return false end;local function sb(Ec)for Fc,Gc in pairs(Ec)do if rl.IsKeyPressed(Fc)then return Fc end end;return false end;local function tb()local Ec,Fc=w.ScreenWidth,w.ScreenHeight;if w.Fullscreen then rl.ToggleFullscreen()w.ScreenWidth,w.ScreenHeight=pb.ScreenWidth,pb.ScreenHeight;rl.RestoreWindow()rl.SetWindowSize(w.ScreenWidth,w.ScreenHeight)else local Gc=rl.GetCurrentMonitor()w.ScreenWidth,w.ScreenHeight=rl.GetMonitorWidth(Gc),rl.GetMonitorHeight(Gc)rl.SetWindowSize(w.ScreenWidth,w.ScreenHeight)rl.ToggleFullscreen()end;w.Fullscreen=not w.Fullscreen;return w.ScreenWidth/Ec,w.ScreenHeight/Fc end;if w.Fullscreen then w.Fullscreen=false;tb()end;local ub={vsync=pb.Settings.VSync}function Taiko.UpdateConfig()w.Offsets.Music=MsToS(w.Offsets.Music)u=w.Paths.Assets;v=w.Paths.Config;w.Controls.SongSelect.FastScrollTime=MsToS(w.Controls.SongSelect.FastScrollTime)w.Controls.SongSelect.FastScrollInterval=MsToS(w.Controls.SongSelect.FastScrollInterval)if ub.vsync~=w.Settings.VSync then rl.CloseWindow()ob()ub.vsync=w.Settings.VSync else if w.Settings.LimitFPS then rl.SetTargetFPS(w.Settings.FPS)end end end;Taiko.UpdateConfig()z=function()end;rl.BeginDrawing()rl.ClearBackground(rl.RAYWHITE)rl.DrawText([[
Taiko v34
Loading assets and config...

WARNING: Sound is very loud, so turn it all
the way down and work your way up.]],0,w.ScreenHeight/2,D,rl.BLACK)rl.EndDrawing()local vb={414 /1280 *pb.ScreenWidth,- (257 /720 -1 /2)*pb.ScreenHeight}local wb=333 /1280 *pb.ScreenWidth;local xb=vb[2]local yb,zb=0,pb.ScreenHeight/2;local Ab=Taiko.Data.BigNoteMul;local Bb=54;local Cb={vb[1],vb[2]}local Db={}local Eb=pb.ScreenHeight/45;local Fb=0.1;local Gb={1280,720}local Hb=60;local Ib=1000 /Hb;local Jb=IniParser.LoadFile(u..'SkinConfig.ini')for Ec,Fc in pairs(Jb)do local Gc=IniParser.ParseCSV(Fc)local Hc=true;for i=1,#Gc do local Ic=tonumber(Gc[i])if Ic then Gc[i]=Ic else Hc=false;break end end;if Hc then Jb[Ec]=Gc end end;local Kb={PlaySong={Notes=Z('Graphics/5_Game/Notes.png'),SENotes=Z('Graphics/5_Game/SENotes.png'),Barlines={bar=Z('Graphics/5_Game/Bar.png'),bar_branch=Z('Graphics/5_Game/Bar_Branch.png')},Judges=Z('Graphics/5_Game/Judge.png'),Balloons={Anim=cb('Graphics/5_Game/11_Balloon/Breaking_','.png',0,5)},Effects={Note={Hit={[1]={Anim=cb('Graphics/5_Game/10_Effects/Hit/Good/','.png',0,14)},[2]={Anim=cb('Graphics/5_Game/10_Effects/Hit/Great/','.png',0,14)},[3]={Anim=cb('Graphics/5_Game/10_Effects/Hit/Good_Big/','.png',0,14)},[4]={Anim=cb('Graphics/5_Game/10_Effects/Hit/Great_Big/','.png',0,14)}},Explosion=Z('Graphics/5_Game/10_Effects/Hit/Explosion.png'),ExplosionBig=Z('Graphics/5_Game/10_Effects/Hit/Explosion_Big.png')}},Lanes={Lane={default=Z('Graphics/5_Game/12_Lane/Background_Main.png'),gogo=Z('Graphics/5_Game/12_Lane/Background_GoGo.png'),[1]=Z('Graphics/5_Game/12_Lane/Red.png'),[2]=Z('Graphics/5_Game/12_Lane/Blue.png'),sub=Z('Graphics/5_Game/12_Lane/Background_Sub.png'),N=Z('Graphics/5_Game/12_Lane/Base_Normal.png'),E=Z('Graphics/5_Game/12_Lane/Base_Expert.png'),M=Z('Graphics/5_Game/12_Lane/Base_Master.png')},Text={N=Z('Graphics/5_Game/12_Lane/Text_Normal.png'),E=Z('Graphics/5_Game/12_Lane/Text_Expert.png'),M=Z('Graphics/5_Game/12_Lane/Text_Master.png')}},Backgrounds={Background={Bottom={},InfoBar={[0]=Z('Graphics/5_Game/6_Taiko/1P_Background.png')},CourseSymbol={[0]=Z('Graphics/5_Game/4_CourseSymbol/Easy.png'),[1]=Z('Graphics/5_Game/4_CourseSymbol/Normal.png'),[2]=Z('Graphics/5_Game/4_CourseSymbol/Hard.png'),[3]=Z('Graphics/5_Game/4_CourseSymbol/Oni.png'),[4]=Z('Graphics/5_Game/4_CourseSymbol/Edit.png'),[5]=Z('Graphics/5_Game/4_CourseSymbol/Tower.png'),[6]=Z('Graphics/5_Game/4_CourseSymbol/Dan.png')}},Frame={[1]=Z('Graphics/5_Game/6_Taiko/1P_Frame.png')},Taiko={base=Z('Graphics/5_Game/6_Taiko/Base.png'),[1]=Z('Graphics/5_Game/6_Taiko/Don.png'),[2]=Z('Graphics/5_Game/6_Taiko/Ka.png'),combo=Z('Graphics/5_Game/6_Taiko/Combo_Text.png')},ComboText={[0]=Z('Graphics/5_Game/6_Taiko/Combo_Text.png')}},Gauges={Meter={base=Z('Graphics/5_Game/7_Gauge/1P_Base.png'),full=Z('Graphics/5_Game/7_Gauge/1P.png'),rainbow={Anim=cb('Graphics/5_Game/7_Gauge/rainbow/','.png',0,11)}},Clear={}},Fonts={Combo={[0]=Z('Graphics/5_Game/6_Taiko/Combo.png'),[1]=Z('Graphics/5_Game/6_Taiko/Combo_Midium.png'),[2]=Z('Graphics/5_Game/6_Taiko/Combo_Big.png')},Score={[0]=Z('Graphics/5_Game/6_Taiko/Score.png'),[1]=Z('Graphics/5_Game/6_Taiko/Score_1P.png')}},Nameplates=Z('Graphics/NamePlate.png')},SongSelect={GenreBar=cb('Graphics/3_SongSelect/Bar_Genre/Bar_Genre_','.png',0,9),BoxCharacter=cb('Graphics/3_SongSelect/Box_Chara/Box_Chara_','.png',0,12),Difficulty={Bar=Z('Graphics/3_SongSelect/Difficulty_Select/Difficulty_Bar.png')},GenreBackground=cb('Graphics/3_SongSelect/Genre_Background/GenreBackground_','.png',0,12)}}local Lb={PlaySong={Notes={target={0,0},[1]={1,0},[2]={2,0},[3]={3,0},[4]={4,0},drumrollnote={5,0},drumrollrect={6,0},drumrollend={7,0},DRUMROLLnote={8,0},DRUMROLLrect={9,0},DRUMROLLend={10,0},balloon={11,0},balloonend={12,0}},SENotes={[1]={0,0},[2]={0,1},[3]={0,2},[4]={0,3},[5]={0,4},[6]={0,5},[7]={0,6},[8]={0,7},[9]={0,8},[10]={0,9},[11]={0,10},[12]={0,11}},Judges={[2]={0,0},[1]={0,1},[0]={0,2},adlib={0,3}},Effects={Note={Explosion={[1]={Anim={[0]={0,1},[1]={1,1},[2]={2,1},[3]={3,1},[4]={4,1},[5]={5,1},[6]={6,1}}},[2]={Anim={[0]={0,0},[1]={1,0},[2]={2,0},[3]={3,0},[4]={4,0},[5]={5,0},[6]={6,0}}},[3]={Anim={[0]={0,3},[1]={1,3},[2]={2,3},[3]={3,3},[4]={4,3},[5]={5,3},[6]={6,3}}},[4]={Anim={[0]={0,2},[1]={1,2},[2]={2,2},[3]={3,2},[4]={4,2},[5]={5,2},[6]={6,2}}}}}},Nameplates={[1]={0,0},[3]={0,1},[2]={0,2},base={0,3},edge={0,4},top={0,5},rankbase={0,7},rank={[1]={0,8},[2]={0,9},[3]={0,10}}}}}z('Splitting into textures')local Mb={130,130}local Nb={130,130}local Ob=Lb.PlaySong.Notes.drumrollend;local Pb=rl.ImageFromImage(Kb.PlaySong.Notes,rl.new('Rectangle',Ob[1]*Mb[1]-5,Ob[2]*Mb[2],Mb[1],Mb[2]))Kb.PlaySong.Notes=TextureMap.SplitUsingMap(Kb.PlaySong.Notes,Lb.PlaySong.Notes,Mb,Nb)Kb.PlaySong.Notes.drumrollstart=rl.ImageCopy(Kb.PlaySong.Notes.drumrollend)rl.ImageFlipHorizontal(Kb.PlaySong.Notes.drumrollstart)Kb.PlaySong.Notes.DRUMROLLstart=rl.ImageCopy(Kb.PlaySong.Notes.DRUMROLLend)rl.ImageFlipHorizontal(Kb.PlaySong.Notes.DRUMROLLstart)local Qb=Kb.PlaySong.Notes.drumrollend;local Rb=rl.ImageCopy(Pb)rl.ImageFlipHorizontal(Rb)local Sb=rl.ImageFromImage(Rb,rl.new('Rectangle',Qb.width/2,0,Qb.width/2,Qb.height))rl.ImageResizeCanvas(Sb,Qb.width,Qb.height,0,0,rl.WHITE)rl.ImageDraw(Sb,Pb,rl.new('Rectangle',0,0,Qb.width/2,Qb.height),rl.new('Rectangle',Qb.width/2,0,Qb.width/2,Qb.height),rl.WHITE)Kb.PlaySong.Notes.drumrollbend=Sb;rl.UnloadImage(Pb)rl.UnloadImage(Rb)local function Tb(Ec,Fc,Gc)Fc=Fc or 1;Gc=Gc or 1;if type(Ec)=='table'then for Hc,Ic in pairs(Ec)do Tb(Ic,Fc,Gc)end else rl.ImageResize(Ec,(pb.ScreenWidth/1280)*Ec.width*Fc,(pb.ScreenHeight/720)*Ec.height*Gc)end;return Ec end;Kb.PlaySong.Notes=Tb(Kb.PlaySong.Notes)Kb.PlaySong.Notes=TextureMap.ReplaceWithTexture(Kb.PlaySong.Notes)local Ub,Vb=Kb.PlaySong.Notes.target.width,Kb.PlaySong.Notes.target.height;local Wb=rl.new('Rectangle',0,0,Ub,Vb)local Xb=rl.new('Vector2',Ub/2,Vb/2)local Yb,Zb=yb- (Ub/2),zb- (Vb/2)local ac,bc=1,-1;local cc=rl.new('Rectangle',0,0,0,0)Kb.PlaySong.Notes.drumrollpr=rl.new('Rectangle',0,0,Ub,Vb)Kb.PlaySong.Notes.drumrollpr2=rl.new('Rectangle',0,0,Ub,Vb)local dc={1,1}local function ec(Ec,Fc,Gc,Hc)if not Hc then dc[1]=dc[1]*Fc;dc[2]=dc[2]*Gc;Xb.x=Xb.x*Fc;Xb.y=Xb.y*Gc;Eb=Eb*Gc end;for Ic,Jc in pairs(Ec)do if type(Jc)=='table'then ec(Jc,Fc,Gc,true)elseif type(Jc)=='number'then if string.find(Ic,'sizex')then Ec[Ic]=Jc*Fc elseif string.find(Ic,'sizey')then Ec[Ic]=Jc*Gc end elseif type(Jc)=='cdata'then local Kc=tostring(Jc)if string.find(Kc,'Image')then elseif string.find(Kc,'Texture')then elseif string.find(Kc,'Vector2')then Jc.x=Jc.x*Fc;Jc.y=Jc.y*Gc elseif string.find(Kc,'Rectangle')then if string.find(Ic,'sourcerect')then else Jc.x=Jc.x*Fc;Jc.y=Jc.y*Gc;Jc.width=Jc.width*Fc;Jc.height=Jc.height*Gc end end end end;return Ec end;local function fc()end;local function gc()end;local hc={136,30}local ic={136,30}Kb.PlaySong.SENotes=TextureMap.SplitUsingMap(Kb.PlaySong.SENotes,Lb.PlaySong.SENotes,hc,ic)Kb.PlaySong.SENotes=Tb(Kb.PlaySong.SENotes)Kb.PlaySong.SENotes=TextureMap.ReplaceWithTexture(Kb.PlaySong.SENotes)Kb.PlaySong.SENotes.sizex=Kb.PlaySong.SENotes[1].width;Kb.PlaySong.SENotes.sizey=Kb.PlaySong.SENotes[1].height;Kb.PlaySong.SENotes.sourcerect=rl.new('Rectangle',0,0,Kb.PlaySong.SENotes.sizex,Kb.PlaySong.SENotes.sizey)Kb.PlaySong.SENotes.center=rl.new('Vector2',Kb.PlaySong.SENotes.sizex/2,Kb.PlaySong.SENotes.sizey/2)Kb.PlaySong.SENotes.offsety=80 /720 *pb.ScreenHeight;Kb.PlaySong.Barlines=Tb(Kb.PlaySong.Barlines)Kb.PlaySong.Barlines=TextureMap.ReplaceWithTexture(Kb.PlaySong.Barlines)local jc,kc=Kb.PlaySong.Barlines.bar.width,Kb.PlaySong.Barlines.bar.height;local lc=rl.new('Rectangle',0,0,jc,kc)local mc=rl.new('Vector2',jc/2,kc/2)Kb.PlaySong.Balloons=Tb(Kb.PlaySong.Balloons)Kb.PlaySong.Balloons=TextureMap.ReplaceWithTexture(Kb.PlaySong.Balloons)Kb.PlaySong.Balloons.sizex=Kb.PlaySong.Balloons.Anim[0].width;Kb.PlaySong.Balloons.sizey=Kb.PlaySong.Balloons.Anim[0].height;Kb.PlaySong.Balloons.sourcerect=rl.new('Rectangle',0,0,Kb.PlaySong.Balloons.sizex,Kb.PlaySong.Balloons.sizey)Kb.PlaySong.Balloons.center=rl.new('Vector2',Kb.PlaySong.Balloons.sizex/2,Kb.PlaySong.Balloons.sizey/2)Kb.PlaySong.Balloons.pr=rl.new('Rectangle',0,0,Kb.PlaySong.Balloons.sizex,Kb.PlaySong.Balloons.sizey)Kb.PlaySong.Balloons.pr2=rl.new('Rectangle',0,0,Ub,Vb)local nc={90,60}local oc={90,60}Kb.PlaySong.Judges=TextureMap.SplitUsingMap(Kb.PlaySong.Judges,Lb.PlaySong.Judges,nc,oc)Kb.PlaySong.Judges=Tb(Kb.PlaySong.Judges)Kb.PlaySong.Judges=TextureMap.ReplaceWithTexture(Kb.PlaySong.Judges)Kb.PlaySong.Judges.sizex=Kb.PlaySong.Judges[0].width;Kb.PlaySong.Judges.sizey=Kb.PlaySong.Judges[0].height;Kb.PlaySong.Judges.sourcerect=rl.new('Rectangle',0,0,Kb.PlaySong.Judges.sizex,Kb.PlaySong.Judges.sizey)Kb.PlaySong.Judges.center=rl.new('Vector2',Kb.PlaySong.Judges.sizex/2,Kb.PlaySong.Judges.sizey/2)Kb.PlaySong.Judges.pr=rl.new('Rectangle',0,0,Kb.PlaySong.Judges.sizex,Kb.PlaySong.Judges.sizey)local pc=rl.new('Color',255,255,255,255 /2)Kb.PlaySong.Effects.Note.Hit=Tb(Kb.PlaySong.Effects.Note.Hit)Kb.PlaySong.Effects.Note.Hit=TextureMap.ReplaceWithTexture(Kb.PlaySong.Effects.Note.Hit)Kb.PlaySong.Effects.Note.sizex=Kb.PlaySong.Effects.Note.Hit[1].Anim[0].width;Kb.PlaySong.Effects.Note.sizey=Kb.PlaySong.Effects.Note.Hit[1].Anim[0].height;Kb.PlaySong.Effects.Note.sizex=Kb.PlaySong.Effects.Note.sizex==0 and 260 /1280 *pb.ScreenWidth or Kb.PlaySong.Effects.Note.sizex;Kb.PlaySong.Effects.Note.sizey=Kb.PlaySong.Effects.sizey==0 and 260 /720 *pb.ScreenHeight or Kb.PlaySong.Effects.Note.sizey;Kb.PlaySong.Effects.Note.sourcerect=rl.new('Rectangle',0,0,Kb.PlaySong.Effects.Note.sizex,Kb.PlaySong.Effects.Note.sizey)Kb.PlaySong.Effects.Note.center=rl.new('Vector2',Kb.PlaySong.Effects.Note.sizex/2,Kb.PlaySong.Effects.Note.sizey/2)local qc={260,260}local rc={260,260}Kb.PlaySong.Effects.Note.Explosion=TextureMap.SplitUsingMap(Kb.PlaySong.Effects.Note.Explosion,Lb.PlaySong.Effects.Note.Explosion,qc,rc)Kb.PlaySong.Effects.Note.Explosion=Tb(Kb.PlaySong.Effects.Note.Explosion)Kb.PlaySong.Effects.Note.Explosion=TextureMap.ReplaceWithTexture(Kb.PlaySong.Effects.Note.Explosion)local sc={Kb.PlaySong.Effects.Note.ExplosionBig}Kb.PlaySong.Effects.Note.ExplosionBig=Tb(sc)Kb.PlaySong.Effects.Note.ExplosionBig={Anim={[0]=TextureMap.ReplaceWithTexture(sc)[1]}}Kb.PlaySong.Lanes=Tb(Kb.PlaySong.Lanes)Kb.PlaySong.Lanes=TextureMap.ReplaceWithTexture(Kb.PlaySong.Lanes)Kb.PlaySong.Lanes.sizex=Kb.PlaySong.Lanes.Lane.default.width;Kb.PlaySong.Lanes.sizey=Kb.PlaySong.Lanes.Lane.default.height;Kb.PlaySong.Lanes.sourcerect=rl.new('Rectangle',0,0,Kb.PlaySong.Lanes.sizex,Kb.PlaySong.Lanes.sizey)Kb.PlaySong.Lanes.center=rl.new('Vector2',0,Kb.PlaySong.Lanes.sizey/2)Kb.PlaySong.Lanes.pr=rl.new('Rectangle',wb*ac+yb,xb*bc+zb,Kb.PlaySong.Lanes.sizex,Kb.PlaySong.Lanes.sizey)Kb.PlaySong.Lanes.ssizex=Kb.PlaySong.Lanes.Lane.sub.width;Kb.PlaySong.Lanes.ssizey=Kb.PlaySong.Lanes.Lane.sub.height;Kb.PlaySong.Lanes.ssourcerect=rl.new('Rectangle',0,0,Kb.PlaySong.Lanes.ssizex,Kb.PlaySong.Lanes.ssizey)Kb.PlaySong.Lanes.scenter=rl.new('Vector2',0,0)Kb.PlaySong.Lanes.spr=rl.new('Rectangle',wb*ac+yb,325 /720 *pb.ScreenHeight,Kb.PlaySong.Lanes.ssizex,Kb.PlaySong.Lanes.ssizey)Kb.PlaySong.Backgrounds=Tb(Kb.PlaySong.Backgrounds)Kb.PlaySong.Backgrounds=TextureMap.ReplaceWithTexture(Kb.PlaySong.Backgrounds)Kb.PlaySong.Backgrounds.Frame.sizex=Kb.PlaySong.Backgrounds.Frame[1].width;Kb.PlaySong.Backgrounds.Frame.sizey=Kb.PlaySong.Backgrounds.Frame[1].height;Kb.PlaySong.Backgrounds.Frame.sourcerect=rl.new('Rectangle',0,0,Kb.PlaySong.Backgrounds.Frame.sizex,Kb.PlaySong.Backgrounds.Frame.sizey)Kb.PlaySong.Backgrounds.Frame.center=rl.new('Vector2',0,0)Kb.PlaySong.Backgrounds.Frame.pr=rl.new('Rectangle',332 /1280 *pb.ScreenWidth,136 /720 *pb.ScreenHeight,Kb.PlaySong.Backgrounds.Frame.sizex,Kb.PlaySong.Backgrounds.Frame.sizey)Kb.PlaySong.Backgrounds.Taiko.sizex=Kb.PlaySong.Backgrounds.Taiko.base.width;Kb.PlaySong.Backgrounds.Taiko.sizey=Kb.PlaySong.Backgrounds.Taiko.base.height;Kb.PlaySong.Backgrounds.Taiko.sourcerect=rl.new('Rectangle',0,0,Kb.PlaySong.Backgrounds.Taiko.sizex,Kb.PlaySong.Backgrounds.Taiko.sizey)Kb.PlaySong.Backgrounds.Taiko.center=rl.new('Vector2',0,0)Kb.PlaySong.Backgrounds.Taiko.pr=rl.new('Rectangle',210 /1280 *pb.ScreenWidth,206 /720 *pb.ScreenHeight,Kb.PlaySong.Backgrounds.Taiko.sizex,Kb.PlaySong.Backgrounds.Taiko.sizey)Kb.PlaySong.Backgrounds.ComboText.sizex=Kb.PlaySong.Backgrounds.ComboText[0].width;Kb.PlaySong.Backgrounds.ComboText.sizey=Kb.PlaySong.Backgrounds.ComboText[0].height;Kb.PlaySong.Backgrounds.ComboText.sourcerect=rl.new('Rectangle',0,0,Kb.PlaySong.Backgrounds.ComboText.sizex,Kb.PlaySong.Backgrounds.ComboText.sizey)Kb.PlaySong.Backgrounds.ComboText.center=rl.new('Vector2',0,0)Kb.PlaySong.Backgrounds.ComboText.pr=rl.new('Rectangle',220 /1280 *pb.ScreenWidth,198 /720 *pb.ScreenHeight,Kb.PlaySong.Backgrounds.ComboText.sizex,Kb.PlaySong.Backgrounds.ComboText.sizey)Kb.PlaySong.Backgrounds.Background.InfoBar.sizex=Kb.PlaySong.Backgrounds.Background.InfoBar[0].width;Kb.PlaySong.Backgrounds.Background.InfoBar.sizey=Kb.PlaySong.Backgrounds.Background.InfoBar[0].height;Kb.PlaySong.Backgrounds.Background.InfoBar.sourcerect=rl.new('Rectangle',0,0,Kb.PlaySong.Backgrounds.Background.InfoBar.sizex,Kb.PlaySong.Backgrounds.Background.InfoBar.sizey)Kb.PlaySong.Backgrounds.Background.InfoBar.center=rl.new('Vector2',0,0)Kb.PlaySong.Backgrounds.Background.InfoBar.pr=rl.new('Rectangle',0 /1280 *pb.ScreenWidth,184 /720 *pb.ScreenHeight,Kb.PlaySong.Backgrounds.Background.InfoBar.sizex,Kb.PlaySong.Backgrounds.Background.InfoBar.sizey)Kb.PlaySong.Backgrounds.Background.CourseSymbol.sizex=Kb.PlaySong.Backgrounds.Background.CourseSymbol[0].width;Kb.PlaySong.Backgrounds.Background.CourseSymbol.sizey=Kb.PlaySong.Backgrounds.Background.CourseSymbol[0].height;Kb.PlaySong.Backgrounds.Background.CourseSymbol.sourcerect=rl.new('Rectangle',0,0,Kb.PlaySong.Backgrounds.Background.CourseSymbol.sizex,Kb.PlaySong.Backgrounds.Background.CourseSymbol.sizey)Kb.PlaySong.Backgrounds.Background.CourseSymbol.center=rl.new('Vector2',0,0)Kb.PlaySong.Backgrounds.Background.CourseSymbol.pr=rl.new('Rectangle',58 /1280 *pb.ScreenWidth,230 /720 *pb.ScreenHeight,Kb.PlaySong.Backgrounds.Background.CourseSymbol.sizex,Kb.PlaySong.Backgrounds.Background.CourseSymbol.sizey)Kb.PlaySong.Backgrounds.Background.CourseSymbol.pr=rl.new('Rectangle',18 /1280 *pb.ScreenWidth,230 /720 *pb.ScreenHeight,Kb.PlaySong.Backgrounds.Background.CourseSymbol.sizex,Kb.PlaySong.Backgrounds.Background.CourseSymbol.sizey)Kb.PlaySong.Gauges.Clear[true]=rl.ImageFromImage(Kb.PlaySong.Gauges.Meter.base,rl.new('Rectangle',0,44,58,24))Kb.PlaySong.Gauges.Clear[false]=rl.ImageFromImage(Kb.PlaySong.Gauges.Meter.base,rl.new('Rectangle',58,44,58,24))Kb.PlaySong.Gauges.Meter.clear=rl.ImageCopy(Kb.PlaySong.Gauges.Meter.full)for x=0,Kb.PlaySong.Gauges.Meter.clear.width-1 do for y=0,Kb.PlaySong.Gauges.Meter.clear.height-1 do local Ec=rl.GetImageColor(Kb.PlaySong.Gauges.Meter.clear,x,y)Ec.g=Ec.r;rl.ImageDrawPixel(Kb.PlaySong.Gauges.Meter.clear,x,y,Ec)end end;Kb.PlaySong.Gauges=Tb(Kb.PlaySong.Gauges)Kb.PlaySong.Gauges=TextureMap.ReplaceWithTexture(Kb.PlaySong.Gauges)Kb.PlaySong.Gauges.Meter.sizex=Kb.PlaySong.Gauges.Meter.base.width;Kb.PlaySong.Gauges.Meter.sizey=Kb.PlaySong.Gauges.Meter.base.height;Kb.PlaySong.Gauges.Meter.sourcerect=rl.new('Rectangle',0,0,Kb.PlaySong.Gauges.Meter.sizex,Kb.PlaySong.Gauges.Meter.sizey)Kb.PlaySong.Gauges.Meter.center=rl.new('Vector2',0,0)Kb.PlaySong.Gauges.Meter.pr=rl.new('Rectangle',494 /1280 *pb.ScreenWidth,144 /720 *pb.ScreenHeight,Kb.PlaySong.Gauges.Meter.sizex,Kb.PlaySong.Gauges.Meter.sizey)Kb.PlaySong.Gauges.Meter.sourcerect2=rl.new('Rectangle',0,0,Kb.PlaySong.Gauges.Meter.sizex,Kb.PlaySong.Gauges.Meter.sizey)Kb.PlaySong.Gauges.Meter.pr2=rl.new('Rectangle',494 /1280 *pb.ScreenWidth,144 /720 *pb.ScreenHeight,Kb.PlaySong.Gauges.Meter.sizex,Kb.PlaySong.Gauges.Meter.sizey)Kb.PlaySong.Gauges.Clear.sizex=Kb.PlaySong.Gauges.Clear[true].width;Kb.PlaySong.Gauges.Clear.sizey=Kb.PlaySong.Gauges.Clear[true].height;Kb.PlaySong.Gauges.Clear.sourcerect=rl.new('Rectangle',0,0,Kb.PlaySong.Gauges.Clear.sizex,Kb.PlaySong.Gauges.Clear.sizey)Kb.PlaySong.Gauges.Clear.center=rl.new('Vector2',0,0)Kb.PlaySong.Gauges.Clear.pr=rl.new('Rectangle',1038 /1280 *pb.ScreenWidth,143 /720 *pb.ScreenHeight,Kb.PlaySong.Gauges.Clear.sizex,Kb.PlaySong.Gauges.Clear.sizey)Kb.PlaySong.Gauges.Meter.rainbow.sizex=Kb.PlaySong.Gauges.Meter.rainbow.Anim[0].width;Kb.PlaySong.Gauges.Meter.rainbow.sizey=Kb.PlaySong.Gauges.Meter.rainbow.Anim[0].height;Kb.PlaySong.Gauges.Meter.rainbow.sourcerect=rl.new('Rectangle',0,0,Kb.PlaySong.Gauges.Meter.rainbow.sizex,Kb.PlaySong.Gauges.Meter.rainbow.sizey)Kb.PlaySong.Gauges.Meter.rainbow.center=rl.new('Vector2',0,0)Kb.PlaySong.Gauges.Meter.rainbow.pr=rl.new('Rectangle',494 /1280 *pb.ScreenWidth,144 /720 *pb.ScreenHeight,Kb.PlaySong.Gauges.Meter.rainbow.sizex,Kb.PlaySong.Gauges.Meter.rainbow.sizey)Kb.PlaySong.Fonts=Tb(Kb.PlaySong.Fonts)Kb.PlaySong.Fonts=TextureMap.ReplaceWithTexture(Kb.PlaySong.Fonts)local tc={220,54}local uc={220,54}Kb.PlaySong.Nameplates=TextureMap.SplitUsingMap(Kb.PlaySong.Nameplates,Lb.PlaySong.Nameplates,tc,uc)Kb.PlaySong.Nameplates=Tb(Kb.PlaySong.Nameplates)Kb.PlaySong.Nameplates=TextureMap.ReplaceWithTexture(Kb.PlaySong.Nameplates)Kb.PlaySong.Nameplates.sizex=Kb.PlaySong.Nameplates.base.width;Kb.PlaySong.Nameplates.sizey=Kb.PlaySong.Nameplates.base.height;Kb.PlaySong.Nameplates.sourcerect=rl.new('Rectangle',0,0,Kb.PlaySong.Nameplates.sizex,Kb.PlaySong.Nameplates.sizey)Kb.PlaySong.Nameplates.center=rl.new('Vector2',0,0)Kb.PlaySong.Nameplates.pr=rl.new('Rectangle',-5 /1280 *pb.ScreenWidth,296 /720 *pb.ScreenHeight,Kb.PlaySong.Nameplates.sizex,Kb.PlaySong.Nameplates.sizey)rl.InitAudioDevice()rl.SetMasterVolume(w.Settings.MasterVolume)local vc={PlaySong={Combo=(not w.ComboSoundEnabled)and{}or{[50]=bb('Sounds/Combo_1P/50.wav'),[100]=bb('Sounds/Combo_1P/100.wav'),[200]=bb('Sounds/Combo_1P/200.wav'),[300]=bb('Sounds/Combo_1P/300.wav'),[400]=bb('Sounds/Combo_1P/400.wav'),[500]=bb('Sounds/Combo_1P/500.wav'),[600]=bb('Sounds/Combo_1P/600.wav'),[700]=bb('Sounds/Combo_1P/700.wav'),[800]=bb('Sounds/Combo_1P/800.wav'),[900]=bb('Sounds/Combo_1P/900.wav'),[1000]=bb('Sounds/Combo_1P/1000.wav'),[1100]=bb('Sounds/Combo_1P/1100.wav'),[1200]=bb('Sounds/Combo_1P/1200.wav'),[1300]=bb('Sounds/Combo_1P/1300.wav'),[1400]=bb('Sounds/Combo_1P/1400.wav'),[1500]=bb('Sounds/Combo_1P/1500.wav'),[1600]=bb('Sounds/Combo_1P/1600.wav'),[1700]=bb('Sounds/Combo_1P/1700.wav'),[1800]=bb('Sounds/Combo_1P/1800.wav'),[1900]=bb('Sounds/Combo_1P/1900.wav'),[2000]=bb('Sounds/Combo_1P/2000.wav'),[2100]=bb('Sounds/Combo_1P/2100.wav'),[2200]=bb('Sounds/Combo_1P/2200.wav'),[2300]=bb('Sounds/Combo_1P/2300.wav'),[2400]=bb('Sounds/Combo_1P/2400.wav'),[2500]=bb('Sounds/Combo_1P/2500.wav'),[2600]=bb('Sounds/Combo_1P/2600.wav'),[2700]=bb('Sounds/Combo_1P/2700.wav'),[2800]=bb('Sounds/Combo_1P/2800.wav'),[2900]=bb('Sounds/Combo_1P/2900.wav'),[3000]=bb('Sounds/Combo_1P/3000.wav'),[3100]=bb('Sounds/Combo_1P/3100.wav'),[3200]=bb('Sounds/Combo_1P/3200.wav'),[3300]=bb('Sounds/Combo_1P/3300.wav'),[3400]=bb('Sounds/Combo_1P/3400.wav'),[3500]=bb('Sounds/Combo_1P/3500.wav'),[3600]=bb('Sounds/Combo_1P/3600.wav'),[3700]=bb('Sounds/Combo_1P/3700.wav'),[3800]=bb('Sounds/Combo_1P/3800.wav'),[3900]=bb('Sounds/Combo_1P/3900.wav'),[4000]=bb('Sounds/Combo_1P/4000.wav'),[4100]=bb('Sounds/Combo_1P/4100.wav'),[4200]=bb('Sounds/Combo_1P/4200.wav'),[4300]=bb('Sounds/Combo_1P/4300.wav'),[4400]=bb('Sounds/Combo_1P/4400.wav'),[4500]=bb('Sounds/Combo_1P/4500.wav'),[4600]=bb('Sounds/Combo_1P/4600.wav'),[4700]=bb('Sounds/Combo_1P/4700.wav'),[4800]=bb('Sounds/Combo_1P/4800.wav'),[4900]=bb('Sounds/Combo_1P/4900.wav'),[5000]=bb('Sounds/Combo_1P/5000.wav')},Notes={[1]=bb('Sounds/Taiko/dong.ogg'),[2]=bb('Sounds/Taiko/ka.ogg'),adlib=bb('Sounds/Taiko/Adlib.ogg'),balloonpop=bb('Sounds/balloon.ogg')}}}local wc={PlaySong={Lyric=hb('Nijiiro Font/Nijiiro font.otf',32,nil,0xFFFF)}}Kb.SongSelect.GenreBar=Tb(Kb.SongSelect.GenreBar)Kb.SongSelect.GenreBar=TextureMap.ReplaceWithTexture(Kb.SongSelect.GenreBar)Kb.SongSelect.GenreBar.sizex=Kb.SongSelect.GenreBar[0].width;Kb.SongSelect.GenreBar.sizey=Kb.SongSelect.GenreBar[0].height;Kb.SongSelect.GenreBar.sourcerect=rl.new('Rectangle',0,0,Kb.SongSelect.GenreBar.sizex,Kb.SongSelect.GenreBar.sizey)Kb.SongSelect.GenreBar.center=rl.new('Vector2',0,0)Kb.SongSelect.GenreBar.pr={}Kb.SongSelect.GenreBar.p={x=Jb.SongSelect_Bar_X,y=Jb.SongSelect_Bar_Y}local xc=math.floor((Jb.SongSelect_Bar_Count[1]+1)/2)for i=1,#Kb.SongSelect.GenreBar.p.x do Kb.SongSelect.GenreBar.pr[i-xc]=rl.new('Rectangle',Kb.SongSelect.GenreBar.p.x[i]*pb.ScreenWidth/Gb[1],Kb.SongSelect.GenreBar.p.y[i]*pb.ScreenHeight/Gb[2],Kb.SongSelect.GenreBar.sizex,Kb.SongSelect.GenreBar.sizey)end;Kb.SongSelect.GenreBackground=Tb(Kb.SongSelect.GenreBackground)Kb.SongSelect.GenreBackground=TextureMap.ReplaceWithTexture(Kb.SongSelect.GenreBackground)Kb.SongSelect.GenreBackground.sizex=Kb.SongSelect.GenreBackground[0].width;Kb.SongSelect.GenreBackground.sizey=Kb.SongSelect.GenreBackground[0].height;Kb.SongSelect.GenreBackground.sourcerect=rl.new('Rectangle',0,0,Kb.SongSelect.GenreBackground.sizex,Kb.SongSelect.GenreBackground.sizey)Kb.SongSelect.GenreBackground.center=rl.new('Vector2',0,0)Kb.SongSelect.GenreBackground.pr=rl.new('Rectangle',0,0,Kb.SongSelect.GenreBackground.sizex,Kb.SongSelect.GenreBackground.sizey)while not rl.WindowShouldClose()do rl.BeginDrawing()rl.ClearBackground(rl.RAYWHITE)rl.DrawText([[
WARNING: Sound is very loud, so turn it all
the way down and work your way up.

Press Enter once you have done this.]],0,w.ScreenHeight/3,D,rl.RED)rl.EndDrawing()if rl.IsKeyPressed(rl.KEY_ENTER)then break end end;function Taiko.RayGuiTemplate()while not rl.WindowShouldClose()do rl.BeginDrawing()rl.ClearBackground(rl.RAYWHITE)rl.EndDrawing()end end;function Taiko.RayGuiDifficulty()local Ec=nil;Ec=string.lower(H('Type the difficulty and press enter\n\nOptions:\nEasy\nNormal\nHard\nOni\nUra'))return Ec end;function Taiko.ParseBoxDef(Ec)local Fc={}local Gc=String.Split(Ec,'\n')for i=1,#Gc do local Jc=String.Trim(Gc[i])if string.sub(Jc,1,1)==';'then else local Kc=string.find(Jc,';')if Kc then Jc=string.sub(Jc,1,Kc-1)end;local Lc={string.match(Jc,'#(.+):(.*)')}if Lc[1]then Fc[Lc[1]]=Lc[2]end end end;Fc.TITLE=tostring(Fc.TITLE or'')Fc.GENRE=tostring(Fc.GENRE or'')Fc.FONTCOLOR={HexToRGB(Fc.FONTCOLOR or'#000000')}Fc.FORECOLOR={HexToRGB(Fc.FORECOLOR or'#000000')}Fc.BACKCOLOR={HexToRGB(Fc.BACKCOLOR or'#000000')}Fc.BOXCOLOR={HexToRGB(Fc.BOXCOLOR or'#FFFFFF')}Fc.BGCOLOR={HexToRGB(Fc.BGCOLOR or'#FFFFFF')}local Hc=255;Fc.FONTCOLOR=rl.new('Color',Fc.FONTCOLOR[1],Fc.FONTCOLOR[2],Fc.FONTCOLOR[3],Hc)Fc.FORECOLOR=rl.new('Color',Fc.FORECOLOR[1],Fc.FORECOLOR[2],Fc.FORECOLOR[3],Hc)Fc.BACKCOLOR=rl.new('Color',Fc.BACKCOLOR[1],Fc.BACKCOLOR[2],Fc.BACKCOLOR[3],Hc)Fc.BOXCOLOR=rl.new('Color',Fc.BOXCOLOR[1],Fc.BOXCOLOR[2],Fc.BOXCOLOR[3],Hc)Fc.BGCOLOR=rl.new('Color',Fc.BGCOLOR[1],Fc.BGCOLOR[2],Fc.BGCOLOR[3],Hc)Fc.BGTYPE=tonumber(Fc.BGTYPE)or 0;Fc.BOXTYPE=tonumber(Fc.BOXTYPE)or 0;Fc.BOXCHARA=tonumber(Fc.BOXCHARA)or 0;local Ic=1;Fc.BOXEXPLANATION={}for i=0,3 do local Jc='BOXEXPLANATION'..tostring(i)if Fc[Jc]then Fc.BOXEXPLANATION[i]=Fc[Jc]end end;return Fc end;function Taiko.SongSelect()local Ec={Text={},Name={},Config={},Expanded={},Path={}}local Fc,Gc=S()local Hc=T(Gc)local Ic={}local Jc=Hc;local Kc=1;local Lc=nil;local Mc=0;local Nc=40;local Oc=0;local Pc=nil;local Qc=nil;local Rc=0;local function Sc(ad,bd)local cd=ad;for i=1,#bd do cd=cd[bd[i]]end;return cd end;local function Tc(ad)local bd={}for i=1,#ad do bd[i]=ad[i]end;return bd end;local function Uc(ad)return table.concat(ad,'/')end;local function Vc(ad,bd)local cd={{},{}}for i=1,#ad do cd[1][i]=i;cd[2][i]=Compact.Search(ad[i],bd)end;table.sort(cd[1],function(dd,ed)return cd[2][dd]>cd[2][ed]end)return cd end;local function Wc(ad,bd,cd)local dd=function(hd,id)local jd={}for ld in pairs(hd)do jd[#jd+1]=ld end;if id then table.sort(jd,function(ld,md)return id(hd,ld,md)end)else table.sort(jd)end;local kd=0;return function()kd=kd+1;if jd[kd]then return jd[kd],hd[jd[kd]]end end end;local function ed(hd,id,jd)if type(hd[id])=='string'and type(hd[jd])=='string'then return hd[id]<hd[jd]elseif type(hd[id])=='string'then return false elseif type(hd[jd])=='string'then return true else return id<jd end end;local fd=0;for hd,id in dd(ad,ed)do table.insert(Ec.Text,bd+fd,hd)table.insert(Ec.Name,bd+fd,type(id)=='string'and O(id)or hd)table.insert(Ec.Path,bd+fd,cd)if type(id)=='table'then local jd=w.Paths.Songs..Uc(cd)..'/'..hd..'/box.def'if U(jd)then local kd=V(jd)local ld=Taiko.ParseBoxDef(kd)table.insert(Ec.Config,bd+fd,ld)else table.insert(Ec.Config,bd+fd,Ec.Config[bd-1]or Taiko.ParseBoxDef(''))end else table.insert(Ec.Config,bd+fd,Ec.Config[bd-1]or Taiko.ParseBoxDef(''))end;fd=fd+1 end;local gd=fd;for i=1,#cd-1 do local hd=cd[i-1]for i2=bd-1,1,-1 do if Ec.Expanded[i2]then local id=Ec.Path[i2]if id[#id]==hd and#id==i-1 then local jd=true;for i=1,#id do if id[i]~=cd[i]then jd=false;break end end;if jd then Ec.Expanded[i2]=Ec.Expanded[i2]+gd;break end end end end end;for hd,id in pairs(Ec.Expanded)do if hd>=bd then Ec.Expanded[hd+fd]=id;Ec.Expanded[hd]=nil end end;return fd end;local function Xc(ad,bd)local cd=Tc(Ec.Path[ad-1])cd[#cd+1]=Ec.Name[ad-1]for i=1,#cd-1 do local dd=cd[i-1]for i2=ad-1,1,-1 do if Ec.Expanded[i2]then local ed=Ec.Path[i2]if ed[#ed]==dd and#ed==i-1 then local fd=true;for i=1,#ed do if ed[i]~=cd[i]then fd=false;break end end;if fd then Ec.Expanded[i2]=Ec.Expanded[i2]-bd;break end end end end end;for dd,ed in pairs(Ec.Expanded)do if dd>=ad+bd then Ec.Expanded[dd-bd]=ed;Ec.Expanded[dd]=nil elseif dd>=ad then Ec.Expanded[dd]=nil end end;for i2=1,bd do table.remove(Ec.Text,ad)table.remove(Ec.Name,ad)table.remove(Ec.Path,ad)table.remove(Ec.Config,ad)end end;local function Yc(ad,bd)if Ec.Expanded[Kc]then Xc(Kc+1,Ec.Expanded[Kc])Ec.Expanded[Kc]=nil else local cd=Tc(Ic)cd[#cd+1]=ad;Ec.Expanded[Kc]=Wc(bd,Kc+1,cd)end end;local Zc=Wc(Hc,1,Tc(Ic))while true do local ad=rl.GetFrameTime()rl.BeginDrawing()rl.ClearBackground(rl.RAYWHITE)if Lc then Kb.SongSelect.GenreBackground.pr.x=Mc*dc[1]+ (Mc>=0 and-Gb[1]or Gb[1])rl.DrawTexturePro(Kb.SongSelect.GenreBackground[Lc.BGTYPE],Kb.SongSelect.GenreBackground.sourcerect,Kb.SongSelect.GenreBackground.pr,Kb.SongSelect.GenreBackground.center,0,Lc.BGCOLOR)Kb.SongSelect.GenreBackground.pr.x=Mc*dc[1]rl.DrawTexturePro(Kb.SongSelect.GenreBackground[Lc.BGTYPE],Kb.SongSelect.GenreBackground.sourcerect,Kb.SongSelect.GenreBackground.pr,Kb.SongSelect.GenreBackground.center,0,Lc.BGCOLOR)Mc=Mc+Nc* (ad)if Mc>=Gb[1]then Mc=Mc-Gb[1]end end;rl.DrawFPS(10,10)local bd=0;for ed,fd in pairs(Kb.SongSelect.GenreBar.pr)do local gd=ed+Kc;local hd=nil;if gd>#Ec.Text then hd=gd%#Ec.Text;if hd==0 then hd=#Ec.Text end elseif gd<1 then hd=#Ec.Text- (-gd%#Ec.Text)else hd=gd end;bd=bd+1;if gd==Kc then rl.DrawText('Press enter to play song',fd.x,fd.y+80 /720 *w.ScreenHeight,D,rl.BLACK)end;local id=Ec.Config[hd]rl.DrawTexturePro(Kb.SongSelect.GenreBar[id.BOXTYPE],Kb.SongSelect.GenreBar.sourcerect,fd,Kb.SongSelect.GenreBar.center,0,id.BOXCOLOR)local jd=Ec.Text[hd]local kd,ld=B(jd,D)rl.DrawText(jd,fd.x+fd.width/2 -kd/2,fd.y+fd.height/2 -ld/2,D,rl.BLACK)end;rl.EndDrawing()if rl.WindowShouldClose()then rl.CloseWindow()error()break end;if qb(w.Controls.SongSelect.L)then Kc=Kc-1 end;if qb(w.Controls.SongSelect.R)then Kc=Kc+1 end;local cd=w.Controls.SongSelect.L;if rb(cd)then if Pc~=cd then Oc=0;Pc=cd;Qc=-1 end;Oc=Oc+rl.GetFrameTime()elseif cd==Pc then Oc=0;Pc=nil end;local dd=w.Controls.SongSelect.R;if rb(dd)then if Pc~=dd then Oc=0;Pc=dd;Qc=1 end;Oc=Oc+rl.GetFrameTime()elseif dd==Pc then Oc=0;Pc=nil end;if Oc- (Rc*w.Controls.SongSelect.FastScrollInterval)>=w.Controls.SongSelect.FastScrollTime then Kc=Kc+Qc;Rc=Rc+1 else Rc=0 end;if Kc>#Ec.Text then Kc=Kc%#Ec.Text;if Kc==0 then Kc=#Ec.Text end elseif Kc<1 then Kc=#Ec.Text- (-Kc%#Ec.Text)else end;Ic=Ec.Path[Kc]rl.DrawText('Path: '..Uc(Ic),100,0,D,rl.BLACK)Lc=Ec.Config[Kc]if rl.IsKeyPressed(rl.KEY_P)then Statistics={}function Statistics.CalculateAllSet(hd)local id={Length=#hd,Sum=0,Minimum=nil,Maximum=nil,Mean=nil,Median=nil,ModeOccurence={},Mode=nil,DeviationSquaredSum=0,Variance=nil,StandardDeviation=nil,N=nil,Total=nil,Average=nil}for i=1,#hd do local jd=hd[i]id.Sum=id.Sum+jd;if(id.Minimum and jd<id.Minimum)or(not id.Minimum)then id.Minimum=jd end;if(id.Maximum and jd>id.Maximum)or(not id.Maximum)then id.Maximum=jd end;id.ModeOccurence[jd]=id.ModeOccurence[jd]and id.ModeOccurence[jd]+1 or 1 end;id.Mean=id.Sum/id.Length;for i=1,#hd do local jd=hd[i]id.DeviationSquaredSum=id.DeviationSquaredSum+ (jd-id.Mean)^2 end;id.Variance=id.DeviationSquaredSum/id.Length;id.StandardDeviation=math.sqrt(id.Variance)return id end;function Statistics.CalculateAllPoints(hd)end;function Statistics.List(hd)local id={}for jd,kd in pairs(hd)do id[#id+1]=jd;id[#id+1]=': 'id[#id+1]=tostring(kd)id[#id+1]='\n'end;return table.concat(id)end;local ed={}local fd={}local function gd(hd)for id,jd in pairs(hd)do if type(jd)=='table'then gd(jd)else local kd=os.clock()local ld,md=Taiko.ParseTJAFile(jd)local nd=os.clock()fd[#fd+1]=(nd-kd)*1000;print(fd[#fd])if ld then else ed[#ed+1]=jd;ed[#ed+1]=': 'ed[#ed+1]=md;ed[#ed+1]='\n\n'end end end end;gd(Hc)io.open('taikov34_parseerror.txt','w+'):write(table.concat(ed))print(Statistics.List(Statistics.CalculateAllSet(fd)))end;if qb(w.Controls.SongSelect.Select)then Jc=Sc(Hc,Ic)local ed=Ec.Name[Kc]local fd=Jc[ed]if type(fd)=='string'then local gd=Taiko.Parse(fd)if gd then local hd=Taiko.RayGuiDifficulty()local id=Taiko.GetDifficulty(gd,hd)Taiko.Play(id)end else Yc(ed,fd)Jc=fd end end;if qb(w.Controls.SongSelect.Search.Init)then local ed={}local fd={}local gd=nil;if rb(w.Controls.SongSelect.Search.All)then gd=Hc;Ic={}for i=1,#Ec.Path do if#Ec.Path[i]==#Ic then Kc=i;break end end else Jc=Sc(Hc,Ic)gd=Jc end;local function hd(vd,wd,xd,yd)for zd,Ad in pairs(vd)do if type(Ad)=='table'then local Bd=Tc(yd)Bd[#Bd+1]=zd;hd(Ad,wd,xd,Bd)else wd[#wd+1]=zd;xd[#xd+1]=yd end end;return wd,xd end;ed,fd=hd(gd,ed,fd,{})local id=nil;local jd=10;local kd=nil;local ld=nil;local md=1;local nd=1;local od=false;local pd='Search:\n'local qd={}local rd=''local sd='\n'local td='\n'local ud=pd;while true do rl.BeginDrawing()rl.ClearBackground(rl.RAYWHITE)rl.DrawText(ud,0,0,D,rl.BLACK)rl.EndDrawing()while true do local vd=rl.GetCharPressed()if vd==0 then break else qd[#qd+1]=vd;rd=m(qd)ud=pd..rd..td;ld=nil end end;if rl.IsKeyPressed(rl.KEY_BACKSPACE)then qd[#qd]=nil;rd=m(qd)ud=pd..rd..td;ld=nil end;if qb(w.Controls.SongSelect.Search.U)then md=md-1 end;if qb(w.Controls.SongSelect.Search.D)then md=md+1 end;if ld==nil and#qd>0 then kd=Vc(ed,rd)local vd={'\n'}ld=nil;for i=1,jd do local wd=kd[1][i]if not kd[2][wd]or kd[2][wd]==-math.huge then ld=i-1;break else vd[#vd+1]=tostring(i)vd[#vd+1]='. 'vd[#vd+1]=ed[wd]vd[#vd+1]='\n'end end;ld=ld or jd;sd=table.concat(vd)od=true end;if ld then md=ClipN(md,1,ld)end;if md~=nd or od then td=string.gsub(sd,'\n'..md,'\n>')ud=pd..rd..td;od=false end;nd=md;if qb(w.Controls.SongSelect.Search.Select)and ld and ld~=0 then break end;if qb(w.Controls.SongSelect.Search.Escape)then id=true;break end;if rl.WindowShouldClose()then rl.CloseWindow()error()end end;if not id then local vd=kd[1][md]local wd=Tc(fd[vd])local xd=ed[vd]wd[#wd+1]=xd;Jc=gd;Ic=Tc(Ic)for i=1,#wd do local yd=nil;local zd=nil;for i2=1,#Ec.Text do if Ec.Name[i2]==wd[i]and#Ic==#Ec.Path[i2]then local Ad=true;for i3=1,#Ic do if Ic[i3]~=Ec.Path[i2][i3]then Ad=false;break end end;if Ad then yd=Ec.Name[i2]zd=Jc[yd]if type(zd)=='string'then if i==#wd then Kc=i2;break end else Kc=i2;break end end end end;if i==#wd then break end;if not Ec.Expanded[Kc]then Yc(yd,zd)end;Jc=zd;Ic[#Ic+1]=yd end end end end end;local yc={startms=nil,framen=eb(Kb.PlaySong.Balloons.Anim),anim={[0]=0.125 *8,[1]=0.125 *7,[2]=0.125 *6,[3]=0.125 *5,[4]=0.125 *4,[5]=0.125 *3,[6]=0.125 *2,[7]=0.125 *1,[8]=0.125 *0},color=rl.new('Color',255,255,255,255)}local zc={startms=nil,framen=31,anim={[0]=0,[1]=0,[2]=0,[3]=0,[4]=0,[5]=0,[6]=0,[7]=0,[8]=0,[9]=0,[10]=0,[11]=0,[12]=0,[13]=0,[14]=0,[15]=0,[16]=0,[17]=0,[18]=0,[19]=0,[20]=0,[21]=0,[22]=0,[23]=0.2,[24]=0.4,[25]=0.6,[26]=0.8,[27]=1,[28]=0.8,[29]=0.6,[30]=0.4,[31]=0.2},color=rl.new('Color',255,255,255,255)}local Ac={startms=nil,framen=12,anim=Kb.PlaySong.Gauges.Meter.rainbow.Anim}local Bc={anim={[0]=1,[1]=1,[2]=1,[3]=0.75,[4]=0.5,[5]=0.25},[1]={startms=nil,color=rl.new('Color',255,255,255,255)},[2]={startms=nil,color=rl.new('Color',255,255,255,255)}}local Cc={animp={[0]=98,[1]=92,[2]=88,[3]=84,[4]=80,[5]=77,[6]=75,[7]=75,[8]=75,[9]=75,[10]=75,[11]=75,[12]=75,[13]=75,[14]=75,[15]=75,[16]=75,[17]=75,[18]=75,[19]=75,[20]=75,[21]=75,[22]=75,[23]=75,[24]=75,[25]=75},animt={[0]=1,[1]=1,[2]=1,[3]=1,[4]=1,[5]=1,[6]=1,[7]=1,[8]=1,[9]=1,[10]=1,[11]=1,[12]=1,[13]=1,[14]=1,[15]=1,[16]=1,[17]=1,[18]=1,[19]=1,[20]=1,[21]=1,[22]=0.75,[23]=0.5,[24]=0.25,[25]=0},startms={},judge={},color=rl.new('Color',255,255,255,255)}local Dc={anim={[0]=0.125 *8,[1]=0.125 *8,[2]=0.125 *8,[3]=0.125 *8,[4]=0.125 *8,[5]=0.125 *6,[6]=0.125 *4,[7]=0.125 *2,[8]=0.125 *0},[1]={[1]={startms=nil,color=rl.new('Color',255,255,255,255)},[2]={startms=nil,color=rl.new('Color',255,255,255,255)},sourcerect=rl.new('Rectangle',0,0,Kb.PlaySong.Backgrounds.Taiko.sizex/2,Kb.PlaySong.Backgrounds.Taiko.sizey),opr=rl.new('Rectangle',Kb.PlaySong.Backgrounds.Taiko.pr.x,Kb.PlaySong.Backgrounds.Taiko.pr.y,Kb.PlaySong.Backgrounds.Taiko.sizex/2,Kb.PlaySong.Backgrounds.Taiko.sizey),pr=rl.new('Rectangle',0,0,0,0),center=rl.new('Vector2',0,0)},[2]={[1]={startms=nil,color=rl.new('Color',255,255,255,255)},[2]={startms=nil,color=rl.new('Color',255,255,255,255)},sourcerect=rl.new('Rectangle',Kb.PlaySong.Backgrounds.Taiko.sizex/2,0,Kb.PlaySong.Backgrounds.Taiko.sizex/2,Kb.PlaySong.Backgrounds.Taiko.sizey),opr=rl.new('Rectangle',Kb.PlaySong.Backgrounds.Taiko.pr.x+Kb.PlaySong.Backgrounds.Taiko.sizex/2,Kb.PlaySong.Backgrounds.Taiko.pr.y,Kb.PlaySong.Backgrounds.Taiko.sizex/2,Kb.PlaySong.Backgrounds.Taiko.sizey),pr=rl.new('Rectangle',0,0,0,0),center=rl.new('Vector2',0,0)}}function Taiko.PlaySong(Ec,Fc)gc()local Gc={dc[1],dc[2]}ec(Kb,1 /dc[1],1 /dc[2])Fc=Fc or{}local Hc=Fc.oneveryframe;local Ic=Fc.oneveryhit;local Jc={}local Kc=Ec.Metadata.SONG;local Lc;local Mc=false;if Kc then if U(Ec.Metadata.SONG)then Lc=Y(Ec.Metadata.SONG)local cf=Ec.Metadata.SONGVOL*w.Settings.PlaySong.SONGVOLMultiplier;rl.SetMusicVolume(Lc,cf)else Kc=false end end;local Nc=Ec.Metadata.SEVOL*w.Settings.PlaySong.SEVOLMultiplier;for cf,df in pairs(vc.PlaySong.Combo)do rl.SetSoundVolume(df,Nc)end;for cf,df in pairs(vc.PlaySong.Notes)do rl.SetSoundVolume(df,Nc)end;local Oc=true;local Pc={[1]=1,[2]=2,[3]=1,[4]=2}local Qc=1;local Rc=1;local Sc=Ec.Metadata.STOPSONG;local Tc=true;local Uc=true;local Vc=true;local Wc=true;if Ec.Flag.PARSER_FORCE_OLD_BPMCHANGE then Uc=false end;local Xc=pb.ScreenWidth;local Yc=1 /16 *pb.ScreenWidth;local Zc=5 /16 *pb.ScreenWidth;local ad=1000;local bd=72 /2 /1280 *pb.ScreenWidth;local cd=0 *pb.ScreenWidth;local dd={414 /1280 *pb.ScreenWidth,- (257 /720 -1 /2)*pb.ScreenHeight}if Ec.Flag.PARSER_FORCE_OLD_TARGET then dd={1 /4 *pb.ScreenWidth,0}end;local ed=wb+Xc;local fd={0,-pb.ScreenHeight/2,pb.ScreenWidth,pb.ScreenHeight/2}local gd={fd[1]-Yc,fd[2]-Yc,fd[3]+Yc,fd[4]+Yc}local hd={fd[1]-Zc,fd[2]-Zc,fd[3]+Zc,fd[4]+Zc}local function id(cf)return math.floor(cf+0.5)end;local function jd(cf)return cf- (math.floor(cf/360)*360)end;local function kd(cf)return(cf.data=='note')or(cf.data=='event'and cf.event=='barline')end;local function ld(cf,df,ef,ff,gf,hf)return ef<=cf and cf<=gf and ff<=df and df<=hf end;local function md(cf,df,ef,ff,gf,hf,jf,kf)gf,hf,jf,kf=gf-cf,hf-df,jf-cf,kf-df;local lf=ff/ef;if ff<0 then local mf,nf=hf/lf,hf;if gf<=mf and mf<=jf then return mf,nf end else local mf,nf=kf/lf,kf;if gf<=mf and mf<=jf then return mf,nf end end;if ef<0 then local mf,nf=gf,gf*lf;if hf<=nf and nf<=kf then return mf,nf end else local mf,nf=jf,jf*lf;if hf<=nf and nf<=kf then return mf,nf end end;return nil end;local function nd(cf,df,ef,ff,gf,hf,jf,kf)if(gf<=cf and cf<=jf and hf<=df and df<=kf)and(gf<=ef and ef<=jf and hf<=ff and ff<=kf)then return false end;local lf=(ff-df)/ (ef-cf)local mf=df-lf*cf;if(ef-cf)==0 then if(not(gf<=cf and cf<=jf and hf<=df and df<=kf))and(not(gf<=ef and ef<=jf and hf<=ff and ff<=kf))then return true else return false end else local nf,of=lf*gf+mf,lf*jf+mf;if(cf<=gf and gf<=ef)and(hf<=nf and nf<=kf)then return false end;if(cf<=jf and jf<=ef)and(hf<=of and of<=kf)then return false end end;if(ff-df)==0 then if(not(gf<=cf and cf<=jf and hf<=df and df<=kf))and(not(gf<=ef and ef<=jf and hf<=ff and ff<=kf))then return true else return false end else local nf,of=(hf-mf)/lf,(kf-mf)/lf;if(df<=hf and hf<=ff)and(gf<=nf and nf<=jf)then return false end;if(df<=kf and kf<=ff)and(gf<=of and of<=jf)then return false end end;return true end;local function od(cf,df,ef)return ef[1]- (cf.speed[1]* (cf.ms-df-cf.delay)),ef[2]- (cf.speed[2]* (cf.ms-df-cf.delay))end;local function pd(cf,df)local ef,ff=md(dd[1],dd[2],-cf.scrollx,-cf.scrolly,gd[1],gd[2],gd[3],gd[4])return df- (ef~=0 and ef/-cf.speed[1]or ff/-cf.speed[2])end;local function qd(cf,df)local ef=-10;local ff=df;while true do cf.p[1],cf.p[2]=cf.CalculatePosition(cf,ff,dd)cf.p[1],cf.p[2]=cf.p[1]*ac,cf.p[2]*bc;cf.startnote.p[1],cf.startnote.p[2]=cf.CalculatePosition(cf.startnote,ff,dd)cf.startnote.p[1],cf.startnote.p[2]=cf.startnote.p[1]*ac,cf.startnote.p[2]*bc;if nd(cf.p[1]<cf.startnote.p[1]and cf.p[1]or cf.startnote.p[2],cf.p[2]<cf.startnote.p[2]and cf.p[2]or cf.startnote.p[2],cf.p[1]<cf.startnote.p[1]and cf.startnote.p[1]or cf.p[2],cf.p[2]<cf.startnote.p[2]and cf.startnote.p[2]or cf.p[2],gd[1],gd[2],gd[3],gd[4])then return ff else ff=ff+ef end;if df-ff>1000 then return df end end end;local rd=Taiko.GetAllNotes(Ec.Data)local sd=Ec.Metadata.OFFSET;local td=1000 /60;local ud=Taiko.Data.Timing.Level[Ec.Metadata.TIMING]local vd={}local wd=0;local xd={[1]=true,[2]=true,[3]=true,[4]=true}local yd={}local zd='M'local Ad,Bd=nil,nil;if Ec.Flag.PARSER_FORCE_OLD_SPEED_CALCULATION then Ad=Taiko.CalculateSpeed;if Ec.Flag.PARSER_FORCE_OLD_NOTERADIUS then bd=1 /40 *pb.ScreenWidth end;Bd=bd else Ad=Taiko.CalculateSpeedInterval;Bd=pb.ScreenWidth/1280 end;for cf,df in pairs(rd)do df.ms=df.oms or df.ms;df.oms=df.ms;df.ms=(df.ms-sd)/Rc;df.delay=df.odelay or df.delay;df.odelay=df.delay;df.p={}df.delay=df.delay/Rc;df.speed=Ad(df,Bd)df.CalculatePosition=df.positionf or od;df.speed[1]=df.speed[1]*Qc;df.speed[2]=df.speed[2]*Qc;if df.jposscroll then df.jposscroll.lengthms=df.jposscroll.olengthms or df.jposscroll.lengthms;df.jposscroll.olengthms=df.jposscroll.lengthms;df.jposscroll.lengthms=df.jposscroll.lengthms/Rc;vd[#vd+1]=df end;df.loadms=pd(df,df.ms-df.delay)if df.type==8 and(df.startnote.type==5 or df.startnote.type==6)then df.loadms=qd(df,df.startnote.loadms<df.loadms and df.startnote.loadms or df.loadms)local ef=df.startnote.drumrollbend;for i=1,#ef do local ff=ef[i]ff.ms=(df.ms-df.startnote.ms)/ (#ef+1)*i+df.startnote.ms;ff.speed=Ad(ff,Bd)ff.CalculatePosition=ff.positionf or od;ff.p={}end end;df.done=nil;df.hit=nil;df.timeshit=nil;df.brokecombo=false;df.setdelay=false;df.pop=false;df.addcombo=nil;df.addscore=nil;df.addgauge=nil;yd[#yd+1]=df.ms;df.senotet=df.senote and df.senote-1;if(df.currentbranch==nil or df.currentbranch==zd)and xd[df.type]then wd=wd+1 end end;if Sc or Uc then for cf,df in pairs(Ec.Data)do if df.branch then for ef,ff in pairs(df.branch.paths)do table.sort(ff,function(gf,hf)return gf.ms<hf.ms end)end end end;table.sort(Ec.Data,function(cf,df)if cf.branch and df.branch then for ef,ff in pairs(cf.branch.paths)do for gf,hf in pairs(df.branch.paths)do return ff[1].ms<hf[1].ms end end elseif cf.branch then for ef,ff in pairs(cf.branch.paths)do return ff[1].ms<df.ms end elseif df.branch then for ef,ff in pairs(df.branch.paths)do return cf.ms<ff[1].ms end else return cf.ms<df.ms end end)end;local Cd={}if Uc then local cf=Ec.Metadata.BPM;local df={ms={},bpmchangemul={},offset=0}Taiko.ForAll(Ec.Data,function(ef,ff,gf)if ef.bpmchange then ef.bpmchangemul=ef.bpmchange/cf;cf=ef.bpmchange;df.ms[#df.ms+1]=ef.ms;df.bpmchangemul[#df.bpmchangemul+1]=ef.bpmchangemul;Cd[#Cd+1]=ef end;for i=#df.ms,1,-1 do ef.ms=( (ef.ms-df.ms[i])*df.bpmchangemul[i])+df.ms[i]ef.speed[1]=ef.speed[1]/df.bpmchangemul[i]ef.speed[2]=ef.speed[2]/df.bpmchangemul[i]end;ef.bpm=Ec.Metadata.BPM;ef.loadms=pd(ef,ef.ms-ef.delay)end)end;local Dd={}if Sc then local cf=nil;local df=0;Taiko.ForAll(Ec.Data,function(ef,ff,gf)if ef.delay~=df then if cf then cf.stopms=ef.delay-cf.delay;cf.stopstart=cf.ms;cf.stopend=cf.stopstart+cf.stopms end;df=ef.delay end;if cf and cf.stopstart then Dd[#Dd+1]=cf end;cf=ef end)end;if Wc then Taiko.ForAll(Ec.Data,function(cf,df,ef)if cf.appearancems then cf.appearancemsa=cf.ms+cf.appearancems;if cf.appearancemsa<cf.loadms then cf.loadms=cf.appearancemsa end end;if cf.movems then cf.movemsa=cf.ms+cf.movems end end)end;for cf,df in pairs(Ec.Data)do if df.branch then for ef,ff in pairs(df.branch.paths)do table.sort(ff,function(gf,hf)return gf.loadms<hf.loadms end)end end end;table.sort(Ec.Data,function(cf,df)if cf.branch and df.branch then for ef,ff in pairs(cf.branch.paths)do for gf,hf in pairs(df.branch.paths)do return ff[1].loadms<hf[1].loadms end end elseif cf.branch then for ef,ff in pairs(cf.branch.paths)do return ff[1].loadms<df.loadms end elseif df.branch then for ef,ff in pairs(df.branch.paths)do return cf.loadms<ff[1].loadms end else return cf.loadms<df.loadms end end)Taiko.ConnectAll(Ec.Data)Taiko.ForAll(Ec.Data,function(cf,df,ef)cf.n=ef end)local Ed=yd[1]for i=1,#yd do if yd[i]>Ed then Ed=yd[i]end end;Ed=Ed+ad/Rc;local Fd={}local Gd={barline={},drumroll={},notes={}}local Hd={}local Id={}local Jd=Ec.Data[1]local Kd='M'local Ld=0;local Md,Nd,Od=Ec.Metadata.SCOREINIT,Ec.Metadata.SCOREDIFF,Taiko.Data.ScoreMode.Note[Ec.Metadata.SCOREMODE]local Pd=0;local Qd=false;local Rd=0;local Sd=0;local Td=false;local Ud=false;local Vd=Taiko.Data.Gauge.Soul[Ec.Metadata.COURSE](wd)local Wd=Taiko.Data.Gauge.Percent;local Xd=nil;local Yd=nil;local Zd=nil;local ae=Taiko.Data.ScoreMode.Balloon[Ec.Metadata.SCOREMODE]local be=Taiko.Data.ScoreMode.BalloonPop[Ec.Metadata.SCOREMODE]local ce=nil;local de=nil;local ee=nil;local fe={}local ge=Taiko.Data.ScoreMode.Drumroll[Ec.Metadata.SCOREMODE]local he={startms=nil,status=nil}local ie=nil;local je=nil;local ke=nil;local le=0;local me=nil;local ne=nil;local oe={nil,nil}local pe={nil,nil}local qe={}local re={}local se=nil;for i=1,#Ec.Lyric do local cf=Ec.Lyric[i]cf.x=0;cf.y=600;cf.p=rl.new('Vector2',cf.x,cf.y)cf.spacing=5;cf.size=45;cf.textrect=rl.new('Rectangle',0 + ( (w.ScreenWidth-1280 /720 *w.ScreenHeight)/2 +100 *dc[1]),0,w.ScreenWidth-2 * ( (w.ScreenWidth-1280 /720 *w.ScreenHeight)/2 +100 *dc[1]),0)cf.p2=rl.new('Vector2',0,0)cf.odata=cf.odata or cf.data;cf.data=cf.odata;if cf.data then if w.Settings.PlaySong.LyricRomajiToHiragana then cf.data=Romaji.ToHiragana(cf.data)end;cf.data=n(cf.data)for i=1,#cf.data do re[cf.data[i]]=true end;cf.datac=rl.new('int[?]',#cf.data,cf.data)else cf.data=nil;cf.datac=nil end;qe[#qe+1]=cf end;local te={}for cf,df in pairs(re)do te[#te+1]=cf end;local ue=wc.PlaySong.Lyric(te,re)for i=1,#Ec.Lyric do Ec.Lyric[i].font=ue end;local ve=false;local we;local xe='test.trp'local ye=false;local ze;local Ae='test.trp'local Be;local Ce;local De;local Ee;if ve then we={[1]={[false]={},[true]={}},[2]={[false]={},[true]={}}}end;if ye then ze,Be=Replay.Load(Replay.Read(Ae))local function cf(df,ef)if df then else error(ef..' does not match')end end;cf(Replay.Version==Be.version,'Version')cf(Ec.Metadata.TITLE==Be.title,'Title')Ce={}for df,ef in pairs(ze)do Ce[#Ce+1]=df end;table.sort(Ce)Ee=1;De=Ce[Ee]end;local Fe={data={DrawTexturePro=rl.DrawTexturePro},offset={x=0,y=0}}local Ge={on=true,changingscroll=true,currentdragging={},currentdragginglinethickness=5,currentdragginglinecolor=rl.new('Color',13,150,241,255 /2),currentdraggingr=rl.new('Rectangle'),info={hovernote=nil,backgroundcolor=rl.new('Color',128,128,128,128),textsize=20,backgroundpadding=10,offset=rl.new('Vector2',50,50)},clipboard={},overlay={on=true,editortextp=rl.new('Vector2',10,10),editortextsize=25},boxselection=false,boxselectionpr=rl.new('Rectangle'),boxselectionpr2=rl.new('Rectangle'),grid={on=true,isrect=true,pr=rl.new('Rectangle',0,0,Ub,Vb),v=rl.new('Vector2'),v2=rl.new('Vector2'),scrollincrement=0.1,msincrement=100,selected=nil,smallest=10},movingnotes=true,moving={tempf=function()end,data=Fe.data,offset={tempf={DrawTexturePro=function(cf,df,ef,ff,gf,hf)local jf=rl.new('Rectangle',ef.x+Fe.offset.x,ef.y+Fe.offset.y,ef.width,ef.height)Fe.data.DrawTexturePro(cf,df,jf,ff,gf,hf)end},data=Fe.data}}}local He=1;local Ie=He;local Je=false;local Ke=nil;Taiko.ForAll(Ec.Data,function(cf,df,ef)local ff=jd(math.deg(math.atan2(-cf.scrollx,-cf.scrolly))-90)if ff<90 or ff>=270 then cf.rotationr=ff else cf.rotationr=180 +ff end;if cf.type==3 or cf.type==4 or cf.type==6 then cf.radiusr=cf.radius/Ab else cf.radiusr=cf.radius or 1 end;if cf.data=='event'and cf.event=='barline'then cf.type='bar'cf.pr=rl.new('Rectangle',0,0,jc,kc)cf.tcentero=rl.new('Vector2',mc.x*cf.radiusr,mc.y*cf.radiusr)else cf.pr=rl.new('Rectangle',0,0,Ub,Vb)cf.tcentero=rl.new('Vector2',Xb.x*cf.radiusr,Xb.y*cf.radiusr)end;cf.tcenter=rl.new('Vector2',0,0)cf.pr.width=cf.pr.width*cf.radiusr;cf.pr.height=cf.pr.height*cf.radiusr;if cf.senote then cf.osenotepr=rl.new('Rectangle',0,0,Kb.PlaySong.SENotes.sizex,Kb.PlaySong.SENotes.sizey)cf.senotepr=rl.new('Rectangle',0,0,0,0)end;if cf.startnote then local gf=cf.startnote;if gf.type==5 or gf.type==6 then cf.rotationr=ff;if gf.type==5 then gf.notetype='drumrollnote'gf.recttype='drumrollrect'gf.endtype='drumrollend'elseif gf.type==6 then gf.notetype='DRUMROLLnote'gf.recttype='DRUMROLLrect'gf.endtype='DRUMROLLend'end;for i=1,#gf.drumrollbend do local hf=gf.drumrollbend[i]hf.pr=rl.new('Rectangle',0,0,Ub,Vb)hf.notetype='drumrollbend'end;fe[#fe+1]=gf elseif gf.type==7 then end end end)local Le=0;local Me=nil;local Ne=nil;local Oe=false;local Pe,Qe={},{}local Re=false;local Se={notes={},startms={},currenttarget={[1]={},[2]={}},anim={},animcache={}}local Te={type=1,pr=rl.new('Rectangle',0,0,0,0),tcentero=rl.new('Vector2',Ub/2,Vb/2),tcenter=rl.new('Vector2',0,0),rotationr=0}local Ue;do local cf={{},{},{},{}}local df=25 * (Hb/60)Ue=function(ef,ff)local gf,hf=ef*ac+yb,ff*bc+zb;local function jf(pf,qf,rf)local sf=1 -pf;for tf,uf in pairs(qf)do rf[tf][1]=uf[1]rf[tf][2]=uf[2]end;for i=2,#rf do for k=1,#rf-i+1 do rf[k][1]=rf[k][1]*sf+rf[k+1][1]*pf;rf[k][2]=rf[k][2]*sf+rf[k+1][2]*pf end end;return rf[1][1],rf[1][2]end;local function kf(pf)return math.sin(math.pi/2 *pf)end;local lf=0;local mf={x1=gf+ (14 /1280 * (pb.ScreenWidth)),y1=hf- (29 /720 * (pb.ScreenHeight)),x2=(pb.ScreenWidth)- (55 /1280 * (pb.ScreenWidth)),y2=lf+ (165 /720 * (pb.ScreenHeight))}mf.w=mf.x2 -mf.x1;mf.h=(63 /720 * (pb.ScreenHeight))local nf={{mf.x1,mf.y1},{mf.x1 +mf.w/6,mf.y1 -mf.h*3.5},{mf.x2 -mf.w/3,mf.y2 -mf.h*5},{mf.x2,mf.y2}}Se.animcache[ef]=Se.animcache[ef]or{}Se.animcache[ef][ff]={}local of=Se.animcache[ef][ff]of[1]={false}of[2]={false}for i=1,df do local pf=(i-1)/ (df-1)local qf,rf=jf(kf(pf),nf,cf)of[1][i]=qf;of[2][i]=rf end end end;Ue(dd[1],dd[2])local function Ve(cf,df)if Ic then Ic(Ne,cf,df,Qe)end;rl.PlaySound(vc.PlaySong.Notes[cf])local ef=Dc[df==false and 1 or df==true and 2]ef[cf].startms=Ne;ef[cf].color.a=255;Bc[cf].startms=Ne;Bc[cf].color.a=255;if ve then we[cf][df][#we[cf][df]+1]=Ne end;if Qe[cf]and(not Qe[cf].hit)then local ff=Qe[cf]local gf=ff.type;local hf=Pe[cf]local jf;local kf;local lf=( (gf==3 or gf==4)and Taiko.Data.BigLeniency)or 1;local mf=nil;local nf=(gf==3 or gf==4)local of=Pd;if hf< (ud.good)then jf=(nf and 3)or 2;Pd=Pd+1;mf=(nf and 4)or 2;kf=2 elseif hf< (ud.ok*lf)then jf=(nf and 2)or 1;Pd=Pd+1;mf=(nf and 3)or 1;kf=1 elseif hf< (ud.bad*lf)then jf=0;Pd=0;mf=0;kf=0 else jf=nil end;ff.addcombo=Pd-of;if jf then local pf=Ld;Ld=Od(Ld,Pd,Md,Nd,jf,ff.gogo)ff.addscore=Ld-pf;local qf=Rd;Rd=Rd+Vd[kf]ff.addgauge=Rd-qf;Sd=Wd(Rd)Td=Sd>=Taiko.Data.Gauge.ClearPercent;local rf=Ud;Ud=Sd>=Taiko.Data.Gauge.OverflowPercent;if Ud and(not rf)then Ac.startms=Ne end;Qe[cf].hit=true;he.startms=Ne;he.status=mf;he.statusanim=mf~=0 and Kb.PlaySong.Effects.Note.Hit[mf].Anim;he.explosionanim=mf~=0 and Kb.PlaySong.Effects.Note.Explosion[mf].Anim;he.explosionbiganim=(nf and Kb.PlaySong.Effects.Note.ExplosionBig.Anim)or nil;local sf=#Se.notes+1;Se.notes[sf]=Qe[cf]Se.startms[sf]=Ne;local tf,uf=dd[1],dd[2]Se.currenttarget[1][sf]=tf;Se.currenttarget[2][sf]=uf;if Se.animcache[tf]and Se.animcache[tf][uf]then else Ue(tf,uf)end;Se.anim[sf]=Se.animcache[tf][uf]Cc.startms[#Cc.startms+1]=Ne;Cc.judge[#Cc.judge+1]=kf;if vc.PlaySong.Combo[Pd]then rl.PlaySound(vc.PlaySong.Combo[Pd])end end end;if(cf==1)and Yd and(Ne>Yd and Ne<Zd)and(not Xd.pop)then Xd.timeshit=Xd.timeshit and Xd.timeshit+1 or 1;local ff=Ld;Ld=ae(Ld,Xd.type,Xd.gogo)Xd.addscore=(Xd.addscore or 0)+Ld-ff;if Xd.timeshit>=Xd.requiredhits then Xd.pop=true;yc.startms=Ne;yc.color.a=255;rl.PlaySound(vc.PlaySong.Notes.balloonpop)end end;if(cf==1 or cf==2)and de and(Ne>de and Ne<ee)then ce.timeshit=ce.timeshit and ce.timeshit+1 or 1;local ff=Ld;Ld=ge(Ld,ce.type,ce.gogo)ce.addscore=(ce.addscore or 0)+Ld-ff;local gf=#Se.notes+1;Se.notes[gf]=Te;Se.startms[gf]=Ne;local hf,jf=dd[1],dd[2]Se.currenttarget[1][gf]=hf;Se.currenttarget[2][gf]=jf;if Se.animcache[hf]and Se.animcache[hf][jf]then else Ue(hf,jf)end;Se.anim[gf]=Se.animcache[hf][jf]end end;local function We(cf)local df=Pc[cf.type]Pe[df]=0;Qe[df]=cf;Ve(df,Re)Re=not Re end;local function Xe(cf)Ve(cf,Re)Re=not Re end;local function Ye(cf,df)return cf.ms>df.ms end;ec(Kb,Gc[1],Gc[2])local Ze=table.concat({'Title: ',Ec.Metadata.TITLE,'\nSubtitle: ',Ec.Metadata.SUBTITLE,'\nDifficulty: ',Taiko.Data.CourseName[Ec.Metadata.COURSE],'\nStars: ',tostring(Ec.Metadata.LEVEL),'\n\nAuto: ',tostring(Oc),'\nRecording: ',tostring(ve),'\nReplaying: ',tostring(ye)})if w.Settings.PlaySong.WaitForStart then while not rl.WindowShouldClose()do rl.BeginDrawing()rl.ClearBackground(rl.RAYWHITE)rl.DrawText('Press SPACE to start',w.ScreenWidth/2,w.ScreenHeight/2,D,rl.BLACK)rl.EndDrawing()if rl.IsKeyPressed(32)then break end end end;if Kc then rl.SetMusicPitch(Lc,Rc)rl.PlayMusicStream(Lc)if w.Offsets.Music<0 then rl.SeekMusicStream(Lc,-w.Offsets.Music)end end;local af=0;local bf=os.clock()while true do rl.BeginDrawing()rl.ClearBackground(rl.RAYWHITE)if Ge.on and(not Ge.movingnotes)then for uf,vf in pairs(Ge.moving.data)do rl[uf]=Ge.moving.tempf end end;rl.DrawTexturePro(Kb.PlaySong.Backgrounds.Background.InfoBar[0],Kb.PlaySong.Backgrounds.Background.InfoBar.sourcerect,Kb.PlaySong.Backgrounds.Background.InfoBar.pr,Kb.PlaySong.Backgrounds.Background.InfoBar.center,0,rl.WHITE)rl.DrawTexturePro(Kb.PlaySong.Backgrounds.Background.CourseSymbol[Ec.Metadata.COURSE],Kb.PlaySong.Backgrounds.Background.CourseSymbol.sourcerect,Kb.PlaySong.Backgrounds.Background.CourseSymbol.pr,Kb.PlaySong.Backgrounds.Background.CourseSymbol.center,0,rl.WHITE)rl.DrawTexturePro(Kb.PlaySong.Nameplates.base,Kb.PlaySong.Nameplates.sourcerect,Kb.PlaySong.Nameplates.pr,Kb.PlaySong.Nameplates.center,0,rl.WHITE)rl.DrawTexturePro(Kb.PlaySong.Nameplates.edge,Kb.PlaySong.Nameplates.sourcerect,Kb.PlaySong.Nameplates.pr,Kb.PlaySong.Nameplates.center,0,rl.WHITE)rl.DrawTexturePro(Kb.PlaySong.Nameplates.top,Kb.PlaySong.Nameplates.sourcerect,Kb.PlaySong.Nameplates.pr,Kb.PlaySong.Nameplates.center,0,rl.WHITE)rl.DrawTexturePro(Kb.PlaySong.Nameplates.rankbase,Kb.PlaySong.Nameplates.sourcerect,Kb.PlaySong.Nameplates.pr,Kb.PlaySong.Nameplates.center,0,rl.WHITE)rl.DrawTexturePro(Kb.PlaySong.Nameplates.rank[3],Kb.PlaySong.Nameplates.sourcerect,Kb.PlaySong.Nameplates.pr,Kb.PlaySong.Nameplates.center,0,rl.WHITE)rl.DrawTexturePro(Kb.PlaySong.Nameplates[1],Kb.PlaySong.Nameplates.sourcerect,Kb.PlaySong.Nameplates.pr,Kb.PlaySong.Nameplates.center,0,rl.WHITE)rl.DrawFPS(10,10)rl.DrawText(Ze,10,40,Eb,rl.BLACK)local cf=rl.GetTime()local df=nil;if Me then df=(cf-Me)/ (1 /60)else df=1 end;if Oe then Oe=false else Le=Le+ ( (af~=0 and(cf-Me)or 0)*He)end;Me=cf;Ne=Le*1000;af=af+1;if Kc then if He~=Ie then rl.SetMusicPitch(Lc,Rc*He)Ie=He end;local uf=Le-w.Offsets.Music;if uf>=0 then local vf=uf- (rl.GetMusicTimePlayed(Lc)/Rc)if Mc or vf>Fb or vf<-Fb then print('RESYNC',vf)rl.SeekMusicStream(Lc,uf*Rc)Mc=false end;rl.UpdateMusicStream(Lc)end end;if ye and De and Ne>=De then local uf=ze[De]for i=1,#uf do local vf=Replay.Notes[uf[i]]Ve(vf[1],vf[2])end;Ee=Ee+1;De=Ce[Ee]end;if ke and Ne>ke then ie,je,ke=nil,nil,nil end;if Zd and Ne>Zd then Xd,Yd,Zd=nil,nil,nil end;if ee and Ne>ee then ce,de,ee=nil,nil,nil end;if Sc then for i=1,#Dd do local uf=Dd[i]if Ne>=uf.stopstart then ie=le+uf.stopstart;stopms=uf.stopms;le=le-uf.stopms;je=uf.stopstart;ke=uf.stopend;uf.queue=Dd;uf.done=Le;Id[#Id+1]=uf;table.remove(Dd,i)break end end end;if Tc then for i=1,#vd do local uf=vd[i]if Ne>=uf.ms then if me then local vf=uf.ms-me;dd[1]=pe[1]+ (oe[1]*vf)dd[2]=pe[2]+ (oe[2]*vf)end;me=uf.ms;ne=uf.ms+uf.jposscroll.lengthms;if uf.jposscroll.p=='default'then oe[1]=(Cb[1]-dd[1])/uf.jposscroll.lengthms;oe[2]=(Cb[2]-dd[2])/uf.jposscroll.lengthms else oe[1]=( (uf.jposscroll.p and uf.jposscroll.p[1])and uf.jposscroll.p[1]or(uf.jposscroll.lanep and uf.jposscroll.lanep[1])and(uf.jposscroll.lanep[1]*Xc)or 0)/uf.jposscroll.lengthms;oe[2]=( (uf.jposscroll.p and uf.jposscroll.p[2])and uf.jposscroll.p[2]or(uf.jposscroll.lanep and uf.jposscroll.lanep[2])and(uf.jposscroll.lanep[2]*Xc)or 0)/uf.jposscroll.lengthms end;pe[1]=dd[1]pe[2]=dd[2]uf.queue=vd;uf.done=Le;Id[#Id+1]=uf;table.remove(vd,i)break end end;if ne and Ne>ne then local uf=ne-me;dd[1]=pe[1]+ (oe[1]*uf)dd[2]=pe[2]+ (oe[2]*uf)me,ne=nil,nil end end;if Uc then for i=1,#Cd do local uf=Cd[i]if Ne>=uf.ms then local vf=uf.ms;local wf=uf.bpmchangemul;Taiko.ForAll(Ec.Data,function(xf,yf,zf)xf.ms=vf+ (xf.ms-vf)/wf;xf.speed[1]=xf.speed[1]*wf;xf.speed[2]=xf.speed[2]*wf;xf.loadms=pd(xf,xf.ms-xf.delay)end)uf.queue=Cd;uf.done=Le;Id[#Id+1]=uf;table.remove(Cd,i)break end end end;if Vc then for i=1,#qe do local uf=qe[i]if Ne>=uf.ms then se=uf;if not uf.data then se=nil end;uf.queue=qe;uf.done=Le;Id[#Id+1]=uf;table.remove(qe,i)break end end;if se and(se.lengthms and Ne>= (se.ms+se.lengthms))then se=nil end end;for i=1,#fe do local uf=fe[i]if Ne>=uf.ms then ce=uf;de=uf.ms;ee=uf.ms+uf.lengthms;uf.queue=fe;uf.done=Le;Id[#Id+1]=uf;table.remove(fe,i)break end end;if Jd then while true do if Jd and(Jd.loadms<Ne+le)then Fd[#Fd+1]=Jd;if Jd.endnote then Fd[#Fd+1]=Jd.endnote end;Jd=Jd.nextnote;if Jd then if Jd.startnote then Jd=Jd.nextnote end;if Jd and Jd.branch then Jd=Jd.branch.paths[Kd][1]end end else break end end else if Ne>Ed then break end end;rl.DrawTexturePro(Kb.PlaySong.Backgrounds.Frame[1],Kb.PlaySong.Backgrounds.Frame.sourcerect,Kb.PlaySong.Backgrounds.Frame.pr,Kb.PlaySong.Backgrounds.Frame.center,0,rl.WHITE)rl.DrawTexturePro(Kb.PlaySong.Gauges.Meter.base,Kb.PlaySong.Gauges.Meter.sourcerect,Kb.PlaySong.Gauges.Meter.pr,Kb.PlaySong.Gauges.Meter.center,0,rl.WHITE)local ef=math.floor(50 *Sd)ef=ClipN(ef,0,50)local ff=14 *ef-1;if ff>0 then Kb.PlaySong.Gauges.Meter.sourcerect2.width=ff/1280 * (w.ScreenWidth/dc[1])Kb.PlaySong.Gauges.Meter.pr2.width=ff/1280 *w.ScreenWidth;rl.DrawTexturePro(Kb.PlaySong.Gauges.Meter.full,Kb.PlaySong.Gauges.Meter.sourcerect2,Kb.PlaySong.Gauges.Meter.pr2,Kb.PlaySong.Gauges.Meter.center,0,rl.WHITE)end;if Ud then local uf=Ne-Ac.startms;local vf=math.floor(uf/Ib)% (Ac.framen-1)local wf=Ac.anim[vf]rl.DrawTexturePro(wf,Kb.PlaySong.Gauges.Meter.rainbow.sourcerect,Kb.PlaySong.Gauges.Meter.rainbow.pr,Kb.PlaySong.Gauges.Meter.rainbow.center,0,rl.WHITE)elseif Td then zc.startms=zc.startms or Ne;local uf=Ne-zc.startms;local vf=math.floor(uf/Ib)local wf=zc.anim[vf]if wf then zc.color.a=255 *wf else zc.startms=zc.startms+zc.framen* (1000 /Hb)end;local xf=39;local yf=14 *xf-1;Kb.PlaySong.Gauges.Meter.sourcerect2.width=yf/1280 * (w.ScreenWidth/dc[1])Kb.PlaySong.Gauges.Meter.pr2.width=yf/1280 *w.ScreenWidth;rl.DrawTexturePro(Kb.PlaySong.Gauges.Meter.clear,Kb.PlaySong.Gauges.Meter.sourcerect2,Kb.PlaySong.Gauges.Meter.pr2,Kb.PlaySong.Gauges.Meter.center,0,zc.color)end;rl.DrawTexturePro(Kb.PlaySong.Gauges.Clear[Td],Kb.PlaySong.Gauges.Clear.sourcerect,Kb.PlaySong.Gauges.Clear.pr,Kb.PlaySong.Gauges.Clear.center,0,rl.WHITE)rl.DrawTexturePro(Kb.PlaySong.Lanes.Lane.default,Kb.PlaySong.Lanes.sourcerect,Kb.PlaySong.Lanes.pr,Kb.PlaySong.Lanes.center,0,rl.WHITE)rl.DrawTexturePro(Kb.PlaySong.Lanes.Lane.sub,Kb.PlaySong.Lanes.ssourcerect,Kb.PlaySong.Lanes.spr,Kb.PlaySong.Lanes.scenter,0,rl.WHITE)rl.DrawTexturePro(Kb.PlaySong.Backgrounds.Taiko.base,Kb.PlaySong.Backgrounds.Taiko.sourcerect,Kb.PlaySong.Backgrounds.Taiko.pr,Kb.PlaySong.Backgrounds.Taiko.center,0,rl.WHITE)for i=1,2 do local uf=Dc[i]for i2=1,2 do local vf=uf[i2]if vf.startms then local wf=Ne-vf.startms;local xf=math.floor(wf/Ib)local yf=Dc.anim[xf]if yf then vf.color.a=255 *yf;if yf>0 then uf.pr.x=uf.opr.x*dc[1]uf.pr.y=uf.opr.y*dc[2]uf.pr.width=uf.opr.width*dc[1]uf.pr.height=uf.opr.height*dc[2]rl.DrawTexturePro(Kb.PlaySong.Backgrounds.Taiko[i2],uf.sourcerect,uf.pr,uf.center,0,rl.WHITE)end else Dc.startms=nil end end end end;for i=1,2 do local uf=Bc[i]if uf.startms then local vf=Ne-uf.startms;local wf=math.floor(vf/Ib)local xf=Bc.anim[wf]if xf then uf.color.a=255 *xf;if xf>0 then rl.DrawTexturePro(Kb.PlaySong.Lanes.Lane[i],Kb.PlaySong.Lanes.sourcerect,Kb.PlaySong.Lanes.pr,Kb.PlaySong.Lanes.center,0,rl.WHITE)end else uf.startms=nil end end end;rl.DrawTexturePro(Kb.PlaySong.Backgrounds.ComboText[0],Kb.PlaySong.Backgrounds.ComboText.sourcerect,Kb.PlaySong.Backgrounds.ComboText.pr,Kb.PlaySong.Backgrounds.ComboText.center,0,rl.WHITE)if Pd>=10 then local uf,vf=40 /1280 * (w.ScreenWidth/dc[1]),48 /720 * (w.ScreenHeight/dc[2])local wf,xf=uf*dc[1],vf*dc[2]local yf=tostring(Pd)local zf=Pd<50 and 0 or Pd<100 and 1 or 2;local Af=jb(yf,uf,vf,wf,xf,dc)kb(Kb.PlaySong.Fonts.Combo[zf],yf,250 /1280 *w.ScreenWidth- (Af/2),220 /720 *w.ScreenHeight,uf,vf,wf,xf,dc)end;local gf,hf=26 /1280 * (w.ScreenWidth/dc[1]),34 /720 * (w.ScreenHeight/dc[2])local jf,kf=gf*dc[1],hf*dc[2]local lf=tostring(Ld)local mf=jb(lf,gf,hf,jf,kf,dc)kb(Kb.PlaySong.Fonts.Score[0],lf,160 /1280 *w.ScreenWidth-mf,194 /720 *w.ScreenHeight,gf,hf,jf,kf,dc)if se then se.p2.x=se.p.x*dc[1]se.p2.y=se.p.y*dc[2]rl.DrawTextCodepoints(se.font,se.datac,#se.data,se.p2,se.size*dc[2],se.spacing,rl.BLACK)end;local nf=0;for i=1,#Se.notes do local uf=i+nf;local vf=Se.notes[uf]local wf=Se.startms[uf]local xf=Ne-wf;local yf=math.floor(xf/Ib)local zf=Se.currenttarget;local Af=Se.anim[uf]if Af[1][yf]~=nil then if Af[1][yf]then vf.pr.width=Ub*dc[1]vf.pr.height=Vb*dc[2]vf.tcenter.x=vf.tcentero.x*dc[1]vf.tcenter.y=vf.tcentero.y*dc[2]vf.pr.x=Af[1][yf]*dc[1]vf.pr.y=Af[2][yf]*dc[2]rl.DrawTexturePro(Kb.PlaySong.Notes[vf.type],Wb,vf.pr,vf.tcenter,vf.rotationr,rl.WHITE)else end else table.remove(Se.notes,uf)table.remove(Se.startms,uf)table.remove(Se.currenttarget[1],uf)table.remove(Se.currenttarget[2],uf)table.remove(Se.anim,uf)nf=nf-1 end end;if Ge.on and(not Ge.movingnotes)then for uf,vf in pairs(Ge.moving.data)do rl[uf]=vf end end;if Ge.on and(not Ge.movingnotes)then for uf,vf in pairs(Ge.moving.offset.tempf)do rl[uf]=vf end end;if me and Ne>=me then dd[1]=pe[1]+ (oe[1]* (Ne-me))dd[2]=pe[2]+ (oe[2]* (Ne-me))end;local of=dd[1]-Cb[1]local pf=dd[2]-Cb[2]Db[1]=hd[1]+of;Db[2]=hd[2]+pf;Db[3]=hd[3]+of;Db[4]=hd[4]+pf;cc.x=(dd[1]*ac+yb)*dc[1]cc.y=(dd[2]*bc+zb)*dc[2]cc.width=Ub*dc[1]cc.height=Vb*dc[2]rl.DrawTexturePro(Kb.PlaySong.Notes.target,Wb,cc,Xb,0,rl.WHITE)Pe={}Qe={}Gd={barline={},drumroll={},balloon={},notes={}}local qf=Ne-w.Offsets.Timing;local rf=0;for i=1,#Fd do local uf=i+rf;local vf=Fd[uf]if vf then if not(vf.hit)and vf.data=='note'then local yf=math.abs(qf-vf.ms)if(vf.type==1 or vf.type==3)and(not Pe[1]or yf<Pe[1])then Pe[1]=yf;Qe[1]=vf elseif(vf.type==2 or vf.type==4)and(not Pe[2]or yf<Pe[2])then Pe[2]=yf;Qe[2]=vf end end;local wf,xf=vf.CalculatePosition(vf,ie or( (vf.movemsa and(Ne>=vf.movemsa and Ne or vf.movemsa)or Ne)+le),dd)vf.p[1]=wf*ac;vf.p[2]=xf*bc;if Ne>vf.ms then Qd=vf.gogo;if vf.type==7 then if Xd then vf.hit=false;if Xd.n==vf.n then vf.p[1]=dd[1]*ac;vf.p[2]=dd[2]*bc;if not Xd.setdelay then Xd.delay=Xd.delay-Xd.lengthms;Xd.setdelay=true end else end end;Xd=vf;Yd=vf.ms;Zd=vf.ms+vf.lengthms end end;vf.pr.x=(vf.p[1]+yb)*dc[1]vf.pr.y=(vf.p[2]+zb)*dc[2]if Oc then if not vf.hit and Pc[vf.type]and qf>=vf.ms then We(vf)end end;if(vf.hit and not(Sc and vf.stopstart and not(Ne>vf.stopstart)))or(Ne>vf.ms and ld(vf.p[1],vf.p[2],Db[1],Db[2],Db[3],Db[4])==false)and( (not vf.endnote)or(vf.endnote.done))and( (not vf.startnote)or(nd(vf.p[1]<vf.startnote.p[1]and vf.p[1]or vf.startnote.p[2],vf.p[2]<vf.startnote.p[2]and vf.p[2]or vf.startnote.p[2],vf.p[1]<vf.startnote.p[1]and vf.startnote.p[1]or vf.p[2],vf.p[2]<vf.startnote.p[2]and vf.startnote.p[2]or vf.p[2],Db[1],Db[2],Db[3],Db[4])))then vf.done=Le;table.remove(Fd,uf)Id[#Id+1]=vf;rf=rf-1 else if vf.data=='event'then if vf.event=='barline'then Gd.barline[#Gd.barline+1]=vf end else if vf.type==8 then Gd.drumroll[#Gd.drumroll+1]=vf elseif vf.type==7 then Gd.balloon[#Gd.balloon+1]=vf else Gd.notes[#Gd.notes+1]=vf end end end end end;if Oc then local uf=Pe[1]local vf=Pe[2]local wf=(uf and vf)and( (uf<vf)and 1 or 2)or(uf and 1 or 2)local xf=Pe[wf]local yf=Qe[wf]if not xf or(xf and xf> (ud.bad* ( ( (yf.type==3 or yf.type==4)and Taiko.Data.BigLeniency)or 1)))then if Yd and(Ne>Yd and Ne<Zd)and not Xd.pop then Xe(1)elseif de and(Ne>de and Ne<ee)then Xe(1)end end end;if Ge.on then for uf,vf in pairs(w.Controls.PlaySong.Hit)do if not(w.Controls.PlaySong.Editor.Shortcut.New[uf])and rl.IsKeyPressed(uf)then Ve(vf[1],vf[2])end end else for uf,vf in pairs(w.Controls.PlaySong.Hit)do if rl.IsKeyPressed(uf)then Ve(vf[1],vf[2])end end end;Hd=Gd.barline;table.sort(Gd.drumroll,Ye)table.sort(Gd.notes,Ye)table.sort(Gd.balloon,Ye)for i=1,#Gd.drumroll do Hd[#Hd+1]=Gd.drumroll[i]end;for i=1,#Gd.notes do Hd[#Hd+1]=Gd.notes[i]end;for i=1,#Gd.balloon do Hd[#Hd+1]=Gd.balloon[i]end;cc.width=cc.width*2;cc.height=cc.height*2;if he.statusanim then local uf=Ne-he.startms;local vf=math.floor(uf/Ib)local wf=he.statusanim[vf]if wf then rl.DrawTexturePro(wf,Kb.PlaySong.Effects.Note.sourcerect,cc,Kb.PlaySong.Effects.Note.center,0,pc)else he.statusanim=nil end end;for i=1,#Hd do local uf=Hd[i]if uf then if not uf.hit then local vf=( (uf.type==3 or uf.type==4)and Taiko.Data.BigLeniency)or 1;if(not uf.brokecombo)and(uf.type==1 or uf.type==2 or uf.type==3 or uf.type==4)and Ne-uf.ms> (ud.bad*vf)then Pd=0;uf.brokecombo=true end;if not(uf.appearancemsa and(Ne<uf.appearancemsa))then if uf.data=='event'then if uf.event=='barline'then uf.pr.width=jc*dc[1]uf.pr.height=kc*dc[2]uf.tcenter.x=uf.tcentero.x*dc[1]uf.tcenter.y=uf.tcentero.y*dc[2]rl.DrawTexturePro(Kb.PlaySong.Barlines[uf.type],lc,uf.pr,uf.tcenter,uf.rotationr,rl.WHITE)end elseif uf.data=='note'then uf.pr.width=Ub*dc[1]uf.pr.height=Vb*dc[2]uf.tcenter.x=uf.tcentero.x*dc[1]uf.tcenter.y=uf.tcentero.y*dc[2]if uf.senote then uf.senotepr.x=uf.pr.x;uf.senotepr.y=uf.pr.y+ (Kb.PlaySong.SENotes.offsety)*dc[2]uf.senotepr.width=uf.osenotepr.width*dc[1]uf.senotepr.height=uf.osenotepr.height*dc[2]rl.DrawTexturePro(Kb.PlaySong.SENotes[uf.senote],Kb.PlaySong.SENotes.sourcerect,uf.senotepr,Kb.PlaySong.SENotes.center,0,rl.WHITE)end;if Kb.PlaySong.Notes[uf.type]then rl.DrawTexturePro(Kb.PlaySong.Notes[uf.type],Wb,uf.pr,uf.tcenter,uf.rotationr,rl.WHITE)elseif uf.type==8 then local wf=uf.startnote;if wf.type==5 or wf.type==6 then if#wf.drumrollbend==0 then local xf=bd*uf.radius;local yf,zf=wf.p[1],uf.p[1]local Af,Bf=wf.p[2],uf.p[2]if id(zf-yf)~=0 or id(Bf-Af)~=0 then uf.rotationr=jd(0 -math.deg(math.atan2((Bf-Af)*bc/dc[1],(zf-yf)*ac/dc[2])))local Cf=math.sqrt((zf-yf)^2 + (Bf-Af)^2)local Df=(zf-yf)/Cf;local Ef=(Bf-Af)/Cf;local Ff=Ub*Df;local Gf=Vb*Ef;local Hf=math.floor(Cf/Ub)local If=Cf- (Hf*Ub)Kb.PlaySong.Notes.drumrollpr.width=Ub*dc[1]Kb.PlaySong.Notes.drumrollpr.height=Vb*dc[2]local Jf=yf+yb+ (Ub/2 *Df)local Kf=Af+zb+ (Vb/2 *Ef)local Lf=4;local Mf=-0.5;for i=1,Hf do Kb.PlaySong.Notes.drumrollpr.x=Jf*dc[1]Kb.PlaySong.Notes.drumrollpr.y=Kf*dc[2]rl.DrawTexturePro(Kb.PlaySong.Notes[wf.recttype],Wb,Kb.PlaySong.Notes.drumrollpr,uf.tcenter,uf.rotationr,rl.WHITE)for i2=0,Lf-1 do if wf.senote then wf.senotepr.x=(Jf+ (Ff* (i2 /Lf+Mf)))*dc[1]wf.senotepr.y=(Kf+ (Gf* (i2 /Lf+Mf))+Kb.PlaySong.SENotes.offsety)*dc[2]rl.DrawTexturePro(Kb.PlaySong.SENotes[9],Kb.PlaySong.SENotes.sourcerect,wf.senotepr,Kb.PlaySong.SENotes.center,0,rl.WHITE)end end;Jf=Jf+Ff;Kf=Kf+Gf end;Kb.PlaySong.Notes.drumrollpr.width=If*dc[1]Kb.PlaySong.Notes.drumrollpr.x=Jf*dc[1]Kb.PlaySong.Notes.drumrollpr.y=Kf*dc[2]Kb.PlaySong.Notes.drumrollpr2.width=If;Kb.PlaySong.Notes.drumrollpr2.height=Vb;rl.DrawTexturePro(Kb.PlaySong.Notes[wf.recttype],Kb.PlaySong.Notes.drumrollpr2,Kb.PlaySong.Notes.drumrollpr,uf.tcenter,uf.rotationr,rl.WHITE)local Nf=math.floor(Kb.PlaySong.Notes.drumrollpr.width/Ub)Mf=Mf+17 /136;for i2=0,Nf-1 do if wf.senote then wf.senotepr.x=(Jf+ (Ff* (i2 /Lf+Mf)))*dc[1]wf.senotepr.y=(Kf+ (Gf* (i2 /Lf+Mf))+Kb.PlaySong.SENotes.offsety)*dc[2]rl.DrawTexturePro(Kb.PlaySong.SENotes[9],Kb.PlaySong.SENotes.sourcerect,wf.senotepr,Kb.PlaySong.SENotes.center,0,rl.WHITE)end end;wf.senotepr.x=(Jf+ (Ff* (Nf/Lf+Mf)))*dc[1]wf.senotepr.y=(Kf+ (Gf* (Nf/Lf+Mf))+Kb.PlaySong.SENotes.offsety)*dc[2]rl.DrawTexturePro(Kb.PlaySong.SENotes[10],Kb.PlaySong.SENotes.sourcerect,wf.senotepr,Kb.PlaySong.SENotes.center,0,rl.WHITE)Jf=Jf+If*Df;Kf=Kf+If*Ef;uf.pr.x=Jf*dc[1]uf.pr.y=Kf*dc[2]rl.DrawTexturePro(Kb.PlaySong.Notes[wf.endtype],Wb,uf.pr,uf.tcenter,uf.rotationr,rl.WHITE)end;rl.DrawTexturePro(Kb.PlaySong.Notes[wf.notetype],Wb,wf.pr,wf.tcenter,wf.rotationr,rl.WHITE)else local xf=uf;local yf=xf.startnote.drumrollbend;for i=1,#yf+1 do local zf,Af;if i==1 then zf=xf.startnote;Af=yf[i]local Gf,Hf=Af.CalculatePosition(Af,ie or( (Af.movemsa and(Ne>=Af.movemsa and Ne or Af.movemsa)or Ne)+le),dd)Af.p[1]=Gf*ac;Af.p[2]=Hf*bc;Af.pr.x=(Af.p[1]+yb)*dc[1]Af.pr.y=(Af.p[2]+zb)*dc[2]elseif i==#yf+1 then zf=yf[i-1]Af=xf;local Gf,Hf=zf.CalculatePosition(zf,ie or( (zf.movemsa and(Ne>=zf.movemsa and Ne or zf.movemsa)or Ne)+le),dd)zf.p[1]=Gf*ac;zf.p[2]=Hf*bc;zf.pr.x=(zf.p[1]+yb)*dc[1]zf.pr.y=(zf.p[2]+zb)*dc[2]zf.pr.width=Ub*dc[1]zf.pr.height=Vb*dc[2]else zf=yf[i-1]Af=yf[i]local Gf,Hf=zf.CalculatePosition(zf,ie or( (zf.movemsa and(Ne>=zf.movemsa and Ne or zf.movemsa)or Ne)+le),dd)zf.p[1]=Gf*ac;zf.p[2]=Hf*bc;zf.pr.x=(zf.p[1]+yb)*dc[1]zf.pr.y=(zf.p[2]+zb)*dc[2]zf.pr.width=Ub*dc[1]zf.pr.height=Vb*dc[2]local If,Jf=Af.CalculatePosition(Af,ie or( (Af.movemsa and(Ne>=Af.movemsa and Ne or Af.movemsa)or Ne)+le),dd)Af.p[1]=If*ac;Af.p[2]=Jf*bc;Af.pr.x=(Af.p[1]+yb)*dc[1]Af.pr.y=(Af.p[2]+zb)*dc[2]end;local Bf=bd*Af.radius;local Cf,Df=zf.p[1],Af.p[1]local Ef,Ff=zf.p[2],Af.p[2]if id(Df-Cf)~=0 or id(Ff-Ef)~=0 then Af.rotationr=jd(0 -math.deg(math.atan2((Ff-Ef)*bc/dc[1],(Df-Cf)*ac/dc[2])))zf.recttype=xf.startnote.recttype;zf.endtype=xf.startnote.endtype;zf.senotepr=xf.startnote.senotepr;Af.tcenter=xf.tcenter;local Gf=math.sqrt((Df-Cf)^2 + (Ff-Ef)^2)local Hf=(Df-Cf)/Gf;local If=(Ff-Ef)/Gf;local Jf=Ub*Hf;local Kf=Vb*If;local Lf=math.floor(Gf/Ub)local Mf=Gf- (Lf*Ub)Kb.PlaySong.Notes.drumrollpr.width=Ub*dc[1]Kb.PlaySong.Notes.drumrollpr.height=Vb*dc[2]local Nf=Cf+yb+ (Ub/2 *Hf)local Of=Ef+zb+ (Vb/2 *If)local Pf=4;local Qf=-0.5;for i=1,Lf do Kb.PlaySong.Notes.drumrollpr.x=Nf*dc[1]Kb.PlaySong.Notes.drumrollpr.y=Of*dc[2]rl.DrawTexturePro(Kb.PlaySong.Notes[zf.recttype],Wb,Kb.PlaySong.Notes.drumrollpr,Af.tcenter,Af.rotationr,rl.WHITE)for i2=0,Pf-1 do if zf.senote then zf.senotepr.x=(Nf+ (Jf* (i2 /Pf+Qf)))*dc[1]zf.senotepr.y=(Of+ (Kf* (i2 /Pf+Qf))+Kb.PlaySong.SENotes.offsety)*dc[2]rl.DrawTexturePro(Kb.PlaySong.SENotes[9],Kb.PlaySong.SENotes.sourcerect,zf.senotepr,Kb.PlaySong.SENotes.center,0,rl.WHITE)end end;Nf=Nf+Jf;Of=Of+Kf end;Kb.PlaySong.Notes.drumrollpr.width=Mf*dc[1]Kb.PlaySong.Notes.drumrollpr.x=Nf*dc[1]Kb.PlaySong.Notes.drumrollpr.y=Of*dc[2]Kb.PlaySong.Notes.drumrollpr2.width=Mf;Kb.PlaySong.Notes.drumrollpr2.height=Vb;rl.DrawTexturePro(Kb.PlaySong.Notes[zf.recttype],Kb.PlaySong.Notes.drumrollpr2,Kb.PlaySong.Notes.drumrollpr,Af.tcenter,Af.rotationr,rl.WHITE)local Rf=math.floor(Kb.PlaySong.Notes.drumrollpr.width/Ub)Qf=Qf+17 /136;for i2=0,Rf-1 do if zf.senote then zf.senotepr.x=(Nf+ (Jf* (i2 /Pf+Qf)))*dc[1]zf.senotepr.y=(Of+ (Kf* (i2 /Pf+Qf))+Kb.PlaySong.SENotes.offsety)*dc[2]rl.DrawTexturePro(Kb.PlaySong.SENotes[9],Kb.PlaySong.SENotes.sourcerect,zf.senotepr,Kb.PlaySong.SENotes.center,0,rl.WHITE)end end;zf.senotepr.x=(Nf+ (Jf* (Rf/Pf+Qf)))*dc[1]zf.senotepr.y=(Of+ (Kf* (Rf/Pf+Qf))+Kb.PlaySong.SENotes.offsety)*dc[2]rl.DrawTexturePro(Kb.PlaySong.SENotes[10],Kb.PlaySong.SENotes.sourcerect,zf.senotepr,Kb.PlaySong.SENotes.center,0,rl.WHITE)Nf=Nf+Mf*Hf;Of=Of+Mf*If;Af.pr.x=Nf*dc[1]Af.pr.y=Of*dc[2]rl.DrawTexturePro(Kb.PlaySong.Notes[zf.endtype],Wb,Af.pr,Af.tcenter,Af.rotationr,rl.WHITE)end end;rl.DrawTexturePro(Kb.PlaySong.Notes[wf.notetype],Wb,wf.pr,wf.tcenter,wf.rotationr,rl.WHITE)for i=1,#yf do local zf=yf[i]rl.DrawTexturePro(Kb.PlaySong.Notes[zf.notetype],Wb,zf.pr,xf.tcenter,0,rl.WHITE)end end elseif wf.type==7 then if wf.timeshit==nil then rl.DrawTexturePro(Kb.PlaySong.Notes.balloon,Wb,wf.pr,wf.tcenter,wf.rotationr,rl.WHITE)Kb.PlaySong.Balloons.pr2.x=wf.pr.x+wf.pr.width;Kb.PlaySong.Balloons.pr2.y=wf.pr.y;rl.DrawTexturePro(Kb.PlaySong.Notes.balloonend,Wb,Kb.PlaySong.Balloons.pr2,wf.tcenter,wf.rotationr,rl.WHITE)else local xf=wf.requiredhits-wf.timeshit;local yf=(yc.framen-1)-math.ceil(xf/ (wf.requiredhits/ (yc.framen-1)))yf=yf<0 and 0 or yf;if yf==5 then local zf=Ne-yc.startms;local Af=math.floor(zf/Ib)local Bf=yc.anim[Af]if Bf then yc.color.a=255 *Bf;if Bf>0 then rl.DrawTexturePro(Kb.PlaySong.Balloons.Anim[yf],Kb.PlaySong.Balloons.sourcerect,Kb.PlaySong.Balloons.pr,Kb.PlaySong.Balloons.center,wf.rotationr,yc.color)end else wf.hit=true end else Kb.PlaySong.Balloons.pr.x=wf.pr.x+wf.pr.width;Kb.PlaySong.Balloons.pr.y=wf.pr.y;rl.DrawTexturePro(Kb.PlaySong.Balloons.Anim[yf],Kb.PlaySong.Balloons.sourcerect,Kb.PlaySong.Balloons.pr,Kb.PlaySong.Balloons.center,wf.rotationr,rl.WHITE)end end end end else error('Invalid note.data')end end end end end;if he.explosionanim then local uf=Ne-he.startms;local vf=math.floor(uf/Ib)local wf=he.explosionanim[vf]if wf then rl.DrawTexturePro(wf,Kb.PlaySong.Effects.Note.sourcerect,cc,Kb.PlaySong.Effects.Note.center,0,pc)else he.explosionanim=nil end end;if he.explosionbiganim then local uf=Ne-he.startms;local vf=math.floor(uf/Ib)local wf=he.explosionbiganim[vf]if wf then rl.DrawTexturePro(wf,Kb.PlaySong.Effects.Note.sourcerect,cc,Kb.PlaySong.Effects.Note.center,0,pc)else he.explosionbiganim=nil end end;local sf=0;for i=1,#Cc.startms do local uf=i+sf;local vf=Ne-Cc.startms[uf]local wf=math.floor(vf/Ib)local xf=Cc.animp[wf]if xf then local yf=Cc.animt[wf]local zf=Cc.judge[uf]Cc.color.a=255 *yf;Kb.PlaySong.Judges.pr.x=cc.x;Kb.PlaySong.Judges.pr.y=cc.y- (xf/720 *w.ScreenHeight)rl.DrawTexturePro(Kb.PlaySong.Judges[zf],Kb.PlaySong.Judges.sourcerect,Kb.PlaySong.Judges.pr,Kb.PlaySong.Judges.center,0,Cc.color)else table.remove(Cc.startms,uf)table.remove(Cc.judge,uf)sf=sf-1 end end;if Ge.on and(not Ge.movingnotes)then for uf,vf in pairs(Ge.moving.offset.data)do rl[uf]=vf end end;if Ge.on then local uf=rl.GetMousePosition()if Ge.grid.on then if Ge.grid.isrect then local wf,xf=Ge.grid.pr.width*dc[1],Ge.grid.pr.height*dc[2]local yf,zf=Ge.grid.v,Ge.grid.v2;local Af=Ge.grid.pr;local Bf,Cf=Af.x+ (Fe.offset.x%wf),Af.y+ (Fe.offset.y%xf)local Df=Ge.currentdragginglinethickness;local Ef=Ge.currentdragginglinecolor;yf.x=0;zf.x=w.ScreenWidth;local Ff=Cf;while true do if Ff<0 then break else yf.y=Ff;zf.y=Ff;rl.DrawLineEx(yf,zf,Df,Ef)Ff=Ff-xf end end;local Gf=Cf+xf;while true do if Gf>w.ScreenHeight then break else yf.y=Gf;zf.y=Gf;rl.DrawLineEx(yf,zf,Df,Ef)Gf=Gf+xf end end;yf.y=0;zf.y=w.ScreenHeight;local Hf=Bf;while true do if Hf<0 then break else yf.x=Hf;zf.x=Hf;rl.DrawLineEx(yf,zf,Df,Ef)Hf=Hf-wf end end;local If=Bf+wf;while true do if If>w.ScreenWidth then break else yf.x=If;zf.x=If;rl.DrawLineEx(yf,zf,Df,Ef)If=If+wf end end else local wf,xf=Ge.grid.pr.x+Fe.offset.x,Ge.grid.pr.y+Fe.offset.y;local yf,zf=Ge.grid.pr.width*dc[1],Ge.grid.pr.height*dc[2]local Af,Bf=Ge.grid.v,Ge.grid.v2;local Cf=Ge.grid.pr;local Df=Ge.currentdragginglinethickness;local Ef=Ge.currentdragginglinecolor;local Ff=1;local Gf,Hf=nil,nil;while true do Gf=yf*Ff;Hf=zf*Ff;local If=( (0 -wf)^2 / (Gf)^2 + (0 -xf)^2 / (Hf)^2 <=1)and( (w.ScreenWidth-wf)^2 / (Gf)^2 + (0 -xf)^2 / (Hf)^2 <=1)and( (0 -wf)^2 / (Gf)^2 + (w.ScreenHeight-xf)^2 / (Hf)^2 <=1)and( (w.ScreenWidth-wf)^2 / (Gf)^2 + (w.ScreenHeight-xf)^2 / (Hf)^2 <=1)if If then break else rl.DrawEllipseLines(wf,xf,Gf,Hf,Ef)Ff=Ff+1 end end;for i2=1,Df-1 do for i3=1,Ff do Gf=yf*i3 +i2;Hf=zf*i3 +i2;rl.DrawEllipseLines(wf,xf,Gf,Hf,Ef)end end end end;if Ge.boxselection then rl.DrawRectangleLinesEx(Ge.boxselectionpr2,Ge.currentdragginglinethickness,Ge.currentdragginglinecolor)end;if Ge.info.hovernote then local wf=Ge.info.hovernote;local xf='ms: '..wf.ms..'\ntype: '..wf.type..'\nscroll: {'..wf.scrollx..', '..wf.scrolly..'}'..'\nspeed: {'..wf.speed[1]..', '..wf.speed[2]..'}'..'\nbpm: '..wf.bpm..'\nn: '..wf.n;local yf,zf=uf.x+Ge.info.offset.x,uf.y+Ge.info.offset.y;local Af,Bf=B(xf,Ge.info.textsize)local Cf=Ge.info.backgroundpadding;rl.DrawRectangle(yf-Cf,zf-Cf,Af+2 *Cf,Bf+2 *Cf,Ge.info.backgroundcolor)rl.DrawText(xf,yf,zf,Ge.info.textsize,rl.RAYWHITE)Ge.info.hovernote=nil end;local vf=0;for i=1,#Ge.currentdragging do local wf=i+vf;local xf=Ge.currentdragging[wf]if xf.hit then table.remove(Ge.currentdragging,wf)vf=vf-1 else local yf=Ge.currentdraggingr;yf.x=xf.pr.x-xf.tcenter.x+Fe.offset.x;yf.y=xf.pr.y-xf.tcenter.y+Fe.offset.y;yf.width=xf.pr.width;yf.height=xf.pr.height;rl.DrawRectangleLinesEx(yf,Ge.currentdragginglinethickness,Ge.currentdragginglinecolor)end end;if Ge.overlay.on then rl.DrawText('Editor'..'   Selected: '..#Ge.currentdragging..' notes'..'   Runtime speed: '.. (Je and Ke or He)..'   ms: '..Ne..'\nEditor   DragMode: Changing '.. (Ge.changingscroll and'scroll'or'ms')..'   DragMode increment: '.. (Ge.grid.on and((Ge.changingscroll and(Ge.grid.scrollincrement..' scroll')or(Ge.grid.msincrement..' ms')))or'Off')..'   Grid: '.. (Ge.grid.on and'On'or'Off')..'\nEditor   MoveMode: Moving '.. (Ge.movingnotes and'notes'or'editor'),Ge.overlay.editortextp.x,Ge.overlay.editortextp.y,Ge.overlay.editortextsize*dc[2],rl.BLACK)end end;if Hc then Hc(Ne)end;rl.EndDrawing()if qb(w.Controls.PlaySong.Editor.Toggle)then Ge.on=not Ge.on end;if Ge.on then local uf=rl.GetMousePosition()local vf=rl.IsMouseButtonDown(rl.MOUSE_BUTTON_LEFT)local wf=rl.IsMouseButtonPressed(rl.MOUSE_BUTTON_LEFT)local xf=rl.IsMouseButtonReleased(rl.MOUSE_BUTTON_LEFT)local yf=rl.IsMouseButtonDown(rl.MOUSE_BUTTON_RIGHT)local zf=rl.IsMouseButtonPressed(rl.MOUSE_BUTTON_RIGHT)local Af=rl.IsMouseButtonReleased(rl.MOUSE_BUTTON_RIGHT)local Bf,Cf=uf.x-Fe.offset.x,uf.y-Fe.offset.y;local Df=nil;for i=1,#Fd do local If=Fd[i]if If.data=='note'then if If.type==8 then If.pr.x=(If.p[1]+yb)*dc[1]If.pr.y=(If.p[2]+zb)*dc[2]local Jf=( (Bf-If.pr.x)^2 / (If.pr.width/4)^2 + (Cf-If.pr.y)^2 / (If.pr.height/4)^2 <=1)if Jf then Df=If;break end elseif If.type==5 or If.type==6 then local Jf=If;for i=1,#Jf.drumrollbend do local Lf=Jf.drumrollbend[i]local Mf=( (Bf-Lf.pr.x)^2 / (Lf.pr.width/4)^2 + (Cf-Lf.pr.y)^2 / (Lf.pr.height/4)^2 <=1)if Mf then Df=Lf;break end end;local Kf=( (Bf-If.pr.x)^2 / (If.pr.width/4)^2 + (Cf-If.pr.y)^2 / (If.pr.height/4)^2 <=1)if Kf then Df=If;break end else local Jf=( (Bf-If.pr.x)^2 / (If.pr.width/4)^2 + (Cf-If.pr.y)^2 / (If.pr.height/4)^2 <=1)if Jf then Df=If;break end end end end;if wf then if Df==nil then Ge.boxselection=true;Ge.boxselectionpr.x=uf.x;Ge.boxselectionpr.y=uf.y else Ge.boxselection=false end end;if vf then if Ge.boxselection then Ge.boxselectionpr.width=uf.x-Ge.boxselectionpr.x;Ge.boxselectionpr.height=uf.y-Ge.boxselectionpr.y;if Ge.boxselectionpr.width<0 then Ge.boxselectionpr2.x=Ge.boxselectionpr.x+Ge.boxselectionpr.width;Ge.boxselectionpr2.width=-Ge.boxselectionpr.width else Ge.boxselectionpr2.x=Ge.boxselectionpr.x;Ge.boxselectionpr2.width=Ge.boxselectionpr.width end;if Ge.boxselectionpr.height<0 then Ge.boxselectionpr2.y=Ge.boxselectionpr.y+Ge.boxselectionpr.height;Ge.boxselectionpr2.height=-Ge.boxselectionpr.height else Ge.boxselectionpr2.y=Ge.boxselectionpr.y;Ge.boxselectionpr2.height=Ge.boxselectionpr.height end;local If,Jf=Ge.boxselectionpr2.x-Fe.offset.x,Ge.boxselectionpr2.x+Ge.boxselectionpr2.width-Fe.offset.x;local Kf,Lf=Ge.boxselectionpr2.y-Fe.offset.y,Ge.boxselectionpr2.y+Ge.boxselectionpr2.height-Fe.offset.y;Ge.currentdragging={}for i=1,#Fd do local Mf=Fd[i]if(If<Mf.pr.x and Mf.pr.x<Jf)and(Kf<Mf.pr.y and Mf.pr.y<Lf)then Ge.currentdragging[#Ge.currentdragging+1]=Mf end end;vf=false end else Ge.boxselection=false end;if rb(w.Controls.PlaySong.Editor.Shortcut.Hold)then if qb(w.Controls.PlaySong.Editor.Shortcut.SelectAll)then Ge.currentdragging={}for i=1,#Fd do local If=Fd[i]if If.data=='note'then Ge.currentdragging[#Ge.currentdragging+1]=If end end end;if qb(w.Controls.PlaySong.Editor.Shortcut.Copy)then Ge.clipboard={}for i=1,#Ge.currentdragging do local If=Ge.currentdragging[i]Ge.clipboard[#Ge.clipboard+1]=If end end;if qb(w.Controls.PlaySong.Editor.Shortcut.Paste)then Ge.currentdragging={}local If=Ge.clipboard[1]local Jf=uf.x-If.pr.x-Fe.offset.x;local Kf=uf.y-If.pr.y-Fe.offset.y;for i=1,#Ge.clipboard do local Lf=Ge.clipboard[i]local Mf={}for Nf,Of in pairs(Lf)do local Pf=nil;if Nf=='pr'or Nf=='osenotepr'or Nf=='senotepr'then Pf=rl.new('Rectangle')Pf.x=Of.x;Pf.y=Of.y;Pf.width=Of.width;Pf.height=Of.height elseif Nf=='tcentero'or Nf=='tcenter'then Pf=rl.new('Vector2')Pf.x=Of.x;Pf.y=Of.y elseif Nf=='speed'or Nf=='p'then Pf={}Pf[1]=Of[1]Pf[2]=Of[2]elseif Nf=='editor'then Pf=nil else Pf=Of end;Mf[Nf]=Pf end;do local Nf=Mf;Nf.editor=Nf.editor or{}Nf.editor.dragstartpr=Nf.editor.dragstartpr or rl.new('Vector2')Nf.editor.dragstartpr.x=Nf.pr.x;Nf.editor.dragstartpr.y=Nf.pr.y;Nf.editor.dragstartmousepr=Nf.editor.dragstartmousepr or rl.new('Vector2')Nf.editor.dragstartmousepr.x=uf.x-Jf;Nf.editor.dragstartmousepr.y=uf.y-Kf end;Fd[#Fd+1]=Mf;Ec.Data[#Ec.Data+1]=Mf;Ge.currentdragging[#Ge.currentdragging+1]=Mf end;vf=true end;if qb(w.Controls.PlaySong.Editor.Shortcut.Cut)then Ge.clipboard={}for i=1,#Ge.currentdragging do local If=Ge.currentdragging[i]Ge.clipboard[#Ge.clipboard+1]=If;local Jf=0;for i2raw=1,#Fd do local Kf=i2raw+Jf;local Lf=Fd[Kf]if Lf==If then table.remove(Fd,Kf)Jf=Jf-1 end end end end;if qb(w.Controls.PlaySong.Editor.Shortcut.Save)then Oe=true;local If=FileDialog.Save('Save: Select editor save data location',rl.GetWorkingDirectory(),nil,nil,false)if If then local Jf=Ec;local Kf=PersistentParsed.Save(Jf)local Lf=io.open(If,'wb+')Lf:write(Kf)Lf:close()for i=1,#Ec.Data do local Mf=Ec.Data[i]if Mf.nextnote then Mf.nextnote=Ec.Data[Mf.nextnote]end;if Mf.startnote then Mf.startnote=Ec.Data[Mf.startnote]end;if Mf.endnote then Mf.endnote=Ec.Data[Mf.endnote]end end;I('Save: Success')else I('Save: File not selected')end end;if qb(w.Controls.PlaySong.Editor.Shortcut.Load)then Oe=true;local If=FileDialog.Open('Load: Select editor save data location',rl.GetWorkingDirectory(),nil,nil,false)if If then local Jf=io.open(If,'rb')local Kf=Jf:read('*all')Jf:close()local Lf=PersistentParsed.Load(Kf)if Lf then I('Load: Success')return Taiko.Play(Lf)else I('Load: Invalid file data')end else I('Load: File not selected')end end;if qb(w.Controls.PlaySong.Editor.Shortcut.Export)then Oe=true;local If=FileDialog.Save('Export: Select editor save data location',rl.GetWorkingDirectory(),nil,nil,false)if If then for Mf,Nf in pairs(Ec.Data)do if Nf.branch then for Of,Pf in pairs(Nf.branch.paths)do table.sort(Pf,function(Qf,Rf)return(Qf.ms==Rf.ms)and(Qf.data=='event'and Qf.event=='barline'and not(Rf.data=='event'and Rf.event=='barline'))or(Qf.ms<Rf.ms)end)end end end;table.sort(Ec.Data,function(Mf,Nf)if Mf.branch and Nf.branch then for Of,Pf in pairs(Mf.branch.paths)do for Qf,Rf in pairs(Nf.branch.paths)do return Pf[1].ms<Rf[1].ms end end elseif Mf.branch then for Of,Pf in pairs(Mf.branch.paths)do return Pf[1].ms<Nf.ms end elseif Nf.branch then for Of,Pf in pairs(Nf.branch.paths)do return Mf.ms<Pf[1].ms end else return(Mf.ms==Nf.ms)and(Mf.data=='event'and Mf.event=='barline'and not(Nf.data=='event'and Nf.event=='barline'))or(Mf.ms<Nf.ms)end end)local Jf=Ec;local Kf=Taiko.SerializeTJA({Jf})local Lf=io.open(If,'wb+')Lf:write(Kf)Lf:close()I('Export: Success')else I('Export: File not selected')end end;if qb(w.Controls.PlaySong.Editor.Shortcut.Import)then Oe=true;local If=FileDialog.Open('Import: Select editor save data location',rl.GetWorkingDirectory(),nil,nil,false)if If then local Jf,Kf=Taiko.ParseTJAFile(If)if Jf then local Lf=Taiko.RayGuiDifficulty()local Mf=Taiko.GetDifficulty(Jf,Lf)I('Import: Success')return Taiko.Play(Mf)else error(Kf)end else I('Import: File not selected')end end;if qb(w.Controls.PlaySong.Editor.Shortcut.ClearAll)then Oe=true;local If=K('Are you sure you want to delete this chart?\nTHIS ACTION CANNOT BE DONE,\nAND EVERYTHING WILL BE DELETED',tostring(math.random(0,1000000000)))if If then local Jf=w.Settings.Defaults.ClearAllPath;if Jf then local Kf,Lf=Taiko.ParseTJAFile(Jf)if Kf then local Mf=Taiko.RayGuiDifficulty()local Nf=Taiko.GetDifficulty(Kf,Mf)I('ClearAll: Success')return Taiko.Play(Nf)else error(Lf)end else I('ClearAll: File not selected')end else I('ClearAll: Action cancelled')end end end;if qb(w.Controls.PlaySong.Editor.Shortcut.Delete)then for i=1,#Ge.currentdragging do local If=Ge.currentdragging[i]local Jf=0;for i2raw=1,#Fd do local Kf=i2raw+Jf;local Lf=Fd[Kf]if Lf==If then table.remove(Fd,Kf)Jf=Jf-1 end end end end;if qb(w.Controls.PlaySong.Editor.Shortcut.Snap)then vf=true end;if qb(w.Controls.PlaySong.Editor.ToggleDragMode)then Ge.changingscroll=not Ge.changingscroll end;if qb(w.Controls.PlaySong.Editor.ToggleGrid)then Ge.grid.on=not Ge.grid.on end;local Ef=not Ge.movingnotes;local Ff=false;local Gf=0;local Hf=0;if(Ef and rb or qb)(w.Controls.PlaySong.Editor.Move.Left)then Gf=Gf-w.Controls.PlaySong.Editor.Move.MoveIncrement end;if(Ef and rb or qb)(w.Controls.PlaySong.Editor.Move.Right)then Gf=Gf+w.Controls.PlaySong.Editor.Move.MoveIncrement end;if(Ef and rb or qb)(w.Controls.PlaySong.Editor.Move.Up)then Hf=Hf-w.Controls.PlaySong.Editor.Move.MoveIncrement end;if(Ef and rb or qb)(w.Controls.PlaySong.Editor.Move.Down)then Hf=Hf+w.Controls.PlaySong.Editor.Move.MoveIncrement end;if qb(w.Controls.PlaySong.Editor.Move.Toggle)then Ge.movingnotes=not Ge.movingnotes end;if rb(w.Controls.PlaySong.Editor.Move.SpeedUpHold)then Gf=Gf*w.Controls.PlaySong.Editor.Move.SpeedUpMultiplier;Hf=Hf*w.Controls.PlaySong.Editor.Move.SpeedUpMultiplier end;if qb(w.Controls.PlaySong.Editor.Move.MoveEditor.Reset)then local If=Fe.offset;If.x=0;If.y=0 end;if not(Gf==0 and Hf==0)then Gf=Gf*df*dc[1]Hf=Hf*df*dc[2]if Ge.movingnotes then Ff=true else local If=Fe.offset;If.x=If.x-Gf;If.y=If.y-Hf;local Jf=Jd;while true do if Jf then Jf.loadms=0;Jf=Jf.nextnote else break end end end end;if not rb(w.Controls.PlaySong.Editor.Shortcut.Hold)then if qb(w.Controls.PlaySong.Editor.Shortcut.New)then end;if qb(w.Controls.PlaySong.Debug.ToggleAuto)then Oc=not Oc end;if qb(w.Controls.PlaySong.Debug.Retry)then return false end end;if Ge.movingnotes and#Ge.currentdragging==0 then if rb(w.Controls.PlaySong.Debug.Backward)then Le=Le- (w.Controls.PlaySong.Debug.BackwardIncrement*df)local If=0;for i=1,#Id do local Jf=i+If;local Kf=Id[Jf]if Kf.done and Kf.done>=Le then if Kf.addcombo then Pd=Pd-Kf.addcombo;Kf.addcombo=nil end;if Kf.addscore then Ld=Ld-Kf.addscore;Kf.addscore=nil end;if Kf.addgauge then Rd=Rd-Kf.addgauge;Kf.addgauge=nil end;if Kf.queue then Kf.done=nil;Kf.queue[#Kf.queue+1]=Kf else Kf.done=nil;Kf.hit=nil;Kf.addcombo=nil;Kf.addscore=nil;Fd[#Fd+1]=Kf end;table.remove(Id,Jf)If=If-1 end end;Mc=true end;if rb(w.Controls.PlaySong.Debug.Forward)then Le=Le+ (w.Controls.PlaySong.Debug.ForwardIncrement*df)Mc=true end;if qb(w.Controls.PlaySong.Debug.RunTimeSpeed.Slower)then if Je then Ke=Ke/w.Controls.PlaySong.Debug.RunTimeSpeed.FasterMultiplier else He=He/w.Controls.PlaySong.Debug.RunTimeSpeed.FasterMultiplier end end;if qb(w.Controls.PlaySong.Debug.RunTimeSpeed.Faster)then if Je then Ke=Ke*w.Controls.PlaySong.Debug.RunTimeSpeed.FasterMultiplier else He=He*w.Controls.PlaySong.Debug.RunTimeSpeed.FasterMultiplier end end end;if qb(w.Controls.PlaySong.Debug.Freeze)then Je=not Je;if Je==false then Mc=true end end;if rb(w.Controls.PlaySong.Debug.SaveState.Save.Hold)then local If=sb(w.Controls.PlaySong.Debug.SaveState.Save.Slot)if If then Oe=true;local Jf,Kf=SaveState.SaveSlot(If)if Jf then print('SaveSlot: Saved to slot '..If)end end else local If=sb(w.Controls.PlaySong.Debug.SaveState.Load.Slot)if If then local Jf=SaveState.LoadSlot(If)if Jf then print('SaveSlot: Loaded from slot '..If)else print('SaveSlot: Unable to find slot '..If)end end end;if Df then Ge.info.hovernote=Df end;if wf then if Df then local If=nil;for i=1,#Ge.currentdragging do if Ge.currentdragging[i]==Df then If=i;break end end;if rb(w.Controls.PlaySong.Editor.ModifySelectionHold)then if If then table.remove(Ge.currentdragging,i)else Ge.currentdragging[#Ge.currentdragging+1]=Df end else if If then else Ge.currentdragging={}Ge.currentdragging[#Ge.currentdragging+1]=Df end end else Ge.currentdragging={}end end;if#Ge.currentdragging==1 then local If=Ge.currentdragging[1]if Ge.grid.selected==nil or(Ge.changingscroll==not Ge.grid.isrect)or(Ge.grid.selected~=If)or Ge.changingscroll then Ge.grid.selected=If;if Ge.changingscroll then Ge.grid.isrect=true;local Jf=ie or( (If.movemsa and(Ne>=If.movemsa and Ne or If.movemsa)or Ne)+le)local Kf=pb.ScreenWidth/1280;local Lf=960;local Mf=(If.bpm/240000 * (Ge.grid.scrollincrement)*Lf*Kf)local Nf=(If.bpm/240000 * (Ge.grid.scrollincrement)*Lf*Kf)Ge.grid.pr.width=Mf* (If.ms-Jf)Ge.grid.pr.height=Nf* (If.ms-Jf)Ge.grid.pr.x=cc.x;Ge.grid.pr.y=cc.y else Ge.grid.isrect=true;local Jf=(Ge.grid.msincrement)*If.speed[1]local Kf=(Ge.grid.msincrement)*If.speed[2]Ge.grid.pr.width=math.sqrt(Jf^2 +Kf^2)Ge.grid.pr.height=w.ScreenHeight;Ge.grid.pr.x=cc.x;Ge.grid.pr.y=cc.y end;Ge.grid.pr.width=math.abs(Ge.grid.pr.width)Ge.grid.pr.height=math.abs(Ge.grid.pr.height)if Ge.grid.pr.width<Ge.grid.smallest then Ge.grid.pr.width=w.ScreenWidth*2 end;if Ge.grid.pr.height<Ge.grid.smallest then Ge.grid.pr.height=w.ScreenHeight*2 end end else Ge.grid.isrect=true;Ge.grid.selected=nil;Ge.grid.pr.x=cc.x;Ge.grid.pr.y=cc.y;Ge.grid.pr.width=Ub/4;Ge.grid.pr.height=Vb/4 end;for i=1,#Ge.currentdragging do local If=Ge.currentdragging[i]if wf or(not If.editor)then If.editor=If.editor or{}If.editor.dragstartpr=If.editor.dragstartpr or rl.new('Vector2')If.editor.dragstartpr.x=If.pr.x;If.editor.dragstartpr.y=If.pr.y;If.editor.dragstartmousepr=If.editor.dragstartmousepr or rl.new('Vector2')If.editor.dragstartmousepr.x=uf.x;If.editor.dragstartmousepr.y=uf.y end;if vf or Ff then if Ff then If.pr.x=If.pr.x+Gf;If.pr.y=If.pr.y+Hf else If.pr.x=If.editor.dragstartpr.x+ (uf.x-If.editor.dragstartmousepr.x)If.pr.y=If.editor.dragstartpr.y+ (uf.y-If.editor.dragstartmousepr.y)if Ge.grid.on and Ge.grid.selected then local Jf=Ge.grid.pr;local Kf,Lf=Jf.width*dc[1],Jf.height*dc[2]local Mf=(If.pr.x-Jf.x)/ (Kf)local Nf=(If.pr.y-Jf.y)/ (Lf)If.pr.x=math.floor(Mf+0.5)*Kf+Jf.x;If.pr.y=math.floor(Nf+0.5)*Lf+Jf.y end end;if Ge.changingscroll then local Jf=ie or( (If.movemsa and(Ne>=If.movemsa and Ne or If.movemsa)or Ne)+le)If.speed[1]=(dd[1]- ( (If.pr.x/dc[1]-yb)/ac))/ (If.ms-Jf-If.delay)If.speed[2]=(dd[2]- ( (If.pr.y/dc[2]-zb)/bc))/ (If.ms-Jf-If.delay)local Kf=pb.ScreenWidth/1280;local Lf=960;If.scrollx=If.speed[1]/If.bpm*240000 /Lf/Kf;If.scrolly=If.speed[2]/If.bpm*240000 /Lf/Kf else local Jf=ie or( (If.movemsa and(Ne>=If.movemsa and Ne or If.movemsa)or Ne)+le)if math.abs(If.speed[1])>=math.abs(If.speed[2])then If.ms=( (dd[1]- ( (If.pr.x/dc[1]-yb)/ac))/ (If.speed[1]))+Jf+If.delay else If.ms=( (dd[2]- ( (If.pr.y/dc[2]-zb)/bc))/ (If.speed[2]))+Jf+If.delay end;If.oms=If.ms*Rc+sd end end end end;if rb(w.Controls.PlaySong.Debug.Hold)then if qb(w.Controls.PlaySong.Debug.ToggleAuto)then Oc=not Oc end;if qb(w.Controls.PlaySong.Debug.Retry)then return false end;if rb(w.Controls.PlaySong.Debug.Backward)then Le=Le- (w.Controls.PlaySong.Debug.BackwardIncrement*df)local uf=0;for i=1,#Id do local vf=i+uf;local wf=Id[vf]if wf.done and wf.done>=Le then if wf.addcombo then Pd=Pd-wf.addcombo;wf.addcombo=nil end;if wf.addscore then Ld=Ld-wf.addscore;wf.addscore=nil end;if wf.addgauge then Rd=Rd-wf.addgauge;wf.addgauge=nil end;if wf.queue then wf.done=nil;wf.queue[#wf.queue+1]=wf else wf.done=nil;wf.hit=nil;wf.addcombo=nil;wf.addscore=nil;Fd[#Fd+1]=wf end;table.remove(Id,vf)uf=uf-1 end end;Mc=true end;if rb(w.Controls.PlaySong.Debug.Forward)then Le=Le+ (w.Controls.PlaySong.Debug.ForwardIncrement*df)Mc=true end;if rb(w.Controls.PlaySong.Debug.SaveState.Save.Hold)then local uf=sb(w.Controls.PlaySong.Debug.SaveState.Save.Slot)if uf then local vf,wf=SaveState.SaveSlot(uf)if vf then print('SaveSlot: Saved to slot '..uf)end end else local uf=sb(w.Controls.PlaySong.Debug.SaveState.Load.Slot)if uf then local vf=SaveState.LoadSlot(uf)if vf then print('SaveSlot: Loaded from slot '..uf)else print('SaveSlot: Unable to find slot '..uf)end end end;if qb(w.Controls.PlaySong.Debug.RunTimeSpeed.Slower)then if Je then Ke=Ke/w.Controls.PlaySong.Debug.RunTimeSpeed.FasterMultiplier else He=He/w.Controls.PlaySong.Debug.RunTimeSpeed.FasterMultiplier end end;if qb(w.Controls.PlaySong.Debug.RunTimeSpeed.Faster)then if Je then Ke=Ke*w.Controls.PlaySong.Debug.RunTimeSpeed.FasterMultiplier else He=He*w.Controls.PlaySong.Debug.RunTimeSpeed.FasterMultiplier end end;if qb(w.Controls.PlaySong.Debug.Freeze)then Je=not Je;if Je==false then Mc=true end end end;if rl.WindowShouldClose()then rl.CloseWindow()error()break end;if rl.IsWindowResized()and(not w.Fullscreen)then local uf,vf=rl.GetScreenWidth(),rl.GetScreenHeight()if uf~=w.ScreenWidth or vf~=w.ScreenHeight then ec(Kb,uf/w.ScreenWidth,vf/w.ScreenHeight)w.ScreenWidth,w.ScreenHeight=uf,vf end end;if qb(w.Controls.PlaySong.Fullscreen)then local uf,vf=tb()ec(Kb,uf,vf)Mc=true end;if qb(w.Controls.PlaySong.Screenshot)then local uf=rl.LoadImageFromScreen()rl.ExportImage(uf,lb(w.Paths.Screenshots,w.Formats.Screenshot))rl.UnloadImage(uf)Mc=true end;local tf=qb(w.Controls.PlaySong.Command.Init)if qb(w.Controls.PlaySong.Pause.Init)or tf then Oe=true;local uf=os.clock()rl.EndDrawing()local vf=rl.LoadImageFromScreen()local wf=rl.LoadTextureFromImage(vf)local xf=1;local yf={'Back to game','Retry','Quit'}local zf,Af,Bf,Cf,Df,Ef,Ff,Gf,Hf,If,Jf,Kf,Lf,Mf,Nf;if tf then zf={'Console','\nS: ',tostring(Le),'\nMs: ',tostring(Ne),'\nGogo: ',tostring(Qd),'\nLoaded: ',tostring(#Hd),'\nFramen: ',af,'\nnextnote.loadms: ',tostring(Jd and Jd.loadms),'\nnextnote.n: ',tostring(Jd and Jd.n),'\nballoonstart: ',tostring(Yd),'\nballoonend: ',tostring(Zd),'\n\nMemory usage (mb): ',collectgarbage('count')/1000,'\nFinished (%): ',Ne/ (Ed)*100,'\n\n'}strtext=table.concat(zf)Af,Bf=0,360 /720 *w.ScreenHeight;Cf=1;Df=false;Ef={}Ff=''Gf={}If=''Hf='Console: 'Jf=rl.ImageFromImage(vf,rl.new('Rectangle',0,0,1,1))rl.ImageDrawPixel(Jf,0,0,rl.new('Color',0,0,0,255 /2))Kf=rl.LoadTextureFromImage(Jf)rl.UnloadImage(Jf)Nf=rl.new('Rectangle',0,0,1,1)Lf=rl.new('Rectangle',0,0,1,1)Mf=rl.new('Vector2',0,0)end;rl.UnloadImage(vf)while true do rl.BeginDrawing()rl.ClearBackground(rl.RAYWHITE)rl.DrawTexture(wf,0,0,rl.WHITE)if tf then local Of=strtext..If..Hf..Ff;Lf.x,Lf.y=Af,Bf;Lf.width,Lf.height=B(Of,Eb)rl.DrawTexturePro(Kf,Nf,Lf,Mf,0,rl.WHITE)rl.DrawText(Of,Af,Bf,Eb,rl.RAYWHITE)end;for i=1,#yf do rl.DrawText((i==xf and'> 'or'')..yf[i],w.ScreenWidth/2,w.ScreenHeight/2 + ( (i- (#yf+1)/2)*D),D,rl.BLACK)end;rl.EndDrawing()if tf then if qb(w.Controls.PlaySong.Command.Move.Toggle)then Df=not Df end;if Df then if rb(w.Controls.PlaySong.Command.Move.Left)then Af=Af-Cf end;if rb(w.Controls.PlaySong.Command.Move.Right)then Af=Af+Cf end;if rb(w.Controls.PlaySong.Command.Move.Up)then Bf=Bf-Cf end;if rb(w.Controls.PlaySong.Command.Move.Down)then Bf=Bf+Cf end end;while true do local Of=rl.GetCharPressed()if Of==0 then break else Ef[#Ef+1]=Of;Ff=m(Ef)end end;if rl.IsKeyPressed(rl.KEY_BACKSPACE)then Ef[#Ef]=nil;Ff=m(Ef)end;if rl.IsKeyPressed(rl.KEY_ENTER)then end end;if qb(w.Controls.PlaySong.Pause.Escape)then break end;if qb(w.Controls.PlaySong.Pause.U)then xf=xf-1 end;if qb(w.Controls.PlaySong.Pause.D)then xf=xf+1 end;xf=ClipN(xf,1,#yf)if qb(w.Controls.PlaySong.Pause.Select)then if xf==1 then break elseif xf==2 then fc()return false elseif xf==3 then fc()return nil else end end;if rl.WindowShouldClose()then break end end;rl.EndDrawing()rl.UnloadTexture(wf)Mc=true;bf=bf+ (os.clock()-uf)end;if Je then if not Ke then Ke=He;He=0 end elseif Ke then He=Ke;Ke=nil end end;if ve then local cf={}for i=1,2 do cf[i]=we[i][false]cf[i+2]=we[i][false]end;we=cf;we=Replay.Save(Replay.TranscodeRawKey(we),{'\ntitle ',Ec.Metadata.TITLE,'\nsubtitle ','','\ndifficulty ',Taiko.Data.CourseName[Ec.Metadata.COURSE],'\nstars ',tostring(Ec.Metadata.LEVEL),'\ntime ',tostring(os.time())})Replay.Write(xe,we)end;fc()if''then return false end;return true,Jc end;function Taiko.CalibrateParsed(Ec)local Fc=false;local Gc=Taiko.Data.Timing.Level[Ec.Metadata.TIMING]local Hc={ms={},n={}}local Ic={oneveryframe=function(Lc)end,oneveryhit=function(Lc,Mc,Nc,Oc)Hc.ms[#Hc.ms+1]=Lc;Hc.n[#Hc.n+1]=Oc[Mc]end}Taiko.PlaySong(Ec,Ic)local Jc={}for i=1,#Hc.ms do local Lc=Hc.ms[i]local Mc=Hc.n[i]if Mc then local Nc=( (Mc.type==3 or Mc.type==4)and Taiko.Data.BigLeniency)or 1;if(not Fc)or(math.abs(Lc-Mc.ms)< (Gc.bad*Nc))then Jc[#Jc+1]=Lc-Mc.ms end end end;local Kc={sum=0,average=nil,min=nil,max=nil}for i=1,#Jc do local Lc=Jc[i]Kc.sum=Kc.sum+Lc;Kc.min=(not Kc.min or Lc<Kc.min)and Lc or Kc.min;Kc.max=(not Kc.max or Lc>Kc.max)and Lc or Kc.max end;Kc.average=Kc.sum/#Jc;return Kc end;function Taiko.Calibrate(Ec)if not Ec then Ec=Taiko.GetDifficulty(Taiko.ParseTJAFile(w.Settings.Defaults.CalibratePath),w.Settings.Defaults.CalibrateDifficulty)end;local Fc={Timing=nil,Music=nil}local Gc=Ec.Metadata.SONG;Ec.Metadata.SONG=nil;local Hc=Taiko.CalibrateParsed(Ec)Ec.Metadata.SONG=Gc;Gc=nil;local Ic=0.00001;for i=1,#Ec.Data do local Kc=Ec.Data[i]Kc.oscrollx=Kc.scrollx;Kc.oscrolly=Kc.scrolly;Kc.scrollx=Ic;Kc.scrolly=Ic end;local Jc=Taiko.CalibrateParsed(Ec)for i=1,#Ec.Data do local Kc=Ec.Data[i]Kc.scrollx=Kc.oscrollx;Kc.scrolly=Kc.oscrolly;Kc.oscrollx=nil;Kc.oscrolly=nil end;Fc.Timing=Hc.average;Fc.Music=Jc.average;require'ppp'(Fc)return Fc end;function Taiko.Play(Ec)while true do local Fc,Gc=Taiko.PlaySong(Ec)if Fc==true then break elseif Fc==false then elseif Fc==nil then break else end end end;function Taiko.Parse(Ec)local Fc,Gc=Taiko.ParseTJAFile(Ec)if Fc then return Fc else I('Taiko.ParseTJA Error: '..Gc)return nil end end;return Taiko.SongSelect()end;Taiko.Game()function Taiko.SongSelectOld(u,v,w)local x={}local y,z=10,10;local A,B,C,D=-y,y,-z,z;local E=true;local F=1;local G=1;local H=4;local I=5;local J=5;local K=2;local L='V'local M='>'local N=10;local O=nil;local P='>'local Q='>'local R=2;local S=true;local T='_Original_'local U=w or{}local V=false;local W={[2]={'Normal','Auto'},[3]={'Normal','2x Speed','3x Speed','4x Speed','0.25x Speed','0.5x Speed','0.75x Speed'},[4]={'Normal','2x Speed','3x Speed','4x Speed','0.25x Speed','0.5x Speed','0.75x Speed'},[5]={'Normal','Reverse','Invisible','Messy'}}local X={4,1,1,1,1,1}local Y={nil}for ub,vb in pairs(W)do Y[ub]={1,#vb,vb}end;local Z={[1]=nil,[2]={function(ub)return ub,'type',ub.type and(Taiko.Data.Notes.ReverseNotes[ub.type]or ub.type)or ub.type end,function(ub)return ub,'type'end},[3]={function(ub)return ub,'scrollx',10000 end,function(ub)return ub,'scrollx'end},[4]={function(ub)return ub,'type',ub.type and(ub.type==1 and math.random(1,2)or ub.type==2 and math.random(1,2)or ub.type==3 and math.random(3,4)or ub.type==4 and math.random(3,4)or ub.type)end,function(ub)return ub,'type'end}}local ab={window=curses.initscr()}curses.keypad(ab,true)curses.echo(false)curses.raw(true)curses.nl(false)curses.cbreak(true)curses.nodelay(ab,true)curses.getch(ab)curses.nodelay(ab,false)local bb,cb=curses.cols(),curses.lines()O=O or bb-2;local db={Escape={['\27']=true,ALT_ESC=true},Scroll={L={KEY_LEFT=true,KEY_SLEFT=true,CTL_LEFT=true,KEY_B1=true,ALT_LEFT=true,KEY_SHIFT_L=true,KEY_UP=true,KEY_A2=true},R={KEY_RIGHT=true,KEY_SRIGHT=true,CTL_RIGHT=true,KEY_B3=true,ALT_RIGHT=true,KEY_SHIFT_R=true,KEY_DOWN=true,KEY_C2=true}},Select={Init={KEY_ENTER=true,PADENTER=true,CTL_PADENTER=true,ALT_PADENTER=true,CTL_PADCENTER=true,ALT_ENTER=true,CTL_ENTER=true,SHF_PADENTER=true,['\n']=true,['\r']=true},Select={KEY_ENTER=true,PADENTER=true,CTL_PADENTER=true,ALT_PADENTER=true,CTL_PADCENTER=true,ALT_ENTER=true,CTL_ENTER=true,SHF_PADENTER=true,['\n']=true,['\r']=true},Escape={['\27']=true,ALT_ESC=true},L={KEY_LEFT=true,KEY_SLEFT=true,CTL_LEFT=true,KEY_B1=true,ALT_LEFT=true,KEY_SHIFT_L=true},R={KEY_RIGHT=true,KEY_SRIGHT=true,CTL_RIGHT=true,KEY_B3=true,ALT_RIGHT=true,KEY_SHIFT_R=true},U={KEY_UP=true,KEY_A2=true},D={KEY_DOWN=true,KEY_C2=true},Play={Hit={['4']=2,['v']=1,['n']=1,['8']=2},Escape={['\27']=true,ALT_ESC=true},L={KEY_LEFT=true,KEY_SLEFT=true,CTL_LEFT=true,KEY_B1=true,ALT_LEFT=true,KEY_SHIFT_L=true,KEY_UP=true,KEY_DOWN=true},R={KEY_RIGHT=true,KEY_SRIGHT=true,CTL_RIGHT=true,KEY_B3=true,ALT_RIGHT=true,KEY_SHIFT_R=true,KEY_DOWN=true,KEY_C2=true},Select={KEY_ENTER=true,PADENTER=true,CTL_PADENTER=true,ALT_PADENTER=true,CTL_PADCENTER=true,ALT_ENTER=true,CTL_ENTER=true,SHF_PADENTER=true,['\n']=true,['\r']=true}}},Search={Init={ALT_F=true,f=true,F=true},Backspace={['\8']=true,KEY_BACKSPACE=true,ALT_BKSP,CTL_BKSP},FirstResult={KEY_ENTER=true,PADENTER=true,CTL_PADENTER=true,ALT_PADENTER=true,CTL_PADCENTER=true,ALT_ENTER=true,CTL_ENTER=true,SHF_PADENTER=true,['\n']=true,['\r']=true},Select={KEY_RIGHT=true,KEY_SRIGHT=true,CTL_RIGHT=true,KEY_B3=true,ALT_RIGHT=true,KEY_SHIFT_R=true},Up={KEY_A2=true,KEY_UP=true},Down={KEY_C2=true,KEY_DOWN=true},Escape={['\27']=true,ALT_ESC=true}},Add={Init={ALT_N=true,n=true,N=true},Backspace={['\8']=true,KEY_BACKSPACE=true,ALT_BKSP,CTL_BKSP},Select={KEY_ENTER=true,PADENTER=true,CTL_PADENTER=true,ALT_PADENTER=true,CTL_PADCENTER=true,ALT_ENTER=true,CTL_ENTER=true,SHF_PADENTER=true,['\n']=true,['\r']=true}},StandardInput={Backspace={['\8']=true,KEY_BACKSPACE=true,ALT_BKSP,CTL_BKSP},Escape={KEY_ENTER=true,PADENTER=true,CTL_PADENTER=true,ALT_PADENTER=true,CTL_PADCENTER=true,ALT_ENTER=true,CTL_ENTER=true,SHF_PADENTER=true,['\n']=true,['\r']=true},L={KEY_LEFT=true,KEY_SLEFT=true,CTL_LEFT=true,KEY_B1=true,ALT_LEFT=true,KEY_SHIFT_L=true,KEY_UP=true,KEY_DOWN=true},R={KEY_RIGHT=true,KEY_SRIGHT=true,CTL_RIGHT=true,KEY_B3=true,ALT_RIGHT=true,KEY_SHIFT_R=true,KEY_DOWN=true,KEY_C2=true}},Reload={Init={r=true}},ReloadAll={Init={R=true}},Rename={Init={KEY_F2=true}}}local eb={ClearScreen=function()io.write("\27[2J")end,SetCursor=function(ub,vb)io.write(string.format("\27[%d;%dH",vb,ub))end,ClearLine=function()io.write("\27[2K")end,CursorLeft=function(ub)io.write(string.format("\27[%dD",ub))end,CursorRight=function(ub)io.write(string.format("\27[%dC",ub))end,SaveCursor=function()io.write("\27[s")end,RestoreCursor=function()io.write("\27[u")end}local function fb(ub)return ub..string.rep(' ',O-#ub)end;local function gb()local ub=curses.getch(ab)local vb=curses.getkeyname(ub)return ub,vb end;local function hb()local ub=''local vb=0;local wb=vb;while true do local xb,yb=gb()if db.StandardInput.Backspace[yb]then ub=string.sub(ub,1,vb-1)..string.sub(ub,vb+1,-1)vb=vb-1 elseif db.StandardInput.Escape[yb]then io.write('\n')return ub elseif db.StandardInput.L[yb]then vb=vb-1 elseif db.StandardInput.R[yb]then vb=vb+1 else ub=string.sub(ub,1,vb)..yb..string.sub(ub,vb+1,-1)vb=vb+1 end;vb=ClipN(vb,0,#ub)local zb=vb-wb;if zb<0 then eb.CursorLeft(-zb)elseif zb>0 then eb.CursorRight(zb)end;eb.SaveCursor()eb.ClearLine()io.write('\r')io.write(ub)eb.RestoreCursor()wb=vb end end;local function ib(ub)return ub>=32 and ub<=126 end;local function jb(ub,vb,wb,xb)return(ub and(vb..string.sub(wb,#vb+1,-1))or wb)..xb end;local function kb(ub,vb,wb)return ub>wb and vb or ub<vb and wb or ub end;local lb={[0]='No',[1]='Yes'}local function mb(ub)return ub and lb[1]or lb[0]end;local function nb(ub)return ub*100 ..'%'end;local function ob(ub)return MsToS(ub)..'s'end;local function pb(ub)return ob(SToMs(ub))end;local function qb(ub)return tonumber(ub)and tonumber(ub)or 0 end;local function rb(ub,vb,wb)ub[T..vb]=ub[vb]ub[vb]=wb end;local function sb(ub,vb)ub[vb]=ub[T..vb]end;local tb={}eb.ClearScreen()while true do x={}if E then x[A]={}for i=F-I,F+I do local yb=nil;if i<1 then yb=#u+i elseif i>#u then yb=i-#u else yb=i end;local zb=u[yb]if zb then x[0]=x[0]or{}x[0][(i-F)*J]=zb end end;local wb={}local xb=string.rep(' ',K)for y=C,D do wb[#wb+1]=jb(y==0,M,xb,'')wb[#wb+1]=fb(x[0]and x[0][y]or'')wb[#wb+1]='\n'end;eb.SetCursor(1,1)print(table.concat(wb))else x[0]={}x[0][C]=L;for i=F-I,F+I do local xb=nil;if i<1 then xb=#u+i elseif i>#u then xb=i-#u else xb=i end;local yb=u[xb]if yb then local zb=(i-F)*J;x[zb]=x[zb]or{}local Ab=C+K;for i2=1,#yb do x[zb][Ab]=string.sub(yb,i2,i2)Ab=Ab+1 end end end;local wb={}for y=C,D do for x=A,B do if x[x]and x[x][y]then local xb=x[x][y]if ib(string.byte(xb))then wb[#wb+1]=xb else wb[#wb+1]=' 'end else wb[#wb+1]=' 'end end;wb[#wb+1]='\n'end;eb.SetCursor(1,1)print(table.concat(wb))end;local ub,vb=gb()if db.Scroll.L[vb]then F=F-1 elseif db.Scroll.R[vb]then F=F+1 elseif db.Select.Init[vb]then local wb;if S then if tb[F]then wb=tb[F]else wb=Taiko.ParseTJA(v[F])tb[F]=wb end else wb=Taiko.ParseTJA(v[F])end;local xb={}for Bb,Cb in pairs(wb)do xb[#xb+1]={Bb,Cb.Metadata.COURSE}end;table.sort(xb,function(Bb,Cb)return Bb[2]<Cb[2]end)min=1;max=#xb;Y[1]={min,max,xb}DifficultyMap=xb;X[1]=ClipN(X[1],min,max)local yb=string.rep(' ',R)eb.ClearScreen()eb.SetCursor(1,1)local zb=nil;local Ab=G;while true do G=ClipN(G,1,5)if G~=Ab then H=X[G]Ab=G end;local Bb=Y[G]min,max=Bb[1],Bb[2]H=kb(H,min,max)X[G]=H;eb.SetCursor(1,1)local Cb=DifficultyMap[X[1]][2]zb=Taiko.GetDifficulty(wb,Cb)local Db=zb.Metadata;local Eb=Taiko.Analyze(zb)local Fb={{'',Db.TITLE},{'\t',Db.SUBTITLE},{'',''},{'','Select Options:'},{jb(G==1,Q,yb,'Difficulty: '),Taiko.Data.CourseName[Db.COURSE]},{jb(G==2,Q,yb,'Mode: '),W[2][X[2]]},{jb(G==3,Q,yb,'Note Speed: '),W[3][X[3]]},{jb(G==4,Q,yb,'Song Speed: '),W[4][X[4]]},{jb(G==5,Q,yb,'Modifiers: '),W[5][X[5]]},{'',''},{'Difficulty: ',Taiko.Data.CourseName[Db.COURSE]},{'Stars: ',Db.LEVEL},{'Diverge Notes: ',mb(Db.DIVERGENOTES)},{'',''},{'','Statistics:'},{'Length: ',ob(Eb.lengthms)},{'Don (DON) / Ka (KA): ',qb(Eb.notes[1])..' + ('..qb(Eb.notes[3])..') / '..qb(Eb.notes[2])..' + ('..qb(Eb.notes[4])..') = '..nb((qb(Eb.notes[1])+qb(Eb.notes[3]))/Eb.notes.validn)..' / '..nb((qb(Eb.notes[2])+qb(Eb.notes[4]))/Eb.notes.validn)},{'Max Score (without drumroll): ',Eb.maxscore},{'Max Combo: ',Eb.maxcombo},{'Drumroll Time (total): ',ob(Eb.drumrollms+Eb.drumrollbigms)},{'Balloon Time: ',ob(Eb.balloonms)},{'Balloon Hits: ',Eb.balloonhit},{'Special Time: ',ob(Eb.specialms)},{'Special Hits: ',Eb.specialhit},{'',''},{'','Press Enter to Play!'}}for i=1,#Fb do local Ib=Fb[i]print(fb(Ib[1]..tostring(Ib[2])))end;local Gb,Hb=gb()if db.Select.L[Hb]then H=H-1 elseif db.Select.R[Hb]then H=H+1 elseif db.Select.U[Hb]then G=G-1 elseif db.Select.D[Hb]then G=G+1 elseif db.Select.Select[Hb]then local Ib=Z[X[5]]if Ib and Ib[1]then local Jb=Ib[1]Taiko.ForAll(zb.Data,function(Kb,Lb,Mb)rb(Jb(Kb))end)end;while true do local Jb,Kb=Taiko.PlaySong(zb,ab,X,db.Select.Play)if Jb and Kb then break elseif Jb=='Retry'then else break end end;curses.nodelay(ab,false)eb.ClearScreen()if Ib and Ib[2]then local Jb=Ib[2]Taiko.ForAll(zb.Data,function(Kb,Lb,Mb)sb(Jb(Kb))end)end elseif db.Select.Escape[Hb]then break end end elseif db.Search.Init[vb]then local wb=''local xb={}local yb=1;local zb=nil;local Ab=1;eb.ClearScreen()eb.SetCursor(1,1)print('Searching...')while true do eb.SetCursor(#wb+1,2)local Bb,Cb=gb()eb.SetCursor(1,2)if db.Search.Backspace[Cb]then wb=string.sub(wb,1,-2)elseif db.Search.FirstResult[Cb]then zb=xb[1]break elseif db.Search.Select[Cb]then zb=xb[Ab]break elseif db.Search.Down[Cb]then Ab=Ab+1 elseif db.Search.Up[Cb]then Ab=Ab-1 elseif db.Search.Escape[Cb]then break else wb=wb..Cb end;print(fb(wb))local Db=Compact.SearchHeaderAll(u,wb)for i=1,N do if Db[i]and Db[i][2]==-math.huge then yb=i-1;break elseif i==N then yb=i end end;Ab=ClipN(Ab,1,yb)local Eb=false;for i=1,N do local Fb=Db[i]if Eb then print(fb(''))else if Fb then if Fb[2]==-math.huge then Eb=true;print(fb(''))else print(fb((i==Ab and P or i)..'. '..Db[i][3]))xb[i]=Fb end end end end end;F=(zb and zb[1]or F)or F elseif db.Add.Init[vb]then print('Import a Custom Song')while true do print('Enter a .tja or .tjac file path (with the file extention)')local wb=hb()local xb=io.open(wb,'rb')if xb then local yb=xb:read('*all')if String.EndsWith(wb,'.tja')then print('Enter a song name')local zb=hb()local Ab=#u+1;u[Ab]=zb;v[Ab]=yb;U[Ab]={wb}break elseif String.EndsWith(wb,'.tjac')then local zb,Ab=Compact.Decompress(yb)for i=1,#zb do local Bb=#u+1;u[Bb]=Ab[i]v[Bb]=zb[i]U[Bb]={wb,zb}end;break else print('Invalid file type')end;xb:close()else print('Unable to read file')end end elseif db.Reload.Init[vb]then print('Reloading selected file...')if U[F]then local wb=U[F]local xb=io.open(wb[1],'rb')if xb then local yb=xb:read('*all')local zb=F;if wb[2]then local Ab,Bb=Compact.Decompress(yb)if V then u[zb]=Bb[i]end;v[zb]=Ab[i]else v[zb]=yb end;if S then tb[zb]=nil end;xb:close()else print('Unable to read file')end else print('File source not found')end elseif db.ReloadAll.Init[vb]then print('Reloading all files...')local wb={}for xb,yb in pairs(U)do wb[yb[1]]=wb[yb[1]]and wb[yb[1]]or{}wb[yb[1]][#wb[yb[1]]+1]={xb,yb[2]}end;for xb,yb in pairs(wb)do local zb=io.open(xb,'rb')if zb then local Ab=zb:read('*all')if yb[1][2]then local Bb,Cb=Compact.Decompress(Ab)for i=1,#yb do local Db=yb[i]if V then u[Db[1]]=Cb[Db[2]]end;v[Db[1]]=Bb[Db[2]]if S then tb[Db[1]]=nil end end else for i=1,#yb do local Bb=yb[i]v[Bb[1]]=Ab;if S then tb[Bb[1]]=nil end end end;zb:close()else print('Unable to read file')end end elseif db.Rename.Init[vb]then print('Enter a song name')local wb=hb()u[F]=wb elseif db.Escape[vb]then return end;F=kb(F,1,#u)end end
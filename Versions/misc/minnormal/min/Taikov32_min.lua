#!.\raylua_s.exe 
local k=require('CompactTJA/compact')local l=require('ReplayTaiko/replayv1')local m=require('Persistent/persistentv1')Split=function(u,v)local w={}for x,y in u:gmatch("([^"..v.."]*)("..v.."?)")do table.insert(w,x)if y==''then return w end end end;Trim=function(u)local v=u:gsub("^%s*(.-)%s*$","%1")return v end;TrimLeft=function(u)local v=u:gsub("^%s*(.-)$","%1")return v end;TrimRight=function(u)local v=u:gsub("^(.-)%s*$","%1")return v end;StartsWith=function(u,v)return u:sub(1,#v)==v end;EndsWith=function(u,v)return u:sub(-#v,-1)==v end;Table={}function Table.Clone(u,v)v=v or{}local w=type(u)local x;if w=='table'then if v[u]then x=v[u]else x={}v[u]=x;for y,z in next,u,nil do x[Table.Clone(y,v)]=Table.Clone(z,v)end;setmetatable(x,Table.Clone(getmetatable(u),v))end else x=u end;return x end;ClipN=function(u,v,w)if u<v then return v elseif u>w then return w else return u end end;function Error(u)error(u)end;LineN=nil;function ParseError(u,v,w)Error('Line: '..LineN..'\n'..u..': '..v.. (w and(', '..w)or''))end;function MsToS(u)return u/1000 end;function SToMs(u)return u*1000 end;Taiko={}Taiko.Data={Languages={'','EN','JA','CN','TW','KO'},GenreName={Pop={'pop','j-pop'},Anime={'anime','アニメ'},Kids={'kids','どうよう'},Variety={'variety','バラエティ'},VOCALOID={'vocaloid','ボーカロイド'},Classic={'classic','クラシック'},['Game Music']={'game music','ゲームミュージック'},['Namco Original']={'namco original','ナムコオリジナル'}},CourseId={easy=0,normal=1,hard=2,oni=3,edit=4,tower=5,dan=6,ura=4},CourseName={[0]='Easy','Normal','Hard','Oni','Edit','Tower','Dan','Ura'},RatingMultiplier={[0]=0,[1]=0.5,[2]=1,[3]=2},GogoMultiplier=1.2,ScoreMode={Note={[0]=function(u,v,w,x,y,z)return u+ ( ( (v<200)and(w or 1000)or( (w or 1000)+ (x or 1000)))*Taiko.Data.RatingMultiplier[y]* (z and Taiko.Data.GogoMultiplier or 1))end,[1]=function(u,v,w,x,y,z)return u+ ( (w+math.max(0,x*math.floor((math.min(v,100)-1)/10)))*Taiko.Data.RatingMultiplier[y]* (z and Taiko.Data.GogoMultiplier or 1))end,[2]=function(u,v,w,x,y,z)return math.floor((u+ ( (w+x* ( (v>=100)and 8 or(v>=50)and 4 or(v>=30)and 2 or(v>=10)and 1 or 0))*Taiko.Data.RatingMultiplier[y]* (z and Taiko.Data.GogoMultiplier or 1)))/10)*10 end},Drumroll={[0]=function(u,v,w)return u+ ( (v==5 and 300 or v==6 and 600)* (w and Taiko.Data.GogoMultiplier or 1))end,[1]=function(u,v,w)return u+ ( (v==5 and 300 or v==6 and 600)* (w and Taiko.Data.GogoMultiplier or 1))end,[2]=function(u,v,w)return u+ ( (v==5 and 100 or v==6 and 200)* (w and Taiko.Data.GogoMultiplier or 1))end},Balloon={[0]=function(u,v,w)return u+ ( (v==7 and 300)* (w and Taiko.Data.GogoMultiplier or 1))end,[1]=function(u,v,w)return u+ ( (v==7 and 300)* (w and Taiko.Data.GogoMultiplier or 1))end,[2]=function(u,v,w)return u+ ( (v==7 and 300)* (w and Taiko.Data.GogoMultiplier or 1))end},BalloonPop={[0]=function(u,v,w)return u+ ( (v==7 and 5000)* (w and Taiko.Data.GogoMultiplier or 1))end,[1]=function(u,v,w)return u+ ( (v==7 and 5000)* (w and Taiko.Data.GogoMultiplier or 1))end,[2]=function(u,v,w)return u+ ( (v==7 and 5000)* (w and Taiko.Data.GogoMultiplier or 1))end}},Autoscore={[0]=function(u)end,[1]=function(u)end,[2]=function(u)end},SideId={normal=1,ex=2,both=3},SideName={'normal','ex','both'},StyleId={single=1,double=2,couple=2},StyleName={'single','double'},Exam={Condition={g=true,jp=true,jg=true,jb=true,s=true,r=true,h=true,c=true},Scope={m=true,l=true}},Branch={PathId={N=0,E=1,M=2},PathName={[0]='N',[1]='E',[2]='M'},Requirements={r=function()end,p=function()end}},Timing={GetFunction=function(u)return function(v)if u==0 or u==1 then return{good=5 /2 *v,ok=13 /2 *v,bad=15 /2 *v}else return{good=3 /2 *v,ok=9 /2 *v,bad=13 /2 *v}end end end},StatusId={bad=0,ok=1,good=2,biggood=3},StatusName={[0]='BAD',[1]='OK',[2]='GOOD',[3]='GOOD'},ModeId={['']=0,P1=1,P2=2},ModeName={[0]='',P1,P2},Combo={[1]=true,[2]=true,[3]=true,[4]=true},BigLeniency=2,Gauge={Soul={[0]=function(u)local v=10000 /u*1.575;local w=v*0.75;local x=v/-2;return{[2]=v,[1]=w,[0]=x}end,[1]=function(u)local v=10000 /u/0.7;local w=v*0.75;local x=v/-0.75;return{[2]=v,[1]=w,[0]=x}end,[2]=function(u)local v=10000 /u*1.5;local w=v*0.75;local x=v/-0.8;return{[2]=v,[1]=w,[0]=x}end,[3]=function(u)local v=10000 /u/0.7;local w=v*0.5;local x=v*-1.6;return{[2]=v,[1]=w,[0]=x}end,[4]=function(u)local v=10000 /u/0.7;local w=v*0.5;local x=v*-1.6;return{[2]=v,[1]=w,[0]=x}end},Percent=function(u)return(u/200)/50 end,ClearPercent=0.8,OverflowPercent=1},Notes={ReverseNotes={[0]=0,[1]=2,[2]=1,[3]=4,[4]=3,[5]=5,[6]=6,[7]=7,[8]=8,[9]=9}},BigNoteMul=1.5,Strings={Notes={}}}function Taiko.ParseTJA(u)local v=os.clock()local w=true;local x=true;local y=true;local z={}local A={Flag={PARSER_FORCE_OLD_SPEED_CALCULATION=false,PARSER_FORCE_OLD_NOTERADIUS=false,PARSER_FORCE_OLD_TARGET=false},Metadata={SUBTITLE='',BPM=120,WAVE='main.mp3',OFFSET=0,DEMOSTART=0,SCOREMODE=1,SONGVOL=100,SEVOL=100,SIDE=3,LIFE=0,GAME='Taiko',HEADSCROLL=1,MOVIEOFFSET=0,COURSE='ONI',LEVEL=0,BALLOON=nil,SCOREINIT,SCOREDIFF,BALLOONNOR=nil,BALLOONEXP=nil,BALLOONMAS=nil,STYLE=1,EXAM1=nil,EXAM2=nil,EXAM3=nil,GAUGEINCR='NORMAL',TOTAL=nil,HIDDENBRANCH=0,DIVERGENOTES=false,SCOREINIT=0,SCOREDIFF=0,STOPSONG=false},Data={}}if string.find(u,'$PARSER_FORCE_OLD_SPEED_CALCULATION')then A.Flag.PARSER_FORCE_OLD_SPEED_CALCULATION=true elseif string.find(u,'$PARSER_FORCE_OPENTAIKO_SPEED_CALCULATION')then else end;if string.find(u,'$PARSER_FORCE_OLD_NOTERADIUS')then A.Flag.PARSER_FORCE_OLD_NOTERADIUS=true else end;if string.find(u,'$PARSER_FORCE_OLD_TARGET')then A.Flag.PARSER_FORCE_OLD_TARGET=true end;local function B(X)local Y=Taiko.Data.Languages;for i=1,#Y do local Z=A.Metadata[X..Y[i]]if Z then return Z end end;return nil end;local function C(X,Y,Z)local ab=tonumber(Y)if ab then return ab else ParseError(X,Z,Y)end end;local function D(X,Y,Z,ab)if Y then return Y else ParseError(X,Z,ab)end end;local function E(X,Y,Z)local ab={['true']=true,['false']=false,yes=true,no=false,['1']=true,['0']=false,[1]=true,[0]=false}local bb=ab[Y]~=nil;if bb then return bb else ParseError(X,Z,Y)end end;local function F(X,Y)local Z=','local ab='\\'local bb={}local cb=''local db=false;for i=1,#Y do local eb=string.sub(Y,i,i)if db then cb=cb..eb;db=false else if eb==Z then table.insert(bb,cb)cb=''elseif eb==ab then db=true else cb=cb..eb end end end;table.insert(bb,cb)return bb end;local function G(X,Y,Z)local ab=F(X,Y)for i=1,#ab do ab[i]=C(X,ab[i],Z,Y)end;return ab end;local function H(X,Y,Z)if Y and Y~=''then return G(X,Y,Z)else return{}end end;local function I(X,Y,Z)if Y and Y~=''then local ab=F(X,Y,Z)D(X,Taiko.Data.Exam.Condition[ab[1]],Z)ab[2]=C(X,ab[2],Z)ab[3]=C(X,ab[3],Z)D(X,Taiko.Data.Exam.Scope[ab[4]],Z)return ab else return{}end end;local J=error;local function K(X)return string.find(X,'/')end;local function L(X)return string.match(X,'(%d+)/(%d+)')end;local function M(X)local Y=nil;local Z=false;local ab=''for i=1,#X do local bb=string.sub(X,i,i)if bb=='+'or bb=='-'then if Y then J('There are multiple signs')else Y=bb end elseif bb=='.'then if Z then J('There are multiple decimal points')else ab=ab..bb;Z=true end elseif tonumber(bb)then ab=ab..bb end end;if ab==''then J('No number was found')end;return tonumber((Y or'+')..ab)end;local function N(X)local Y=tonumber(X)if Y then return Y end;local Z=string.gsub(X,'[^%d%.%-%+]','')if Z==''then return 0 end;return tonumber(Z)or M(X)or M(Z)end;local function O(X)return string.find(X,'i')end;local function P(X)local Y={0,0}local Z=false;local ab=''for i=1,#X do local bb=string.sub(X,i,i)if bb=='+'or bb=='-'then Y[1]=Y[1]+N(ab)ab=bb elseif bb=='i'then Y[2]=Y[2]+N(ab)ab=''else ab=ab..bb end end;if ab~=''then Y[1]=Y[1]+N(ab)end;return Y end;local function Q(X)local Y=Split(X,'%+')local Z={}for i=1,#Y do local cb=Split(Y[i],'%-')for i=1,#cb do if i==1 then Z[#Z+1]=cb[i]else Z[#Z+1]='-'..cb[i]end end end;Y=Z;local ab={0,0}local bb={false,false}for i=1,#Y do if Y[i]~=''then local cb=false;if string.find(Y[i],'i')then cb=true;Y[i]=string.gsub(Y[i],'i','')end;if K(Y[i])then local db=false;if string.find(Y[i],'%-')then db=true end;local eb,fb=L(Y[i])Y[i]=(eb/fb)bb[cb and 2 or 1]=true;if db then Y[i]=-Y[i]end else Y[i]=tonumber(Y[i])end;if cb then ab[2]=ab[2]+Y[i]else ab[1]=ab[1]+Y[i]end end end;return ab,bb end;local function R(X)return string.find(X,',')end;local function S(X,Y)return{X*math.cos(Y),X*math.sin(Y)}end;local function T(X)return Split(X,' ')end;local U={}local function V()local X={settings={noteparse={notes={[0]=true,[1]=true,[2]=true,[3]=true,[4]=true,[5]=true,[6]=true,[7]=true,[8]=true,[9]=true,['A']=true,['B']=true}},command={matchexceptions={}},directionweight={R=0,U=90,L=180,D=270,['0']=0,['1']=90,['2']=270,['3']=45,['4']=315,['5']=180,['6']=135,['7']=225}},bpm=0,ms=0,songstarted=false,timingpoint=nil,sign=4 /4,mpm=0,mspermeasure=0,scroll=1,scrollx=-1,scrolly=0,measuredone=true,currentmeasure={},measurepushto=A.Data,barline=true,insertbarline=true,gogo=false,lastlong=nil,balloonn=1,currentbranch=nil,branch={on=false,requirements={},paths={}},msbeforebranch=nil,section=false,disablescroll=false,stopsong=false,delay=0,suddenappear=nil,suddenmove=nil,notechain={},jposscroll={lengthms=nil,p=nil,lanep=nil},zeroopt=w}function X.createnote(Y)if Y then local Z={ms=nil,data=nil,type=Y,txt=nil,gogo=X.gogo,scroll=(X.scroll*A.Metadata.HEADSCROLL),scrollx=(X.scrollx*A.Metadata.HEADSCROLL),scrolly=(X.scrolly*A.Metadata.HEADSCROLL),mspermeasure=X.mspermeasure,bpm=X.bpm,nextnote=nil,radius=1,requiredhits=nil,lengthms=nil,endnote=nil,section=nil,text=nil,delay=X.delay,appearancems=X.suddenappear,movems=X.suddenmove,dummy=X.dummy,onnotepush=nil,currentbranch=X.currentbranch,line=LineN}if Y==3 or Y==4 or Y==6 then Z.radius=Z.radius*Taiko.Data.BigNoteMul end;if Y==5 or Y==6 or Y==7 or Y==9 then if X.lastlong then if Y==9 then else ParseError('parser.noteparse','Last long note has not ended')end else X.lastlong=Z;if Y==7 or Y==9 then Z.requiredhits=D('parser.noteparse',A.Metadata.BALLOON[X.balloonn],'Invalid number of balloons',X.balloonn)X.balloonn=X.balloonn+1 end end end;if Y==8 then local ab=X.lastlong;X.lastlong=nil;Z.startnote=ab;if ab then Z.onnotepush=function()ab.lengthms=Z.ms-ab.ms;ab.endnote=Z end else end end;if X.section then Z.section=true;X.section=false end;return Z else return{ms=nil,data=nil,type=nil,txt=nil,gogo=X.gogo,scroll=(X.scroll*A.Metadata.HEADSCROLL),scrollx=(X.scrollx*A.Metadata.HEADSCROLL),scrolly=(X.scrolly*A.Metadata.HEADSCROLL),mspermeasure=X.mspermeasure,bpm=X.bpm,nextnote=nil,delay=X.delay,appearancems=X.suddenappear,movems=X.suddenmove,currentbranch=X.currentbranch,line=LineN}end end;function X.createbarline()local Y=X.createnote()Y.ms=X.ms;Y.data='event'Y.event='barline'return Y end;function X.endbranch()local Y=X.createnote()Y.data='event'Y.event='branch'Y.branch={requirements=X.branch.requirements,paths=X.branch.paths}X.branch.on=false;X.currentbranch=nil;X.branch.requirements={}X.branch.paths={}table.insert(A.Data,Y)X.measurepushto=A.Data end;return X end;U=V()local W=Split(u,'\n')for i=1,#W do LineN=i;local X=Trim(W[i])if StartsWith(X,'//')or X==''then else local Y=string.find(X,'//')if Y then X=string.sub(X,1,Y-1)end;local Z=false;if U.songstarted==false and Z==false then local ab={string.match(X,'(%u+):(.*)')}if ab[1]then local bb=Trim(ab[2])if bb~=''then A.Metadata[Trim(ab[1])]=bb end;Z=true end end;if(U.songstarted or StartsWith(X,'#START')or StartsWith(X,'#BMSCROLL')or StartsWith(X,'#HBSCROLL'))and Z==false then local ab={string.match(X,'#(%u-)%s(.*)')}if not ab[1]then ab={string.match(X,'#(%u+)')}end;if ab[1]then if ab[1]=='START'then if U.songstarted then ParseError(ab[1],'Song has already started')else A.OriginalMetadata=Table.Clone(A.Metadata)if ab[2]then A.Metadata.MODE=D(ab[1],Taiko.Data.ModeId[ab[2]],'Invalid mode',ab[2])else A.Metadata.MODE=0 end;A.Metadata.TITLE=D(ab[1],B('TITLE'),'Title is missing')A.Metadata.SUBTITLE=D(ab[1],B('SUBTITLE'),'Subtitle is missing')A.Metadata.BPM=C(ab[1],A.Metadata.BPM,'Invalid bpm')A.Metadata.OFFSET=SToMs(C(ab[1],A.Metadata.OFFSET,'Invalid offset'))A.Metadata.DEMOSTART=SToMs(C(ab[1],A.Metadata.DEMOSTART,'Invalid demostart'))if A.Metadata.DEMOSTART==0 then A.Metadata.DEMOSTART=nil end;for eb,fb in pairs(Taiko.Data.GenreName)do for i=1,#fb do if fb[i]==A.Metadata.GENRE then A.Metadata.GENRE=eb end end end;A.Metadata.SCOREMODE=C(ab[1],A.Metadata.SCOREMODE,'Invalid scoremode')D(ab[1],Taiko.Data.ScoreMode.Note[A.Metadata.SCOREMODE],'Invalid scoremode',A.Metadata.SCOREMODE)if A.Metadata.MAKER then A.Metadata.CREATORURLT={}A.Metadata.CREATOR=Trim(string.gsub(A.Metadata.MAKER,'(<.->)',function(eb)table.insert(A.Metadata.CREATORURLT,string.sub(eb,2,-2))return''end))A.Metadata.CREATORURL=table.concat(A.Metadata.CREATORURLT,', ')A.Metadata.CREATIVE=false else A.Metadata.CREATIVE=false end;A.Metadata.SONGVOL=C(ab[1],A.Metadata.SONGVOL,'Invalid songvol')/100;A.Metadata.SEVOL=C(ab[1],A.Metadata.SEVOL,'Invalid sevol')/100 /2;local bb=tonumber(A.Metadata.SIDE)if bb then D(ab[1],Taiko.Data.SideName[bb],'Invalid side id',A.Metadata.SIDE)A.Metadata.SIDE=bb else A.Metadata.SIDE=D(ab[1],Taiko.Data.SideId[string.lower(A.Metadata.SIDE)],'Invalid side name',A.Metadata.SIDE)end;A.Metadata.LIFE=C(ab[1],A.Metadata.LIFE,'Invalid life')if A.Metadata.LIFE==0 then A.Metadata.LIFE=nil end;A.Metadata.GAME=string.lower(A.Metadata.GAME)if A.Metadata.GAME=='taiko'then elseif A.Metadata.GAME=='jube'then else end;A.Metadata.HEADSCROLL=C(ab[1],A.Metadata.HEADSCROLL,'Invalid headscroll')A.Metadata.MOVIEOFFSET=C(ab[1],A.Metadata.MOVIEOFFSET,'Invalid movieoffset')local cb=tonumber(A.Metadata.COURSE)if cb then D(ab[1],Taiko.Data.CourseName[cb],'Invalid course id',A.Metadata.COURSE)A.Metadata.COURSE=cb else A.Metadata.COURSE=D(ab[1],Taiko.Data.CourseId[string.lower(A.Metadata.COURSE)],'Invalid course name',A.Metadata.COURSE)end;A.Metadata.TIMING=Taiko.Data.Timing.GetFunction(A.Metadata.COURSE)A.Metadata.LEVEL=ClipN(math.floor(C(ab[1],A.Metadata.LEVEL,'Invalid level')),0,10)A.Metadata.BALLOON=H(ab[1],A.Metadata.BALLOON,'Invalid balloon')A.Metadata.SCOREINIT=C(ab[1],A.Metadata.SCOREINIT,'Invalid scoreinit')A.Metadata.SCOREDIFF=C(ab[1],A.Metadata.SCOREDIFF,'Invalid scoreinit')A.Metadata.BALLOONNOR=H(ab[1],A.Metadata.BALLOONNOR,'Invalid balloonnor')A.Metadata.BALLOONEXP=H(ab[1],A.Metadata.BALLOONEXP,'Invalid balloonexp')A.Metadata.BALLOONMAS=H(ab[1],A.Metadata.BALLOONMAS,'Invalid balloonmas')local db=tonumber(A.Metadata.STYLE)if db then D(ab[1],Taiko.Data.StyleName[db],'Invalid style id',Taiko.Data.STYLE)A.Metadata.STYLE=db else A.Metadata.STYLE=D(ab[1],Taiko.Data.StyleId[string.lower(A.Metadata.STYLE)],'Invalid style name',A.Metadata.STYLE)end;A.Metadata.EXAM1=I(A.Metadata.EXAM1)A.Metadata.EXAM2=I(A.Metadata.EXAM2)A.Metadata.EXAM3=I(A.Metadata.EXAM3)A.Metadata.GAUGEINCR=string.lower(A.Metadata.GAUGEINCR)if A.Metadata.TOTAL then A.Metadata.TOTAL=C(ab[1],A.Metadata.TOTAL,'Invalid total')end;A.Metadata.HIDDENBRANCH=E(ab[1],A.Metadata.HIDDENBRANCH,'Invalid hiddenbranch')U.bpm=A.Metadata.BPM;U.songstarted=true end elseif ab[1]=='END'then if U.songstarted then if#U.currentmeasure~=0 then ParseError(ab[1],'Current measure is not empty')end;table.insert(z,A)A={Flag=A.Flag,Metadata=Table.Clone(A.OriginalMetadata),Data={}}U=V()U.songstarted=false;U.measurepushto=A.Data else ParseError(ab[1],'Song has already ended')end elseif ab[1]=='MEASURE'then local bb,cb=L(ab[2])bb=C(ab[1],bb,'Invalid measure')cb=C(ab[1],cb,'Invalid measure')U.sign=(bb/cb)or U.sign elseif ab[1]=='BPMCHANGE'then U.bpm=C(ab[1],ab[2],'Invalid bpmchange')or U.bpm elseif ab[1]=='DELAY'then local bb=SToMs((C(ab[1],ab[2],'Invalid delay')or 0))if A.Metadata.STOPSONG then U.delay=U.delay+bb;U.zeroopt=false end;table.insert(U.currentmeasure,{'DELAY',bb})elseif ab[1]=='SCROLL'then if U.disablescroll then else if x and O(ab[2])then local bb=P(ab[2])U.scrollx=-bb[1]U.scrolly=-bb[2]elseif x and R(ab[2])then local bb=G(ab[1],ab[2],'Invalid polar scroll')if#bb==3 then local cb=S(bb[1],math.rad(bb[3]/bb[2]*360))U.scrollx=-cb[1]U.scrolly=-cb[2]else ParseError(ab[1],'Invalid polar scroll')end else U.scrollx=- (C(ab[1],ab[2],'Invalid scroll')or-U.scrollx)U.scrolly=0 end;U.scroll=-U.scrollx;if U.scroll==0 and U.scrollx==0 and U.scrolly==0 then ParseError(ab[1],'Scroll cannot be 0')end end elseif ab[1]=='GOGOSTART'then U.gogo=true elseif ab[1]=='GOGOEND'then U.gogo=false elseif ab[1]=='BARLINEOFF'then U.barline=false elseif ab[1]=='BARLINEON'then U.barline=true elseif ab[1]=='BRANCHSTART'then if U.branch.on then U.endbranch()end;U.msbeforebranch=U.ms;U.branch.on=true;A.Metadata.DIVERGENOTES=true;local bb=F(ab[1],ab[2])local cb=D(ab[1],Taiko.Data.Branch.Requirements[string.lower(bb[1])],'Invalid type',bb[1])U.branch.requirements={cb}local db=2;while true do if not bb[db]then break end;local eb=Taiko.Data.Branch.PathName[db-1]if eb then U.branch.requirements[eb]=bb[db]else break end;db=db+1 end elseif Taiko.Data.Branch.PathId[ab[1]]then if U.branch.on then U.ms=U.msbeforebranch;U.currentbranch=ab[1]U.branch.paths[ab[1]]={}U.measurepushto=U.branch.paths[ab[1]]else ParseError(ab[1],'Branch has not started')end elseif ab[1]=='BRANCHEND'then if U.branch.on then U.endbranch()else ParseError(ab[1],'Branch has already ended')end elseif ab[1]=='SECTION'then U.section=true elseif ab[1]=='LYRIC'then elseif ab[1]=='LEVELHOLD'then elseif ab[1]=='BMSCROLL'then U.disablescroll=true;A.Metadata.STOPSONG=true elseif ab[1]=='HBSCROLL'then A.Metadata.STOPSONG=true elseif ab[1]=='SENOTECHANGE'then elseif ab[1]=='NEXTSONG'then elseif ab[1]=='DIRECTION'then local bb=ab[2]local cb=U.settings.directionweight;local db=0;local eb=0;for i=1,#bb do local ib=string.sub(bb,i,i)if cb[ib]then db=db+cb[ib]eb=eb+1 end end;if eb==0 then ParseError(ab[1],'Invalid direction')end;local fb=db/eb;local gb=math.sqrt(U.scrollx^2 +U.scrolly^2)local hb=S(gb,math.rad(fb))U.scrollx=-hb[1]U.scrolly=-hb[2]elseif ab[1]=='SUDDEN'then local bb=T(ab[2])U.suddenappear=SToMs(C(ab[1],bb[1],'Invalid sudden')or(U.suddenappear and MsToS(U.suddenappear)or 0))U.suddenmove=SToMs(C(ab[1],bb[2],'Invalid sudden')or(U.suddenmove and MsToS(U.suddenmove)or 0))elseif ab[1]=='JPOSSCROLL'then U.zeroopt=false;local bb=false;local cb=T(ab[2])local function db(eb,fb,gb,hb)if(x and K(fb))or(hb)then U.jposscroll.lanep=U.jposscroll.lanep or{nil,nil}if K(fb)then local ib,jb=L(fb)ib=C(ab[1],ib,'Invalid jposscroll')jb=C(ab[1],jb,'Invalid jposscroll')U.jposscroll.lanep[eb]=(ib/jb)else U.jposscroll.lanep[eb]=fb end;if gb then U.jposscroll.lanep[1]=U.jposscroll.lanep[1]* (D(ab[1],gb=='1'and 1 or gb=='0'and-1,'Invalid jposscroll',gb)or 1)end elseif x and fb=='default'then U.jposscroll.p='default'else U.jposscroll.p=U.jposscroll.p or{nil,nil}U.jposscroll.p[eb]=C(ab[1],fb,'Invalid jposscroll')if gb then U.jposscroll.p[eb]=U.jposscroll.p[eb]* (D(ab[1],gb=='1'and 1 or gb=='0'and-1,'Invalid jposscroll',gb)or 1)end end end;if y then if O(cb[2])then local eb,fb=Q(cb[2])db(1,eb[1],nil,fb[1])db(2,eb[2],nil,fb[2])bb=true elseif R(cb[2])then local eb=F(ab[1],cb[2])if#eb==3 then local fb=false;if K(eb[2])then fb=true;local hb,ib=L(eb[2])hb=C(ab[1],hb,'Invalid polar jposscroll')ib=C(ab[1],ib,'Invalid polar jposscroll')eb[2]=(hb/ib)else eb[2]=C(ab[1],eb[2],'Invalid polar jposscroll')end;eb[1]=C(ab[1],eb[1],'Invalid polar jposscroll')eb[3]=C(ab[1],eb[3],'Invalid polar jposscroll')local gb=S(eb[1],math.rad(eb[3]/eb[2]*360))db(1,gb[1],nil,fb)db(2,gb[2],nil,fb)bb=true else ParseError(ab[1],'Invalid polar jposscroll')end end else end;if bb==false then db(1,cb[2],cb[3])end;U.jposscroll.lengthms=SToMs(C(ab[1],cb[1],'Invalid jposscroll')or 0)table.insert(U.currentmeasure,{'JPOSSCROLL',U.jposscroll})U.jposscroll={}elseif x then if ab[1]=='GAMEMODE'then elseif ab[1]=='SPLITLANE'then elseif ab[1]=='MERGELANE'then elseif ab[1]=='BARLINE'then table.insert(U.measurepushto,U.createbarline())elseif ab[1]=='DUMMYSTART'then U.dummy=true elseif ab[1]=='DUMMYEND'then U.dummy=false elseif ab[1]==''then elseif ab[1]==''then elseif ab[1]==''then elseif ab[1]==''then elseif ab[1]==''then elseif ab[1]==''then elseif ab[1]==''then elseif ab[1]==''then elseif ab[1]==''then elseif ab[1]==''then elseif ab[1]==''then elseif ab[1]==''then elseif ab[1]==''then elseif ab[1]==''then elseif ab[1]==''then elseif ab[1]==''then elseif ab[1]==''then elseif ab[1]=='RESETCOMMAND'then end else end;Z=true end end;if(U.songstarted)and Z==false then U.mpm=U.bpm*U.sign/4;U.mspermeasure=60000 *U.sign*4 /U.bpm;if U.barline and U.insertbarline then table.insert(U.measurepushto,U.createbarline())U.insertbarline=false end;for i=1,#X do local ab=string.sub(X,i,i)local bb=tonumber(ab)or ab;if U.settings.noteparse.notes[bb]then local cb=U.createnote(bb)cb.data='note'table.insert(U.currentmeasure,cb)end end;if EndsWith(TrimRight(X),',')then U.mpm=U.bpm*U.sign/4;U.mspermeasure=60000 *U.sign*4 /U.bpm;if#U.currentmeasure==0 then U.ms=U.ms+U.mspermeasure elseif#U.currentmeasure==1 and U.currentmeasure[1].data=='event'and U.currentmeasure[1].event=='barline'then A.Data[#A.Data+1]=U.currentmeasure[1]U.ms=U.ms+U.mspermeasure else local ab=0;local bb=nil;for i=1,#U.currentmeasure do local eb=U.currentmeasure[i]if eb.data=='note'then bb=bb or eb.mspermeasure;ab=ab+1 end end;bb=bb or U.mspermeasure;local cb=bb/ab;local db=false;for i=1,#U.currentmeasure do local eb=U.currentmeasure[i]if eb[1]=='DELAY'then U.ms=U.ms+eb[2]elseif eb[1]=='JPOSSCROLL'then db=eb[2]else if not U.zeroopt or eb.type~=0 then eb.ms=U.ms;eb.appearancems=eb.appearancems and(eb.ms- (eb.appearancems))eb.movems=eb.movems and(eb.ms- (eb.movems))local fb=U.measurepushto[#U.measurepushto]or A.Data[#A.Data]if fb then fb.nextnote=eb end;table.insert(U.measurepushto,eb)if eb.onnotepush then eb.onnotepush()end;cb=eb.mspermeasure/ab end;if db then eb.jposscroll=db;db=false end;if eb.data=='note'then U.ms=U.ms+cb end end end end;U.measuredone=true;U.currentmeasure={}if nextjposscroll then U.currentmeasure[#U.currentmeasure+1]=nextjposscroll end;U.insertbarline=true;U.zeroopt=w else U.measuredone=false end end end end;print('Parsing Took: '..SToMs(os.clock()-v)..'ms')return z end;function Taiko.ParseTJAFile(u)local v=io.open(u,'r')local w=v:read('*all')local x=Taiko.ParseTJA(w)local y=string.find(u,'[/\\]')for z,A in pairs(x)do A.Metadata.SONG=(y and string.sub(u,1,y)or'')..A.Metadata.WAVE end;return x end;function Taiko.SerializeTJA(u)local function v(G)return math.floor(G+0.5)end;local w=5;local x=10 ^w;local function y(G)return math.floor(G*x+0.5)/x end;local function z(G)if math.floor(G)~=G then return string.format('%f',G)else return tostring(G)end end;local function A(G,H)if G<H then return A(H,G)end;if math.abs(H)<0.001 then return G else return A(H,G-math.floor(G/H)*H)end end;local function B(G)local H=A(G,1)return v(G/H),v(1 /H)end;local function C(G)local H,I=string.match(G,'(%d+)/(%d+)')return H,I end;local function D(G)for i=1,#G do G[i]=tostring(G[i])end;return table.concat(G,',')end;local function E(G)local H={}local I={OFFSET=true,DEMOSTART=true}for R,S in pairs(G.Metadata)do local T;if type(S)=='number'then if I[R]then T=tostring(MsToS(tonumber(S)))else T=tostring(S)end elseif type(S)=='table'then T=D(S)elseif type(S)=='string'then T=tostring(S)else T=nil end;if T then H[#H+1]=R;H[#H+1]=':'H[#H+1]=T;H[#H+1]='\n'end end;H[#H+1]='\n\n'local J=false;local K=false;local L=G.Metadata.HEADSCROLL;for i=1,#G.Data do local R=G.Data[i]R.ms=R.ms-R.delay;if R.data=='event'and R.event=='barline'then J=true end;if R.delay and R.delay~=0 then K=true end;if R.scroll and R.scroll~=L then L=false end end;if K then if L then H[#H+1]='#BMSCROLL\n'else H[#H+1]='#HBSCROLL\n'end end;H[#H+1]='#START\n'if J then H[#H+1]='#BARLINEON\n'else H[#H+1]='#BARLINEOFF\n'end;local M={startms=nil}local N=nil;local O=0;local P={scroll=0,bpm=G.Metadata.BPM,measure=nil,gogo=false,delay=0}local Q={scroll={'#SCROLL ',nil,function(R)local S=R.scroll/G.Metadata.HEADSCROLL;if S~=P.scroll then P.scroll=S;return tostring(S)end end},bpm={'#BPMCHANGE ',tostring(G.Metadata.BPM),function(R)local S=R.bpm;if S~=P.bpm then P.bpm=S;return tostring(S)end end},measure={'#MEASURE ',false,function(R)local S,T=B(R.bpm*R.mspermeasure/240000)local U=S..'/'..T;if U~=P.measure then P.measure=U;return U end end},gogo={'#GOGO',false,function(R)local S=R.gogo;if S~=P.gogo then P.gogo=S;if S then return'START'else return'END'end end end},delay={'#DELAY ',nil,function(R)if R.delay~=P.delay then local S=R.delay-P.delay;P.delay=R.delay;return z(MsToS(S))end end}}for i=1,#G.Data do local R=G.Data[i]local S=R.ms;if R.data=='note'then M[#M+1]=R elseif R.data=='event'and R.event=='barline'then M.startms=R.ms;M[#M+1]=R end;local T=G.Data[i+1]if(T and T.data=='event'and T.event=='barline')or(i==#G.Data)then if#M==0 then error('No barline')else local U={}for i=2,#M do local Y=M[i-1]local Z=M[i]U[#U+1]=math.abs(Z.ms-Y.ms)end;U[#U+1]=math.abs((M.startms+M[1].mspermeasure)-M[#M].ms)local V=U[1]for i=2,#U do V=A(V,U[i])end;if V==nil then error('gcd invalid, probably delay')V=M[1]and(M[1].ms-O)end;local W=M.startms;local X=W+M[1].mspermeasure;for i2=1,#M do local Y=M[i2]for Z,ab in pairs(Q)do if Y[Z]==ab[2]then else local bb=ab[3](Y)if bb then ab[2]=bb;if H[#H]~='\n'then H[#H+1]='\n'end;H[#H+1]=ab[1]H[#H+1]=bb;H[#H+1]='\n'end end end;if i2 ~=1 then H[#H+1]=tostring(Y.type)end;if i2 ==1 and#M~=1 then H[#H+1]=string.rep('0',( (M[i2 +1]and M[i2 +1].ms or X)-Y.ms)/V)else H[#H+1]=string.rep('0',( (M[i2 +1]and M[i2 +1].ms or X)-Y.ms)/V-1)end end;H[#H+1]=','H[#H+1]='\n'M={}end end end;if H[#H]~='\n'then H[#H+1]='\n'end;H[#H+1]='\n#END'return table.concat(H)end;local F={'// Automatically Serialized by Taiko.SerializeTJA'}for G,H in pairs(u)do F[#F+1]=E(H)return table.concat(F,'\n\n')end;F=table.concat(F,'\n\n')return F end;function Taiko.Score(u,v,w,x,y)if x==0 then w=0 else w=w+1 end;local z=u.Metadata;return Taiko.Data.ScoreMode.Note[z.SCOREMODE](v,w,z.SCOREINIT,z.SCOREDIFF,x,y),w end;function Taiko.Analyze(u)local v='M'local w={[1]=2,[2]=2,[3]=3,[4]=3}local x={notes={n=0,validn=0},measures=0,lengthms=0,drumrollms=0,drumrollbigms=0,balloonms=0,balloonhit=0,specialms=0,specialhit=0,maxcombo=0,maxscore=0}local y=nil;Taiko.ForAll(u.Data,function(z,A,B)if z.data=='note'then x.notes.n=x.notes.n+1;x.notes[z.type]=x.notes[z.type]and x.notes[z.type]+1 or 1;if w[z.type]then x.maxscore,x.maxcombo=Taiko.Score(u,x.maxscore,x.maxcombo,w[z.type],z.gogo)end;local C=z.endnote;if C then local D=C.ms-z.ms;if z.type==5 then x.drumrollms=x.drumrollms+D elseif z.type==6 then x.drumrollbigms=x.drumrollbigms+D elseif z.type==7 then x.balloonms=x.balloonms+D;x.balloonhit=x.balloonhit+z.requiredhits elseif z.type==9 then x.specialms=x.specialms+D;x.specialhit=x.specialhit+z.requiredhits else end end;y=z elseif z.data=='event'and z.event=='barline'then x.measures=x.measures+1 else end end,v)x.lengthms=y.ms-u.Metadata.OFFSET;x.notes.validn=x.maxcombo;return x end;function Taiko.GetDifficulty(u,v)local w=Taiko.Data.CourseId[string.lower(v)]or v;for x,y in pairs(u)do if y.Metadata.COURSE==w then return y end end;Error('No difficulty found, '..v)return nil end;function Taiko.ForAll(u,v,w)local x=1;for i=1,#u do local y=u[i]if y.branch then if w then local z=y.branch.paths[w]for i2=1,#z do v(z[i2],i2,x)x=x+1 end;x=x-1 else local z=-1;for A,B in pairs(y.branch.paths)do local C=x;for i2=1,#B do v(B[i2],i2,C)C=C+1 end;z=(z<C)and C or z end;x=z end else v(y,i,x)end;x=x+1 end;return u end;function Taiko.GetAllNotes(u)local v={}for w,x in pairs(u)do if x.branch then for y,z in pairs(x.branch.paths)do for i=1,#z do table.insert(v,z[i])end end else table.insert(v,x)end end;return v end;function Taiko.ConnectNotes(u)local v=nil;for i=#u,1,-1 do local w=u[i]w.nextnote=v;v=w end;return u end;function Taiko.ExtractBranch(u,v)return u.branch.paths[v]end;function Taiko.ConnectAll(u)local v=nil;for i=#u,1,-1 do local w=u[i]if w.branch then for x,y in pairs(w.branch.paths)do local z=Taiko.ConnectNotes(y)z[#z].nextnote=v end else w.nextnote=v end;v=w end end;function Taiko.CalculateSpeed(u,v)local w=(v*u.scrollx*u.bpm/7500)local x=(v*u.scrolly*u.bpm/7500)return{w,x}end;function Taiko.CalculateSpeedInterval(u,v)local w=960;local x=(u.bpm/240000 *u.scrollx*w*v)local y=(u.bpm/240000 *u.scrolly*w*v)return{x,y}end;function Taiko.RenderScale(u)local v={}local w={}local x={}for i=1,#u.Data do local B=u.Data[i]if B.data=='note'then local C=math.floor(B.ms)if math.floor(C)-C==0 then table.insert(v,{C,B.type})table.insert(w,C)else table.insert(x,i)end end end;function gcd2(B,C)if C==0 then return B else return gcd2(C,B%C)end end;function gcdn(B)local C=B[1]for i=2,#B do C=gcd2(C,B[i])end;return C end;local y=gcdn(w)for i=1,#x do local B=v[x[i]]B[1]=math.floor(B[1]/y)*y end;local z=''local A=0;for i=1,#v do v[i][1]=v[i][1]/y;z=z..string.rep(' ',v[i][1]-A)..v[i][2]A=v[i][1]end;return z end;function Taiko.Game(u,v,w,x)local z='Assets/'local A='config.tpd'local B='tscreenshot.png'local C;local D=0;local E=138;local F;local function G()rl.CloseWindow()rl.CloseAudioDevice()end;local function H(wc)local xc=""local yc=0;local zc=wc;if wc<0x80 then return string.char(wc)end;topspace=0x20;while wc>topspace do local Cc=bit.bor(bit.band(wc,0x3F),0x80)xc=string.char(Cc)..xc;wc=bit.rshift(wc,6)yc=yc+1;topspace=bit.rshift(topspace,1)end;local Ac=bit.lshift(bit.rshift(0xFF,7 -yc),7 -yc)local Bc=bit.bor(Ac,wc)return string.char(Bc)..xc end;local function I(wc,xc,...)if xc~=nil then wc={wc,xc,...}end;local yc={}for zc,Ac in ipairs(wc)do if Ac<0x80 then yc[#yc+1]=string.char(Ac)elseif Ac<0x800 then yc[#yc+1]=string.char(bit.bor(bit.rshift(Ac,6),0xc0))yc[#yc+1]=string.char(bit.bor(bit.band(Ac,0x3F),0x80))elseif Ac<0x10000 then yc[#yc+1]=string.char(bit.bor(bit.rshift(Ac,12),0xe0))yc[#yc+1]=string.char(bit.bor(bit.band(bit.rshift(Ac,6),0x3F),0x80))yc[#yc+1]=string.char(bit.bor(bit.band(Ac,0x3F),0x80))elseif Ac<0x200000 then yc[#yc+1]=string.char(bit.bor(bit.rshift(Ac,18),0xf0))yc[#yc+1]=string.char(bit.bor(bit.band(bit.rshift(Ac,12),0x3F),0x80))yc[#yc+1]=string.char(bit.bor(bit.band(bit.rshift(Ac,6),0x3F),0x80))yc[#yc+1]=string.char(bit.bor(bit.band(Ac,0x3F),0x80))else yc[#yc+1]=H(Ac)end end;return table.concat(yc)end;local function J(wc,xc)local yc=10;if xc<yc then xc=yc end;local zc=xc/yc;local Ac=rl.MeasureTextEx(rl.GetFontDefault(),wc,xc,zc)return math.floor(Ac.x),math.floor(Ac.y)end;local K={[rl.KEY_Y]=true,[rl.KEY_N]=false}local L=50;local function M(wc)local xc,yc=J(wc,L)local zc=nil;while not rl.WindowShouldClose()do rl.BeginDrawing()rl.ClearBackground(rl.RAYWHITE)rl.DrawText(wc,C.ScreenWidth/2 -xc/2,C.ScreenHeight/2 -yc/2,L,rl.BLACK)rl.EndDrawing()for Ac,Bc in pairs(K)do if rl.IsKeyPressed(Ac)then zc=Bc;break end end;if zc~=nil then break end end;return zc end;local N=true;local function O(wc)if N then return M(wc..'\nPress y to confirm\nPress n to reject')else return true end end;local function P(wc)local xc,yc=J(wc,L)local zc={}wc=wc..'\n'local Ac=wc;while not rl.WindowShouldClose()do rl.BeginDrawing()rl.ClearBackground(rl.RAYWHITE)rl.DrawText(Ac,C.ScreenWidth/2 -xc/2,C.ScreenHeight/2 -yc/2,L,rl.BLACK)rl.EndDrawing()while true do local Bc=rl.GetCharPressed()if Bc==0 then break else zc[#zc+1]=Bc;Ac=wc..I(zc)end end;if rl.IsKeyPressed(rl.KEY_BACKSPACE)then zc[#zc]=nil;Ac=wc..I(zc)end;if rl.IsKeyPressed(rl.KEY_ENTER)then break end end;zc=I(zc)return zc~=''and zc or nil end;local function Q(wc)local xc,yc=J(wc,L)local zc=nil;while not rl.WindowShouldClose()do rl.BeginDrawing()rl.ClearBackground(rl.RAYWHITE)rl.DrawText(wc,C.ScreenWidth/2 -xc/2,C.ScreenHeight/2 -yc/2,L,rl.BLACK)rl.EndDrawing()while true do local Ac=rl.GetCharPressed()if Ac==0 then break else zc=true;break end end;if zc then break end end;return zc end;local function R(wc)return string.reverse(string.match(string.reverse(wc),'(.-%.)'))end;local function S(wc)local xc=io.open(wc,'rb')if xc then xc:close()return true else return false end end;local function T(wc)local xc=io.open(wc,'rb')if xc then local yc=xc:read('*all')xc:close()return yc else error('Unable to find file'..wc)end end;local function U(wc)F(wc)return T(z..wc)end;local function V(wc)return rl.LoadMusicStream(wc)end;local function W(wc)local xc=U(wc)return rl.LoadImageFromMemory(R(wc),xc,#xc)end;local function X(wc)local xc=U(wc)return rl.LoadWaveFromMemory(R(wc),xc,#xc)end;local function Y(wc)local xc=X(wc)local yc=rl.LoadSoundFromWave(xc)rl.UnloadWave(xc)return yc end;local function Z(wc,xc,yc)local zc={}local Ac=yc;while true do local Bc=wc..tostring(Ac)..xc;if S(z..Bc)then zc[Ac]=W(Bc)Ac=Ac+1 else break end end;return zc end;local function ab(wc,xc)local yc={wc,xc}return yc end;local function bb(wc)local xc=0;for yc,zc in pairs(wc)do xc=xc+1 end;return xc end;local cb=-4;local function db(wc,xc,yc)local zc,Ac=0,0;local Bc=0;for i=1,#wc do local Cc=string.sub(wc,i,i)if Cc=='\n'then Bc=Bc- (xc+cb)zc=Bc>zc and Bc or zc;Ac=Ac+ (yc+cb)else Bc=Bc+ (xc+cb)end end;Bc=Bc- (xc+cb)zc=Bc>zc and Bc or zc;return zc,Ac end;local function eb(wc,xc,yc,zc,Ac,Bc,Cc)Cc=Cc or{['0']={0,0},['1']={1,0},['2']={2,0},['3']={3,0},['4']={4,0},['5']={5,0},['6']={6,0},['7']={7,0},['8']={8,0},['9']={9,0}}local Dc=0;local Ec=0;local Fc=rl.new('Rectangle',0,0,Ac-1,Bc-1)local Gc=rl.new('Rectangle',0,0,Ac-1,Bc-1)local Hc=rl.new('Vector2',0,0)for i=1,#xc do local Ic=string.sub(xc,i,i)if Ic=='\n'then Dc=Dc+1;Ec=0 else local Jc=Cc[Ic]Fc.x=Jc[1]*Ac;Fc.y=Jc[2]*Bc;Gc.x=yc+ (Ac+cb)*Ec;Gc.y=zc+ (Bc+cb)*Dc;rl.DrawTexturePro(wc,Fc,Gc,Hc,0,rl.WHITE)Ec=Ec+1 end end end;local fb=false;if S(A)then C=m.Load(m.Read(A))else C={}fb=true end;C.ScreenWidth=C and C.ScreenWidth or 1600;C.ScreenHeight=C and C.ScreenHeight or C.ScreenWidth/16 *9;rl.SetConfigFlags(rl.FLAG_VSYNC_HINT)rl.InitWindow(C.ScreenWidth,C.ScreenHeight,'Taiko')rl.SetExitKey(rl.KEY_NULL)if fb then local wc=nil;while true do local xc=M('Config file not found\nPress y to generate new config\nPress n to use a different config')if xc==true then local yc=O('Are you sure you want to overwrite '..A..'?')if yc then wc=m.Read('defaultconfig.tpd')else end elseif xc==false then while true do local yc=P('What is the file path?\n(Relative or Absolute)')if yc then if S(yc)then local zc=O('Are you sure you want to use '..yc..'?')if zc then wc=m.Read(yc)break else end else Q('Invalid file')end else break end end else local yc=O('Are you sure you want to continue without config?')if yc then break else end end;if wc then break end end;if wc then C=m.Load(wc)end end;F=function()end;rl.BeginDrawing()rl.ClearBackground(rl.RAYWHITE)rl.DrawText([[
Taiko v32
Loading assets and config...]],0,C.ScreenHeight/2,L,rl.BLACK)rl.EndDrawing()local gb=w or{}local hb={auto={[1]=false,[2]=true},notespeedmul={[1]=1,[2]=2,[3]=3,[4]=4,[5]=0.25,[6]=0.5,[7]=0.75},songspeedmul={[1]=1,[2]=2,[3]=3,[4]=4,[5]=0.25,[6]=0.5,[7]=0.75}}local ib=hb.auto[gb[2]]or false;local jb={[1]=1,[2]=2,[3]=1,[4]=2}local kb=hb.notespeedmul[gb[3]]or 1;local lb=hb.songspeedmul[gb[4]]or 1;local mb=u.Metadata.STOPSONG;local nb=true;local ob=C.Controls;local pb=C.ScreenWidth;local qb=1 /16 *C.ScreenWidth;local rb=5 /16 *C.ScreenWidth;local sb=1000;local tb=72 /2 /1280 *C.ScreenWidth;local ub=0 *C.ScreenWidth;local vb={414 /1280 *C.ScreenWidth,- (257 /720 -1 /2)*C.ScreenHeight}local wb=vb[2]local xb=333 /1280 *C.ScreenWidth;if u.Flag.PARSER_FORCE_OLD_TARGET then vb={1 /4 *C.ScreenWidth,0}end;local yb=200;local zb=yb/4;local Ab=1 /40 *C.ScreenWidth;local Bb=20;local Cb={[1]={color='red'},[2]={color='blue'},[3]={color='red'},[4]={color='blue'},[5]={color='yellow'},[6]={color='yellow'},[7]={color='cyan'}}local Db=xb+pb;local Eb={0,-C.ScreenHeight/2,C.ScreenWidth,C.ScreenHeight/2}local Fb={Eb[1]-qb,Eb[2]-qb,Eb[3]+qb,Eb[4]+qb}local Gb={Eb[1]-rb,Eb[2]-rb,Eb[3]+rb,Eb[4]+rb}local Hb,Ib=0,C.ScreenHeight/2;local Jb=Taiko.Data.BigNoteMul;local Kb=54;local Lb={vb[1],vb[2]}local Mb={}local Nb=C.ScreenHeight/45;local Ob=0.1;local Pb=60;local Qb=1000 /Pb;local Rb=require('texturemap')local Sb={PlaySong={Notes=W('Graphics/5_Game/Notes.png'),ChipEffect=W('Graphics/5_Game/ChipEffect.png'),Barlines={bar=W('Graphics/5_Game/Bar.png'),bar_branch=W('Graphics/5_Game/Bar_Branch.png')},Judges=W('Graphics/5_Game/Judge.png'),Balloons={Anim=Z('Graphics/5_Game/11_Balloon/Breaking_','.png',0,5)},Effects={Hit={[1]={Anim=Z('Graphics/5_Game/10_Effects/Hit/Good/','.png',0,14)},[2]={Anim=Z('Graphics/5_Game/10_Effects/Hit/Great/','.png',0,14)},[3]={Anim=Z('Graphics/5_Game/10_Effects/Hit/Good_Big/','.png',0,14)},[4]={Anim=Z('Graphics/5_Game/10_Effects/Hit/Great_Big/','.png',0,14)}},Explosion=W('Graphics/5_Game/10_Effects/Hit/Explosion.png'),ExplosionBig=W('Graphics/5_Game/10_Effects/Hit/Explosion_Big.png')},Lanes={Lane={default=W('Graphics/5_Game/12_Lane/Background_Main.png'),gogo=W('Graphics/5_Game/12_Lane/Background_GoGo.png'),sub=W('Graphics/5_Game/12_Lane/Background_Sub.png'),N=W('Graphics/5_Game/12_Lane/Base_Normal.png'),E=W('Graphics/5_Game/12_Lane/Base_Expert.png'),M=W('Graphics/5_Game/12_Lane/Base_Master.png')},Text={N=W('Graphics/5_Game/12_Lane/Text_Normal.png'),E=W('Graphics/5_Game/12_Lane/Text_Expert.png'),M=W('Graphics/5_Game/12_Lane/Text_Master.png')}},Backgrounds={Background={Bottom={},InfoBar={[0]=W('Graphics/5_Game/6_Taiko/1P_Background.png')},CourseSymbol={[0]=W('Graphics/5_Game/4_CourseSymbol/Easy.png'),[1]=W('Graphics/5_Game/4_CourseSymbol/Normal.png'),[2]=W('Graphics/5_Game/4_CourseSymbol/Hard.png'),[3]=W('Graphics/5_Game/4_CourseSymbol/Oni.png'),[4]=W('Graphics/5_Game/4_CourseSymbol/Edit.png'),[5]=W('Graphics/5_Game/4_CourseSymbol/Tower.png'),[6]=W('Graphics/5_Game/4_CourseSymbol/Dan.png')}},Frame={[1]=W('Graphics/5_Game/6_Taiko/1P_Frame.png')},Taiko={base=W('Graphics/5_Game/6_Taiko/Base.png'),[1]=W('Graphics/5_Game/6_Taiko/Don.png'),[2]=W('Graphics/5_Game/6_Taiko/Ka.png'),combo=W('Graphics/5_Game/6_Taiko/Combo_Text.png')},ComboText={[0]=W('Graphics/5_Game/6_Taiko/Combo_Text.png')}},Gauges={Meter={base=W('Graphics/5_Game/7_Gauge/1P_Base.png'),full=W('Graphics/5_Game/7_Gauge/1P.png'),rainbow={Anim=Z('Graphics/5_Game/7_Gauge/Rainbow/','.png',0,11)}},Clear={}},Fonts={Combo={[0]=W('Graphics/5_Game/6_Taiko/Combo.png'),[1]=W('Graphics/5_Game/6_Taiko/Combo_Midium.png'),[2]=W('Graphics/5_Game/6_Taiko/Combo_Big.png')},Score={[0]=W('Graphics/5_Game/6_Taiko/Score.png'),[1]=W('Graphics/5_Game/6_Taiko/Score_1P.png')}}}}local Tb={Notes={target={0,0},[1]={1,0},[2]={2,0},[3]={3,0},[4]={4,0},drumrollnote={5,0},drumrollrect={6,0},drumrollend={7,0},DRUMROLLnote={8,0},DRUMROLLrect={9,0},DRUMROLLend={10,0},balloon={11,0},balloonend={12,0}},Barlines={bar=nil,bar_branch=nil},Judges={great={0,0},good={0,1},bad={0,2},adlib={0,3}},Effects={Explosion={[1]={Anim={[0]={0,1},[1]={1,1},[2]={2,1},[3]={3,1},[4]={4,1},[5]={5,1},[6]={6,1}}},[2]={Anim={[0]={0,0},[1]={1,0},[2]={2,0},[3]={3,0},[4]={4,0},[5]={5,0},[6]={6,0}}},[3]={Anim={[0]={0,3},[1]={1,3},[2]={2,3},[3]={3,3},[4]={4,3},[5]={5,3},[6]={6,3}}},[4]={Anim={[0]={0,2},[1]={1,2},[2]={2,2},[3]={3,2},[4]={4,2},[5]={5,2},[6]={6,2}}}}}}F('Splitting into textures')local Ub={130,130}local Vb={130,130}Sb.PlaySong.Notes=Rb.SplitUsingMap(Sb.PlaySong.Notes,Tb.Notes,Ub,Vb)Sb.PlaySong.Notes.drumrollstart=rl.ImageCopy(Sb.PlaySong.Notes.drumrollend)rl.ImageFlipHorizontal(Sb.PlaySong.Notes.drumrollstart)Sb.PlaySong.Notes.DRUMROLLstart=rl.ImageCopy(Sb.PlaySong.Notes.DRUMROLLend)rl.ImageFlipHorizontal(Sb.PlaySong.Notes.DRUMROLLstart)local Wb=C.ScreenWidth/1280;local function Xb(wc,xc)xc=xc or 1;if type(wc)=='table'then for yc,zc in pairs(wc)do Xb(zc,xc)end else rl.ImageResize(wc,Wb*wc.width*xc,Wb*wc.height*xc)end;return wc end;Sb.PlaySong.Notes=Xb(Sb.PlaySong.Notes)local Yb,Zb=Sb.PlaySong.Notes.target.width,Sb.PlaySong.Notes.target.height;local ac=rl.new('Rectangle',0,0,Yb,Zb)local bc=rl.new('Vector2',Yb/2,Zb/2)local cc,dc=Hb- (Yb/2),Ib- (Zb/2)local ec,fc=1,-1;Sb.PlaySong.Notes=Rb.ReplaceWithTexture(Sb.PlaySong.Notes)Sb.PlaySong.Barlines=Xb(Sb.PlaySong.Barlines)Sb.PlaySong.Barlines=Rb.ReplaceWithTexture(Sb.PlaySong.Barlines)local gc,hc=Sb.PlaySong.Barlines.bar.width,Sb.PlaySong.Barlines.bar.height;local ic=rl.new('Rectangle',0,0,gc,hc)local jc=rl.new('Vector2',gc/2,hc/2)Sb.PlaySong.Balloons=Xb(Sb.PlaySong.Balloons)Sb.PlaySong.Balloons=Rb.ReplaceWithTexture(Sb.PlaySong.Balloons)Sb.PlaySong.Balloons.sizex=Sb.PlaySong.Balloons.Anim[0].width;Sb.PlaySong.Balloons.sizey=Sb.PlaySong.Balloons.Anim[0].height;Sb.PlaySong.Balloons.sourcerect=rl.new('Rectangle',0,0,Sb.PlaySong.Balloons.sizex,Sb.PlaySong.Balloons.sizey)Sb.PlaySong.Balloons.center=rl.new('Vector2',Sb.PlaySong.Balloons.sizex/2,Sb.PlaySong.Balloons.sizey/2)local kc={90,60}local lc={90,60}Sb.PlaySong.Judges=Rb.SplitUsingMap(Sb.PlaySong.Judges,Tb.Judges,kc,lc)Sb.PlaySong.Judges=Xb(Sb.PlaySong.Judges)Sb.PlaySong.Judges=Rb.ReplaceWithTexture(Sb.PlaySong.Judges)local mc=rl.new('Color',255,255,255,255 /2)Sb.PlaySong.Effects.Hit=Xb(Sb.PlaySong.Effects.Hit)local nc=Sb.PlaySong.Effects.Hit[1].Anim[0]local oc=Hb- (nc.width/2)local pc=Ib- (nc.height/2)Sb.PlaySong.Effects.Hit=Rb.ReplaceWithTexture(Sb.PlaySong.Effects.Hit)local qc={260,260}local rc={260,260}Sb.PlaySong.Effects.Explosion=Rb.SplitUsingMap(Sb.PlaySong.Effects.Explosion,Tb.Effects.Explosion,qc,rc)Sb.PlaySong.Effects.Explosion=Xb(Sb.PlaySong.Effects.Explosion)Sb.PlaySong.Effects.Explosion=Rb.ReplaceWithTexture(Sb.PlaySong.Effects.Explosion)local sc={Sb.PlaySong.Effects.ExplosionBig}Sb.PlaySong.Effects.ExplosionBig=Xb(sc)Sb.PlaySong.Effects.ExplosionBig={Anim={[0]=Rb.ReplaceWithTexture(sc)[1]}}Sb.PlaySong.Lanes=Xb(Sb.PlaySong.Lanes)Sb.PlaySong.Lanes=Rb.ReplaceWithTexture(Sb.PlaySong.Lanes)Sb.PlaySong.Lanes.sizex=Sb.PlaySong.Lanes.Lane.default.width;Sb.PlaySong.Lanes.sizey=Sb.PlaySong.Lanes.Lane.default.height;Sb.PlaySong.Lanes.sourcerect=rl.new('Rectangle',0,0,Sb.PlaySong.Lanes.sizex,Sb.PlaySong.Lanes.sizey)Sb.PlaySong.Lanes.center=rl.new('Vector2',0,Sb.PlaySong.Lanes.sizey/2)Sb.PlaySong.Lanes.pr=rl.new('Rectangle',xb*ec+Hb,wb*fc+Ib,Sb.PlaySong.Lanes.sizex,Sb.PlaySong.Lanes.sizey)Sb.PlaySong.Lanes.ssizex=Sb.PlaySong.Lanes.Lane.sub.width;Sb.PlaySong.Lanes.ssizey=Sb.PlaySong.Lanes.Lane.sub.height;Sb.PlaySong.Lanes.ssourcerect=rl.new('Rectangle',0,0,Sb.PlaySong.Lanes.ssizex,Sb.PlaySong.Lanes.ssizey)Sb.PlaySong.Lanes.scenter=rl.new('Vector2',0,0)Sb.PlaySong.Lanes.spr=rl.new('Rectangle',xb*ec+Hb,325 /720 *C.ScreenHeight,Sb.PlaySong.Lanes.ssizex,Sb.PlaySong.Lanes.ssizey)Sb.PlaySong.Backgrounds=Xb(Sb.PlaySong.Backgrounds)Sb.PlaySong.Backgrounds=Rb.ReplaceWithTexture(Sb.PlaySong.Backgrounds)Sb.PlaySong.Backgrounds.Frame.sizex=Sb.PlaySong.Backgrounds.Frame[1].width;Sb.PlaySong.Backgrounds.Frame.sizey=Sb.PlaySong.Backgrounds.Frame[1].height;Sb.PlaySong.Backgrounds.Frame.sourcerect=rl.new('Rectangle',0,0,Sb.PlaySong.Backgrounds.Frame.sizex,Sb.PlaySong.Backgrounds.Frame.sizey)Sb.PlaySong.Backgrounds.Frame.center=rl.new('Vector2',0,0)Sb.PlaySong.Backgrounds.Frame.pr=rl.new('Rectangle',332 /1280 *C.ScreenWidth,136 /720 *C.ScreenHeight,Sb.PlaySong.Backgrounds.Frame.sizex,Sb.PlaySong.Backgrounds.Frame.sizey)Sb.PlaySong.Backgrounds.Taiko.sizex=Sb.PlaySong.Backgrounds.Taiko.base.width;Sb.PlaySong.Backgrounds.Taiko.sizey=Sb.PlaySong.Backgrounds.Taiko.base.height;Sb.PlaySong.Backgrounds.Taiko.sourcerect=rl.new('Rectangle',0,0,Sb.PlaySong.Backgrounds.Taiko.sizex,Sb.PlaySong.Backgrounds.Taiko.sizey)Sb.PlaySong.Backgrounds.Taiko.center=rl.new('Vector2',0,0)Sb.PlaySong.Backgrounds.Taiko.pr=rl.new('Rectangle',210 /1280 *C.ScreenWidth,206 /720 *C.ScreenHeight,Sb.PlaySong.Backgrounds.Taiko.sizex,Sb.PlaySong.Backgrounds.Taiko.sizey)Sb.PlaySong.Backgrounds.ComboText.sizex=Sb.PlaySong.Backgrounds.ComboText[0].width;Sb.PlaySong.Backgrounds.ComboText.sizey=Sb.PlaySong.Backgrounds.ComboText[0].height;Sb.PlaySong.Backgrounds.ComboText.sourcerect=rl.new('Rectangle',0,0,Sb.PlaySong.Backgrounds.ComboText.sizex,Sb.PlaySong.Backgrounds.ComboText.sizey)Sb.PlaySong.Backgrounds.ComboText.center=rl.new('Vector2',0,0)Sb.PlaySong.Backgrounds.ComboText.pr=rl.new('Rectangle',220 /1280 *C.ScreenWidth,198 /720 *C.ScreenHeight,Sb.PlaySong.Backgrounds.ComboText.sizex,Sb.PlaySong.Backgrounds.ComboText.sizey)Sb.PlaySong.Backgrounds.Background.InfoBar.sizex=Sb.PlaySong.Backgrounds.Background.InfoBar[0].width;Sb.PlaySong.Backgrounds.Background.InfoBar.sizey=Sb.PlaySong.Backgrounds.Background.InfoBar[0].height;Sb.PlaySong.Backgrounds.Background.InfoBar.sourcerect=rl.new('Rectangle',0,0,Sb.PlaySong.Backgrounds.Background.InfoBar.sizex,Sb.PlaySong.Backgrounds.Background.InfoBar.sizey)Sb.PlaySong.Backgrounds.Background.InfoBar.center=rl.new('Vector2',0,0)Sb.PlaySong.Backgrounds.Background.InfoBar.pr=rl.new('Rectangle',0 /1280 *C.ScreenWidth,184 /720 *C.ScreenHeight,Sb.PlaySong.Backgrounds.Background.InfoBar.sizex,Sb.PlaySong.Backgrounds.Background.InfoBar.sizey)Sb.PlaySong.Backgrounds.Background.CourseSymbol.sizex=Sb.PlaySong.Backgrounds.Background.CourseSymbol[0].width;Sb.PlaySong.Backgrounds.Background.CourseSymbol.sizey=Sb.PlaySong.Backgrounds.Background.CourseSymbol[0].height;Sb.PlaySong.Backgrounds.Background.CourseSymbol.sourcerect=rl.new('Rectangle',0,0,Sb.PlaySong.Backgrounds.Background.CourseSymbol.sizex,Sb.PlaySong.Backgrounds.Background.CourseSymbol.sizey)Sb.PlaySong.Backgrounds.Background.CourseSymbol.center=rl.new('Vector2',0,0)Sb.PlaySong.Backgrounds.Background.CourseSymbol.pr=rl.new('Rectangle',58 /1280 *C.ScreenWidth,230 /720 *C.ScreenHeight,Sb.PlaySong.Backgrounds.Background.CourseSymbol.sizex,Sb.PlaySong.Backgrounds.Background.CourseSymbol.sizey)Sb.PlaySong.Backgrounds.Background.CourseSymbol.pr=rl.new('Rectangle',18 /1280 *C.ScreenWidth,230 /720 *C.ScreenHeight,Sb.PlaySong.Backgrounds.Background.CourseSymbol.sizex,Sb.PlaySong.Backgrounds.Background.CourseSymbol.sizey)Sb.PlaySong.Gauges.Clear[true]=rl.ImageFromImage(Sb.PlaySong.Gauges.Meter.base,rl.new('Rectangle',0,44,58,24))Sb.PlaySong.Gauges.Clear[false]=rl.ImageFromImage(Sb.PlaySong.Gauges.Meter.base,rl.new('Rectangle',58,44,58,24))Sb.PlaySong.Gauges=Xb(Sb.PlaySong.Gauges)Sb.PlaySong.Gauges=Rb.ReplaceWithTexture(Sb.PlaySong.Gauges)Sb.PlaySong.Gauges.Meter.sizex=Sb.PlaySong.Gauges.Meter.base.width;Sb.PlaySong.Gauges.Meter.sizey=Sb.PlaySong.Gauges.Meter.base.height;Sb.PlaySong.Gauges.Meter.sourcerect=rl.new('Rectangle',0,0,Sb.PlaySong.Gauges.Meter.sizex,Sb.PlaySong.Gauges.Meter.sizey)Sb.PlaySong.Gauges.Meter.center=rl.new('Vector2',0,0)Sb.PlaySong.Gauges.Meter.pr=rl.new('Rectangle',494 /1280 *C.ScreenWidth,144 /720 *C.ScreenHeight,Sb.PlaySong.Gauges.Meter.sizex,Sb.PlaySong.Gauges.Meter.sizey)Sb.PlaySong.Gauges.Meter.sourcerect2=rl.new('Rectangle',0,0,Sb.PlaySong.Gauges.Meter.sizex,Sb.PlaySong.Gauges.Meter.sizey)Sb.PlaySong.Gauges.Meter.pr2=rl.new('Rectangle',494 /1280 *C.ScreenWidth,144 /720 *C.ScreenHeight,Sb.PlaySong.Gauges.Meter.sizex,Sb.PlaySong.Gauges.Meter.sizey)Sb.PlaySong.Gauges.Clear.sizex=Sb.PlaySong.Gauges.Clear[true].width;Sb.PlaySong.Gauges.Clear.sizey=Sb.PlaySong.Gauges.Clear[true].height;Sb.PlaySong.Gauges.Clear.sourcerect=rl.new('Rectangle',0,0,Sb.PlaySong.Gauges.Clear.sizex,Sb.PlaySong.Gauges.Clear.sizey)Sb.PlaySong.Gauges.Clear.center=rl.new('Vector2',0,0)Sb.PlaySong.Gauges.Clear.pr=rl.new('Rectangle',1038 /1280 *C.ScreenWidth,143 /720 *C.ScreenHeight,Sb.PlaySong.Gauges.Clear.sizex,Sb.PlaySong.Gauges.Clear.sizey)Sb.PlaySong.Fonts=Xb(Sb.PlaySong.Fonts)Sb.PlaySong.Fonts=Rb.ReplaceWithTexture(Sb.PlaySong.Fonts)local tc=u.Metadata.SONG;rl.InitAudioDevice()local uc;if tc then if S(u.Metadata.SONG)then uc=V(u.Metadata.SONG)rl.SetMusicVolume(uc,u.Metadata.SONGVOL)else tc=false end end;local vc={PlaySong={Combo={[50]=Y('Sounds/Combo_1P/50.wav'),[100]=Y('Sounds/Combo_1P/100.wav'),[200]=Y('Sounds/Combo_1P/200.wav'),[300]=Y('Sounds/Combo_1P/300.wav'),[400]=Y('Sounds/Combo_1P/400.wav'),[500]=Y('Sounds/Combo_1P/500.wav'),[600]=Y('Sounds/Combo_1P/600.wav'),[700]=Y('Sounds/Combo_1P/700.wav'),[800]=Y('Sounds/Combo_1P/800.wav'),[900]=Y('Sounds/Combo_1P/900.wav'),[1000]=Y('Sounds/Combo_1P/1000.wav'),[1100]=Y('Sounds/Combo_1P/1100.wav'),[1200]=Y('Sounds/Combo_1P/1200.wav'),[1300]=Y('Sounds/Combo_1P/1300.wav'),[1400]=Y('Sounds/Combo_1P/1400.wav'),[1500]=Y('Sounds/Combo_1P/1500.wav'),[1600]=Y('Sounds/Combo_1P/1600.wav'),[1700]=Y('Sounds/Combo_1P/1700.wav'),[1800]=Y('Sounds/Combo_1P/1800.wav'),[1900]=Y('Sounds/Combo_1P/1900.wav'),[2000]=Y('Sounds/Combo_1P/2000.wav'),[2100]=Y('Sounds/Combo_1P/2100.wav'),[2200]=Y('Sounds/Combo_1P/2200.wav'),[2300]=Y('Sounds/Combo_1P/2300.wav'),[2400]=Y('Sounds/Combo_1P/2400.wav'),[2500]=Y('Sounds/Combo_1P/2500.wav'),[2600]=Y('Sounds/Combo_1P/2600.wav'),[2700]=Y('Sounds/Combo_1P/2700.wav'),[2800]=Y('Sounds/Combo_1P/2800.wav'),[2900]=Y('Sounds/Combo_1P/2900.wav'),[3000]=Y('Sounds/Combo_1P/3000.wav'),[3100]=Y('Sounds/Combo_1P/3100.wav'),[3200]=Y('Sounds/Combo_1P/3200.wav'),[3300]=Y('Sounds/Combo_1P/3300.wav'),[3400]=Y('Sounds/Combo_1P/3400.wav'),[3500]=Y('Sounds/Combo_1P/3500.wav'),[3600]=Y('Sounds/Combo_1P/3600.wav'),[3700]=Y('Sounds/Combo_1P/3700.wav'),[3800]=Y('Sounds/Combo_1P/3800.wav'),[3900]=Y('Sounds/Combo_1P/3900.wav'),[4000]=Y('Sounds/Combo_1P/4000.wav'),[4100]=Y('Sounds/Combo_1P/4100.wav'),[4200]=Y('Sounds/Combo_1P/4200.wav'),[4300]=Y('Sounds/Combo_1P/4300.wav'),[4400]=Y('Sounds/Combo_1P/4400.wav'),[4500]=Y('Sounds/Combo_1P/4500.wav'),[4600]=Y('Sounds/Combo_1P/4600.wav'),[4700]=Y('Sounds/Combo_1P/4700.wav'),[4800]=Y('Sounds/Combo_1P/4800.wav'),[4900]=Y('Sounds/Combo_1P/4900.wav'),[5000]=Y('Sounds/Combo_1P/5000.wav')},Notes={[1]=Y('Sounds/Taiko/dong.ogg'),[2]=Y('Sounds/Taiko/ka.ogg'),adlib=Y('Sounds/Taiko/Adlib.ogg'),balloonpop=Y('Sounds/balloon.ogg')}}}for wc,xc in pairs(vc.PlaySong.Combo)do rl.SetSoundVolume(xc,u.Metadata.SEVOL)end;for wc,xc in pairs(vc.PlaySong.Notes)do rl.SetSoundVolume(xc,u.Metadata.SEVOL)end;function Taiko.PlaySong(wc)local function xc(fe)return math.floor(fe+0.5)end;local function yc(fe)return fe- (math.floor(fe/360)*360)end;local function zc(fe)return(fe.data=='note')or(fe.data=='event'and fe.event=='barline')end;local function Ac(fe,ge,he,ie,je,ke)return he<=fe and fe<=je and ie<=ge and ge<=ke end;local function Bc(fe,ge,he,ie,je,ke,le,me)je,ke,le,me=je-fe,ke-ge,le-fe,me-ge;local ne=ie/he;if ie<0 then local oe,pe=ke/ne,ke;if je<=oe and oe<=le then return oe,pe end else local oe,pe=me/ne,me;if je<=oe and oe<=le then return oe,pe end end;if he<0 then local oe,pe=je,je*ne;if ke<=pe and pe<=me then return oe,pe end else local oe,pe=le,le*ne;if ke<=pe and pe<=me then return oe,pe end end;return nil end;local function Cc(fe,ge)local he,ie=Bc(vb[1],vb[2],-fe.scrollx,-fe.scrolly,Fb[1],Fb[2],Fb[3],Fb[4])return ge- (he~=0 and he/-fe.speed[1]or ie/-fe.speed[2])end;local function Dc(fe,ge)return vb[1]- (fe.speed[1]* (fe.ms-ge-fe.delay)),vb[2]- (fe.speed[2]* (fe.ms-ge-fe.delay))end;local Ec=Taiko.GetAllNotes(wc.Data)local Fc=wc.Metadata.OFFSET;local Gc=1000 /60;local Hc=wc.Metadata.TIMING(Gc/lb)local Ic=0;local Jc={[1]=true,[2]=true,[3]=true,[4]=true}local Kc={}local Lc='M'local Mc,Nc=nil,nil;if wc.Flag.PARSER_FORCE_OLD_SPEED_CALCULATION then Mc=Taiko.CalculateSpeed;if wc.Flag.PARSER_FORCE_OLD_NOTERADIUS then tb=1 /40 *C.ScreenWidth end;Nc=tb else Mc=Taiko.CalculateSpeedInterval;Nc=C.ScreenWidth/1280 end;for fe,ge in pairs(Ec)do ge.ms=ge.oms or ge.ms;ge.oms=ge.ms;ge.ms=(ge.ms-Fc)/lb;ge.s=MsToS(ge.ms)ge.delay=ge.odelay or ge.delay;ge.odelay=ge.delay;ge.p={}ge.delay=ge.delay/lb;ge.speed=Mc(ge,Nc)ge.speed[1]=ge.speed[1]*kb;ge.speed[2]=ge.speed[2]*kb;if ge.jposscroll then ge.jposscroll.lengthms=ge.jposscroll.olengthms or ge.jposscroll.lengthms;ge.jposscroll.olengthms=ge.jposscroll.lengthms;ge.jposscroll.lengthms=ge.jposscroll.lengthms/lb;ge.jposscrolldone=false end;ge.loadms=Cc(ge,ge.ms)ge.loads=MsToS(ge.loadms)ge.hit=nil;ge.timeshit=nil;ge.brokecombo=false;ge.setdelay=false;ge.pop=false;ge.stopdone=false;Kc[#Kc+1]=ge.ms;if(ge.currentbranch==nil or ge.currentbranch==Lc)and Jc[ge.type]then Ic=Ic+1 end end;if mb then for ie,je in pairs(wc.Data)do if je.branch then for ke,le in pairs(je.branch.paths)do table.sort(le,function(me,ne)return me.ms<ne.ms end)end end end;table.sort(wc.Data,function(ie,je)if ie.branch and je.branch then for ke,le in pairs(ie.branch.paths)do for me,ne in pairs(je.branch.paths)do return le[1].ms<ne[1].ms end end elseif ie.branch then for ke,le in pairs(ie.branch.paths)do return le[1].ms<je.ms end elseif je.branch then for ke,le in pairs(je.branch.paths)do return ie.ms<le[1].ms end else return ie.ms<je.ms end end)local fe=nil;local ge=0;local he={}Taiko.ForAll(wc.Data,function(ie,je,ke)if ie.delay~=ge then if fe then fe.stopms=ie.delay-fe.delay;fe.stopstart=fe.ms;fe.stopend=fe.stopstart+fe.stopms end;ge=ie.delay end;if fe and fe.delay~=0 then fe.ms=fe.ms-fe.delay;fe.s=MsToS(fe.ms)fe.loadms=Cc(fe,fe.ms)fe.loads=MsToS(fe.loadms)fe.ms=fe.ms+fe.delay;fe.s=MsToS(fe.ms)end;fe=ie end)end;for fe,ge in pairs(wc.Data)do if ge.branch then for he,ie in pairs(ge.branch.paths)do table.sort(ie,function(je,ke)return je.loadms<ke.loadms end)end end end;table.sort(wc.Data,function(fe,ge)if fe.branch and ge.branch then for he,ie in pairs(fe.branch.paths)do for je,ke in pairs(ge.branch.paths)do return ie[1].loadms<ke[1].loadms end end elseif fe.branch then for he,ie in pairs(fe.branch.paths)do return ie[1].loadms<ge.loadms end elseif ge.branch then for he,ie in pairs(ge.branch.paths)do return fe.loadms<ie[1].loadms end else return fe.loadms<ge.loadms end end)Taiko.ConnectAll(wc.Data)Taiko.ForAll(wc.Data,function(fe,ge,he)fe.n=he end)local Oc=sb/lb;local Pc=Kc[1]for i=1,#Kc do if Kc[i]>Pc then Pc=Kc[i]end end;Pc=Pc+Oc;local Qc={}local Rc={barline={},drumroll={},notes={}}local Sc={}local Tc=wc.Data[1]local Uc=Tc.loads;local Vc='M'local Wc=0;local Xc,Yc,Zc=wc.Metadata.SCOREINIT,wc.Metadata.SCOREDIFF,Taiko.Data.ScoreMode.Note[wc.Metadata.SCOREMODE]local ad=0;local bd=false;local cd=0;local dd=0;local ed=false;local fd=false;local gd=Taiko.Data.Gauge.Soul[wc.Metadata.COURSE](Ic)local hd=Taiko.Data.Gauge.Percent;local id=nil;local jd=nil;local kd=nil;local ld=Taiko.Data.ScoreMode.Balloon[wc.Metadata.SCOREMODE]local md=Taiko.Data.ScoreMode.BalloonPop[wc.Metadata.SCOREMODE]local nd=nil;local od=nil;local pd=nil;local qd=Taiko.Data.ScoreMode.Drumroll[wc.Metadata.SCOREMODE]local rd={startms=nil,status=nil}local sd=nil;local td=nil;local ud=nil;local vd={}local wd=0;local xd=nil;local yd=nil;local zd={nil,nil}local Ad={nil,nil}local Bd={}local Cd={-1,nil}local Dd=0;local Ed=0;local Fd=true;local Gd=false;local Hd;local Id='test.trp'local Jd=false;local Kd;local Ld='test.trp'local Md;local Nd;local Od;local Pd;if Gd then Hd={[1]={},[2]={}}end;if Jd then Kd,Md=l.Load(l.Read(Ld))local function fe(ge,he)if ge then else error(he..' does not match')end end;fe(l.Version==Md.version,'Version')fe(wc.Metadata.TITLE==Md.title,'Title')Nd={}for ge,he in pairs(Kd)do Nd[#Nd+1]=ge end;table.sort(Nd)Pd=1;Od=Nd[Pd]end;Taiko.ForAll(wc.Data,function(fe,ge,he)local ie=yc(math.deg(math.atan2(-fe.scrollx,-fe.scrolly))-90)if ie<90 or ie>=270 then fe.rotationr=ie else fe.rotationr=180 +ie end;if fe.type==3 or fe.type==4 or fe.type==6 then fe.radiusr=fe.radius/Jb else fe.radiusr=fe.radius or 1 end;if fe.data=='event'and fe.event=='barline'then fe.type='bar'fe.pr=rl.new('Rectangle',0,0,gc,hc)fe.tcenter=rl.new('Vector2',jc.x*fe.radiusr,jc.y*fe.radiusr)else fe.pr=rl.new('Rectangle',0,0,Yb,Zb)fe.tcenter=rl.new('Vector2',bc.x*fe.radiusr,bc.y*fe.radiusr)end;fe.pr.width=fe.pr.width*fe.radiusr;fe.pr.height=fe.pr.height*fe.radiusr;if fe.startnote then local je=fe.startnote;if je.type==5 or je.type==6 then fe.rotationr=ie;fe.drumrollrect=rl.new('Rectangle',0,0,0,0)fe.drumrollrect2=rl.new('Rectangle',0,0,0,0)if je.type==5 then je.notetype='drumrollnote'je.recttype='drumrollrect'je.endtype='drumrollend'elseif je.type==6 then je.notetype='DRUMROLLnote'je.recttype='DRUMROLLrect'je.endtype='DRUMROLLend'end elseif je.type==7 then fe.balloonrect=rl.new('Rectangle',0,0,Sb.PlaySong.Balloons.sourcerect.width,Sb.PlaySong.Balloons.sourcerect.height)end end end)local Qd={startms=nil,framen=bb(Sb.PlaySong.Balloons.Anim),anim={[0]=0.125 *8,[1]=0.125 *7,[2]=0.125 *6,[3]=0.125 *5,[4]=0.125 *4,[5]=0.125 *3,[6]=0.125 *2,[7]=0.125 *1,[8]=0.125 *0},color=rl.new('Color',255,255,255,255)}local Rd;local Sd,Td={},{}local Ud=false;local Vd={notes={},startms={},currenttarget={[1]={},[2]={}},anim={}}local Wd;do local fe={{},{},{},{}}local ge=25;Wd=function(he)local function ie(pe,qe,re)local se=1 -pe;for te,ue in pairs(qe)do re[te][1]=ue[1]re[te][2]=ue[2]end;for i=2,#re do for k=1,#re-i+1 do re[k][1]=re[k][1]*se+re[k+1][1]*pe;re[k][2]=re[k][2]*se+re[k+1][2]*pe end end;return{re[1][1],re[1][2]}end;local function je(pe)return math.sin(math.pi/2 *pe)end;local ke=C.ScreenHeight/2 -720 /2;local le={vb[1]*ec+Hb,vb[2]*fc+Ib}local me={x1=le[1]+14,y1=le[2]-29,x2=C.ScreenWidth-55,y2=ke+165}me.w=me.x2 -me.x1;me.h=63;local ne={{me.x1,me.y1},{me.x1 +me.w/6,me.y1 -me.h*3.5},{me.x2 -me.w/3,me.y2 -me.h*5},{me.x2,me.y2}}Vd.anim[he[1]]=Vd.anim[he[1]]or{}Vd.anim[he[1]][he[2]]={}local oe=Vd.anim[he[1]][he[2]]oe[0]={nil,nil}for i=1,ge do local pe=(i-1)/ (ge-1)local qe=ie(je(pe),ne,fe)qe[1]=xc(qe[1]/1280 *C.ScreenWidth)qe[2]=xc(qe[2]/720 *C.ScreenHeight)oe[i]=qe end end end;Wd(Lb)local Xd={anim={[0]=0.125 *8,[1]=0.125 *8,[2]=0.125 *8,[3]=0.125 *8,[4]=0.125 *8,[5]=0.125 *6,[6]=0.125 *4,[7]=0.125 *2,[8]=0.125 *0},[1]={[1]={startms=nil,color=rl.new('Color',255,255,255,255)},[2]={startms=nil,color=rl.new('Color',255,255,255,255)},sourcerect=rl.new('Rectangle',0,0,Sb.PlaySong.Backgrounds.Taiko.sizex/2,Sb.PlaySong.Backgrounds.Taiko.sizey),pr=rl.new('Rectangle',Sb.PlaySong.Backgrounds.Taiko.pr.x,Sb.PlaySong.Backgrounds.Taiko.pr.y,Sb.PlaySong.Backgrounds.Taiko.sizex/2,Sb.PlaySong.Backgrounds.Taiko.sizey),center=rl.new('Vector2',0,0)},[2]={[1]={startms=nil,color=rl.new('Color',255,255,255,255)},[2]={startms=nil,color=rl.new('Color',255,255,255,255)},sourcerect=rl.new('Rectangle',Sb.PlaySong.Backgrounds.Taiko.sizex/2,0,Sb.PlaySong.Backgrounds.Taiko.sizex/2,Sb.PlaySong.Backgrounds.Taiko.sizey),pr=rl.new('Rectangle',Sb.PlaySong.Backgrounds.Taiko.pr.x+Sb.PlaySong.Backgrounds.Taiko.sizex/2,Sb.PlaySong.Backgrounds.Taiko.pr.y,Sb.PlaySong.Backgrounds.Taiko.sizex/2,Sb.PlaySong.Backgrounds.Taiko.sizey),center=rl.new('Vector2',0,0)}}local function Yd(fe,ge)rl.PlaySound(vc.PlaySong.Notes[fe])local he=Xd[ge==false and 1 or ge==true and 2]he[fe].startms=Rd;he[fe].color.a=255;if Gd then Hd[fe][#Hd[fe]+1]=Rd end;if Td[fe]and(not Td[fe].hit)then local ie=Td[fe]local je=ie.type;local ke=Sd[fe]local le;local me;local ne=( (je==3 or je==4)and Taiko.Data.BigLeniency)or 1;local oe=nil;local pe=(je==3 or je==4)if ke< (Hc.good)then le=(pe and 3)or 2;ad=ad+1;oe=(pe and 4)or 2;me=2 elseif ke< (Hc.ok*ne)then le=(pe and 2)or 1;ad=ad+1;oe=(pe and 3)or 1;me=1 elseif ke< (Hc.bad*ne)then le=0;ad=0;oe=0;me=0 else le=nil end;if le then Wc=Zc(Wc,ad,Xc,Yc,le,ie.gogo)cd=cd+gd[me]dd=hd(cd)ed=dd>=Taiko.Data.Gauge.ClearPercent;fd=dd>=Taiko.Data.Gauge.OverflowPercent;Td[fe].hit=true;rd.startms=Rd;rd.status=oe;rd.statusanim=oe~=0 and Sb.PlaySong.Effects.Hit[oe].Anim;rd.explosionanim=oe~=0 and Sb.PlaySong.Effects.Explosion[oe].Anim;rd.explosionbiganim=(pe and Sb.PlaySong.Effects.ExplosionBig.Anim)or nil;local qe=#Vd.notes+1;Vd.notes[qe]=Td[fe]Vd.startms[qe]=Rd;Vd.currenttarget[1][qe]=vb[1]Vd.currenttarget[2][qe]=vb[2]if Vd.anim[vb[1]]and Vd.anim[vb[1]][vb[2]]then else Wd(vb)end;if vc.PlaySong.Combo[ad]then rl.PlaySound(vc.PlaySong.Combo[ad])end end end;if(fe==1)and jd and(Rd>jd and Rd<kd)and(not id.pop)then id.timeshit=id.timeshit and id.timeshit+1 or 1;Wc=ld(Wc,id.type,notegogo)if id.timeshit>=id.requiredhits then id.pop=true;Qd.startms=Rd;Qd.color.a=255;rl.PlaySound(vc.PlaySong.Notes.balloonpop)end end;if(fe==1 or fe==2)and od and(Rd>od and Rd<pd)then nd.timeshit=nd.timeshit and nd.timeshit+1 or 1;Wc=qd(Wc,nd.type,notegogo)end end;local function Zd(fe)local ge=jb[fe.type]Sd[ge]=0;Td[ge]=fe;Yd(ge,Ud)Ud=not Ud end;local function ae(fe)Yd(fe,Ud)Ud=not Ud end;local function be(fe,ge)return fe.ms>ge.ms end;local ce=table.concat({'Title: ',wc.Metadata.TITLE,'\nSubtitle: ','','\nDifficulty: ',Taiko.Data.CourseName[wc.Metadata.COURSE],'\nStars: ',tostring(wc.Metadata.LEVEL),'\n\nAuto: ',tostring(ib),'\nRecording: ',tostring(Gd),'\nReplaying: ',tostring(Jd)})local de={'Combo: ','','\nScore: ',''}while not rl.WindowShouldClose()do rl.BeginDrawing()rl.ClearBackground(rl.RAYWHITE)rl.DrawText('Press SPACE to start',C.ScreenWidth/2,C.ScreenHeight/2,L,rl.BLACK)rl.EndDrawing()if rl.IsKeyPressed(32)then break end end;if tc then rl.SetMusicPitch(uc,lb)rl.PlayMusicStream(uc)end;local ee=os.clock()while true do if tc then rl.UpdateMusicStream(uc)end;rl.BeginDrawing()rl.ClearBackground(rl.RAYWHITE)rl.DrawTexturePro(Sb.PlaySong.Backgrounds.Background.InfoBar[0],Sb.PlaySong.Backgrounds.Background.InfoBar.sourcerect,Sb.PlaySong.Backgrounds.Background.InfoBar.pr,Sb.PlaySong.Backgrounds.Background.InfoBar.center,0,rl.WHITE)rl.DrawTexturePro(Sb.PlaySong.Backgrounds.Background.CourseSymbol[wc.Metadata.COURSE],Sb.PlaySong.Backgrounds.Background.CourseSymbol.sourcerect,Sb.PlaySong.Backgrounds.Background.CourseSymbol.pr,Sb.PlaySong.Backgrounds.Background.CourseSymbol.center,0,rl.WHITE)rl.DrawFPS(10,10)rl.DrawText(ce,10,40,Nb,rl.BLACK)rl.DrawText(table.concat(de)..'\n'..dd,10,C.ScreenHeight- (Nb*5),Nb,rl.BLACK)local fe=os.clock()local ge=fe-ee;Rd=ge*1000;if tc then local re=ge- (rl.GetMusicTimePlayed(uc)/lb)if re>Ob or re<-Ob then print('RESYNC',re)rl.SeekMusicStream(uc,ge*lb)end end;if Jd and Od and Rd>=Od then local re=Kd[Od]for i=1,#re do Yd(tonumber(re[i]),false)end;Pd=Pd+1;Od=Nd[Pd]end;if ud and Rd>ud then sd,td,ud=nil,nil,nil end;if kd and Rd>kd then id,jd,kd=nil,nil,nil end;if pd and Rd>pd then nd,od,pd=nil,nil,nil end;if mb then for i=1,#vd do local re=vd[i]if Rd>=re.stopstart then sd=wd+re.stopstart;stopms=re.stopms;wd=wd-re.stopms;td=re.stopstart;ud=re.stopend;table.remove(vd,i)break end end end;if nb then for i=1,#Bd do local re=Bd[i]if Rd>=re.ms then xd=re.ms;yd=re.ms+re.jposscroll.lengthms;if re.jposscroll.p=='default'then zd[1]=(Lb[1]-vb[1])/re.jposscroll.lengthms;zd[2]=(Lb[2]-vb[2])/re.jposscroll.lengthms else zd[1]=( (re.jposscroll.p and re.jposscroll.p[1])and re.jposscroll.p[1]or(re.jposscroll.lanep and re.jposscroll.lanep[1])and(re.jposscroll.lanep[1]*pb)or 0)/re.jposscroll.lengthms;zd[2]=( (re.jposscroll.p and re.jposscroll.p[2])and re.jposscroll.p[2]or(re.jposscroll.lanep and re.jposscroll.lanep[2])and(re.jposscroll.lanep[2]*pb)or 0)/re.jposscroll.lengthms end;Ad[1]=vb[1]Ad[2]=vb[2]table.remove(Bd,i)break end end;if yd and Rd>yd then local re=yd-xd;vb[1]=Ad[1]+ (zd[1]*re)vb[2]=Ad[2]+ (zd[2]*re)xd,yd=nil,nil end end;if Tc then while true do if Tc and Tc.loadms<Rd+wd then Qc[#Qc+1]=Tc;if Tc.endnote then Qc[#Qc+1]=Tc.endnote end;Tc=Tc.nextnote;if Tc then if Tc.startnote then Tc=Tc.nextnote end;if Tc and Tc.branch then Tc=Tc.branch.paths[Vc][1]end end else break end end else if Rd>Pc then break end end;rl.DrawTexturePro(Sb.PlaySong.Backgrounds.Frame[1],Sb.PlaySong.Backgrounds.Frame.sourcerect,Sb.PlaySong.Backgrounds.Frame.pr,Sb.PlaySong.Backgrounds.Frame.center,0,rl.WHITE)rl.DrawTexturePro(Sb.PlaySong.Gauges.Meter.base,Sb.PlaySong.Gauges.Meter.sourcerect,Sb.PlaySong.Gauges.Meter.pr,Sb.PlaySong.Gauges.Meter.center,0,rl.WHITE)local he=math.floor(50 *dd)he=ClipN(he,0,50)local ie=14 *he-1;if ie>0 then Sb.PlaySong.Gauges.Meter.sourcerect2.width=ie;Sb.PlaySong.Gauges.Meter.pr2.width=ie;rl.DrawTexturePro(Sb.PlaySong.Gauges.Meter.full,Sb.PlaySong.Gauges.Meter.sourcerect2,Sb.PlaySong.Gauges.Meter.pr2,Sb.PlaySong.Gauges.Meter.center,0,rl.WHITE)end;rl.DrawTexturePro(Sb.PlaySong.Gauges.Clear[ed],Sb.PlaySong.Gauges.Clear.sourcerect,Sb.PlaySong.Gauges.Clear.pr,Sb.PlaySong.Gauges.Clear.center,0,rl.WHITE)rl.DrawTexturePro(Sb.PlaySong.Lanes.Lane.default,Sb.PlaySong.Lanes.sourcerect,Sb.PlaySong.Lanes.pr,Sb.PlaySong.Lanes.center,0,rl.WHITE)rl.DrawTexturePro(Sb.PlaySong.Lanes.Lane.sub,Sb.PlaySong.Lanes.ssourcerect,Sb.PlaySong.Lanes.spr,Sb.PlaySong.Lanes.scenter,0,rl.WHITE)rl.DrawTexturePro(Sb.PlaySong.Backgrounds.Taiko.base,Sb.PlaySong.Backgrounds.Taiko.sourcerect,Sb.PlaySong.Backgrounds.Taiko.pr,Sb.PlaySong.Backgrounds.Taiko.center,0,rl.WHITE)for i=1,2 do local re=Xd[i]for i2=1,2 do local se=re[i2]if se.startms then local te=Rd-se.startms;local ue=math.floor(te/Qb)local ve=Xd.anim[ue]if ve then se.color.a=255 *ve;if ve>0 then rl.DrawTexturePro(Sb.PlaySong.Backgrounds.Taiko[i2],re.sourcerect,re.pr,re.center,0,rl.WHITE)end else Xd.startms=nil end end end end;rl.DrawTexturePro(Sb.PlaySong.Backgrounds.ComboText[0],Sb.PlaySong.Backgrounds.ComboText.sourcerect,Sb.PlaySong.Backgrounds.ComboText.pr,Sb.PlaySong.Backgrounds.ComboText.center,0,rl.WHITE)if ad>=10 then local re,se=40 /1280 *C.ScreenWidth,48 /720 *C.ScreenHeight;local te=tostring(ad)local ue=ad<50 and 0 or ad<100 and 1 or 2;local ve=db(te,re,se)eb(Sb.PlaySong.Fonts.Combo[ue],te,250 /1280 *C.ScreenWidth- (ve/2),220 /720 *C.ScreenHeight,re,se)end;local je,ke=26 /1280 *C.ScreenWidth,34 /720 *C.ScreenHeight;local le=tostring(Wc)local me=db(le,je,ke)eb(Sb.PlaySong.Fonts.Score[0],le,160 /1280 *C.ScreenWidth-me,194 /720 *C.ScreenHeight,je,ke)if xd and Rd>=xd then vb[1]=Ad[1]+ (zd[1]* (Rd-xd))vb[2]=Ad[2]+ (zd[2]* (Rd-xd))end;local ne=vb[1]-Lb[1]local oe=vb[2]-Lb[2]Mb[1]=Gb[1]+ne;Mb[2]=Gb[2]+oe;Mb[3]=Gb[3]+ne;Mb[4]=Gb[4]+oe;rl.DrawTexture(Sb.PlaySong.Notes.target,xc(vb[1]*ec)+cc,xc(vb[2]*fc)+dc,rl.WHITE)local pe=0;for i=1,#Vd.notes do local re=i+pe;local se=Vd.notes[re]local te=Vd.startms[re]local ue=Rd-te;local ve=math.floor(ue/Qb)local we=Vd.currenttarget;local xe=Vd.anim[we[1][re]][we[2][re]][ve]if xe then if xe[1]then se.pr.x=xe[1]se.pr.y=xe[2]rl.DrawTexturePro(Sb.PlaySong.Notes[se.type],ac,se.pr,se.tcenter,se.rotationr,rl.WHITE)else end else table.remove(Vd.notes,re)table.remove(Vd.startms,re)table.remove(Vd.currenttarget[1],re)table.remove(Vd.currenttarget[2],re)pe=pe-1 end end;Sd={}Td={}Rc={barline={},drumroll={},balloon={},notes={}}local qe=0;for i=1,#Qc do local re=i+qe;local se=Qc[re]if se then if not(se.hit)and se.data=='note'then if(se.type==1 or se.type==3)and(not Sd[1]or math.abs(Rd-se.ms)<Sd[1])then Sd[1]=math.abs(Rd-se.ms)Td[1]=se elseif(se.type==2 or se.type==4)and(not Sd[2]or math.abs(Rd-se.ms)<Sd[2])then Sd[2]=math.abs(Rd-se.ms)Td[2]=se end end;local te,ue=Dc(se,sd or(Rd+wd))se.p[1]=te*ec;se.p[2]=ue*fc;if Rd>se.ms then bd=se.gogo;if se.type==7 then if id then se.hit=false;if id.n==se.n then se.p[1]=vb[1]*ec;se.p[2]=vb[2]*fc;if not id.setdelay then id.delay=id.delay-id.lengthms;id.setdelay=true end else end end;id=se;jd=se.ms;kd=se.ms+se.lengthms elseif se.type==5 or se.type==6 then nd=se;od=se.ms;pd=se.ms+se.lengthms end end;se.pr.x=xc(se.p[1])+Hb;se.pr.y=xc(se.p[2])+Ib;if ib then if not se.hit and jb[se.type]and Rd>=se.ms then Zd(se)end end;if nb and se.jposscroll and(not se.jposscrolldone)then Bd[#Bd+1]=se;se.jposscrolldone=true end;if mb and se.stopstart and(not se.stopdone)then vd[#vd+1]=se;se.stopdone=true end;if(se.hit and not(mb and se.stopstart and not(Rd>se.stopstart)))or(Rd>se.ms and Ac(se.p[1],se.p[2],Mb[1],Mb[2],Mb[3],Mb[4])==false)then se.done=true;table.remove(Qc,re)qe=qe-1 else if se.data=='event'then if se.event=='barline'then Rc.barline[#Rc.barline+1]=se end else if se.type==8 then Rc.drumroll[#Rc.drumroll+1]=se elseif se.type==7 then Rc.balloon[#Rc.balloon+1]=se else Rc.notes[#Rc.notes+1]=se end end end end end;if ib then local re=Sd[1]local se=Sd[2]local te=(re and se)and( (re<se)and 1 or 2)or(re and 1 or 2)local ue=Sd[te]local ve=Td[te]if not ue or(ue and ue> (Hc.bad* ( ( (ve.type==3 or ve.type==4)and Taiko.Data.BigLeniency)or 1)))then if jd and(Rd>jd and Rd<kd)and not id.pop then ae(1)elseif od and(Rd>od and Rd<pd)then ae(1)end end end;for re,se in pairs(ob.Hit)do if rl.IsKeyPressed(re)then Yd(se[1],se[2])end end;de[2]=tostring(ad)de[4]=tostring(Wc)Sc=Rc.barline;table.sort(Rc.drumroll,be)table.sort(Rc.notes,be)table.sort(Rc.balloon,be)for i=1,#Rc.drumroll do Sc[#Sc+1]=Rc.drumroll[i]end;for i=1,#Rc.notes do Sc[#Sc+1]=Rc.notes[i]end;for i=1,#Rc.balloon do Sc[#Sc+1]=Rc.balloon[i]end;if rd.statusanim then local re=Rd-rd.startms;local se=math.floor(re/Qb)local te=rd.statusanim[se]if te then rl.DrawTexture(te,xc(vb[1]*ec)+oc,xc(vb[2]*fc)+pc,mc)else rd.statusanim=nil end end;for i=1,#Sc do local re=Sc[i]if re then if not re.hit then local se=( (notetype==3 or notetype==4)and Taiko.Data.BigLeniency)or 1;if(not re.brokecombo)and(re.type==1 or re.type==2 or re.type==3 or re.type==4)and Rd-re.ms> (Hc.bad*se)then ad=0;re.brokecombo=true end;if Fd then if re.data=='event'then if re.event=='barline'then rl.DrawTexturePro(Sb.PlaySong.Barlines[re.type],ic,re.pr,re.tcenter,re.rotationr,rl.WHITE)end elseif re.data=='note'then if Sb.PlaySong.Notes[re.type]then rl.DrawTexturePro(Sb.PlaySong.Notes[re.type],ac,re.pr,re.tcenter,re.rotationr,rl.WHITE)elseif re.type==8 then local te=re.startnote;if te.type==5 or te.type==6 then local ue=tb*re.radius;local ve,we=te.p[1],re.p[1]local xe,ye=te.p[2],re.p[2]if xc(we-ve)~=0 or xc(ye-xe)~=0 then local ze=te.scrollx>0;local Ae=te.scrolly<=0;local Be=Sb.PlaySong.Notes.drumrollrect.width;local Ce=Sb.PlaySong.Notes.drumrollrect.height;local De=math.sqrt((we-ve)^2 + (ye-xe)^2)local Ee=(we-ve)/De;local Fe=(ye-xe)/De;local Ge=Be*Ee;local He=Be*Fe;local Ie=re.tcenter.x*Ee;local Je=re.tcenter.y*Fe;we=we-Ie;ye=ye-Je;De=math.sqrt((we-ve)^2 + (ye-xe)^2)local Ke=math.floor(De/Be)local Le=De- (Ke*Be)local Me=Le*Ee;local Ne=Le*Fe;re.drumrollrect.width=Be;re.drumrollrect.height=Ce;local Oe=ve+Hb+Ie;local Pe=xe+Ib+Je;for i=1,Ke do re.drumrollrect.x=Oe;re.drumrollrect.y=Pe;rl.DrawTexturePro(Sb.PlaySong.Notes[te.recttype],ac,re.drumrollrect,re.tcenter,re.rotationr,rl.WHITE)Oe=Oe+Ge;Pe=Pe+He end;re.drumrollrect.width=Le;re.drumrollrect.x=Oe;re.drumrollrect.y=Pe;re.drumrollrect2.x=0;re.drumrollrect2.y=0;re.drumrollrect2.width=re.drumrollrect.width;re.drumrollrect2.height=re.drumrollrect.height;rl.DrawTexturePro(Sb.PlaySong.Notes[te.recttype],re.drumrollrect2,re.drumrollrect,re.tcenter,re.rotationr,rl.WHITE)Oe=Oe+Me;Pe=Pe+Ne;rl.DrawTexturePro(Sb.PlaySong.Notes[te.endtype],ac,re.pr,re.tcenter,re.rotationr,rl.WHITE)end;rl.DrawTexturePro(Sb.PlaySong.Notes[te.notetype],ac,te.pr,te.tcenter,te.rotationr,rl.WHITE)elseif te.type==7 then if te.timeshit==nil then rl.DrawTexturePro(Sb.PlaySong.Notes.balloon,ac,te.pr,te.tcenter,te.rotationr,rl.WHITE)te.pr.x=te.pr.x+te.pr.width;rl.DrawTexturePro(Sb.PlaySong.Notes.balloonend,ac,te.pr,te.tcenter,te.rotationr,rl.WHITE)else local ue=te.requiredhits-te.timeshit;local ve=(Qd.framen-1)-math.ceil(ue/math.floor(te.requiredhits/ (Qd.framen-1)))ve=ve<0 and 0 or ve;if ve==5 then local we=Rd-Qd.startms;local xe=math.floor(we/Qb)local ye=Qd.anim[xe]if ye then Qd.color.a=255 *ye;if ye>0 then rl.DrawTexturePro(Sb.PlaySong.Balloons.Anim[ve],Sb.PlaySong.Balloons.sourcerect,re.balloonrect,Sb.PlaySong.Balloons.center,te.rotationr,Qd.color)end else te.hit=true end else re.balloonrect.x=te.pr.x+te.pr.width;re.balloonrect.y=te.pr.y;rl.DrawTexturePro(Sb.PlaySong.Balloons.Anim[ve],Sb.PlaySong.Balloons.sourcerect,re.balloonrect,Sb.PlaySong.Balloons.center,te.rotationr,rl.WHITE)end end end end else error('Invalid note.data')end end end end end;if rd.explosionanim then local re=Rd-rd.startms;local se=math.floor(re/Qb)local te=rd.explosionanim[se]if te then rl.DrawTexture(te,xc(vb[1]*ec)+oc,xc(vb[2]*fc)+pc,mc)else rd.explosionanim=nil end end;if rd.explosionbiganim then local re=Rd-rd.startms;local se=math.floor(re/Qb)local te=rd.explosionbiganim[se]if te then rl.DrawTexture(te,xc(vb[1]*ec)+oc,xc(vb[2]*fc)+pc,mc)else rd.explosionbiganim=nil end end;rl.EndDrawing()if rl.WindowShouldClose()then rl.CloseWindow()break end;if rl.IsKeyPressed(rl.KEY_F)then rl.ToggleFullscreen()end;if rl.IsKeyPressed(rl.KEY_S)then local re=rl.LoadImageFromScreen()rl.ExportImage(re,B)rl.UnloadImage(re)end;if rl.IsKeyPressed(rl.KEY_ESCAPE)then local re=os.clock()while true do if rl.IsKeyPressed(rl.KEY_ESCAPE)then break end;if rl.WindowShouldClose()then break end end;ee=ee+ (os.clock()-re)end end end;return Taiko.PlaySong(u)end;a='taikobuipm/Saitama 2000.tja'a='tja/neta/donkama/neta.tja'local function n(u)local v=io.open(u,'rb')if v then v:close()return true else return false end end;local o=Taiko.ParseTJAFile(a)song='taikobuipm/Donkama 2000.ogg'local q={[2]=2,[3]=1,[4]=1}if not n(o[1].Metadata.SONG)then for u,w in pairs(o)do w.Metadata.SONG=song end end;Taiko.Game(Taiko.GetDifficulty(o,'Oni'),nil,q)error()function Taiko.SongSelectOld(u,v,w)local x={}local y,z=10,10;local A,B,C,D=-y,y,-z,z;local E=true;local F=1;local G=1;local H=4;local I=5;local J=5;local K=2;local L='V'local M='>'local N=10;local O=nil;local P='>'local Q='>'local R=2;local S=true;local T='_Original_'local U=w or{}local V=false;local W={[2]={'Normal','Auto'},[3]={'Normal','2x Speed','3x Speed','4x Speed','0.25x Speed','0.5x Speed','0.75x Speed'},[4]={'Normal','2x Speed','3x Speed','4x Speed','0.25x Speed','0.5x Speed','0.75x Speed'},[5]={'Normal','Reverse','Invisible','Messy'}}local X={4,1,1,1,1,1}local Y={nil}for ub,vb in pairs(W)do Y[ub]={1,#vb,vb}end;local Z={[1]=nil,[2]={function(ub)return ub,'type',ub.type and(Taiko.Data.Notes.ReverseNotes[ub.type]or ub.type)or ub.type end,function(ub)return ub,'type'end},[3]={function(ub)return ub,'scrollx',10000 end,function(ub)return ub,'scrollx'end},[4]={function(ub)return ub,'type',ub.type and(ub.type==1 and math.random(1,2)or ub.type==2 and math.random(1,2)or ub.type==3 and math.random(3,4)or ub.type==4 and math.random(3,4)or ub.type)end,function(ub)return ub,'type'end}}local ab={window=curses.initscr()}curses.keypad(ab,true)curses.echo(false)curses.raw(true)curses.nl(false)curses.cbreak(true)curses.nodelay(ab,true)curses.getch(ab)curses.nodelay(ab,false)local bb,cb=curses.cols(),curses.lines()O=O or bb-2;local db={Escape={['\27']=true,ALT_ESC=true},Scroll={L={KEY_LEFT=true,KEY_SLEFT=true,CTL_LEFT=true,KEY_B1=true,ALT_LEFT=true,KEY_SHIFT_L=true,KEY_UP=true,KEY_A2=true},R={KEY_RIGHT=true,KEY_SRIGHT=true,CTL_RIGHT=true,KEY_B3=true,ALT_RIGHT=true,KEY_SHIFT_R=true,KEY_DOWN=true,KEY_C2=true}},Select={Init={KEY_ENTER=true,PADENTER=true,CTL_PADENTER=true,ALT_PADENTER=true,CTL_PADCENTER=true,ALT_ENTER=true,CTL_ENTER=true,SHF_PADENTER=true,['\n']=true,['\r']=true},Select={KEY_ENTER=true,PADENTER=true,CTL_PADENTER=true,ALT_PADENTER=true,CTL_PADCENTER=true,ALT_ENTER=true,CTL_ENTER=true,SHF_PADENTER=true,['\n']=true,['\r']=true},Escape={['\27']=true,ALT_ESC=true},L={KEY_LEFT=true,KEY_SLEFT=true,CTL_LEFT=true,KEY_B1=true,ALT_LEFT=true,KEY_SHIFT_L=true},R={KEY_RIGHT=true,KEY_SRIGHT=true,CTL_RIGHT=true,KEY_B3=true,ALT_RIGHT=true,KEY_SHIFT_R=true},U={KEY_UP=true,KEY_A2=true},D={KEY_DOWN=true,KEY_C2=true},Play={Hit={['4']=2,['v']=1,['n']=1,['8']=2},Escape={['\27']=true,ALT_ESC=true},L={KEY_LEFT=true,KEY_SLEFT=true,CTL_LEFT=true,KEY_B1=true,ALT_LEFT=true,KEY_SHIFT_L=true,KEY_UP=true,KEY_DOWN=true},R={KEY_RIGHT=true,KEY_SRIGHT=true,CTL_RIGHT=true,KEY_B3=true,ALT_RIGHT=true,KEY_SHIFT_R=true,KEY_DOWN=true,KEY_C2=true},Select={KEY_ENTER=true,PADENTER=true,CTL_PADENTER=true,ALT_PADENTER=true,CTL_PADCENTER=true,ALT_ENTER=true,CTL_ENTER=true,SHF_PADENTER=true,['\n']=true,['\r']=true}}},Search={Init={ALT_F=true,f=true,F=true},Backspace={['\8']=true,KEY_BACKSPACE=true,ALT_BKSP,CTL_BKSP},FirstResult={KEY_ENTER=true,PADENTER=true,CTL_PADENTER=true,ALT_PADENTER=true,CTL_PADCENTER=true,ALT_ENTER=true,CTL_ENTER=true,SHF_PADENTER=true,['\n']=true,['\r']=true},Select={KEY_RIGHT=true,KEY_SRIGHT=true,CTL_RIGHT=true,KEY_B3=true,ALT_RIGHT=true,KEY_SHIFT_R=true},Up={KEY_A2=true,KEY_UP=true},Down={KEY_C2=true,KEY_DOWN=true},Escape={['\27']=true,ALT_ESC=true}},Add={Init={ALT_N=true,n=true,N=true},Backspace={['\8']=true,KEY_BACKSPACE=true,ALT_BKSP,CTL_BKSP},Select={KEY_ENTER=true,PADENTER=true,CTL_PADENTER=true,ALT_PADENTER=true,CTL_PADCENTER=true,ALT_ENTER=true,CTL_ENTER=true,SHF_PADENTER=true,['\n']=true,['\r']=true}},StandardInput={Backspace={['\8']=true,KEY_BACKSPACE=true,ALT_BKSP,CTL_BKSP},Escape={KEY_ENTER=true,PADENTER=true,CTL_PADENTER=true,ALT_PADENTER=true,CTL_PADCENTER=true,ALT_ENTER=true,CTL_ENTER=true,SHF_PADENTER=true,['\n']=true,['\r']=true},L={KEY_LEFT=true,KEY_SLEFT=true,CTL_LEFT=true,KEY_B1=true,ALT_LEFT=true,KEY_SHIFT_L=true,KEY_UP=true,KEY_DOWN=true},R={KEY_RIGHT=true,KEY_SRIGHT=true,CTL_RIGHT=true,KEY_B3=true,ALT_RIGHT=true,KEY_SHIFT_R=true,KEY_DOWN=true,KEY_C2=true}},Reload={Init={r=true}},ReloadAll={Init={R=true}},Rename={Init={KEY_F2=true}}}local eb={ClearScreen=function()io.write("\27[2J")end,SetCursor=function(ub,vb)io.write(string.format("\27[%d;%dH",vb,ub))end,ClearLine=function()io.write("\27[2K")end,CursorLeft=function(ub)io.write(string.format("\27[%dD",ub))end,CursorRight=function(ub)io.write(string.format("\27[%dC",ub))end,SaveCursor=function()io.write("\27[s")end,RestoreCursor=function()io.write("\27[u")end}local function fb(ub)return ub..string.rep(' ',O-#ub)end;local function gb()local ub=curses.getch(ab)local vb=curses.getkeyname(ub)return ub,vb end;local function hb()local ub=''local vb=0;local wb=vb;while true do local xb,yb=gb()if db.StandardInput.Backspace[yb]then ub=string.sub(ub,1,vb-1)..string.sub(ub,vb+1,-1)vb=vb-1 elseif db.StandardInput.Escape[yb]then io.write('\n')return ub elseif db.StandardInput.L[yb]then vb=vb-1 elseif db.StandardInput.R[yb]then vb=vb+1 else ub=string.sub(ub,1,vb)..yb..string.sub(ub,vb+1,-1)vb=vb+1 end;vb=ClipN(vb,0,#ub)local zb=vb-wb;if zb<0 then eb.CursorLeft(-zb)elseif zb>0 then eb.CursorRight(zb)end;eb.SaveCursor()eb.ClearLine()io.write('\r')io.write(ub)eb.RestoreCursor()wb=vb end end;local function ib(ub)return ub>=32 and ub<=126 end;local function jb(ub,vb,wb,xb)return(ub and(vb..string.sub(wb,#vb+1,-1))or wb)..xb end;local function kb(ub,vb,wb)return ub>wb and vb or ub<vb and wb or ub end;local lb={[0]='No',[1]='Yes'}local function mb(ub)return ub and lb[1]or lb[0]end;local function nb(ub)return ub*100 ..'%'end;local function ob(ub)return MsToS(ub)..'s'end;local function pb(ub)return ob(SToMs(ub))end;local function qb(ub)return tonumber(ub)and tonumber(ub)or 0 end;local function rb(ub,vb,wb)ub[T..vb]=ub[vb]ub[vb]=wb end;local function sb(ub,vb)ub[vb]=ub[T..vb]end;local tb={}eb.ClearScreen()while true do x={}if E then x[A]={}for i=F-I,F+I do local yb=nil;if i<1 then yb=#u+i elseif i>#u then yb=i-#u else yb=i end;local zb=u[yb]if zb then x[0]=x[0]or{}x[0][(i-F)*J]=zb end end;local wb={}local xb=string.rep(' ',K)for y=C,D do wb[#wb+1]=jb(y==0,M,xb,'')wb[#wb+1]=fb(x[0]and x[0][y]or'')wb[#wb+1]='\n'end;eb.SetCursor(1,1)print(table.concat(wb))else x[0]={}x[0][C]=L;for i=F-I,F+I do local xb=nil;if i<1 then xb=#u+i elseif i>#u then xb=i-#u else xb=i end;local yb=u[xb]if yb then local zb=(i-F)*J;x[zb]=x[zb]or{}local Ab=C+K;for i2=1,#yb do x[zb][Ab]=string.sub(yb,i2,i2)Ab=Ab+1 end end end;local wb={}for y=C,D do for x=A,B do if x[x]and x[x][y]then local xb=x[x][y]if ib(string.byte(xb))then wb[#wb+1]=xb else wb[#wb+1]=' 'end else wb[#wb+1]=' 'end end;wb[#wb+1]='\n'end;eb.SetCursor(1,1)print(table.concat(wb))end;local ub,vb=gb()if db.Scroll.L[vb]then F=F-1 elseif db.Scroll.R[vb]then F=F+1 elseif db.Select.Init[vb]then local wb;if S then if tb[F]then wb=tb[F]else wb=Taiko.ParseTJA(v[F])tb[F]=wb end else wb=Taiko.ParseTJA(v[F])end;local xb={}for Bb,Cb in pairs(wb)do xb[#xb+1]={Bb,Cb.Metadata.COURSE}end;table.sort(xb,function(Bb,Cb)return Bb[2]<Cb[2]end)min=1;max=#xb;Y[1]={min,max,xb}DifficultyMap=xb;X[1]=ClipN(X[1],min,max)local yb=string.rep(' ',R)eb.ClearScreen()eb.SetCursor(1,1)local zb=nil;local Ab=G;while true do G=ClipN(G,1,5)if G~=Ab then H=X[G]Ab=G end;local Bb=Y[G]min,max=Bb[1],Bb[2]H=kb(H,min,max)X[G]=H;eb.SetCursor(1,1)local Cb=DifficultyMap[X[1]][2]zb=Taiko.GetDifficulty(wb,Cb)local Db=zb.Metadata;local Eb=Taiko.Analyze(zb)local Fb={{'',Db.TITLE},{'\t',Db.SUBTITLE},{'',''},{'','Select Options:'},{jb(G==1,Q,yb,'Difficulty: '),Taiko.Data.CourseName[Db.COURSE]},{jb(G==2,Q,yb,'Mode: '),W[2][X[2]]},{jb(G==3,Q,yb,'Note Speed: '),W[3][X[3]]},{jb(G==4,Q,yb,'Song Speed: '),W[4][X[4]]},{jb(G==5,Q,yb,'Modifiers: '),W[5][X[5]]},{'',''},{'Difficulty: ',Taiko.Data.CourseName[Db.COURSE]},{'Stars: ',Db.LEVEL},{'Diverge Notes: ',mb(Db.DIVERGENOTES)},{'',''},{'','Statistics:'},{'Length: ',ob(Eb.lengthms)},{'Don (DON) / Ka (KA): ',qb(Eb.notes[1])..' + ('..qb(Eb.notes[3])..') / '..qb(Eb.notes[2])..' + ('..qb(Eb.notes[4])..') = '..nb((qb(Eb.notes[1])+qb(Eb.notes[3]))/Eb.notes.validn)..' / '..nb((qb(Eb.notes[2])+qb(Eb.notes[4]))/Eb.notes.validn)},{'Max Score (without drumroll): ',Eb.maxscore},{'Max Combo: ',Eb.maxcombo},{'Drumroll Time (total): ',ob(Eb.drumrollms+Eb.drumrollbigms)},{'Balloon Time: ',ob(Eb.balloonms)},{'Balloon Hits: ',Eb.balloonhit},{'Special Time: ',ob(Eb.specialms)},{'Special Hits: ',Eb.specialhit},{'',''},{'','Press Enter to Play!'}}for i=1,#Fb do local Ib=Fb[i]print(fb(Ib[1]..tostring(Ib[2])))end;local Gb,Hb=gb()if db.Select.L[Hb]then H=H-1 elseif db.Select.R[Hb]then H=H+1 elseif db.Select.U[Hb]then G=G-1 elseif db.Select.D[Hb]then G=G+1 elseif db.Select.Select[Hb]then local Ib=Z[X[5]]if Ib and Ib[1]then local Jb=Ib[1]Taiko.ForAll(zb.Data,function(Kb,Lb,Mb)rb(Jb(Kb))end)end;while true do local Jb,Kb=Taiko.PlaySong(zb,ab,X,db.Select.Play)if Jb and Kb then break elseif Jb=='Retry'then else break end end;curses.nodelay(ab,false)eb.ClearScreen()if Ib and Ib[2]then local Jb=Ib[2]Taiko.ForAll(zb.Data,function(Kb,Lb,Mb)sb(Jb(Kb))end)end elseif db.Select.Escape[Hb]then break end end elseif db.Search.Init[vb]then local wb=''local xb={}local yb=1;local zb=nil;local Ab=1;eb.ClearScreen()eb.SetCursor(1,1)print('Searching...')while true do eb.SetCursor(#wb+1,2)local Bb,Cb=gb()eb.SetCursor(1,2)if db.Search.Backspace[Cb]then wb=string.sub(wb,1,-2)elseif db.Search.FirstResult[Cb]then zb=xb[1]break elseif db.Search.Select[Cb]then zb=xb[Ab]break elseif db.Search.Down[Cb]then Ab=Ab+1 elseif db.Search.Up[Cb]then Ab=Ab-1 elseif db.Search.Escape[Cb]then break else wb=wb..Cb end;print(fb(wb))local Db=k.SearchHeaderAll(u,wb)for i=1,N do if Db[i]and Db[i][2]==-math.huge then yb=i-1;break elseif i==N then yb=i end end;Ab=ClipN(Ab,1,yb)local Eb=false;for i=1,N do local Fb=Db[i]if Eb then print(fb(''))else if Fb then if Fb[2]==-math.huge then Eb=true;print(fb(''))else print(fb((i==Ab and P or i)..'. '..Db[i][3]))xb[i]=Fb end end end end end;F=(zb and zb[1]or F)or F elseif db.Add.Init[vb]then print('Import a Custom Song')while true do print('Enter a .tja or .tjac file path (with the file extention)')local wb=hb()local xb=io.open(wb,'rb')if xb then local yb=xb:read('*all')if EndsWith(wb,'.tja')then print('Enter a song name')local zb=hb()local Ab=#u+1;u[Ab]=zb;v[Ab]=yb;U[Ab]={wb}break elseif EndsWith(wb,'.tjac')then local zb,Ab=k.Decompress(yb)for i=1,#zb do local Bb=#u+1;u[Bb]=Ab[i]v[Bb]=zb[i]U[Bb]={wb,zb}end;break else print('Invalid file type')end;xb:close()else print('Unable to read file')end end elseif db.Reload.Init[vb]then print('Reloading selected file...')if U[F]then local wb=U[F]local xb=io.open(wb[1],'rb')if xb then local yb=xb:read('*all')local zb=F;if wb[2]then local Ab,Bb=k.Decompress(yb)if V then u[zb]=Bb[i]end;v[zb]=Ab[i]else v[zb]=yb end;if S then tb[zb]=nil end;xb:close()else print('Unable to read file')end else print('File source not found')end elseif db.ReloadAll.Init[vb]then print('Reloading all files...')local wb={}for xb,yb in pairs(U)do wb[yb[1]]=wb[yb[1]]and wb[yb[1]]or{}wb[yb[1]][#wb[yb[1]]+1]={xb,yb[2]}end;for xb,yb in pairs(wb)do local zb=io.open(xb,'rb')if zb then local Ab=zb:read('*all')if yb[1][2]then local Bb,Cb=k.Decompress(Ab)for i=1,#yb do local Db=yb[i]if V then u[Db[1]]=Cb[Db[2]]end;v[Db[1]]=Bb[Db[2]]if S then tb[Db[1]]=nil end end else for i=1,#yb do local Bb=yb[i]v[Bb[1]]=Ab;if S then tb[Bb[1]]=nil end end end;zb:close()else print('Unable to read file')end end elseif db.Rename.Init[vb]then print('Enter a song name')local wb=hb()u[F]=wb elseif db.Escape[vb]then return end;F=kb(F,1,#u)end end;local r='./CompactTJA/taikobuipm.tjac'r='./CompactTJA/ESE/06 Classical.tjac'r='./CompactTJA/ESE/ESE.tjac'local function t(u)local v,w,x={},{},{}for i=1,#u do local y=u[i]v[#v+1]=y:gsub('(.-)/','')local z=io.open(y,'r')local A=z:read('*all')z:close()w[#w+1]=A;x[#x+1]=y end;return v,w,x end;Taiko.SongSelect(t({'./tja/neta/ekiben/spiraltest.tja','./tja/neta/ekiben/delay.tja','./tja/neta/ekiben/neta.tja','./tja/neta/kita/kita.tja','./taikobuipm/Kita Saitama 2000.tja'}))error()
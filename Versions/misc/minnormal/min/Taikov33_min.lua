#!.\raylua_s.exe 
require'strict'local function k(s)local t=""local u=0;local v=s;if s<0x80 then return string.char(s)end;topspace=0x20;while s>topspace do local y=bit.bor(bit.band(s,0x3F),0x80)t=string.char(y)..t;s=bit.rshift(s,6)u=u+1;topspace=bit.rshift(topspace,1)end;local w=bit.lshift(bit.rshift(0xFF,7 -u),7 -u)local x=bit.bor(w,s)return string.char(x)..t end;local function l(s,u,...)if u~=nil then s={s,u,...}end;local v={}for w,x in ipairs(s)do if x<0x80 then v[#v+1]=string.char(x)elseif x<0x800 then v[#v+1]=string.char(bit.bor(bit.rshift(x,6),0xc0))v[#v+1]=string.char(bit.bor(bit.band(x,0x3F),0x80))elseif x<0x10000 then v[#v+1]=string.char(bit.bor(bit.rshift(x,12),0xe0))v[#v+1]=string.char(bit.bor(bit.band(bit.rshift(x,6),0x3F),0x80))v[#v+1]=string.char(bit.bor(bit.band(x,0x3F),0x80))elseif x<0x200000 then v[#v+1]=string.char(bit.bor(bit.rshift(x,18),0xf0))v[#v+1]=string.char(bit.bor(bit.band(bit.rshift(x,12),0x3F),0x80))v[#v+1]=string.char(bit.bor(bit.band(bit.rshift(x,6),0x3F),0x80))v[#v+1]=string.char(bit.bor(bit.band(x,0x3F),0x80))else v[#v+1]=k(x)end end;return table.concat(v)end;local function m(t)local u,v,w={},0,nil;for i=1,#t do local x=string.byte(t,i)if v==0 then table.insert(u,w)v=x<0x80 and 1 or x<0xE0 and 2 or x<0xF0 and 3 or x<0xF8 and 4 or x<0xFC and 5 or x<0xFE and 6 or error("invalid UTF-8 character sequence")w=bit.band(x,2 ^ (8 -v)-1)else w=bit.bor(bit.lshift(w,6),bit.band(x,0x3F))end;v=v-1 end;table.insert(u,w)return u end;local function n(s)return string.char(bit.band(bit.rshift(s,8),0xFF),bit.band(s,0xFF))end;local function o(s)return string.char(bit.band(s,0xFF),bit.band(bit.rshift(s,8),0xFF))end;local function p(s,t)if t<0x10000 then return s(t)else t=t-0x10000;return s(0xD800 +bit.rshift(t,10))..s(0xDC00 +bit.band(t,0x3FF))end end;local function q(s)local u={'\255\254'}for i=1,#s do u[#u+1]=p(o,s[i])end;return table.concat(u)end;do local s=require'ffi's.cdef[[
    typedef struct {
    char *fpos;
    void *base;
    unsigned short handle;
    short flags;
    short unget;
    unsigned long alloc;
    unsigned short buffincrement;
    } FILE;

    FILE *fopen(const char *filename, const char *mode);
    int fclose(FILE *stream);


    void *malloc(int64_t);
    void free(void *);

    int fseek(FILE *stream, long int offset, int whence);
    long int ftell(FILE *stream);

    size_t fread(void *ptr, size_t size, size_t nmemb, FILE *stream);
    size_t fwrite(const void *ptr, size_t size, size_t nmemb, FILE *stream);

    ]]local t=s.os=='Windows'local u;local v;if t then s.cdef[[
        FILE *_wfopen(const wchar_t *filename, const wchar_t *mode);
        ]]u=function(y)local z=#y+1;local A=s.new('wchar_t[?]',z)for i=1,#y do A[i-1]=y[i]end;A[#y]=0;return A end end;local w={}local x=io.open;function w.open(y,z)local A=m(y)local B=false;for i=1,#A do if A[i]>255 then B=true;break end end;if B==false then return x(y,z)end;local C;if t then local D=u(A)local E=u(m(z))C=s.C._wfopen(D,E)else C=s.C.fopen(y,z)end;if C==nil then return nil end;return setmetatable({file=C},{__index=w})end;function w.read(y,z)if string.sub(z,1,2)~='*a'then error('File.read: Does not support mode')end;local A=y.file;s.C.fseek(A,0,2)local B=s.C.ftell(A)s.C.fseek(A,0,0)if B~=-1 then local C=s.cast('char *',s.C.malloc(B+1))s.C.fread(C,B,1,A)C[B]=0;local D=s.string(C,B)s.C.free(C)return D else error('File error')end end;function w.write(y,z)local A=y.file;s.C.fwrite(z,#z,1,A)end;function w.close(y)local z=y.file;s.C.fclose(z)end;io.open=w.open end;do local s='\\'local t='\\'local u=-0.005;local v=-0.005;local w=-0.01;local x=1.0;local y=0.9;local z=0.8;local A=0.7;local B=0.6;local C=math.huge;local D=-math.huge;local E=1024;local F={}function F.has_match(hb,ib,jb)if not jb then hb=string.lower(hb)ib=string.lower(ib)end;local kb=1;for i=1,string.len(hb)do kb=string.find(ib,hb:sub(i,i),kb,true)if not kb then return false else kb=kb+1 end end;return true end;local function G(hb)return hb:match("%l")end;local function H(hb)return hb:match("%u")end;local function I(hb)local ib={}local jb="/"for i=1,string.len(hb)do local kb=hb:sub(i,i)if jb=="/"or jb=="\\"then ib[i]=y elseif jb=="-"or jb=="_"or jb==" "then ib[i]=z elseif jb=="."then ib[i]=B elseif G(jb)and H(kb)then ib[i]=A else ib[i]=0 end;jb=kb end;return ib end;local function J(hb,ib,jb,kb,lb)local mb=I(ib)local nb=string.len(hb)local ob=string.len(ib)if not lb then hb=string.lower(hb)ib=string.lower(ib)end;local pb={}for i=1,ob do pb[i]=ib:sub(i,i)end;for i=1,nb do jb[i]={}kb[i]={}local qb=D;local rb=i==nb and v or w;local sb=hb:sub(i,i)for j=1,ob do if sb==pb[j]then local tb=D;if i==1 then tb=( (j-1)*u)+mb[j]elseif j>1 then local ub=kb[i-1][j-1]+mb[j]local vb=jb[i-1][j-1]+x;tb=math.max(ub,vb)end;jb[i][j]=tb;qb=math.max(tb,qb+rb)kb[i][j]=qb else jb[i][j]=D;qb=qb+rb;kb[i][j]=qb end end end end;function F.score(hb,ib,jb)local kb=string.len(hb)local lb=string.len(ib)if kb==0 or lb==0 or lb>E or kb>lb then return D elseif hb==ib then return C else local mb={}local nb={}J(hb,ib,mb,nb,jb)return nb[kb][lb]end end;function F.positions(hb,ib,jb)local kb=string.len(hb)local lb=string.len(ib)if kb==0 or lb==0 or lb>E or kb>lb then return{},D elseif kb==lb then local rb={}for i=1,kb do rb[i]=i end;return rb,C end;local mb={}local nb={}J(hb,ib,mb,nb,jb)local ob={}local pb=false;local qb=lb;for i=kb,1,-1 do while qb>=1 do if mb[i][qb]~=D and(pb or mb[i][qb]==nb[i][qb])then pb=(i~=1)and(qb~=1)and(nb[i][qb]==mb[i-1][qb-1]+x)ob[i]=qb;qb=qb-1;break else qb=qb-1 end end end;return ob,nb[kb][lb]end;function F.filter(hb,ib,jb)local kb={}for lb,mb in ipairs(ib)do if F.has_match(hb,mb,jb)then local nb,ob=F.positions(hb,mb,jb)table.insert(kb,{lb,nb,ob})end end;return kb end;function F.get_score_min()return D end;function F.get_score_max()return C end;function F.get_max_length()return E end;function F.get_score_floor()return E*w end;function F.get_score_ceiling()return E*x end;function F.get_implementation_name()return"lua"end;local K=function(hb,ib)return F.score(ib,hb)end;local function L(hb,ib)return string.gsub(string.gsub(hb,s,s..s),ib,s..ib)end;local function M(hb,ib)return string.gsub(string.gsub(hb,s..ib,ib),s..s,s)end;local function N(hb,ib,jb)local kb={}local lb=''for mb,nb in string.gmatch(hb,'([^'..ib..']*)('..ib..'?)')do local ob,pb=string.sub(mb,-2,-2),string.sub(mb,-1,-1)local qb=true;if ob==jb then if pb==jb then else end else if pb==jb then lb=lb..string.sub(mb,1,-2)..nb;qb=false else end end;if qb then lb=lb..mb;kb[#kb+1]=lb;lb=''end;if nb==''then return kb end end;return error(unpack(kb))end;local O=string.char;local P=type;local Q=select;local R=string.sub;local S=table.concat;local T={}local U={}for i=0,255 do local hb,ib=O(i),O(i,0)T[hb]=ib;U[ib]=hb end;local function V(hb,ib,jb,kb)if jb>=256 then jb,kb=0,kb+1;if kb>=256 then ib={}kb=1 end end;ib[hb]=O(jb,kb)jb=jb+1;return ib,jb,kb end;local function W(hb)if P(hb)~="string"then return nil,"string expected, got "..P(hb)end;local ib=#hb;if ib<=1 then return"u"..hb end;local jb={}local kb,lb=0,1;local mb={"c"}local nb=1;local ob=2;local pb=""for i=1,ib do local qb=R(hb,i,i)local rb=pb..qb;if not(T[rb]or jb[rb])then local sb=T[pb]or jb[pb]if not sb then return nil,"algorithm error, could not fetch word"end;mb[ob]=sb;nb=nb+#sb;ob=ob+1;if ib<=nb then return"u"..hb end;jb,kb,lb=V(rb,jb,kb,lb)pb=qb else pb=rb end end;mb[ob]=T[pb]or jb[pb]nb=nb+#mb[ob]ob=ob+1;if ib<=nb then return"u"..hb end;return S(mb)end;local function X(hb,ib,jb,kb)if jb>=256 then jb,kb=0,kb+1;if kb>=256 then ib={}kb=1 end end;ib[O(jb,kb)]=hb;jb=jb+1;return ib,jb,kb end;local function Y(hb)if P(hb)~="string"then return nil,"string expected, got "..P(hb)end;if#hb<1 then return nil,"invalid input - not a compressed string"end;local ib=R(hb,1,1)if ib=="u"then return R(hb,2)elseif ib~="c"then return nil,"invalid input - not a compressed string"end;hb=R(hb,2)local jb=#hb;if jb<2 then return nil,"invalid input - not a compressed string"end;local kb={}local lb,mb=0,1;local nb={}local ob=1;local pb=R(hb,1,2)nb[ob]=U[pb]or kb[pb]ob=ob+1;for i=3,jb,2 do local qb=R(hb,i,i+1)local rb=U[pb]or kb[pb]if not rb then return nil,"could not find last from dict. Invalid input?"end;local sb=U[qb]or kb[qb]if sb then nb[ob]=sb;ob=ob+1;kb,lb,mb=X(rb..R(sb,1,1),kb,lb,mb)else local tb=rb..R(rb,1,1)nb[ob]=tb;ob=ob+1;kb,lb,mb=X(tb,kb,lb,mb)end;pb=qb end;return S(nb)end;local function Z(hb)if string.sub(hb,1,3)=='\239\187\191'then return string.sub(hb,4,-1)else return hb end end;local ab='\n'local bb=','local cb=true;local function db(hb)local ib={}for i=1,#hb do print(string.match(hb[i],'\nTITLE:(.-)\n'))local jb=string.match(hb[i],'TITLE:(.-)\n')or string.match(hb[i],'TITLE:(.-)\r')if not jb then print'input title'jb=io.read()end;ib[#ib+1]=L(jb,bb)end;return table.concat(ib,bb)..ab end;local function eb(hb)local ib=string.find(hb,ab)local jb=N(string.sub(hb,1,ib-1),bb,s)for i=1,#jb do jb[i]=M(jb[i],bb)end;return jb,string.sub(hb,ib+1,-1)end;local function fb(hb,ib)local jb={}for i=1,#hb do jb[i]={i,K(hb[i],ib),hb[i]}end;table.sort(jb,function(kb,lb)return kb[2]>lb[2]end)return jb end;local function gb(hb,ib)local jb=fb(hb,ib)return jb[1][1]end;Compact={}function Compact.Read(hb)local ib=io.open(hb,'rb')local jb=ib:read('*all')ib:close()return jb end;function Compact.Write(hb,ib)local jb=io.open(hb,'wb+')jb:write(ib)jb:close()end;function Compact.Compress(hb)for i=1,#hb do hb[i]=L(Z(hb[i]),t)end;local ib=table.concat(hb,t)local jb=W(ib)jb=db(hb)..jb;print('Before chars: '..#ib..'\nAfter Chars:'..#jb..'\nAfter/Before: '.. (#jb/#ib)..'\nCompression Rate: '.. (#ib/#jb)..'x')return jb end;function Compact.Decompress(hb)local ib,jb=eb(hb)local kb=Y(jb)local lb=N(kb,t,s)return lb,ib end;function Compact.ListFiles(hb)local ib={}for i=1,#hb do ib[#ib+1]=hb[i]end;table.sort(ib)return table.concat(ib,'\n')end;function Compact.Search(hb,ib,jb)local kb=gb(ib,jb)if kb then return hb[kb]else return nil end end;function Compact.Input(hb)local ib,jb=Compact.Decompress(hb)print(Compact.ListFiles(jb))print('Song Name:')local kb=io.read()local lb=Compact.Search(ib,jb,kb)if lb then return lb else error('Invalid input')end end;function Compact.InputFile(hb)return Compact.Input(Compact.Read(hb))end;function Compact.Merge(hb)local ib={}for i=1,#hb do local jb=Compact.Decompress(hb[i])for i=1,#jb do ib[#ib+1]=jb[i]end end;return Compact.Compress(ib)end;function Compact.CompressDir(hb,ib)local function jb(ob)local pb,qb,rb=0,{},io.popen;local sb=rb('dir "'..ob..'" /b')for tb in sb:lines()do pb=pb+1;qb[pb]=tb end;sb:close()return qb end;local kb=hb;local lb=jb(kb)local mb={}local nb={}for i=1,#lb do local ob=lb[i]local pb=jb(kb..'\\'..ob)if#pb~=0 and pb[1]~=ob then local qb=Compact.CompressDir(kb..'\\'..ob,true)for i=1,#qb do nb[#nb+1]=qb[i]end elseif(not mb[ob])and string.sub(ob,-3,-1)=='tja'then print(ob)nb[#nb+1]=kb..'\\'..ob else end end;if ib then return nb else for i=1,#nb do local ob=io.open(nb[i],'r')nb[i]=ob:read('*all')ob:close()end;return Compact.Compress(nb)end end;Compact.SearchHeader=gb;Compact.SearchHeaderAll=fb;Compact.Search=K end;do Replay={}Replay.Version='beta-2'Replay.Notes={['1']={1,false},['2']={2,false},['3']={1,true},['4']={2,true}}local s=string.char;local t=type;local u=select;local v=string.sub;local w=table.concat;local x={}local y={}for i=0,255 do local D,E=s(i),s(i,0)x[D]=E;y[E]=D end;local function z(D,E,F,G)if F>=256 then F,G=0,G+1;if G>=256 then E={}G=1 end end;E[D]=s(F,G)F=F+1;return E,F,G end;local function A(D)if t(D)~="string"then return nil,"string expected, got "..t(D)end;local E=#D;if E<=1 then return"u"..D end;local F={}local G,H=0,1;local I={"c"}local J=1;local K=2;local L=""for i=1,E do local M=v(D,i,i)local N=L..M;if not(x[N]or F[N])then local O=x[L]or F[L]if not O then return nil,"algorithm error, could not fetch word"end;I[K]=O;J=J+#O;K=K+1;if E<=J then return"u"..D end;F,G,H=z(N,F,G,H)L=M else L=N end end;I[K]=x[L]or F[L]J=J+#I[K]K=K+1;if E<=J then return"u"..D end;return w(I)end;local function B(D,E,F,G)if F>=256 then F,G=0,G+1;if G>=256 then E={}G=1 end end;E[s(F,G)]=D;F=F+1;return E,F,G end;local function C(D)if t(D)~="string"then return nil,"string expected, got "..t(D)end;if#D<1 then return nil,"invalid input - not a compressed string"end;local E=v(D,1,1)if E=="u"then return v(D,2)elseif E~="c"then return nil,"invalid input - not a compressed string"end;D=v(D,2)local F=#D;if F<2 then return nil,"invalid input - not a compressed string"end;local G={}local H,I=0,1;local J={}local K=1;local L=v(D,1,2)J[K]=y[L]or G[L]K=K+1;for i=3,F,2 do local M=v(D,i,i+1)local N=y[L]or G[L]if not N then return nil,"could not find last from dict. Invalid input?"end;local O=y[M]or G[M]if O then J[K]=O;K=K+1;G,H,I=B(N..v(O,1,1),G,H,I)else local P=N..v(N,1,1)J[K]=P;K=K+1;G,H,I=B(P,G,H,I)end;L=M end;return w(J)end;function Replay.Read(D)local E=io.open(D,'rb')local F=E:read('*all')E:close()return F end;function Replay.Write(D,E)local F=io.open(D,'wb+')F:write(E)F:close()end;function Replay.TranscodeRaw(D)local E={}for F,G in pairs(D)do local H=string.find(F,' ')E[tonumber(string.sub(F,1,H-1))]=tonumber(string.sub(F,H+1,-1))end;return E end;function Replay.TranscodeRawKey(D)local E={}for F,G in pairs(D)do for i=1,#G do local H=G[i]E[H]=E[H]and E[H]or{}E[H][#E[H]+1]=F end end;return E end;function Replay.Save(D,E)local F={}local G,H,I=0;for K,L in pairs(D)do H=(not H or K<H)and K or H;I=(not I or K>I)and K or I;G=G+1 end;F={'version ',Replay.Version,'\ntotalms ',tostring(I-H),'\nactivecount ',tostring(G)}E=E or{}for i=1,#E do F[#F+1]=E[i]end;F[#F+1]='\ndata 'local J={}for K,L in pairs(D)do J[#J+1]=tostring(K)J[#J+1]=' 'J[#J+1]=table.concat(L)J[#J+1]='\n'end;F[#F+1]=A(table.concat(J))return table.concat(F)end;function Replay.Load(D)local E,F=string.find(D,'data ')local G=string.sub(D,1,E-1)local H={}string.gsub(G,'(.-) (.-)\n',function(M,N)H[M]=N end)local I=string.sub(D,F+1,-1)local J=C(I)local K={}local L=1;while true do local M,N=string.find(J,'\n',L)if not M then break end;local O=string.sub(J,L,M-1)L=N+1;local P=string.find(O,' ')local Q=string.sub(O,1,P-1)local R=string.sub(O,P+1,-1)local S={}for i2=1,#R do S[#S+1]=string.sub(R,i2,i2)end;K[tonumber(Q)]=S end;return K,H end end;do Persistent={}function Persistent.Read(t)local u=io.open(t,'rb')local v=u:read('*all')u:close()return v end;function Persistent.Write(t,u)local v=io.open(t,'wb+')v:write(u)v:close()end;local s=function(t,u)local v={}for x in pairs(t)do v[#v+1]=x end;if u then table.sort(v,function(x,y)return u(t,x,y)end)else table.sort(v)end;local w=0;return function()w=w+1;if v[w]then return v[w],t[v[w]]end end end;function Persistent.Save(u,v,w)local x=v;v=v or{'Automatically generated by Persistent.\nThis file will be read and overwritten.\nDO NOT EDIT\n'}w=w and w+1 or 1;v[#v+1]='{\n'for y,z in s(u,function(y,z,A)return tostring(z)<tostring(A)end)do v[#v+1]=string.rep('\t',w)if type(y)=='string'then v[#v+1]='\''v[#v+1]=y;v[#v+1]='\''elseif type(y)=='number'or type(y)=='boolean'or type(y)=='nil'then v[#v+1]=tostring(y)else error('Invalid key type, '..type(y))end;v[#v+1]=' = 'if type(z)=='table'then Persistent.Save(z,v,w)elseif type(z)=='string'then v[#v+1]='\''v[#v+1]=z;v[#v+1]='\''elseif type(z)=='number'or type(z)=='boolean'or type(z)=='nil'then v[#v+1]=tostring(z)else error('Invalid value type, '..type(z))end;v[#v+1]=',\n'end;v[#v+1]=string.rep('\t',w-1)v[#v+1]='}'if not x then return table.concat(v)end end;function Persistent.Load(t)local u={}local v=0;local w=0;local x=true;local y=0;local z=true;local A=false;local B={}local C={}local D={}local E=u;local F=string.find(t,'{')-1;repeat F=F+1;if string.sub(t,F,F+2)==' = 'then z=false;A=true;C={}F=F+3 end;local G=string.sub(t,F,F)if G=='{'then v=v+1;if v>=2 then z=true;A=false;local H=table.concat(B)H=string.sub(H,1,1)=='\''and string.sub(H,2,-2)or tonumber(H)and tonumber(H)or H=='true'and true or H=='false'and false;D[#D+1]=H;B={}local I=u;for i=1,#D-1 do I=I[D[i]]end;I[D[#D]]={}E=I[D[#D]]end elseif G=='}'then v=v-1;if#D>=1 then D[#D]=nil;local H=u;for i=1,#D do H=H[D[i]]end;E=H end elseif G=='\''and y%2 ==0 then w=x and w+1 or w-1;x=not x elseif G=='\\'then y=y+1 end;if z and G~='{'and G~='}'and G~=','and G~='\t'and G~='\n'and G~='\r'and G~=' 'then B[#B+1]=G end;if A then if w==0 and G==','then local H=table.concat(B)H=string.sub(H,1,1)=='\''and string.sub(H,2,-2)or tonumber(H)and tonumber(H)or H=='true'and true or H=='false'and false;local I=table.concat(C)I=string.sub(I,1,1)=='\''and string.sub(I,2,-2)or tonumber(I)and tonumber(I)or I=='true'and true or I=='false'and false;E[H]=I;z=true;A=false;B={}else C[#C+1]=G end end;if G~='\\'then y=0 end until F>=#t;return u end end;do TextureMap={}function TextureMap.SplitUsingMap(s,t,u,v,w)v=v or{1,1}w=w or{0,0}local function x(y)local z={}for A,B in pairs(y)do local C=false;for D,E in pairs(B)do if type(E)=='table'then C=true end end;if C then z[A]=x(B)else z[A]=rl.ImageFromImage(s,rl.new('Rectangle',B[1]*v[1]+w[1],B[2]*v[2]+w[2],(B[3]or u[1])-1 +w[1],(B[4]or u[2])-1 +w[2]))end end;return z end;return x(t)end;function TextureMap.LoadTextureFromImage(s)local t=rl.LoadTextureFromImage(s)rl.UnloadImage(s)return t end;function TextureMap.ReplaceWithTexture(s)local function t(u)local v={}for w,x in pairs(u)do if type(x)=='table'then v[w]=t(x)else v[w]=TextureMap.LoadTextureFromImage(x)end end;return v end;return t(s)end;function TextureMap.SplitAndReplaceWithTexture(...)return TextureMap.ReplaceWithTexture(TextureMap.SplitUsingMap(...))end end;do IniParser={}function IniParser.Read(t)local u=io.open(t,'rb')local v=u:read('*all')u:close()return v end;function IniParser.Write(t,u)local v=io.open(t,'wb+')v:write(u)v:close()end;local s=function(t,u)local v={}for x in pairs(t)do v[#v+1]=x end;if u then table.sort(v,function(x,y)return u(t,x,y)end)else table.sort(v)end;local w=0;return function()w=w+1;if v[w]then return v[w],t[v[w]]end end end;function IniParser.Save(u)local v={}local w={}for x,y in s(u,function(x,y,z)return tostring(y)<tostring(z)end)do if type(y)=='table'then w[#w+1]='['w[#w+1]=tostring(x)w[#w+1]=']\n'for z,A in s(y,function(z,A,B)return tostring(A)<tostring(B)end)do w[#w+1]=tostring(z)w[#w+1]=' = 'w[#w+1]=tostring(A)w[#w+1]='\n'end;w[#w+1]='\n'else v[#v+1]=tostring(x)v[#v+1]=' = 'v[#v+1]=tostring(y)v[#v+1]='\n'end end;return table.concat(v).. (#w~=0 and('\n\n'..table.concat(w))or'')end;function IniParser.Load(t)local u={}local v=nil;local w=1;while true do local x=string.find(t,'\n',w)local y=string.find(t,'\r\n',w)if y and y<x then x=y end;if not x then break end;local z=string.sub(t,w,x-1)local A=string.find(z,'%[')if A then local C=string.find(z,'%]')if C then v=string.sub(z,A+1,C-1)end end;local B=string.find(z,'=')if B then local C=B-1;while true do local F=string.sub(z,C,C)if string.find(F,'%s')then C=C-1 else break end end;local D=B+1;while true do local F=string.sub(z,D,D)if string.find(F,'%s')then D=D+1 else break end end;local E=u;if v then u[v]=u[v]or{}E=u[v]end;E[string.sub(z,1,C)]=string.sub(z,D,-1)end;w=x+ (y and 2 or 1)end;return u end;function IniParser.ParseCSV(t)local u=','local v='\\'local w={}local x=''local y=false;for i=1,#t do local z=string.sub(t,i,i)if y then x=x..z;y=false else if z==u then table.insert(w,x)x=''elseif z==v then y=true else x=x..z end end end;table.insert(w,x)return w end;function IniParser.ParseCSVN(t)local u=IniParser.ParseCSV(t)for i=1,#u do local v=tonumber(u[i])if v then u[i]=v else error('IniParser: csvn value not a number')end end;return u end end;do Romaji={}Romaji.Data={To={['a']={'あ','ア'},['i']={'い','イ'},['u']={'う','ウ'},['e']={'え','エ'},['o']={'お','オ'},['ka']={'か','カ'},['ki']={'き','キ'},['ku']={'く','ク'},['ke']={'け','ケ'},['ko']={'こ','コ'},['kya']={'きゃ','キャ'},['kyu']={'きゅ','キュ'},['kyo']={'きょ','キョ'},['sa']={'さ','サ'},['shi']={'し','シ'},['su']={'す','ス'},['se']={'せ','セ'},['so']={'そ','ソ'},['sha']={'しゃ','シャ'},['shu']={'しゅ','シュ'},['sho']={'しょ','ショ'},['ta']={'た','タ'},['chi']={'ち','チ'},['tsu']={'つ','ツ'},['te']={'て','テ'},['to']={'と','ト'},['cha']={'ちゃ','チャ'},['chu']={'ちゅ','チュ'},['cho']={'ちょ','チョ'},['na']={'な','ナ'},['ni']={'に','ニ'},['nu']={'ぬ','ヌ'},['ne']={'ね','ネ'},['no']={'の','ノ'},['nya']={'にゃ','ニャ'},['nyu']={'にゅ','ニュ'},['nyo']={'にょ','ニョ'},['ha']={'は','ハ'},['hi']={'ひ','ヒ'},['fu']={'ふ','フ'},['he']={'へ','ヘ'},['ho']={'ほ','ホ'},['hya']={'ひゃ','ヒャ'},['hyu']={'ひゅ','ヒュ'},['hyo']={'ひょ','ヒョ'},['ma']={'ま','マ'},['mi']={'み','ミ'},['mu']={'む','ム'},['me']={'め','メ'},['mo']={'も','モ'},['mya']={'みゃ','ミャ'},['myu']={'みゅ','ミュ'},['myo']={'みょ','ミョ'},['ya']={'や','ヤ'},['yu']={'ゆ','ユ'},['yo']={'よ','ヨ'},['ra']={'ら','ラ'},['ri']={'り','リ'},['ru']={'る','ル'},['re']={'れ','レ'},['ro']={'ろ','ロ'},['rya']={'りゃ','リャ'},['ryu']={'りゅ','リュ'},['ryo']={'りょ','リョ'},['wa']={'わ','ワ'},['wo']={'を','ヲ'},['n']={'ん','ン'},['ga']={'が','ガ'},['gi']={'ぎ','ギ'},['gu']={'ぐ','グ'},['ge']={'げ','ゲ'},['go']={'ご','ゴ'},['gya']={'ぎゃ','ギャ'},['gyu']={'ぎゅ','ギュ'},['gyo']={'ぎょ','ギョ'},['za']={'ざ','ザ'},['ji']={'じ','ジ'},['zu']={'ず','ズ'},['ze']={'ぜ','ゼ'},['zo']={'ぞ','ゾ'},['ja']={'じゃ','ジャ'},['ju']={'じゅ','ジュ'},['jo']={'じょ','ジョ'},['da']={'だ','ダ'},['ji']={'ぢ','ヂ'},['zu']={'づ','ヅ'},['de']={'で','デ'},['do']={'ど','ド'},['ja']={'ぢゃ','ヂャ'},['ju']={'ぢゅ','ヂュ'},['jo']={'ぢょ','ヂョ'},['ba']={'ば','バ'},['bi']={'び','ビ'},['bu']={'ぶ','ブ'},['be']={'べ','ベ'},['bo']={'ぼ','ボ'},['bya']={'びゃ','ビャ'},['byu']={'びゅ','ビュ'},['byo']={'びょ','ビョ'},['pa']={'ぱ','パ'},['pi']={'ぴ','ピ'},['pu']={'ぷ','プ'},['pe']={'ぺ','ペ'},['po']={'ぽ','ポ'},['pya']={'ぴゃ','ピャ'},['pyu']={'ぴゅ','ピュ'},['pyo']={'ぴょ','ピョ'},['si']={'し','シ'},['kka']={'っか','ッカ'},['kki']={'っき','ッキ'},['kku']={'っく','ック'},['kke']={'っけ','ッケ'},['kko']={'っこ','ッコ'},['kkya']={'っきゃ','ッキャ'},['kkyu']={'っきゅ','ッキュ'},['kkyo']={'っきょ','ッキョ'},['ssa']={'っさ','ッサ'},['sshi']={'っし','ッシ'},['ssu']={'っす','ッス'},['sse']={'っせ','ッセ'},['sso']={'っそ','ッソ'},['ssha']={'っしゃ','ッシャ'},['sshu']={'っしゅ','ッシュ'},['ssho']={'っしょ','ッショ'},['tta']={'った','ッタ'},['cchi']={'っち','ッチ'},['ttsu']={'っつ','ッツ'},['tte']={'って','ッテ'},['tto']={'っと','ット'},['ccha']={'っちゃ','ッチャ'},['cchu']={'っちゅ','ッチュ'},['ccho']={'っちょ','ッチョ'},['hha']={'っは','ッハ'},['hhi']={'っひ','ッヒ'},['ffu']={'っふ','ッフ'},['hhe']={'っへ','ッヘ'},['hho']={'っほ','ッホ'},['hhya']={'っひゃ','ッヒャ'},['hhyu']={'っひゅ','ッヒュ'},['hhyo']={'っひょ','ッヒョ'},['mma']={'っま','ッマ'},['mmi']={'っみ','ッミ'},['mmu']={'っむ','ッム'},['mme']={'っめ','ッメ'},['mmo']={'っも','ッモ'},['mmya']={'っみゃ','ッミャ'},['mmyu']={'っみゅ','ッミュ'},['mmyo']={'っみょ','ッミョ'},['yya']={'っや','ッヤ'},['yyu']={'っゆ','ッユ'},['yyo']={'っよ','ッヨ'},['rra']={'っら','ッラ'},['rri']={'っり','ッリ'},['rru']={'っる','ッル'},['rre']={'っれ','ッレ'},['rro']={'っろ','ッロ'},['rrya']={'っりゃ','ッリャ'},['rryu']={'っりゅ','ッリュ'},['rryo']={'っりょ','ッリョ'},['wwa']={'っわ','ッワ'},['wwo']={'っを','ッヲ'},['gga']={'っが','ッガ'},['ggi']={'っぎ','ッギ'},['ggu']={'っぐ','ッグ'},['gge']={'っげ','ッゲ'},['ggo']={'っご','ッゴ'},['ggya']={'っぎゃ','ッギャ'},['ggyu']={'っぎゅ','ッギュ'},['ggyo']={'っぎょ','ッギョ'},['zza']={'っざ','ッザ'},['jji']={'っじ','ッジ'},['zzu']={'っず','ッズ'},['zze']={'っぜ','ッゼ'},['zzo']={'っぞ','ッゾ'},['jja']={'っじゃ','ッジャ'},['jju']={'っじゅ','ッジュ'},['jjo']={'っじょ','ッジョ'},['dda']={'っだ','ッダ'},['jji']={'っぢ','ッヂ'},['zzu']={'っづ','ッヅ'},['dde']={'っで','ッデ'},['ddo']={'っど','ッド'},['jja']={'っぢゃ','ッヂャ'},['jju']={'っぢゅ','ッヂュ'},['jjo']={'っぢょ','ッヂョ'},['bba']={'っば','ッバ'},['bbi']={'っび','ッビ'},['bbu']={'っぶ','ッブ'},['bbe']={'っべ','ッベ'},['bbo']={'っぼ','ッボ'},['bbya']={'っびゃ','ッビャ'},['bbyu']={'っびゅ','ッビュ'},['bbyo']={'っびょ','ッビョ'},['ppa']={'っぱ','ッパ'},['ppi']={'っぴ','ッピ'},['ppu']={'っぷ','ップ'},['ppe']={'っぺ','ッペ'},['ppo']={'っぽ','ッポ'},['ppya']={'っぴゃ','ッピャ'},['ppyu']={'っぴゅ','ッピュ'},['ppyo']={'っぴょ','ッピョ'}}}function Romaji.ToHiragana(s)local t=1;local u=string.lower(s)local v={}local w=1;while true do local x=false;if not x and w<#u-1 then local y=string.sub(u,w,w+2)if Romaji.Data.To[y]then v[#v+1]=Romaji.Data.To[y][t]w=w+3;x=true end end;if not x and w<#u then local y=string.sub(u,w,w+1)if Romaji.Data.To[y]then v[#v+1]=Romaji.Data.To[y][t]w=w+2;x=true end end;if not x then local y=string.sub(u,w,w)if Romaji.Data.To[y]then v[#v+1]=Romaji.Data.To[y][t]w=w+1;x=true end end;if not x then v[#v+1]=string.sub(u,w,w)w=w+1 end;if w>#u then break end end;return table.concat(v)end;function Romaji.ToRomaji(s)end end;String={}String.Split=function(s,t)local u={}for v,w in s:gmatch("([^"..t.."]*)("..t.."?)")do table.insert(u,v)if w==''then return u end end end;String.Trim=function(t)local u=t:gsub("^%s*(.-)%s*$","%1")return u end;String.TrimLeft=function(t)local u=t:gsub("^%s*(.-)$","%1")return u end;String.TrimRight=function(t)local u=t:gsub("^(.-)%s*$","%1")return u end;String.StartsWith=function(s,t)return s:sub(1,#t)==t end;String.EndsWith=function(s,t)return s:sub(-#t,-1)==t end;Table={}function Table.Clone(s,t)t=t or{}local u=type(s)local v;if u=='table'then if t[s]then v=t[s]else v={}t[s]=v;for w,x in next,s,nil do v[Table.Clone(w,t)]=Table.Clone(x,t)end;setmetatable(v,Table.Clone(getmetatable(s),t))end else v=s end;return v end;ClipN=function(s,t,u)if s<t then return t elseif s>u then return u else return s end end;function Error(s)error(s)end;LineN=nil;function ParseError(s,t,u)Error('Line: '..LineN..'\n'..s..': '..t.. (u and(', '..u)or''))end;function MsToS(s)return s/1000 end;function SToMs(t)return t*1000 end;function HexToRGB(s)s=string.gsub(s,'#','')if#s==3 then return(tonumber('0x'..string.sub(s,1,1))*17), (tonumber('0x'..string.sub(s,2,2))*17), (tonumber('0x'..string.sub(s,3,3))*17)else return(tonumber('0x'..string.sub(s,1,2))), (tonumber('0x'..string.sub(s,3,4))), (tonumber('0x'..string.sub(s,5,6)))end end;Taiko={}Taiko.Data={Languages={'','EN','JA','CN','TW','KO'},GenreAlias={Pop={'pop','j-pop'},Anime={'anime','アニメ'},Kids={'kids','どうよう'},Variety={'variety','バラエティ'},VOCALOID={'vocaloid','ボーカロイド'},Classic={'classic','クラシック'},['Game Music']={'game music','ゲームミュージック'},['Namco Original']={'namco original','ナムコオリジナル'}},CourseId={easy=0,normal=1,hard=2,oni=3,edit=4,tower=5,dan=6,ura=4},CourseName={[0]='Easy','Normal','Hard','Oni','Edit','Tower','Dan','Ura'},RatingMultiplier={[0]=0,[1]=0.5,[2]=1,[3]=2},GogoMultiplier=1.2,ScoreMode={Note={[0]=function(s,t,u,v,w,x)return math.floor((s+ ( ( (t<200)and(u or 1000)or( (u or 1000)+ (v or 1000)))*Taiko.Data.RatingMultiplier[w]* (x and Taiko.Data.GogoMultiplier or 1)))/10)*10 end,[1]=function(s,t,u,v,w,x)return math.floor((s+ ( (u+math.max(0,v*math.floor((math.min(t,100)-1)/10)))*Taiko.Data.RatingMultiplier[w]* (x and Taiko.Data.GogoMultiplier or 1)))/10)*10 end,[2]=function(s,t,u,v,w,x)return math.floor((s+ ( (u+v* ( (t>=100)and 8 or(t>=50)and 4 or(t>=30)and 2 or(t>=10)and 1 or 0))*Taiko.Data.RatingMultiplier[w]* (x and Taiko.Data.GogoMultiplier or 1)))/10)*10 end},Drumroll={[0]=function(s,t,u)return s+ ( (t==5 and 300 or t==6 and 600)* (u and Taiko.Data.GogoMultiplier or 1))end,[1]=function(s,t,u)return s+ ( (t==5 and 300 or t==6 and 600)* (u and Taiko.Data.GogoMultiplier or 1))end,[2]=function(s,t,u)return s+ ( (t==5 and 100 or t==6 and 200)* (u and Taiko.Data.GogoMultiplier or 1))end},Balloon={[0]=function(s,t,u)return s+ ( (t==7 and 300)* (u and Taiko.Data.GogoMultiplier or 1))end,[1]=function(s,t,u)return s+ ( (t==7 and 300)* (u and Taiko.Data.GogoMultiplier or 1))end,[2]=function(s,t,u)return s+ ( (t==7 and 300)* (u and Taiko.Data.GogoMultiplier or 1))end},BalloonPop={[0]=function(s,t,u)return s+ ( (t==7 and 5000)* (u and Taiko.Data.GogoMultiplier or 1))end,[1]=function(s,t,u)return s+ ( (t==7 and 5000)* (u and Taiko.Data.GogoMultiplier or 1))end,[2]=function(s,t,u)return s+ ( (t==7 and 5000)* (u and Taiko.Data.GogoMultiplier or 1))end}},Autoscore={[0]=function(s)end,[1]=function(s)end,[2]=function(s)end},SideId={normal=1,ex=2,both=3},SideName={'normal','ex','both'},StyleId={single=1,double=2,couple=2},StyleName={'single','double'},Exam={Condition={g=true,jp=true,jg=true,jb=true,s=true,r=true,h=true,c=true},Scope={m=true,l=true}},Branch={PathId={N=0,E=1,M=2},PathName={[0]='N',[1]='E',[2]='M'},Requirements={r=function()end,p=function()end}},Timing={Level={[0]={good=75,ok=108,bad=125},[1]={good=58,ok=108,bad=125},[2]={good=42,ok=108,bad=125},[3]={good=42,ok=75,bad=108},[4]={good=25,ok=75,bad=108},[5]={good=25,ok=58,bad=108},[6]={good=17,ok=42,bad=108}},Course=function(s)if s==0 or s==1 then return 2 else return 4 end end},StatusId={bad=0,ok=1,good=2,biggood=3},StatusName={[0]='BAD',[1]='OK',[2]='GOOD',[3]='GOOD'},ModeId={['']=0,P1=1,P2=2},ModeName={[0]='','P1','P2'},Combo={[1]=true,[2]=true,[3]=true,[4]=true},BigLeniency=2,Gauge={Soul={[0]=function(s)local t=10000 /s*1.575;local u=t*0.75;local v=t/-2;return{[2]=t,[1]=u,[0]=v}end,[1]=function(s)local t=10000 /s/0.7;local u=t*0.75;local v=t/-0.75;return{[2]=t,[1]=u,[0]=v}end,[2]=function(s)local t=10000 /s*1.5;local u=t*0.75;local v=t/-0.8;return{[2]=t,[1]=u,[0]=v}end,[3]=function(s)local t=10000 /s/0.7;local u=t*0.5;local v=t*-1.6;return{[2]=t,[1]=u,[0]=v}end,[4]=function(s)local t=10000 /s/0.7;local u=t*0.5;local v=t*-1.6;return{[2]=t,[1]=u,[0]=v}end},Percent=function(s)return(s/200)/50 end,ClearPercent=0.8,OverflowPercent=1},SENotes={[1]={1,2,3},[2]={4,5},[3]={6,6,6},[4]={7,7},[5]={8,9,10},[6]={11,9,10},[7]={12}},Notes={ReverseNotes={[0]=0,[1]=2,[2]=1,[3]=4,[4]=3,[5]=5,[6]=6,[7]=7,[8]=8,[9]=9}},BigNoteMul=1.5}function Taiko.ReplaceNewline(s)return string.gsub(s,'\r\n','\n')end;function Taiko.ParseWebVTT(s)end;local function r(s)local t=math.floor(s/ (1000 *60 *60))local u=math.floor((s% (1000 *60 *60))/ (1000 *60))local v=math.floor((s% (1000 *60))/ (1000))local w=math.floor((s% (1000))/ (1))local x={}if t~=0 then local B=tostring(t)if#B>=2 then else x[#x+1]='0'end;x[#x+1]=B;x[#x+1]=':'else x[#x+1]='00:'end;local y=tostring(u)if#y>=2 then else x[#x+1]='0'end;x[#x+1]=y;x[#x+1]=':'local z=tostring(v)if#z>=2 then else x[#x+1]='0'end;x[#x+1]=z;x[#x+1]='.'local A=tostring(w)if#A==1 then x[#x+1]='00'elseif#A==2 then x[#x+1]='0'else end;x[#x+1]=A;return table.concat(x)end;function Taiko.SerializeWebVTT(s,u)table.sort(s,function(w,x)return w.ms<x.ms end)local v={'WEBVTT\n\n'}for i=1,#s do local w=s[i]if w.data~=''then local x=w.ms;v[#v+1]=r(x)v[#v+1]=' --> 'local y=nil;if w.lengthms then y=x+w.lengthms elseif i~=#s then y=s[i+1].ms else y=u end;v[#v+1]=r(y)v[#v+1]=w.data;v[#v+1]='\n\n'end end;if v[#v]=='\n\n'then v[#v]=nil end;return table.concat(v)end;function Taiko.ParseTJA(s)local t=os.clock()local u=true;local v=true;local w=true;local x={}local y={Flag={PARSER_FORCE_OLD_SPEED_CALCULATION=false,PARSER_FORCE_OLD_NOTERADIUS=false,PARSER_FORCE_OLD_TARGET=false},Metadata={SUBTITLE='',BPM=120,WAVE='main.mp3',OFFSET=0,DEMOSTART=0,SCOREMODE=1,SONGVOL=100,SEVOL=100,SIDE=3,LIFE=0,GAME='Taiko',HEADSCROLL=1,MOVIEOFFSET=0,COURSE='ONI',LEVEL=0,BALLOON=nil,BALLOONNOR=nil,BALLOONEXP=nil,BALLOONMAS=nil,STYLE=1,EXAM1=nil,EXAM2=nil,EXAM3=nil,GAUGEINCR='NORMAL',TOTAL=nil,HIDDENBRANCH=0,DIVERGENOTES=false,SCOREINIT=0,SCOREDIFF=0,STOPSONG=false},Data={},Lyric={}}if string.find(s,'$PARSER_FORCE_OLD_SPEED_CALCULATION')then y.Flag.PARSER_FORCE_OLD_SPEED_CALCULATION=true elseif string.find(s,'$PARSER_FORCE_OPENTAIKO_SPEED_CALCULATION')then else end;if string.find(s,'$PARSER_FORCE_OLD_NOTERADIUS')then y.Flag.PARSER_FORCE_OLD_NOTERADIUS=true else end;if string.find(s,'$PARSER_FORCE_OLD_TARGET')then y.Flag.PARSER_FORCE_OLD_TARGET=true end;if string.find(s,'$PARSER_FORCE_OLD_BPMCHANGE')then y.Flag.PARSER_FORCE_OLD_BPMCHANGE=true end;local function z(W)local X=Taiko.Data.Languages;for i=1,#X do local Y=y.Metadata[W..X[i]]if Y then return Y end end;return nil end;local function A(W,X,Y)local Z=tonumber(X)if Z then return Z else ParseError(W,Y,X)end end;local function B(W,X,Y,Z)if X then return X else ParseError(W,Y,Z)end end;local function C(W,X,Y)local Z={['true']=true,['false']=false,yes=true,no=false,['1']=true,['0']=false,[1]=true,[0]=false}local ab=Z[X]~=nil;if ab then return ab else ParseError(W,Y,X)end end;local function D(W,X)local Y=','local Z='\\'local ab={}local bb=''local cb=false;for i=1,#X do local db=string.sub(X,i,i)if cb then bb=bb..db;cb=false else if db==Y then table.insert(ab,bb)bb=''elseif db==Z then cb=true else bb=bb..db end end end;table.insert(ab,bb)return ab end;local function E(W,X,Y)local Z=D(W,X)for i=1,#Z do Z[i]=A(W,Z[i],Y,X)end;return Z end;local function F(W,X,Y)if X and X~=''then return E(W,X,Y)else return{}end end;local function G(W,X,Y)if X and X~=''then local Z=D(W,X,Y)B(W,Taiko.Data.Exam.Condition[Z[1]],Y)Z[2]=A(W,Z[2],Y)Z[3]=A(W,Z[3],Y)B(W,Taiko.Data.Exam.Scope[Z[4]],Y)return Z else return{}end end;local H=error;local function I(W)return string.find(W,'/')end;local function J(W)return string.match(W,'(.+)/(.+)')end;local function K(W)local X=nil;local Y=false;local Z=''for i=1,#W do local ab=string.sub(W,i,i)if ab=='+'or ab=='-'then if X then H('There are multiple signs')else X=ab end elseif ab=='.'then if Y then H('There are multiple decimal points')else Z=Z..ab;Y=true end elseif tonumber(ab)then Z=Z..ab end end;if Z==''then H('No number was found')end;return tonumber((X or'+')..Z)end;local function L(W)local X=tonumber(W)if X then return X end;local Y=string.gsub(W,'[^%d%.%-%+]','')if Y==''then return 0 end;return tonumber(Y)or K(W)or K(Y)end;local function M(W)return string.find(W,'i')end;local function N(W)local X={0,0}local Y=false;local Z=''for i=1,#W do local ab=string.sub(W,i,i)if ab=='+'or ab=='-'then X[1]=X[1]+L(Z)Z=ab elseif ab=='i'then X[2]=X[2]+L(Z)Z=''else Z=Z..ab end end;if Z~=''then X[1]=X[1]+L(Z)end;return X end;local function O(W)local X=String.Split(W,'%+')local Y={}for i=1,#X do local bb=String.Split(X[i],'%-')for i=1,#bb do if i==1 then Y[#Y+1]=bb[i]else Y[#Y+1]='-'..bb[i]end end end;X=Y;local Z={0,0}local ab={false,false}for i=1,#X do if X[i]~=''then local bb=false;if string.find(X[i],'i')then bb=true;X[i]=string.gsub(X[i],'i','')end;if I(X[i])then local cb=false;if string.find(X[i],'%-')then cb=true end;local db,eb=J(X[i])X[i]=(db/eb)ab[bb and 2 or 1]=true;if cb then X[i]=-X[i]end else X[i]=tonumber(X[i])end;if bb then Z[2]=Z[2]+X[i]else Z[1]=Z[1]+X[i]end end end;return Z,ab end;local function P(W)return string.find(W,',')end;local function Q(W,X)return{W*math.cos(X),W*math.sin(X)}end;local function R(W)return String.Split(W,' ')end;local S={}local function T()local W={settings={noteparse={notes={[0]=true,[1]=true,[2]=true,[3]=true,[4]=true,[5]=true,[6]=true,[7]=true,[8]=true,[9]=true,['A']=true,['B']=true}},command={matchexceptions={}},directionweight={R=0,U=90,L=180,D=270,['0']=0,['1']=90,['2']=270,['3']=45,['4']=315,['5']=180,['6']=135,['7']=225}},bpm=0,ms=0,songstarted=false,timingpoint=nil,sign=4 /4,mpm=0,mspermeasure=0,scrollx=-1,scrolly=0,measuredone=true,currentmeasure={},measurepushto=y.Data,barline=true,insertbarline=true,gogo=false,lastlong=nil,balloonn=1,currentbranch=nil,branch={on=false,requirements={},paths={}},msbeforebranch=nil,section=false,disablescroll=false,attachbpmchange=false,stopsong=false,delay=0,suddenappear=nil,suddenmove=nil,senotems=nil,senotei=false,lastsenote=nil,lastlastsenote=nil,senotechange=nil,jposscroll={lengthms=nil,p=nil,lanep=nil},zeroopt=u}function W.createnote(X)if X then local Y={ms=nil,data=nil,type=X,txt=nil,gogo=W.gogo,scrollx=(W.scrollx*y.Metadata.HEADSCROLL),scrolly=(W.scrolly*y.Metadata.HEADSCROLL),mspermeasure=W.mspermeasure,bpm=W.bpm,nextnote=nil,radius=1,requiredhits=nil,lengthms=nil,endnote=nil,section=nil,text=nil,delay=W.delay,senote=nil,appearancems=W.suddenappear,movems=W.suddenmove,dummy=W.dummy,onnotepush=nil,currentbranch=W.currentbranch,line=LineN}if X==3 or X==4 or X==6 then Y.radius=Y.radius*Taiko.Data.BigNoteMul end;if X==5 or X==6 or X==7 or X==9 then if W.lastlong then if X==9 then else ParseError('parser.noteparse','Last long note has not ended')end else W.lastlong=Y;if X==7 or X==9 then Y.requiredhits=B('parser.noteparse',y.Metadata.BALLOON[W.balloonn],'Invalid number of balloons',W.balloonn)W.balloonn=W.balloonn+1 end end end;if X==8 then local Z=W.lastlong;W.lastlong=nil;Y.startnote=Z;if Z then Y.onnotepush=function()Z.lengthms=Y.ms-Z.ms;Z.endnote=Y end else end end;if W.section then Y.section=true;W.section=false end;if W.senotechange then Y.senote=W.senotechange;W.senotechange=nil end;return Y else return{ms=nil,data=nil,type=nil,txt=nil,gogo=W.gogo,scrollx=(W.scrollx*y.Metadata.HEADSCROLL),scrolly=(W.scrolly*y.Metadata.HEADSCROLL),mspermeasure=W.mspermeasure,bpm=W.bpm,nextnote=nil,delay=W.delay,appearancems=W.suddenappear,movems=W.suddenmove,currentbranch=W.currentbranch,line=LineN}end end;function W.createbarline()local X=W.createnote()X.ms=W.ms;X.data='event'X.event='barline'return X end;function W.endbranch()local X=W.createnote()X.data='event'X.event='branch'X.branch={requirements=W.branch.requirements,paths=W.branch.paths}W.branch.on=false;W.currentbranch=nil;W.branch.requirements={}W.branch.paths={}table.insert(y.Data,X)W.measurepushto=y.Data end;return W end;S=T()local U=String.Split(s,'\n')for i=1,#U do LineN=i;local W=String.Trim(U[i])if String.StartsWith(W,'//')or W==''then else local X=string.find(W,'//')if X then W=string.sub(W,1,X-1)end;local Y=false;if S.songstarted==false and Y==false then local Z={string.match(W,'(%u+):(.*)')}if Z[1]then local ab=String.Trim(Z[2])if ab~=''then y.Metadata[String.Trim(Z[1])]=ab end;Y=true end end;if(S.songstarted or String.StartsWith(W,'#START')or String.StartsWith(W,'#BMSCROLL')or String.StartsWith(W,'#HBSCROLL')or String.StartsWith(W,'#NMSCROLL'))and Y==false then local Z={string.match(W,'#(%u-)%s(.*)')}if not Z[1]then Z={string.match(W,'#(%u+)')}end;if Z[1]then if Z[1]=='START'then if S.songstarted then ParseError(Z[1],'Song has already started')else y.OriginalMetadata=Table.Clone(y.Metadata)if Z[2]then y.Metadata.MODE=B(Z[1],Taiko.Data.ModeId[Z[2]],'Invalid mode',Z[2])else y.Metadata.MODE=0 end;y.Metadata.TITLE=B(Z[1],z('TITLE'),'Title is missing')y.Metadata.SUBTITLE=B(Z[1],z('SUBTITLE'),'Subtitle is missing')y.Metadata.BPM=A(Z[1],y.Metadata.BPM,'Invalid bpm')y.Metadata.OFFSET=SToMs(A(Z[1],y.Metadata.OFFSET,'Invalid offset'))y.Metadata.DEMOSTART=SToMs(A(Z[1],y.Metadata.DEMOSTART,'Invalid demostart'))if y.Metadata.DEMOSTART==0 then y.Metadata.DEMOSTART=nil end;for db,eb in pairs(Taiko.Data.GenreAlias)do for i=1,#eb do if eb[i]==y.Metadata.GENRE then y.Metadata.GENRE=db end end end;y.Metadata.SCOREMODE=A(Z[1],y.Metadata.SCOREMODE,'Invalid scoremode')B(Z[1],Taiko.Data.ScoreMode.Note[y.Metadata.SCOREMODE],'Invalid scoremode',y.Metadata.SCOREMODE)if y.Metadata.MAKER then y.Metadata.CREATORURLT={}y.Metadata.CREATOR=String.Trim(string.gsub(y.Metadata.MAKER,'(<.->)',function(db)table.insert(y.Metadata.CREATORURLT,string.sub(db,2,-2))return''end))y.Metadata.CREATORURL=table.concat(y.Metadata.CREATORURLT,', ')y.Metadata.CREATIVE=false else y.Metadata.CREATIVE=false end;y.Metadata.SONGVOL=A(Z[1],y.Metadata.SONGVOL,'Invalid songvol')/100;y.Metadata.SEVOL=A(Z[1],y.Metadata.SEVOL,'Invalid sevol')/100 /2;local ab=tonumber(y.Metadata.SIDE)if ab then B(Z[1],Taiko.Data.SideName[ab],'Invalid side id',y.Metadata.SIDE)y.Metadata.SIDE=ab else y.Metadata.SIDE=B(Z[1],Taiko.Data.SideId[string.lower(y.Metadata.SIDE)],'Invalid side name',y.Metadata.SIDE)end;y.Metadata.LIFE=A(Z[1],y.Metadata.LIFE,'Invalid life')if y.Metadata.LIFE==0 then y.Metadata.LIFE=nil end;y.Metadata.GAME=string.lower(y.Metadata.GAME)if y.Metadata.GAME=='taiko'then elseif y.Metadata.GAME=='jube'then else end;y.Metadata.HEADSCROLL=A(Z[1],y.Metadata.HEADSCROLL,'Invalid headscroll')y.Metadata.MOVIEOFFSET=A(Z[1],y.Metadata.MOVIEOFFSET,'Invalid movieoffset')local bb=tonumber(y.Metadata.COURSE)if bb then B(Z[1],Taiko.Data.CourseName[bb],'Invalid course id',y.Metadata.COURSE)y.Metadata.COURSE=bb else y.Metadata.COURSE=B(Z[1],Taiko.Data.CourseId[string.lower(y.Metadata.COURSE)],'Invalid course name',y.Metadata.COURSE)end;y.Metadata.TIMING=Taiko.Data.Timing.Course(y.Metadata.COURSE)y.Metadata.LEVEL=ClipN(math.floor(A(Z[1],y.Metadata.LEVEL,'Invalid level')),0,10)y.Metadata.BALLOON=F(Z[1],y.Metadata.BALLOON,'Invalid balloon')y.Metadata.SCOREINIT=A(Z[1],y.Metadata.SCOREINIT,'Invalid scoreinit')y.Metadata.SCOREDIFF=A(Z[1],y.Metadata.SCOREDIFF,'Invalid scoreinit')y.Metadata.BALLOONNOR=F(Z[1],y.Metadata.BALLOONNOR,'Invalid balloonnor')y.Metadata.BALLOONEXP=F(Z[1],y.Metadata.BALLOONEXP,'Invalid balloonexp')y.Metadata.BALLOONMAS=F(Z[1],y.Metadata.BALLOONMAS,'Invalid balloonmas')local cb=tonumber(y.Metadata.STYLE)if cb then B(Z[1],Taiko.Data.StyleName[cb],'Invalid style id',Taiko.Data.STYLE)y.Metadata.STYLE=cb else y.Metadata.STYLE=B(Z[1],Taiko.Data.StyleId[string.lower(y.Metadata.STYLE)],'Invalid style name',y.Metadata.STYLE)end;y.Metadata.EXAM1=G(y.Metadata.EXAM1)y.Metadata.EXAM2=G(y.Metadata.EXAM2)y.Metadata.EXAM3=G(y.Metadata.EXAM3)y.Metadata.GAUGEINCR=string.lower(y.Metadata.GAUGEINCR)if y.Metadata.TOTAL then y.Metadata.TOTAL=A(Z[1],y.Metadata.TOTAL,'Invalid total')end;y.Metadata.HIDDENBRANCH=C(Z[1],y.Metadata.HIDDENBRANCH,'Invalid hiddenbranch')S.bpm=y.Metadata.BPM;S.songstarted=true end elseif Z[1]=='END'then if S.songstarted then if#S.currentmeasure~=0 then ParseError(Z[1],'Current measure is not empty')end;table.insert(x,y)y={Flag=y.Flag,Metadata=Table.Clone(y.OriginalMetadata),Data={},Lyric={}}S=T()S.songstarted=false;S.measurepushto=y.Data else ParseError(Z[1],'Song has already ended')end elseif Z[1]=='MEASURE'then local ab,bb=J(Z[2])ab=A(Z[1],ab,'Invalid measure')bb=A(Z[1],bb,'Invalid measure')S.sign=(ab/bb)or S.sign elseif Z[1]=='BPMCHANGE'then S.bpm=A(Z[1],Z[2],'Invalid bpmchange')or S.bpm;if S.attachbpmchange then table.insert(S.currentmeasure,{'BPMCHANGE',S.bpm})end elseif Z[1]=='DELAY'then local ab=SToMs((A(Z[1],Z[2],'Invalid delay')or 0))if y.Metadata.STOPSONG then S.delay=S.delay+ab end;table.insert(S.currentmeasure,{'DELAY',ab})elseif Z[1]=='SCROLL'then if S.disablescroll then else if v and M(Z[2])then local ab=N(Z[2])S.scrollx=-ab[1]S.scrolly=-ab[2]elseif v and P(Z[2])then local ab=E(Z[1],Z[2],'Invalid polar scroll')if#ab==3 then local bb=Q(ab[1],math.rad(ab[3]/ab[2]*360))S.scrollx=-bb[1]S.scrolly=-bb[2]else ParseError(Z[1],'Invalid polar scroll')end else S.scrollx=- (A(Z[1],Z[2],'Invalid scroll')or-S.scrollx)S.scrolly=0 end;if S.scroll==0 and S.scrollx==0 and S.scrolly==0 then ParseError(Z[1],'Scroll cannot be 0')end end elseif Z[1]=='GOGOSTART'then S.gogo=true elseif Z[1]=='GOGOEND'then S.gogo=false elseif Z[1]=='BARLINEOFF'then S.barline=false elseif Z[1]=='BARLINEON'then S.barline=true elseif Z[1]=='BRANCHSTART'then if S.branch.on then S.endbranch()end;S.msbeforebranch=S.ms;S.branch.on=true;y.Metadata.DIVERGENOTES=true;local ab=D(Z[1],Z[2])local bb=B(Z[1],Taiko.Data.Branch.Requirements[string.lower(ab[1])],'Invalid type',ab[1])S.branch.requirements={bb}local cb=2;while true do if not ab[cb]then break end;local db=Taiko.Data.Branch.PathName[cb-1]if db then S.branch.requirements[db]=ab[cb]else break end;cb=cb+1 end elseif Taiko.Data.Branch.PathId[Z[1]]then if S.branch.on then S.ms=S.msbeforebranch;S.currentbranch=Z[1]S.branch.paths[Z[1]]={}S.measurepushto=S.branch.paths[Z[1]]else ParseError(Z[1],'Branch has not started')end elseif Z[1]=='BRANCHEND'then if S.branch.on then S.endbranch()else ParseError(Z[1],'Branch has already ended')end elseif Z[1]=='SECTION'then S.section=true elseif Z[1]=='LYRIC'then table.insert(S.currentmeasure,{'LYRIC',Z[2]})elseif Z[1]=='LEVELHOLD'then elseif Z[1]=='BMSCROLL'then S.disablescroll=true;if not y.Flag.PARSER_FORCE_OLD_BPMCHANGE then S.attachbpmchange=true end;y.Metadata.STOPSONG=true elseif Z[1]=='HBSCROLL'then if not y.Flag.PARSER_FORCE_OLD_BPMCHANGE then S.attachbpmchange=true end;y.Metadata.STOPSONG=true elseif Z[1]=='NMSCROLL'then if not y.Flag.PARSER_FORCE_OLD_BPMCHANGE then S.attachbpmchange=false end;y.Metadata.STOPSONG=false elseif Z[1]=='SENOTECHANGE'then S.senotechange=A(Z[1],Z[2],'Invalid senotechange')elseif Z[1]=='NEXTSONG'then elseif Z[1]=='DIRECTION'then local ab=Z[2]local bb=S.settings.directionweight;local cb=0;local db=0;for i=1,#ab do local hb=string.sub(ab,i,i)if bb[hb]then cb=cb+bb[hb]db=db+1 end end;if db==0 then ParseError(Z[1],'Invalid direction')end;local eb=cb/db;local fb=math.sqrt(S.scrollx^2 +S.scrolly^2)local gb=Q(fb,math.rad(eb))S.scrollx=-gb[1]S.scrolly=-gb[2]elseif Z[1]=='SUDDEN'then local ab=R(Z[2])S.suddenappear=SToMs(A(Z[1],ab[1],'Invalid sudden')or(S.suddenappear and MsToS(S.suddenappear)or 0))S.suddenmove=SToMs(A(Z[1],ab[2],'Invalid sudden')or(S.suddenmove and MsToS(S.suddenmove)or 0))elseif Z[1]=='JPOSSCROLL'then local ab=false;local bb=R(Z[2])local function cb(db,eb,fb,gb)if(v and I(eb))or(gb)then S.jposscroll.lanep=S.jposscroll.lanep or{nil,nil}if I(eb)then local hb,ib=J(eb)hb=A(Z[1],hb,'Invalid jposscroll')ib=A(Z[1],ib,'Invalid jposscroll')S.jposscroll.lanep[db]=(hb/ib)else S.jposscroll.lanep[db]=eb end;if fb then S.jposscroll.lanep[1]=S.jposscroll.lanep[1]* (B(Z[1],fb=='1'and 1 or fb=='0'and-1,'Invalid jposscroll',fb)or 1)end elseif v and eb=='default'then S.jposscroll.p='default'else S.jposscroll.p=S.jposscroll.p or{nil,nil}S.jposscroll.p[db]=A(Z[1],eb,'Invalid jposscroll')if fb then S.jposscroll.p[db]=S.jposscroll.p[db]* (B(Z[1],fb=='1'and 1 or fb=='0'and-1,'Invalid jposscroll',fb)or 1)end end end;if w then if M(bb[2])then local db,eb=O(bb[2])cb(1,db[1],nil,eb[1])cb(2,db[2],nil,eb[2])ab=true elseif P(bb[2])then local db=D(Z[1],bb[2])if#db==3 then local eb=false;if I(db[2])then eb=true;local gb,hb=J(db[2])gb=A(Z[1],gb,'Invalid polar jposscroll')hb=A(Z[1],hb,'Invalid polar jposscroll')db[2]=(gb/hb)else db[2]=A(Z[1],db[2],'Invalid polar jposscroll')end;db[1]=A(Z[1],db[1],'Invalid polar jposscroll')db[3]=A(Z[1],db[3],'Invalid polar jposscroll')local fb=Q(db[1],math.rad(db[3]/db[2]*360))cb(1,fb[1],nil,eb)cb(2,fb[2],nil,eb)ab=true else ParseError(Z[1],'Invalid polar jposscroll')end end else end;if ab==false then cb(1,bb[2],bb[3])end;S.jposscroll.lengthms=SToMs(A(Z[1],bb[1],'Invalid jposscroll')or 0)table.insert(S.currentmeasure,{'JPOSSCROLL',S.jposscroll})S.jposscroll={}elseif v then if Z[1]=='GAMEMODE'then elseif Z[1]=='SPLITLANE'then elseif Z[1]=='MERGELANE'then elseif Z[1]=='BARLINE'then table.insert(S.measurepushto,S.createbarline())elseif Z[1]=='DUMMYSTART'then S.dummy=true elseif Z[1]=='DUMMYEND'then S.dummy=false elseif Z[1]==''then elseif Z[1]==''then elseif Z[1]==''then elseif Z[1]==''then elseif Z[1]==''then elseif Z[1]==''then elseif Z[1]==''then elseif Z[1]==''then elseif Z[1]==''then elseif Z[1]==''then elseif Z[1]==''then elseif Z[1]==''then elseif Z[1]==''then elseif Z[1]==''then elseif Z[1]==''then elseif Z[1]==''then elseif Z[1]==''then elseif Z[1]=='RESETCOMMAND'then end else end;Y=true end end;if(S.songstarted)and Y==false then S.mpm=S.bpm*S.sign/4;S.mspermeasure=60000 *S.sign*4 /S.bpm;if S.barline and S.insertbarline then table.insert(S.measurepushto,S.createbarline())S.insertbarline=false end;for i=1,#W do local Z=string.sub(W,i,i)local ab=tonumber(Z)or Z;if S.settings.noteparse.notes[ab]then local bb=S.createnote(ab)bb.data='note'table.insert(S.currentmeasure,bb)end end;if String.EndsWith(String.TrimRight(W),',')then S.mpm=S.bpm*S.sign/4;S.mspermeasure=60000 *S.sign*4 /S.bpm;if#S.currentmeasure==0 then S.ms=S.ms+S.mspermeasure;S.measuredone=true;S.insertbarline=true elseif#S.currentmeasure==1 and S.currentmeasure[1].data=='event'and S.currentmeasure[1].event=='barline'then y.Data[#y.Data+1]=S.currentmeasure[1]S.ms=S.ms+S.mspermeasure;S.measuredone=true;S.currentmeasure={}S.insertbarline=true else local Z=0;local ab=nil;for i=1,#S.currentmeasure do local fb=S.currentmeasure[i]if fb.data=='note'then ab=ab or fb.mspermeasure;Z=Z+1 end end;ab=ab or S.mspermeasure;local bb=ab/Z;local cb=false;local db=false;local eb=false;for i=1,#S.currentmeasure do local fb=S.currentmeasure[i]if fb[1]=='DELAY'then S.ms=S.ms+fb[2]elseif fb[1]=='JPOSSCROLL'then cb=fb;S.zeroopt=false elseif fb[1]=='BPMCHANGE'then db=fb;S.zeroopt=false elseif fb[1]=='LYRIC'then eb=fb;S.zeroopt=false else if not S.zeroopt or fb.type~=0 then fb.ms=S.ms;fb.appearancems=fb.appearancems and(fb.ms- (fb.appearancems))fb.movems=fb.movems and(fb.ms- (fb.movems))local gb=S.measurepushto[#S.measurepushto]or y.Data[#y.Data]if gb then gb.nextnote=fb end;table.insert(S.measurepushto,fb)if fb.onnotepush then fb.onnotepush()end;bb=fb.mspermeasure/Z end;if cb then fb.jposscroll=cb[2]cb=false end;if db then fb.bpmchange=db[2]db=false end;if eb then table.insert(y.Lyric,{ms=fb.ms-y.Metadata.OFFSET,lengthms=nil,data=eb[2]})eb=false end;if fb.type==0 then S.zeroopt=u end;if fb.type==1 or fb.type==2 then if not S.senotems then if S.senotems==nil then S.senotems=false elseif S.lastsenote then local gb=(fb.ms or S.ms)-S.lastsenote.ms;if gb<200 then S.senotems=gb;if S.lastlastsenote and(S.lastsenote.ms-S.lastlastsenote.ms==S.senotems)then S.lastlastsenote.senote=Taiko.Data.SENotes[S.lastlastsenote.type][2]end end end end;if S.senotems then if fb.ms- (S.lastsenote and S.lastsenote.ms or 0)==S.senotems then S.lastsenote.senote=Taiko.Data.SENotes[S.lastsenote.type][2]elseif S.lastsenote and Taiko.Data.SENotes[S.lastsenote.type]then S.lastsenote.senote=Taiko.Data.SENotes[S.lastsenote.type][1]S.senotems=false end elseif S.lastsenote then S.lastsenote.senote=Taiko.Data.SENotes[S.lastsenote.type][1]end;S.lastlastsenote=S.lastsenote;S.lastsenote=fb elseif fb.type==3 or fb.type==4 or fb.type==7 or fb.type==5 or fb.type==6 then fb.senote=Taiko.Data.SENotes[fb.type][1]S.senotems=false end;if fb.data=='note'then S.ms=S.ms+bb end end end;S.measuredone=true;S.currentmeasure={}S.zeroopt=u;S.insertbarline=true;if cb then S.currentmeasure[#S.currentmeasure+1]=cb end;if db then S.currentmeasure[#S.currentmeasure+1]=db end;if eb then S.currentmeasure[#S.currentmeasure+1]=eb end end else S.measuredone=false end end end end;local V=nil;for W,X in pairs(x)do if#X.Lyric~=0 then V=X.Lyric;break end end;if V then for W,X in pairs(x)do if#X.Lyric==0 then X.Lyric=V end end end;print('Parsing Took: '..SToMs(os.clock()-t)..'ms')return x end;function Taiko.ParseTJAFile(s)local t=io.open(s,'r')if t then local u=t:read('*all')t:close()local v;local w,x=pcall(function()v=Taiko.ParseTJA(u)end)if w then else return nil,x end;local y=string.find(string.reverse(s),'[/\\]')for z,A in pairs(v)do A.Metadata.SONG=(y and string.sub(s,1,#s+1 -y)or'')..A.Metadata.WAVE end;return v else return nil,'Unable to open file'end end;function Taiko.SerializeTJA(s)local t={OFFSET=0.001,MOVIEOFFSET=0.001,SONGVOL=100,SEVOL=100}local u={'// Automatically Serialized by Taiko.SerializeTJA\n\n'}local v=nil;local w={mspermeasure=true,startnote=true,endnote=true,nextnote=true,lengthms=true,onnotepush=true,data=true,line=true,type=true,ms=true,scrolly=true}local function x(D)local E=false;for F,G in pairs(D)do if(not w[F])and(not v or not D[F]==v[F])then if E==false then u[#u+1]='\n'E=true end;local H=true;if F=='bpm'then u[#u+1]='#BPMCHANGE 'u[#u+1]=tostring(G)elseif F=='scrollx'then u[#u+1]='#SCROLL 'u[#u+1]=tostring(-G)if D.scrolly~=0 then u[#u+1]='+'u[#u+1]=tostring(-D.scrolly)u[#u+1]='i'end elseif F=='gogo'then if G then u[#u+1]='#GOGOSTART'else u[#u+1]='#GOGOEND'end elseif F=='senote'then H=false elseif F=='delay'then if G==0 then H=false else u[#u+1]='#DELAY 'u[#u+1]=tostring(MsToS(D.delay- (v and v.delay or 0)))end elseif F=='radius'then u[#u+1]='#RADIUS 'u[#u+1]=tostring(G)else print('Invalid attribute, '..F)H=false end;if H then u[#u+1]='\n'end end end;u[#u+1]=tostring(D.type)v=D end;local y=1;local function z(D,E)if D<E then return z(E,D)end;if math.abs(E)<y then return D else return z(E,D-math.floor(D/E)*E)end end;local function A(D)return math.floor(D+0.5)end;local function B(D)local E,F=D,1;while true do if not string.find(tostring(E),'%.')then break end;E=E*10;F=F*10 end;return E..'/'..F end;local function C(D)local E=D[1].ms;for i=2,#D do E=z(E,D[i].ms)end;return E end;for D,E in pairs(s)do v=nil;local F=E.Data;for J,K in pairs(E.Metadata)do if(type(K)=='string'or type(K)=='number')and J~='SONG'then u[#u+1]=tostring(J)u[#u+1]=':'if J=='COURSE'then u[#u+1]=tostring(Taiko.Data.CourseName[K])elseif t[J]then u[#u+1]=tostring(K*t[J])else u[#u+1]=tostring(K)end;u[#u+1]='\n'end end;u[#u+1]='\n'u[#u+1]='#START\n'local G={}local H=nil;local I=nil;for i=1,#F do local J=F[i]local K=F[i+1]H=H or J.ms;if(J.data=='note')then G[#G+1]=J end;if(K and(K.data=='event'and K.event=='barline'))or(i==#F)then local L=J.ms-H;local M=L/#G;local N=nil;if#G>=2 then N=C(G)else N=J.mspermeasure end;local O=nil;if K then O=K.ms-H else O=N+L end;local P=60000 /J.bpm;local Q=(O/P)/4;local R=tostring(Q)if R~=I then u[#u+1]='#MEASURE '..B(Q)..'\n'I=R end;if#G==0 then u[#u+1]=',\n'elseif#G==1 then x(J)u[#u+1]=',\n'else for i=1,#G do local S=G[i]x(S)if i~=#G then u[#u+1]=string.rep('0',(G[i+1].ms-G[i].ms)/N-1)end end;u[#u+1]=string.rep('0',(O+H-G[#G].ms)/N-1)u[#u+1]=',\n'end;G={}H=nil end end;u[#u+1]='#END\n'return table.concat(u)end;return table.concat(u)end;function Taiko.Score(s,t,u,v,w)if v==0 then u=0 else u=u+1 end;local x=s.Metadata;return Taiko.Data.ScoreMode.Note[x.SCOREMODE](t,u,x.SCOREINIT,x.SCOREDIFF,v,w),u end;function Taiko.Analyze(s)local t='M'local u={[1]=2,[2]=2,[3]=3,[4]=3}local v={notes={n=0,validn=0},measures=0,lengthms=0,drumrollms=0,drumrollbigms=0,balloonms=0,balloonhit=0,specialms=0,specialhit=0,maxcombo=0,maxscore=0}local w=nil;Taiko.ForAll(s.Data,function(x,y,z)if x.data=='note'then v.notes.n=v.notes.n+1;v.notes[x.type]=v.notes[x.type]and v.notes[x.type]+1 or 1;if u[x.type]then v.maxscore,v.maxcombo=Taiko.Score(s,v.maxscore,v.maxcombo,u[x.type],x.gogo)end;local A=x.endnote;if A then local B=A.ms-x.ms;if x.type==5 then v.drumrollms=v.drumrollms+B elseif x.type==6 then v.drumrollbigms=v.drumrollbigms+B elseif x.type==7 then v.balloonms=v.balloonms+B;v.balloonhit=v.balloonhit+x.requiredhits elseif x.type==9 then v.specialms=v.specialms+B;v.specialhit=v.specialhit+x.requiredhits else end end;w=x elseif x.data=='event'and x.event=='barline'then v.measures=v.measures+1 else end end,t)v.lengthms=w.ms-s.Metadata.OFFSET;v.notes.validn=v.maxcombo;return v end;function Taiko.GetDifficulty(s,t)local u=Taiko.Data.CourseId[string.lower(t)]or t;for w,x in pairs(s)do if x.Metadata.COURSE==u then return x end end;Error('No difficulty found, '..t)return nil end;function Taiko.ForAll(s,t,u)local v=1;for i=1,#s do local w=s[i]if w.branch then if u then local x=w.branch.paths[u]for i2=1,#x do t(x[i2],i2,v)v=v+1 end;v=v-1 else local x=-1;for y,z in pairs(w.branch.paths)do local A=v;for i2=1,#z do t(z[i2],i2,A)A=A+1 end;x=(x<A)and A or x end;v=x end else t(w,i,v)end;v=v+1 end;return s end;function Taiko.GetAllNotes(s)local u={}for w,x in pairs(s)do if x.branch then for y,z in pairs(x.branch.paths)do for i=1,#z do table.insert(u,z[i])end end else table.insert(u,x)end end;return u end;function Taiko.ConnectNotes(s)local t=nil;for i=#s,1,-1 do local u=s[i]u.nextnote=t;t=u end;return s end;function Taiko.ExtractBranch(s,t)return s.branch.paths[t]end;function Taiko.ConnectAll(s)local t=nil;for i=#s,1,-1 do local u=s[i]if u.branch then for w,x in pairs(u.branch.paths)do local y=Taiko.ConnectNotes(x)y[#y].nextnote=t end else u.nextnote=t end;t=u end end;function Taiko.CalculateSpeed(s,t)local u=(t*s.scrollx*s.bpm/7500)local v=(t*s.scrolly*s.bpm/7500)return{u,v}end;function Taiko.CalculateSpeedInterval(s,t)local u=960;local v=(s.bpm/240000 *s.scrollx*u*t)local w=(s.bpm/240000 *s.scrolly*u*t)return{v,w}end;function Taiko.RenderScale(s)local u={}local v={}local w={}for i=1,#s.Data do local A=s.Data[i]if A.data=='note'then local B=math.floor(A.ms)if math.floor(B)-B==0 then table.insert(u,{B,A.type})table.insert(v,B)else table.insert(w,i)end end end;function gcd2(A,B)if B==0 then return A else return gcd2(B,A%B)end end;function gcdn(A)local B=A[1]for i=2,#A do B=gcd2(B,A[i])end;return B end;local x=gcdn(v)for i=1,#w do local A=u[w[i]]A[1]=math.floor(A[1]/x)*x end;local y=''local z=0;for i=1,#u do u[i][1]=u[i][1]/x;y=y..string.rep(' ',u[i][1]-z)..u[i][2]z=u[i][1]end;return y end;function Taiko.Game()local s=nil;local t='config.tpd'local u;local v=0;local w=138;local x;local function y()rl.CloseWindow()rl.CloseAudioDevice()end;local function z(qc,rc)local sc=10;if rc<sc then rc=sc end;local tc=rc/sc;local uc=rl.MeasureTextEx(rl.GetFontDefault(),qc,rc,tc)return math.floor(uc.x),math.floor(uc.y)end;local A={[rl.KEY_Y]=true,[rl.KEY_N]=false}local B=50;local function C(qc)local rc,sc=z(qc,B)local tc=nil;while not rl.WindowShouldClose()do rl.BeginDrawing()rl.ClearBackground(rl.RAYWHITE)rl.DrawText(qc,u.ScreenWidth/2 -rc/2,u.ScreenHeight/2 -sc/2,B,rl.BLACK)rl.EndDrawing()for uc,vc in pairs(A)do if rl.IsKeyPressed(uc)then tc=vc;break end end;if tc~=nil then break end end;return tc end;local D=true;local function E(qc)if D then return C(qc..'\nPress y to confirm\nPress n to reject')else return true end end;local function F(qc)local rc,sc=z(qc,B)local tc={}qc=qc..'\n'local uc=qc;while not rl.WindowShouldClose()do rl.BeginDrawing()rl.ClearBackground(rl.RAYWHITE)rl.DrawText(uc,u.ScreenWidth/2 -rc/2,u.ScreenHeight/2 -sc/2,B,rl.BLACK)rl.EndDrawing()while true do local vc=rl.GetCharPressed()if vc==0 then break else tc[#tc+1]=vc;uc=qc..l(tc)end end;if rl.IsKeyPressed(rl.KEY_BACKSPACE)then tc[#tc]=nil;uc=qc..l(tc)end;if rl.IsKeyPressed(rl.KEY_ENTER)then break end end;tc=l(tc)return tc~=''and tc or nil end;local function G(qc)local rc,sc=z(qc,B)local tc=nil;while not rl.WindowShouldClose()do rl.BeginDrawing()rl.ClearBackground(rl.RAYWHITE)rl.DrawText(qc,u.ScreenWidth/2 -rc/2,u.ScreenHeight/2 -sc/2,B,rl.BLACK)rl.EndDrawing()while true do local uc=rl.GetCharPressed()if uc==0 then break else tc=true;break end end;if tc then break end end;return tc end;local function H(qc)return string.reverse(string.match(string.reverse(qc),'(.-%.)'))end;local function I(qc)local rc=string.sub(qc,-1,-1)if rc=='/'or rc=='\\'then return string.sub(qc,1,-2)else return qc end end;local function J(qc)return string.reverse(string.match(string.reverse(qc),'(.-)/'))end;local function K(qc)local rc=J(qc)local sc=string.find(rc,'%.')if sc then return string.sub(rc,1,sc-1)else return rc end end;local function L(qc)local rc=J(qc)if string.find(rc,'%.')then return true else return false end end;local function M(qc)local rc=require('ffi')local sc=rl.LoadDirectoryFiles(I(qc))local tc={}for i=0,sc.count-1 do tc[#tc+1]=rc.string(sc.paths[i])if rl.IsPathFile(tc[#tc])==false then local uc=M(tc[#tc])tc[#tc]=nil;for i2=1,#uc do tc[#tc+1]=uc[i2]end end end;return tc end;local function N(qc)local rc=require('ffi')qc=qc or u.Paths.Songs;local sc={}local tc=rl.LoadDirectoryFiles(I(qc))local uc={}for i=0,tc.count-1 do if rl.IsPathFile(uc[#uc])==false then local vc=uc[#uc]local wc=rc.string(rl.GetFileNameWithoutExt(uc[#uc]))local xc,yc=ScanSongs(uc[#uc])sc[wc]=yc;uc[#uc]=nil;local zc=true;for i2=1,#xc do if zc then local Ac=rl.GetFileNameWithoutExt(xc[i2])if rc.string(Ac)==wc then else zc=false end end;uc[#uc+1]=xc[i2]end;if zc then for i2=1,#sc[wc]do sc[#sc+1]=sc[wc][i2]end;sc[wc]=nil else end else sc[#sc+1]=uc[#uc]end end;return uc,sc end;local function O(qc)local rc=require('lfs.lfs_ffi')qc=qc or u.Paths.Songs;local sc={}local tc=I(qc)local uc,vc=rc.dir(tc)tc=tc..'/'local wc={}while true do local xc=uc(vc)if not xc then break end;if xc~='.'and xc~='..'then wc[#wc+1]=tc..xc;if L(wc[#wc])==false then local yc=wc[#wc]local zc=K(wc[#wc])local Ac,Bc=O(wc[#wc])sc[zc]=Bc;wc[#wc]=nil;local Cc=true;for i2=1,#Ac do if Cc then local Dc=K(Ac[i2])if Dc==zc then else Cc=false end end;wc[#wc+1]=Ac[i2]end;if Cc then for i2=1,#sc[zc]do sc[#sc+1]=sc[zc][i2]end;sc[zc]=nil else end else sc[#sc+1]=wc[#wc]end end end;return wc,sc end;local function P(qc)local rc={}for sc,tc in pairs(qc)do if type(tc)=='table'then rc[sc]=P(tc)else if H(tc)=='.tja'then rc[K(tc)]=tc end end end;return rc end;local function Q(qc)local rc=io.open(qc,'rb')if rc then rc:close()return true else return false end end;local function R(qc)local rc=io.open(qc,'rb')if rc then local sc=rc:read('*all')rc:close()return sc else print('Unable to find file: '..qc)end end;local function S(qc)x(qc)return R(s..qc)end;local function T(qc)local rc,sc=io.open(qc,'rb')if rc then local tc=rc:read('*all')rc:close()local uc=require('ffi')return rl.LoadMusicStreamFromMemory(uc.new('const char *',H(qc)),uc.new("const unsigned char *",tc),uc.new('int',#tc+1))else return nil end end;local function U(qc)return rl.LoadMusicStream(qc)end;local function V(qc)local rc=S(qc)if not rc then return rl.new('Image')end;return rl.LoadImageFromMemory(H(qc),rc,#rc)end;local function W(qc)local rc=S(qc)if not rc then return rl.new('Wave')end;return rl.LoadWaveFromMemory(H(qc),rc,#rc)end;local function X(qc)local rc=W(qc)local sc=rl.LoadSoundFromWave(rc)rl.UnloadWave(rc)return sc end;local function Y(qc,rc,sc)local tc={}local uc=sc;while true do local vc=qc..tostring(uc)..rc;if Q(s..vc)then tc[uc]=V(vc)uc=uc+1 else if uc==0 then tc[0]=rl.new('Image')end;break end end;return tc end;local function Z(qc,rc)local sc={qc,rc}return sc end;local function ab(qc)local rc=0;for sc,tc in pairs(qc)do rc=rc+1 end;return rc end;local function bb(qc,rc,sc,tc)rc=rc or 32;if not sc then sc={}for i=1,tc do sc[#sc+1]=i end end;sc=sc and rl.new('int[?]',#sc,sc)tc=tc or 0;local uc=S(qc)if not uc then return rl.new('Font')end;return rl.LoadFontFromMemory(H(qc),uc,#uc,rc,sc,tc)end;local cb={}local function db(qc,rc,sc,tc)return function(uc,vc)if not vc then vc={}for i=1,#uc do vc[uc[i]]=true end end;for wc,xc in pairs(cb)do if#wc==#uc then local yc=true;for i=1,#wc do if not vc[wc[i]]then yc=false;break end end;if yc then return xc end end end;cb[uc]=bb(qc,rc,uc,#uc)return cb[uc]end end;local eb=-4;local function fb(qc,rc,sc,tc,uc,vc)local wc=eb*vc[1]local xc,yc=0,0;local zc=0;for i=1,#qc do local Ac=string.sub(qc,i,i)if Ac=='\n'then zc=zc- (tc+wc)xc=zc>xc and zc or xc;yc=yc+ (uc+wc)else zc=zc+ (tc+wc)end end;zc=zc- (tc+wc)xc=zc>xc and zc or xc;return xc,yc end;local function gb(qc,rc,sc,tc,uc,vc,wc,xc,yc,zc)zc=zc or{['0']={0,0},['1']={1,0},['2']={2,0},['3']={3,0},['4']={4,0},['5']={5,0},['6']={6,0},['7']={7,0},['8']={8,0},['9']={9,0}}local Ac=0;local Bc=0;local Cc=rl.new('Rectangle',0,0,uc-1,vc-1)local Dc=rl.new('Rectangle',0,0,wc-1,xc-1)local Ec=rl.new('Vector2',0,0)local Fc=eb*yc[1]for i=1,#rc do local Gc=string.sub(rc,i,i)if Gc=='\n'then Ac=Ac+1;Bc=0 else local Hc=zc[Gc]Cc.x=Hc[1]*uc;Cc.y=Hc[2]*vc;Dc.x=sc+ (wc+Fc)*Bc;Dc.y=tc+ (xc+Fc)*Ac;rl.DrawTexturePro(qc,Cc,Dc,Ec,0,rl.WHITE)Bc=Bc+1 end end end;local function hb(qc,rc)local sc=os.date('%Y-%m-%d-%Hh%Mm%Ss000',os.time())local tc=qc..sc..rc;return tc end;local function ib(qc,rc,sc)local tc=hb(qc,rc)local uc=io.open(tc,'wb+')if uc then uc:write(sc)uc:close()else print('Unable to find file: '..tc)end end;local jb=false;if Q(t)then u=Persistent.Load(Persistent.Read(t))else u={}jb=true end;u.ScreenWidth=u and u.ScreenWidth or 1600;u.ScreenHeight=u and u.ScreenHeight or u.ScreenWidth/16 *9;rl.SetTargetFPS(60)rl.SetConfigFlags(rl.FLAG_WINDOW_RESIZABLE)rl.SetTraceLogLevel(rl.LOG_NONE)rl.InitWindow(u.ScreenWidth,u.ScreenHeight,'Taiko')rl.SetExitKey(rl.KEY_NULL)if jb then local qc=nil;while true do local rc=C('Config file not found\nPress y to generate new config\nPress n to use a different config')if rc==true then local sc=E('Are you sure you want to overwrite '..t..'?')if sc then qc=Persistent.Read('defaultconfig.tpd')else end elseif rc==false then while true do local sc=F('What is the file path?\n(Relative or Absolute)')if sc then if Q(sc)then local tc=E('Are you sure you want to use '..sc..'?')if tc then qc=Persistent.Read(sc)break else end else G('Invalid file')end else break end end else local sc=E('Are you sure you want to continue without config?')if sc then break else end end;if qc then break end end;if qc then u=Persistent.Load(qc)end end;local kb=Table.Clone(u)local function lb(qc)for rc,sc in pairs(qc)do if rl.IsKeyPressed(rc)then return true end end;return false end;local function mb(qc)for rc,sc in pairs(qc)do if rl.IsKeyDown(rc)then return true end end;return false end;local function nb()local qc,rc=u.ScreenWidth,u.ScreenHeight;if u.Fullscreen then rl.ToggleFullscreen()u.ScreenWidth,u.ScreenHeight=kb.ScreenWidth,kb.ScreenHeight;rl.RestoreWindow()rl.SetWindowSize(u.ScreenWidth,u.ScreenHeight)else local sc=rl.GetCurrentMonitor()u.ScreenWidth,u.ScreenHeight=rl.GetMonitorWidth(sc),rl.GetMonitorHeight(sc)rl.SetWindowSize(u.ScreenWidth,u.ScreenHeight)rl.ToggleFullscreen()end;u.Fullscreen=not u.Fullscreen;return u.ScreenWidth/qc,u.ScreenHeight/rc end;if u.Fullscreen then u.Fullscreen=false;nb()end;u.Offsets.Music=MsToS(u.Offsets.Music)s=u.Paths.Assets;t=u.Paths.Config;u.Controls.SongSelect.FastScrollTime=MsToS(u.Controls.SongSelect.FastScrollTime)u.Controls.SongSelect.FastScrollInterval=MsToS(u.Controls.SongSelect.FastScrollInterval)x=function()end;rl.BeginDrawing()rl.ClearBackground(rl.RAYWHITE)rl.DrawText([[
Taiko v33
Loading assets and config...]],0,u.ScreenHeight/2,B,rl.BLACK)rl.EndDrawing()local ob={414 /1280 *kb.ScreenWidth,- (257 /720 -1 /2)*kb.ScreenHeight}local pb=333 /1280 *kb.ScreenWidth;local qb=ob[2]local rb,sb=0,kb.ScreenHeight/2;local tb=Taiko.Data.BigNoteMul;local ub=54;local vb={ob[1],ob[2]}local wb={}local xb=kb.ScreenHeight/45;local yb=0.1;local zb={1280,720}local Ab=60;local Bb=1000 /Ab;local Cb={PlaySong={Notes=V('Graphics/5_Game/Notes.png'),SENotes=V('Graphics/5_Game/SENotes.png'),Barlines={bar=V('Graphics/5_Game/Bar.png'),bar_branch=V('Graphics/5_Game/Bar_Branch.png')},Judges=V('Graphics/5_Game/Judge.png'),Balloons={Anim=Y('Graphics/5_Game/11_Balloon/Breaking_','.png',0,5)},Effects={Note={Hit={[1]={Anim=Y('Graphics/5_Game/10_Effects/Hit/Good/','.png',0,14)},[2]={Anim=Y('Graphics/5_Game/10_Effects/Hit/Great/','.png',0,14)},[3]={Anim=Y('Graphics/5_Game/10_Effects/Hit/Good_Big/','.png',0,14)},[4]={Anim=Y('Graphics/5_Game/10_Effects/Hit/Great_Big/','.png',0,14)}},Explosion=V('Graphics/5_Game/10_Effects/Hit/Explosion.png'),ExplosionBig=V('Graphics/5_Game/10_Effects/Hit/Explosion_Big.png')}},Lanes={Lane={default=V('Graphics/5_Game/12_Lane/Background_Main.png'),gogo=V('Graphics/5_Game/12_Lane/Background_GoGo.png'),[1]=V('Graphics/5_Game/12_Lane/Red.png'),[2]=V('Graphics/5_Game/12_Lane/Blue.png'),sub=V('Graphics/5_Game/12_Lane/Background_Sub.png'),N=V('Graphics/5_Game/12_Lane/Base_Normal.png'),E=V('Graphics/5_Game/12_Lane/Base_Expert.png'),M=V('Graphics/5_Game/12_Lane/Base_Master.png')},Text={N=V('Graphics/5_Game/12_Lane/Text_Normal.png'),E=V('Graphics/5_Game/12_Lane/Text_Expert.png'),M=V('Graphics/5_Game/12_Lane/Text_Master.png')}},Backgrounds={Background={Bottom={},InfoBar={[0]=V('Graphics/5_Game/6_Taiko/1P_Background.png')},CourseSymbol={[0]=V('Graphics/5_Game/4_CourseSymbol/Easy.png'),[1]=V('Graphics/5_Game/4_CourseSymbol/Normal.png'),[2]=V('Graphics/5_Game/4_CourseSymbol/Hard.png'),[3]=V('Graphics/5_Game/4_CourseSymbol/Oni.png'),[4]=V('Graphics/5_Game/4_CourseSymbol/Edit.png'),[5]=V('Graphics/5_Game/4_CourseSymbol/Tower.png'),[6]=V('Graphics/5_Game/4_CourseSymbol/Dan.png')}},Frame={[1]=V('Graphics/5_Game/6_Taiko/1P_Frame.png')},Taiko={base=V('Graphics/5_Game/6_Taiko/Base.png'),[1]=V('Graphics/5_Game/6_Taiko/Don.png'),[2]=V('Graphics/5_Game/6_Taiko/Ka.png'),combo=V('Graphics/5_Game/6_Taiko/Combo_Text.png')},ComboText={[0]=V('Graphics/5_Game/6_Taiko/Combo_Text.png')}},Gauges={Meter={base=V('Graphics/5_Game/7_Gauge/1P_Base.png'),full=V('Graphics/5_Game/7_Gauge/1P.png'),rainbow={Anim=Y('Graphics/5_Game/7_Gauge/rainbow/','.png',0,11)}},Clear={}},Fonts={Combo={[0]=V('Graphics/5_Game/6_Taiko/Combo.png'),[1]=V('Graphics/5_Game/6_Taiko/Combo_Midium.png'),[2]=V('Graphics/5_Game/6_Taiko/Combo_Big.png')},Score={[0]=V('Graphics/5_Game/6_Taiko/Score.png'),[1]=V('Graphics/5_Game/6_Taiko/Score_1P.png')}},Nameplates=V('Graphics/NamePlate.png')},SongSelect={GenreBar=Y('Graphics/3_SongSelect/Bar_Genre/Bar_Genre_','.png',0,9),BoxCharacter=Y('Graphics/3_SongSelect/Box_Chara/Box_Chara_','.png',0,12),Difficulty={Bar=V('Graphics/3_SongSelect/Difficulty_Select/Difficulty_Bar.png')},GenreBackground=Y('Graphics/3_SongSelect/Genre_Background/GenreBackground_','.png',0,12)}}local Db={PlaySong={Notes={target={0,0},[1]={1,0},[2]={2,0},[3]={3,0},[4]={4,0},drumrollnote={5,0},drumrollrect={6,0},drumrollend={7,0},DRUMROLLnote={8,0},DRUMROLLrect={9,0},DRUMROLLend={10,0},balloon={11,0},balloonend={12,0}},SENotes={[1]={0,0},[2]={0,1},[3]={0,2},[4]={0,3},[5]={0,4},[6]={0,5},[7]={0,6},[8]={0,7},[9]={0,8},[10]={0,9},[11]={0,10},[12]={0,11}},Judges={[2]={0,0},[1]={0,1},[0]={0,2},adlib={0,3}},Effects={Note={Explosion={[1]={Anim={[0]={0,1},[1]={1,1},[2]={2,1},[3]={3,1},[4]={4,1},[5]={5,1},[6]={6,1}}},[2]={Anim={[0]={0,0},[1]={1,0},[2]={2,0},[3]={3,0},[4]={4,0},[5]={5,0},[6]={6,0}}},[3]={Anim={[0]={0,3},[1]={1,3},[2]={2,3},[3]={3,3},[4]={4,3},[5]={5,3},[6]={6,3}}},[4]={Anim={[0]={0,2},[1]={1,2},[2]={2,2},[3]={3,2},[4]={4,2},[5]={5,2},[6]={6,2}}}}}},Nameplates={[1]={0,0},[3]={0,1},[2]={0,2},base={0,3},edge={0,4},top={0,5},rankbase={0,7},rank={[1]={0,8},[2]={0,9},[3]={0,10}}}}}x('Splitting into textures')local Eb={130,130}local Fb={130,130}Cb.PlaySong.Notes=TextureMap.SplitUsingMap(Cb.PlaySong.Notes,Db.PlaySong.Notes,Eb,Fb)Cb.PlaySong.Notes.drumrollstart=rl.ImageCopy(Cb.PlaySong.Notes.drumrollend)rl.ImageFlipHorizontal(Cb.PlaySong.Notes.drumrollstart)Cb.PlaySong.Notes.DRUMROLLstart=rl.ImageCopy(Cb.PlaySong.Notes.DRUMROLLend)rl.ImageFlipHorizontal(Cb.PlaySong.Notes.DRUMROLLstart)local function Gb(qc,rc,sc)rc=rc or 1;sc=sc or 1;if type(qc)=='table'then for tc,uc in pairs(qc)do Gb(uc,rc,sc)end else rl.ImageResize(qc,(kb.ScreenWidth/1280)*qc.width*rc,(kb.ScreenHeight/720)*qc.height*sc)end;return qc end;Cb.PlaySong.Notes=Gb(Cb.PlaySong.Notes)Cb.PlaySong.Notes=TextureMap.ReplaceWithTexture(Cb.PlaySong.Notes)local Hb,Ib=Cb.PlaySong.Notes.target.width,Cb.PlaySong.Notes.target.height;local Jb=rl.new('Rectangle',0,0,Hb,Ib)local Kb=rl.new('Vector2',Hb/2,Ib/2)local Lb,Mb=rb- (Hb/2),sb- (Ib/2)local Nb,Ob=1,-1;local Pb=rl.new('Rectangle',0,0,0,0)Cb.PlaySong.Notes.drumrollpr=rl.new('Rectangle',0,0,Hb,Ib)Cb.PlaySong.Notes.drumrollpr2=rl.new('Rectangle',0,0,Hb,Ib)local Qb={1,1}local function Rb(qc,rc,sc,tc)if not tc then Qb[1]=Qb[1]*rc;Qb[2]=Qb[2]*sc;Kb.x=Kb.x*rc;Kb.y=Kb.y*sc;xb=xb*sc end;for uc,vc in pairs(qc)do if type(vc)=='table'then Rb(vc,rc,sc,true)elseif type(vc)=='number'then if string.find(uc,'sizex')then qc[uc]=vc*rc elseif string.find(uc,'sizey')then qc[uc]=vc*sc end elseif type(vc)=='cdata'then local wc=tostring(vc)if string.find(wc,'Image')then elseif string.find(wc,'Texture')then elseif string.find(wc,'Vector2')then vc.x=vc.x*rc;vc.y=vc.y*sc elseif string.find(wc,'Rectangle')then if string.find(uc,'sourcerect')then else vc.x=vc.x*rc;vc.y=vc.y*sc;vc.width=vc.width*rc;vc.height=vc.height*sc end end end end;return qc end;local function Sb()end;local function Tb()end;local Ub={136,30}local Vb={136,30}Cb.PlaySong.SENotes=TextureMap.SplitUsingMap(Cb.PlaySong.SENotes,Db.PlaySong.SENotes,Ub,Vb)Cb.PlaySong.SENotes=Gb(Cb.PlaySong.SENotes)Cb.PlaySong.SENotes=TextureMap.ReplaceWithTexture(Cb.PlaySong.SENotes)Cb.PlaySong.SENotes.sizex=Cb.PlaySong.SENotes[1].width;Cb.PlaySong.SENotes.sizey=Cb.PlaySong.SENotes[1].height;Cb.PlaySong.SENotes.sourcerect=rl.new('Rectangle',0,0,Cb.PlaySong.SENotes.sizex,Cb.PlaySong.SENotes.sizey)Cb.PlaySong.SENotes.center=rl.new('Vector2',Cb.PlaySong.SENotes.sizex/2,Cb.PlaySong.SENotes.sizey/2)Cb.PlaySong.SENotes.offsety=80 /720 *kb.ScreenHeight;Cb.PlaySong.Barlines=Gb(Cb.PlaySong.Barlines)Cb.PlaySong.Barlines=TextureMap.ReplaceWithTexture(Cb.PlaySong.Barlines)local Wb,Xb=Cb.PlaySong.Barlines.bar.width,Cb.PlaySong.Barlines.bar.height;local Yb=rl.new('Rectangle',0,0,Wb,Xb)local Zb=rl.new('Vector2',Wb/2,Xb/2)Cb.PlaySong.Balloons=Gb(Cb.PlaySong.Balloons)Cb.PlaySong.Balloons=TextureMap.ReplaceWithTexture(Cb.PlaySong.Balloons)Cb.PlaySong.Balloons.sizex=Cb.PlaySong.Balloons.Anim[0].width;Cb.PlaySong.Balloons.sizey=Cb.PlaySong.Balloons.Anim[0].height;Cb.PlaySong.Balloons.sourcerect=rl.new('Rectangle',0,0,Cb.PlaySong.Balloons.sizex,Cb.PlaySong.Balloons.sizey)Cb.PlaySong.Balloons.center=rl.new('Vector2',Cb.PlaySong.Balloons.sizex/2,Cb.PlaySong.Balloons.sizey/2)Cb.PlaySong.Balloons.pr=rl.new('Rectangle',0,0,Cb.PlaySong.Balloons.sizex,Cb.PlaySong.Balloons.sizey)Cb.PlaySong.Balloons.pr2=rl.new('Rectangle',0,0,Hb,Ib)local ac={90,60}local bc={90,60}Cb.PlaySong.Judges=TextureMap.SplitUsingMap(Cb.PlaySong.Judges,Db.PlaySong.Judges,ac,bc)Cb.PlaySong.Judges=Gb(Cb.PlaySong.Judges)Cb.PlaySong.Judges=TextureMap.ReplaceWithTexture(Cb.PlaySong.Judges)Cb.PlaySong.Judges.sizex=Cb.PlaySong.Judges[0].width;Cb.PlaySong.Judges.sizey=Cb.PlaySong.Judges[0].height;Cb.PlaySong.Judges.sourcerect=rl.new('Rectangle',0,0,Cb.PlaySong.Judges.sizex,Cb.PlaySong.Judges.sizey)Cb.PlaySong.Judges.center=rl.new('Vector2',Cb.PlaySong.Judges.sizex/2,Cb.PlaySong.Judges.sizey/2)Cb.PlaySong.Judges.pr=rl.new('Rectangle',0,0,Cb.PlaySong.Judges.sizex,Cb.PlaySong.Judges.sizey)local cc=rl.new('Color',255,255,255,255 /2)Cb.PlaySong.Effects.Note.Hit=Gb(Cb.PlaySong.Effects.Note.Hit)Cb.PlaySong.Effects.Note.Hit=TextureMap.ReplaceWithTexture(Cb.PlaySong.Effects.Note.Hit)Cb.PlaySong.Effects.Note.sizex=Cb.PlaySong.Effects.Note.Hit[1].Anim[0].width;Cb.PlaySong.Effects.Note.sizey=Cb.PlaySong.Effects.Note.Hit[1].Anim[0].height;Cb.PlaySong.Effects.Note.sizex=Cb.PlaySong.Effects.Note.sizex==0 and 260 /1280 *kb.ScreenWidth or Cb.PlaySong.Effects.Note.sizex;Cb.PlaySong.Effects.Note.sizey=Cb.PlaySong.Effects.sizey==0 and 260 /720 *kb.ScreenHeight or Cb.PlaySong.Effects.Note.sizey;Cb.PlaySong.Effects.Note.sourcerect=rl.new('Rectangle',0,0,Cb.PlaySong.Effects.Note.sizex,Cb.PlaySong.Effects.Note.sizey)Cb.PlaySong.Effects.Note.center=rl.new('Vector2',Cb.PlaySong.Effects.Note.sizex/2,Cb.PlaySong.Effects.Note.sizey/2)local dc={260,260}local ec={260,260}Cb.PlaySong.Effects.Note.Explosion=TextureMap.SplitUsingMap(Cb.PlaySong.Effects.Note.Explosion,Db.PlaySong.Effects.Note.Explosion,dc,ec)Cb.PlaySong.Effects.Note.Explosion=Gb(Cb.PlaySong.Effects.Note.Explosion)Cb.PlaySong.Effects.Note.Explosion=TextureMap.ReplaceWithTexture(Cb.PlaySong.Effects.Note.Explosion)local fc={Cb.PlaySong.Effects.Note.ExplosionBig}Cb.PlaySong.Effects.Note.ExplosionBig=Gb(fc)Cb.PlaySong.Effects.Note.ExplosionBig={Anim={[0]=TextureMap.ReplaceWithTexture(fc)[1]}}Cb.PlaySong.Lanes=Gb(Cb.PlaySong.Lanes)Cb.PlaySong.Lanes=TextureMap.ReplaceWithTexture(Cb.PlaySong.Lanes)Cb.PlaySong.Lanes.sizex=Cb.PlaySong.Lanes.Lane.default.width;Cb.PlaySong.Lanes.sizey=Cb.PlaySong.Lanes.Lane.default.height;Cb.PlaySong.Lanes.sourcerect=rl.new('Rectangle',0,0,Cb.PlaySong.Lanes.sizex,Cb.PlaySong.Lanes.sizey)Cb.PlaySong.Lanes.center=rl.new('Vector2',0,Cb.PlaySong.Lanes.sizey/2)Cb.PlaySong.Lanes.pr=rl.new('Rectangle',pb*Nb+rb,qb*Ob+sb,Cb.PlaySong.Lanes.sizex,Cb.PlaySong.Lanes.sizey)Cb.PlaySong.Lanes.ssizex=Cb.PlaySong.Lanes.Lane.sub.width;Cb.PlaySong.Lanes.ssizey=Cb.PlaySong.Lanes.Lane.sub.height;Cb.PlaySong.Lanes.ssourcerect=rl.new('Rectangle',0,0,Cb.PlaySong.Lanes.ssizex,Cb.PlaySong.Lanes.ssizey)Cb.PlaySong.Lanes.scenter=rl.new('Vector2',0,0)Cb.PlaySong.Lanes.spr=rl.new('Rectangle',pb*Nb+rb,325 /720 *kb.ScreenHeight,Cb.PlaySong.Lanes.ssizex,Cb.PlaySong.Lanes.ssizey)Cb.PlaySong.Backgrounds=Gb(Cb.PlaySong.Backgrounds)Cb.PlaySong.Backgrounds=TextureMap.ReplaceWithTexture(Cb.PlaySong.Backgrounds)Cb.PlaySong.Backgrounds.Frame.sizex=Cb.PlaySong.Backgrounds.Frame[1].width;Cb.PlaySong.Backgrounds.Frame.sizey=Cb.PlaySong.Backgrounds.Frame[1].height;Cb.PlaySong.Backgrounds.Frame.sourcerect=rl.new('Rectangle',0,0,Cb.PlaySong.Backgrounds.Frame.sizex,Cb.PlaySong.Backgrounds.Frame.sizey)Cb.PlaySong.Backgrounds.Frame.center=rl.new('Vector2',0,0)Cb.PlaySong.Backgrounds.Frame.pr=rl.new('Rectangle',332 /1280 *kb.ScreenWidth,136 /720 *kb.ScreenHeight,Cb.PlaySong.Backgrounds.Frame.sizex,Cb.PlaySong.Backgrounds.Frame.sizey)Cb.PlaySong.Backgrounds.Taiko.sizex=Cb.PlaySong.Backgrounds.Taiko.base.width;Cb.PlaySong.Backgrounds.Taiko.sizey=Cb.PlaySong.Backgrounds.Taiko.base.height;Cb.PlaySong.Backgrounds.Taiko.sourcerect=rl.new('Rectangle',0,0,Cb.PlaySong.Backgrounds.Taiko.sizex,Cb.PlaySong.Backgrounds.Taiko.sizey)Cb.PlaySong.Backgrounds.Taiko.center=rl.new('Vector2',0,0)Cb.PlaySong.Backgrounds.Taiko.pr=rl.new('Rectangle',210 /1280 *kb.ScreenWidth,206 /720 *kb.ScreenHeight,Cb.PlaySong.Backgrounds.Taiko.sizex,Cb.PlaySong.Backgrounds.Taiko.sizey)Cb.PlaySong.Backgrounds.ComboText.sizex=Cb.PlaySong.Backgrounds.ComboText[0].width;Cb.PlaySong.Backgrounds.ComboText.sizey=Cb.PlaySong.Backgrounds.ComboText[0].height;Cb.PlaySong.Backgrounds.ComboText.sourcerect=rl.new('Rectangle',0,0,Cb.PlaySong.Backgrounds.ComboText.sizex,Cb.PlaySong.Backgrounds.ComboText.sizey)Cb.PlaySong.Backgrounds.ComboText.center=rl.new('Vector2',0,0)Cb.PlaySong.Backgrounds.ComboText.pr=rl.new('Rectangle',220 /1280 *kb.ScreenWidth,198 /720 *kb.ScreenHeight,Cb.PlaySong.Backgrounds.ComboText.sizex,Cb.PlaySong.Backgrounds.ComboText.sizey)Cb.PlaySong.Backgrounds.Background.InfoBar.sizex=Cb.PlaySong.Backgrounds.Background.InfoBar[0].width;Cb.PlaySong.Backgrounds.Background.InfoBar.sizey=Cb.PlaySong.Backgrounds.Background.InfoBar[0].height;Cb.PlaySong.Backgrounds.Background.InfoBar.sourcerect=rl.new('Rectangle',0,0,Cb.PlaySong.Backgrounds.Background.InfoBar.sizex,Cb.PlaySong.Backgrounds.Background.InfoBar.sizey)Cb.PlaySong.Backgrounds.Background.InfoBar.center=rl.new('Vector2',0,0)Cb.PlaySong.Backgrounds.Background.InfoBar.pr=rl.new('Rectangle',0 /1280 *kb.ScreenWidth,184 /720 *kb.ScreenHeight,Cb.PlaySong.Backgrounds.Background.InfoBar.sizex,Cb.PlaySong.Backgrounds.Background.InfoBar.sizey)Cb.PlaySong.Backgrounds.Background.CourseSymbol.sizex=Cb.PlaySong.Backgrounds.Background.CourseSymbol[0].width;Cb.PlaySong.Backgrounds.Background.CourseSymbol.sizey=Cb.PlaySong.Backgrounds.Background.CourseSymbol[0].height;Cb.PlaySong.Backgrounds.Background.CourseSymbol.sourcerect=rl.new('Rectangle',0,0,Cb.PlaySong.Backgrounds.Background.CourseSymbol.sizex,Cb.PlaySong.Backgrounds.Background.CourseSymbol.sizey)Cb.PlaySong.Backgrounds.Background.CourseSymbol.center=rl.new('Vector2',0,0)Cb.PlaySong.Backgrounds.Background.CourseSymbol.pr=rl.new('Rectangle',58 /1280 *kb.ScreenWidth,230 /720 *kb.ScreenHeight,Cb.PlaySong.Backgrounds.Background.CourseSymbol.sizex,Cb.PlaySong.Backgrounds.Background.CourseSymbol.sizey)Cb.PlaySong.Backgrounds.Background.CourseSymbol.pr=rl.new('Rectangle',18 /1280 *kb.ScreenWidth,230 /720 *kb.ScreenHeight,Cb.PlaySong.Backgrounds.Background.CourseSymbol.sizex,Cb.PlaySong.Backgrounds.Background.CourseSymbol.sizey)Cb.PlaySong.Gauges.Clear[true]=rl.ImageFromImage(Cb.PlaySong.Gauges.Meter.base,rl.new('Rectangle',0,44,58,24))Cb.PlaySong.Gauges.Clear[false]=rl.ImageFromImage(Cb.PlaySong.Gauges.Meter.base,rl.new('Rectangle',58,44,58,24))Cb.PlaySong.Gauges.Meter.clear=rl.ImageCopy(Cb.PlaySong.Gauges.Meter.full)for x=0,Cb.PlaySong.Gauges.Meter.clear.width-1 do for y=0,Cb.PlaySong.Gauges.Meter.clear.height-1 do local qc=rl.GetImageColor(Cb.PlaySong.Gauges.Meter.clear,x,y)qc.g=qc.r;rl.ImageDrawPixel(Cb.PlaySong.Gauges.Meter.clear,x,y,qc)end end;Cb.PlaySong.Gauges=Gb(Cb.PlaySong.Gauges)Cb.PlaySong.Gauges=TextureMap.ReplaceWithTexture(Cb.PlaySong.Gauges)Cb.PlaySong.Gauges.Meter.sizex=Cb.PlaySong.Gauges.Meter.base.width;Cb.PlaySong.Gauges.Meter.sizey=Cb.PlaySong.Gauges.Meter.base.height;Cb.PlaySong.Gauges.Meter.sourcerect=rl.new('Rectangle',0,0,Cb.PlaySong.Gauges.Meter.sizex,Cb.PlaySong.Gauges.Meter.sizey)Cb.PlaySong.Gauges.Meter.center=rl.new('Vector2',0,0)Cb.PlaySong.Gauges.Meter.pr=rl.new('Rectangle',494 /1280 *kb.ScreenWidth,144 /720 *kb.ScreenHeight,Cb.PlaySong.Gauges.Meter.sizex,Cb.PlaySong.Gauges.Meter.sizey)Cb.PlaySong.Gauges.Meter.sourcerect2=rl.new('Rectangle',0,0,Cb.PlaySong.Gauges.Meter.sizex,Cb.PlaySong.Gauges.Meter.sizey)Cb.PlaySong.Gauges.Meter.pr2=rl.new('Rectangle',494 /1280 *kb.ScreenWidth,144 /720 *kb.ScreenHeight,Cb.PlaySong.Gauges.Meter.sizex,Cb.PlaySong.Gauges.Meter.sizey)Cb.PlaySong.Gauges.Clear.sizex=Cb.PlaySong.Gauges.Clear[true].width;Cb.PlaySong.Gauges.Clear.sizey=Cb.PlaySong.Gauges.Clear[true].height;Cb.PlaySong.Gauges.Clear.sourcerect=rl.new('Rectangle',0,0,Cb.PlaySong.Gauges.Clear.sizex,Cb.PlaySong.Gauges.Clear.sizey)Cb.PlaySong.Gauges.Clear.center=rl.new('Vector2',0,0)Cb.PlaySong.Gauges.Clear.pr=rl.new('Rectangle',1038 /1280 *kb.ScreenWidth,143 /720 *kb.ScreenHeight,Cb.PlaySong.Gauges.Clear.sizex,Cb.PlaySong.Gauges.Clear.sizey)Cb.PlaySong.Gauges.Meter.rainbow.sizex=Cb.PlaySong.Gauges.Meter.rainbow.Anim[0].width;Cb.PlaySong.Gauges.Meter.rainbow.sizey=Cb.PlaySong.Gauges.Meter.rainbow.Anim[0].height;Cb.PlaySong.Gauges.Meter.rainbow.sourcerect=rl.new('Rectangle',0,0,Cb.PlaySong.Gauges.Meter.rainbow.sizex,Cb.PlaySong.Gauges.Meter.rainbow.sizey)Cb.PlaySong.Gauges.Meter.rainbow.center=rl.new('Vector2',0,0)Cb.PlaySong.Gauges.Meter.rainbow.pr=rl.new('Rectangle',494 /1280 *kb.ScreenWidth,144 /720 *kb.ScreenHeight,Cb.PlaySong.Gauges.Meter.rainbow.sizex,Cb.PlaySong.Gauges.Meter.rainbow.sizey)Cb.PlaySong.Fonts=Gb(Cb.PlaySong.Fonts)Cb.PlaySong.Fonts=TextureMap.ReplaceWithTexture(Cb.PlaySong.Fonts)local gc={220,54}local hc={220,54}Cb.PlaySong.Nameplates=TextureMap.SplitUsingMap(Cb.PlaySong.Nameplates,Db.PlaySong.Nameplates,gc,hc)Cb.PlaySong.Nameplates=Gb(Cb.PlaySong.Nameplates)Cb.PlaySong.Nameplates=TextureMap.ReplaceWithTexture(Cb.PlaySong.Nameplates)Cb.PlaySong.Nameplates.sizex=Cb.PlaySong.Nameplates.base.width;Cb.PlaySong.Nameplates.sizey=Cb.PlaySong.Nameplates.base.height;Cb.PlaySong.Nameplates.sourcerect=rl.new('Rectangle',0,0,Cb.PlaySong.Nameplates.sizex,Cb.PlaySong.Nameplates.sizey)Cb.PlaySong.Nameplates.center=rl.new('Vector2',0,0)Cb.PlaySong.Nameplates.pr=rl.new('Rectangle',-5 /1280 *kb.ScreenWidth,296 /720 *kb.ScreenHeight,Cb.PlaySong.Nameplates.sizex,Cb.PlaySong.Nameplates.sizey)rl.InitAudioDevice()local ic={PlaySong={Combo=(not u.ComboSoundEnabled)and{}or{[50]=X('Sounds/Combo_1P/50.wav'),[100]=X('Sounds/Combo_1P/100.wav'),[200]=X('Sounds/Combo_1P/200.wav'),[300]=X('Sounds/Combo_1P/300.wav'),[400]=X('Sounds/Combo_1P/400.wav'),[500]=X('Sounds/Combo_1P/500.wav'),[600]=X('Sounds/Combo_1P/600.wav'),[700]=X('Sounds/Combo_1P/700.wav'),[800]=X('Sounds/Combo_1P/800.wav'),[900]=X('Sounds/Combo_1P/900.wav'),[1000]=X('Sounds/Combo_1P/1000.wav'),[1100]=X('Sounds/Combo_1P/1100.wav'),[1200]=X('Sounds/Combo_1P/1200.wav'),[1300]=X('Sounds/Combo_1P/1300.wav'),[1400]=X('Sounds/Combo_1P/1400.wav'),[1500]=X('Sounds/Combo_1P/1500.wav'),[1600]=X('Sounds/Combo_1P/1600.wav'),[1700]=X('Sounds/Combo_1P/1700.wav'),[1800]=X('Sounds/Combo_1P/1800.wav'),[1900]=X('Sounds/Combo_1P/1900.wav'),[2000]=X('Sounds/Combo_1P/2000.wav'),[2100]=X('Sounds/Combo_1P/2100.wav'),[2200]=X('Sounds/Combo_1P/2200.wav'),[2300]=X('Sounds/Combo_1P/2300.wav'),[2400]=X('Sounds/Combo_1P/2400.wav'),[2500]=X('Sounds/Combo_1P/2500.wav'),[2600]=X('Sounds/Combo_1P/2600.wav'),[2700]=X('Sounds/Combo_1P/2700.wav'),[2800]=X('Sounds/Combo_1P/2800.wav'),[2900]=X('Sounds/Combo_1P/2900.wav'),[3000]=X('Sounds/Combo_1P/3000.wav'),[3100]=X('Sounds/Combo_1P/3100.wav'),[3200]=X('Sounds/Combo_1P/3200.wav'),[3300]=X('Sounds/Combo_1P/3300.wav'),[3400]=X('Sounds/Combo_1P/3400.wav'),[3500]=X('Sounds/Combo_1P/3500.wav'),[3600]=X('Sounds/Combo_1P/3600.wav'),[3700]=X('Sounds/Combo_1P/3700.wav'),[3800]=X('Sounds/Combo_1P/3800.wav'),[3900]=X('Sounds/Combo_1P/3900.wav'),[4000]=X('Sounds/Combo_1P/4000.wav'),[4100]=X('Sounds/Combo_1P/4100.wav'),[4200]=X('Sounds/Combo_1P/4200.wav'),[4300]=X('Sounds/Combo_1P/4300.wav'),[4400]=X('Sounds/Combo_1P/4400.wav'),[4500]=X('Sounds/Combo_1P/4500.wav'),[4600]=X('Sounds/Combo_1P/4600.wav'),[4700]=X('Sounds/Combo_1P/4700.wav'),[4800]=X('Sounds/Combo_1P/4800.wav'),[4900]=X('Sounds/Combo_1P/4900.wav'),[5000]=X('Sounds/Combo_1P/5000.wav')},Notes={[1]=X('Sounds/Taiko/dong.ogg'),[2]=X('Sounds/Taiko/ka.ogg'),adlib=X('Sounds/Taiko/Adlib.ogg'),balloonpop=X('Sounds/balloon.ogg')}}}local jc={PlaySong={Lyric=db('Nijiiro Font/Nijiiro font.otf',32,nil,0xFFFF)}}Cb.SongSelect.GenreBar=Gb(Cb.SongSelect.GenreBar)Cb.SongSelect.GenreBar=TextureMap.ReplaceWithTexture(Cb.SongSelect.GenreBar)Cb.SongSelect.GenreBar.sizex=Cb.SongSelect.GenreBar[0].width;Cb.SongSelect.GenreBar.sizey=Cb.SongSelect.GenreBar[0].height;Cb.SongSelect.GenreBar.sourcerect=rl.new('Rectangle',0,0,Cb.SongSelect.GenreBar.sizex,Cb.SongSelect.GenreBar.sizey)Cb.SongSelect.GenreBar.center=rl.new('Vector2',0,0)Cb.SongSelect.GenreBar.pr=rl.new('Rectangle',0,0,Cb.SongSelect.GenreBar.sizex,Cb.SongSelect.GenreBar.sizey)function Taiko.ParseBoxDef(qc)local rc={}local sc=String.Split(qc,'\n')for i=1,#sc do local uc=String.Trim(sc[i])if string.sub(uc,1,1)==';'then else local vc=string.find(uc,';')if vc then uc=string.sub(uc,1,vc-1)end;local wc={string.match(uc,'#(.+):(.*)')}if wc[1]then rc[wc[1]]=wc[2]end end end;rc.TITLE=tostring(rc.TITLE)rc.GENRE=tostring(rc.GENRE)rc.FONTCOLOR={HexToRGB(rc.FONTCOLOR or'#000000')}rc.FORECOLOR={HexToRGB(rc.FORECOLOR or'#000000')}rc.BACKCOLOR={HexToRGB(rc.BACKCOLOR or'#000000')}rc.BOXCOLOR={HexToRGB(rc.BOXCOLOR or'#000000')}rc.BGCOLOR={HexToRGB(rc.BGCOLOR or'#000000')}rc.BGTYPE=rc.BGTYPE or 0;rc.BOXTYPE=rc.BOXTYPE or 0;rc.BOXCHARA=rc.BOXCHARA or 0;local tc=1;rc.BOXEXPLANATION={}for i=0,3 do local uc='BOXEXPLANATION'..tostring(i)if rc[uc]then rc.BOXEXPLANATION[i]=rc[uc]end end;return rc end;function Taiko.SongSelect()local qc={Text={},Name={},Config={},Expanded={},Path={}}local rc,sc=O()local tc=P(sc)local uc={}local vc=tc;local wc=1;local xc=5;local yc=0;local zc=nil;local Ac=nil;local Bc=0;local function Cc(Kc,Lc)local Mc=Kc;for i=1,#Lc do Mc=Mc[Lc[i]]end;return Mc end;local function Dc(Kc)local Lc={}for i=1,#Kc do Lc[i]=Kc[i]end;return Lc end;local function Ec(Kc)return table.concat(Kc,'/')end;local function Fc(Kc,Lc)local Mc={{},{}}for i=1,#Kc do Mc[1][i]=i;Mc[2][i]=Compact.Search(Kc[i],Lc)end;table.sort(Mc[1],function(Nc,Oc)return Mc[2][Nc]>Mc[2][Oc]end)return Mc end;local function Gc(Kc,Lc,Mc)local Nc=function(Qc,Rc)local Sc={}for Uc in pairs(Qc)do Sc[#Sc+1]=Uc end;if Rc then table.sort(Sc,function(Uc,Vc)return Rc(Qc,Uc,Vc)end)else table.sort(Sc)end;local Tc=0;return function()Tc=Tc+1;if Sc[Tc]then return Sc[Tc],Qc[Sc[Tc]]end end end;local function Oc(Qc,Rc,Sc)if type(Qc[Rc])=='string'and type(Qc[Sc])=='string'then return Qc[Rc]<Qc[Sc]elseif type(Qc[Rc])=='string'then return false elseif type(Qc[Sc])=='string'then return true else return Rc<Sc end end;local Pc=0;for Qc,Rc in Nc(Kc,Oc)do table.insert(qc.Text,Lc+Pc,Qc)table.insert(qc.Name,Lc+Pc,type(Rc)=='string'and K(Rc)or Qc)table.insert(qc.Path,Lc+Pc,Mc)if type(Rc)=='table'then local Sc=u.Paths.Songs..Ec(Mc)..'/'..Qc..'/box.def'if Q(Sc)then local Tc=R(Sc)local Uc=Taiko.ParseBoxDef(Tc)qc.Config[Lc-1]=Uc;require'ppp'(Uc)end end;Pc=Pc+1 end;for Qc,Rc in pairs(qc.Expanded)do if Qc>=Lc then qc.Expanded[Qc+Pc]=Rc;qc.Expanded[Qc]=nil end end;return Pc end;local function Hc(Kc,Lc)for Mc,Nc in pairs(qc.Expanded)do if Mc>=Kc then qc.Expanded[Mc-Lc]=Nc;qc.Expanded[Mc]=nil end end;for i2=1,Lc do table.remove(qc.Text,Kc)table.remove(qc.Name,Kc)table.remove(qc.Path,Kc)end end;local function Ic(Kc,Lc)if qc.Expanded[wc]then Hc(wc+1,qc.Expanded[wc])qc.Expanded[wc]=nil else local Mc=Dc(uc)Mc[#Mc+1]=Kc;qc.Expanded[wc]=Gc(Lc,wc+1,Mc)end end;local Jc=Gc(tc,1,Dc(uc))while true do rl.BeginDrawing()rl.ClearBackground(rl.RAYWHITE)rl.DrawFPS(10,10)local Kc=0;for i=wc-xc,wc+xc do local Nc=nil;if i>#qc.Text then Nc=i%#qc.Text;if Nc==0 then Nc=#qc.Text end elseif i<1 then Nc=#qc.Text- (-i%#qc.Text)else Nc=i end;Kc=Kc+1;rl.DrawText(i==wc and'> '..qc.Text[Nc]or qc.Text[Nc],100,Kc*50,B,rl.BLACK)end;rl.EndDrawing()if rl.WindowShouldClose()then rl.CloseWindow()error()break end;if lb(u.Controls.SongSelect.L)then wc=wc-1 end;if lb(u.Controls.SongSelect.R)then wc=wc+1 end;local Lc=u.Controls.SongSelect.L;if mb(Lc)then if zc~=Lc then yc=0;zc=Lc;Ac=-1 end;yc=yc+rl.GetFrameTime()elseif Lc==zc then yc=0;zc=nil end;local Mc=u.Controls.SongSelect.R;if mb(Mc)then if zc~=Mc then yc=0;zc=Mc;Ac=1 end;yc=yc+rl.GetFrameTime()elseif Mc==zc then yc=0;zc=nil end;if yc- (Bc*u.Controls.SongSelect.FastScrollInterval)>=u.Controls.SongSelect.FastScrollTime then wc=wc+Ac;Bc=Bc+1 else Bc=0 end;if wc>#qc.Text then wc=wc%#qc.Text;if wc==0 then wc=#qc.Text end elseif wc<1 then wc=#qc.Text- (-wc%#qc.Text)else end;uc=qc.Path[wc]rl.DrawText('Path: '..Ec(uc),100,0,B,rl.BLACK)if lb(u.Controls.SongSelect.Select)then vc=Cc(tc,uc)local Nc=qc.Name[wc]local Oc=vc[Nc]if type(Oc)=='string'then while true do local Pc,Qc=Taiko.ParseTJAFile(Oc)if Pc then local Rc=Taiko.GetDifficulty(Pc,'oni')local Sc,Tc=Taiko.PlaySong(Rc)if Sc==true then break elseif Sc==false then elseif Sc==nil then break else end else error('SONGSELECT: '..Qc)end end else Ic(Nc,Oc)vc=Oc end end;if lb(u.Controls.SongSelect.Search.Init)then local Nc={}local Oc={}local Pc=nil;if mb(u.Controls.SongSelect.Search.All)then Pc=tc;uc={}for i=1,#qc.Path do if#qc.Path[i]==#uc then wc=i;break end end else vc=Cc(tc,uc)Pc=vc end;local function Qc(ed,fd,gd,hd)for id,jd in pairs(ed)do if type(jd)=='table'then local kd=Dc(hd)kd[#kd+1]=id;Qc(jd,fd,gd,kd)else fd[#fd+1]=id;gd[#gd+1]=hd end end;return fd,gd end;Nc,Oc=Qc(Pc,Nc,Oc,{})local Rc=nil;local Sc=10;local Tc=nil;local Uc=nil;local Vc=1;local Wc=1;local Xc=false;local Yc='Search:\n'local Zc={}local ad=''local bd='\n'local cd='\n'local dd=Yc;while true do rl.BeginDrawing()rl.ClearBackground(rl.RAYWHITE)rl.DrawText(dd,0,0,B,rl.BLACK)rl.EndDrawing()while true do local ed=rl.GetCharPressed()if ed==0 then break else Zc[#Zc+1]=ed;ad=l(Zc)dd=Yc..ad..cd;Uc=nil end end;if rl.IsKeyPressed(rl.KEY_BACKSPACE)then Zc[#Zc]=nil;ad=l(Zc)dd=Yc..ad..cd;Uc=nil end;if lb(u.Controls.SongSelect.Search.U)then Vc=Vc-1 end;if lb(u.Controls.SongSelect.Search.D)then Vc=Vc+1 end;if Uc==nil and#Zc>0 then Tc=Fc(Nc,ad)local ed={'\n'}Uc=nil;for i=1,Sc do local fd=Tc[1][i]if not Tc[2][fd]or Tc[2][fd]==-math.huge then Uc=i-1;break else ed[#ed+1]=tostring(i)ed[#ed+1]='. 'ed[#ed+1]=Nc[fd]ed[#ed+1]='\n'end end;Uc=Uc or Sc;bd=table.concat(ed)Xc=true end;if Uc then Vc=ClipN(Vc,1,Uc)end;if Vc~=Wc or Xc then cd=string.gsub(bd,'\n'..Vc,'\n>')dd=Yc..ad..cd;Xc=false end;Wc=Vc;if lb(u.Controls.SongSelect.Search.Select)and Uc and Uc~=0 then break end;if lb(u.Controls.SongSelect.Search.Escape)then Rc=true;break end;if rl.WindowShouldClose()then rl.CloseWindow()error()end end;if not Rc then local ed=Tc[1][Vc]local fd=Dc(Oc[ed])local gd=Nc[ed]fd[#fd+1]=gd;vc=Pc;uc=Dc(uc)for i=1,#fd do local hd=nil;local id=nil;for i2=1,#qc.Text do if qc.Name[i2]==fd[i]and#uc==#qc.Path[i2]then local jd=true;for i3=1,#uc do if uc[i3]~=qc.Path[i2][i3]then jd=false;break end end;if jd then hd=qc.Name[i2]id=vc[hd]if type(id)=='string'then if i==#fd then wc=i2;break end else wc=i2;break end end end end;if i==#fd then break end;if not qc.Expanded[wc]then Ic(hd,id)end;vc=id;uc[#uc+1]=hd end end end end end;local kc={startms=nil,framen=ab(Cb.PlaySong.Balloons.Anim),anim={[0]=0.125 *8,[1]=0.125 *7,[2]=0.125 *6,[3]=0.125 *5,[4]=0.125 *4,[5]=0.125 *3,[6]=0.125 *2,[7]=0.125 *1,[8]=0.125 *0},color=rl.new('Color',255,255,255,255)}local lc={startms=nil,framen=31,anim={[0]=0,[1]=0,[2]=0,[3]=0,[4]=0,[5]=0,[6]=0,[7]=0,[8]=0,[9]=0,[10]=0,[11]=0,[12]=0,[13]=0,[14]=0,[15]=0,[16]=0,[17]=0,[18]=0,[19]=0,[20]=0,[21]=0,[22]=0,[23]=0.2,[24]=0.4,[25]=0.6,[26]=0.8,[27]=1,[28]=0.8,[29]=0.6,[30]=0.4,[31]=0.2},color=rl.new('Color',255,255,255,255)}local mc={startms=nil,framen=12,anim=Cb.PlaySong.Gauges.Meter.rainbow.Anim}local nc={anim={[0]=1,[1]=1,[2]=1,[3]=0.75,[4]=0.5,[5]=0.25},[1]={startms=nil,color=rl.new('Color',255,255,255,255)},[2]={startms=nil,color=rl.new('Color',255,255,255,255)}}local oc={animp={[0]=98,[1]=92,[2]=88,[3]=84,[4]=80,[5]=77,[6]=75,[7]=75,[8]=75,[9]=75,[10]=75,[11]=75,[12]=75,[13]=75,[14]=75,[15]=75,[16]=75,[17]=75,[18]=75,[19]=75,[20]=75,[21]=75,[22]=75,[23]=75,[24]=75,[25]=75},animt={[0]=1,[1]=1,[2]=1,[3]=1,[4]=1,[5]=1,[6]=1,[7]=1,[8]=1,[9]=1,[10]=1,[11]=1,[12]=1,[13]=1,[14]=1,[15]=1,[16]=1,[17]=1,[18]=1,[19]=1,[20]=1,[21]=1,[22]=0.75,[23]=0.5,[24]=0.25,[25]=0},startms={},judge={},color=rl.new('Color',255,255,255,255)}local pc={anim={[0]=0.125 *8,[1]=0.125 *8,[2]=0.125 *8,[3]=0.125 *8,[4]=0.125 *8,[5]=0.125 *6,[6]=0.125 *4,[7]=0.125 *2,[8]=0.125 *0},[1]={[1]={startms=nil,color=rl.new('Color',255,255,255,255)},[2]={startms=nil,color=rl.new('Color',255,255,255,255)},sourcerect=rl.new('Rectangle',0,0,Cb.PlaySong.Backgrounds.Taiko.sizex/2,Cb.PlaySong.Backgrounds.Taiko.sizey),opr=rl.new('Rectangle',Cb.PlaySong.Backgrounds.Taiko.pr.x,Cb.PlaySong.Backgrounds.Taiko.pr.y,Cb.PlaySong.Backgrounds.Taiko.sizex/2,Cb.PlaySong.Backgrounds.Taiko.sizey),pr=rl.new('Rectangle',0,0,0,0),center=rl.new('Vector2',0,0)},[2]={[1]={startms=nil,color=rl.new('Color',255,255,255,255)},[2]={startms=nil,color=rl.new('Color',255,255,255,255)},sourcerect=rl.new('Rectangle',Cb.PlaySong.Backgrounds.Taiko.sizex/2,0,Cb.PlaySong.Backgrounds.Taiko.sizex/2,Cb.PlaySong.Backgrounds.Taiko.sizey),opr=rl.new('Rectangle',Cb.PlaySong.Backgrounds.Taiko.pr.x+Cb.PlaySong.Backgrounds.Taiko.sizex/2,Cb.PlaySong.Backgrounds.Taiko.pr.y,Cb.PlaySong.Backgrounds.Taiko.sizex/2,Cb.PlaySong.Backgrounds.Taiko.sizey),pr=rl.new('Rectangle',0,0,0,0),center=rl.new('Vector2',0,0)}}function Taiko.PlaySong(qc)Tb()local rc={Qb[1],Qb[2]}Rb(Cb,1 /Qb[1],1 /Qb[2])local sc={}local tc=qc.Metadata.SONG;local uc;local vc=false;if tc then if Q(qc.Metadata.SONG)then uc=U(qc.Metadata.SONG)rl.SetMusicVolume(uc,qc.Metadata.SONGVOL)else tc=false end end;for Ae,Be in pairs(ic.PlaySong.Combo)do rl.SetSoundVolume(Be,qc.Metadata.SEVOL)end;for Ae,Be in pairs(ic.PlaySong.Notes)do rl.SetSoundVolume(Be,qc.Metadata.SEVOL)end;local wc=true;local xc={[1]=1,[2]=2,[3]=1,[4]=2}local yc=1;local zc=1;local Ac=qc.Metadata.STOPSONG;local Bc=true;local Cc=true;local Dc=true;if qc.Flag.PARSER_FORCE_OLD_BPMCHANGE then Cc=false end;local Ec=kb.ScreenWidth;local Fc=1 /16 *kb.ScreenWidth;local Gc=5 /16 *kb.ScreenWidth;local Hc=1000;local Ic=72 /2 /1280 *kb.ScreenWidth;local Jc=0 *kb.ScreenWidth;local Kc={414 /1280 *kb.ScreenWidth,- (257 /720 -1 /2)*kb.ScreenHeight}if qc.Flag.PARSER_FORCE_OLD_TARGET then Kc={1 /4 *kb.ScreenWidth,0}end;local Lc=pb+Ec;local Mc={0,-kb.ScreenHeight/2,kb.ScreenWidth,kb.ScreenHeight/2}local Nc={Mc[1]-Fc,Mc[2]-Fc,Mc[3]+Fc,Mc[4]+Fc}local Oc={Mc[1]-Gc,Mc[2]-Gc,Mc[3]+Gc,Mc[4]+Gc}local function Pc(Ae)return math.floor(Ae+0.5)end;local function Qc(Ae)return Ae- (math.floor(Ae/360)*360)end;local function Rc(Ae)return(Ae.data=='note')or(Ae.data=='event'and Ae.event=='barline')end;local function Sc(Ae,Be,Ce,De,Ee,Fe)return Ce<=Ae and Ae<=Ee and De<=Be and Be<=Fe end;local function Tc(Ae,Be,Ce,De,Ee,Fe,Ge,He)Ee,Fe,Ge,He=Ee-Ae,Fe-Be,Ge-Ae,He-Be;local Ie=De/Ce;if De<0 then local Je,Ke=Fe/Ie,Fe;if Ee<=Je and Je<=Ge then return Je,Ke end else local Je,Ke=He/Ie,He;if Ee<=Je and Je<=Ge then return Je,Ke end end;if Ce<0 then local Je,Ke=Ee,Ee*Ie;if Fe<=Ke and Ke<=He then return Je,Ke end else local Je,Ke=Ge,Ge*Ie;if Fe<=Ke and Ke<=He then return Je,Ke end end;return nil end;local function Uc(Ae,Be,Ce,De,Ee,Fe,Ge,He)if(Ee<=Ae and Ae<=Ge and Fe<=Be and Be<=He)and(Ee<=Ce and Ce<=Ge and Fe<=De and De<=He)then return false end;local Ie=(De-Be)/ (Ce-Ae)local Je=Be-Ie*Ae;if(Ce-Ae)==0 then if(not(Ee<=Ae and Ae<=Ge and Fe<=Be and Be<=He))and(not(Ee<=Ce and Ce<=Ge and Fe<=De and De<=He))then return true else return false end else local Ke,Le=Ie*Ee+Je,Ie*Ge+Je;if(Ae<=Ee and Ee<=Ce)and(Fe<=Ke and Ke<=He)then return false end;if(Ae<=Ge and Ge<=Ce)and(Fe<=Le and Le<=He)then return false end end;if(De-Be)==0 then if(not(Ee<=Ae and Ae<=Ge and Fe<=Be and Be<=He))and(not(Ee<=Ce and Ce<=Ge and Fe<=De and De<=He))then return true else return false end else local Ke,Le=(Fe-Je)/Ie,(He-Je)/Ie;if(Be<=Fe and Fe<=De)and(Ee<=Ke and Ke<=Ge)then return false end;if(Be<=He and He<=De)and(Ee<=Le and Le<=Ge)then return false end end;return true end;local function Vc(Ae,Be)return Kc[1]- (Ae.speed[1]* (Ae.ms-Be-Ae.delay)),Kc[2]- (Ae.speed[2]* (Ae.ms-Be-Ae.delay))end;local function Wc(Ae,Be)local Ce,De=Tc(Kc[1],Kc[2],-Ae.scrollx,-Ae.scrolly,Nc[1],Nc[2],Nc[3],Nc[4])return Be- (Ce~=0 and Ce/-Ae.speed[1]or De/-Ae.speed[2])end;local function Xc(Ae,Be)local Ce=-10;local De=Be;while true do Ae.p[1],Ae.p[2]=Vc(Ae,De)Ae.p[1],Ae.p[2]=Ae.p[1]*Nb,Ae.p[2]*Ob;Ae.startnote.p[1],Ae.startnote.p[2]=Vc(Ae.startnote,De)Ae.startnote.p[1],Ae.startnote.p[2]=Ae.startnote.p[1]*Nb,Ae.startnote.p[2]*Ob;if Uc(Ae.p[1]<Ae.startnote.p[1]and Ae.p[1]or Ae.startnote.p[2],Ae.p[2]<Ae.startnote.p[2]and Ae.p[2]or Ae.startnote.p[2],Ae.p[1]<Ae.startnote.p[1]and Ae.startnote.p[1]or Ae.p[2],Ae.p[2]<Ae.startnote.p[2]and Ae.startnote.p[2]or Ae.p[2],Nc[1],Nc[2],Nc[3],Nc[4])then return De else De=De+Ce end;if Be-De>1000 then return Be end end end;local Yc=Taiko.GetAllNotes(qc.Data)local Zc=qc.Metadata.OFFSET;local ad=1000 /60;local bd=Taiko.Data.Timing.Level[qc.Metadata.TIMING]local cd={}local dd=0;local ed={[1]=true,[2]=true,[3]=true,[4]=true}local fd={}local gd='M'local hd,id=nil,nil;if qc.Flag.PARSER_FORCE_OLD_SPEED_CALCULATION then hd=Taiko.CalculateSpeed;if qc.Flag.PARSER_FORCE_OLD_NOTERADIUS then Ic=1 /40 *kb.ScreenWidth end;id=Ic else hd=Taiko.CalculateSpeedInterval;id=kb.ScreenWidth/1280 end;for Ae,Be in pairs(Yc)do Be.ms=Be.oms or Be.ms;Be.oms=Be.ms;Be.ms=(Be.ms-Zc)/zc;Be.delay=Be.odelay or Be.delay;Be.odelay=Be.delay;Be.p={}Be.delay=Be.delay/zc;Be.speed=hd(Be,id)Be.speed[1]=Be.speed[1]*yc;Be.speed[2]=Be.speed[2]*yc;if Be.jposscroll then Be.jposscroll.lengthms=Be.jposscroll.olengthms or Be.jposscroll.lengthms;Be.jposscroll.olengthms=Be.jposscroll.lengthms;Be.jposscroll.lengthms=Be.jposscroll.lengthms/zc;cd[#cd+1]=Be end;Be.loadms=Wc(Be,Be.ms-Be.delay)if Be.type==8 and(Be.startnote.type==5 or Be.startnote.type==6)then Be.loadms=Xc(Be,Be.startnote.loadms<Be.loadms and Be.startnote.loadms or Be.loadms)end;Be.hit=nil;Be.timeshit=nil;Be.brokecombo=false;Be.setdelay=false;Be.pop=false;fd[#fd+1]=Be.ms;Be.senotet=Be.senote and Be.senote-1;if(Be.currentbranch==nil or Be.currentbranch==gd)and ed[Be.type]then dd=dd+1 end end;if Ac or Cc then for Ae,Be in pairs(qc.Data)do if Be.branch then for Ce,De in pairs(Be.branch.paths)do table.sort(De,function(Ee,Fe)return Ee.ms<Fe.ms end)end end end;table.sort(qc.Data,function(Ae,Be)if Ae.branch and Be.branch then for Ce,De in pairs(Ae.branch.paths)do for Ee,Fe in pairs(Be.branch.paths)do return De[1].ms<Fe[1].ms end end elseif Ae.branch then for Ce,De in pairs(Ae.branch.paths)do return De[1].ms<Be.ms end elseif Be.branch then for Ce,De in pairs(Be.branch.paths)do return Ae.ms<De[1].ms end else return Ae.ms<Be.ms end end)end;local jd={}if Cc then local Ae=qc.Metadata.BPM;local Be={ms={},bpmchangemul={},offset=0}Taiko.ForAll(qc.Data,function(Ce,De,Ee)if Ce.bpmchange then Ce.bpmchangemul=Ce.bpmchange/Ae;Ae=Ce.bpmchange;Be.ms[#Be.ms+1]=Ce.ms;Be.bpmchangemul[#Be.bpmchangemul+1]=Ce.bpmchangemul;jd[#jd+1]=Ce end;for i=#Be.ms,1,-1 do Ce.ms=( (Ce.ms-Be.ms[i])*Be.bpmchangemul[i])+Be.ms[i]Ce.speed[1]=Ce.speed[1]/Be.bpmchangemul[i]Ce.speed[2]=Ce.speed[2]/Be.bpmchangemul[i]end;Ce.bpm=qc.Metadata.BPM;Ce.loadms=Wc(Ce,Ce.ms-Ce.delay)end)end;local kd={}if Ac then local Ae=nil;local Be=0;Taiko.ForAll(qc.Data,function(Ce,De,Ee)if Ce.delay~=Be then if Ae then Ae.stopms=Ce.delay-Ae.delay;Ae.stopstart=Ae.ms;Ae.stopend=Ae.stopstart+Ae.stopms end;Be=Ce.delay end;if Ae and Ae.stopstart then kd[#kd+1]=Ae end;Ae=Ce end)end;for Ae,Be in pairs(qc.Data)do if Be.branch then for Ce,De in pairs(Be.branch.paths)do table.sort(De,function(Ee,Fe)return Ee.loadms<Fe.loadms end)end end end;table.sort(qc.Data,function(Ae,Be)if Ae.branch and Be.branch then for Ce,De in pairs(Ae.branch.paths)do for Ee,Fe in pairs(Be.branch.paths)do return De[1].loadms<Fe[1].loadms end end elseif Ae.branch then for Ce,De in pairs(Ae.branch.paths)do return De[1].loadms<Be.loadms end elseif Be.branch then for Ce,De in pairs(Be.branch.paths)do return Ae.loadms<De[1].loadms end else return Ae.loadms<Be.loadms end end)Taiko.ConnectAll(qc.Data)Taiko.ForAll(qc.Data,function(Ae,Be,Ce)Ae.n=Ce end)local ld=Hc/zc;local md=fd[1]for i=1,#fd do if fd[i]>md then md=fd[i]end end;md=md+ld;local nd={}local od={barline={},drumroll={},notes={}}local pd={}local qd=qc.Data[1]local rd='M'local sd=0;local td,ud,vd=qc.Metadata.SCOREINIT,qc.Metadata.SCOREDIFF,Taiko.Data.ScoreMode.Note[qc.Metadata.SCOREMODE]local wd=0;local xd=false;local yd=0;local zd=0;local Ad=false;local Bd=false;local Cd=Taiko.Data.Gauge.Soul[qc.Metadata.COURSE](dd)local Dd=Taiko.Data.Gauge.Percent;local Ed=nil;local Fd=nil;local Gd=nil;local Hd=Taiko.Data.ScoreMode.Balloon[qc.Metadata.SCOREMODE]local Id=Taiko.Data.ScoreMode.BalloonPop[qc.Metadata.SCOREMODE]local Jd=nil;local Kd=nil;local Ld=nil;local Md={}local Nd=Taiko.Data.ScoreMode.Drumroll[qc.Metadata.SCOREMODE]local Od={startms=nil,status=nil}local Pd=nil;local Qd=nil;local Rd=nil;local Sd=0;local Td=nil;local Ud=nil;local Vd={nil,nil}local Wd={nil,nil}local Xd={}local Yd={}local Zd=nil;for i=1,#qc.Lyric do local Ae=qc.Lyric[i]Ae.x=0;Ae.y=600;Ae.p=rl.new('Vector2',Ae.x,Ae.y)Ae.spacing=5;Ae.size=50;Ae.p2=rl.new('Vector2',0,0)Ae.odata=Ae.odata or Ae.data;Ae.data=Ae.odata;if Ae.data then if u.Settings.PlaySong.LyricRomajiToHiragana then Ae.data=Romaji.ToHiragana(Ae.data)end;Ae.data=m(Ae.data)for i=1,#Ae.data do Yd[Ae.data[i]]=true end;Ae.datac=rl.new('int[?]',#Ae.data,Ae.data)else Ae.data=nil;Ae.datac=nil end;Xd[#Xd+1]=Ae end;local ae={}for Ae,Be in pairs(Yd)do ae[#ae+1]=Ae end;local be=jc.PlaySong.Lyric(ae,Yd)for i=1,#qc.Lyric do qc.Lyric[i].font=be end;local ce=false;local de;local ee='test.trp'local fe=false;local ge;local he='test.trp'local ie;local je;local ke;local le;if ce then de={[1]={[false]={},[true]={}},[2]={[false]={},[true]={}}}end;if fe then ge,ie=Replay.Load(Replay.Read(he))local function Ae(Be,Ce)if Be then else error(Ce..' does not match')end end;Ae(Replay.Version==ie.version,'Version')Ae(qc.Metadata.TITLE==ie.title,'Title')je={}for Be,Ce in pairs(ge)do je[#je+1]=Be end;table.sort(je)le=1;ke=je[le]end;Taiko.ForAll(qc.Data,function(Ae,Be,Ce)local De=Qc(math.deg(math.atan2(-Ae.scrollx,-Ae.scrolly))-90)if De<90 or De>=270 then Ae.rotationr=De else Ae.rotationr=180 +De end;if Ae.type==3 or Ae.type==4 or Ae.type==6 then Ae.radiusr=Ae.radius/tb else Ae.radiusr=Ae.radius or 1 end;if Ae.data=='event'and Ae.event=='barline'then Ae.type='bar'Ae.pr=rl.new('Rectangle',0,0,Wb,Xb)Ae.tcentero=rl.new('Vector2',Zb.x*Ae.radiusr,Zb.y*Ae.radiusr)else Ae.pr=rl.new('Rectangle',0,0,Hb,Ib)Ae.tcentero=rl.new('Vector2',Kb.x*Ae.radiusr,Kb.y*Ae.radiusr)end;Ae.tcenter=rl.new('Vector2',0,0)Ae.pr.width=Ae.pr.width*Ae.radiusr;Ae.pr.height=Ae.pr.height*Ae.radiusr;if Ae.senote then Ae.osenotepr=rl.new('Rectangle',0,0,Cb.PlaySong.SENotes.sizex,Cb.PlaySong.SENotes.sizey)Ae.senotepr=rl.new('Rectangle',0,0,0,0)end;if Ae.startnote then local Ee=Ae.startnote;if Ee.type==5 or Ee.type==6 then Ae.rotationr=De;if Ee.type==5 then Ee.notetype='drumrollnote'Ee.recttype='drumrollrect'Ee.endtype='drumrollend'elseif Ee.type==6 then Ee.notetype='DRUMROLLnote'Ee.recttype='DRUMROLLrect'Ee.endtype='DRUMROLLend'end;Md[#Md+1]=Ee elseif Ee.type==7 then end end end)local me=0;local ne;local oe,pe={},{}local qe=false;local re={notes={},startms={},currenttarget={[1]={},[2]={}},anim={}}local se;do local Ae={{},{},{},{}}local Be=25 * (Ab/60)se=function(Ce)local function De(Ke,Le,Me)local Ne=1 -Ke;for Oe,Pe in pairs(Le)do Me[Oe][1]=Pe[1]Me[Oe][2]=Pe[2]end;for i=2,#Me do for k=1,#Me-i+1 do Me[k][1]=Me[k][1]*Ne+Me[k+1][1]*Ke;Me[k][2]=Me[k][2]*Ne+Me[k+1][2]*Ke end end;return{Me[1][1],Me[1][2]}end;local function Ee(Ke)return math.sin(math.pi/2 *Ke)end;local Fe=0;local Ge={Ce[1]*Nb+rb,Ce[2]*Ob+sb}local He={x1=Ge[1]+ (14 /1280 * (kb.ScreenWidth/Qb[1])),y1=Ge[2]- (29 /720 * (kb.ScreenHeight/Qb[2])),x2=(kb.ScreenWidth/Qb[1])- (55 /1280 * (kb.ScreenWidth/Qb[1])),y2=Fe+ (165 /720 * (kb.ScreenHeight/Qb[2]))}He.w=He.x2 -He.x1;He.h=(63 /720 * (kb.ScreenHeight/Qb[2]))local Ie={{He.x1,He.y1},{He.x1 +He.w/6,He.y1 -He.h*3.5},{He.x2 -He.w/3,He.y2 -He.h*5},{He.x2,He.y2}}re.anim[Ce[1]]=re.anim[Ce[1]]or{}re.anim[Ce[1]][Ce[2]]={}local Je=re.anim[Ce[1]][Ce[2]]Je[0]={nil,nil}for i=1,Be do local Ke=(i-1)/ (Be-1)local Le=De(Ee(Ke),Ie,Ae)Je[i]=Le end end end;se(vb)local function te(Ae,Be)rl.PlaySound(ic.PlaySong.Notes[Ae])local Ce=pc[Be==false and 1 or Be==true and 2]Ce[Ae].startms=ne;Ce[Ae].color.a=255;nc[Ae].startms=ne;nc[Ae].color.a=255;if ce then de[Ae][Be][#de[Ae][Be]+1]=ne end;if pe[Ae]and(not pe[Ae].hit)then local De=pe[Ae]local Ee=De.type;local Fe=oe[Ae]local Ge;local He;local Ie=( (Ee==3 or Ee==4)and Taiko.Data.BigLeniency)or 1;local Je=nil;local Ke=(Ee==3 or Ee==4)if Fe< (bd.good)then Ge=(Ke and 3)or 2;wd=wd+1;Je=(Ke and 4)or 2;He=2 elseif Fe< (bd.ok*Ie)then Ge=(Ke and 2)or 1;wd=wd+1;Je=(Ke and 3)or 1;He=1 elseif Fe< (bd.bad*Ie)then Ge=0;wd=0;Je=0;He=0 else Ge=nil end;if Ge then sd=vd(sd,wd,td,ud,Ge,De.gogo)yd=yd+Cd[He]zd=Dd(yd)Ad=zd>=Taiko.Data.Gauge.ClearPercent;local Le=Bd;Bd=zd>=Taiko.Data.Gauge.OverflowPercent;if Bd and(not Le)then mc.startms=ne end;pe[Ae].hit=true;Od.startms=ne;Od.status=Je;Od.statusanim=Je~=0 and Cb.PlaySong.Effects.Note.Hit[Je].Anim;Od.explosionanim=Je~=0 and Cb.PlaySong.Effects.Note.Explosion[Je].Anim;Od.explosionbiganim=(Ke and Cb.PlaySong.Effects.Note.ExplosionBig.Anim)or nil;local Me=#re.notes+1;re.notes[Me]=pe[Ae]re.startms[Me]=ne;re.currenttarget[1][Me]=Kc[1]re.currenttarget[2][Me]=Kc[2]if re.anim[Kc[1]]and re.anim[Kc[1]][Kc[2]]then else se(Kc)end;oc.startms[#oc.startms+1]=ne;oc.judge[#oc.judge+1]=He;if ic.PlaySong.Combo[wd]then rl.PlaySound(ic.PlaySong.Combo[wd])end end end;if(Ae==1)and Fd and(ne>Fd and ne<Gd)and(not Ed.pop)then Ed.timeshit=Ed.timeshit and Ed.timeshit+1 or 1;sd=Hd(sd,Ed.type,Ed.gogo)if Ed.timeshit>=Ed.requiredhits then Ed.pop=true;kc.startms=ne;kc.color.a=255;rl.PlaySound(ic.PlaySong.Notes.balloonpop)end end;if(Ae==1 or Ae==2)and Kd and(ne>Kd and ne<Ld)then Jd.timeshit=Jd.timeshit and Jd.timeshit+1 or 1;sd=Nd(sd,Jd.type,Jd.gogo)end end;local function ue(Ae)local Be=xc[Ae.type]oe[Be]=0;pe[Be]=Ae;te(Be,qe)qe=not qe end;local function ve(Ae)te(Ae,qe)qe=not qe end;local function we(Ae,Be)return Ae.ms>Be.ms end;Rb(Cb,rc[1],rc[2])local xe=table.concat({'Title: ',qc.Metadata.TITLE,'\nSubtitle: ',qc.Metadata.SUBTITLE,'\nDifficulty: ',Taiko.Data.CourseName[qc.Metadata.COURSE],'\nStars: ',tostring(qc.Metadata.LEVEL),'\n\nAuto: ',tostring(wc),'\nRecording: ',tostring(ce),'\nReplaying: ',tostring(fe)})while not rl.WindowShouldClose()do rl.BeginDrawing()rl.ClearBackground(rl.RAYWHITE)rl.DrawText('Press SPACE to start',u.ScreenWidth/2,u.ScreenHeight/2,B,rl.BLACK)rl.EndDrawing()if rl.IsKeyPressed(32)then break end end;if tc then rl.SetMusicPitch(uc,zc)rl.PlayMusicStream(uc)if u.Offsets.Music<0 then rl.SeekMusicStream(uc,-u.Offsets.Music)end end;local ye=0;local ze=os.clock()while true do rl.BeginDrawing()rl.ClearBackground(rl.RAYWHITE)rl.DrawTexturePro(Cb.PlaySong.Backgrounds.Background.InfoBar[0],Cb.PlaySong.Backgrounds.Background.InfoBar.sourcerect,Cb.PlaySong.Backgrounds.Background.InfoBar.pr,Cb.PlaySong.Backgrounds.Background.InfoBar.center,0,rl.WHITE)rl.DrawTexturePro(Cb.PlaySong.Backgrounds.Background.CourseSymbol[qc.Metadata.COURSE],Cb.PlaySong.Backgrounds.Background.CourseSymbol.sourcerect,Cb.PlaySong.Backgrounds.Background.CourseSymbol.pr,Cb.PlaySong.Backgrounds.Background.CourseSymbol.center,0,rl.WHITE)rl.DrawTexturePro(Cb.PlaySong.Nameplates.base,Cb.PlaySong.Nameplates.sourcerect,Cb.PlaySong.Nameplates.pr,Cb.PlaySong.Nameplates.center,0,rl.WHITE)rl.DrawTexturePro(Cb.PlaySong.Nameplates.edge,Cb.PlaySong.Nameplates.sourcerect,Cb.PlaySong.Nameplates.pr,Cb.PlaySong.Nameplates.center,0,rl.WHITE)rl.DrawTexturePro(Cb.PlaySong.Nameplates.top,Cb.PlaySong.Nameplates.sourcerect,Cb.PlaySong.Nameplates.pr,Cb.PlaySong.Nameplates.center,0,rl.WHITE)rl.DrawTexturePro(Cb.PlaySong.Nameplates.rankbase,Cb.PlaySong.Nameplates.sourcerect,Cb.PlaySong.Nameplates.pr,Cb.PlaySong.Nameplates.center,0,rl.WHITE)rl.DrawTexturePro(Cb.PlaySong.Nameplates.rank[3],Cb.PlaySong.Nameplates.sourcerect,Cb.PlaySong.Nameplates.pr,Cb.PlaySong.Nameplates.center,0,rl.WHITE)rl.DrawTexturePro(Cb.PlaySong.Nameplates[1],Cb.PlaySong.Nameplates.sourcerect,Cb.PlaySong.Nameplates.pr,Cb.PlaySong.Nameplates.center,0,rl.WHITE)rl.DrawFPS(10,10)rl.DrawText(xe,10,40,xb,rl.BLACK)me=me+ (ye~=0 and rl.GetFrameTime()or 0)ne=me*1000;ye=ye+1;if tc then local Pe=me-u.Offsets.Music;if Pe>=0 then local Qe=Pe- (rl.GetMusicTimePlayed(uc)/zc)if vc or Qe>yb or Qe<-yb then print('RESYNC',Qe)rl.SeekMusicStream(uc,Pe*zc)vc=false end;rl.UpdateMusicStream(uc)end end;if fe and ke and ne>=ke then local Pe=ge[ke]for i=1,#Pe do local Qe=Replay.Notes[Pe[i]]te(Qe[1],Qe[2])end;le=le+1;ke=je[le]end;if Rd and ne>Rd then Pd,Qd,Rd=nil,nil,nil end;if Gd and ne>Gd then Ed,Fd,Gd=nil,nil,nil end;if Ld and ne>Ld then Jd,Kd,Ld=nil,nil,nil end;if Ac then for i=1,#kd do local Pe=kd[i]if ne>=Pe.stopstart then Pd=Sd+Pe.stopstart;stopms=Pe.stopms;Sd=Sd-Pe.stopms;Qd=Pe.stopstart;Rd=Pe.stopend;table.remove(kd,i)break end end end;if Bc then for i=1,#cd do local Pe=cd[i]if ne>=Pe.ms then if Td then local Qe=Pe.ms-Td;Kc[1]=Wd[1]+ (Vd[1]*Qe)Kc[2]=Wd[2]+ (Vd[2]*Qe)end;Td=Pe.ms;Ud=Pe.ms+Pe.jposscroll.lengthms;if Pe.jposscroll.p=='default'then Vd[1]=(vb[1]-Kc[1])/Pe.jposscroll.lengthms;Vd[2]=(vb[2]-Kc[2])/Pe.jposscroll.lengthms else Vd[1]=( (Pe.jposscroll.p and Pe.jposscroll.p[1])and Pe.jposscroll.p[1]or(Pe.jposscroll.lanep and Pe.jposscroll.lanep[1])and(Pe.jposscroll.lanep[1]*Ec)or 0)/Pe.jposscroll.lengthms;Vd[2]=( (Pe.jposscroll.p and Pe.jposscroll.p[2])and Pe.jposscroll.p[2]or(Pe.jposscroll.lanep and Pe.jposscroll.lanep[2])and(Pe.jposscroll.lanep[2]*Ec)or 0)/Pe.jposscroll.lengthms end;Wd[1]=Kc[1]Wd[2]=Kc[2]table.remove(cd,i)break end end;if Ud and ne>Ud then local Pe=Ud-Td;Kc[1]=Wd[1]+ (Vd[1]*Pe)Kc[2]=Wd[2]+ (Vd[2]*Pe)Td,Ud=nil,nil end end;if Cc then for i=1,#jd do local Pe=jd[i]if ne>=Pe.ms then local Qe=Pe.ms;local Re=Pe.bpmchangemul;Taiko.ForAll(qc.Data,function(Se,Te,Ue)Se.ms=Qe+ (Se.ms-Qe)/Re;Se.speed[1]=Se.speed[1]*Re;Se.speed[2]=Se.speed[2]*Re;Se.loadms=Wc(Se,Se.ms-Se.delay)end)table.remove(jd,i)break end end end;if Dc then for i=1,#Xd do local Pe=Xd[i]if ne>=Pe.ms then Zd=Pe;if not Pe.data then Zd=nil end;table.remove(Xd,i)break end end;if Zd and(Zd.lengthms and ne>= (Zd.ms+Zd.lengthms))then Zd=nil end end;for i=1,#Md do local Pe=Md[i]if ne>=Pe.ms then Jd=Pe;Kd=Pe.ms;Ld=Pe.ms+Pe.lengthms;table.remove(Md,i)break end end;if qd then while true do if qd and(qd.loadms<ne+Sd)then nd[#nd+1]=qd;if qd.endnote then nd[#nd+1]=qd.endnote end;qd=qd.nextnote;if qd then if qd.startnote then qd=qd.nextnote end;if qd and qd.branch then qd=qd.branch.paths[rd][1]end end else break end end else if ne>md then break end end;rl.DrawTexturePro(Cb.PlaySong.Backgrounds.Frame[1],Cb.PlaySong.Backgrounds.Frame.sourcerect,Cb.PlaySong.Backgrounds.Frame.pr,Cb.PlaySong.Backgrounds.Frame.center,0,rl.WHITE)rl.DrawTexturePro(Cb.PlaySong.Gauges.Meter.base,Cb.PlaySong.Gauges.Meter.sourcerect,Cb.PlaySong.Gauges.Meter.pr,Cb.PlaySong.Gauges.Meter.center,0,rl.WHITE)local Ae=math.floor(50 *zd)Ae=ClipN(Ae,0,50)local Be=14 *Ae-1;if Be>0 then Cb.PlaySong.Gauges.Meter.sourcerect2.width=Be/1280 * (u.ScreenWidth/Qb[1])Cb.PlaySong.Gauges.Meter.pr2.width=Be/1280 *u.ScreenWidth;rl.DrawTexturePro(Cb.PlaySong.Gauges.Meter.full,Cb.PlaySong.Gauges.Meter.sourcerect2,Cb.PlaySong.Gauges.Meter.pr2,Cb.PlaySong.Gauges.Meter.center,0,rl.WHITE)end;if Bd then local Pe=ne-mc.startms;local Qe=math.floor(Pe/Bb)% (mc.framen-1)local Re=mc.anim[Qe]rl.DrawTexturePro(Re,Cb.PlaySong.Gauges.Meter.rainbow.sourcerect,Cb.PlaySong.Gauges.Meter.rainbow.pr,Cb.PlaySong.Gauges.Meter.rainbow.center,0,rl.WHITE)elseif Ad then lc.startms=lc.startms or ne;local Pe=ne-lc.startms;local Qe=math.floor(Pe/Bb)local Re=lc.anim[Qe]if Re then lc.color.a=255 *Re else lc.startms=lc.startms+lc.framen* (1000 /Ab)end;local Se=39;local Te=14 *Se-1;Cb.PlaySong.Gauges.Meter.sourcerect2.width=Te/1280 * (u.ScreenWidth/Qb[1])Cb.PlaySong.Gauges.Meter.pr2.width=Te/1280 *u.ScreenWidth;rl.DrawTexturePro(Cb.PlaySong.Gauges.Meter.clear,Cb.PlaySong.Gauges.Meter.sourcerect2,Cb.PlaySong.Gauges.Meter.pr2,Cb.PlaySong.Gauges.Meter.center,0,lc.color)end;rl.DrawTexturePro(Cb.PlaySong.Gauges.Clear[Ad],Cb.PlaySong.Gauges.Clear.sourcerect,Cb.PlaySong.Gauges.Clear.pr,Cb.PlaySong.Gauges.Clear.center,0,rl.WHITE)rl.DrawTexturePro(Cb.PlaySong.Lanes.Lane.default,Cb.PlaySong.Lanes.sourcerect,Cb.PlaySong.Lanes.pr,Cb.PlaySong.Lanes.center,0,rl.WHITE)rl.DrawTexturePro(Cb.PlaySong.Lanes.Lane.sub,Cb.PlaySong.Lanes.ssourcerect,Cb.PlaySong.Lanes.spr,Cb.PlaySong.Lanes.scenter,0,rl.WHITE)rl.DrawTexturePro(Cb.PlaySong.Backgrounds.Taiko.base,Cb.PlaySong.Backgrounds.Taiko.sourcerect,Cb.PlaySong.Backgrounds.Taiko.pr,Cb.PlaySong.Backgrounds.Taiko.center,0,rl.WHITE)for i=1,2 do local Pe=pc[i]for i2=1,2 do local Qe=Pe[i2]if Qe.startms then local Re=ne-Qe.startms;local Se=math.floor(Re/Bb)local Te=pc.anim[Se]if Te then Qe.color.a=255 *Te;if Te>0 then Pe.pr.x=Pe.opr.x*Qb[1]Pe.pr.y=Pe.opr.y*Qb[2]Pe.pr.width=Pe.opr.width*Qb[1]Pe.pr.height=Pe.opr.height*Qb[2]rl.DrawTexturePro(Cb.PlaySong.Backgrounds.Taiko[i2],Pe.sourcerect,Pe.pr,Pe.center,0,rl.WHITE)end else pc.startms=nil end end end end;for i=1,2 do local Pe=nc[i]if Pe.startms then local Qe=ne-Pe.startms;local Re=math.floor(Qe/Bb)local Se=nc.anim[Re]if Se then Pe.color.a=255 *Se;if Se>0 then rl.DrawTexturePro(Cb.PlaySong.Lanes.Lane[i],Cb.PlaySong.Lanes.sourcerect,Cb.PlaySong.Lanes.pr,Cb.PlaySong.Lanes.center,0,rl.WHITE)end else Pe.startms=nil end end end;rl.DrawTexturePro(Cb.PlaySong.Backgrounds.ComboText[0],Cb.PlaySong.Backgrounds.ComboText.sourcerect,Cb.PlaySong.Backgrounds.ComboText.pr,Cb.PlaySong.Backgrounds.ComboText.center,0,rl.WHITE)if wd>=10 then local Pe,Qe=40 /1280 * (u.ScreenWidth/Qb[1]),48 /720 * (u.ScreenHeight/Qb[2])local Re,Se=Pe*Qb[1],Qe*Qb[2]local Te=tostring(wd)local Ue=wd<50 and 0 or wd<100 and 1 or 2;local Ve=fb(Te,Pe,Qe,Re,Se,Qb)gb(Cb.PlaySong.Fonts.Combo[Ue],Te,250 /1280 *u.ScreenWidth- (Ve/2),220 /720 *u.ScreenHeight,Pe,Qe,Re,Se,Qb)end;local Ce,De=26 /1280 * (u.ScreenWidth/Qb[1]),34 /720 * (u.ScreenHeight/Qb[2])local Ee,Fe=Ce*Qb[1],De*Qb[2]local Ge=tostring(sd)local He=fb(Ge,Ce,De,Ee,Fe,Qb)gb(Cb.PlaySong.Fonts.Score[0],Ge,160 /1280 *u.ScreenWidth-He,194 /720 *u.ScreenHeight,Ce,De,Ee,Fe,Qb)if Zd then Zd.p2.x=Zd.p.x*Qb[1]Zd.p2.y=Zd.p.y*Qb[2]rl.DrawTextCodepoints(Zd.font,Zd.datac,#Zd.data,Zd.p2,Zd.size*Qb[2],Zd.spacing,rl.BLACK)end;if Td and ne>=Td then Kc[1]=Wd[1]+ (Vd[1]* (ne-Td))Kc[2]=Wd[2]+ (Vd[2]* (ne-Td))end;local Ie=Kc[1]-vb[1]local Je=Kc[2]-vb[2]wb[1]=Oc[1]+Ie;wb[2]=Oc[2]+Je;wb[3]=Oc[3]+Ie;wb[4]=Oc[4]+Je;Pb.x=(Kc[1]*Nb+rb)*Qb[1]Pb.y=(Kc[2]*Ob+sb)*Qb[2]Pb.width=Hb*Qb[1]Pb.height=Ib*Qb[2]rl.DrawTexturePro(Cb.PlaySong.Notes.target,Jb,Pb,Kb,0,rl.WHITE)local Ke=0;for i=1,#re.notes do local Pe=i+Ke;local Qe=re.notes[Pe]local Re=re.startms[Pe]local Se=ne-Re;local Te=math.floor(Se/Bb)local Ue=re.currenttarget;local Ve=re.anim[Ue[1][Pe]][Ue[2][Pe]][Te]if Ve then if Ve[1]then Qe.pr.width=Hb*Qb[1]Qe.pr.height=Ib*Qb[2]Qe.tcenter.x=Qe.tcentero.x*Qb[1]Qe.tcenter.y=Qe.tcentero.y*Qb[2]Qe.pr.x=Ve[1]*Qb[1]Qe.pr.y=Ve[2]*Qb[2]rl.DrawTexturePro(Cb.PlaySong.Notes[Qe.type],Jb,Qe.pr,Qe.tcenter,Qe.rotationr,rl.WHITE)else end else table.remove(re.notes,Pe)table.remove(re.startms,Pe)table.remove(re.currenttarget[1],Pe)table.remove(re.currenttarget[2],Pe)Ke=Ke-1 end end;oe={}pe={}od={barline={},drumroll={},balloon={},notes={}}local Le=ne-u.Offsets.Timing;local Me=0;for i=1,#nd do local Pe=i+Me;local Qe=nd[Pe]if Qe then if not(Qe.hit)and Qe.data=='note'then local Te=math.abs(Le-Qe.ms)if(Qe.type==1 or Qe.type==3)and(not oe[1]or Te<oe[1])then oe[1]=Te;pe[1]=Qe elseif(Qe.type==2 or Qe.type==4)and(not oe[2]or Te<oe[2])then oe[2]=Te;pe[2]=Qe end end;local Re,Se=Vc(Qe,Pd or(ne+Sd))Qe.p[1]=Re*Nb;Qe.p[2]=Se*Ob;if ne>Qe.ms then xd=Qe.gogo;if Qe.type==7 then if Ed then Qe.hit=false;if Ed.n==Qe.n then Qe.p[1]=Kc[1]*Nb;Qe.p[2]=Kc[2]*Ob;if not Ed.setdelay then Ed.delay=Ed.delay-Ed.lengthms;Ed.setdelay=true end else end end;Ed=Qe;Fd=Qe.ms;Gd=Qe.ms+Qe.lengthms end end;Qe.pr.x=(Qe.p[1]+rb)*Qb[1]Qe.pr.y=(Qe.p[2]+sb)*Qb[2]if wc then if not Qe.hit and xc[Qe.type]and Le>=Qe.ms then ue(Qe)end end;if(Qe.hit and not(Ac and Qe.stopstart and not(ne>Qe.stopstart)))or(ne>Qe.ms and Sc(Qe.p[1],Qe.p[2],wb[1],wb[2],wb[3],wb[4])==false)and( (not Qe.endnote)or(Qe.endnote.done))and( (not Qe.startnote)or(Uc(Qe.p[1]<Qe.startnote.p[1]and Qe.p[1]or Qe.startnote.p[2],Qe.p[2]<Qe.startnote.p[2]and Qe.p[2]or Qe.startnote.p[2],Qe.p[1]<Qe.startnote.p[1]and Qe.startnote.p[1]or Qe.p[2],Qe.p[2]<Qe.startnote.p[2]and Qe.startnote.p[2]or Qe.p[2],wb[1],wb[2],wb[3],wb[4])))then Qe.done=true;table.remove(nd,Pe)Me=Me-1 else if Qe.data=='event'then if Qe.event=='barline'then od.barline[#od.barline+1]=Qe end else if Qe.type==8 then od.drumroll[#od.drumroll+1]=Qe elseif Qe.type==7 then od.balloon[#od.balloon+1]=Qe else od.notes[#od.notes+1]=Qe end end end end end;if wc then local Pe=oe[1]local Qe=oe[2]local Re=(Pe and Qe)and( (Pe<Qe)and 1 or 2)or(Pe and 1 or 2)local Se=oe[Re]local Te=pe[Re]if not Se or(Se and Se> (bd.bad* ( ( (Te.type==3 or Te.type==4)and Taiko.Data.BigLeniency)or 1)))then if Fd and(ne>Fd and ne<Gd)and not Ed.pop then ve(1)elseif Kd and(ne>Kd and ne<Ld)then ve(1)end end end;for Pe,Qe in pairs(u.Controls.PlaySong.Hit)do if rl.IsKeyPressed(Pe)then te(Qe[1],Qe[2])end end;pd=od.barline;table.sort(od.drumroll,we)table.sort(od.notes,we)table.sort(od.balloon,we)for i=1,#od.drumroll do pd[#pd+1]=od.drumroll[i]end;for i=1,#od.notes do pd[#pd+1]=od.notes[i]end;for i=1,#od.balloon do pd[#pd+1]=od.balloon[i]end;Pb.width=Pb.width*2;Pb.height=Pb.height*2;if Od.statusanim then local Pe=ne-Od.startms;local Qe=math.floor(Pe/Bb)local Re=Od.statusanim[Qe]if Re then rl.DrawTexturePro(Re,Cb.PlaySong.Effects.Note.sourcerect,Pb,Cb.PlaySong.Effects.Note.center,0,cc)else Od.statusanim=nil end end;for i=1,#pd do local Pe=pd[i]if Pe then if not Pe.hit then local Qe=( (Pe.type==3 or Pe.type==4)and Taiko.Data.BigLeniency)or 1;if(not Pe.brokecombo)and(Pe.type==1 or Pe.type==2 or Pe.type==3 or Pe.type==4)and ne-Pe.ms> (bd.bad*Qe)then wd=0;Pe.brokecombo=true end;if Pe.data=='event'then if Pe.event=='barline'then Pe.pr.width=Wb*Qb[1]Pe.pr.height=Xb*Qb[2]Pe.tcenter.x=Pe.tcentero.x*Qb[1]Pe.tcenter.y=Pe.tcentero.y*Qb[2]rl.DrawTexturePro(Cb.PlaySong.Barlines[Pe.type],Yb,Pe.pr,Pe.tcenter,Pe.rotationr,rl.WHITE)end elseif Pe.data=='note'then Pe.pr.width=Hb*Qb[1]Pe.pr.height=Ib*Qb[2]Pe.tcenter.x=Pe.tcentero.x*Qb[1]Pe.tcenter.y=Pe.tcentero.y*Qb[2]if Pe.senote then Pe.senotepr.x=Pe.pr.x;Pe.senotepr.y=Pe.pr.y+ (Cb.PlaySong.SENotes.offsety)*Qb[2]Pe.senotepr.width=Pe.osenotepr.width*Qb[1]Pe.senotepr.height=Pe.osenotepr.height*Qb[2]rl.DrawTexturePro(Cb.PlaySong.SENotes[Pe.senote],Cb.PlaySong.SENotes.sourcerect,Pe.senotepr,Cb.PlaySong.SENotes.center,0,rl.WHITE)end;if Cb.PlaySong.Notes[Pe.type]then rl.DrawTexturePro(Cb.PlaySong.Notes[Pe.type],Jb,Pe.pr,Pe.tcenter,Pe.rotationr,rl.WHITE)elseif Pe.type==8 then local Re=Pe.startnote;if Re.type==5 or Re.type==6 then local Se=Ic*Pe.radius;local Te,Ue=Re.p[1],Pe.p[1]local Ve,We=Re.p[2],Pe.p[2]if Pc(Ue-Te)~=0 or Pc(We-Ve)~=0 then Pe.rotationr=Qc(0 -math.deg(math.atan2((We-Ve)*Ob/Qb[1],(Ue-Te)*Nb/Qb[2])))local Xe=math.sqrt((Ue-Te)^2 + (We-Ve)^2)local Ye=(Ue-Te)/Xe;local Ze=(We-Ve)/Xe;local af=Hb*Ye;local bf=Ib*Ze;local cf=math.floor(Xe/Hb)local df=Xe- (cf*Hb)Cb.PlaySong.Notes.drumrollpr.width=Hb*Qb[1]Cb.PlaySong.Notes.drumrollpr.height=Ib*Qb[2]local ef=Te+rb+ (Hb/2 *Ye)local ff=Ve+sb+ (Ib/2 *Ze)local gf=4;local hf=-0.5;for i=1,cf do Cb.PlaySong.Notes.drumrollpr.x=ef*Qb[1]Cb.PlaySong.Notes.drumrollpr.y=ff*Qb[2]rl.DrawTexturePro(Cb.PlaySong.Notes[Re.recttype],Jb,Cb.PlaySong.Notes.drumrollpr,Pe.tcenter,Pe.rotationr,rl.WHITE)for i2=0,gf-1 do if Re.senote then Re.senotepr.x=(ef+ (af* (i2 /gf+hf)))*Qb[1]Re.senotepr.y=(ff+ (bf* (i2 /gf+hf))+Cb.PlaySong.SENotes.offsety)*Qb[2]rl.DrawTexturePro(Cb.PlaySong.SENotes[9],Cb.PlaySong.SENotes.sourcerect,Re.senotepr,Cb.PlaySong.SENotes.center,0,rl.WHITE)end end;ef=ef+af;ff=ff+bf end;Cb.PlaySong.Notes.drumrollpr.width=df*Qb[1]Cb.PlaySong.Notes.drumrollpr.x=ef*Qb[1]Cb.PlaySong.Notes.drumrollpr.y=ff*Qb[2]Cb.PlaySong.Notes.drumrollpr2.width=df;Cb.PlaySong.Notes.drumrollpr2.height=Ib;rl.DrawTexturePro(Cb.PlaySong.Notes[Re.recttype],Cb.PlaySong.Notes.drumrollpr2,Cb.PlaySong.Notes.drumrollpr,Pe.tcenter,Pe.rotationr,rl.WHITE)local jf=math.floor(Cb.PlaySong.Notes.drumrollpr.width/Hb)hf=hf+17 /136;for i2=0,jf-1 do if Re.senote then Re.senotepr.x=(ef+ (af* (i2 /gf+hf)))*Qb[1]Re.senotepr.y=(ff+ (bf* (i2 /gf+hf))+Cb.PlaySong.SENotes.offsety)*Qb[2]rl.DrawTexturePro(Cb.PlaySong.SENotes[9],Cb.PlaySong.SENotes.sourcerect,Re.senotepr,Cb.PlaySong.SENotes.center,0,rl.WHITE)end end;Re.senotepr.x=(ef+ (af* (jf/gf+hf)))*Qb[1]Re.senotepr.y=(ff+ (bf* (jf/gf+hf))+Cb.PlaySong.SENotes.offsety)*Qb[2]rl.DrawTexturePro(Cb.PlaySong.SENotes[10],Cb.PlaySong.SENotes.sourcerect,Re.senotepr,Cb.PlaySong.SENotes.center,0,rl.WHITE)ef=ef+df*Ye;ff=ff+df*Ze;Pe.pr.x=ef*Qb[1]Pe.pr.y=ff*Qb[2]rl.DrawTexturePro(Cb.PlaySong.Notes[Re.endtype],Jb,Pe.pr,Pe.tcenter,Pe.rotationr,rl.WHITE)end;rl.DrawTexturePro(Cb.PlaySong.Notes[Re.notetype],Jb,Re.pr,Re.tcenter,Re.rotationr,rl.WHITE)elseif Re.type==7 then if Re.timeshit==nil then rl.DrawTexturePro(Cb.PlaySong.Notes.balloon,Jb,Re.pr,Re.tcenter,Re.rotationr,rl.WHITE)Cb.PlaySong.Balloons.pr2.x=Re.pr.x+Re.pr.width;Cb.PlaySong.Balloons.pr2.y=Re.pr.y;rl.DrawTexturePro(Cb.PlaySong.Notes.balloonend,Jb,Cb.PlaySong.Balloons.pr2,Re.tcenter,Re.rotationr,rl.WHITE)else local Se=Re.requiredhits-Re.timeshit;local Te=(kc.framen-1)-math.ceil(Se/ (Re.requiredhits/ (kc.framen-1)))Te=Te<0 and 0 or Te;if Te==5 then local Ue=ne-kc.startms;local Ve=math.floor(Ue/Bb)local We=kc.anim[Ve]if We then kc.color.a=255 *We;if We>0 then rl.DrawTexturePro(Cb.PlaySong.Balloons.Anim[Te],Cb.PlaySong.Balloons.sourcerect,Cb.PlaySong.Balloons.pr,Cb.PlaySong.Balloons.center,Re.rotationr,kc.color)end else Re.hit=true end else Cb.PlaySong.Balloons.pr.x=Re.pr.x+Re.pr.width;Cb.PlaySong.Balloons.pr.y=Re.pr.y;rl.DrawTexturePro(Cb.PlaySong.Balloons.Anim[Te],Cb.PlaySong.Balloons.sourcerect,Cb.PlaySong.Balloons.pr,Cb.PlaySong.Balloons.center,Re.rotationr,rl.WHITE)end end end end else error('Invalid note.data')end end end end;if Od.explosionanim then local Pe=ne-Od.startms;local Qe=math.floor(Pe/Bb)local Re=Od.explosionanim[Qe]if Re then rl.DrawTexturePro(Re,Cb.PlaySong.Effects.Note.sourcerect,Pb,Cb.PlaySong.Effects.Note.center,0,cc)else Od.explosionanim=nil end end;if Od.explosionbiganim then local Pe=ne-Od.startms;local Qe=math.floor(Pe/Bb)local Re=Od.explosionbiganim[Qe]if Re then rl.DrawTexturePro(Re,Cb.PlaySong.Effects.Note.sourcerect,Pb,Cb.PlaySong.Effects.Note.center,0,cc)else Od.explosionbiganim=nil end end;local Ne=0;for i=1,#oc.startms do local Pe=i+Ne;local Qe=ne-oc.startms[Pe]local Re=math.floor(Qe/Bb)local Se=oc.animp[Re]if Se then local Te=oc.animt[Re]local Ue=oc.judge[Pe]oc.color.a=255 *Te;Cb.PlaySong.Judges.pr.x=Pb.x;Cb.PlaySong.Judges.pr.y=Pb.y- (Se/720 *u.ScreenHeight)rl.DrawTexturePro(Cb.PlaySong.Judges[Ue],Cb.PlaySong.Judges.sourcerect,Cb.PlaySong.Judges.pr,Cb.PlaySong.Judges.center,0,oc.color)else table.remove(oc.startms,Pe)table.remove(oc.judge,Pe)Ne=Ne-1 end end;rl.EndDrawing()if rl.WindowShouldClose()then rl.CloseWindow()error()break end;if rl.IsWindowResized()and(not u.Fullscreen)then local Pe,Qe=rl.GetScreenWidth(),rl.GetScreenHeight()if Pe~=u.ScreenWidth or Qe~=u.ScreenHeight then Rb(Cb,Pe/u.ScreenWidth,Qe/u.ScreenHeight)u.ScreenWidth,u.ScreenHeight=Pe,Qe end end;if lb(u.Controls.PlaySong.Fullscreen)then local Pe,Qe=nb()Rb(Cb,Pe,Qe)end;if lb(u.Controls.PlaySong.Screenshot)then local Pe=rl.LoadImageFromScreen()rl.ExportImage(Pe,hb(u.Paths.Screenshots,u.Formats.Screenshot))rl.UnloadImage(Pe)end;local Oe=lb(u.Controls.PlaySong.Command.Init)if lb(u.Controls.PlaySong.Pause.Init)or Oe then local Pe=os.clock()rl.EndDrawing()local Qe=rl.LoadImageFromScreen()local Re=rl.LoadTextureFromImage(Qe)local Se=1;local Te={'Back to game','Retry','Quit'}local Ue,Ve,We,Xe,Ye,Ze,af,bf,cf,df,ef,ff,gf,hf,jf;if Oe then Ue={'Console','\nS: ',tostring(me),'\nMs: ',tostring(ne),'\nGogo: ',tostring(xd),'\nLoaded: ',tostring(#pd),'\nFramen: ',ye,'\nnextnote.loadms: ',tostring(qd and qd.loadms),'\nnextnote.n: ',tostring(qd and qd.n),'\nballoonstart: ',tostring(Fd),'\nballoonend: ',tostring(Gd),'\n\nMemory usage (mb): ',collectgarbage('count')/1000,'\nFinished (%): ',ne/ (md)*100,'\n\n'}strtext=table.concat(Ue)Ve,We=0,360 /720 *u.ScreenHeight;Xe=1;Ye=false;Ze={}af=''bf={}df=''cf='Console: 'ef=rl.ImageFromImage(Qe,rl.new('Rectangle',0,0,1,1))rl.ImageDrawPixel(ef,0,0,rl.new('Color',0,0,0,255 /2))ff=rl.LoadTextureFromImage(ef)rl.UnloadImage(ef)jf=rl.new('Rectangle',0,0,1,1)gf=rl.new('Rectangle',0,0,1,1)hf=rl.new('Vector2',0,0)end;rl.UnloadImage(Qe)while true do rl.BeginDrawing()rl.ClearBackground(rl.RAYWHITE)rl.DrawTexture(Re,0,0,rl.WHITE)if Oe then local kf=strtext..df..cf..af;gf.x,gf.y=Ve,We;gf.width,gf.height=z(kf,xb)rl.DrawTexturePro(ff,jf,gf,hf,0,rl.WHITE)rl.DrawText(kf,Ve,We,xb,rl.RAYWHITE)end;for i=1,#Te do rl.DrawText((i==Se and'> 'or'')..Te[i],u.ScreenWidth/2,u.ScreenHeight/2 + ( (i- (#Te+1)/2)*B),B,rl.BLACK)end;rl.EndDrawing()if Oe then if lb(u.Controls.PlaySong.Command.Move.Toggle)then Ye=not Ye end;if Ye then if mb(u.Controls.PlaySong.Command.Move.Left)then Ve=Ve-Xe end;if mb(u.Controls.PlaySong.Command.Move.Right)then Ve=Ve+Xe end;if mb(u.Controls.PlaySong.Command.Move.Up)then We=We-Xe end;if mb(u.Controls.PlaySong.Command.Move.Down)then We=We+Xe end end;while true do local kf=rl.GetCharPressed()if kf==0 then break else Ze[#Ze+1]=kf;af=l(Ze)end end;if rl.IsKeyPressed(rl.KEY_BACKSPACE)then Ze[#Ze]=nil;af=l(Ze)end;if rl.IsKeyPressed(rl.KEY_ENTER)then end end;if lb(u.Controls.PlaySong.Pause.Escape)then break end;if lb(u.Controls.PlaySong.Pause.U)then Se=Se-1 end;if lb(u.Controls.PlaySong.Pause.D)then Se=Se+1 end;Se=ClipN(Se,1,#Te)if lb(u.Controls.PlaySong.Pause.Select)then if Se==1 then break elseif Se==2 then Sb()return false elseif Se==3 then Sb()return nil else end end;if rl.WindowShouldClose()then break end end;rl.EndDrawing()rl.UnloadTexture(Re)vc=true;ze=ze+ (os.clock()-Pe)end end;if ce then local Ae={}for i=1,2 do Ae[i]=de[i][false]Ae[i+2]=de[i][false]end;de=Ae;de=Replay.Save(Replay.TranscodeRawKey(de),{'\ntitle ',qc.Metadata.TITLE,'\nsubtitle ','','\ndifficulty ',Taiko.Data.CourseName[qc.Metadata.COURSE],'\nstars ',tostring(qc.Metadata.LEVEL),'\ntime ',tostring(os.time())})Replay.Write(ee,de)end;Sb()return true,sc end;return Taiko.SongSelect()end;Taiko.Game()function Taiko.SongSelectOld(s,t,u)local v={}local w,x=10,10;local y,z,A,B=-w,w,-x,x;local C=true;local D=1;local E=1;local F=4;local G=5;local H=5;local I=2;local J='V'local K='>'local L=10;local M=nil;local N='>'local O='>'local P=2;local Q=true;local R='_Original_'local S=u or{}local T=false;local U={[2]={'Normal','Auto'},[3]={'Normal','2x Speed','3x Speed','4x Speed','0.25x Speed','0.5x Speed','0.75x Speed'},[4]={'Normal','2x Speed','3x Speed','4x Speed','0.25x Speed','0.5x Speed','0.75x Speed'},[5]={'Normal','Reverse','Invisible','Messy'}}local V={4,1,1,1,1,1}local W={nil}for sb,tb in pairs(U)do W[sb]={1,#tb,tb}end;local X={[1]=nil,[2]={function(sb)return sb,'type',sb.type and(Taiko.Data.Notes.ReverseNotes[sb.type]or sb.type)or sb.type end,function(sb)return sb,'type'end},[3]={function(sb)return sb,'scrollx',10000 end,function(sb)return sb,'scrollx'end},[4]={function(sb)return sb,'type',sb.type and(sb.type==1 and math.random(1,2)or sb.type==2 and math.random(1,2)or sb.type==3 and math.random(3,4)or sb.type==4 and math.random(3,4)or sb.type)end,function(sb)return sb,'type'end}}local Y={window=curses.initscr()}curses.keypad(Y,true)curses.echo(false)curses.raw(true)curses.nl(false)curses.cbreak(true)curses.nodelay(Y,true)curses.getch(Y)curses.nodelay(Y,false)local Z,ab=curses.cols(),curses.lines()M=M or Z-2;local bb={Escape={['\27']=true,ALT_ESC=true},Scroll={L={KEY_LEFT=true,KEY_SLEFT=true,CTL_LEFT=true,KEY_B1=true,ALT_LEFT=true,KEY_SHIFT_L=true,KEY_UP=true,KEY_A2=true},R={KEY_RIGHT=true,KEY_SRIGHT=true,CTL_RIGHT=true,KEY_B3=true,ALT_RIGHT=true,KEY_SHIFT_R=true,KEY_DOWN=true,KEY_C2=true}},Select={Init={KEY_ENTER=true,PADENTER=true,CTL_PADENTER=true,ALT_PADENTER=true,CTL_PADCENTER=true,ALT_ENTER=true,CTL_ENTER=true,SHF_PADENTER=true,['\n']=true,['\r']=true},Select={KEY_ENTER=true,PADENTER=true,CTL_PADENTER=true,ALT_PADENTER=true,CTL_PADCENTER=true,ALT_ENTER=true,CTL_ENTER=true,SHF_PADENTER=true,['\n']=true,['\r']=true},Escape={['\27']=true,ALT_ESC=true},L={KEY_LEFT=true,KEY_SLEFT=true,CTL_LEFT=true,KEY_B1=true,ALT_LEFT=true,KEY_SHIFT_L=true},R={KEY_RIGHT=true,KEY_SRIGHT=true,CTL_RIGHT=true,KEY_B3=true,ALT_RIGHT=true,KEY_SHIFT_R=true},U={KEY_UP=true,KEY_A2=true},D={KEY_DOWN=true,KEY_C2=true},Play={Hit={['4']=2,['v']=1,['n']=1,['8']=2},Escape={['\27']=true,ALT_ESC=true},L={KEY_LEFT=true,KEY_SLEFT=true,CTL_LEFT=true,KEY_B1=true,ALT_LEFT=true,KEY_SHIFT_L=true,KEY_UP=true,KEY_DOWN=true},R={KEY_RIGHT=true,KEY_SRIGHT=true,CTL_RIGHT=true,KEY_B3=true,ALT_RIGHT=true,KEY_SHIFT_R=true,KEY_DOWN=true,KEY_C2=true},Select={KEY_ENTER=true,PADENTER=true,CTL_PADENTER=true,ALT_PADENTER=true,CTL_PADCENTER=true,ALT_ENTER=true,CTL_ENTER=true,SHF_PADENTER=true,['\n']=true,['\r']=true}}},Search={Init={ALT_F=true,f=true,F=true},Backspace={['\8']=true,KEY_BACKSPACE=true,ALT_BKSP,CTL_BKSP},FirstResult={KEY_ENTER=true,PADENTER=true,CTL_PADENTER=true,ALT_PADENTER=true,CTL_PADCENTER=true,ALT_ENTER=true,CTL_ENTER=true,SHF_PADENTER=true,['\n']=true,['\r']=true},Select={KEY_RIGHT=true,KEY_SRIGHT=true,CTL_RIGHT=true,KEY_B3=true,ALT_RIGHT=true,KEY_SHIFT_R=true},Up={KEY_A2=true,KEY_UP=true},Down={KEY_C2=true,KEY_DOWN=true},Escape={['\27']=true,ALT_ESC=true}},Add={Init={ALT_N=true,n=true,N=true},Backspace={['\8']=true,KEY_BACKSPACE=true,ALT_BKSP,CTL_BKSP},Select={KEY_ENTER=true,PADENTER=true,CTL_PADENTER=true,ALT_PADENTER=true,CTL_PADCENTER=true,ALT_ENTER=true,CTL_ENTER=true,SHF_PADENTER=true,['\n']=true,['\r']=true}},StandardInput={Backspace={['\8']=true,KEY_BACKSPACE=true,ALT_BKSP,CTL_BKSP},Escape={KEY_ENTER=true,PADENTER=true,CTL_PADENTER=true,ALT_PADENTER=true,CTL_PADCENTER=true,ALT_ENTER=true,CTL_ENTER=true,SHF_PADENTER=true,['\n']=true,['\r']=true},L={KEY_LEFT=true,KEY_SLEFT=true,CTL_LEFT=true,KEY_B1=true,ALT_LEFT=true,KEY_SHIFT_L=true,KEY_UP=true,KEY_DOWN=true},R={KEY_RIGHT=true,KEY_SRIGHT=true,CTL_RIGHT=true,KEY_B3=true,ALT_RIGHT=true,KEY_SHIFT_R=true,KEY_DOWN=true,KEY_C2=true}},Reload={Init={r=true}},ReloadAll={Init={R=true}},Rename={Init={KEY_F2=true}}}local cb={ClearScreen=function()io.write("\27[2J")end,SetCursor=function(sb,tb)io.write(string.format("\27[%d;%dH",tb,sb))end,ClearLine=function()io.write("\27[2K")end,CursorLeft=function(sb)io.write(string.format("\27[%dD",sb))end,CursorRight=function(sb)io.write(string.format("\27[%dC",sb))end,SaveCursor=function()io.write("\27[s")end,RestoreCursor=function()io.write("\27[u")end}local function db(sb)return sb..string.rep(' ',M-#sb)end;local function eb()local sb=curses.getch(Y)local tb=curses.getkeyname(sb)return sb,tb end;local function fb()local sb=''local tb=0;local ub=tb;while true do local vb,wb=eb()if bb.StandardInput.Backspace[wb]then sb=string.sub(sb,1,tb-1)..string.sub(sb,tb+1,-1)tb=tb-1 elseif bb.StandardInput.Escape[wb]then io.write('\n')return sb elseif bb.StandardInput.L[wb]then tb=tb-1 elseif bb.StandardInput.R[wb]then tb=tb+1 else sb=string.sub(sb,1,tb)..wb..string.sub(sb,tb+1,-1)tb=tb+1 end;tb=ClipN(tb,0,#sb)local xb=tb-ub;if xb<0 then cb.CursorLeft(-xb)elseif xb>0 then cb.CursorRight(xb)end;cb.SaveCursor()cb.ClearLine()io.write('\r')io.write(sb)cb.RestoreCursor()ub=tb end end;local function gb(sb)return sb>=32 and sb<=126 end;local function hb(sb,tb,ub,vb)return(sb and(tb..string.sub(ub,#tb+1,-1))or ub)..vb end;local function ib(sb,tb,ub)return sb>ub and tb or sb<tb and ub or sb end;local jb={[0]='No',[1]='Yes'}local function kb(sb)return sb and jb[1]or jb[0]end;local function lb(sb)return sb*100 ..'%'end;local function mb(sb)return MsToS(sb)..'s'end;local function nb(sb)return mb(SToMs(sb))end;local function ob(sb)return tonumber(sb)and tonumber(sb)or 0 end;local function pb(sb,tb,ub)sb[R..tb]=sb[tb]sb[tb]=ub end;local function qb(sb,tb)sb[tb]=sb[R..tb]end;local rb={}cb.ClearScreen()while true do v={}if C then v[y]={}for i=D-G,D+G do local wb=nil;if i<1 then wb=#s+i elseif i>#s then wb=i-#s else wb=i end;local xb=s[wb]if xb then v[0]=v[0]or{}v[0][(i-D)*H]=xb end end;local ub={}local vb=string.rep(' ',I)for y=A,B do ub[#ub+1]=hb(y==0,K,vb,'')ub[#ub+1]=db(v[0]and v[0][y]or'')ub[#ub+1]='\n'end;cb.SetCursor(1,1)print(table.concat(ub))else v[0]={}v[0][A]=J;for i=D-G,D+G do local vb=nil;if i<1 then vb=#s+i elseif i>#s then vb=i-#s else vb=i end;local wb=s[vb]if wb then local xb=(i-D)*H;v[xb]=v[xb]or{}local yb=A+I;for i2=1,#wb do v[xb][yb]=string.sub(wb,i2,i2)yb=yb+1 end end end;local ub={}for y=A,B do for x=y,z do if v[x]and v[x][y]then local vb=v[x][y]if gb(string.byte(vb))then ub[#ub+1]=vb else ub[#ub+1]=' 'end else ub[#ub+1]=' 'end end;ub[#ub+1]='\n'end;cb.SetCursor(1,1)print(table.concat(ub))end;local sb,tb=eb()if bb.Scroll.L[tb]then D=D-1 elseif bb.Scroll.R[tb]then D=D+1 elseif bb.Select.Init[tb]then local ub;if Q then if rb[D]then ub=rb[D]else ub=Taiko.ParseTJA(t[D])rb[D]=ub end else ub=Taiko.ParseTJA(t[D])end;local vb={}for zb,Ab in pairs(ub)do vb[#vb+1]={zb,Ab.Metadata.COURSE}end;table.sort(vb,function(zb,Ab)return zb[2]<Ab[2]end)min=1;max=#vb;W[1]={min,max,vb}DifficultyMap=vb;V[1]=ClipN(V[1],min,max)local wb=string.rep(' ',P)cb.ClearScreen()cb.SetCursor(1,1)local xb=nil;local yb=E;while true do E=ClipN(E,1,5)if E~=yb then F=V[E]yb=E end;local zb=W[E]min,max=zb[1],zb[2]F=ib(F,min,max)V[E]=F;cb.SetCursor(1,1)local Ab=DifficultyMap[V[1]][2]xb=Taiko.GetDifficulty(ub,Ab)local Bb=xb.Metadata;local Cb=Taiko.Analyze(xb)local Db={{'',Bb.TITLE},{'\t',Bb.SUBTITLE},{'',''},{'','Select Options:'},{hb(E==1,O,wb,'Difficulty: '),Taiko.Data.CourseName[Bb.COURSE]},{hb(E==2,O,wb,'Mode: '),U[2][V[2]]},{hb(E==3,O,wb,'Note Speed: '),U[3][V[3]]},{hb(E==4,O,wb,'Song Speed: '),U[4][V[4]]},{hb(E==5,O,wb,'Modifiers: '),U[5][V[5]]},{'',''},{'Difficulty: ',Taiko.Data.CourseName[Bb.COURSE]},{'Stars: ',Bb.LEVEL},{'Diverge Notes: ',kb(Bb.DIVERGENOTES)},{'',''},{'','Statistics:'},{'Length: ',mb(Cb.lengthms)},{'Don (DON) / Ka (KA): ',ob(Cb.notes[1])..' + ('..ob(Cb.notes[3])..') / '..ob(Cb.notes[2])..' + ('..ob(Cb.notes[4])..') = '..lb((ob(Cb.notes[1])+ob(Cb.notes[3]))/Cb.notes.validn)..' / '..lb((ob(Cb.notes[2])+ob(Cb.notes[4]))/Cb.notes.validn)},{'Max Score (without drumroll): ',Cb.maxscore},{'Max Combo: ',Cb.maxcombo},{'Drumroll Time (total): ',mb(Cb.drumrollms+Cb.drumrollbigms)},{'Balloon Time: ',mb(Cb.balloonms)},{'Balloon Hits: ',Cb.balloonhit},{'Special Time: ',mb(Cb.specialms)},{'Special Hits: ',Cb.specialhit},{'',''},{'','Press Enter to Play!'}}for i=1,#Db do local Gb=Db[i]print(db(Gb[1]..tostring(Gb[2])))end;local Eb,Fb=eb()if bb.Select.L[Fb]then F=F-1 elseif bb.Select.R[Fb]then F=F+1 elseif bb.Select.U[Fb]then E=E-1 elseif bb.Select.D[Fb]then E=E+1 elseif bb.Select.Select[Fb]then local Gb=X[V[5]]if Gb and Gb[1]then local Hb=Gb[1]Taiko.ForAll(xb.Data,function(Ib,Jb,Kb)pb(Hb(Ib))end)end;while true do local Hb,Ib=Taiko.PlaySong(xb,Y,V,bb.Select.Play)if Hb and Ib then break elseif Hb=='Retry'then else break end end;curses.nodelay(Y,false)cb.ClearScreen()if Gb and Gb[2]then local Hb=Gb[2]Taiko.ForAll(xb.Data,function(Ib,Jb,Kb)qb(Hb(Ib))end)end elseif bb.Select.Escape[Fb]then break end end elseif bb.Search.Init[tb]then local ub=''local vb={}local wb=1;local xb=nil;local yb=1;cb.ClearScreen()cb.SetCursor(1,1)print('Searching...')while true do cb.SetCursor(#ub+1,2)local zb,Ab=eb()cb.SetCursor(1,2)if bb.Search.Backspace[Ab]then ub=string.sub(ub,1,-2)elseif bb.Search.FirstResult[Ab]then xb=vb[1]break elseif bb.Search.Select[Ab]then xb=vb[yb]break elseif bb.Search.Down[Ab]then yb=yb+1 elseif bb.Search.Up[Ab]then yb=yb-1 elseif bb.Search.Escape[Ab]then break else ub=ub..Ab end;print(db(ub))local Bb=Compact.SearchHeaderAll(s,ub)for i=1,L do if Bb[i]and Bb[i][2]==-math.huge then wb=i-1;break elseif i==L then wb=i end end;yb=ClipN(yb,1,wb)local Cb=false;for i=1,L do local Db=Bb[i]if Cb then print(db(''))else if Db then if Db[2]==-math.huge then Cb=true;print(db(''))else print(db((i==yb and N or i)..'. '..Bb[i][3]))vb[i]=Db end end end end end;D=(xb and xb[1]or D)or D elseif bb.Add.Init[tb]then print('Import a Custom Song')while true do print('Enter a .tja or .tjac file path (with the file extention)')local ub=fb()local vb=io.open(ub,'rb')if vb then local wb=vb:read('*all')if String.EndsWith(ub,'.tja')then print('Enter a song name')local xb=fb()local yb=#s+1;s[yb]=xb;t[yb]=wb;S[yb]={ub}break elseif String.EndsWith(ub,'.tjac')then local xb,yb=Compact.Decompress(wb)for i=1,#xb do local zb=#s+1;s[zb]=yb[i]t[zb]=xb[i]S[zb]={ub,xb}end;break else print('Invalid file type')end;vb:close()else print('Unable to read file')end end elseif bb.Reload.Init[tb]then print('Reloading selected file...')if S[D]then local ub=S[D]local vb=io.open(ub[1],'rb')if vb then local wb=vb:read('*all')local xb=D;if ub[2]then local yb,zb=Compact.Decompress(wb)if T then s[xb]=zb[i]end;t[xb]=yb[i]else t[xb]=wb end;if Q then rb[xb]=nil end;vb:close()else print('Unable to read file')end else print('File source not found')end elseif bb.ReloadAll.Init[tb]then print('Reloading all files...')local ub={}for vb,wb in pairs(S)do ub[wb[1]]=ub[wb[1]]and ub[wb[1]]or{}ub[wb[1]][#ub[wb[1]]+1]={vb,wb[2]}end;for vb,wb in pairs(ub)do local xb=io.open(vb,'rb')if xb then local yb=xb:read('*all')if wb[1][2]then local zb,Ab=Compact.Decompress(yb)for i=1,#wb do local Bb=wb[i]if T then s[Bb[1]]=Ab[Bb[2]]end;t[Bb[1]]=zb[Bb[2]]if Q then rb[Bb[1]]=nil end end else for i=1,#wb do local zb=wb[i]t[zb[1]]=yb;if Q then rb[zb[1]]=nil end end end;xb:close()else print('Unable to read file')end end elseif bb.Rename.Init[tb]then print('Enter a song name')local ub=fb()s[D]=ub elseif bb.Escape[tb]then return end;D=ib(D,1,#s)end end
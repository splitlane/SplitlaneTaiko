Split=function(c,d)local e={}for f,g in c:gmatch("([^"..d.."]*)("..d.."?)")do table.insert(e,f)if g==''then return e end end end;Trim=function(b)local c=b:gsub("^%s*(.-)%s*$","%1")return c end;TrimLeft=function(b)local c=b:gsub("^%s*(.-)$","%1")return c end;TrimRight=function(b)local c=b:gsub("^(.-)%s*$","%1")return c end;StartsWith=function(c,d)return c:sub(1,#d)==d end;EndsWith=function(c,d)return c:sub(-#d,-1)==d end;function Error(b)error(b)end;function ParseError(b,c)Error(b..': '..c)end;Taiko={}function Taiko.ParseTJA(b)local c={Metadata={BPM=120,WAVE='main.mp3',OFFSET=0,DEMOSTART=0,SCOREMODE=1,SONGVOL=100,SEVOL=100,LIFE=0,GAME='Taiko',HEADSCROLL=1,MOVIEOFFSET=0,COURSE='ONI',LEVEL=0,SCOREINIT,SCOREDIFF},Data={}}local d={bpm=0,ms=0,songstarted=false,timingpoint=nil,sign=4 /4,mpm=0,mspermeasure=0,scroll=1,measuredone=true,currentmeasure={},barline=true,gogo=false}local e=Split(b,'\n')for i=1,#e do local f=TrimLeft(e[i])if StartsWith(f,'//')or f==''then else local g=false;if d.songstarted==false and g==false then local h={string.match(f,'(%u+):(.*)')}if h[1]then c.Metadata[Trim(h[1])]=Trim(h[2])g=true end end;if(d.songstarted or StartsWith(f,'#START'))and g==false then local h={string.match(f,'#(%u-)%s(.*)')}if not h[1]then h={string.match(f,'#(%u+)')}end;if h[1]then if h[1]=='START'then if d.songstarted then ParseError(h[1],'Song has already started')else d.bpm=c.Metadata.BPM;d.songstarted=true end elseif h[1]=='END'then if d.songstarted then d.songstarted=false else ParseError(h[1],'Song has already ended')end elseif h[1]=='MEASURE'then d.sign=tonumber(h[2])or d.sign elseif h[1]=='BPMCHANGE'then d.bpm=tonumber(h[2])or d.bpm elseif h[1]=='DELAY'then table.insert(d.currentmeasure,{h[1],tostring(1000 * (tonumber(h[2])or 0))})elseif h[1]=='SCROLL'then d.scroll=tonumber(h[2])or d.scroll;if d.scroll==0 then ParseError(h[1],'Scroll cannot be 0')end elseif h[1]=='GOGOSTART'then d.gogo=true elseif h[1]=='GOGOEND'then d.gogo=false elseif h[1]=='BARLINEOFF'then d.barline=false elseif h[1]=='BARLINEON'then d.barline=true elseif h[1]=='BRANCHSTART'then elseif h[1]=='N'then elseif h[1]=='E'then elseif h[1]=='M'then elseif h[1]=='BRANCHEND'then elseif h[1]=='SECTION'then elseif h[1]=='LYRIC'then elseif h[1]=='LEVELHOLD'then elseif h[1]=='BMSCROLL'then elseif h[1]=='HBSCROLL'then elseif h[1]=='SENOTECHANGE'then elseif h[1]=='NEXTSONG'then elseif h[1]=='DIRECTION'then elseif h[1]=='SUDDEN'then elseif h[1]=='JPOSSCROLL'then else end;g=true end end;if(d.songstarted)and g==false then d.mpm=d.bpm*d.sign/4;d.mspermeasure=60000 *d.sign*4 /d.bpm;local h={}for i=1,#f do local j=string.sub(f,i,i)local k=tonumber(j)if k then table.insert(d.currentmeasure,{ms=nil,data='note',type=k,txt=nil,gogo=d.gogo,speed=(d.scroll*c.Metadata.HEADSCROLL),mspermeasure=d.mspermeasure})end end;if EndsWith(f,',')then if d.barline then table.insert(c.Data,{ms=d.ms,data='event',event='barline'})end;if#d.currentmeasure==0 then d.ms=d.ms+d.mspermeasure else local j=0;local k=nil;for i=1,#d.currentmeasure do local m=d.currentmeasure[i]if m.data=='note'then k=k or m.mspermeasure;j=j+1 end end;local l=k/j;for i=1,#d.currentmeasure do local m=d.currentmeasure[i]if m[1]=='DELAY'then d.ms=d.ms+m[2]else if m.type~=0 then m.ms=d.ms;table.insert(c.Data,m)l=m.mspermeasure/j end end;d.ms=d.ms+l end end;d.measuredone=true;d.currentmeasure={}else d.measuredone=false end end end end;return c end;function Taiko.RenderScale(b)local c={}local d={}local e={}for i=1,#b.Data do local j=b.Data[i]if j.data=='note'then local k=math.floor(j.ms)if math.floor(k)-k==0 then table.insert(c,{k,j.type})table.insert(d,k)else table.insert(e,i)end end end;function gcd2(i,j)if j==0 then return i else return gcd2(j,i%j)end end;function gcdn(i)local j=i[1]for i=2,#i do j=gcd2(j,i[i])end;return j end;local f=gcdn(d)for i=1,#e do local j=c[e[i]]j[1]=math.floor(j[1]/f)*f end;local g=''local h=0;for i=1,#c do c[i][1]=c[i][1]/f;g=g..string.rep(' ',c[i][1]-h)..c[i][2]h=c[i][1]end;return g end;function Taiko.PlaySong(b)require'ppp'(b)local c=0 end;Taiko.PlaySong(Taiko.ParseTJA(io.open('test.tja','r'):read('*all')))
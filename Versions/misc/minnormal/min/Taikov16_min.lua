local g;Split=function(l,m)local n={}for o,p in l:gmatch("([^"..m.."]*)("..m.."?)")do table.insert(n,o)if p==''then return n end end end;Trim=function(l)local m=l:gsub("^%s*(.-)%s*$","%1")return m end;TrimLeft=function(l)local m=l:gsub("^%s*(.-)$","%1")return m end;TrimRight=function(l)local m=l:gsub("^(.-)%s*$","%1")return m end;StartsWith=function(l,m)return l:sub(1,#m)==m end;EndsWith=function(l,m)return l:sub(-#m,-1)==m end;Table={}function Table.Clone(l,m)m=m or{}local n=type(l)local o;if n=='table'then if m[l]then o=m[l]else o={}m[l]=o;for p,q in next,l,nil do o[Table.Clone(p,m)]=Table.Clone(q,m)end;setmetatable(o,Table.Clone(getmetatable(l),m))end else o=l end;return o end;ClipN=function(l,m,o)if l<m then return m elseif l>o then return o else return l end end;function Error(l)print(l)end;LineN=nil;function ParseError(l,m,n)Error('Line: '..LineN..'\n'..l..': '..m.. (n and(', '..n)or''))end;function MsToS(l)return l/1000 end;function SToMs(l)return l*1000 end;Taiko={}Taiko.Data={Languages={'','EN','JA','CN','TW','KO'},GenreName={Pop={'pop','j-pop'},Anime={'anime','アニメ'},Kids={'kids','どうよう'},Variety={'variety','バラエティ'},VOCALOID={'vocaloid','ボーカロイド'},Classic={'classic','クラシック'},['Game Music']={'game music','ゲームミュージック'},['Namco Original']={'namco original','ナムコオリジナル'}},CourseId={easy=0,normal=1,hard=2,oni=3,edit=4,tower=5,dan=6,ura=4},CourseName={[0]='Easy','Normal','Hard','Oni','Edit','Tower','Dan','Ura'},RatingMultiplier={[0]=0,[1]=0.5,[2]=1,[3]=2},GogoMultiplier=1.2,ScoreMode={[0]=function(l,m,n,o,p,q)return l+ ( ( (m<200)and(n or 1000)or( (n or 1000)+ (o or 1000)))*Taiko.Data.RatingMultiplier[p]* (q and Taiko.Data.GogoMultiplier or 1))end,[1]=function(l,m,n,o,p,q)return l+ ( (n+math.max(0,o*math.floor((math.min(m,100)-1)/10)))*Taiko.Data.RatingMultiplier[p]* (q and Taiko.Data.GogoMultiplier or 1))end,[2]=function(l,m,n,o,p,q)return l+ ( (n+o* ( (m>=100)and 8 or(m>=50)and 4 or(m>=30)and 2 or(m>=10)and 1 or 0))*Taiko.Data.RatingMultiplier[p]* (q and Taiko.Data.GogoMultiplier or 1))end},Autoscore={[0]=function(l)end,[1]=function(l)end,[2]=function(l)end},SideId={normal=1,ex=2,both=3},SideName={'normal','ex','both'},StyleId={single=1,double=2,couple=2},StyleName={'single','double'},Exam={Condition={g=true,jp=true,jg=true,jb=true,s=true,r=true,h=true,c=true},Scope={m=true,l=true}},Branch={PathId={N=0,E=1,M=2},PathName={[0]='N',[1]='E',[2]='M'},Requirements={r=function()end,p=function()end}},Timing={GetFunction=function(l)return function(m)if l==1 then return{good=5 /2 *m,ok=13 /2 *m,bad=15 /2 *m}else return{good=3 /2 *m,ok=9 /2 *m,bad=13 /2 *m}end end end},StatusId={bad=0,ok=1,good=2,biggood=3},StatusName={[0]='BAD',[1]='OK',[2]='GOOD',[3]='GOOD'},ModeId={['']=0,P1=1,P2=2},ModeName={[0]='',P1,P2},Combo={[1]=true,[2]=true,[3]=true,[4]=true},BigLeniency=2}for l,m in pairs(Taiko.Data.ScoreMode)do Taiko.Data.ScoreMode[l]=function(...)return math.floor(m(...)/10)*10 end end;function Taiko.ParseTJA(l)local m=os.clock()local n={}local o={Metadata={BPM=120,WAVE='main.mp3',OFFSET=0,DEMOSTART=0,SCOREMODE=1,SONGVOL=100,SEVOL=100,SIDE=3,LIFE=0,GAME='Taiko',HEADSCROLL=1,MOVIEOFFSET=0,COURSE='ONI',LEVEL=0,BALLOON=nil,SCOREINIT,SCOREDIFF,BALLOONNOR=nil,BALLOONEXP=nil,BALLOONMAS=nil,STYLE=1,EXAM1=nil,EXAM2=nil,EXAM3=nil,GAUGEINCR='NORMAL',TOTAL=nil,HIDDENBRANCH=0,DIVERGENOTES=false,SCOREINIT=0,SCOREDIFF=0},Data={}}local function p(B)local C=Taiko.Data.Languages;for i=1,#C do local D=o.Metadata[B..C[i]]if D then return D end end;return nil end;local function q(B,C,D)local E=tonumber(C)if E then return E else ParseError(B,D,C)end end;local function r(B,C,D,E)if C then return C else ParseError(B,D,E)end end;local function s(B,C,D)local E={['true']=true,['false']=false,yes=true,no=false,['1']=true,['0']=false,[1]=true,[0]=false}local F=E[C]~=nil;if F then return F else ParseError(B,D,C)end end;local function u(B,C)local D=','local E='\\'local F={}local G=''local H=false;for i=1,#C do local I=string.sub(C,i,i)if H then G=G..I;H=false else if I==D then table.insert(F,G)G=''elseif I==E then H=true else G=G..I end end end;table.insert(F,G)return F end;local function v(B,C,D)local E=u(B,C)for i=1,#E do E[i]=q(B,E[i],D,C)end;return E end;local function w(B,C,D)if C and C~=''then return v(B,C,D)else return{}end end;local function x(B,C,D)if C and C~=''then local E=u(B,C,D)r(B,Taiko.Data.Exam.Condition[E[1]],D)E[2]=q(B,E[2],D)E[3]=q(B,E[3],D)r(B,Taiko.Data.Exam.Scope[E[4]],D)return E else return{}end end;local y={}local function z()local B={settings={noteparse={notealias={A=3,B=4},noteexceptions={[',']=true,[' ']=true,['\t']=true}},command={matchexceptions={}}},bpm=0,ms=0,songstarted=false,timingpoint=nil,sign=4 /4,mpm=0,mspermeasure=0,scroll=1,measuredone=true,currentmeasure={},measurepushto=o.Data,barline=true,gogo=false,lastlong=nil,balloonn=1,currentbranch=nil,branch={on=false,requirements={},paths={}},msbeforebranch=nil}function B.createnote(C)if C then local D={ms=nil,data=nil,type=C,txt=nil,gogo=B.gogo,scroll=(B.scroll*o.Metadata.HEADSCROLL),mspermeasure=B.mspermeasure,bpm=B.bpm,nextnote=nil,radius=1,requiredhits=nil,length=nil,endnote=nil,onnotepush=nil}D.type=C;if C==3 or C==4 or C==6 then D.radius=D.radius*1.6 end;if C==5 or C==6 or C==7 or C==9 then if B.lastlong then if C==9 then else ParseError('parser.noteparse','Last long note has not ended')end else B.lastlong=D;if C==7 or C==9 then D.requiredhits=r('parser.noteparse',o.Metadata.BALLOON[B.balloonn],'Invalid number of balloons',B.balloonn)B.balloonn=B.balloonn+1 end end end;if C==8 then local E=B.lastlong;B.lastlong=nil;D.startnote=E;if E then D.onnotepush=function()E.length=D.ms-E.ms;E.endnote=D end else end end;return D else return{ms=nil,data=nil,type=nil,txt=nil,gogo=B.gogo,scroll=(B.scroll*o.Metadata.HEADSCROLL),mspermeasure=B.mspermeasure,bpm=B.bpm,nextnote=nil}end end;function B.endbranch()local C=B.createnote()C.data='event'C.event='branch'C.branch={requirements=B.branch.requirements,paths=B.branch.paths}B.branch.on=false;B.branch.requirements={}B.branch.paths={}table.insert(o.Data,C)B.measurepushto=o.Data end;return B end;y=z()local A=Split(l,'\n')for i=1,#A do LineN=i;local B=Trim(A[i])if StartsWith(B,'//')or B==''then else local C=string.find(B,'//')if C then B=string.sub(B,1,C-1)end;local D=false;if y.songstarted==false and D==false then local E={string.match(B,'(%u+):(.*)')}if E[1]then local F=Trim(E[2])if F~=''then o.Metadata[Trim(E[1])]=F end;D=true end end;if(y.songstarted or StartsWith(B,'#START'))and D==false then local E={string.match(B,'#(%u-)%s(.*)')}if not E[1]then E={string.match(B,'#(%u+)')}end;if E[1]then if E[1]=='START'then if y.songstarted then ParseError(E[1],'Song has already started')else o.OriginalMetadata=Table.Clone(o.Metadata)if E[2]then o.Metadata.MODE=r(E[1],Taiko.Data.ModeId[E[2]],'Invalid mode',E[2])else o.Metadata.MODE=0 end;o.Metadata.TITLE=r(E[1],p('TITLE'),'Title is missing')o.Metadata.SUBTITLE=r(E[1],p('SUBTITLE'),'Subtitle is missing')o.Metadata.BPM=q(E[1],o.Metadata.BPM,'Invalid bpm')o.Metadata.OFFSET=SToMs(q(E[1],o.Metadata.OFFSET,'Invalid offset'))o.Metadata.DEMOSTART=SToMs(q(E[1],o.Metadata.DEMOSTART,'Invalid demostart'))if o.Metadata.DEMOSTART==0 then o.Metadata.DEMOSTART=nil end;for I,J in pairs(Taiko.Data.GenreName)do for i=1,#J do if J[i]==o.Metadata.GENRE then o.Metadata.GENRE=I end end end;o.Metadata.SCOREMODE=q(E[1],o.Metadata.SCOREMODE,'Invalid scoremode')r(E[1],Taiko.Data.ScoreMode[o.Metadata.SCOREMODE],'Invalid scoremode',o.Metadata.SCOREMODE)if o.Metadata.MAKER then o.Metadata.CREATORURLT={}o.Metadata.CREATOR=Trim(string.gsub(o.Metadata.MAKER,'(<.->)',function(I)table.insert(o.Metadata.CREATORURLT,string.sub(I,2,-2))return''end))o.Metadata.CREATORURL=table.concat(o.Metadata.CREATORURLT,', ')o.Metadata.CREATIVE=false else o.Metadata.CREATIVE=false end;o.Metadata.SONGVOL=q(E[1],o.Metadata.SONGVOL,'Invalid songvol')/100;o.Metadata.SEVOL=q(E[1],o.Metadata.SEVOL,'Invalid sevol')/100;local F=tonumber(o.Metadata.SIDE)if F then r(E[1],Taiko.Data.SideName[F],'Invalid side id',o.Metadata.SIDE)o.Metadata.SIDE=F else o.Metadata.SIDE=r(E[1],Taiko.Data.SideId[string.lower(o.Metadata.SIDE)],'Invalid side name',o.Metadata.SIDE)end;o.Metadata.LIFE=q(E[1],o.Metadata.LIFE,'Invalid life')if o.Metadata.LIFE==0 then o.Metadata.LIFE=nil end;o.Metadata.GAME=string.lower(o.Metadata.GAME)if o.Metadata.GAME=='taiko'then elseif o.Metadata.GAME=='jube'then else end;o.Metadata.HEADSCROLL=q(E[1],o.Metadata.HEADSCROLL,'Invalid headscroll')o.Metadata.MOVIEOFFSET=q(E[1],o.Metadata.MOVIEOFFSET,'Invalid movieoffset')local G=tonumber(o.Metadata.COURSE)if G then r(E[1],Taiko.Data.CourseName[G],'Invalid course id',o.Metadata.COURSE)o.Metadata.COURSE=G else o.Metadata.COURSE=r(E[1],Taiko.Data.CourseId[string.lower(o.Metadata.COURSE)],'Invalid course name',o.Metadata.COURSE)end;o.Metadata.TIMING=Taiko.Data.Timing.GetFunction(o.Metadata.COURSE)o.Metadata.LEVEL=ClipN(math.floor(q(E[1],o.Metadata.LEVEL,'Invalid level')),0,10)o.Metadata.BALLOON=w(E[1],o.Metadata.BALLOON,'Invalid balloon')o.Metadata.SCOREINIT=q(E[1],o.Metadata.SCOREINIT,'Invalid scoreinit')o.Metadata.SCOREDIFF=q(E[1],o.Metadata.SCOREDIFF,'Invalid scoreinit')o.Metadata.BALLOONNOR=w(E[1],o.Metadata.BALLOONNOR,'Invalid balloonnor')o.Metadata.BALLOONEXP=w(E[1],o.Metadata.BALLOONEXP,'Invalid balloonexp')o.Metadata.BALLOONMAS=w(E[1],o.Metadata.BALLOONMAS,'Invalid balloonmas')local H=tonumber(o.Metadata.STYLE)if H then r(E[1],Taiko.Data.StyleName[H],'Invalid style id',Taiko.Data.STYLE)o.Metadata.STYLE=H else o.Metadata.STYLE=r(E[1],Taiko.Data.StyleId[string.lower(o.Metadata.STYLE)],'Invalid style name',o.Metadata.STYLE)end;o.Metadata.EXAM1=x(o.Metadata.EXAM1)o.Metadata.EXAM2=x(o.Metadata.EXAM2)o.Metadata.EXAM3=x(o.Metadata.EXAM3)o.Metadata.GAUGEINCR=string.lower(o.Metadata.GAUGEINCR)if o.Metadata.TOTAL then o.Metadata.TOTAL=q(E[1],o.Metadata.TOTAL,'Invalid total')end;o.Metadata.HIDDENBRANCH=s(E[1],o.Metadata.HIDDENBRANCH,'Invalid hiddenbranch')y.bpm=o.Metadata.BPM;y.songstarted=true end elseif E[1]=='END'then if y.songstarted then if#y.currentmeasure~=0 then ParseError(E[1],'Current measure is not empty')end;table.insert(n,o)o={Metadata=Table.Clone(o.OriginalMetadata),Data={}}y=z()y.songstarted=false;y.measurepushto=o.Data else ParseError(E[1],'Song has already ended')end elseif E[1]=='MEASURE'then local F,G=string.match(E[2],'(%d+)/(%d+)')F=q(E[1],F,'Invalid measure')G=q(E[1],G,'Invalid measure')y.sign=(F/G)or y.sign elseif E[1]=='BPMCHANGE'then y.bpm=q(E[1],E[2],'Invalid bpmchange')or y.bpm elseif E[1]=='DELAY'then table.insert(y.currentmeasure,{E[1],SToMs((q(E[1],E[2],'Invalid delay')or 0))})elseif E[1]=='SCROLL'then y.scroll=q(E[1],E[2],'Invalid scroll')or y.scroll;if y.scroll==0 then ParseError(E[1],'Scroll cannot be 0')end elseif E[1]=='GOGOSTART'then y.gogo=true elseif E[1]=='GOGOEND'then y.gogo=false elseif E[1]=='BARLINEOFF'then y.barline=false elseif E[1]=='BARLINEON'then y.barline=true elseif E[1]=='BRANCHSTART'then if y.branch.on then y.endbranch()end;y.msbeforebranch=y.ms;y.branch.on=true;o.Metadata.DIVERGENOTES=true;local F=u(E[1],E[2])local G=r(E[1],Taiko.Data.Branch.Requirements[string.lower(F[1])],'Invalid type',F[1])y.branch.requirements={G}local H=2;while true do if not F[H]then break end;local I=Taiko.Data.Branch.PathName[H-1]if I then y.branch.requirements[I]=F[H]else break end;H=H+1 end elseif Taiko.Data.Branch.PathId[E[1]]then if y.branch.on then y.ms=y.msbeforebranch;y.currentbranch=E[1]y.branch.paths[E[1]]={}y.measurepushto=y.branch.paths[E[1]]else ParseError(E[1],'Branch has not started')end elseif E[1]=='BRANCHEND'then if y.branch.on then y.endbranch()else ParseError(E[1],'Branch has already ended')end elseif E[1]=='SECTION'then elseif E[1]=='LYRIC'then elseif E[1]=='LEVELHOLD'then elseif E[1]=='BMSCROLL'then elseif E[1]=='HBSCROLL'then elseif E[1]=='SENOTECHANGE'then elseif E[1]=='NEXTSONG'then elseif E[1]=='DIRECTION'then elseif E[1]=='SUDDEN'then elseif E[1]=='JPOSSCROLL'then else end;D=true end end;if(y.songstarted)and D==false then y.mpm=y.bpm*y.sign/4;y.mspermeasure=60000 *y.sign*4 /y.bpm;if y.barline and#y.currentmeasure==0 then local E=y.createnote()E.ms=y.ms;E.data='event'E.event='barline'table.insert(y.measurepushto,1,E)end;for i=1,#B do local E=string.sub(B,i,i)if y.settings.noteparse.noteexceptions[E]then else local F=q('parser.noteparse',tonumber(E)or y.settings.noteparse.notealias[E]or E,'Invalid note')if F then local G=y.createnote(F)G.data='note'table.insert(y.currentmeasure,G)end end end;if EndsWith(TrimRight(B),',')then y.mpm=y.bpm*y.sign/4;y.mspermeasure=60000 *y.sign*4 /y.bpm;if#y.currentmeasure==0 then y.ms=y.ms+y.mspermeasure else local E=0;local F=nil;for i=1,#y.currentmeasure do local H=y.currentmeasure[i]if H.data=='note'then F=F or H.mspermeasure;E=E+1 end end;F=F or y.mspermeasure;local G=F/E;for i=1,#y.currentmeasure do local H=y.currentmeasure[i]if H[1]=='DELAY'then y.ms=y.ms+H[2]else if H.type~=0 then H.ms=y.ms;local I=o.Data[#o.Data]if I then I.nextnote=H end;table.insert(y.measurepushto,H)if H.onnotepush then H.onnotepush()end;G=H.mspermeasure/E end end;y.ms=y.ms+G end end;y.measuredone=true;y.currentmeasure={}else y.measuredone=false end end end end;print('Parsing Took: '..SToMs(os.clock()-m)..'ms')return n end;function Taiko.Score(l,m,n,o,p)if o==0 then n=0 else n=n+1 end;local q=l.Metadata;return Taiko.Data.ScoreMode[q.SCOREMODE](m,n,q.SCOREINIT,q.SCOREDIFF,o,p),n end;function Taiko.Analyze(l)local m='M'local n={[1]=2,[2]=2,[3]=3,[4]=3}local o={notes={n=0,validn=0},measures=0,lengthms=0,drumrollms=0,drumrollbigms=0,balloonms=0,balloonhit=0,specialms=0,specialhit=0,maxcombo=0,maxscore=0}local p=nil;Taiko.ForAll(l.Data,function(q,r,s)if q.data=='note'then o.notes.n=o.notes.n+1;o.notes[q.type]=o.notes[q.type]and o.notes[q.type]+1 or 1;if n[q.type]then o.maxscore,o.maxcombo=Taiko.Score(l,o.maxscore,o.maxcombo,n[q.type],q.gogo)end;local u=q.endnote;if u then local v=u.ms-q.ms;if q.type==5 then o.drumrollms=o.drumrollms+v elseif q.type==6 then o.drumrollbigms=o.drumrollbigms+v elseif q.type==7 then o.balloonms=o.balloonms+v;o.balloonhit=o.balloonhit+q.requiredhits elseif q.type==9 then o.specialms=o.specialms+v;o.specialhit=o.specialhit+q.requiredhits else end end;p=q elseif q.data=='event'and q.event=='barline'then o.measures=o.measures+1 else end end,m)o.lengthms=p.ms-l.Metadata.OFFSET;o.notes.validn=o.maxcombo;return o end;function Taiko.GetDifficulty(l,m)local n=Taiko.Data.CourseId[string.lower(m)]or m;for o,p in pairs(l)do if p.Metadata.COURSE==n then return p end end;Error('No difficulty found, '..m)return nil end;function Taiko.ForAll(l,m,n)local o=1;for i=1,#l do local p=l[i]if p.branch then if n then local q=p.branch.paths[n]for i2=1,#q do m(q[i2],i2,o)o=o+1 end;o=o-1 else local q=-1;for r,s in pairs(p.branch.paths)do local u=o;for i2=1,#s do m(s[i2],i2,u)u=u+1 end;q=(q<u)and u or q end;o=q end else m(p,i,o)end;o=o+1 end;return l end;function Taiko.GetAllNotes(l)local m={}for n,o in pairs(l)do if o.branch then for p,q in pairs(o.branch.paths)do for i=1,#q do table.insert(m,q[i])end end else table.insert(m,o)end end;return m end;function Taiko.ConnectNotes(l)local m=nil;for i=#l,1,-1 do local o=l[i]o.nextnote=m;m=o end;return l end;function Taiko.ExtractBranch(l,m)return l.branch.paths[m]end;function Taiko.ConnectAll(l)local m=nil;for i=#l,1,-1 do local n=l[i]if n.branch then for o,p in pairs(n.branch.paths)do local q=Taiko.ConnectNotes(p)q[#q].nextnote=m end else n.nextnote=m end;m=n end end;function Taiko.CalculateSpeed(l,m)local n=(m*l.scroll*l.bpm/7500)return n end;function Taiko.CalculateSpeedAll(l,m)for i=1,#l do l[i].speed=Taiko.CalculateSpeed(l[i],m)end;return l end;function Taiko.RenderScale(l)local m={}local n={}local o={}for i=1,#l.Data do local s=l.Data[i]if s.data=='note'then local u=math.floor(s.ms)if math.floor(u)-u==0 then table.insert(m,{u,s.type})table.insert(n,u)else table.insert(o,i)end end end;function gcd2(s,u)if u==0 then return s else return gcd2(u,s%u)end end;function gcdn(s)local u=s[1]for i=2,#s do u=gcd2(u,s[i])end;return u end;local p=gcdn(n)for i=1,#o do local s=m[o[i]]s[1]=math.floor(s[1]/p)*p end;local q=''local r=0;for i=1,#m do m[i][1]=m[i][1]/p;q=q..string.rep(' ',m[i][1]-r)..m[i][2]r=m[i][1]end;return q end;function Taiko.PlaySong(l,m,n,o)local p={on=false,fps=60,frames={}}local q=nil;local r={auto={[1]=false,[2]=true},notespeedmul={[1]=1,[2]=2,[3]=3,[4]=4,[5]=0.25,[6]=0.5,[7]=0.75},songspeedmul={[1]=1,[2]=2,[3]=3,[4]=4,[5]=0.25,[6]=0.5,[7]=0.75}}local s=r.auto[n[2]]or false;local u=false;local v=r.notespeedmul[n[3]]or 1;local w=r.songspeedmul[n[4]]or 1;local x=o or{}x={Hit=x.Hit or{['4']=2,['v']=1,['n']=1,['8']=2},Escape=x.Escape or{['\27']=true,ALT_ESC=true},L=x.L or{KEY_LEFT=true,KEY_SLEFT=true,CTL_LEFT=true,KEY_B1=true,ALT_LEFT=true,KEY_SHIFT_L=true,KEY_UP=true,KEY_A2=true},R=x.R or{KEY_RIGHT=true,KEY_SRIGHT=true,CTL_RIGHT=true,KEY_B3=true,ALT_RIGHT=true,KEY_SHIFT_R=true,KEY_DOWN=true,KEY_C2=true},Select=x.Select or{KEY_ENTER=true,PADENTER=true,CTL_PADENTER=true,ALT_PADENTER=true,CTL_PADCENTER=true,ALT_ENTER=true,CTL_ENTER=true,SHF_PADENTER=true,['\n']=true,['\r']=true}}local z=1;local A=2;local B='>'local C='\n\n\n'local D=10;local E=1000;local F=4;local G=0;local H=10;local I=0;local J=40;local K=3;local L=1;local M={[1]={color='red'},[2]={color='blue'},[3]={color='red'},[4]={color='blue'},[5]={color='yellow'},[6]={color='yellow'}}local N=200;local O=N/4;local P=4;local Q=20;J=math.floor(J*F)local R=I+J;K=math.floor(K*F)local S=require('taikocurses')local T=m or{window=S.initscr()}S.keypad(T,true)S.echo(false)S.raw(true)S.nl(false)S.cbreak(true)S.nodelay(T,true)local U={[0]={Data={[1]={'0','1','1','1','1','1','1','1'},[2]={[2]='1',[5]='1',[8]='1'},[3]={[2]='1',[5]='1',[8]='1'},[4]={[2]='1',[5]='1',[8]='1'},[5]={[2]='1',[5]='1',[8]='1'},[6]={[3]='1',[4]='1',[6]='1',[7]='1'},[8]={'0','0','1','1','1','1','1','1'},[9]={[2]='1',[5]='1'},[10]={[2]='1',[5]='1'},[11]={[2]='1',[5]='1'},[12]={[2]='1',[5]='1'},[13]={'0','0','1','1','1','1','1','1'},[15]={'0','1','1','1','1','1','1','1'},[16]={[2]='1',[8]='1'},[17]={[2]='1',[8]='1'},[18]={[2]='1',[8]='1'},[19]={[2]='1',[8]='1'},[20]={'0','0','1','1','1','1','1','0'}},Color={All='blue'},Offset={-1,0}},[1]={Data={[1]={'0','0','1','1','1','1','1','0'},[2]={[2]='1',[8]='1'},[3]={[2]='1',[8]='1'},[4]={[2]='1',[8]='1'},[5]={[2]='1',[8]='1'},[6]={'0','0','1','1','1','1','1','0'},[8]={'0','1','1','1','1','1','1','1'},[9]={[5]='1'},[10]={[4]='1',[6]='1'},[11]={[3]='1',[7]='1'},[12]={[2]='1',[8]='1'}},Color={All='white'},Offset={-1,0}},[2]={Data={[1]={'0','0','1','1','1','1','1','0'},[2]={[2]='1',[8]='1'},[3]={[2]='1',[8]='1'},[4]={[2]='1',[5]='1',[8]='1'},[5]={[2]='1',[5]='1',[8]='1'},[6]={'0','1','0','0','1','1','1','1'},[8]={'0','0','1','1','1','1','1','0'},[9]={[2]='1',[8]='1'},[10]={[2]='1',[8]='1'},[11]={[2]='1',[8]='1'},[12]={[2]='1',[8]='1'},[13]={'0','0','1','1','1','1','1','0'},[15]={'0','0','1','1','1','1','1','0'},[16]={[2]='1',[8]='1'},[17]={[2]='1',[8]='1'},[18]={[2]='1',[8]='1'},[19]={[2]='1',[8]='1'},[20]={'0','0','1','1','1','1','1','0'},[22]={'0','1','1','1','1','1','1','1'},[23]={[2]='1',[8]='1'},[24]={[2]='1',[8]='1'},[25]={[2]='1',[8]='1'},[26]={[2]='1',[8]='1'},[27]={'0','0','1','1','1','1','1','0'}},Color={All='yellow'},Offset={-1,0}}}U[3]=U[2]local V={[0]=nil,[1]={},[2]={}}local W;if g then W=g else os.execute('chcp 65001')W={}local Fb=([[
⠀ ⢀ ⠠ ⢠ ⠐ ⢐ ⠰ ⢰ ⠈ ⢈ ⠨ ⢨ ⠘ ⢘ ⠸ ⢸
⡀ ⣀ ⡠ ⣠ ⡐ ⣐ ⡰ ⣰ ⡈ ⣈ ⡨ ⣨ ⡘ ⣘ ⡸ ⣸
⠄ ⢄ ⠤ ⢤ ⠔ ⢔ ⠴ ⢴ ⠌ ⢌ ⠬ ⢬ ⠜ ⢜ ⠼ ⢼
⡄ ⣄ ⡤ ⣤ ⡔ ⣔ ⡴ ⣴ ⡌ ⣌ ⡬ ⣬ ⡜ ⣜ ⡼ ⣼
⠂ ⢂ ⠢ ⢢ ⠒ ⢒ ⠲ ⢲ ⠊ ⢊ ⠪ ⢪ ⠚ ⢚ ⠺ ⢺
⡂ ⣂ ⡢ ⣢ ⡒ ⣒ ⡲ ⣲ ⡊ ⣊ ⡪ ⣪ ⡚ ⣚ ⡺ ⣺
⠆ ⢆ ⠦ ⢦ ⠖ ⢖ ⠶ ⢶ ⠎ ⢎ ⠮ ⢮ ⠞ ⢞ ⠾ ⢾
⡆ ⣆ ⡦ ⣦ ⡖ ⣖ ⡶ ⣶ ⡎ ⣎ ⡮ ⣮ ⡞ ⣞ ⡾ ⣾
⠁ ⢁ ⠡ ⢡ ⠑ ⢑ ⠱ ⢱ ⠉ ⢉ ⠩ ⢩ ⠙ ⢙ ⠹ ⢹
⡁ ⣁ ⡡ ⣡ ⡑ ⣑ ⡱ ⣱ ⡉ ⣉ ⡩ ⣩ ⡙ ⣙ ⡹ ⣹
⠅ ⢅ ⠥ ⢥ ⠕ ⢕ ⠵ ⢵ ⠍ ⢍ ⠭ ⢭ ⠝ ⢝ ⠽ ⢽
⡅ ⣅ ⡥ ⣥ ⡕ ⣕ ⡵ ⣵ ⡍ ⣍ ⡭ ⣭ ⡝ ⣝ ⡽ ⣽
⠃ ⢃ ⠣ ⢣ ⠓ ⢓ ⠳ ⢳ ⠋ ⢋ ⠫ ⢫ ⠛ ⢛ ⠻ ⢻
⡃ ⣃ ⡣ ⣣ ⡓ ⣓ ⡳ ⣳ ⡋ ⣋ ⡫ ⣫ ⡛ ⣛ ⡻ ⣻
⠇ ⢇ ⠧ ⢧ ⠗ ⢗ ⠷ ⢷ ⠏ ⢏ ⠯ ⢯ ⠟ ⢟ ⠿ ⢿
⡇ ⣇ ⡧ ⣧ ⡗ ⣗ ⡷ ⣷ ⡏ ⣏ ⡯ ⣯ ⡟ ⣟ ⡿ ⣿]]):gsub('\n',' ')function GenerateDotData()function ToBinary(Rb)local Sb={}while Rb>0 do local Ub=math.fmod(Rb,2)Sb[#Sb+1]=string.sub(Ub,1,1)Rb=(Rb-Ub)/2 end;local Tb=string.reverse(table.concat(Sb))return string.rep('0',8 -#Tb)..Tb end;local function Lb(Rb)return Rb end;local Mb=Split(Fb,' ')local Nb={}local Ob=false;local Pb=''local Qb=' 'for i=1,#Mb do Nb[ToBinary(i-1)]=Lb(Mb[i])if Ob then print(ToBinary(i-1)..Mb[i])local Rb=io.read()if Rb==''then Rb=Mb[i]elseif Rb=='stop'then break end;Pb=Pb..Rb..Qb end end;if Ob then print(Pb)io.open('Data.lua','a+'):write(Pb)end;return Nb end;W.Data={}W.Data.Dot=GenerateDotData()W.ColorData={reset=0,clear=0,space=0,bright=1,bold=1,dim=2,faint=1,italic=3,underline=4,blink=5,reverse=7,invisible=8,hidden=8,strikethrough=9,black=30,red=31,green=32,yellow=33,blue=34,purple=35,magenta=35,cyan=36,white=37,onblack=40,onred=41,ongreen=42,onyellow=43,onblue=44,onpurple=45,onmagenta=45,oncyan=46,onwhite=47}W.Color={}for Lb,Mb in pairs(W.ColorData)do W.Color[Lb]='\27['..Mb..'m'end;local Gb,Hb=I,J;local Ib,Jb=-H,H;Ib,Jb=-20,20;W.Convert={}W.Convert.ToDots=function(Lb)local Mb,Nb=Lb.Data,Lb.Color;local Ob={}local Pb=string.rep('0',8)local Qb=W.Data.Dot[Pb]local Rb=nil;local Sb=nil;local Tb=W.Color['reset']if Lb.Color.All then local Ub=W.Color[Lb.Color.All]table.insert(Ob,Ub)Sb=Ub end;if not Ib then return''end;for y=Ib,Jb,4 do for x=Gb,Hb,2 do local Ub=Mb[x]local Vb=Mb[x+1]local Wb=( (Ub)and( (Ub[y]or'0').. (Ub[y+1]or'0').. (Ub[y+2]or'0').. (Ub[y+3]or'0'))or'0000').. ( (Vb)and( (Vb[y]or'0').. (Vb[y+1]or'0').. (Vb[y+2]or'0').. (Vb[y+3]or'0'))or'0000')if Wb~=Pb then Wb=W.Data.Dot[Wb]if not Sb then local Xb=Nb[x]local Yb=Nb[x+1]local Zb=( (Xb)and(Xb[y]or Xb[y+1]or Xb[y+2]or Xb[y+3]))or( (Yb)and(Yb[y]or Yb[y+1]or Yb[y+2]or Yb[y+3]))if Zb then Zb=W.Color[Zb]else Zb=Tb end;if Rb==Zb then else table.insert(Ob,Zb)Rb=Zb end end;table.insert(Ob,Wb)else table.insert(Ob,Qb)end end;table.insert(Ob,'\n')end;table.insert(Ob,Tb)return table.concat(Ob)end;W.CircleGen=function(Lb,Mb,Nb,Ob,Pb)Pb=Pb or{}local Qb=Pb.color;local Rb=Ob*Ob;local Sb=Ob;for y=0,Ob do Sb=Sb+1;repeat Sb=Sb-1 until Sb*Sb+y*y<=Rb;for x2=0,Sb do Lb.Data[Mb+x2]=Lb.Data[Mb+x2]or{}Lb.Data[Mb-x2]=Lb.Data[Mb-x2]or{}Lb.Data[Mb+x2][Nb+y]='1'Lb.Data[Mb-x2][Nb+y]='1'Lb.Data[Mb+x2][Nb-y]='1'Lb.Data[Mb-x2][Nb-y]='1'Lb.Color[Mb+x2]=Lb.Color[Mb+x2]or{}Lb.Color[Mb-x2]=Lb.Color[Mb-x2]or{}Lb.Color[Mb+x2][Nb+y]=Qb;Lb.Color[Mb-x2][Nb+y]=Qb;Lb.Color[Mb+x2][Nb-y]=Qb;Lb.Color[Mb-x2][Nb-y]=Qb end end;return Lb end;local Kb={}W.Circle=function(Lb,Mb,Nb,Ob,Pb)local Qb=nil;if Kb[Ob]then else Kb[Ob]=W.CircleGen(W.New(),0,0,Ob)end;local Rb=Pb and Pb.color;Qb=Kb[Ob]for Sb,Tb in pairs(Qb.Data)do for Ub,Vb in pairs(Tb)do local Wb,Xb=Sb+Mb,Ub+Nb;Lb.Data[Wb]=Lb.Data[Wb]or{}Lb.Data[Wb][Xb]=Vb;Lb.Color[Wb]=Lb.Color[Wb]or{}Lb.Color[Wb][Xb]=Rb end end;return Lb end;W.New=function()return{Data={},Color={}}end;g=W end;local function X(Fb,Gb)local Hb=math.floor(Gb.p)local Ib,Jb=G-H,G+H;for y=Ib,Jb do local Kb=Fb.Data[Hb]and Fb.Data[Hb][y]if Kb=='0'or Kb==nil then Fb.Data[Hb]=Fb.Data[Hb]or{}Fb.Data[Hb][y]='1'end end end;local function Y(Fb,Gb,Hb)Hb=Hb or Gb.p;W.Circle(Fb,math.floor(Hb),G,F*Gb.radius,M[Gb.type])end;local function Z(Fb,Gb,Hb,Ib,Jb,Kb)local Lb=Kb or{}color=Lb.color;local Mb=(I-D)if Gb<Mb then Gb=Mb end;local Nb=(J+D)if Hb>Nb then Hb=Nb end;for y=Ib,Jb do for x=Gb,Hb do Fb.Data[x]=Fb.Data[x]or{}Fb.Data[x][y]='1'if color then Fb.Color[x]=Fb.Color[x]or{}Fb.Color[x][y]=color end end end end;local function ab(Fb,Gb)local Hb=Gb.type;if Hb==1 or Hb==2 or Hb==3 or Hb==4 then Y(Fb,Gb)elseif Hb==5 or Hb==6 then Y(Fb,Gb)local Ib=Gb.endnote;local Jb=(Ib.ms-Gb.ms)*Gb.speed;Y(Fb,Gb)local Kb=F*Gb.radius;local Lb,Mb=math.floor(Gb.p),math.floor(Gb.p+Jb)local Nb=math.floor(G-Kb)local Ob=math.floor(G+Kb)Z(Fb,Lb,Mb,Nb,Ob,M[Gb.type])elseif Hb==8 then Y(Fb,Gb.startnote,Gb.p)end end;local function bb(Fb,Gb,Hb)local Ib=P/ (O/2)local Jb=-Ib*math.abs(( (Hb-Gb.startms)/ (N/O))- (P/Ib))+P;local Kb=U[Gb.status]local Lb=Kb.Offset;local Mb=Kb.Color.All;local Nb,Ob=0,-math.floor(F*1.6)-8 -math.floor(Jb)for Pb,Qb in pairs(Kb.Data)do for Rb,Sb in pairs(Qb)do if Sb=='1'then local Tb,Ub=Pb+Lb[1]+Nb,Rb+Lb[2]+Ob;Fb.Data[Tb]=Fb.Data[Tb]or{}Fb.Data[Tb][Ub]=Sb;Fb.Color[Tb]=Fb.Color[Tb]or{}Fb.Color[Tb][Ub]=Mb end end end end;local function cb(Fb,Gb)local Hb=V[Gb.status]local Ib=Hb.Offset;local Jb=Hb.Color.All;local Kb,Lb=0,0;for Mb,Nb in pairs(Hb.Data)do for Ob,Pb in pairs(Nb)do if Pb=='1'then local Qb,Rb=Mb+Ib[1]+Kb,Ob+Ib[2]+Lb;Fb.Data[Qb]=Fb.Data[Qb]or{}Fb.Data[Qb][Rb]=Pb;Fb.Color[Qb]=Fb.Color[Qb]or{}Fb.Color[Qb][Rb]=Jb end end end end;local db={ClearScreen=function()io.write("\27[2J")end,SetCursor=function(Fb,Gb)io.write(string.format("\27[%d;%dH",Gb,Fb))end}local eb=Taiko.GetAllNotes(l.Data)local fb=l.Metadata.OFFSET;local gb=1000 /60;local hb=l.Metadata.TIMING(gb)local function ib(Fb)return(Fb.data=='note')or(Fb.data=='event'and Fb.event=='barline')end;local function jb(Fb,Gb)return Gb- (( (J+D)/math.abs(Fb.speed)))end;local function kb(Fb,Gb)return(Fb.ms-Gb)*Fb.speed+K end;local function lb(Fb,Gb)return Fb.loadp- (Fb.speed* (Gb-Fb.loadms))end;local mb={}for Fb,Gb in pairs(eb)do Gb.ms=Gb.oms or Gb.ms;Gb.oms=Gb.ms;Gb.ms=(Gb.ms-fb)/w;Gb.s=MsToS(Gb.ms)Gb.speed=(Taiko.CalculateSpeed(Gb,F))*v;Gb.loadms=jb(Gb,Gb.ms)Gb.loads=MsToS(Gb.loadms)Gb.loadp=kb(Gb,Gb.loadms)Gb.hit=nil;table.insert(mb,Gb.ms)end;for Fb,Gb in pairs(l.Data)do if Gb.branch then for Hb,Ib in pairs(Gb.branch.paths)do table.sort(Ib,function(Jb,Kb)return Jb.loadms<Kb.loadms end)end end end;table.sort(l.Data,function(Fb,Gb)if Fb.branch and Gb.branch then for Hb,Ib in pairs(Fb.branch.paths)do for Jb,Kb in pairs(Gb.branch.paths)do return Ib[1].loadms<Kb[1].loadms end end elseif Fb.branch then for Hb,Ib in pairs(Fb.branch.paths)do return Ib[1].loadms<Gb.loadms end elseif Gb.branch then for Hb,Ib in pairs(Gb.branch.paths)do return Fb.loadms<Ib[1].loadms end else return Fb.loadms<Gb.loadms end end)Taiko.ConnectAll(l.Data)Taiko.ForAll(l.Data,function(Fb,Gb,Hb)Fb.n=Hb end)local nb=math.max(unpack(mb))+ (E/w)local ob={s=1,e=0,n=0}local pb=l.Data[1]local qb=pb.loads;ob.e=ob.n;local rb=10;local sb=string.rep(' ',rb)local tb={}local function ub(Fb,Gb)table.insert(tb,Fb)table.insert(tb,': ')table.insert(tb,tostring(Gb))table.insert(tb,sb)table.insert(tb,'\n')end;local function vb()print(table.concat(tb))tb={}end;local wb=''local function xb(Fb)wb=wb..'\n'..Fb end;local function yb()print(wb)end;db.ClearScreen()local zb='M'local Ab={startms=nil,status=nil}local Bb={-1,nil}local Cb=0;local Db=0;if q then local Fb=1 /q;local Gb=nil end;local Eb=os.clock()if q then nextframes=Eb+frames end;if not p.on then while true do local Fb=W.New()local Gb=os.clock()local Hb=Gb-Eb;local Ib=Hb*1000;if pb then if pb.loadms<Ib then ob.n=ob.n+1;ob.e=pb.n;ob[pb.n]=pb;pb=pb.nextnote;if pb and pb.branch then pb=pb.branch.paths[zb][1]end end else if Ib>nb then break end end;W.Circle(Fb,math.floor(K),G,F,{color='purple'})local Jb={}local Kb={}for i=ob.s,ob.e do local Pb=ob[i]if Pb then if Pb.data=='note'then if(Pb.type==1 or Pb.type==3)and(not Jb[1]or math.abs(Ib-Pb.ms)<Jb[1])then Jb[1]=math.abs(Ib-Pb.ms)Kb[1]=Pb elseif(Pb.type==2 or Pb.type==4)and(not Jb[2]or math.abs(Ib-Pb.ms)<Jb[2])then Jb[2]=math.abs(Ib-Pb.ms)Kb[2]=Pb end end;Pb.p=lb(Pb,Ib)if math.abs(Pb.p-K)> (J+D+1)then if Pb.endnote and Pb.endnote.done~=true then else Pb.done=true;ob[i]=nil;if pb and ob.n==0 then ob.s=pb.n elseif Pb.n==ob.s then if Pb.n==ob.e then ob.n=0 else local Qb=ob.s;repeat Qb=Qb+1;ob.n=ob.n-1 until ob[Qb]ob.s=Qb end end end else if Pb.data=='event'then if Pb.event=='barline'then X(Fb,Pb)end elseif Pb.data=='note'then ab(Fb,Pb)else error('Invalid note.data')end end end end;if Ab.status then if Ib>Ab.startms+N then Ab={}else bb(Fb,Ab,Ib)end end;db.SetCursor(1,1)if q then local Pb=W.Convert.ToDots(Fb)repeat until os.clock()>=nextframes;nextframes=nextframes+frames;print(Pb)else print(W.Convert.ToDots(Fb))end;Cb=Cb+1;local Lb=os.clock()-Gb;Db=Db+Lb;local Mb=S.getch(T)local Nb=S.getkeyname(Mb)local Ob=x.Hit[Nb]if s then local Pb=Jb[1]local Qb=Jb[2]local Rb=(Jb[1]and Jb[2])and( (Jb[1]<Jb[2])and 1 or 2)or(Jb[1]and 1 or 2)local Sb=Jb[Rb]local Tb=Kb[Rb]if Sb and Ib>Tb.ms and(not Tb.hit)then if u then Ob=Rb else Tb.hit=true;local Ub=Tb.type;local Vb=( (Ub==3 or Ub==4)and 3)or 2;Ab={startms=Ib,status=Vb}end end end;if Ob and Jb[Ob]and(not Kb[Ob].hit)then local Pb=Jb[Ob]local Qb;local Rb=Kb[Ob].type;local Sb=( (Rb==3 or Rb==4)and Taiko.Data.BigLeniency)or 1;if Pb< (hb.good)then local Tb=Kb[Ob].type;Qb=( (Tb==3 or Tb==4)and 3)or 2 elseif Pb< (hb.ok*Sb)then Qb=1 elseif Pb< (hb.bad*Sb)then Qb=0 else Qb=nil end;if Qb then Kb[Ob].hit=true;Ab={startms=Ib,status=Qb}end end;if x.Escape[Nb]then local Pb=os.clock()db.ClearScreen()S.nodelay(T,false)local Qb={'Back','Retry','Back to Select'}while true do db.SetCursor(1,1)local Rb={}for i=1,#Qb do Rb[i]=( (i==z)and(B..string.rep(' ',A-#B))or string.rep(' ',A))..Qb[i]end;print(table.concat(Rb,C))local Sb=S.getch(T)local Tb=S.getkeyname(Sb)if x.L[Tb]then z=z==1 and 1 or z-1 elseif x.R[Tb]then z=z==3 and 3 or z+1 elseif x.Select[Tb]then if z==1 then elseif z==2 then return'Retry'elseif z==3 then return nil end;break elseif x.Escape[Tb]then break end end;S.nodelay(T,true)Eb=Eb+ (os.clock()-Pb)end;if Mb~=-1 then Bb={Mb,Nb}end;ub('Input (ascii)',Bb[1])ub('Input (key)',Bb[2])ub('S',Hb)ub('Ms',Ib)ub('Loaded',ob.n)ub('Frames Rendered',Cb)ub('Last Frame Render (s)',Lb)ub('Last Frame Render (ms)',Lb*1000)ub('Frame Render Total (s)',Db)ub('Frame Render Total (ms)',Db*1000)ub('Frame Render Total (%)',Db/Hb*100)ub('FPS (Frame)',Cb/Hb)ub('Memory Usage (mb)',collectgarbage('count')/1000)ub('Finished (%)',Ib/ (nb)*100)ub('Nearest1 (ms)',Jb[1])ub('Nearest2 (ms)',Jb[2])ub('Song Name',l.Metadata.TITLE)ub('Difficulty (id)',l.Metadata.COURSE)ub('Stars',l.Metadata.LEVEL)vb()yb()end else error('Prerendering has been removed')end;return true end;function Taiko.SongSelect(l,m)local n={}local o,p=10,10;local q,r,s,u=-o,o,-p,p;local v=true;local w=1;local x=1;local y=4;local z=5;local A=5;local B=2;local C='V'local D='>'local E=10;local F=nil;local G='>'local H='>'local I=2;local J=true;local K={[2]={'Normal','Auto'},[3]={'Normal','2x Speed','3x Speed','4x Speed','0.25x Speed','0.5x Speed','0.75x Speed'},[4]={'Normal','2x Speed','3x Speed','4x Speed','0.25x Speed','0.5x Speed','0.75x Speed'},[5]={'TODO Normal'}}local L={4,1,1,1,1,1}local M={nil}for gb,hb in pairs(K)do M[gb]={1,#hb,hb}end;local N=require('./CompactTJA/compactv4')local O=require('taikocurses')local P={window=O.initscr()}O.keypad(P,true)O.echo(false)O.raw(true)O.nl(false)O.cbreak(true)O.nodelay(P,true)O.getch(P)O.nodelay(P,false)local Q,R=O.cols(),O.lines()F=F or Q-2;local S={Escape={['\27']=true,ALT_ESC=true},Scroll={L={KEY_LEFT=true,KEY_SLEFT=true,CTL_LEFT=true,KEY_B1=true,ALT_LEFT=true,KEY_SHIFT_L=true,KEY_UP=true,KEY_A2=true},R={KEY_RIGHT=true,KEY_SRIGHT=true,CTL_RIGHT=true,KEY_B3=true,ALT_RIGHT=true,KEY_SHIFT_R=true,KEY_DOWN=true,KEY_C2=true}},Select={Init={KEY_ENTER=true,PADENTER=true,CTL_PADENTER=true,ALT_PADENTER=true,CTL_PADCENTER=true,ALT_ENTER=true,CTL_ENTER=true,SHF_PADENTER=true,['\n']=true,['\r']=true},Select={KEY_ENTER=true,PADENTER=true,CTL_PADENTER=true,ALT_PADENTER=true,CTL_PADCENTER=true,ALT_ENTER=true,CTL_ENTER=true,SHF_PADENTER=true,['\n']=true,['\r']=true},Escape={['\27']=true,ALT_ESC=true},L={KEY_LEFT=true,KEY_SLEFT=true,CTL_LEFT=true,KEY_B1=true,ALT_LEFT=true,KEY_SHIFT_L=true},R={KEY_RIGHT=true,KEY_SRIGHT=true,CTL_RIGHT=true,KEY_B3=true,ALT_RIGHT=true,KEY_SHIFT_R=true},U={KEY_UP=true,KEY_A2=true},D={KEY_DOWN=true,KEY_C2=true},Play={Hit={['4']=2,['v']=1,['n']=1,['8']=2},Escape={['\27']=true,ALT_ESC=true},L={KEY_LEFT=true,KEY_SLEFT=true,CTL_LEFT=true,KEY_B1=true,ALT_LEFT=true,KEY_SHIFT_L=true,KEY_UP=true,KEY_DOWN=true},R={KEY_RIGHT=true,KEY_SRIGHT=true,CTL_RIGHT=true,KEY_B3=true,ALT_RIGHT=true,KEY_SHIFT_R=true,KEY_DOWN=true,KEY_C2=true},Select={KEY_ENTER=true,PADENTER=true,CTL_PADENTER=true,ALT_PADENTER=true,CTL_PADCENTER=true,ALT_ENTER=true,CTL_ENTER=true,SHF_PADENTER=true,['\n']=true,['\r']=true}}},Search={Init={ALT_F=true,f=true,F=true},Backspace={['\8']=true,KEY_BACKSPACE=true,ALT_BKSP,CTL_BKSP},FirstResult={KEY_ENTER=true,PADENTER=true,CTL_PADENTER=true,ALT_PADENTER=true,CTL_PADCENTER=true,ALT_ENTER=true,CTL_ENTER=true,SHF_PADENTER=true,['\n']=true,['\r']=true},Select={KEY_RIGHT=true,KEY_SRIGHT=true,CTL_RIGHT=true,KEY_B3=true,ALT_RIGHT=true,KEY_SHIFT_R=true},Up={KEY_A2=true,KEY_UP=true},Down={KEY_C2=true,KEY_DOWN=true},Escape={['\27']=true,ALT_ESC=true}}}local T={ClearScreen=function()io.write("\27[2J")end,SetCursor=function(gb,hb)io.write(string.format("\27[%d;%dH",hb,gb))end}local function U(gb)return gb..string.rep(' ',F-#gb)end;local function V()local gb=O.getch(P)local hb=O.getkeyname(gb)return gb,hb end;local function W(gb)return gb>=32 and gb<=126 end;local function X(gb,hb,ib,jb)return(gb and(hb..string.sub(ib,#hb+1,-1))or ib)..jb end;local function Y(gb,hb,ib)return gb>ib and hb or gb<hb and ib or gb end;local Z={[0]='No',[1]='Yes'}local function ab(gb)return gb and Z[1]or Z[0]end;local function bb(gb)return gb*100 ..'%'end;local function cb(gb)return MsToS(gb)..'s'end;local function db(gb)return cb(SToMs(gb))end;local function eb(gb)return tonumber(gb)and tonumber(gb)or 0 end;local fb={}T.ClearScreen()while true do n={}if v then n[q]={}for i=w-z,w+z do local kb=nil;if i<1 then kb=#l+i elseif i>#l then kb=i-#l else kb=i end;local lb=l[kb]if lb then n[0]=n[0]or{}n[0][(i-w)*A]=lb end end;local ib={}local jb=string.rep(' ',B)for y=s,u do ib[#ib+1]=X(y==0,D,jb,'')ib[#ib+1]=U(n[0][y]or'')ib[#ib+1]='\n'end;T.SetCursor(1,1)print(table.concat(ib))else n[0]={}n[0][s]=C;for i=w-z,w+z do local jb=nil;if i<1 then jb=#l+i elseif i>#l then jb=i-#l else jb=i end;local kb=l[jb]if kb then local lb=(i-w)*A;n[lb]=n[lb]or{}local mb=s+B;for i2=1,#kb do n[lb][mb]=string.sub(kb,i2,i2)mb=mb+1 end end end;local ib={}for y=s,u do for x=q,r do if n[x]and n[x][y]then local jb=n[x][y]if W(string.byte(jb))then ib[#ib+1]=jb else ib[#ib+1]=' 'end else ib[#ib+1]=' 'end end;ib[#ib+1]='\n'end;T.SetCursor(1,1)print(table.concat(ib))end;local gb,hb=V()if S.Scroll.L[hb]then w=w-1 elseif S.Scroll.R[hb]then w=w+1 elseif S.Select.Init[hb]then local ib;if J then if fb[w]then ib=fb[w]else ib=Taiko.ParseTJA(m[w])fb[w]=ib end else ib=Taiko.ParseTJA(m[w])end;local jb={}for nb,ob in pairs(ib)do jb[#jb+1]={nb,ob.Metadata.COURSE}end;table.sort(jb,function(nb,ob)return nb[2]<ob[2]end)min=1;max=#jb;M[x]={min,max,jb}DifficultyMap=jb;local kb=string.rep(' ',I)T.ClearScreen()T.SetCursor(1,1)local lb=nil;local mb=x;while true do T.SetCursor(1,1)local nb=DifficultyMap[L[1]][2]lb=Taiko.GetDifficulty(ib,nb)local ob=lb.Metadata;local pb=Taiko.Analyze(lb)local qb={{'',ob.TITLE},{'\t',ob.SUBTITLE},{'',''},{'','Select Options:'},{X(x==1,H,kb,'Difficulty: '),Taiko.Data.CourseName[ob.COURSE]},{X(x==2,H,kb,'Mode: '),K[2][L[2]]},{X(x==3,H,kb,'Note Speed: '),K[3][L[3]]},{X(x==4,H,kb,'Song Speed: '),K[4][L[4]]},{X(x==5,H,kb,'Modifiers: '),K[5][L[5]]},{'',''},{'Difficulty: ',Taiko.Data.CourseName[ob.COURSE]},{'Stars: ',ob.LEVEL},{'Diverge Notes: ',ab(ob.DIVERGENOTES)},{'',''},{'','Statistics:'},{'Don (DON) / Ka (KA): ',eb(pb.notes[1])..' + ('..eb(pb.notes[3])..') / '..eb(pb.notes[2])..' + ('..eb(pb.notes[4])..') = '..bb((eb(pb.notes[1])+eb(pb.notes[3]))/pb.notes.validn)..' / '..bb((eb(pb.notes[2])+eb(pb.notes[4]))/pb.notes.validn)},{'Max Score (without drumroll): ',pb.maxscore},{'Max Combo: ',pb.maxcombo},{'Drumroll Time (total): ',cb(pb.drumrollms+pb.drumrollbigms)},{'Balloon Time: ',cb(pb.balloonms)},{'Balloon Hits: ',pb.balloonhit},{'Special Time: ',cb(pb.specialms)},{'Special Hits: ',pb.specialhit},{'',''},{'','Press Enter to Play!'}}for i=1,#qb do local ub=qb[i]print(U(ub[1]..tostring(ub[2])))end;local rb,sb=V()if S.Select.L[sb]then y=y-1 elseif S.Select.R[sb]then y=y+1 elseif S.Select.U[sb]then x=x-1 elseif S.Select.D[sb]then x=x+1 elseif S.Select.Select[sb]then while true do local ub,vb=Taiko.PlaySong(Taiko.GetDifficulty(ib,nb),P,L,S.Select.Play)if ub and vb then break elseif ub=='Retry'then else break end end;O.nodelay(P,false)elseif S.Select.Escape[sb]then break end;x=ClipN(x,1,5)if x~=mb then y=L[x]mb=x end;local tb=M[x]min,max=tb[1],tb[2]y=Y(y,min,max)L[x]=y end elseif S.Search.Init[hb]then local ib=''local jb={}local kb=1;local lb=nil;local mb=1;T.ClearScreen()T.SetCursor(1,1)print('Searching...')while true do T.SetCursor(#ib+1,2)local nb,ob=V()T.SetCursor(1,2)if S.Search.Backspace[ob]then ib=string.sub(ib,1,-2)elseif S.Search.FirstResult[ob]then lb=jb[1]break elseif S.Search.Select[ob]then lb=jb[mb]break elseif S.Search.Down[ob]then mb=mb+1 elseif S.Search.Up[ob]then mb=mb-1 elseif S.Search.Escape[ob]then break else ib=ib..ob end;print(U(ib))local pb=N.SearchHeaderAll(l,ib)for i=1,E do if pb[i][2]==-math.huge then kb=i-1;break elseif i==E then kb=i end end;mb=ClipN(mb,1,kb)local qb=false;for i=1,E do local rb=pb[i]if qb then print(U(''))else if rb then if rb[2]==-math.huge then qb=true;print(U(''))else print(U((i==mb and G or i)..'. '..pb[i][3]))jb[i]=rb end end end end end;w=(lb and lb[1]or w)or w elseif S.Escape[hb]then return end;w=Y(w,1,#l)end end;local h='./CompactTJA/taikobuipm.tjac'h='./CompactTJA/ESE/06 Classical.tjac'h='./CompactTJA/ESE/ESE.tjac'local i=require('./CompactTJA/compactv4')local j,k=i.Decompress(i.Read(h))Taiko.SongSelect(k,j)error()Taiko.PlaySong(Taiko.GetDifficulty(Taiko.ParseTJA(i.InputFile(h)),'Ura'))
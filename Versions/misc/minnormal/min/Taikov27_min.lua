local j=require('taikocurses')local k=require('./CompactTJA/compactv4')Split=function(p,q)local r={}for s,t in p:gmatch("([^"..q.."]*)("..q.."?)")do table.insert(r,s)if t==''then return r end end end;Trim=function(p)local q=p:gsub("^%s*(.-)%s*$","%1")return q end;TrimLeft=function(p)local q=p:gsub("^%s*(.-)$","%1")return q end;TrimRight=function(p)local q=p:gsub("^(.-)%s*$","%1")return q end;StartsWith=function(p,q)return p:sub(1,#q)==q end;EndsWith=function(p,q)return p:sub(-#q,-1)==q end;Table={}function Table.Clone(p,q)q=q or{}local r=type(p)local s;if r=='table'then if q[p]then s=q[p]else s={}q[p]=s;for t,u in next,p,nil do s[Table.Clone(t,q)]=Table.Clone(u,q)end;setmetatable(s,Table.Clone(getmetatable(p),q))end else s=p end;return s end;ClipN=function(p,q,r)if p<q then return q elseif p>r then return r else return p end end;function Error(p)error(p)end;LineN=nil;function ParseError(p,q,r)Error('Line: '..LineN..'\n'..p..': '..q.. (r and(', '..r)or''))end;function MsToS(p)return p/1000 end;function SToMs(p)return p*1000 end;Taiko={}Taiko.Data={Languages={'','EN','JA','CN','TW','KO'},GenreName={Pop={'pop','j-pop'},Anime={'anime','アニメ'},Kids={'kids','どうよう'},Variety={'variety','バラエティ'},VOCALOID={'vocaloid','ボーカロイド'},Classic={'classic','クラシック'},['Game Music']={'game music','ゲームミュージック'},['Namco Original']={'namco original','ナムコオリジナル'}},CourseId={easy=0,normal=1,hard=2,oni=3,edit=4,tower=5,dan=6,ura=4},CourseName={[0]='Easy','Normal','Hard','Oni','Edit','Tower','Dan','Ura'},RatingMultiplier={[0]=0,[1]=0.5,[2]=1,[3]=2},GogoMultiplier=1.2,ScoreMode={Note={[0]=function(p,q,r,s,t,u)return p+ ( ( (q<200)and(r or 1000)or( (r or 1000)+ (s or 1000)))*Taiko.Data.RatingMultiplier[t]* (u and Taiko.Data.GogoMultiplier or 1))end,[1]=function(p,q,r,s,t,u)return p+ ( (r+math.max(0,s*math.floor((math.min(q,100)-1)/10)))*Taiko.Data.RatingMultiplier[t]* (u and Taiko.Data.GogoMultiplier or 1))end,[2]=function(p,q,r,s,t,u)return math.floor(p+ ( (r+s* ( (q>=100)and 8 or(q>=50)and 4 or(q>=30)and 2 or(q>=10)and 1 or 0))*Taiko.Data.RatingMultiplier[t]* (u and Taiko.Data.GogoMultiplier or 1))/10)*10 end},Drumroll={[0]=function(p,q,r)return p+ ( (q==5 and 300 or q==6 and 600)* (r and Taiko.Data.GogoMultiplier or 1))end,[1]=function(p,q,r)return p+ ( (q==5 and 300 or q==6 and 600)* (r and Taiko.Data.GogoMultiplier or 1))end,[2]=function(p,q,r)return p+ ( (q==5 and 100 or q==6 and 200)* (r and Taiko.Data.GogoMultiplier or 1))end},Balloon={[0]=function(p,q,r)return p+ ( (q==7 and 300)* (r and Taiko.Data.GogoMultiplier or 1))end,[1]=function(p,q,r)return p+ ( (q==7 and 300)* (r and Taiko.Data.GogoMultiplier or 1))end,[2]=function(p,q,r)return p+ ( (q==7 and 300)* (r and Taiko.Data.GogoMultiplier or 1))end},BalloonPop={[0]=function(p,q,r)return p+ ( (q==7 and 5000)* (r and Taiko.Data.GogoMultiplier or 1))end,[1]=function(p,q,r)return p+ ( (q==7 and 5000)* (r and Taiko.Data.GogoMultiplier or 1))end,[2]=function(p,q,r)return p+ ( (q==7 and 5000)* (r and Taiko.Data.GogoMultiplier or 1))end}},Autoscore={[0]=function(p)end,[1]=function(p)end,[2]=function(p)end},SideId={normal=1,ex=2,both=3},SideName={'normal','ex','both'},StyleId={single=1,double=2,couple=2},StyleName={'single','double'},Exam={Condition={g=true,jp=true,jg=true,jb=true,s=true,r=true,h=true,c=true},Scope={m=true,l=true}},Branch={PathId={N=0,E=1,M=2},PathName={[0]='N',[1]='E',[2]='M'},Requirements={r=function()end,p=function()end}},Timing={GetFunction=function(p)return function(q)if p==1 then return{good=5 /2 *q,ok=13 /2 *q,bad=15 /2 *q}else return{good=3 /2 *q,ok=9 /2 *q,bad=13 /2 *q}end end end},StatusId={bad=0,ok=1,good=2,biggood=3},StatusName={[0]='BAD',[1]='OK',[2]='GOOD',[3]='GOOD'},ModeId={['']=0,P1=1,P2=2},ModeName={[0]='',P1,P2},Combo={[1]=true,[2]=true,[3]=true,[4]=true},BigLeniency=2,Notes={ReverseNotes={[0]=0,[1]=2,[2]=1,[3]=4,[4]=3,[5]=5,[6]=6,[7]=7,[8]=8,[9]=9}},Strings={Notes={}}}function Taiko.ParseTJA(p)local q=os.clock()local r=true;local s=true;local t={}local u={Metadata={SUBTITLE='',BPM=120,WAVE='main.mp3',OFFSET=0,DEMOSTART=0,SCOREMODE=1,SONGVOL=100,SEVOL=100,SIDE=3,LIFE=0,GAME='Taiko',HEADSCROLL=1,MOVIEOFFSET=0,COURSE='ONI',LEVEL=0,BALLOON=nil,SCOREINIT,SCOREDIFF,BALLOONNOR=nil,BALLOONEXP=nil,BALLOONMAS=nil,STYLE=1,EXAM1=nil,EXAM2=nil,EXAM3=nil,GAUGEINCR='NORMAL',TOTAL=nil,HIDDENBRANCH=0,DIVERGENOTES=false,SCOREINIT=0,SCOREDIFF=0,STOPSONG=false},Data={}}local function v(O)local P=Taiko.Data.Languages;for i=1,#P do local Q=u.Metadata[O..P[i]]if Q then return Q end end;return nil end;local function w(O,P,Q)local R=tonumber(P)if R then return R else ParseError(O,Q,P)end end;local function x(O,P,Q,R)if P then return P else ParseError(O,Q,R)end end;local function y(O,P,Q)local R={['true']=true,['false']=false,yes=true,no=false,['1']=true,['0']=false,[1]=true,[0]=false}local S=R[P]~=nil;if S then return S else ParseError(O,Q,P)end end;local function z(O,P)local Q=','local R='\\'local S={}local T=''local U=false;for i=1,#P do local V=string.sub(P,i,i)if U then T=T..V;U=false else if V==Q then table.insert(S,T)T=''elseif V==R then U=true else T=T..V end end end;table.insert(S,T)return S end;local function A(O,P,Q)local R=z(O,P)for i=1,#R do R[i]=w(O,R[i],Q,P)end;return R end;local function B(O,P,Q)if P and P~=''then return A(O,P,Q)else return{}end end;local function C(O,P,Q)if P and P~=''then local R=z(O,P,Q)x(O,Taiko.Data.Exam.Condition[R[1]],Q)R[2]=w(O,R[2],Q)R[3]=w(O,R[3],Q)x(O,Taiko.Data.Exam.Scope[R[4]],Q)return R else return{}end end;local D=error;local function E(O)local P=nil;local Q=false;local R=''for i=1,#O do local S=string.sub(O,i,i)if S=='+'or S=='-'then if P then D('There are multiple signs')else P=S end elseif S=='.'then if Q then D('There are multiple decimal points')else R=R..S;Q=true end elseif tonumber(S)then R=R..S end end;if R==''then D('No number was found')end;return tonumber((P or'+')..R)end;local function F(O)local P=tonumber(O)if P then return P end;local Q=string.gsub(O,'[^%d%.%-%+]','')if Q==''then return 0 end;return tonumber(Q)or E(O)or E(Q)end;local function G(O)return string.find(O,'i')end;local function H(O)local P={0,0}local Q=false;local R=''for i=1,#O do local S=string.sub(O,i,i)if S=='+'or S=='-'then P[1]=P[1]+F(R)R=S elseif S=='i'then P[2]=P[2]+F(R)R=''else R=R..S end end;if R~=''then P[1]=P[1]+F(R)end;return P end;local function I(O)return string.find(O,',')end;local function J(O,P)return{O*math.cos(P),O*math.sin(P)}end;local function K(O)return Split(O,',')end;local L={}local function M()local O={settings={noteparse={notes={[0]=true,[1]=true,[2]=true,[3]=true,[4]=true,[5]=true,[6]=true,[7]=true,[8]=true,[9]=true,['A']=true,['B']=true}},command={matchexceptions={}},directionweight={R=0,U=90,L=180,D=270,['0']=0,['1']=90,['2']=270,['3']=45,['4']=315,['5']=180,['6']=135,['7']=225}},bpm=0,ms=0,songstarted=false,timingpoint=nil,sign=4 /4,mpm=0,mspermeasure=0,scroll=1,scrollx=-1,scrolly=0,measuredone=true,currentmeasure={},measurepushto=u.Data,barline=true,insertbarline=true,gogo=false,lastlong=nil,balloonn=1,currentbranch=nil,branch={on=false,requirements={},paths={}},msbeforebranch=nil,section=false,disablescroll=false,stopsong=false,delay=0,suddenappear=nil,suddenmove=nil,notechain={}}function O.createnote(P)if P then local Q={ms=nil,data=nil,type=P,txt=nil,gogo=O.gogo,scroll=(O.scroll*u.Metadata.HEADSCROLL),scrollx=(O.scrollx*u.Metadata.HEADSCROLL),scrolly=(O.scrolly*u.Metadata.HEADSCROLL),mspermeasure=O.mspermeasure,bpm=O.bpm,nextnote=nil,radius=1,requiredhits=nil,length=nil,endnote=nil,section=nil,text=nil,delay=O.delay,appearancems=O.suddenappear,movems=O.suddenmove,dummy=O.dummy,onnotepush=nil,line=LineN}if P==3 or P==4 or P==6 then Q.radius=Q.radius*1.6 end;if P==5 or P==6 or P==7 or P==9 then if O.lastlong then if P==9 then else ParseError('parser.noteparse','Last long note has not ended')end else O.lastlong=Q;if P==7 or P==9 then Q.requiredhits=x('parser.noteparse',u.Metadata.BALLOON[O.balloonn],'Invalid number of balloons',O.balloonn)O.balloonn=O.balloonn+1 end end end;if P==8 then local R=O.lastlong;O.lastlong=nil;Q.startnote=R;if R then Q.onnotepush=function()R.length=Q.ms-R.ms;R.endnote=Q end else end end;if O.section then Q.section=true;O.section=false end;return Q else return{ms=nil,data=nil,type=nil,txt=nil,gogo=O.gogo,scroll=(O.scroll*u.Metadata.HEADSCROLL),scrollx=(O.scrollx*u.Metadata.HEADSCROLL),scrolly=(O.scrolly*u.Metadata.HEADSCROLL),mspermeasure=O.mspermeasure,bpm=O.bpm,nextnote=nil,delay=O.delay,appearancems=O.suddenappear,movems=O.suddenmove,line=LineN}end end;function O.createbarline()local P=O.createnote()P.ms=O.ms;P.data='event'P.event='barline'return P end;function O.endbranch()local P=O.createnote()P.data='event'P.event='branch'P.branch={requirements=O.branch.requirements,paths=O.branch.paths}O.branch.on=false;O.branch.requirements={}O.branch.paths={}table.insert(u.Data,P)O.measurepushto=u.Data end;return O end;L=M()local N=Split(p,'\n')for i=1,#N do LineN=i;local O=Trim(N[i])if StartsWith(O,'//')or O==''then else local P=string.find(O,'//')if P then O=string.sub(O,1,P-1)end;local Q=false;if L.songstarted==false and Q==false then local R={string.match(O,'(%u+):(.*)')}if R[1]then local S=Trim(R[2])if S~=''then u.Metadata[Trim(R[1])]=S end;Q=true end end;if(L.songstarted or StartsWith(O,'#START')or StartsWith(O,'#BMSCROLL')or StartsWith(O,'#HBSCROLL'))and Q==false then local R={string.match(O,'#(%u-)%s(.*)')}if not R[1]then R={string.match(O,'#(%u+)')}end;if R[1]then if R[1]=='START'then if L.songstarted then ParseError(R[1],'Song has already started')else u.OriginalMetadata=Table.Clone(u.Metadata)if R[2]then u.Metadata.MODE=x(R[1],Taiko.Data.ModeId[R[2]],'Invalid mode',R[2])else u.Metadata.MODE=0 end;u.Metadata.TITLE=x(R[1],v('TITLE'),'Title is missing')u.Metadata.SUBTITLE=x(R[1],v('SUBTITLE'),'Subtitle is missing')u.Metadata.BPM=w(R[1],u.Metadata.BPM,'Invalid bpm')u.Metadata.OFFSET=SToMs(w(R[1],u.Metadata.OFFSET,'Invalid offset'))u.Metadata.DEMOSTART=SToMs(w(R[1],u.Metadata.DEMOSTART,'Invalid demostart'))if u.Metadata.DEMOSTART==0 then u.Metadata.DEMOSTART=nil end;for V,W in pairs(Taiko.Data.GenreName)do for i=1,#W do if W[i]==u.Metadata.GENRE then u.Metadata.GENRE=V end end end;u.Metadata.SCOREMODE=w(R[1],u.Metadata.SCOREMODE,'Invalid scoremode')x(R[1],Taiko.Data.ScoreMode.Note[u.Metadata.SCOREMODE],'Invalid scoremode',u.Metadata.SCOREMODE)if u.Metadata.MAKER then u.Metadata.CREATORURLT={}u.Metadata.CREATOR=Trim(string.gsub(u.Metadata.MAKER,'(<.->)',function(V)table.insert(u.Metadata.CREATORURLT,string.sub(V,2,-2))return''end))u.Metadata.CREATORURL=table.concat(u.Metadata.CREATORURLT,', ')u.Metadata.CREATIVE=false else u.Metadata.CREATIVE=false end;u.Metadata.SONGVOL=w(R[1],u.Metadata.SONGVOL,'Invalid songvol')/100;u.Metadata.SEVOL=w(R[1],u.Metadata.SEVOL,'Invalid sevol')/100;local S=tonumber(u.Metadata.SIDE)if S then x(R[1],Taiko.Data.SideName[S],'Invalid side id',u.Metadata.SIDE)u.Metadata.SIDE=S else u.Metadata.SIDE=x(R[1],Taiko.Data.SideId[string.lower(u.Metadata.SIDE)],'Invalid side name',u.Metadata.SIDE)end;u.Metadata.LIFE=w(R[1],u.Metadata.LIFE,'Invalid life')if u.Metadata.LIFE==0 then u.Metadata.LIFE=nil end;u.Metadata.GAME=string.lower(u.Metadata.GAME)if u.Metadata.GAME=='taiko'then elseif u.Metadata.GAME=='jube'then else end;u.Metadata.HEADSCROLL=w(R[1],u.Metadata.HEADSCROLL,'Invalid headscroll')u.Metadata.MOVIEOFFSET=w(R[1],u.Metadata.MOVIEOFFSET,'Invalid movieoffset')local T=tonumber(u.Metadata.COURSE)if T then x(R[1],Taiko.Data.CourseName[T],'Invalid course id',u.Metadata.COURSE)u.Metadata.COURSE=T else u.Metadata.COURSE=x(R[1],Taiko.Data.CourseId[string.lower(u.Metadata.COURSE)],'Invalid course name',u.Metadata.COURSE)end;u.Metadata.TIMING=Taiko.Data.Timing.GetFunction(u.Metadata.COURSE)u.Metadata.LEVEL=ClipN(math.floor(w(R[1],u.Metadata.LEVEL,'Invalid level')),0,10)u.Metadata.BALLOON=B(R[1],u.Metadata.BALLOON,'Invalid balloon')u.Metadata.SCOREINIT=w(R[1],u.Metadata.SCOREINIT,'Invalid scoreinit')u.Metadata.SCOREDIFF=w(R[1],u.Metadata.SCOREDIFF,'Invalid scoreinit')u.Metadata.BALLOONNOR=B(R[1],u.Metadata.BALLOONNOR,'Invalid balloonnor')u.Metadata.BALLOONEXP=B(R[1],u.Metadata.BALLOONEXP,'Invalid balloonexp')u.Metadata.BALLOONMAS=B(R[1],u.Metadata.BALLOONMAS,'Invalid balloonmas')local U=tonumber(u.Metadata.STYLE)if U then x(R[1],Taiko.Data.StyleName[U],'Invalid style id',Taiko.Data.STYLE)u.Metadata.STYLE=U else u.Metadata.STYLE=x(R[1],Taiko.Data.StyleId[string.lower(u.Metadata.STYLE)],'Invalid style name',u.Metadata.STYLE)end;u.Metadata.EXAM1=C(u.Metadata.EXAM1)u.Metadata.EXAM2=C(u.Metadata.EXAM2)u.Metadata.EXAM3=C(u.Metadata.EXAM3)u.Metadata.GAUGEINCR=string.lower(u.Metadata.GAUGEINCR)if u.Metadata.TOTAL then u.Metadata.TOTAL=w(R[1],u.Metadata.TOTAL,'Invalid total')end;u.Metadata.HIDDENBRANCH=y(R[1],u.Metadata.HIDDENBRANCH,'Invalid hiddenbranch')L.bpm=u.Metadata.BPM;L.songstarted=true end elseif R[1]=='END'then if L.songstarted then if#L.currentmeasure~=0 then ParseError(R[1],'Current measure is not empty')end;table.insert(t,u)u={Metadata=Table.Clone(u.OriginalMetadata),Data={}}L=M()L.songstarted=false;L.measurepushto=u.Data else ParseError(R[1],'Song has already ended')end elseif R[1]=='MEASURE'then local S,T=string.match(R[2],'(%d+)/(%d+)')S=w(R[1],S,'Invalid measure')T=w(R[1],T,'Invalid measure')L.sign=(S/T)or L.sign elseif R[1]=='BPMCHANGE'then L.bpm=w(R[1],R[2],'Invalid bpmchange')or L.bpm elseif R[1]=='DELAY'then local S=SToMs((w(R[1],R[2],'Invalid delay')or 0))L.delay=L.delay+S;table.insert(L.currentmeasure,{'DELAY',S})elseif R[1]=='SCROLL'then if L.disablescroll then else if s and G(R[2])then local S=H(R[2])L.scrollx=-S[1]L.scrolly=-S[2]elseif s and I(R[2])then local S=A(R[1],R[2],'Invalid polar scroll')if#S==3 then local T=J(S[1],math.rad(S[3]/S[2]*360))L.scrollx=-T[1]L.scrolly=-T[2]else ParseError(R[1],'Invalid polar scroll')end else L.scrollx=- (w(R[1],R[2],'Invalid scroll')or-L.scrollx)L.scrolly=0 end;L.scroll=-L.scrollx;if L.scroll==0 and L.scrollx==0 and L.scrolly==0 then ParseError(R[1],'Scroll cannot be 0')end end elseif R[1]=='GOGOSTART'then L.gogo=true elseif R[1]=='GOGOEND'then L.gogo=false elseif R[1]=='BARLINEOFF'then L.barline=false elseif R[1]=='BARLINEON'then L.barline=true elseif R[1]=='BRANCHSTART'then if L.branch.on then L.endbranch()end;L.msbeforebranch=L.ms;L.branch.on=true;u.Metadata.DIVERGENOTES=true;local S=z(R[1],R[2])local T=x(R[1],Taiko.Data.Branch.Requirements[string.lower(S[1])],'Invalid type',S[1])L.branch.requirements={T}local U=2;while true do if not S[U]then break end;local V=Taiko.Data.Branch.PathName[U-1]if V then L.branch.requirements[V]=S[U]else break end;U=U+1 end elseif Taiko.Data.Branch.PathId[R[1]]then if L.branch.on then L.ms=L.msbeforebranch;L.currentbranch=R[1]L.branch.paths[R[1]]={}L.measurepushto=L.branch.paths[R[1]]else ParseError(R[1],'Branch has not started')end elseif R[1]=='BRANCHEND'then if L.branch.on then L.endbranch()else ParseError(R[1],'Branch has already ended')end elseif R[1]=='SECTION'then L.section=true elseif R[1]=='LYRIC'then elseif R[1]=='LEVELHOLD'then elseif R[1]=='BMSCROLL'then L.disablescroll=true;u.Metadata.STOPSONG=true elseif R[1]=='HBSCROLL'then u.Metadata.STOPSONG=true elseif R[1]=='SENOTECHANGE'then elseif R[1]=='NEXTSONG'then elseif R[1]=='DIRECTION'then local S=R[2]local T=L.settings.directionweight;local U=0;local V=0;for i=1,#S do local Z=string.sub(S,i,i)if T[Z]then U=U+T[Z]V=V+1 end end;if V==0 then ParseError(R[1],'Invalid direction')end;local W=U/V;local X=math.sqrt(L.scrollx^2 +L.scrolly^2)local Y=J(X,math.rad(W))L.scrollx=-Y[1]L.scrolly=-Y[2]elseif R[1]=='SUDDEN'then local S=K(R[2])L.suddenappear=SToMs(tonumber(S[1]))L.suddenmove=SToMs(tonumber(S[2]))elseif R[1]=='JPOSSCROLL'then elseif s then if R[1]=='GAMEMODE'then elseif R[1]=='SPLITLANE'then elseif R[1]=='MERGELANE'then elseif R[1]=='BARLINE'then table.insert(L.measurepushto,L.createbarline())elseif R[1]=='DUMMYSTART'then L.dummy=true elseif R[1]=='DUMMYEND'then L.dummy=false elseif R[1]==''then elseif R[1]==''then elseif R[1]==''then elseif R[1]==''then elseif R[1]==''then elseif R[1]==''then elseif R[1]==''then elseif R[1]==''then elseif R[1]==''then elseif R[1]==''then elseif R[1]==''then elseif R[1]==''then elseif R[1]==''then elseif R[1]==''then elseif R[1]==''then elseif R[1]==''then elseif R[1]==''then elseif R[1]==''then end else end;Q=true end end;if(L.songstarted)and Q==false then L.mpm=L.bpm*L.sign/4;L.mspermeasure=60000 *L.sign*4 /L.bpm;if L.barline and L.insertbarline then table.insert(L.measurepushto,L.createbarline())L.insertbarline=false end;for i=1,#O do local R=string.sub(O,i,i)local S=tonumber(R)or R;if L.settings.noteparse.notes[S]then local T=L.createnote(S)T.data='note'table.insert(L.currentmeasure,T)end end;if EndsWith(TrimRight(O),',')then L.mpm=L.bpm*L.sign/4;L.mspermeasure=60000 *L.sign*4 /L.bpm;if#L.currentmeasure==0 then L.ms=L.ms+L.mspermeasure elseif#L.currentmeasure==1 and L.currentmeasure[1].data=='event'and L.currentmeasure[1].event=='barline'then u.Data[#u.Data+1]=L.currentmeasure[1]L.ms=L.ms+L.mspermeasure else local R=0;local S=nil;for i=1,#L.currentmeasure do local U=L.currentmeasure[i]if U.data=='note'then S=S or U.mspermeasure;R=R+1 end end;S=S or L.mspermeasure;local T=S/R;for i=1,#L.currentmeasure do local U=L.currentmeasure[i]if U[1]=='DELAY'then L.ms=L.ms+U[2]else if not r or U.type~=0 then U.ms=L.ms;U.appearancems=U.appearancems and(U.ms- (U.appearancems))U.movems=U.movems and(U.ms- (U.movems))local V=L.measurepushto[#L.measurepushto]or u.Data[#u.Data]if V then V.nextnote=U end;table.insert(L.measurepushto,U)if U.onnotepush then U.onnotepush()end;T=U.mspermeasure/R end;if U.data=='note'then L.ms=L.ms+T end end end end;L.measuredone=true;L.currentmeasure={}L.insertbarline=true else L.measuredone=false end end end end;print('Parsing Took: '..SToMs(os.clock()-q)..'ms')return t end;function Taiko.SerializeTJA(p)local function q(B)return math.floor(B+0.5)end;local r=5;local s=10 ^r;local function t(B)return math.floor(B*s+0.5)/s end;local function u(B)if math.floor(B)~=B then return string.format('%f',B)else return tostring(B)end end;local function v(B,C)if B<C then return v(C,B)end;if math.abs(C)<0.001 then return B else return v(C,B-math.floor(B/C)*C)end end;local function w(B)local C=v(B,1)return q(B/C),q(1 /C)end;local function x(B)local C,D=string.match(B,'(%d+)/(%d+)')return C,D end;local function y(B)for i=1,#B do B[i]=tostring(B[i])end;return table.concat(B,',')end;local function z(B)local C={}local D={OFFSET=true,DEMOSTART=true}for M,N in pairs(B.Metadata)do local O;if type(N)=='number'then if D[M]then O=tostring(MsToS(tonumber(N)))else O=tostring(N)end elseif type(N)=='table'then O=y(N)elseif type(N)=='string'then O=tostring(N)else O=nil end;if O then C[#C+1]=M;C[#C+1]=':'C[#C+1]=O;C[#C+1]='\n'end end;C[#C+1]='\n\n'local E=false;local F=false;local G=B.Metadata.HEADSCROLL;for i=1,#B.Data do local M=B.Data[i]M.ms=M.ms-M.delay;if M.data=='event'and M.event=='barline'then E=true end;if M.delay and M.delay~=0 then F=true end;if M.scroll and M.scroll~=G then G=false end end;if F then if G then C[#C+1]='#BMSCROLL\n'else C[#C+1]='#HBSCROLL\n'end end;C[#C+1]='#START\n'if E then C[#C+1]='#BARLINEON\n'else C[#C+1]='#BARLINEOFF\n'end;local H={startms=nil}local I=nil;local J=0;local K={scroll=0,bpm=B.Metadata.BPM,measure=nil,gogo=false,delay=0}local L={scroll={'#SCROLL ',nil,function(M)local N=M.scroll/B.Metadata.HEADSCROLL;if N~=K.scroll then K.scroll=N;return tostring(N)end end},bpm={'#BPMCHANGE ',tostring(B.Metadata.BPM),function(M)local N=M.bpm;if N~=K.bpm then K.bpm=N;return tostring(N)end end},measure={'#MEASURE ',false,function(M)local N,O=w(M.bpm*M.mspermeasure/240000)local P=N..'/'..O;if P~=K.measure then K.measure=P;return P end end},gogo={'#GOGO',false,function(M)local N=M.gogo;if N~=K.gogo then K.gogo=N;if N then return'START'else return'END'end end end},delay={'#DELAY ',nil,function(M)if M.delay~=K.delay then local N=M.delay-K.delay;K.delay=M.delay;return u(MsToS(N))end end}}for i=1,#B.Data do local M=B.Data[i]local N=M.ms;if M.data=='note'then H[#H+1]=M elseif M.data=='event'and M.event=='barline'then H.startms=M.ms;H[#H+1]=M end;local O=B.Data[i+1]if(O and O.data=='event'and O.event=='barline')or(i==#B.Data)then if#H==0 then error('No barline')else local P={}for i=2,#H do local T=H[i-1]local U=H[i]P[#P+1]=math.abs(U.ms-T.ms)end;P[#P+1]=math.abs((H.startms+H[1].mspermeasure)-H[#H].ms)local Q=P[1]for i=2,#P do Q=v(Q,P[i])end;if Q==nil then error('gcd invalid, probably delay')Q=H[1]and(H[1].ms-J)end;local R=H.startms;local S=R+H[1].mspermeasure;for i2=1,#H do local T=H[i2]for U,V in pairs(L)do if T[U]==V[2]then else local W=V[3](T)if W then V[2]=W;if C[#C]~='\n'then C[#C+1]='\n'end;C[#C+1]=V[1]C[#C+1]=W;C[#C+1]='\n'end end end;if i2 ~=1 then C[#C+1]=tostring(T.type)end;if i2 ==1 and#H~=1 then C[#C+1]=string.rep('0',( (H[i2 +1]and H[i2 +1].ms or S)-T.ms)/Q)else C[#C+1]=string.rep('0',( (H[i2 +1]and H[i2 +1].ms or S)-T.ms)/Q-1)end end;C[#C+1]=','C[#C+1]='\n'H={}end end end;if C[#C]~='\n'then C[#C+1]='\n'end;C[#C+1]='\n#END'return table.concat(C)end;local A={'// Automatically Serialized by Taiko.SerializeTJA'}for B,C in pairs(p)do A[#A+1]=z(C)return table.concat(A,'\n\n')end;A=table.concat(A,'\n\n')return A end;function Taiko.Score(p,q,r,s,t)if s==0 then r=0 else r=r+1 end;local u=p.Metadata;return Taiko.Data.ScoreMode.Note[u.SCOREMODE](q,r,u.SCOREINIT,u.SCOREDIFF,s,t),r end;function Taiko.Analyze(p)local q='M'local r={[1]=2,[2]=2,[3]=3,[4]=3}local s={notes={n=0,validn=0},measures=0,lengthms=0,drumrollms=0,drumrollbigms=0,balloonms=0,balloonhit=0,specialms=0,specialhit=0,maxcombo=0,maxscore=0}local t=nil;Taiko.ForAll(p.Data,function(u,v,w)if u.data=='note'then s.notes.n=s.notes.n+1;s.notes[u.type]=s.notes[u.type]and s.notes[u.type]+1 or 1;if r[u.type]then s.maxscore,s.maxcombo=Taiko.Score(p,s.maxscore,s.maxcombo,r[u.type],u.gogo)end;local x=u.endnote;if x then local y=x.ms-u.ms;if u.type==5 then s.drumrollms=s.drumrollms+y elseif u.type==6 then s.drumrollbigms=s.drumrollbigms+y elseif u.type==7 then s.balloonms=s.balloonms+y;s.balloonhit=s.balloonhit+u.requiredhits elseif u.type==9 then s.specialms=s.specialms+y;s.specialhit=s.specialhit+u.requiredhits else end end;t=u elseif u.data=='event'and u.event=='barline'then s.measures=s.measures+1 else end end,q)s.lengthms=t.ms-p.Metadata.OFFSET;s.notes.validn=s.maxcombo;return s end;function Taiko.GetDifficulty(p,q)local r=Taiko.Data.CourseId[string.lower(q)]or q;for s,t in pairs(p)do if t.Metadata.COURSE==r then return t end end;Error('No difficulty found, '..q)return nil end;function Taiko.ForAll(p,q,r)local s=1;for i=1,#p do local t=p[i]if t.branch then if r then local u=t.branch.paths[r]for i2=1,#u do q(u[i2],i2,s)s=s+1 end;s=s-1 else local u=-1;for w,x in pairs(t.branch.paths)do local y=s;for i2=1,#x do q(x[i2],i2,y)y=y+1 end;u=(u<y)and y or u end;s=u end else q(t,i,s)end;s=s+1 end;return p end;function Taiko.GetAllNotes(p)local q={}for r,s in pairs(p)do if s.branch then for u,w in pairs(s.branch.paths)do for i=1,#w do table.insert(q,w[i])end end else table.insert(q,s)end end;return q end;function Taiko.ConnectNotes(p)local q=nil;for i=#p,1,-1 do local r=p[i]r.nextnote=q;q=r end;return p end;function Taiko.ExtractBranch(p,q)return p.branch.paths[q]end;function Taiko.ConnectAll(p)local q=nil;for i=#p,1,-1 do local r=p[i]if r.branch then for s,t in pairs(r.branch.paths)do local u=Taiko.ConnectNotes(t)u[#u].nextnote=q end else r.nextnote=q end;q=r end end;function Taiko.CalculateSpeed(p,q)local r=(q*p.scrollx*p.bpm/7500)local s=(q*p.scrolly*p.bpm/7500)return{r,s}end;function Taiko.CalculateSpeedAll(p,q)for i=1,#p do p[i].speed=Taiko.CalculateSpeed(p[i],q)end;return p end;function Taiko.RenderScale(p)local q={}local r={}local s={}for i=1,#p.Data do local x=p.Data[i]if x.data=='note'then local y=math.floor(x.ms)if math.floor(y)-y==0 then table.insert(q,{y,x.type})table.insert(r,y)else table.insert(s,i)end end end;function gcd2(x,y)if y==0 then return x else return gcd2(y,x%y)end end;function gcdn(x)local y=x[1]for i=2,#x do y=gcd2(y,x[i])end;return y end;local u=gcdn(r)for i=1,#s do local x=q[s[i]]x[1]=math.floor(x[1]/u)*u end;local v=''local w=0;for i=1,#q do q[i][1]=q[i][1]/u;v=v..string.rep(' ',q[i][1]-w)..q[i][2]w=q[i][1]end;return v end;function Taiko.PlaySong(p,q,r,s)local t={on=false,fps=60,frames={}}local u=nil;local v={auto={[1]=false,[2]=true},notespeedmul={[1]=1,[2]=2,[3]=3,[4]=4,[5]=0.25,[6]=0.5,[7]=0.75},songspeedmul={[1]=1,[2]=2,[3]=3,[4]=4,[5]=0.25,[6]=0.5,[7]=0.75}}local w=v.auto[r[2]]or false;local x=v.notespeedmul[r[3]]or 1;local z=v.songspeedmul[r[4]]or 1;local A=p.Metadata.STOPSONG;local B=s or{}B={Hit=B.Hit or{['4']=2,['v']=1,['n']=1,['8']=2},Escape=B.Escape or{['\27']=true,ALT_ESC=true},L=B.L or{KEY_LEFT=true,KEY_SLEFT=true,CTL_LEFT=true,KEY_B1=true,ALT_LEFT=true,KEY_SHIFT_L=true,KEY_UP=true,KEY_A2=true},R=B.R or{KEY_RIGHT=true,KEY_SRIGHT=true,CTL_RIGHT=true,KEY_B3=true,ALT_RIGHT=true,KEY_SHIFT_R=true,KEY_DOWN=true,KEY_C2=true},Select=B.Select or{KEY_ENTER=true,PADENTER=true,CTL_PADENTER=true,ALT_PADENTER=true,CTL_PADCENTER=true,ALT_ENTER=true,CTL_ENTER=true,SHF_PADENTER=true,['\n']=true,['\r']=true}}local C=1;local D=2;local E='>'local F='\n\n\n'local G=10;local H=50;local I=1000;local J=4;local K=0;local L=10;local M=0;local N=40;local O=3;local P=1;local Q={[1]={color='red'},[2]={color='blue'},[3]={color='red'},[4]={color='blue'},[5]={color='yellow'},[6]={color='yellow'},[7]={color='cyan'}}local R=200;local S=R/4;local T=4;local U=20;N=math.floor(N*J)local V=M+N;O={O*J,0}local W={M,-L*2,V,L*2}local X={W[1]-G,W[2]-G,W[3]+G,W[4]+G}local Y={W[1]-H,W[2]-H,W[3]+H,W[4]+H}local Z=q or{window=j.initscr()}j.keypad(Z,true)j.echo(false)j.raw(true)j.nl(false)j.cbreak(true)j.nodelay(Z,true)local ab={[0]={Data={[1]={'0','1','1','1','1','1','1','1'},[2]={[2]='1',[5]='1',[8]='1'},[3]={[2]='1',[5]='1',[8]='1'},[4]={[2]='1',[5]='1',[8]='1'},[5]={[2]='1',[5]='1',[8]='1'},[6]={[3]='1',[4]='1',[6]='1',[7]='1'},[8]={'0','0','1','1','1','1','1','1'},[9]={[2]='1',[5]='1'},[10]={[2]='1',[5]='1'},[11]={[2]='1',[5]='1'},[12]={[2]='1',[5]='1'},[13]={'0','0','1','1','1','1','1','1'},[15]={'0','1','1','1','1','1','1','1'},[16]={[2]='1',[8]='1'},[17]={[2]='1',[8]='1'},[18]={[2]='1',[8]='1'},[19]={[2]='1',[8]='1'},[20]={'0','0','1','1','1','1','1','0'}},Color={All='blue'},Offset={-1,0}},[1]={Data={[1]={'0','0','1','1','1','1','1','0'},[2]={[2]='1',[8]='1'},[3]={[2]='1',[8]='1'},[4]={[2]='1',[8]='1'},[5]={[2]='1',[8]='1'},[6]={'0','0','1','1','1','1','1','0'},[8]={'0','1','1','1','1','1','1','1'},[9]={[5]='1'},[10]={[4]='1',[6]='1'},[11]={[3]='1',[7]='1'},[12]={[2]='1',[8]='1'}},Color={All='white'},Offset={-1,0}},[2]={Data={[1]={'0','0','1','1','1','1','1','0'},[2]={[2]='1',[8]='1'},[3]={[2]='1',[8]='1'},[4]={[2]='1',[5]='1',[8]='1'},[5]={[2]='1',[5]='1',[8]='1'},[6]={'0','1','0','0','1','1','1','1'},[8]={'0','0','1','1','1','1','1','0'},[9]={[2]='1',[8]='1'},[10]={[2]='1',[8]='1'},[11]={[2]='1',[8]='1'},[12]={[2]='1',[8]='1'},[13]={'0','0','1','1','1','1','1','0'},[15]={'0','0','1','1','1','1','1','0'},[16]={[2]='1',[8]='1'},[17]={[2]='1',[8]='1'},[18]={[2]='1',[8]='1'},[19]={[2]='1',[8]='1'},[20]={'0','0','1','1','1','1','1','0'},[22]={'0','1','1','1','1','1','1','1'},[23]={[2]='1',[8]='1'},[24]={[2]='1',[8]='1'},[25]={[2]='1',[8]='1'},[26]={[2]='1',[8]='1'},[27]={'0','0','1','1','1','1','1','0'}},Color={All='yellow'},Offset={-1,0}},Size={27,8}}ab[3]=ab[2]local bb={[0]=nil,[1]={},[2]={}}local cb;os.execute('chcp 65001')cb={}local db=([[
⠀ ⢀ ⠠ ⢠ ⠐ ⢐ ⠰ ⢰ ⠈ ⢈ ⠨ ⢨ ⠘ ⢘ ⠸ ⢸
⡀ ⣀ ⡠ ⣠ ⡐ ⣐ ⡰ ⣰ ⡈ ⣈ ⡨ ⣨ ⡘ ⣘ ⡸ ⣸
⠄ ⢄ ⠤ ⢤ ⠔ ⢔ ⠴ ⢴ ⠌ ⢌ ⠬ ⢬ ⠜ ⢜ ⠼ ⢼
⡄ ⣄ ⡤ ⣤ ⡔ ⣔ ⡴ ⣴ ⡌ ⣌ ⡬ ⣬ ⡜ ⣜ ⡼ ⣼
⠂ ⢂ ⠢ ⢢ ⠒ ⢒ ⠲ ⢲ ⠊ ⢊ ⠪ ⢪ ⠚ ⢚ ⠺ ⢺
⡂ ⣂ ⡢ ⣢ ⡒ ⣒ ⡲ ⣲ ⡊ ⣊ ⡪ ⣪ ⡚ ⣚ ⡺ ⣺
⠆ ⢆ ⠦ ⢦ ⠖ ⢖ ⠶ ⢶ ⠎ ⢎ ⠮ ⢮ ⠞ ⢞ ⠾ ⢾
⡆ ⣆ ⡦ ⣦ ⡖ ⣖ ⡶ ⣶ ⡎ ⣎ ⡮ ⣮ ⡞ ⣞ ⡾ ⣾
⠁ ⢁ ⠡ ⢡ ⠑ ⢑ ⠱ ⢱ ⠉ ⢉ ⠩ ⢩ ⠙ ⢙ ⠹ ⢹
⡁ ⣁ ⡡ ⣡ ⡑ ⣑ ⡱ ⣱ ⡉ ⣉ ⡩ ⣩ ⡙ ⣙ ⡹ ⣹
⠅ ⢅ ⠥ ⢥ ⠕ ⢕ ⠵ ⢵ ⠍ ⢍ ⠭ ⢭ ⠝ ⢝ ⠽ ⢽
⡅ ⣅ ⡥ ⣥ ⡕ ⣕ ⡵ ⣵ ⡍ ⣍ ⡭ ⣭ ⡝ ⣝ ⡽ ⣽
⠃ ⢃ ⠣ ⢣ ⠓ ⢓ ⠳ ⢳ ⠋ ⢋ ⠫ ⢫ ⠛ ⢛ ⠻ ⢻
⡃ ⣃ ⡣ ⣣ ⡓ ⣓ ⡳ ⣳ ⡋ ⣋ ⡫ ⣫ ⡛ ⣛ ⡻ ⣻
⠇ ⢇ ⠧ ⢧ ⠗ ⢗ ⠷ ⢷ ⠏ ⢏ ⠯ ⢯ ⠟ ⢟ ⠿ ⢿
⡇ ⣇ ⡧ ⣧ ⡗ ⣗ ⡷ ⣷ ⡏ ⣏ ⡯ ⣯ ⡟ ⣟ ⡿ ⣿]]):gsub('\n',' ')function GenerateDotData()function ToBinary(uc)local vc={}while uc>0 do local xc=math.fmod(uc,2)vc[#vc+1]=string.sub(xc,1,1)uc=(uc-xc)/2 end;local wc=string.reverse(table.concat(vc))return string.rep('0',8 -#wc)..wc end;local function oc(uc)return uc end;local pc=Split(db,' ')local qc={}local rc=false;local sc=''local tc=' 'for i=1,#pc do qc[i-1]=oc(pc[i])end;return qc end;cb.Data={}cb.Data.Dot=GenerateDotData()cb.ColorData={reset=0,clear=0,space=0,bright=1,bold=1,dim=2,faint=1,italic=3,underline=4,blink=5,reverse=7,invisible=8,hidden=8,strikethrough=9,black=30,red=31,green=32,yellow=33,blue=34,purple=35,magenta=35,cyan=36,white=37,onblack=40,onred=41,ongreen=42,onyellow=43,onblue=44,onpurple=45,onmagenta=45,oncyan=46,onwhite=47}cb.Color={}for oc,pc in pairs(cb.ColorData)do cb.Color[oc]='\27['..pc..'m'end;local eb,fb=W[1],W[3]local gb,hb=-W[4],-W[2]cb.Convert={}cb.Convert.ToDots=function(oc)local pc,qc=oc.Data,oc.Color;local rc={}local sc=0;local tc=cb.Data.Dot[sc]local uc=nil;local vc=nil;local wc=cb.Color['reset']if oc.Color.All then local xc=cb.Color[oc.Color.All]rc[#rc+1]=xc;vc=xc end;if not gb then return''end;for y=hb,gb,-4 do for x=eb,fb,2 do local xc=pc[x]local yc=pc[x+1]local zc=(xc and( (xc[y]or 0)*128 + (xc[y-1]or 0)*64 + (xc[y-2]or 0)*32 + (xc[y-3]or 0)*16)or 0)+ (yc and( (yc[y]or 0)*8 + (yc[y-1]or 0)*4 + (yc[y-2]or 0)*2 + (yc[y-3]or 0))or 0)if zc~=sc then zc=cb.Data.Dot[zc]if not vc then local Ac=qc[x]local Bc=qc[x+1]local Cc=( (Ac)and(Ac[y]or Ac[y-1]or Ac[y-2]or Ac[y-3]))or( (Bc)and(Bc[y]or Bc[y-1]or Bc[y-2]or Bc[y-3]))if Cc then Cc=cb.Color[Cc]else Cc=wc end;if uc==Cc then else rc[#rc+1]=Cc;uc=Cc end end;rc[#rc+1]=zc else rc[#rc+1]=tc end end;rc[#rc+1]='\n'end;rc[#rc+1]=wc;return table.concat(rc)end;cb.ToDotsParallel=function(oc,pc)local qc,rc=oc.Data,oc.Color;local sc,tc=pc.Data,pc.Color;local uc={}local vc=0;local wc=cb.Data.Dot[vc]local xc=nil;local yc=nil;local zc=cb.Color['reset']if oc.Color.All then local Ac=cb.Color[oc.Color.All]uc[#uc+1]=Ac;yc=Ac end;if not gb then return''end;for y=hb,gb,-4 do for x=eb,fb,2 do local Ac=qc[x]local Bc=qc[x+1]local Cc=sc[x]local Dc=sc[x+1]local Ec=( (Ac and Cc)and( (Ac[y]or Cc[y]or 0)*128 + (Ac[y-1]or Cc[y-1]or 0)*64 + (Ac[y-2]or Cc[y-2]or 0)*32 + (Ac[y-3]or Cc[y-3]or 0)*16)or(Ac)and( (Ac[y]or 0)*128 + (Ac[y-1]or 0)*64 + (Ac[y-2]or 0)*32 + (Ac[y-3]or 0)*16)or(Cc)and( (Cc[y]or 0)*128 + (Cc[y-1]or 0)*64 + (Cc[y-2]or 0)*32 + (Cc[y-3]or 0)*16)or 0)+ ( (Bc and Dc)and( (Bc[y]or Dc[y]or 0)*8 + (Bc[y-1]or Dc[y-1]or 0)*4 + (Bc[y-2]or Dc[y-2]or 0)*2 + (Bc[y-3]or Dc[y-3]or 0))or(Bc)and( (Bc[y]or 0)*8 + (Bc[y-1]or 0)*4 + (Bc[y-2]or 0)*2 + (Bc[y-3]or 0))or(Dc)and( (Dc[y]or 0)*8 + (Dc[y-1]or 0)*4 + (Dc[y-2]or 0)*2 + (Dc[y-3]or 0))or 0)if Ec~=vc then Ec=cb.Data.Dot[Ec]if not yc then local Fc=tc[x]local Gc=tc[x+1]local Hc=rc[x]local Ic=rc[x+1]local Jc=Hc and(Hc[y]or Hc[y-1]or Hc[y-2]or Hc[y-3])or Ic and(Ic[y]or Ic[y-1]or Ic[y-2]or Ic[y-3])or Fc and(Fc[y]or Fc[y-1]or Fc[y-2]or Fc[y-3])or Gc and(Gc[y]or Gc[y-1]or Gc[y-2]or Gc[y-3])if Jc then Jc=cb.Color[Jc]else Jc=zc end;if xc==Jc then else uc[#uc+1]=Jc;xc=Jc end end;uc[#uc+1]=Ec else uc[#uc+1]=wc end end;uc[#uc+1]='\n'end;uc[#uc+1]=zc;return table.concat(uc)end;cb.CircleGen=function(oc,pc,qc,rc,sc)sc=sc or{}local tc=sc.color;local uc=rc*rc;local vc=rc;for y=0,rc do vc=vc+1;repeat vc=vc-1 until vc*vc+y*y<=uc;for x2=0,vc do oc.Data[pc+x2]=oc.Data[pc+x2]or{}oc.Data[pc-x2]=oc.Data[pc-x2]or{}oc.Data[pc+x2][qc+y]='1'oc.Data[pc-x2][qc+y]='1'oc.Data[pc+x2][qc-y]='1'oc.Data[pc-x2][qc-y]='1'oc.Color[pc+x2]=oc.Color[pc+x2]or{}oc.Color[pc-x2]=oc.Color[pc-x2]or{}oc.Color[pc+x2][qc+y]=tc;oc.Color[pc-x2][qc+y]=tc;oc.Color[pc+x2][qc-y]=tc;oc.Color[pc-x2][qc-y]=tc end end;return oc end;local ib={}cb.Circle=function(oc,pc,qc,rc,sc)local tc=nil;if ib[rc]then else ib[rc]=cb.CircleGen(cb.New(),0,0,rc)end;local uc=sc and sc.color;tc=ib[rc]for vc,wc in pairs(tc.Data)do for xc,yc in pairs(wc)do local zc,Ac=vc+pc,xc+qc;oc.Data[zc]=oc.Data[zc]or{}oc.Data[zc][Ac]=yc;oc.Color[zc]=oc.Color[zc]or{}oc.Color[zc][Ac]=uc end end;return oc end;cb.New=function()return{Data={},Color={}}end;local function jb(oc)return(oc.data=='note')or(oc.data=='event'and oc.event=='barline')end;local function kb(oc,pc,qc,rc,sc,tc)return qc<=oc and oc<=sc and rc<=pc and pc<=tc end;local function lb(oc,pc,qc,rc,sc,tc,uc,vc)sc,tc,uc,vc=sc-oc,tc-pc,uc-oc,vc-pc;local wc=rc/qc;if rc<0 then local xc,yc=tc/wc,tc;if sc<=xc and xc<=uc then return xc,yc end else local xc,yc=vc/wc,vc;if sc<=xc and xc<=uc then return xc,yc end end;if qc<0 then local xc,yc=sc,sc*wc;if tc<=yc and yc<=vc then return xc,yc end else local xc,yc=uc,uc*wc;if tc<=yc and yc<=vc then return xc,yc end end;return nil end;local function mb(oc,pc)local qc,rc=lb(0,0,-oc.scrollx,-oc.scrolly,X[1],X[2],X[3],X[4])return pc- (qc~=0 and qc/-oc.speed[1]or rc/-oc.speed[2])end;local function nb(oc,pc)return O[1]+ (-oc.speed[1]* (oc.ms-pc-oc.delay)),- (O[2]+ (oc.speed[2]* (oc.ms-pc-oc.delay)))end;local function ob(oc,pc)local qc=math.floor(pc.p[1])local rc=math.floor(pc.p[2])local sc,tc=rc-L,rc+L;for y=sc,tc do oc.Data[qc]=oc.Data[qc]or{}oc.Data[qc][y]='1'end end;local function pb(oc,pc,qc)qc=qc or pc.p;cb.Circle(oc,math.floor(qc[1]),math.floor(qc[2]),J*pc.radius,Q[pc.type])end;local function qb(oc,pc,qc,rc,sc,tc)pc=math.floor(pc)qc=math.floor(qc)rc=math.floor(rc)sc=math.floor(sc)local uc=tc or{}color=uc.color;for y=qc,sc do for x=pc,rc do oc.Data[x]=oc.Data[x]or{}oc.Data[x][y]='1'if color then oc.Color[x]=oc.Color[x]or{}oc.Color[x][y]=color end end end end;local function rb(oc,pc,qc)local rc=pc.type;if rc==1 or rc==2 or rc==3 or rc==4 then pb(oc,pc)elseif rc==5 or rc==6 then elseif rc==7 then pc.radius=0.8;pb(oc,pc)elseif rc==8 then pb(oc,pc)local sc=pc.startnote;pb(oc,sc)local tc=J*pc.radius;local uc,vc=math.floor(sc.p[1]),math.floor(pc.p[1])pb(oc,sc,pc.p)local wc=math.floor(K-tc)local xc=math.floor(K+tc)if qc then else if uc>vc then uc,vc=vc,uc end;if uc<X[1]then uc=X[1]end;if vc>X[3]then vc=X[3]end end;qb(oc,uc,wc,vc,xc,Q[sc.type])end end;local function sb(oc,pc,qc)local rc=T/ (S/2)local sc=-rc*math.abs(( (qc-pc.startms)/ (R/S))- (T/rc))+T;local tc=ab[pc.status]local uc=tc.Offset;local vc=tc.Color.All;local wc,xc=0,-math.floor(J*1.6)-8 -math.floor(sc)local yc,zc=uc[1]+wc,uc[2]+xc;for x=1,ab.Size[1]do for y=1,ab.Size[2]do local Ac,Bc=x+yc,y+zc;oc.Data[Ac]=oc.Data[Ac]or{}oc.Data[Ac][-Bc]=tc.Data[x]and tc.Data[x][y]oc.Color[Ac]=oc.Color[Ac]or{}oc.Color[Ac][-Bc]=vc end end end;local function tb(oc,pc)local qc=bb[pc.status]local rc=qc.Offset;local sc=qc.Color.All;local tc,uc=0,0;for vc,wc in pairs(qc.Data)do for xc,yc in pairs(wc)do if yc=='1'then local zc,Ac=vc+rc[1]+tc,xc+rc[2]+uc;oc.Data[zc]=oc.Data[zc]or{}oc.Data[zc][Ac]=yc;oc.Color[zc]=oc.Color[zc]or{}oc.Color[zc][Ac]=sc end end end end;local ub={ClearScreen=function()io.write("\27[2J")end,SetCursor=function(oc,pc)io.write(string.format("\27[%d;%dH",pc,oc))end}local vb=Taiko.GetAllNotes(p.Data)local wb=p.Metadata.OFFSET;local xb=1000 /60;local yb=p.Metadata.TIMING(xb/z)local zb={}for oc,pc in pairs(vb)do pc.ms=pc.oms or pc.ms;pc.oms=pc.ms;pc.ms=(pc.ms-wb)/z;pc.s=MsToS(pc.ms)pc.delay=pc.odelay or pc.delay;pc.odelay=pc.delay;pc.p={}pc.delay=pc.delay/z;pc.speed=Taiko.CalculateSpeed(pc,J)pc.speed[1]=pc.speed[1]*x;pc.speed[2]=pc.speed[2]*x;pc.loadms=mb(pc,pc.ms)pc.loads=MsToS(pc.loadms)pc.hit=nil;zb[#zb+1]=pc.ms end;if A then for rc,sc in pairs(p.Data)do if sc.branch then for tc,uc in pairs(sc.branch.paths)do table.sort(uc,function(vc,wc)return vc.ms<wc.ms end)end end end;table.sort(p.Data,function(rc,sc)if rc.branch and sc.branch then for tc,uc in pairs(rc.branch.paths)do for vc,wc in pairs(sc.branch.paths)do return uc[1].ms<wc[1].ms end end elseif rc.branch then for tc,uc in pairs(rc.branch.paths)do return uc[1].ms<sc.ms end elseif sc.branch then for tc,uc in pairs(sc.branch.paths)do return rc.ms<uc[1].ms end else return rc.ms<sc.ms end end)local oc=nil;local pc=0;local qc={}Taiko.ForAll(p.Data,function(rc,sc,tc)if rc.delay~=pc then if oc then oc.stopms=rc.delay-oc.delay;oc.stopstart=oc.ms;oc.stopend=oc.stopstart+oc.stopms end;pc=rc.delay end;if oc and oc.delay~=0 then oc.ms=oc.ms-oc.delay;oc.s=MsToS(oc.ms)oc.loadms=mb(oc,oc.ms)oc.loads=MsToS(oc.loadms)oc.ms=oc.ms+oc.delay;oc.s=MsToS(oc.ms)end;oc=rc end)end;for oc,pc in pairs(p.Data)do if pc.branch then for qc,rc in pairs(pc.branch.paths)do table.sort(rc,function(sc,tc)return sc.loadms<tc.loadms end)end end end;table.sort(p.Data,function(oc,pc)if oc.branch and pc.branch then for qc,rc in pairs(oc.branch.paths)do for sc,tc in pairs(pc.branch.paths)do return rc[1].loadms<tc[1].loadms end end elseif oc.branch then for qc,rc in pairs(oc.branch.paths)do return rc[1].loadms<pc.loadms end elseif pc.branch then for qc,rc in pairs(pc.branch.paths)do return oc.loadms<rc[1].loadms end else return oc.loadms<pc.loadms end end)Taiko.ConnectAll(p.Data)Taiko.ForAll(p.Data,function(oc,pc,qc)oc.n=qc end)local Ab=I/z;local Bb=zb[1]for i=1,#zb do if zb[i]>Bb then Bb=zb[i]end end;Bb=Bb+Ab;loaded={}local Cb=p.Data[1]local Db=Cb.loads;local Eb=10;local Fb=string.rep(' ',Eb)local Gb={}local function Hb(oc,pc)Gb[#Gb+1]=oc;Gb[#Gb+1]=': 'Gb[#Gb+1]=tostring(pc)Gb[#Gb+1]=Fb;Gb[#Gb+1]='\n'end;local function Ib()print(table.concat(Gb))Gb={}end;local Jb={}local function Kb(oc)Jb[#Jb+1]=oc end;local function Lb()print(table.concat(Jb,'\n'))Jb={}end;ub.ClearScreen()local Mb='M'local Nb=0;local Ob,Pb,Qb=p.Metadata.SCOREINIT,p.Metadata.SCOREDIFF,Taiko.Data.ScoreMode.Note[p.Metadata.SCOREMODE]local Rb=0;local Sb=false;local Tb=nil;local Ub=nil;local Vb=nil;local Wb=Taiko.Data.ScoreMode.Balloon[p.Metadata.SCOREMODE]local Xb=Taiko.Data.ScoreMode.BalloonPop[p.Metadata.SCOREMODE]local Yb=nil;local Zb=nil;local ac=nil;local bc=Taiko.Data.ScoreMode.Drumroll[p.Metadata.SCOREMODE]local cc={startms=nil,status=nil}local dc=nil;local ec=nil;local fc=nil;local gc=0;local hc={-1,nil}local ic=0;local jc=0;local kc=true;local lc=os.clock()local mc,nc;if u then mc=1 /u;nc=lc+mc end;if not t.on then while true do local oc=cb.New()local pc=os.clock()local qc=pc-lc;local rc=qc*1000;if fc and rc>fc then dc,ec,fc=nil,nil,nil end;if Vb and rc>Vb then Tb,Ub,Vb=nil,nil,nil end;if ac and rc>ac then Yb,Zb,ac=nil,nil,nil end;if Cb then if Cb.loadms<rc+gc then loaded[#loaded+1]=Cb;if Cb.endnote then loaded[#loaded+1]=Cb.endnote end;Cb=Cb.nextnote;if Cb then if Cb.startnote then Cb=Cb.nextnote end;if Cb and Cb.branch then Cb=Cb.branch.paths[Mb][1]end end end else if rc>Bb then break end end;cb.Circle(oc,math.floor(O[1]),math.floor(O[2]),J,{color='purple'})local sc={}local tc={}local uc=0;for i=1,#loaded do local zc=i+uc;local Ac=loaded[zc]if Ac then if Ac.data=='note'then if(Ac.type==1 or Ac.type==3)and(not sc[1]or math.abs(rc-Ac.ms)<sc[1])then sc[1]=math.abs(rc-Ac.ms)tc[1]=Ac elseif(Ac.type==2 or Ac.type==4)and(not sc[2]or math.abs(rc-Ac.ms)<sc[2])then sc[2]=math.abs(rc-Ac.ms)tc[2]=Ac end end;local Bc,Cc=nb(Ac,dc or(rc+gc))Ac.p[1]=Bc;Ac.p[2]=Cc;if rc>Ac.ms then Sb=Ac.gogo;if Ac.type==7 then if Tb then if Tb.n==Ac.n then Ac.p[1]=O else end end;Tb=Ac;Ub=Ac.ms;Vb=Ac.ms+Ac.length elseif Ac.type==5 or Ac.type==6 then Yb=Ac;Zb=Ac.ms;ac=Ac.ms+Ac.length end end;if A and Ac.stopstart and rc>Ac.stopstart then dc=gc+Ac.stopstart;stopms=Ac.stopms;gc=gc-Ac.stopms;ec=Ac.stopstart;fc=Ac.stopend;Ac.stopstart=nil end;if(Ac.hit and not(A and Ac.stopstart and not(rc>Ac.stopstart)))or kb(Ac.p[1],Ac.p[2],Y[1],Y[2],Y[3],Y[4])==false then Ac.done=true;table.remove(loaded,zc)uc=uc-1 else if not Ac.hit then if kc then if Ac.data=='event'then if Ac.event=='barline'then ob(oc,Ac)end elseif Ac.data=='note'then rb(oc,Ac)else error('Invalid note.data')end end end end end end;if cc.status then if rc>cc.startms+R then cc={}else sb(oc,cc,rc,0)end end;ub.SetCursor(1,1)if u then local zc=cb.Convert.ToDots(oc)repeat until os.clock()>=nc;nc=nc+mc;print(zc)else print(cb.Convert.ToDots(oc))end;ic=ic+1;local vc=os.clock()-pc;jc=jc+vc;local wc=j.getch(Z)local xc=j.getkeyname(wc)local yc=B.Hit[xc]if w then local zc=sc[1]local Ac=sc[2]local Bc=(sc[1]and sc[2])and( (sc[1]<sc[2])and 1 or 2)or(sc[1]and 1 or 2)local Cc=sc[Bc]local Dc=tc[Bc]if Cc and rc>=Dc.ms and(not Dc.hit)then yc=Bc elseif not Cc or(Cc and Cc> (yb.bad* ( ( (Dc.type==3 or Dc.type==4)and Taiko.Data.BigLeniency)or 1)))then if Ub and(rc>Ub and rc<Vb)then yc=1 elseif Zb and(rc>Zb and rc<ac)then yc=1 end end end;if yc then if sc[yc]and(not tc[yc].hit)then local zc=tc[yc]local Ac=zc.type;local Bc=zc.gogo;local Cc=sc[yc]local Dc;local Ec=( (Ac==3 or Ac==4)and Taiko.Data.BigLeniency)or 1;if Cc< (yb.good)then Dc=( (Ac==3 or Ac==4)and 3)or 2;Rb=Rb+1 elseif Cc< (yb.ok*Ec)then Dc=1;Rb=Rb+1 elseif Cc< (yb.bad*Ec)then Dc=0;Rb=0 else Dc=nil end;if Dc then Nb=Qb(Nb,Rb,Ob,Pb,Dc,Bc)tc[yc].hit=true;cc={startms=rc,status=Dc}end end;if(yc==1)and Ub and(rc>Ub and rc<Vb)then Nb=Wb(Nb,Tb.type,notegogo)end;if(yc==1 or yc==2)and Zb and(rc>Zb and rc<ac)then Nb=bc(Nb,Yb.type,notegogo)end end;if B.Escape[xc]then local zc=os.clock()ub.ClearScreen()j.nodelay(Z,false)local Ac={'Back','Retry','Back to Select'}while true do ub.SetCursor(1,1)local Bc={}for i=1,#Ac do Bc[i]=( (i==C)and(E..string.rep(' ',D-#E))or string.rep(' ',D))..Ac[i]end;print(table.concat(Bc,F))local Cc=j.getch(Z)local Dc=j.getkeyname(Cc)if B.L[Dc]then C=C==1 and 1 or C-1 elseif B.R[Dc]then C=C==3 and 3 or C+1 elseif B.Select[Dc]then if C==1 then elseif C==2 then return'Retry'elseif C==3 then return nil end;break elseif B.Escape[Dc]then break end end;j.nodelay(Z,true)lc=lc+ (os.clock()-zc)end;if wc~=-1 then hc={wc,xc}end;Hb('Input (ascii)',hc[1])Hb('Input (key)',hc[2])Hb('S',qc)Hb('Ms',rc)Hb('Loaded',#loaded)Hb('Frames Rendered',ic)Hb('Last Frame Render (ms)',vc*1000)Hb('Frame Render Total (ms)',jc*1000)Hb('Frame Render Total (%)',jc/qc*100)Hb('FPS (Frame)',ic/qc)Hb('Stop Start',ec or'')Hb('Stop End',fc or'')Hb('Total Delay',gc)Hb('Score',Nb)Hb('Combo',Rb)Hb('Gogo',Sb)Hb('Drumroll Start',Zb)Hb('Drumroll End',ac)Ib()Lb()end else error('Prerendering has been removed')end;return true end;function Taiko.SongSelect(p,q,r)local s={}local t,u=10,10;local v,w,x,y=-t,t,-u,u;local z=true;local A=1;local B=1;local C=4;local D=5;local E=5;local F=2;local G='V'local H='>'local I=10;local J=nil;local K='>'local L='>'local M=2;local N=true;local O='_Original_'local P=r or{}local Q=false;local R={[2]={'Normal','Auto'},[3]={'Normal','2x Speed','3x Speed','4x Speed','0.25x Speed','0.5x Speed','0.75x Speed'},[4]={'Normal','2x Speed','3x Speed','4x Speed','0.25x Speed','0.5x Speed','0.75x Speed'},[5]={'Normal','Reverse','Invisible','Messy'}}local S={4,1,1,1,1,1}local T={nil}for pb,qb in pairs(R)do T[pb]={1,#qb,qb}end;local U={[1]=nil,[2]={function(pb)return pb,'type',pb.type and(Taiko.Data.Notes.ReverseNotes[pb.type]or pb.type)or pb.type end,function(pb)return pb,'type'end},[3]={function(pb)return pb,'scrollx',10000 end,function(pb)return pb,'scrollx'end},[4]={function(pb)return pb,'type',pb.type and(pb.type==1 and math.random(1,2)or pb.type==2 and math.random(1,2)or pb.type==3 and math.random(3,4)or pb.type==4 and math.random(3,4)or pb.type)end,function(pb)return pb,'type'end}}local V={window=j.initscr()}j.keypad(V,true)j.echo(false)j.raw(true)j.nl(false)j.cbreak(true)j.nodelay(V,true)j.getch(V)j.nodelay(V,false)local W,X=j.cols(),j.lines()J=J or W-2;local Y={Escape={['\27']=true,ALT_ESC=true},Scroll={L={KEY_LEFT=true,KEY_SLEFT=true,CTL_LEFT=true,KEY_B1=true,ALT_LEFT=true,KEY_SHIFT_L=true,KEY_UP=true,KEY_A2=true},R={KEY_RIGHT=true,KEY_SRIGHT=true,CTL_RIGHT=true,KEY_B3=true,ALT_RIGHT=true,KEY_SHIFT_R=true,KEY_DOWN=true,KEY_C2=true}},Select={Init={KEY_ENTER=true,PADENTER=true,CTL_PADENTER=true,ALT_PADENTER=true,CTL_PADCENTER=true,ALT_ENTER=true,CTL_ENTER=true,SHF_PADENTER=true,['\n']=true,['\r']=true},Select={KEY_ENTER=true,PADENTER=true,CTL_PADENTER=true,ALT_PADENTER=true,CTL_PADCENTER=true,ALT_ENTER=true,CTL_ENTER=true,SHF_PADENTER=true,['\n']=true,['\r']=true},Escape={['\27']=true,ALT_ESC=true},L={KEY_LEFT=true,KEY_SLEFT=true,CTL_LEFT=true,KEY_B1=true,ALT_LEFT=true,KEY_SHIFT_L=true},R={KEY_RIGHT=true,KEY_SRIGHT=true,CTL_RIGHT=true,KEY_B3=true,ALT_RIGHT=true,KEY_SHIFT_R=true},U={KEY_UP=true,KEY_A2=true},D={KEY_DOWN=true,KEY_C2=true},Play={Hit={['4']=2,['v']=1,['n']=1,['8']=2},Escape={['\27']=true,ALT_ESC=true},L={KEY_LEFT=true,KEY_SLEFT=true,CTL_LEFT=true,KEY_B1=true,ALT_LEFT=true,KEY_SHIFT_L=true,KEY_UP=true,KEY_DOWN=true},R={KEY_RIGHT=true,KEY_SRIGHT=true,CTL_RIGHT=true,KEY_B3=true,ALT_RIGHT=true,KEY_SHIFT_R=true,KEY_DOWN=true,KEY_C2=true},Select={KEY_ENTER=true,PADENTER=true,CTL_PADENTER=true,ALT_PADENTER=true,CTL_PADCENTER=true,ALT_ENTER=true,CTL_ENTER=true,SHF_PADENTER=true,['\n']=true,['\r']=true}}},Search={Init={ALT_F=true,f=true,F=true},Backspace={['\8']=true,KEY_BACKSPACE=true,ALT_BKSP,CTL_BKSP},FirstResult={KEY_ENTER=true,PADENTER=true,CTL_PADENTER=true,ALT_PADENTER=true,CTL_PADCENTER=true,ALT_ENTER=true,CTL_ENTER=true,SHF_PADENTER=true,['\n']=true,['\r']=true},Select={KEY_RIGHT=true,KEY_SRIGHT=true,CTL_RIGHT=true,KEY_B3=true,ALT_RIGHT=true,KEY_SHIFT_R=true},Up={KEY_A2=true,KEY_UP=true},Down={KEY_C2=true,KEY_DOWN=true},Escape={['\27']=true,ALT_ESC=true}},Add={Init={ALT_N=true,n=true,N=true},Backspace={['\8']=true,KEY_BACKSPACE=true,ALT_BKSP,CTL_BKSP},Select={KEY_ENTER=true,PADENTER=true,CTL_PADENTER=true,ALT_PADENTER=true,CTL_PADCENTER=true,ALT_ENTER=true,CTL_ENTER=true,SHF_PADENTER=true,['\n']=true,['\r']=true}},StandardInput={Backspace={['\8']=true,KEY_BACKSPACE=true,ALT_BKSP,CTL_BKSP},Escape={KEY_ENTER=true,PADENTER=true,CTL_PADENTER=true,ALT_PADENTER=true,CTL_PADCENTER=true,ALT_ENTER=true,CTL_ENTER=true,SHF_PADENTER=true,['\n']=true,['\r']=true},L={KEY_LEFT=true,KEY_SLEFT=true,CTL_LEFT=true,KEY_B1=true,ALT_LEFT=true,KEY_SHIFT_L=true,KEY_UP=true,KEY_DOWN=true},R={KEY_RIGHT=true,KEY_SRIGHT=true,CTL_RIGHT=true,KEY_B3=true,ALT_RIGHT=true,KEY_SHIFT_R=true,KEY_DOWN=true,KEY_C2=true}},Reload={Init={r=true}},ReloadAll={Init={R=true}},Rename={Init={KEY_F2=true}}}local Z={ClearScreen=function()io.write("\27[2J")end,SetCursor=function(pb,qb)io.write(string.format("\27[%d;%dH",qb,pb))end,ClearLine=function()io.write("\27[2K")end,CursorLeft=function(pb)io.write(string.format("\27[%dD",pb))end,CursorRight=function(pb)io.write(string.format("\27[%dC",pb))end,SaveCursor=function()io.write("\27[s")end,RestoreCursor=function()io.write("\27[u")end}local function ab(pb)return pb..string.rep(' ',J-#pb)end;local function bb()local pb=j.getch(V)local qb=j.getkeyname(pb)return pb,qb end;local function cb()local pb=''local qb=0;local rb=qb;while true do local sb,tb=bb()if Y.StandardInput.Backspace[tb]then pb=string.sub(pb,1,qb-1)..string.sub(pb,qb+1,-1)qb=qb-1 elseif Y.StandardInput.Escape[tb]then io.write('\n')return pb elseif Y.StandardInput.L[tb]then qb=qb-1 elseif Y.StandardInput.R[tb]then qb=qb+1 else pb=string.sub(pb,1,qb)..tb..string.sub(pb,qb+1,-1)qb=qb+1 end;qb=ClipN(qb,0,#pb)local ub=qb-rb;if ub<0 then Z.CursorLeft(-ub)elseif ub>0 then Z.CursorRight(ub)end;Z.SaveCursor()Z.ClearLine()io.write('\r')io.write(pb)Z.RestoreCursor()rb=qb end end;local function db(pb)return pb>=32 and pb<=126 end;local function eb(pb,qb,rb,sb)return(pb and(qb..string.sub(rb,#qb+1,-1))or rb)..sb end;local function fb(pb,qb,rb)return pb>rb and qb or pb<qb and rb or pb end;local gb={[0]='No',[1]='Yes'}local function hb(pb)return pb and gb[1]or gb[0]end;local function ib(pb)return pb*100 ..'%'end;local function jb(pb)return MsToS(pb)..'s'end;local function kb(pb)return jb(SToMs(pb))end;local function lb(pb)return tonumber(pb)and tonumber(pb)or 0 end;local function mb(pb,qb,rb)pb[O..qb]=pb[qb]pb[qb]=rb end;local function nb(pb,qb)pb[qb]=pb[O..qb]end;local ob={}Z.ClearScreen()while true do s={}if z then s[v]={}for i=A-D,A+D do local tb=nil;if i<1 then tb=#p+i elseif i>#p then tb=i-#p else tb=i end;local ub=p[tb]if ub then s[0]=s[0]or{}s[0][(i-A)*E]=ub end end;local rb={}local sb=string.rep(' ',F)for y=x,y do rb[#rb+1]=eb(y==0,H,sb,'')rb[#rb+1]=ab(s[0]and s[0][y]or'')rb[#rb+1]='\n'end;Z.SetCursor(1,1)print(table.concat(rb))else s[0]={}s[0][x]=G;for i=A-D,A+D do local sb=nil;if i<1 then sb=#p+i elseif i>#p then sb=i-#p else sb=i end;local tb=p[sb]if tb then local ub=(i-A)*E;s[ub]=s[ub]or{}local vb=x+F;for i2=1,#tb do s[ub][vb]=string.sub(tb,i2,i2)vb=vb+1 end end end;local rb={}for y=x,y do for x=v,w do if s[x]and s[x][y]then local sb=s[x][y]if db(string.byte(sb))then rb[#rb+1]=sb else rb[#rb+1]=' 'end else rb[#rb+1]=' 'end end;rb[#rb+1]='\n'end;Z.SetCursor(1,1)print(table.concat(rb))end;local pb,qb=bb()if Y.Scroll.L[qb]then A=A-1 elseif Y.Scroll.R[qb]then A=A+1 elseif Y.Select.Init[qb]then local rb;if N then if ob[A]then rb=ob[A]else rb=Taiko.ParseTJA(q[A])ob[A]=rb end else rb=Taiko.ParseTJA(q[A])end;local sb={}for wb,xb in pairs(rb)do sb[#sb+1]={wb,xb.Metadata.COURSE}end;table.sort(sb,function(wb,xb)return wb[2]<xb[2]end)min=1;max=#sb;T[1]={min,max,sb}DifficultyMap=sb;S[1]=ClipN(S[1],min,max)local tb=string.rep(' ',M)Z.ClearScreen()Z.SetCursor(1,1)local ub=nil;local vb=B;while true do B=ClipN(B,1,5)if B~=vb then C=S[B]vb=B end;local wb=T[B]min,max=wb[1],wb[2]C=fb(C,min,max)S[B]=C;Z.SetCursor(1,1)local xb=DifficultyMap[S[1]][2]ub=Taiko.GetDifficulty(rb,xb)local yb=ub.Metadata;local zb=Taiko.Analyze(ub)local Ab={{'',yb.TITLE},{'\t',yb.SUBTITLE},{'',''},{'','Select Options:'},{eb(B==1,L,tb,'Difficulty: '),Taiko.Data.CourseName[yb.COURSE]},{eb(B==2,L,tb,'Mode: '),R[2][S[2]]},{eb(B==3,L,tb,'Note Speed: '),R[3][S[3]]},{eb(B==4,L,tb,'Song Speed: '),R[4][S[4]]},{eb(B==5,L,tb,'Modifiers: '),R[5][S[5]]},{'',''},{'Difficulty: ',Taiko.Data.CourseName[yb.COURSE]},{'Stars: ',yb.LEVEL},{'Diverge Notes: ',hb(yb.DIVERGENOTES)},{'',''},{'','Statistics:'},{'Length: ',jb(zb.lengthms)},{'Don (DON) / Ka (KA): ',lb(zb.notes[1])..' + ('..lb(zb.notes[3])..') / '..lb(zb.notes[2])..' + ('..lb(zb.notes[4])..') = '..ib((lb(zb.notes[1])+lb(zb.notes[3]))/zb.notes.validn)..' / '..ib((lb(zb.notes[2])+lb(zb.notes[4]))/zb.notes.validn)},{'Max Score (without drumroll): ',zb.maxscore},{'Max Combo: ',zb.maxcombo},{'Drumroll Time (total): ',jb(zb.drumrollms+zb.drumrollbigms)},{'Balloon Time: ',jb(zb.balloonms)},{'Balloon Hits: ',zb.balloonhit},{'Special Time: ',jb(zb.specialms)},{'Special Hits: ',zb.specialhit},{'',''},{'','Press Enter to Play!'}}for i=1,#Ab do local Db=Ab[i]print(ab(Db[1]..tostring(Db[2])))end;local Bb,Cb=bb()if Y.Select.L[Cb]then C=C-1 elseif Y.Select.R[Cb]then C=C+1 elseif Y.Select.U[Cb]then B=B-1 elseif Y.Select.D[Cb]then B=B+1 elseif Y.Select.Select[Cb]then local Db=U[S[5]]if Db and Db[1]then local Eb=Db[1]Taiko.ForAll(ub.Data,function(Fb,Gb,Hb)mb(Eb(Fb))end)end;while true do local Eb,Fb=Taiko.PlaySong(ub,V,S,Y.Select.Play)if Eb and Fb then break elseif Eb=='Retry'then else break end end;j.nodelay(V,false)Z.ClearScreen()if Db and Db[2]then local Eb=Db[2]Taiko.ForAll(ub.Data,function(Fb,Gb,Hb)nb(Eb(Fb))end)end elseif Y.Select.Escape[Cb]then break end end elseif Y.Search.Init[qb]then local rb=''local sb={}local tb=1;local ub=nil;local vb=1;Z.ClearScreen()Z.SetCursor(1,1)print('Searching...')while true do Z.SetCursor(#rb+1,2)local wb,xb=bb()Z.SetCursor(1,2)if Y.Search.Backspace[xb]then rb=string.sub(rb,1,-2)elseif Y.Search.FirstResult[xb]then ub=sb[1]break elseif Y.Search.Select[xb]then ub=sb[vb]break elseif Y.Search.Down[xb]then vb=vb+1 elseif Y.Search.Up[xb]then vb=vb-1 elseif Y.Search.Escape[xb]then break else rb=rb..xb end;print(ab(rb))local yb=k.SearchHeaderAll(p,rb)for i=1,I do if yb[i]and yb[i][2]==-math.huge then tb=i-1;break elseif i==I then tb=i end end;vb=ClipN(vb,1,tb)local zb=false;for i=1,I do local Ab=yb[i]if zb then print(ab(''))else if Ab then if Ab[2]==-math.huge then zb=true;print(ab(''))else print(ab((i==vb and K or i)..'. '..yb[i][3]))sb[i]=Ab end end end end end;A=(ub and ub[1]or A)or A elseif Y.Add.Init[qb]then print('Import a Custom Song')while true do print('Enter a .tja or .tjac file path (with the file extention)')local rb=cb()local sb=io.open(rb,'rb')if sb then local tb=sb:read('*all')if EndsWith(rb,'.tja')then print('Enter a song name')local ub=cb()local vb=#p+1;p[vb]=ub;q[vb]=tb;P[vb]={rb}break elseif EndsWith(rb,'.tjac')then local ub,vb=k.Decompress(tb)for i=1,#ub do local wb=#p+1;p[wb]=vb[i]q[wb]=ub[i]P[wb]={rb,ub}end;break else print('Invalid file type')end;sb:close()else print('Unable to read file')end end elseif Y.Reload.Init[qb]then print('Reloading selected file...')if P[A]then local rb=P[A]local sb=io.open(rb[1],'rb')if sb then local tb=sb:read('*all')local ub=A;if rb[2]then local vb,wb=k.Decompress(tb)if Q then p[ub]=wb[i]end;q[ub]=vb[i]else q[ub]=tb end;if N then ob[ub]=nil end;sb:close()else print('Unable to read file')end else print('File source not found')end elseif Y.ReloadAll.Init[qb]then print('Reloading all files...')local rb={}for sb,tb in pairs(P)do rb[tb[1]]=rb[tb[1]]and rb[tb[1]]or{}rb[tb[1]][#rb[tb[1]]+1]={sb,tb[2]}end;for sb,tb in pairs(rb)do local ub=io.open(sb,'rb')if ub then local vb=ub:read('*all')if tb[1][2]then local wb,xb=k.Decompress(vb)for i=1,#tb do local yb=tb[i]if Q then p[yb[1]]=xb[yb[2]]end;q[yb[1]]=wb[yb[2]]if N then ob[yb[1]]=nil end end else for i=1,#tb do local wb=tb[i]q[wb[1]]=vb;if N then ob[wb[1]]=nil end end end;ub:close()else print('Unable to read file')end end elseif Y.Rename.Init[qb]then print('Enter a song name')local rb=cb()p[A]=rb elseif Y.Escape[qb]then return end;A=fb(A,1,#p)end end;function Taiko.Game()end;local l='./CompactTJA/taikobuipm.tjac'l='./CompactTJA/ESE/06 Classical.tjac'l='./CompactTJA/ESE/ESE.tjac'local m='./tja/neta/ekiben/neta.tja'local n=io.open(m)local o=n:read('*all')n:close()Taiko.SongSelect({'neta'},{o},{{m}})error()Taiko.PlaySong(Taiko.GetDifficulty(Taiko.ParseTJA(k.InputFile(l)),'Ura'))